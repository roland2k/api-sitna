TC.Layer=function(t){this.options=t||{};TC.Util.extend(this,this.options);this.PROTOCOL_REGEX=/^(f|ht)tp?:\/\//i;this.id=this.options.id||TC.getUID();this.map=this.options.map;this.type=this.options.type||TC.Consts.layerType.WMS;this.customLegend=this.options.customLegend;var e=this.options.isBase?TC.Consts.mimeType.JPEG:TC.Consts.mimeType.PNG;this.options.format=this.options.format||e;this.options.owner&&(this.owner=this.options.owner);void 0===this.options.hideTree&&(this.options.hideTree=!0);void 0===this.options.hideTitle&&(this.options.hideTitle=!1);this._cache={visibilityStates:{}};this.tree=null;this.wrap=null};TC.Layer.state={IDLE:"idle",LOADING:"loading"};TC.Layer.prototype.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.";TC.Layer.prototype.setVisibility=function(t){this.wrap.setVisibility(t)};TC.Layer.prototype.getVisibility=function(){var t=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(t=this.wrap.getVisibility()));return t};TC.Layer.prototype.getOpacity=function(){var t=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(t=this.wrap.layer.getOpacity()));return t};TC.Layer.prototype.setOpacity=function(t,e){var i=this;this.wrap.getLayer().then(function(o){o.setOpacity(t);i.opacity=t;i.map&&!e&&i.map.trigger(TC.Consts.event.LAYEROPACITY,{layer:i,opacity:t})})};TC.Layer.prototype.isCompatible=function(t){return!0};TC.Layer.prototype.isValidFromNames=function(){return!0};TC.Layer.prototype.isRaster=function(){var t=!0;switch(this.type){case TC.Consts.layerType.VECTOR:case TC.Consts.layerType.KML:case TC.Consts.layerType.WFS:case TC.Consts.layerType.GROUP:t=!1}return t};TC.Layer.prototype.isVisibleByScale=function(t){return!0};TC.Layer.prototype.isVisibleByName=function(t){return!0};TC.Layer.prototype.getTree=function(){return{name:this.name,title:this.title}};TC.Layer.prototype.findNode=function t(e,i){var o=null;if(i.uid==e)o=i;else for(var r=0;r<i.children.length;r++){var n=t(e,i.children[r]);if(n){o=n;break}}return o};TC.Layer.prototype.setNodeVisibility=function(t,e){this.setVisibility(e)};TC.Layer.prototype.getNodeVisibility=function(t){return TC.Consts.visibility.VISIBLE};TC.Layer.prototype.getResolutions=function(){return this.wrap.getResolutions?this.wrap.getResolutions():[]};TC.Layer.prototype.setProjection=function(){};TC.Layer.prototype.clone=function(){const t=TC.Util.extend(!0,{},this.options,{id:this.id+"_clone"});return new this.constructor(t)};TC.Layer.prototype.getBySSL_=function(t){return t.replace(this.PROTOCOL_REGEX,"https://")};TC.Layer.prototype.clip=function(t){this.wrap.clip(t)};TC.Layer.prototype.stroke=function(t,e){this.wrap.stroke(t,e)};!function(){const t=window.hasOwnProperty("Worker"),e=TC.Util.getWebWorkerCrossOriginURL(TC.apiLocation+"TC/workers/tc-caps-web-worker.js"),i=function(t,e){return"No se pudo obtener el documento de capacidades del servicio "+t.url+": ["+e+"]"},o=function(t){const e=document.createElement("a");e.href=t;if(!e.origin){if(!e.protocol||!e.hostname){var i=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/.exec(e.href);e.protocol=i[1];if(i[4].indexOf(":")>-1){var o=i[4].split(":");e.hostname=o[0];e.port=o[1]}else e.hostname=i[4]}e.origin=(0===e.protocol.length?window.location.protocol:e.protocol)+"//"+e.hostname+(e.port&&t.indexOf(e.port)>-1?":"+e.port:"")}return e},r=function(t,e){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){const i=o(t.options.url);var r=t.CAPABILITIES_STORE_KEY_PREFIX+t.type+"."+i.href,n=function(){e.hasOwnProperty("error")||t.getCapabilitiesPromise().then(function(){localforage.setItem(r,e).catch(t=>console.log(t))})};t.map?t.map.loaded(n):n()})};TC.Layer.prototype.getGetMapUrl=function(){return function(t){var e=t;if(t){var i=t.match(/\??SERVICE=\w+&/i);i&&(e=e.replace(i[0],""))}return e}(this.wrap.getGetMapUrl())};TC.Layer.prototype.getCapabilitiesOnline=function(){const o=this;return o._onlineCapabilitiesPromise=o._onlineCapabilitiesPromise||new Promise(function(n,s){const a=o.getGetCapabilitiesUrl();o.toolProxification.fetch(a,{retryAttempts:2}).then(function(a){(function(i,o){var n;if(o.documentElement){const t=o.getElementsByTagName("ServiceException")[0];if(t)n={error:t.textContent};else{var s=i.type===TC.Consts.layerType.WMTS?new i.wrap.WmtsParser:new i.wrap.WmsParser;n=s.read(o);if(i.type===TC.Consts.layerType.WMTS&&n.Contents&&n.Contents.Layer){const t=o.getElementsByTagName("Layer");for(var a=0,p=t.length;a<p;a++){const e=t[a];var l=TC.Util.getElementByNodeName(e,"ows:Identifier")[0].firstChild.data,c=n.Contents.Layer.filter(function(t){return t.Identifier==l});if(c.length){c=c[0];for(var y=0;y<c.TileMatrixSetLink.length;y++){var T,C=c.TileMatrixSetLink[y];matrixId=C.TileMatrixSet;const t=e.getElementsByTagName("TileMatrixSetLink");for(var h=0,u=t.length;h<u;h++){const e=t[h];if(e.querySelector("TileMatrixSet:first").textContent==matrixId){T=e;break}}if(T){C.TileMatrixSetLimits=[];const t=T.getElementsByTagName("TileMatrixLimits");for(h=0,u=t.length;h<u;h++){const e=t[h];C.TileMatrixSetLimits.push({TileMatrix:e.getElementsByTagName("TileMatrix")[0].textContent,MinTileRow:parseInt(e.getElementsByTagName("MinTileRow")[0].textContent),MinTileCol:parseInt(e.getElementsByTagName("MinTileCol")[0].textContent),MaxTileRow:parseInt(e.getElementsByTagName("MaxTileRow")[0].textContent),MaxTileCol:parseInt(e.getElementsByTagName("MaxTileCol")[0].textContent)})}}}}}}}r(i,n);return Promise.resolve(n)}return new Promise(function(s,a){t&&"string"==typeof o?e.then(function(t){var e=new Worker(t);e.onmessage=function(t){if("success"===t.data.state){n=t.data.capabilities;r(i,n)}else{n={error:"Web worker error: "+i.url};a(n.error)}s(n);e.terminate()};e.postMessage({type:i.type,text:o,url:TC.apiLocation.indexOf("http")>=0?TC.apiLocation:document.location.protocol+TC.apiLocation})}):s(n=o)})})(o,a.responseText).then(function(t){t.error?s(Error(i(o,t.error))):n(t)}).catch(function(t){delete o._onlineCapabilitesPromise;s(Error(t))})}).catch(function(t){delete o._onlineCapabilitesPromise;s(Error(i(o,t)))})})};TC.Layer.prototype.getCapabilitiesFromStorage=function(){var t=this;return new Promise(function(e,i){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){const r=o(t.url);localforage.getItem(t.CAPABILITIES_STORE_KEY_PREFIX+t.type+"."+r.href).then(function(t){t?e(t):i(Error("Capabilities not in storage: "+r.href))}).catch(function(){i(Error("Undefined storage error"))})})})}}();
//# sourceMappingURL=maps/Layer.min.js.map