!function(e,t){"function"==typeof define&&define.amd?define(["../../lib/ol/build/ol-debug"],t):"object"==typeof exports?module.exports=t(require("../../lib/ol/build/ol-debug")):e.ol=t(e.ol)}(this,function(e){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)};for(var t=0,r=["ms","moz","webkit","o"],a=0;a<r.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[r[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[r[a]+"CancelAnimationFrame"]||window[r[a]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(e,r){var a=(new Date).getTime(),n=Math.max(0,16-(a-t)),o=window.setTimeout(function(){e(a+n)},n);t=a+n;return o});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});var n="mousemove.tc",o=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));o=o.substr(0,o.lastIndexOf("/")+1)+"css/ol.css";e.proj.get("EPSG:4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("urn:ogc:def:crs:EPSG::4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("http://www.opengis.net/gml/srs/epsg.xml#4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.oldGet=e.proj.get;e.proj.get=function(t){if("string"==typeof t){t=t.trim();TC.loadProjDef({crs:t,sync:!0})}return e.proj.oldGet.call(this,t)};e.format.GMLBase.prototype.readGeometryElement=function(t,r){var a=r[0];a.srsName=t.firstElementChild.getAttribute("srsName");if((this instanceof e.format.GML2CRS84||this instanceof e.format.GML3CRS84)&&("EPSG:4326"!==a.srsName||!a.srsName))throw new Error("Conflicto de CRS");a.srsName||(a.srsName=this.srsName);a.dataProjection=e.proj.get(a.srsName);var n=e.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS_,t,r,this);return n?e.format.Feature.transformWithOptions(n,!1,a):void 0};e.format.GMLBase.prototype.readFeatureElement=function(t,r){var a,n,o=t.getAttribute("fid")||e.xml.getAttributeNS(t,e.format.GMLBase.GMLNS,"id"),i={};for(a=t.firstElementChild;a;a=a.nextElementSibling){var s=a.localName;if(0===a.childNodes.length||1===a.childNodes.length&&(3===a.firstChild.nodeType||4===a.firstChild.nodeType)){var l=e.xml.getAllTextContent(a,!1);e.format.GMLBase.ONLY_WHITESPACE_RE_.test(l)&&(l=void 0);i[s]=l}else(i[s]=this.readGeometryElement(a,r))&&"boundedBy"!==s&&"referencePoint"!==s&&(n=s)}var p=new e.Feature(i);n&&p.setGeometryName(n);o&&p.setId(o);return p};e.format.GML3.prototype._writePosList_=e.format.GML3.prototype.writePosList_;e.format.GML3.prototype.writePosList_=function(e,t,r){this._writePosList_(e,t,r);const a=t.getCoordinates()[0];a&&a.length>2&&e.setAttribute("srsDimension",a.length)};e.format.GML3.prototype._getCoords_=e.format.GML3.prototype.getCoords_;e.format.GML3.prototype.getCoords_=function(e,t){var r=this._getCoords_(e,t);e.length>2&&(r+=" "+e[2]);return r};e.format.GML3.prototype._writePos_=e.format.GML3.prototype.writePos_;e.format.GML3.prototype.writePos_=function(t,r,a){this._writePos_(t,r,a);const n=r.getCoordinates();n.length>2&&e.format.XSD.writeStringTextNode(t," "+n[2])};var i="http://www.opengis.net/gml",s="http://www.opengis.net/gml/3.2";e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[s]=e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[i];e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[s]=e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[i];e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[s]=e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[i];e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[s]=e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[i];e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[s]=e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[i];e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[s]=e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[i];e.format.GMLBase.prototype.RING_PARSERS[s]=e.format.GMLBase.prototype.RING_PARSERS[i];e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[s]=e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[i];e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[s]=e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[i];e.format.GML3.prototype.GEOMETRY_PARSERS_[s]=e.format.GML3.prototype.GEOMETRY_PARSERS_[i];e.format.GML3.prototype.MULTICURVE_PARSERS_[s]=e.format.GML3.prototype.MULTICURVE_PARSERS_[i];e.format.GML3.prototype.MULTISURFACE_PARSERS_[s]=e.format.GML3.prototype.MULTISURFACE_PARSERS_[i];e.format.GML3.prototype.CURVEMEMBER_PARSERS_[s]=e.format.GML3.prototype.CURVEMEMBER_PARSERS_[i];e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[s]=e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[i];e.format.GML3.prototype.SURFACE_PARSERS_[s]=e.format.GML3.prototype.SURFACE_PARSERS_[i];e.format.GML3.prototype.CURVE_PARSERS_[s]=e.format.GML3.prototype.CURVE_PARSERS_[i];e.format.GML3.prototype.ENVELOPE_PARSERS_[s]=e.format.GML3.prototype.ENVELOPE_PARSERS_[i];e.format.GML3.prototype.PATCHES_PARSERS_[s]=e.format.GML3.prototype.PATCHES_PARSERS_[i];e.format.GML3.prototype.SEGMENTS_PARSERS_[s]=e.format.GML3.prototype.SEGMENTS_PARSERS_[i];e.format.KML._createStyleDefaults_=e.format.KML.createStyleDefaults_;e.format.KML.createStyleDefaults_=function(){e.format.KML._createStyleDefaults_();e.format.KML.DEFAULT_FILL_STYLE_.color_=v(TC.Cfg.styles.polygon.fillColor,TC.Cfg.styles.polygon.fillOpacity);e.format.KML.DEFAULT_TEXT_STYLE_.fill_=new e.style.Fill({color:e.format.KML.DEFAULT_COLOR_});e.format.KML.DEFAULT_STROKE_STYLE_.color_=v(TC.Cfg.styles.line.strokeColor,1);e.format.KML.DEFAULT_STROKE_STYLE_.width_=TC.Cfg.styles.line.strokeWidth;return e.format.KML.DEFAULT_STYLE_ARRAY_};e.format.KML.prototype._readDocumentOrFolder_=e.format.KML.prototype.readDocumentOrFolder_;e.format.KML.prototype.readDocumentOrFolder_=function(t,r){var a=e.format.KML.prototype._readDocumentOrFolder_.apply(this,arguments);if("Folder"==t.localName)for(var n=0;n<a.length;n++){var o=a[n];$.isArray(o._folders)||(o._folders=[]);var i=t.getElementsByTagName("name")[0];i&&TC.Util.fastUnshift(o._folders,i.innerHTML||i.textContent)}return a};e.format.KML.readText_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE);e.asserts.assert("text"==t.localName);return e.xml.getAllTextContent(t,!1).trim()};e.format.KML.BALLOON_STYLE_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{text:e.xml.makeObjectPropertySetter(e.format.KML.readText_)});e.format.KML.BalloonStyleParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE);e.asserts.assert("BalloonStyle"==t.localName);var a=e.xml.pushParseAndPop({},e.format.KML.BALLOON_STYLE_PARSERS_,t,r);if(goog.isDef(a)){var n=r[r.length-1];e.asserts.assert(goog.isObject(n));var o=new e.style.Text({text:a.text});n.balloonStyle=o}};for(var l in e.format.KML.STYLE_PARSERS_){e.format.KML.STYLE_PARSERS_[l].BalloonStyle=e.format.KML.BalloonStyleParser_}e.format.KML.readStyle_=function(t,r){var a=e.xml.pushParseAndPop({},e.format.KML.STYLE_PARSERS_,t,r);if(!a)return null;var n="fillStyle"in a?a.fillStyle:e.format.KML.DEFAULT_FILL_STYLE_,o=a.fill;void 0===o||o||(n=null);var i="imageStyle"in a?a.imageStyle:e.format.KML.DEFAULT_IMAGE_STYLE_;i==e.format.KML.DEFAULT_NO_IMAGE_STYLE_&&(i=void 0);var s="textStyle"in a?a.textStyle:e.format.KML.DEFAULT_TEXT_STYLE_,l="strokeStyle"in a?a.strokeStyle:e.format.KML.DEFAULT_STROKE_STYLE_,p="balloonStyle"in a?a.balloonStyle:e.format.KML.DEFAULT_BALLOON_STYLE_,c=a.outline;void 0===c||c||(l=null);var u=new e.style.Style({fill:n,image:i,stroke:l,text:s,zIndex:void 0});u._balloon=p;return[u]};e.format.KML._readURI_=e.format.KML.readURI_;e.format.KML.readURI_=function(t){var r=e.format.KML._readURI_(t);"https:"===location.protocol&&0===r.indexOf("http://")&&(r=r.substr(5));return r};for(var l in e.format.KML.ICON_PARSERS_)e.format.KML.ICON_PARSERS_[l].href=e.xml.makeObjectPropertySetter(e.format.KML.readURI_);e.format.KML.whenParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");e.asserts.assert("when"==t.localName,"localName should be when");var a=r[r.length-1];e.asserts.assert(goog.isObject(a),"gxTrackObject should be an Object");a=a.whens;var n=e.xml.getAllTextContent(t,!1);if(n=/^\s*(\d{4})($|-(\d{2})($|-(\d{2})($|T(\d{2}):(\d{2}):(\d{2})(?:.?\d{3})?(Z|(?:([+\-])(\d{2})(?::(\d{2}))?)))))\s*$/.exec(n)){var o=parseInt(n[1],10),i=n[3]?parseInt(n[3],10)-1:0,s=n[5]?parseInt(n[5],10):1,l=n[7]?parseInt(n[7],10):0,p=n[8]?parseInt(n[8],10):0,c=n[9]?parseInt(n[9],10):0;o=Date.UTC(o,i,s,l,p,c);n[10]&&"Z"!=n[10]&&(o+=60*(i="-"==n[11]?-1:1)*parseInt(n[12],10),n[13]&&(o+=3600*i*parseInt(n[13],10)));a.push(o)}else a.push(0)};e.format.KML.GX_TRACK_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{when:e.format.KML.whenParser_},e.xml.makeStructureNS(e.format.KML.GX_NAMESPACE_URIS_,{coord:e.format.KML.gxCoordParser_}));e.format.KML.prototype.readFeatures=function(t,r){if("string"==typeof t){var a=t.indexOf("<kml");if(a>=0){a+="<kml".length;t.indexOf(">",a);t.indexOf("xmlns:xsi=")<0&&(t=t.substr(0,a)+' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+t.substr(a));t=function(t,r){var a=e.xml.parse(t).getElementsByTagName(r.toLowerCase());if(a&&a.length>0){var n=a[0].getAttribute("xmlns");if(n&&n.indexOf(" ")>-1&&m.indexOf(n)>-1)for(var o=n.split(" "),i=[],s=0;s<o.length;s++)i.push("xmlns:"+r.toLowerCase()+s+'="'+o[s].trim()+'"')}return t}(t,"KML")}}return e.format.XMLFeature.prototype.readFeatures.call(this,t,r)};e.format.XSD.readDateTime=function(t){t=e.xml.getAllTextContent(t,!1);if(t=/^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(?:([+\-])(\d{2})(?::(\d{2}))?))\s*$/.exec(t)){var r=parseInt(t[1],10),a=parseInt(t[2],10)-1,n=parseInt(t[3],10),o=parseInt(t[4],10),i=parseInt(t[5],10),s=parseInt(t[6],10);r=Date.UTC(r,a,n,o,i,s);"Z"!=t[7]&&(r+=60*(a="-"==t[8]?-1:1)*parseInt(t[9],10),void 0!==t[10]&&(r+=3600*a*parseInt(t[10],10)));return r}};e.format.GPX.RTEPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)});e.format.GPX.TRKPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)});e.format.GPX.WPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime),magvar:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),geoidheight:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),name:e.xml.makeObjectPropertySetter(e.format.XSD.readString),cmt:e.xml.makeObjectPropertySetter(e.format.XSD.readString),desc:e.xml.makeObjectPropertySetter(e.format.XSD.readString),src:e.xml.makeObjectPropertySetter(e.format.XSD.readString),link:e.format.GPX.parseLink_,sym:e.xml.makeObjectPropertySetter(e.format.XSD.readString),type:e.xml.makeObjectPropertySetter(e.format.XSD.readString),fix:e.xml.makeObjectPropertySetter(e.format.XSD.readString),sat:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),hdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),vdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),pdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),ageofdgpsdata:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),dgpsid:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),extensions:e.format.GPX.parseExtensions_});e.format.XSD.writeDateTimeTextNode=function(t,r){var a=new Date(r),n=a.getUTCFullYear()+"-"+e.string.padNumber(a.getUTCMonth()+1,2)+"-"+e.string.padNumber(a.getUTCDate(),2)+"T"+e.string.padNumber(a.getUTCHours(),2)+":"+e.string.padNumber(a.getUTCMinutes(),2)+":"+e.string.padNumber(a.getUTCSeconds(),2)+"Z";t.appendChild(e.xml.DOCUMENT.createTextNode(n))};e.format.GPX.WPT_TYPE_SERIALIZERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),time:e.xml.makeChildAppender(e.format.XSD.writeDateTimeTextNode),magvar:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),geoidheight:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),name:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),cmt:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),desc:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),src:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),link:e.xml.makeChildAppender(e.format.GPX.writeLink_),sym:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),type:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),fix:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),sat:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode),hdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),vdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),pdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),ageofdgpsdata:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),dgpsid:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode)});const p=TC.Util.detectMouse()?3:10;var c=function(e){for(var t=[],r=[],a=Math.pow(2,e.length),n=0;n<a;n++){r=[];for(var o=0;o<e.length;o++)n&Math.pow(2,o)&&-1==r.indexOf(e[o])&&r.push(e[o]);r.length>0&&-1==t.indexOf(r.join(" "))&&t.push(r.join(" "))}return t},u=function(e,t){if(e&&e.length>0)for(var r=0;r<t.length;r++){var a=e.indexOf(t[r]);a>-1&&e.splice(a,1)}},f=function(e,t){for(var r=0;r<e.length;r++)for(var a=e[r],n=0;n<t.length;n++){var o=t[n].split(" ")[0];a[t[n]]=a[o]}},g=[e.format.KML.DATA_PARSERS_,e.format.KML.EXTENDED_DATA_PARSERS_,e.format.KML.REGION_PARSERS_,e.format.KML.LAT_LON_ALT_BOX_PARSERS_,e.format.KML.LOD_PARSERS_,e.format.KML.EXTRUDE_AND_ALTITUDE_MODE_PARSERS_,e.format.KML.FLAT_LINEAR_RING_PARSERS_,e.format.KML.FLAT_LINEAR_RINGS_PARSERS_,e.format.KML.GX_TRACK_PARSERS_,e.format.KML.GEOMETRY_FLAT_COORDINATES_PARSERS_,e.format.KML.ICON_PARSERS_,e.format.KML.ICON_STYLE_PARSERS_,e.format.KML.INNER_BOUNDARY_IS_PARSERS_,e.format.KML.LABEL_STYLE_PARSERS_,e.format.KML.LINE_STYLE_PARSERS_,e.format.KML.MULTI_GEOMETRY_PARSERS_,e.format.KML.GX_MULTITRACK_GEOMETRY_PARSERS_,e.format.KML.NETWORK_LINK_PARSERS_,e.format.KML.LINK_PARSERS_,e.format.KML.OUTER_BOUNDARY_IS_PARSERS_,e.format.KML.PAIR_PARSERS_,e.format.KML.PLACEMARK_PARSERS_,e.format.KML.POLY_STYLE_PARSERS_,e.format.KML.SCHEMA_DATA_PARSERS_,e.format.KML.STYLE_PARSERS_,e.format.KML.STYLE_MAP_PARSERS_],m=c(e.format.KML.NAMESPACE_URIS_.slice().slice(1));u(m,e.format.KML.NAMESPACE_URIS_);e.format.KML.NAMESPACE_URIS_=e.format.KML.NAMESPACE_URIS_.concat(m);f(g,m);var y=[e.format.GPX.GPX_PARSERS_,e.format.GPX.LINK_PARSERS_,e.format.GPX.RTE_PARSERS_,e.format.GPX.RTEPT_PARSERS_,e.format.GPX.TRK_PARSERS_,e.format.GPX.TRKSEG_PARSERS_,e.format.GPX.TRKPT_PARSERS_,e.format.GPX.WPT_PARSERS_,e.format.GPX.LINK_SERIALIZERS_,e.format.GPX.RTE_SEQUENCE_,e.format.GPX.RTE_SERIALIZERS_,e.format.GPX.RTEPT_TYPE_SEQUENCE_,e.format.GPX.TRK_SEQUENCE_,e.format.GPX.TRK_SERIALIZERS_,e.format.GPX.TRKSEG_SERIALIZERS_,e.format.GPX.WPT_TYPE_SEQUENCE_,e.format.GPX.WPT_TYPE_SERIALIZERS_,e.format.GPX.GPX_SERIALIZERS_],d=c(e.format.GPX.NAMESPACE_URIS_.slice().slice(1));u(d,e.format.GPX.NAMESPACE_URIS_);e.format.GPX.NAMESPACE_URIS_=e.format.GPX.NAMESPACE_URIS_.concat(d);f(y,d);e.format.GML3Patched=function(t){var r=new e.format.GML(t);r.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS].featureMember=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal);return r};e.format.GMLBase.prototype.readFeaturesInternal=function(t,r){e.DEBUG&&console.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");var a=t.localName,n=null;if("FeatureCollection"==a){var o=this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS];o.member||(o.member=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal));if("http://www.opengis.net/wfs"===t.namespaceURI)n=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this);else{this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS];n=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this)}}else if("featureMembers"==a||"featureMember"==a||"member"==a){var i,s=r[0],l=s.featureType,p=s.featureNS;if(t.childNodes){l=[],p={};for(w=0,i=t.childNodes.length;w<i;++w){var c=t.childNodes[w];if(1===c.nodeType){var u=c.nodeName.split(":").pop();if(-1===l.indexOf(u)){var f="",g=0,m=c.namespaceURI;for(var y in p){if(p[y]===m){f=y;break}++g}f||(p[f="p"+g]=m);l.push(f+":"+u)}}}if("featureMember"!=a&&"member"!=a){s.featureType=l;s.featureNS=p}}if("string"==typeof p){var d=p;(p={}).p0=d}var h={},v=Array.isArray(l)?l:[l];for(var C in p){var T={};for(w=0,i=v.length;w<i;++w){(-1===v[w].indexOf(":")?"p0":v[w].split(":")[0])===C&&(T[v[w].split(":").pop()]="featureMembers"==a?e.xml.makeArrayPusher(this.readFeatureElement,this):e.xml.makeReplacer(this.readFeatureElement,this))}h[p[C]]=T}n="featureMember"==a||"member"==a?e.xml.pushParseAndPop(void 0,h,t,r):e.xml.pushParseAndPop([],h,t,r)}null===n&&(n=[]);var S=function(e){var t=e.getGeometry();if(e.getProperties()[e.getGeometryName()]&&(!t||!t.flatCoordinates.length))throw"Geometr\xeda no v\xe1lida. \xbfPosible versi\xf3n incorrecta de GML?"};if(n instanceof e.Feature)S(n);else for(var w=0,E=n.length;w<E;w++)S(n[w]);return n};e.format.GML3CRS84=function(){e.format.GML3.call(this,{srsName:"CRS:84"})};e.inherits(e.format.GML3CRS84,e.format.GML3);e.format.GML2CRS84=function(){e.format.GML2.call(this,{srsName:"CRS:84"})};e.inherits(e.format.GML2CRS84,e.format.GML2);e.View.prototype.getValueForResolutionFunction=function(e){var t=e||2,r=this.maxResolution_,a=this.minResolution_,n=Math.log(r/a)/Math.log(t);return function(e){var a=Math.log(r/e)/Math.log(t)/n;return a=Math.max(Math.min(1,a),0)}};e.control.OverviewMap.prototype._validateExtent_=e.control.OverviewMap.prototype.validateExtent_;e.control.OverviewMap.prototype.validateExtent_=function(){this._validateExtent_();this._wrap&&this._wrap.parent.options.alwaysCentered&&this.recenter_()};e.control.OverviewMap.prototype._resetExtent_=e.control.OverviewMap.prototype.resetExtent_;e.control.OverviewMap.prototype.resetExtent_=function(){this._resetExtent_.call(this);var t=this._wrap;if(t.is3D){var r=this.ovmap_.getView(),a=r.calculateExtent(),n=t.get3DCameraLayer().getSource().getFeatures()[0];if(n){coordinates=n.getGeometry().getCoordinates();var o=coordinates[0][0],i=coordinates[0][1];if(!e.extent.containsCoordinate(a,o)||!e.extent.containsCoordinate(a,i)){var s=Math.max(a[0]-o[0],a[1]-o[1],o[0]-a[2],o[1]-a[3],a[0]-i[0],a[1]-i[1],i[0]-a[2],i[1]-a[3]);r.fit(e.extent.buffer(a,s))}}}};const h=e.Image;e.Image=function(){7===arguments.length&&Array.prototype.splice.call(arguments,3,1);return h.apply(this,arguments)};TC.inherit(e.Image,h);var v=function(t,r){var a;if(t){a=(a=e.color.asArray(t)).slice();void 0!==r&&(a[3]=r)}else a=[0,0,0,1];return a},C=function(e,t){var r=e.map.getView(),a=r.getResolution(),n={projection:r.getProjection(),center:r.getCenter(),resolution:a,enableRotation:!1};e.parent.maxExtent&&(n.extent=e.parent.maxExtent);if(t.type===TC.Consts.layerType.WMS||t.type===TC.Consts.layerType.WMTS){var o,i,s=t.getResolutions();if(s&&s.length){o=t.maxResolution||s[0];i=t.minResolution||s[s.length-1];var l=s.indexOf(i),p=s.indexOf(o);n.resolutions=s.slice(p,l+1)}else{o=t.maxResolution;i=t.minResolution}if(i){n.minResolution=i;a<i&&(n.resolution=i)}if(o){n.maxResolution=o;a>o&&(n.resolution=o)}}return n};TC.wrap.Map.prototype.setMap=function(){var t=this,r=[(t.parent.initialExtent[0]+t.parent.initialExtent[2])/2,(t.parent.initialExtent[1]+t.parent.initialExtent[3])/2],a=proj4(t.parent.crs);!function(){var r=t.parent.crs.substr(t.parent.crs.lastIndexOf(":")+1),n={units:a.oProj.units,global:!0},o=[];if("4326"!==r){n.code="EPSG:"+r;o.push(new e.proj.Projection(n));n.code="urn:ogc:def:crs:EPSG::"+r;o.push(new e.proj.Projection(n));e.proj.addEquivalentProjections(o)}var i=function(e,t,r,a){for(var n=[],o=a||2,i=0;i<t.length;i+=o){var s=Array.prototype.slice.call(e(t.slice(i,i+o)));3!==o&&4!==o||(s=s.slice(0,2).concat(t.slice(i+2,i+2+(o-2))));n=n.concat(s)}if($.isArray(r)){r.length=0;for(i=0;i<n.length;i++)r[i]=n[i];n=r}return n};e.proj.addEquivalentTransforms(e.proj.EPSG4326.PROJECTIONS,o,function(e,t,r){return i(a.forward,e,t,r)},function(e,t,r){return i(a.inverse,e,t,r)})}();var n={code:t.parent.crs,units:a.oProj.units};"EPSG:4326"===t.parent.crs&&(n.axisOrientation="neu");var o=new e.proj.Projection(n),i=e.interaction.defaults({constrainResolution:!0}),s={projection:o,center:r,enableRotation:!1};if(t.parent.maxExtent){var l=t.parent.maxExtent;s.extent=l;var c=t.parent.div.getBoundingClientRect(),u=(c.width,c.height,l[2]-l[0]),f=l[3]-l[1];c.width/c.height>u/f?s.resolution=u/c.width:s.resolution=f/c.height}else s.zoom=2;t.map=new e.Map({target:t.parent.div,renderer:e.renderer.Type.CANVAS,view:new e.View(s),controls:[],interactions:i});t.map._wrap=t;var g=function(){t.map.updateSize()};$(t.parent.div).on(e.events.EventType.RESIZE,g);t.parent.$events.one(TC.Consts.event.MAPLOAD,g);t.map.on(e.MapBrowserEventType.SINGLECLICK,function(e){t.parent.workLayers.forEach(function(e){delete e._noFeatureClicked});var r=$.map(t.parent.workLayers,function(){return!1});t.map.forEachFeatureAtPixel(e.pixel,function(e,a){if(e._wrap&&e._wrap.parent.showsPopup){for(var n=0;n<t.parent.workLayers.length;n++){if(t.parent.workLayers[n].wrap.layer===a){r[n]=!0;break}}t.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:e._wrap.parent}));return e}},{hitTolerance:p});for(var a=0;a<r.length;a++)r[a]||t.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:t.parent.workLayers[a]}))});t.map.getView().on("change:resolution",function(){t.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))},t.parent);t.map.on(e.MapEventType.MOVEEND,function(){t.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))});t.mapDeferred.resolve(t.map);var m=function(r){t.map.getView().getResolution(),t.map.getView().getZoom();var a=C(t,r),n=new e.View(a);t.map.setView(n);t.map.render()};t.parent.$events.on(TC.Consts.event.BASELAYERCHANGE,function(e){t.parent.crs!==t.parent.options.crs||t.parent.on3DView||m(e.layer)});t.parent.$events.on(TC.Consts.event.MAPLOAD,function(e){m(t.parent.getBaseLayer())})};var T=function(t,r){var a=t.getUnits();return a&&a!==e.proj.Units.DEGREES?e.proj.METERS_PER_UNIT[a]:TC.Util.getMetersPerDegree(r)};TC.wrap.Map.prototype.getMetersPerUnit=function(){return T(e.proj.get(this.parent.crs),this.getExtent())};var S=function(t){t=t||{};var r=this.parent.options.crs||TC.Cfg.crs,a=e.proj.get(r),n=e.proj.get(t.crs);return T(n,t.extentInDegrees)/T(a,t.extentInDegrees)},w=function(t){var r;(r=t.axisOrientation?new e.proj.Projection({code:t.crs,axisOrientation:t.axisOrientation}):e.proj.get(t.crs)).getUnits()||(r.units_=e.proj.Units.DEGREES);return r};TC.wrap.Map.prototype.setProjection=function(t){var r,a=(t=t||{}).baseLayer||this.parent.baseLayer;r=t.extent?t.extent:e.proj.transformExtent(this.getExtent(),this.parent.crs,t.crs);var n=S.call(this,{crs:t.crs,extentInDegrees:e.proj.transformExtent(r,t.crs,"EPSG:4326")}),o=w(t),i=this.map.getView(),s={projection:o,enableRotation:!1},l=a.getResolutions();if(l&&l.length)s.resolutions=l;else{s.minZoom=i.getMinZoom();s.maxZoom=i.getMaxZoom();var p=a.wrap.layer.getMinResolution();0!==p&&(s.minResolution=p);var c=a.wrap.layer.getMaxResolution();c!==Number.POSITIVE_INFINITY&&(s.maxResolution=c)}s.center=e.proj.transformExtent(this.getCenter(),this.parent.crs,t.crs);var u=new e.View(s);this.map.setView(u);this.parent.initialExtent=1!==n?e.proj.transformExtent(this.parent.initialExtent,this.parent.crs,t.crs):this.parent.options.initialExtent;this.parent.options.maxExtent&&(this.parent.maxExtent=1!==n?e.proj.transformExtent(this.parent.maxExtent,this.parent.crs,t.crs):this.parent.options.maxExtent);u.fit(r,{nearest:!0})};TC.wrap.Map.prototype.insertLayer=function(t,r){for(var a=this,n=a.map.getLayers(),o=!1,i=0;i<n.getLength();i++)if(n.item(i)===t){o=!0;break}if(o){n.remove(t);n.insertAt(r,t)}else{r<0?n.push(t):n.insertAt(r,t);var s=a.map.getView();if(a.parent.crs===a.parent.options.crs){if(t instanceof e.layer.Tile){var l=t.getSource().getResolutions();s.maxResolution_=l[0];s.minResolution_=l[l.length-1]}}else if(t instanceof e.layer.Tile){t.setMaxResolution(s.getMaxResolution());t.setMinResolution(s.getMinResolution())}var p=t._wrap,c=0,u=function(e){p.parent.state=TC.Layer.state.LOADING;if(c<=0){c=0;a.parent.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:p.parent}))}t._loadingTileCount=t._loadingTileCount+1};p.parent.state===TC.Layer.state.LOADING&&p.parent.isRaster()&&u();p.$events.on(TC.Consts.event.BEFORETILELOAD,u);p.$events.on(TC.Consts.event.TILELOAD,function(e){if((c-=1)<=0){c=0;p.parent.state=TC.Layer.state.IDLE;a.parent.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:p.parent}))}})}};TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)};TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()};TC.wrap.Map.prototype.indexOfFirstVector=function(){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,a){r instanceof e.layer.Vector&&-1===t&&(t=a)});return t};TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,a){r===e&&(t=a)});return t};TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers().getArray().indexOf(e);if(r>-1&&r!=t){this.map.removeLayer(e);this.insertLayer(e,t)}};TC.wrap.Map.prototype.setBaseLayer=function(t){var r=this,a=new $.Deferred,n=function(n){if(n=n||r.parent.getBaseLayer()){r.map.removeLayer(n.wrap.getLayer());if(t instanceof e.layer.Image){S.call(r,{crs:r.parent.crs,extent:r.parent.getExtent()});t._wrap.setProjection({crs:r.parent.crs})}if(t._wrap.parent.type===TC.Consts.layerType.WMTS){var o={crs:r.parent.crs,oldCrs:t.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t._wrap.parent.setProjection(o)}}r.insertLayer(t,0);a.resolve()},o=C(r,t._wrap.parent),i=r.map.getView(),s=i.getResolution();if(r.parent.crs===r.parent.options.crs&&o.resolutions){var l=o.resolutions.sort(function(e,t){return e-t}).reduce(function(e,t){return 0===e&&(t>s||Math.abs(1-s/t)<r.parent.options.maxResolutionError)?t:e},0);if(l!==s)if(r.parent.isLoaded)i.animate({resolution:l,duration:TC.Consts.ZOOM_ANIMATION_DURATION},n.bind(r,r.parent.getBaseLayer()));else{i.setResolution(l);n()}else n()}else n();return a.promise()};TC.wrap.Map.prototype.setExtent=function(t,r){var a=this;a.done&&a.done.resolve();a.done=new $.Deferred;var n=r||{};clearTimeout(a._timeout);a._timeout=setTimeout(function(){var r=a.map.getSize(),o=a.map.getView(),i=function(){a.done.resolve()},s=function(){var e=o.getResolutionForExtent(t,r);if(o.constrainResolution){var a=o.constrainResolution(e,0,0);a<e&&a/e<TC.Consts.EXTENT_TOLERANCE&&(a=o.constrainResolution(a,-1,0));e=a}const s=[(t[0]+t[2])/2,(t[1]+t[3])/2];if(void 0===n.animate||n.animate)o.animate({resolution:e,center:s,duration:TC.Consts.ZOOM_ANIMATION_DURATION},i);else{o.setCenter(s);o.setResolution(e);i()}};a.parent.baseLayer?$.when(a.parent.baseLayer.wrap.getLayer()).then(function(n){if(n.getSource().getResolutions!=goog.abstractMethod){var i=o.getResolutionForExtent(t,r),l=a.map.getView().getResolutions();if(l&&l.length>0){var p=Math.min.apply(a,l);if(p>i){var c=.5*(p/i-1),u=e.extent.getWidth(t)*c,f=e.extent.getHeight(t)*c;(t=t.slice(0))[0]=t[0]-u;t[1]=t[1]-f;t[2]=t[2]+u;t[3]=t[3]+f}}}s()}):s()},50);return a.done};TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())};TC.wrap.Map.prototype.setCenter=function(e,t){var r=$.Deferred(),a=t||{},n=this.map.getView();if(a.animate)n.animate({center:e,duration:TC.Consts.ZOOM_ANIMATION_DURATION},function(){r.resolve()});else{n.setCenter(e);r.resolve()}return r.promise()};TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()};TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()};TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.getView().setResolution(e)})};TC.wrap.Map.prototype.setRotation=function(e){$.when(this.getMap()).then(function(t){t.getView().setRotation(e)})};TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()};TC.wrap.Map.prototype.getResolutions=function(){return this.map.getView().getResolutions()||[]};TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)};TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};TC.wrap.Map.prototype.getViewport=function(e){if((e||{}).synchronous)t=this.map.getViewport();else{var t=new $.Deferred;$.when(this.getMap()).then(function(e){t.resolve(e.getViewport())})}return t};TC.wrap.Map.prototype.isNative=function(t){return t instanceof e.Map};TC.wrap.Map.prototype.isGeo=function(){var t=this.map.getView().getProjection().getUnits();return!t||t===e.proj.Units.DEGREES};TC.wrap.Map.prototype.addPopup=function(t){var r=$.Deferred(),a=this,o=void 0===t.options.draggable||t.options.draggable;TC.loadJS(o&&!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){$.when(a.getMap()).then(function(r){if(!t.$popupDiv){var i=TC.Util.getDiv();t.$popupDiv=$(i);t.$popupDiv.addClass(TC.control.Popup.prototype.CLASS).appendTo(a.parent.div);t.$contentDiv=$(TC.Util.getDiv()).addClass(TC.control.Popup.prototype.CLASS+"-content").appendTo(t.$popupDiv);t.$menuDiv=$(TC.Util.getDiv()).addClass(TC.control.Popup.prototype.CLASS+"-menu").appendTo(t.$popupDiv);var s=new e.Overlay({element:i,positioning:e.OverlayPositioning.BOTTOM_LEFT});r.addOverlay(s);t.wrap.popup=s;t._firstRender.resolve();t.$events.trigger($.Event(TC.Consts.event.CONTROLRENDER));var l=$(r.getViewport());if(o){var c=t.$popupDiv.parent();t.$popupDiv.addClass(TC.Consts.classes.DRAGGABLE);c.on("touchmove",function(e){$(e.target).parents(".tc-ctl-finfo-layer-content").length&&e.stopPropagation()}).drag("start",function(e,a){var n=e.target.getBoundingClientRect();if(n.left+e.target.clientWidth<e.clientX||n.top+e.target.clientHeight<e.clientY)return!1;t.setDragging(!0);t._currentOffset=s.getOffset();if(t._previousContainerPosition){var o=r.getSize();s.setPosition(r.getCoordinateFromPixel([t._previousContainerPosition[0],o[1]-t._previousContainerPosition[1]]));t._currentOffset=[0,0];s.setOffset(t._currentOffset);delete t._previousContainerPosition}else t._currentOffset=s.getOffset()}).drag("end",function(e,a){t.setDragging(!1);var n=r.getCoordinateFromPixel([0,0]),o=r.getCoordinateFromPixel(s.getOffset()),i=[o[0]-n[0],o[1]-n[1]],l=s.getPosition();s.setPosition([l[0]+i[0],l[1]+i[1]]);s.setOffset([0,0]);t._currentOffset=[0,0];t._previousContainerPosition=[parseInt(c.css("left")),parseInt(c.css("bottom"))]}).drag(function(e,r){if(!e.buttons&&!Modernizr.touch)return!1;s.setOffset([t._currentOffset[0]+r.deltaX,t._currentOffset[1]+r.deltaY])},{not:"th,td, td *,input,select,.tc-ctl-finfo-coords"}).on("mouseenter",function(e){l.off(n+".popup")}).on("mouseleave",function(e){l.on(n+".popup",u)})}var u=function(e){var t=r.getTarget(),n=!1;if(!a.parent.activeControl||!a.parent.activeControl.isExclusive()){var o=r.getEventPixel(e.originalEvent);n=r.forEachFeatureAtPixel(o,function(e,t){var r=!0;!e._wrap||e._wrap.parent.showsPopup||e._wrap.parent.options.selectable||(r=!1);r&&e._wrap&&a.parent.$events.trigger($.Event(TC.Consts.event.FEATUREOVER,{feature:e._wrap.parent}));return r},{hitTolerance:p})}t.style.cursor=n?"pointer":""};l.off(n+".popup").on(n+".popup",u)}});r.resolve()});r.promise()};TC.wrap.Map.prototype.hidePopup=function(e){this.parent.currentFeature=null;e.$popupDiv&&e.$popupDiv.removeClass(TC.Consts.classes.VISIBLE)};var E=function(t){switch(t){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:return new e.format.KML({showPointNames:!1});case TC.Consts.layerType.GPX:case TC.Consts.mimeType.GPX:return new e.format.GPX;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new e.format.GeoJSON;case TC.Consts.format.GML2:return new e.format.GML2;case TC.Consts.format.GML3:return new e.format.GML3Patched;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new e.format.GML;case TC.Consts.format.TOPOJSON:return new e.format.TopoJSON;case TC.Consts.format.WKT:return new e.format.WKT;default:return null}};TC.wrap.Map.prototype.exportFeatures=function(t,r){r=r||{};var a=I({styles:this.parent.options.styles}),n=t.map(function(e){var t=e.wrap.feature;t.getStyle()||t.setStyle(a);const r=q.call(t).getText();r&&(t=t.clone()).setProperties({name:r.getText()});return t}),o=E(r.format);if(o instanceof e.format.KML){const t=[];(n=n.map(function(t){const r=t.getGeometry();if(r instanceof e.geom.Point){var a=q.call(t);const n=a.getImage();if(n instanceof e.style.RegularShape){const o=n.getRadius(),i=n.getStroke(),s=(n.getFill(),2*o+i.getWidth()+1),l=s/2,p=document.createElement("canvas");p.width=s;p.height=s;const c=e.render.toContext(p.getContext("2d"),{size:[s,s]}),u=a.getText();(a=a.clone()).setText();c.setStyle(a);c.drawGeometry(new e.geom.Point([l,l]));const f=new e.Feature(r);f.setProperties(t.getProperties());f.setStyle(new e.style.Style({image:new e.style.Icon({src:p.toDataURL("image/png")}),text:u}));return f}}return t})).forEach(function(r){var a=q.call(r);const n=r.getGeometry(),o=a.getText();var i;if(o){switch(!0){case n instanceof e.geom.LineString:i=new e.geom.Point(n.getCoordinateAt(.5));break;case n instanceof e.geom.Polygon:i=n.getInteriorPoint();break;case n instanceof e.geom.MultiLineString:const t=n.getLineStrings();var s=-1;i=new e.geom.Point(t[t.map(function(e){return e.getLength()}).reduce(function(e,t,r){if(t>s){s=t;return r}return e},-1)].getCoordinateAt(.5));break;case n instanceof e.geom.MultiPolygon:const r=n.getPolygons();var l=-1;i=r[r.map(function(e){return e.getArea()}).reduce(function(e,t,r){if(t>l){l=t;return r}return e},-1)].getInteriorPoint()}if(i){const r=new e.Feature(i);r.setStyle(new e.style.Style({text:o.clone(),image:new e.style.Icon({crossOrigin:"anonymous",src:TC.apiLocation+"TC/css/img/transparent.gif"})}));t.push(r)}}});t.length&&(n=n.concat(t))}if(o instanceof e.format.GMLBase){(n=n.map(function(e){return e.clone()})).forEach(function(e){const t=e.values_,r=[];for(var a in t)a.indexOf(" ")>=0&&r.push(a);r.forEach(function(e){var r=e.replace(/ /g,"_");/^\d/.test(r)&&(r="_"+r);if(e!==r)for(;void 0!==t[r];)r+="_";t[r]=t[e];delete t[e]})});o.featureNS="sitna";o.featureType="feature";var i=o.writeFeaturesNode(n,{featureProjection:this.parent.crs}),s=e.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");e.xml.setAttributeNS(s,"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",o.schemaLocation);i.removeAttribute("xmlns:xsi");i.removeAttribute("xsi:schemaLocation");s.appendChild(i)}o instanceof e.format.GPX&&(n=n.map(function(t){const r=t.getGeometry();r instanceof e.geom.LineString&&(t=t.clone()).setGeometry(new e.geom.MultiLineString([r.getCoordinates()]));return t}));var l=o.writeFeatures(n,{dataProjection:"EPSG:4326",featureProjection:this.parent.crs});o instanceof e.format.GPX&&(l=l.replace(/<ele>NaN<\/ele>/g,""));return l};var L=function(e){for(var t=0,r=e.dataTransfer.types.length;t<r;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},M=function(e){if(L(e)){this.getMap()._wrap.parent._$div.addClass(TC.Consts.classes.DROP);e.preventDefault();e.stopPropagation()}},R=function(e){if(L(e)){var t=this.getMap()._wrap.parent;e.target===this.target&&t._$div.removeClass(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(t){var r=this,a=t||{},n={formatConstructors:[e.format.KML,e.format.GPX,e.format.GML3CRS84,e.format.GML2CRS84,e.format.GML3Patched,e.format.GML2,e.format.GeoJSON,function(){return new e.format.WKT({splitCollection:!0})},e.format.TopoJSON]};a.dropTarget?n.target=TC.getDiv(a.dropTarget):n.target=r.parent.div;var o=new e.interaction.DragAndDrop(n);o.on(e.interaction.DragAndDrop.EventType_.ADD_FEATURES,function(e){var t=e.features?e.features.map(function(e){return TC.wrap.Feature.createFeature(e)}):[];$.when.apply(this,t).then(function(){var t=r.parent.getLoadingIndicator();t&&t.removeWait(r._featureImportWaitId);if(arguments.length){for(var a=new Array(arguments.length),n=0,o=a.length;n<o;n++)a[n]=arguments[n];r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORT,{features:a,fileName:e.file.name}))}else r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORTERROR,{file:e.file}))})});if(a.once)o.map_=r.map;else{r.map.addInteraction(o);var i=o.target?o.target:r.map.getViewport(),s=function(e){if(L(e)){var t=r.parent;if(o.target===e.target){var a=t.getLoadingIndicator();a&&(r._featureImportWaitId=a.addWait());e.stopPropagation()}else e.preventDefault();t._$div.removeClass(TC.Consts.classes.DROP)}};o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGENTER,M,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGENTER,M,o));o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGOVER,M,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGOVER,M,o));o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DROP,s,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DROP,s,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragleave",R,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragend",R,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragexit",R,o));document.addEventListener("mouseenter",function(e){e.buttons||r.parent._$div.removeClass(TC.Consts.classes.DROP)},!1);r.ddEnabled=!0}return o};TC.wrap.Map.prototype.loadFiles=function(t){var r;this.ddEnabled?this.map.getInteractions().forEach(function(t){t instanceof e.interaction.DragAndDrop&&(r=t)}):r=this.enableDragAndDrop({once:!0});var a=this.parent.getLoadingIndicator();a&&(this._featureImportWaitId=a.addWait());e.interaction.DragAndDrop.handleDrop_.call(r,{dataTransfer:{files:t}})};TC.wrap.Layer.prototype.getVisibility=function(e){var t=!1;this.layer&&(t=this.layer.getVisible());return t};TC.wrap.Layer.prototype.setVisibility=function(e){$.when(this.getLayer()).then(function(t){t.setVisible(e)})};TC.wrap.Layer.prototype.isNative=function(t){return t instanceof e.layer.Layer};TC.wrap.Layer.prototype.setProjection=function(t){const r=this;t=t||{};const a=r.parent;if(a.map){const o=S.call(r,{crs:t.crs,extentInDegrees:e.proj.transformExtent(a.map.getExtent(),a.map.crs,"EPSG:4326")});var n=a.getResolutions();if(n&&n.length){n=n.map(function(e){return e/o});a.wrap.layer.setMaxResolution(n[0]);a.wrap.layer.setMinResolution(n[n.length-1])}else{if(a.minResolution){a.minResolution=a.minResolution/o;r.layer.setMinResolution(a.minResolution)}if(a.maxResolution){a.maxResolution=a.maxResolution/o;r.layer.setMaxResolution(a.maxResolution)}}}};TC.wrap.layer.Raster.prototype.WmsParser=e.format.WMSCapabilities;TC.wrap.layer.Raster.prototype.WmtsParser=e.format.WMTSCapabilities;TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent}))},t.parent.map)};TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null;switch(this.getServiceType()){case TC.Consts.layerType.WMS:for(var t=this.parent.capabilities.Capability.Request.GetMap.DCPType,r=0;r<t.length;r++)if(t[r].HTTP&&t[r].HTTP.Get){e=t[r].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=this.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}return e=$("<textarea />").html(e).text()};TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format);return e};TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"];TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this.parent.capabilities;if(t&&t.Contents)for(var r=0;r<t.Contents.Layer.length;r++)for(var a=t.Contents.Layer[r],n=0;n<a.TileMatrixSetLink.length;n++)if(this.parent.options.matrixSet===a.TileMatrixSetLink[n].TileMatrixSet){e=a;break}return e};TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this.parent.capabilities;if(r&&r.Contents&&r.Contents.TileMatrixSet)for(var a=0;a<r.Contents.TileMatrixSet.length;a++){var n=r.Contents.TileMatrixSet[a];if(n.Identifier===e){t=n.TileMatrix;break}}return t};TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[];e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]);if(!t.length&&!this.getName(e)){for(var r=this.getLayerNodes(e),a=-1/0,n=1/0,o=0,i=r.length;o<i;o++){var s=this.getScaleDenominators(r[o]);s[0]>a&&(a=s[0]);s[1]<n&&(n=s[1])}a>-1/0&&n<1/0&&(t=[a,n])}return t};TC.wrap.layer.Raster.prototype.getAttribution=function(){const e={},t=TC.capabilities[this.parent.url];if(t)if(t.ServiceProvider){e.name=t.ServiceProvider.ProviderName.trim();e.site=t.ServiceProvider.ProviderSite;e.site.href&&e.site.href.trim().length>0&&(e.site=e.site.href)}else t.ServiceIdentification?e.name=t.ServiceIdentification.Title.trim():e.name=t.Service.Title.trim();return e};TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},a=t.parent.capabilities;if(a&&a.Capability)for(var n=t.getAllLayerNodes(),o=0;o<n.length;o++){var i=n[o];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title);i.Abstract&&(r.abstract=i.Abstract);r.legend=[];var s=function(e,r){if(e.Layer&&e.Layer.length>0)for(var a in e.Layer)s(e.Layer[a],r);else r.apply(t,[e])};s(i,function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})});if(i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var l=0;l<i.MetadataURL.length;l++){var p=i.MetadataURL[l];r.metadata.push({format:p.Format,type:p.type,url:p.OnlineResource})}}r.queryable=i.queryable;break}}return r};TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS);return e};TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title);return e};TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e;this.getServiceType()===TC.Consts.layerType.WMS&&(e=this.parent.capabilities.Capability.Layer);return e};TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var a=r.indexOf(":");a>=0&&(r=r.substr(a+1))}return r};TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier};TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;$.isArray(t)||(t=t?[t]:[]);return t};TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=e.getRootLayerNode();e._layerList=t?function t(r){for(var a=[r],n=e.getLayerNodes(r),o=0;o<n.length;o++)a=a.concat(t(n[o]));return a}(t):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList};TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e};TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e};TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var a=r[0].LegendURL[0];t.src=$("<textarea />").html(a.OnlineResource).text()}return t};TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.Capability&&a.capabilities.Capability.Layer&&a.names.length>0)for(var n=a.names.slice(0),o=function r(n,o,i){var s=!1;if(n)for(var l=0;l<n.length;l++){var p=n[l];const u=p.CRS||p.SRS,f=Array.isArray(u)?u:[u];var c=i||$.inArray(e,f)>=0;if(a.compareNames(t.getName(p),o)){c&&(s=!0);break}if(r(p.Layer,o,c)){s=!0;break}}return s};n.length>0;)if(!o([a.capabilities.Capability.Layer],n.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:r=!1;if(a.capabilities&&a.capabilities.Contents&&a.capabilities.Contents.TileMatrixSet)for(var i=a.capabilities.Contents.TileMatrixSet,s=0;s<i.length;s++)if(i[s].Identifier===a.options.matrixSet){r=TC.Util.CRSCodesEqual(e,i[s].SupportedCRS);break}}return r};TC.wrap.layer.Raster.prototype.getCompatibleCRS=function(){var e=[],t=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(t.capabilities&&t.capabilities.Capability&&t.capabilities.Capability.Layer&&t.names.length>0){const r=t.names.map(function(e){return t.getNodePath(e).map(function(e){const t=e.CRS||e.SRS||[],r=Array.isArray(t)?t:[t];return $.isArray(r)?r:[r]}).reduce(function(e,t){if(0===e.length)return t;t.forEach(function(t){e.indexOf(t)<0&&(e[e.length-1]=t)});return e})});if(1===r.length)e=r[0];else{const t=r.slice(1);e=r[0].filter(function(e){return t.every(function(t){return t.indexOf(e)>=0})})}}break;case TC.Consts.layerType.WMTS:t.capabilities&&t.capabilities.Contents&&t.capabilities.Contents.Layer.filter(function(e){return e.Identifier===t.layerNames}).forEach(function(r){const a=r.TileMatrixSetLink.map(function(e){return e.TileMatrixSet});e=t.capabilities.Contents.TileMatrixSet.filter(function(e){return a.indexOf(e.Identifier)>=0}).map(function(e){return e.SupportedCRS})})}return e};TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=[],r=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(r.capabilities&&r.capabilities.Capability&&r.capabilities.Capability.Layer){var a=function(e,r,n){var o=e.CRS||e.SRS,i=Array.isArray(o)?o:[o],s=n||$.inArray(r,i)>=0;s&&e.Name&&(t[t.length]=e.Name);if(e.Layer)for(var l=0;l<e.Layer.length;l++)a(e.Layer[l],r,s)};a(r.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:if(r.capabilities&&r.capabilities.Contents&&r.capabilities.Contents.TileMatrixSet)for(var n=r.capabilities.Contents.TileMatrixSet,o=0,i=n.length;o<i;o++){var s=n[o];if(TC.Util.CRSCodesEqual(e,s.SupportedCRS))for(var l=s.Identifier,p=r.capabilities.Contents.Layer,c=0,u=p.length;c<u;c++)for(var f=p[c].TileMatrixSetLink,g=0,m=f.length;g<m;g++)if(f[g].TileMatrixSet===l){t[t.length]=p[c].Identifier;break}}}return t};TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets=function(e){var t=[];w({crs:e});var r=this.parent;if(this.getServiceType()===TC.Consts.layerType.WMTS)for(var a=r.capabilities.Contents.Layer,n=r.capabilities.Contents.TileMatrixSet,o=0,i=a.length;o<i;o++)if(r.layerNames===a[o].Identifier)for(var s=a[o].TileMatrixSetLink,l=0,p=s.length;l<p;l++)for(var c=s[l],u=0,f=n.length;u<f;u++){var g=n[u];if(g.Identifier===c.TileMatrixSet){TC.Util.CRSCodesEqual(e,g.SupportedCRS)&&(t[t.length]=g.Identifier);break}}return t};TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;$.when(e.getLayer()).then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};TC.wrap.layer.Raster.prototype.createWMSLayer=function(t,r,a){var n=this,o=null;n.$events=$(n);var i=new e.source.ImageWMS({url:t,crossOrigin:a.map?a.map.options.crossOrigin:void 0,params:r,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:$.proxy(n.parent.getImageLoad,n.parent)});i.on(e.source.Image.EventType_.IMAGELOADSTART,function(e){n.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()}))});i.on(e.source.Image.EventType_.IMAGELOADEND,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))});i.on(e.source.Image.EventType_.IMAGELOADERROR,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))});var s={visible:!!r.LAYERS.length||a&&a.method&&"POST"===a.method,source:i};a.minResolution&&(s.minResolution=a.minResolution);a.maxResolution&&(s.maxResolution=a.maxResolution);(o=new e.layer.Image(s))._wrap=n;n.addCommonEvents(o);return o};var _=function(t){var r=this,a=null,n=e.source.WMTS.optionsFromCapabilities(r.parent.capabilities,{layer:t.layerNames,matrixSet:t.matrixSet,crossOrigin:t.map?t.map.options.crossOrigin:void 0,requestEncoding:t.encoding,format:t.format});"https:"===location.protocol&&(n.urls=n.urls.map(function(e){return e.replace("http:","https:")}));n.crossOrigin=t.map?t.map.options.crossOrigin:void 0;(a=new e.source.WMTS(n)).setTileLoadFunction($.proxy(r.parent.getImageLoad,r.parent));a.on(e.source.TileEventType.TILELOADSTART,function(e){r.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()}))});a.on(e.source.TileEventType.TILELOADEND,function(e){r.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))});a.on(e.source.TileEventType.TILELOADERROR,function(e){r.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))});var o=$.proxy(a.getResolutions,a);a.getResolutions=function(){var e=o(),t=r.parent.getLimitedMatrixSet();if(t&&t.length){var a=t[0].matrixIndex;e=e.slice(a,t.length+a)}return e};return a};TC.wrap.layer.Raster.prototype.createWMTSLayer=function(t){var r=null;this.$events=$(this);var a=_.call(this,t),n={source:a};t.minResolution&&(n.minResolution=t.minResolution);t.maxResolution&&(n.maxResolution=t.maxResolution);(r=new e.layer.Tile(n))._wrap=this;this.addCommonEvents(r);var o=a.getResolutions();r.setMaxResolution(o[0]+1);r.setMinResolution(o[o.length-1]);return r};TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()};TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)};TC.wrap.layer.Raster.prototype.setMatrixSet=function(e){const t=this;t.layer.getSource().getResolutions();if(t.parent.type===TC.Consts.layerType.WMTS){const r=_.call(t,$.extend({},t.parent.options,{matrixSet:e})),a=r.getResolutions(),n=a[0],o=a[a.length-1];t.layer.setMaxResolution(n);t.layer.setMinResolution(o);t.parent.minResolution&&(t.parent.minResolution=o);t.parent.maxResolution&&(t.parent.maxResolution=n);t.layer.setSource(r)}};TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions&&e.getResolutions!=goog.abstractMethod?e.getResolutions():[]}return[]};TC.wrap.Geometry={getNearest:function(t,r){return new e.geom.LineString(r).getClosestPoint(t)}};var P=function(e,t,r){if(e){var a=function(a){var n=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(n<a){var o=n/a;e.setScale(o)}},n=e.getSize();if(n)a(n[0]);else{var o=e.getImage();o.naturalWidth?a(o.naturalWidth):$('<img src="'+e.getSrc()+'">').on("load",function(){a(this.naturalWidth)})}}},x=function(e,t){var r=e,a=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var n=e.match(/^\$\{(.+)\}$/);if(n&&a){for(var o=n[1].split("."),i=a.getProperties(),s=0;s<o.length&&void 0!==i;s++)i=i[o[s]];if(void 0===i){i=t.data;for(s=0;s<o.length&&void 0!==i;s++)i=i[o[s]]}r=i}}else $.isFunction(e)&&(r=e(t));return r},A=function(e){var t=e.getStyle();$.isFunction(t)&&(t=t.call(e));$.isArray(t)&&(t=t[0]);return t},I=function(t,r){var a,n,o={};r&&(a=r._wrap?r._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:r}),features:r.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:r})}});var i={};if((n=a&&$.isArray(a.features)&&a.features.length>1&&t.cluster?$.extend(!0,{},TC.Cfg.styles.cluster,t.cluster.styles):t.styles||TC.Cfg.styles).line){i=n.line;o.stroke=new e.style.Stroke({color:x(n.line.strokeColor,a),width:x(n.line.strokeWidth,a),lineDash:n.line.lineDash})}if(n.polygon){i=n.polygon;o.fill=new e.style.Fill({color:v(x(n.polygon.fillColor,a),x(n.polygon.fillOpacity,a))});o.stroke=new e.style.Stroke({color:x(n.polygon.strokeColor,a),width:x(n.polygon.strokeWidth,a),lineDash:n.polygon.lineDash})}if(n.point){i=n.point;var s={radius:x(i.radius,a)||(x(i.height,a)+x(i.width,a))/4};i.fillColor&&(s.fill=new e.style.Fill({color:v(x(i.fillColor,a),x(i.fillOpacity,a))}));i.strokeColor&&(s.stroke=new e.style.Stroke({color:x(i.strokeColor,a),width:x(i.strokeWidth,a),lineDash:i.lineDash}));isNaN(s.radius)||(o.image=new e.style.Circle(s))}i.label&&(o.text=F(i,a));if(n.marker){if((i=n.marker).url){o.image=new e.style.Icon({crossOrigin:"anonymous",anchor:i.anchor,anchorXUnits:i.anchorXUnits||"fraction",anchorYUnits:i.anchorYUnits||"fraction",src:i.url});o.text=F(i,a)}}return[new e.style.Style(o)]},F=function(t,r){if(t&&t.label){var a={text:""+x(t.label,r)};t.fontSize&&(a.font=x(t.fontSize,r)+"pt sans-serif");t.angle&&(a.rotation=-Math.PI*x(t.angle,r)/180);t.fontColor&&(a.fill=new e.style.Fill({color:v(x(t.fontColor,r),1)}));t.labelOutlineColor&&(a.stroke=new e.style.Stroke({color:v(x(t.labelOutlineColor,r),1),width:x(t.labelOutlineWidth,r)}));if(t.labelOffset){a.offsetX=t.labelOffset[0];a.offsetY=t.labelOffset[1]}return new e.style.Text(a)}},O=function(e){var t=e.toString(16);1===t.length&&(t="0"+t);return t},G=function(e){return"#"+O(e[0])+O(e[1])+O(e[2])},N=function(t,r){var a={};$.isFunction(t)&&r&&(t=t(r));$.isArray(t)&&(t=t[0]);if(!$.isFunction(t)){var n,o,i,s=t.getImage();if(s)if(s instanceof e.style.RegularShape){o=s.getStroke();n=e.color.asArray(o.getColor());a.strokeColor=G(n);a.strokeWidth=o.getWidth();if(i=s.getFill()){n=e.color.asArray(i.getColor());a.fillColor=G(n);a.fillOpacity=n[3]}}else{a.url=s.getSrc();var l=s.getSize();if(l){a.width=l[0];a.height=l[1];a.anchor=s.getAnchor();if(a.anchor){a.anchor[0]=a.anchor[0]/a.width;a.anchor[1]=a.anchor[1]/a.height}}}else{if(o=t.getStroke()){n=e.color.asArray(o.getColor());a.strokeColor=G(n);a.strokeWidth=o.getWidth();a.lineDash=o.getLineDash()}if(i=t.getFill()){n=e.color.asArray(i.getColor());a.fillColor=G(n);a.fillOpacity=n[3]}}}return a};TC.wrap.layer.Vector.prototype.getStyle=function(){return N(this.layer.getStyle())};TC.wrap.layer.Vector.prototype.reloadSource=function(){var t=new $.Deferred,r=this.createVectorSource(this.parent,this.createStyles(this.parent));if(this.parent.type===TC.Consts.layerType.WFS)var a=r.source.on("change",function(n){if("ready"==r.source.getState()){e.Observable.unByKey(a);t.resolve()}});var n=this.layer.getSource().getFeatures();this.layer.setSource(r.source);r.style&&this.layer.setStyle(r.style);if(this.parent.type!=TC.Consts.layerType.WFS){r.source.addFeatures(n);t.resolve()}return t};TC.wrap.layer.Vector.prototype.import=function(e){var t=$.extend({},e);t.type=e.format;var r=this.layer.getSource().getFeatures(),a=this.createVectorSource(t,this.createStyles(this.parent));this.layer.setSource(a.source);a.style&&this.layer.setStyle(a.style);a.source.addFeatures(r)};const b=function(t){const r=$.Deferred();if(t._wrapDeferred)t._wrapDeferred.then(function(e){r.resolve(e.parent)});else{t._wrapDeferred=$.Deferred();var a=void 0,n=t.getGeometry();const o=t.getStyle();o&&(a=N(o,t));const i=function(e){TC.loadJS(!TC.feature||!TC.feature[e],TC.apiLocation+"TC/feature/"+e,function(){r.resolve(new TC.feature[e](t,a));t._wrapDeferred.resolve(t._wrap)})};n instanceof e.geom.Point?!function(t){var r=null,a=A(t);if(a){var n=a.getImage();n instanceof e.style.Icon&&(r=n.getSrc())}return r}(t)?i("Point"):i("Marker"):n instanceof e.geom.LineString?i("Polyline"):n instanceof e.geom.Polygon?i("Polygon"):n instanceof e.geom.MultiLineString?i("MultiPolyline"):n instanceof e.geom.MultiPolygon&&i("MultiPolygon")}return r.promise()};TC.wrap.layer.Vector.prototype.createVectorSource=function(t,r){var a,n,o,i,s,l=this,p=!1;if($.isArray(t.url)||t.urls){var c=t.urls||t.url;n={url:c=$.map(c,function(e,t){return TC.proxify(e)}),format:new e.format.KML({showPointNames:!1}),projection:t.crs}}else if(t.url&&t.type!==TC.Consts.layerType.WFS){(n={url:TC.proxify(t.url),projection:t.crs}).format=E(t.format)||E(function(e){var t=e.indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));switch(e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.mimeType.KML;case"json":case"geojson":return TC.Consts.mimeType.GEOJSON;case"gml":return TC.Consts.mimeType.GML;case"gpx":return TC.Consts.mimeType.GPX;default:return null}}(t.url))||E(t.type);n.loader=(o=n.url,i=n.format,s=e.featureloader.xhr(o,i),function(e,t,r){l.parent.state=TC.Layer.state.LOADING;l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent}));s.call(this,e,t,r)});p=!0}else if(t.data)(n={projection:t.crs,loader:function(e,r,a){l.parent.state=TC.Layer.state.LOADING;l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent}));var n=this.getFormat();try{var o=n.readFeatures(t.data,{featureProjection:a});this.addFeatures(o);l.parent.state=TC.Layer.state.IDLE;l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:l.parent,newData:data}))}catch(e){l.parent.state=TC.Layer.state.IDLE;l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:l.parent,reason:e.message}))}}}).format=E(t.format)||E(t.type);else if(t.type==TC.Consts.layerType.WFS){var u,f;switch(t.outputFormat){case TC.Consts.format.JSON:u=new e.format.GeoJSON({geometryName:t.geometryName});f="json";break;case TC.Consts.format.GML3:u=new e.format.GML3Patched;f=TC.Consts.mimeType.GML;break;default:u=new e.format.GML2;f=TC.Consts.mimeType.GML}n={format:u,loader:function(e,r,a){var n=this,o=t.url;if(o){l.parent.state=TC.Layer.state.LOADING;l.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent}));var i={},s=a.getCode(),p=t.version||"1.1.0",c=o,g=$.isArray(t.featureType)?t.featureType:[t.featureType];if(!t.properties||t.properties instanceof Array&&!t.properties.length||!Object.keys(t.properties).length){c=c+"?service=WFS&version="+p+"&request=GetFeature&typename="+g.join(",")+"&outputFormat="+f+"&srsname="+s;e[0]!==-1/0&&e[1]!==-1/0&&e[2]!==1/0&&e[3]!==1/0&&(c=c+"&bbox="+e.join(",")+","+s);t.maxFeatures&&(c=c+"maxFeatures="+t.maxFeatures)}else{i.type="POST";i.contentType=TC.Consts.mimeType.XML;i.processData=!1;var m=[];m[m.length]='<wfs:GetFeature xmlns:wfs="http://www.opengis.net/wfs" service="WFS" version="';m[m.length]=p;m[m.length]='" outputFormat="';m[m.length]=t.outputFormat;if(t.maxFeatures){m[m.length]='" maxFeatures="';m[m.length]=t.maxFeatures}m[m.length]='" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/';m[m.length]=p;m[m.length]='/wfs.xsd">';for(var y=0;y<g.length;y++){m[m.length]='<wfs:Query typeName="feature:';m[m.length]=g[y];m[m.length]='" srsName="';m[m.length]=s;m[m.length]='">';if(t.propertynames){var d="1.1.0"===p?"wfs":"ogc",h="string"==typeof t.propertynames?t.propertynames.split(","):t.propertynames;t.geometryName&&h.push(t.geometryName);for(;y<h.length;y++)m[m.length]="<"+d+":PropertyName>"+h[y].trim()+"</"+d+":PropertyName>"}m[m.length]=t.properties.getText();m[m.length]="</wfs:Query>"}m[m.length]="</wfs:GetFeature>";i.data=m.join("")}i.url=c;l._requestUrl=c;$.ajax(i).done(function(e){n.addFeatures(u.readFeatures(e));l.parent.state=TC.Layer.state.IDLE;l.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:l.parent,newData:e}))})}},projection:t.crs}}a=new e.source.Vector(n);p&&a.on(e.events.EventType.CHANGE,function(e){l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:l.parent}))});a._tcLayer=l.parent;var g=t.style&&t.style.marker?t.style.marker:TC.Cfg.styles.marker;t.style&&t.style.marker||(g=$.extend({},g,{anchor:TC.Cfg.styles.point.anchor}));if(t.cluster){a=new e.source.Cluster({projection:t.crs,distance:t.cluster.distance,source:a});if(t.cluster.animate){var m=function(t,r){var a=Date.now(),n=t.getGeometry().getCoordinates(),o=r.getGeometry().getCoordinates();r.setGeometry(new e.geom.Point(n));requestAnimationFrame(function i(){var s=function(e,t,r,a){var n=Math.min((Date.now()-a)/r,1),o=(t[0]-e[0])*n,i=(t[1]-e[1])*n;return[e[0]+o,e[1]+i]}(n,o,TC.Consts.CLUSTER_ANIMATION_DURATION,a);r.setGeometry(new e.geom.Point(s));s[0]!==o[0]&&s[1]!==o[1]?requestAnimationFrame(i):y.splice($.inArray(t,y),1)})},y=[];a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature.get("features");t&&t.length>1&&y.push(e.feature)});a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var a=$.grep(y,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});a.length&&y.splice($.inArray(a[0],y),1)}var n=$.grep(y,function(e){var t=e.get("features");if(t&&t.length>0){return $.grep(t,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]}).length>0}});n.length&&m(n[n.length-1],e.feature)}})}}var d=a;do{d.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature,r=A(t);r&&P(r.getImage(),g.width,t)});d=$.isFunction(d.getSource)?d.getSource():null}while(d);a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){const t=e.feature,r=function(e){var r;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:r=l.parent.addPoint;break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:r=l.parent.addPolyline;break;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:r=l.parent.addPolygon;break;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:r=l.parent.addMultiPolygon;break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:r=l.parent.addMultiPolyline}if(r){var a;r.call(l.parent,t).then(function(r){var n=t.get("features");$.isArray(n)&&(r.features=$.map(n,function(t){return new e.constructor(t)}));clearTimeout(a);a=setTimeout(function(){l.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:l.parent,features:[r]}))},50)})}};t._wrap&&t._wrap.parent.layer||b(t).then(r)});a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature;if(t._wrap){var r=$.inArray(t._wrap.parent,l.parent.features);if(r>-1){l.parent.features.splice(r,1);l.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:l.parent,feature:t._wrap.parent}))}}});a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:l.parent}))});a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(){l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:l.parent}))});a.addEventListener(e.source.VectorEventType.CLEAR,function(){l.parent.map&&l.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESCLEAR,{layer:l.parent}))});var h={source:a};t.minResolution&&(h.minResolution=t.minResolution);t.maxResolution&&(h.maxResolution=t.maxResolution);n&&n.format instanceof e.format.KML&&!t.cluster||(h.style=r||t.styles);return h};TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if($.isFunction(e)){r=!0;t.styleFunction=function(t){return I(e(t))}}else{(e=$.extend({},e)).crs=e.crs||TC.Cfg.crs;e.styles=e.styles||TC.Cfg.styles;r=!(!e.cluster||!e.cluster.styles)||function e(t){for(var r in t){var a=t[r];switch(typeof a){case"string":if(/^\$\{(.+)\}$/.test(a))return!0;break;case"object":if(e(a))return!0;break;case"function":return!0}}return!1}(e.styles);t.styleFunction=function(e){return I(t.parent.options,e)}}return r?t.styleFunction:t.styleFunction()};TC.wrap.layer.Vector.prototype.setStyles=function(e){const t=this;$.when(t.getLayer()).then(function(r){r.setStyle(t.createStyles(e))})};TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var t=null;this.$events=$(this);var r=this.parent.options,a=this.createVectorSource(r,this.createStyles(r));a.declutter=this.parent.options.declutter||!1;(t=new e.layer.Vector(a))._wrap=this;this.addCommonEvents(t);return t};TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){for(var r=t;$.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)})};TC.wrap.layer.Vector.prototype.getFeatures=function(){var t=this.getLayer();return t instanceof e.layer.Layer?t.getSource().getFeatures():[]};TC.wrap.layer.Vector.prototype.getFeatureById=function(t){var r=this.getLayer();return r instanceof e.layer.Layer?r.getSource().getFeatureById(t):null};TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){t.getSource().removeFeature(e.wrap.feature)})};TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()})};TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(t,r){var a=this,n={color:"rgba(0, 0, 0, 0)"},o={color:"rgba(0, 0, 0, 0)"},i=new e.style.Style({image:new e.style.Circle({radius:0,fill:new e.style.Fill(n),stroke:new e.style.Stroke(o)}),fill:new e.style.Fill(n),stroke:new e.style.Stroke(o)});if($.inArray(t,a.parent.features)>=0){var s=t.wrap.feature;if(r&&s._originalStyle)s.setStyle(s._originalStyle);else{s._originalStyle=s.getStyle();s.setStyle(i)}$.when(a.getLayer()).then(function(e){a.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:a.parent}))})}};TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return v(e,t)};TC.wrap.layer.Vector.prototype.findFeature=function(e){};TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl};TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl=function(){var e=this.parent,t=e.options.version||"1.1.0",r=e.url;return r=r+"?service=WFS&version="+t+"&request=DescribeFeatureType&typename="+($.isArray(e.options.featureType)?e.options.featureType:[e.options.featureType]).join(",")+"&outputFormat=XMLSCHEMA"};TC.wrap.layer.Vector.prototype.sendTransaction=function(t,r,a){var n=this,o=$.Deferred(),i=function(e){return e.wrap.feature},s=$.map(t,i),l=$.map(r,i),p=$.map(a,i);t.length||r.length||a.length?$.when(n.getLayer()).then(function(t){t.getSource();var r=new e.format.WFS,a=n.parent.options,i=r.writeTransaction(s,l,p,{featurePrefix:a.featurePrefix,featureNS:a.featureNS,featureType:a.featureType[0]}),c={url:n.parent.url,type:"POST",contentType:TC.Consts.mimeType.XML,processData:!1,data:i.outerHTML};$.ajax(c).done(function(e){var t=e.getElementsByTagName("ExceptionReport")[0],a={reason:""};if(t){var n=t.getElementsByTagName("Exception")[0];if(n){a.code=n.getAttribute("exceptionCode");for(var i=n.getElementsByTagName("ExceptionText"),s=0,l=i.length;s<l;s++)a.reason+="\n"+i[s].innerHTML}o.reject(a)}else{var p=r.readTransactionResponse(e);o.resolve(p)}}).fail(function(){o.reject({code:"",reason:"unknown"})})}):o.resolve(n.parent);return o};TC.wrap.layer.Vector.prototype.setDraggable=function(t,r,a){var n=this;$.when(n.parent.map.wrap.getMap(),n.getLayer()).then(function(o,i){if(t){var s={layers:[i],features:new e.Collection(i.getSource().getFeatures())};n.interaction=new e.interaction.Translate(s);$.isFunction(r)&&n.interaction.on(e.interaction.TranslateEventType.TRANSLATEEND,function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)});$.isFunction(a)&&n.interaction.on(e.interaction.TranslateEventType.TRANSLATESTART,function(e){e.features.getLength()&&a(e.features.item(0)._wrap.parent)});o.addInteraction(n.interaction);if(TC.Util.detectIE()){n._handlerDraggablePointerMove=function(e){if(!e.dragging){var t=o.getEventPixel(e.originalEvent);o.hasFeatureAtPixel(t)?o.forEachFeatureAtPixel(t,function(e,t){t._wrap&&t._wrap.parent&&t._wrap.parent.id===n.parent.id&&e?o.getTarget().style.cursor="move":o.getTarget().style.cursor=""},{hitTolerance:p}):o.getTarget().style.cursor=""}};o.on("pointermove",n._handlerDraggablePointerMove)}}else if(n.interaction){o.removeInteraction(n.interaction);if(TC.Util.detectIE()&&n._handlerDraggablePointerMove&&$.isFunction(n._handlerDraggablePointerMove)){o.un("pointermove",n._handlerDraggablePointerMove);delete n._handlerDraggablePointerMove}}})};TC.wrap.layer.Vector.prototype.getFeaturesInExtent=function(t,r){var a=this.getLayer().getSource().getFeatures(),n=[];if(r){var o=this.parent.map.getPixelFromCoordinate([t[0],t[1]]),i=this.parent.map.getPixelFromCoordinate([t[2],t[3]]);o[0]-=r[0]/2;o[1]+=r[1];i[0]+=r[0]/2;t=this.parent.map.getCoordinateFromPixel(o).concat(this.parent.map.getCoordinateFromPixel(i))}for(var s=0;s<a.length;s++){var l=a[s],p=l.getGeometry().getCoordinates();e.extent.containsCoordinate(t,p)&&n.push(l._wrap.parent)}return n};TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){var a=0;e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&a++},{hitTolerance:p});if(!a){t.parent.map.$events.trigger($.Event(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel}));t.parent.callback(r.coordinate,r.pixel)}return 0===a}};TC.wrap.control.Click.prototype.activate=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){r.on(e.MapBrowserEventType.SINGLECLICK,t._trigger)})};TC.wrap.control.Click.prototype.deactivate=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){r.un(e.MapBrowserEventType.SINGLECLICK,t._trigger)})};TC.wrap.control.ScaleBar.prototype.render=function(){this.ctl?this.ctl.updateElement_():this.ctl=new e.control.ScaleLine({target:this.parent.div})};TC.wrap.control.ScaleBar.prototype.getText=function(){if(this.ctl)return this.ctl.renderedHTML_};TC.wrap.control.NavBar.prototype.register=function(t){var r=this;$.when(t.wrap.getMap()).then(function(a){var n=r.parent.div;r.zCtl=new e.control.Zoom({target:n});r.zsCtl=new e.control.ZoomSlider({target:n,render:function(t){if(!t.frameState||!t.frameState.viewState||a.getView().getMinResolution()<=t.frameState.viewState.resolution){var n=function(){if(this.element.offsetWidth>this.element.offsetHeight){r.requestSliderSize||(r.requestSliderSize=window.requestAnimationFrame(n.bind(this)));window.requestAnimationFrame(n.bind(this))}else if(this.element.offsetWidth<this.element.offsetHeight){if(r.requestSliderSize){window.cancelAnimationFrame(r.requestSliderSize);delete r.requestSliderSize}e.control.ZoomSlider.render.call(this,t)}};n.call(this)}}});r.z2eCtl=new e.control.ZoomToExtent({target:n,extent:t.initialExtent,tipLabel:""});a.addControl(r.zCtl);a.addControl(r.zsCtl);a.addControl(r.z2eCtl);var o=r.parent._$div;$buttons=o.find("button").addClass("tc-ctl-btn "+r.parent.CLASS+"-btn").css("display","block").html("");$buttons.filter(".ol-zoom-in").addClass(r.parent.CLASS+"-btn-zoomin").attr("title",r.parent.getLocaleString("zoomIn"));$buttons.filter(".ol-zoom-out").addClass(r.parent.CLASS+"-btn-zoomout").attr("title",r.parent.getLocaleString("zoomOut"));o.find(".ol-zoom-extent button").addClass(r.parent.CLASS+"-btn-home").attr("title",r.parent.getLocaleString("zoomToInitialExtent"));$(t.div).find(".ol-zoomslider").addClass(r.parent.CLASS+"-bar").find(".ol-zoomslider-thumb").addClass(r.parent.CLASS+"-slider");t.on(TC.Consts.event.BASELAYERCHANGE,$.proxy(r.refresh,r))})};TC.wrap.control.NavBar.prototype.refresh=function(){var t=this,r=t.parent.map.wrap.map;if(t.zsCtl.sliderInitialized_){var a=r.getView().getResolution();t.zsCtl.setThumbPosition_(a)}else r.once(e.MapEventType.POSTRENDER,function(e){t.zsCtl.render(e)})};TC.wrap.control.NavBar.prototype.setInitialExtent=function(e){this.z2eCtl.extent=e};TC.wrap.control.Coordinates.prototype.register=function(t){var r=this,a=new $.Deferred;r.map=t;r._coordsTrigger=function(e){r.parent.coordsToClick(e)};$.when(t.wrap.getMap()).then(function(t){r.olMap=t;var n=t.getView().getProjection();r.parent.crs=n.getCode();r.parent.units=n.getUnits();r.parent.isGeo=r.parent.units===e.proj.Units.DEGREES;$(t.getViewport()).add(r.parent.div);a.resolve()});return a};TC.wrap.control.Coordinates.prototype.onMouseMove=function(e){var t=this;$.when(t.map.wrap.getMap()).then(function(r){var a=r.getEventCoordinate(e);if(a){t.parent.isGeo?t.parent.latLon=a.reverse():t.parent.xy=a;t.parent.update.apply(t.parent,arguments)}})};TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e;t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e.originalEvent),e.pixel)};t._postcomposeTrigger=function(e){t.duringTrackSnap(e)};$.when(e.wrap.getMap()).then(function(e){t.olMap=e})};var k=function(){return this.parent.layerTracking.features.filter(function(e){return e instanceof TC.feature.Polyline})[0]};TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){return this.parent.layerTracking.features.length>0&&this.parent.layerTracking.features[0].geometry.length>=1};TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){TC.wrap.control.ResultsPanel.prototype.showElevationMarker.call(this,{data:e,layer:this.parent.layerTrack,coords:this.parent.chart.coordinates})};TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){TC.wrap.control.ResultsPanel.prototype.hideElevationMarker.call(this)};TC.wrap.control.Geolocation.prototype.addWaypoint=function(t,r){var a=new e.Feature({geometry:new e.geom.Point([t[0],t[1],r.ele,r.time],"XYZM")});a.setProperties(r);this.parent.layerTracking.wrap.layer.getSource().addFeature(a)};TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,a,n,o,i){var s=Math.round(e[0]),l=Math.round(e[1]),p=k.call(this);if(this.parent.layerTracking.features&&p){var c=p.geometry.length>0&&p.geometry[p.geometry.length-1];if(c&&0==c.length){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}else{var u=Math.round(c[0]),f=Math.round(c[1]);if(s!=u||l!=f){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}}TC.Util.storage.setSessionLocalValue(this.parent.Const.LocalStorageKey.TRACKINGTEMP,this.formattedToStorage(this.parent.layerTracking).features)}this.parent.$events.trigger($.Event(this.parent.Const.Event.STATEUPDATED,{moving:void 0!=t&&void 0!=a&&a>0&&t>0}))};TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){var t,r,a,n,o,i=this,s=$.Deferred();k.call(this)||i.parent.setTracking(!1);if(e&&e.coords){i.parent.layerGPS.clearFeatures();t=e.coords.accuracy/i.parent.map.getMetersPerUnit()||0;r=e.coords.heading||e[2]||0;a=e.coords.speed?3.6*e.coords.speed:0;n=e.coords.altitude||0;o=e.coords.altitudeAccuracy||0;if(i.parent.layerTracking){var l=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],p=TC.Util.reproject(l,"EPSG:4326",i.parent.map.crs);i.addPosition(p,r,(new Date).getTime(),a,t,o,n);var c=k.call(this).geometry,u=c.length;u>=2&&(i.parent.deltaMean=(c[u-1][3]-c[0][3])/(u-1));i.parent.$events.trigger($.Event(i.parent.Const.Event.POSITIONCHANGE,{pd:{position:p,altitude:n,accuracy:t,heading:TC.Util.radToDeg(r),speed:a}}));$.when(i.parent.layerGPS.addPoint(p,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),i.parent.layerGPS.addCircle([p,t],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})).done(function(e,t){i.parent.geopositionTracking=!0;if(0==i.parent.firstPosition){i.parent.firstPosition=!0;if(i.parent.$centerDiv)i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1);else{i.parent.$centerDiv=i.parent._$div.find("."+i.parent.CLASS+"-track-center");i.parent.$button=i.parent._$div.find("."+i.parent.CLASS+"-track-center button");i.parent.$button.on("click",function(){i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features);i.parent.track.$info.find(".prsidebar-body").fadeIn("slide");i.parent.track.$info.find(".prcollapsed").hide()});i.parent.$centerDiv.appendTo(i.parent.map._$div);i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1)}i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features)}s.resolve({marker:e,accuracy:t})})}else s.resolve(null)}else s.resolve(null);return s.promise()};TC.wrap.control.Geolocation.prototype.setTracking=function(t){var r=this;if(t){r.parent.firstPosition=!1;var a,n=[];if(r.parent.sessionTracking){var o=(new TC.wrap.parser.JSON).parser.readFeatures(r.parent.sessionTracking);o&&r.parent.storageCRS!==r.parent.map.crs&&(o=o.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t}));var i=o.filter(function(e){var t=e.getGeometry().getType().toLowerCase();"point"===t&&n.push(e);return"linestring"===t||"multilinestring"===t})[0].getGeometry().getCoordinates();a=new e.Feature({geometry:new e.geom.LineString(i,"XYZM"),tracking:!0})}else a=new e.Feature({geometry:new e.geom.LineString([],"XYZM"),tracking:!0});a&&TC.wrap.Feature.createFeature(a).then(function(e){r.parent.layerTracking.addFeature(e);e.geometry.length>1&&r.parent.map.setExtent(r.parent.layerTracking.wrap.layer.getSource().getExtent());n.length>0&&$.when.apply($,n.map(function(e){return TC.wrap.Feature.createFeature(e)})).then(function(e){(e=Array.prototype.slice.call(arguments,0))&&e.forEach(function(e){r.parent.layerTracking.addFeature(e)})});r.parent.currentPositionWaiting=r.parent.getLoadingIndicator().addWait();r.currentPositionTrk||(r.currentPositionTrk=[]);var t,a=0,o=0,i=!1,s={enableHighAccuracy:!0,timeout:6e5};t=setInterval(function e(n){var l=a++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.positionChangehandler(e).then(function(e){1==r.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&r.currentPositionTrk.push(navigator.geolocation.watchPosition(r.positionChangehandler.bind(r),r.parent.onGeolocateError.bind(r.parent),s))})},n||function(a){switch(a.code){case a.TIMEOUT:if(o>10){clearInterval(t);r.parent.onGeolocateError.call(r.parent,a)}else{o++;e(function(){clearInterval(t);if(!i){i=!0;r.parent.onGeolocateError.call(r.parent,a)}})}break;default:clearInterval(t);r.parent.onGeolocateError.call(r.parent,a)}},{timeout:5e3+l,maximumAge:10,enableHighAccuracy:!0})},1e3);setTimeout(function(){if(r.parent.layerTracking&&r.parent.layerTracking.features&&r.parent.layerTracking.features.length>0&&0==r.parent.layerTracking.features[0].geometry.length){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.map.toast(r.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING});r.parent.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);r.parent.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)}},s.timeout+1e3)})}else{r.parent.firstPosition=!1;if(r.currentPositionTrk){r.currentPositionTrk=r.currentPositionTrk instanceof Array?r.currentPositionTrk:[r.currentPositionTrk];r.currentPositionTrk.forEach(function(e){navigator.geolocation.clearWatch(e)});r.currentPositionTrk=[]}r.parent.$centerDiv&&r.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!0)}};TC.wrap.control.Geolocation.prototype.activateSnapping=function(){if(!TC.Util.detectMobile()){this.olMap.on([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],this._snapTrigger);this.olMap.on(e.render.EventType.POSTCOMPOSE,this._postcomposeTrigger)}};TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){if(!TC.Util.detectMobile()){r.un([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],t._snapTrigger);r.un(e.render.EventType.POSTCOMPOSE,t._postcomposeTrigger)}t.snapInfo&&r.removeOverlay(t.snapInfo);t.snapInfoElement&&(t.snapInfoElement.style.display="none");if(t.snapLine){delete t.snapLine;r.render()}})};TC.wrap.control.Geolocation.prototype.clear=function(e){e&&e.clearFeatures();attachedDTD=!1;this.deactivateSnapping.call(this)};TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(t){var r=t.vectorContext;if(r&&this.snapLine){"function"==typeof r.setFillStrokeStyle&&r.setFillStrokeStyle(null,new e.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1}));"function"==typeof r.drawGeometry&&r.drawGeometry(this.snapLine.wrap.feature.getGeometry())}};TC.wrap.control.Geolocation.prototype.endSnap=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){e.snapInfo&&t.removeOverlay(e.snapInfo);e.snapInfoElement&&(e.snapInfoElement.style.display="none");e.snapLine&&delete e.snapLine})};TC.wrap.control.Geolocation.prototype.initSnap=function(t,r){var a=this;if(a.parent.layerTrack){var n=a.parent.layerTrack.wrap.layer.getSource().getClosestFeatureToCoordinate(t);if(null!==n){var o=n.getGeometry().getClosestPoint(t);const u=a.parent.map.getPixelFromCoordinate(o);if(Math.sqrt(Math.pow(r[0]-u[0],2)+Math.pow(r[1]-u[1],2))>a.parent.snappingTolerance)a.endSnap();else{var i=[t,[o[0],o[1]]];a.snapLine?a.snapLine.wrap.feature.getGeometry().setCoordinates(i):a.snapLine=new TC.feature.Polyline(i);a.snapInfoElement||(a.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]);a.snapInfoElement.style.display="block";if(!a.snapInfo){a.snapInfo=new e.Overlay({element:a.snapInfoElement,offset:[5,18]});a.olMap.addOverlay(a.snapInfo)}void 0==a.snapInfo.getMap()&&a.snapInfo.setMap(a.olMap);a.snapInfo.setPosition(t);var s={};"LineString"!=n.getGeometry().getType()&&n.getKeys().indexOf("name")>-1&&(s.n=n.get("name"));var l=a.parent.map.options.locale&&a.parent.map.options.locale.replace("_","-")||void 0;s.x=a.map.wrap.isGeo()?o[0].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[0]).toLocaleString(l);s.y=a.map.wrap.isGeo()?o[1].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[1]).toLocaleString(l);a.map.wrap.isGeo()&&(s.isGeo=!0);var p=function(e){return o[e]?(Math.round(100*o[e])/100).toLocaleString(l):void 0},c=function(e){return o[e]>0?new Date(o[e]).toLocaleString(l):void 0};if(n.getGeometry().getLayout()===e.geom.GeometryLayout.XYZM){s.z=p(2);s.m=c(3)}else n.getGeometry().getLayout()===e.geom.GeometryLayout.XYZ?s.z=p(2):n.getGeometry().getLayout()===e.geom.GeometryLayout.XYM&&(s.m=c(2));s&&a.parent.getRenderedHtml(a.parent.CLASS+"-track-snapping-node",s,function(e){a.snapInfoElement.innerHTML=e})}}}a.olMap.render()};TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){var t=this,r=$.Deferred(),a=[],n=(new TC.wrap.parser.JSON).parser.readFeatures(e.data);n.filter(function(e){return"linestring"===e.getGeometry().getType().toLowerCase()||"multilinestring"===e.getGeometry().getType().toLowerCase()}).forEach(function(t){t.getGeometry().setCoordinates(t.getGeometry().getCoordinates(),e.layout)});t.activateSnapping.call(t);for(var o=0,i=n.length;o<i;o++)a.push(TC.wrap.Feature.createFeature(n[o]));$.when.apply($,a).then(function(){for(var e=0;e<arguments.length;e++){var a=arguments[e];a&&t.parent.layerTrack.addFeature(a)}t.parent.map.zoomToFeatures(t.parent.layerTrack.features);r.resolve()});return r.promise()};TC.wrap.control.Geolocation.prototype.formattedFromStorage=function(t){const r=this;if(r.parent.storageCRS!==r.parent.map.crs){var a=(new e.format.GeoJSON).readFeatures(t);if(a){a=a.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t});return(new e.format.GeoJSON).writeFeatures(a)}}return t};TC.wrap.control.Geolocation.prototype.formattedToStorage=function(t,r){var a=this,n=new TC.wrap.parser.JSON;n=n.parser;var o,i=t.wrap.layer.getSource().getFeatures();i=i.map(function(t){t.getGeometry()instanceof e.geom.LineString&&(o=t.getGeometry().getLayout());if(a.parent.map.crs!==a.parent.storageCRS){var r=t.clone();r.getGeometry().transform(a.parent.map.crs,a.parent.storageCRS);return r}return t});return{features:n.writeFeatures(i),layout:o}};TC.wrap.control.Geolocation.prototype.export=function(t,r){var a=this,n=new $.Deferred,o=[];a.parent.getTrackingData(r).then(function(i){if(i){var s=(new e.format.GeoJSON).readFeatures(i.data);if(0===s.length){var l=a.parent.getTrackingData(r);s=(new e.format.GeoJSON).readFeatures(l)}o=s.map(function(t){var r=t.clone();r.getGeometry().transform(a.parent.map.crs,"EPSG:4326");return r.getGeometry()instanceof e.geom.LineString?new e.Feature({geometry:new e.geom.MultiLineString([r.getGeometry().getCoordinates()],"XYZM")}):r})}switch(t){case"GPX":n.resolve(o?(new e.format.GPX).writeFeatures(o):null);break;case"KML":n.resolve(o?(new e.format.KML).writeFeatures(o):null)}});return n};var D,U,j=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var a=0;a<e.length;a++){for(var n=e[a],o=-1,i=1/0,s=n.getLastCoordinate(),l=a+1;l<e.length;l++){var p=e[l].getFirstCoordinate(),c=Math.hypot(s[0]-p[0],s[1]-p[1]);if(c<i){o=l;i=c}}if(t.length<e.length){if(-1==t.indexOf(a)){t.push(a);r=r.concat(n.getCoordinates())}if(-1==t.indexOf(o)){t.push(o);r=r.concat(e[o].getCoordinates())}}}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(t){for(var r=this,a=r.parent.layerTrack.wrap.layer.getSource(),n=r.parent.importedFileName,o=[],i=[],s=[],l=[],p=a.getFeatures(),c=[],u=[],f=function(e){e.getProperties().hasOwnProperty("name")&&e.getProperties().name.trim().length>0?o.push(e.getProperties().name):o.push(n)},g=0;g<p.length;g++){var m=p[g];m instanceof TC.Feature&&(m=p[g].wrap.feature);if(m.getGeometry()instanceof e.geom.Point){u.push(m.getGeometry().getCoordinates());l.push(m)}else if(m.getGeometry()instanceof e.geom.LineString){f(m);i.push(new e.Feature({geometry:new e.geom.LineString(m.getGeometry().getCoordinates(),m.getGeometry().getLayout())}));s.push(m)}else if(m.getGeometry()instanceof e.geom.MultiLineString){var y=m.clone();f(y);var d=y.getGeometry().getLineStrings(),h=j(d);i.push(new e.Feature({geometry:new e.geom.LineString(h,m.getGeometry().getLayout())}));s.push(m)}}if(c.length>0){h=j(c);i.push(new e.Feature({geometry:new e.geom.LineString(h)}))}u.length>0&&l.length==p.length&&i.push(new e.Feature({geometry:new e.geom.LineString(u)}));if(s.length>0)for(var v=0;v<s.length;v++)a.removeFeature(s[v]);if(i.length>0){new $.Deferred;var C,T=0;(function(){var e=[];$.each(i,function(t){var s=new $.Deferred;C&&a.removeFeature(C);if(o.length>t){var l=o[t];(function(e,t){for(var r=[],a=e.indexOf(t);-1!=a;){r.push(a);a=e.indexOf(t,a+1);if(r.length>1)return!0}return r.length>1})(o,l)&&(l="["+(t+1)+"] "+l)}r.parent.importedFileName=l||n;C=i[t];a.addFeature(C);r.parent.saveTrack(r.parent.getLocaleString("geo.trk.upload.ok",{trackName:r.parent.importedFileName})).then(function(e){0==t&&(T=e);s.resolve()});e.push(s)});return $.when.apply(void 0,e).promise()})().then(function(){r.parent.layerTrack.setVisibility(!1);r.parent.layerTrack.clearFeatures();r.parent.$events.trigger(r.parent.Const.Event.IMPORTEDTRACK,T);delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t)})}else{if(r.parent.layerTrack){r.parent.map.removeLayer(r.parent.layerTrack);r.parent.layerTrack=void 0}delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t);TC.alert(r.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.import=function(t,r,a){var n,o,i=this;if(r&&r.text){var s=i.parent.layerTrack.wrap.createVectorSource({data:r.text,type:a});n=s.source;o=n.on("change",function(r){if("ready"==n.getState()){e.Observable.unByKey(o);i.processImportedFeatures(t)}});i.parent.layerTrack.wrap.layer.setSource(n)}else{if(i.parent.layerTrack){i.parent.map.removeLayer(i.parent.layerTrack);i.parent.layerTrack=void 0}delete i.parent.importedFileName;i.parent.getLoadingIndicator().removeWait(t);TC.alert(i.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){this.parent.chartProgressClear();if(this.simulateMarker){window.cancelAnimationFrame(D);this.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&this.simulateMarker.layer.removeFeature(this.simulateMarker);delete this.simulateMarker}};TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var t,r=this,a=r.parent.layerTrack.wrap.layer.getSource().getFeatures(),n=0;n<a.length;n++)if(a[n].getGeometry()instanceof e.geom.LineString){t=a[n].getGeometry().getCoordinates();break}if(t&&t.length>0){var o=t[0];(function(){var e=new $.Deferred;if(r.simulateMarker){r.simulateMarker.setCoords(o.slice(0,2));e.resolve(r.simulateMarker)}else r.parent.layerTrack.addPoint(o.slice(0,2),{radius:7,fillColor:"#ff0000",fillOpacity:.5,strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e.resolve(t)});return e})().then(function(a){r.simulateMarker=a;var n=function(){t.length;var a,n=!1;const o=function(e){return r.parent.map.crs!==r.parent.map.options.utmCrs?TC.Util.reproject(e,r.parent.map.crs,r.parent.map.options.utmCrs):e};r.parent.hasElevation&&r.parent.chartProgressInit();var i=t;if(4==i[0].length&&i[0][3]>0){a=i[0][3];i[i.length-1][3];n=!0}else{i[0][3]=Date.now();for(var s=1;s<i.length;s++){i[s][3]=0;u=s+1<i.length?new e.geom.LineString(o(i.slice(s-1,s+1))).getLength():new e.geom.LineString(o(i.slice(s-1))).getLength();i[s][3]=i[s-1][3]+36e5*u/r.parent.walkingSpeed}a=i[0][3];i[i.length-1][3]}var l=new e.geom.LineString(i),p=a,c=0;c=r.parent.map.crs!==r.parent.map.options.utmCrs?new e.geom.LineString(o(JSON.parse(JSON.stringify(i)))).getLength():l.getLength();var u=0,f=function(){if(!r.parent.simulate_paused){var t=l.getCoordinateAtM(p),a=function(t){for(var r=0;r<i.length;r++)if(i[r][3]>t)return{d:new e.geom.LineString(o(i.slice(0,r))).getLength(),p:i[r-1].slice(0,2)}}(p);if(!t||!a){r.simulateTrackEnd();var s=r.parent.getSelectedTrack();s&&r.parent.uiSimulate(!1,s);r.parent.chartProgressClear();return}r.parent.hasElevation&&r.parent.chartSetProgress(a,t,c,!!n&&r.parent._getTime(i[0][3],t[3]));if(r.simulateMarker){var u=r.simulateMarker.getCoords(),g=t;Math.atan2(g[1]-u[1],g[0]-u[0]),Math.PI;r.simulateMarker.setCoords(t)}1!==r.parent.simulate_speed?p+=r.parent.delta*r.parent.simulate_speed:p+=r.parent.delta}D=requestAnimationFrame(f)};D=requestAnimationFrame(f)},o=new $.Deferred;window.d3?o.resolve():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){o.resolve()});o.then(function(){D=requestAnimationFrame(n)})})}};TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;t.parent.track.$infoOnMap||(t.parent.track.$infoOnMap=$('<div style="overflow-y: scroll; height: 200px; width: 200px; top: 0; left: 100px; background-color: fuchsia; position: absolute;"></div>').appendTo(t.parent.map._$div));t.parent.track.$infoOnMap.show();t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> salta headingChangehandler </p>");t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> evt.target.getHeading(): "+e.target.getHeading()+" </p>");t.heading=e.target.getHeading();$.when(t.map.wrap.getMap()).then(function(e){e.getView().setRotation(-t.heading)});t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))};TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this.map.wrap.map.getView(),r=t.getCenter(),a=t.getResolution(),n=e.target.getBeta()||0,o=e.target.getGamma()||0;r[0]-=a*o*25;r[1]+=a*n*25;t.setCenter(t.constrainCenter(r));this.parent.$events.trigger($.Event(this.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))};TC.wrap.control.Geolocation.prototype.pulsate=function(t){this.pulsated=!0;var r,a=t.wrap.feature.getGeometry().getRadius(),n=(new Date).getTime();r=this.olMap.on(e.render.EventType.POSTCOMPOSE,function(o){var i=o.vectorContext,s=o.frameState,l=s.time-n,p=t.wrap.feature.getGeometry().clone(),c=function(e){switch(!0){case e<=50:return a;case e>50&&e<=100:return 1.02*a;case e>100&&e<=150:return 1.05*a;case e>150&&e<=200:return 1.02*a;case e>200&&e<=300:return a;case e>300&&e<=350:return 1.02*a;case e>350&&e<=400:return 1.05*a;case e>400&&e<=450:return 1.02*a;case e>450&&e<=500:return 1*a;default:return a}}(l);p.setRadius(c);i.setFillStrokeStyle(new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new e.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1}));i.drawCircleGeometry(p);l>500?e.Observable.unByKey(r):s.animate=!0})};TC.wrap.control.ResultsPanel.prototype.register=function(e){const t=this;t.map=e;$.when(e.wrap.getMap()).then(function(e){t.olMap=e})};TC.wrap.control.ResultsPanel.prototype.showElevationMarker=function(t){const r=this,a=(t=t||{}).data,n=t.layer,o=t.coords;r.elevationMarker||(r.elevationMarker=new e.Overlay({element:$("<div>").addClass("tc-ctl-geolocation-trackMarker elevation").css("display","none")[0],offset:[0,-11],positioning:e.OverlayPositioning.CENTER_CENTER,stopEvent:!1}));if(n.getVisibility()&&n.getOpacity()>0){$(r.elevationMarker.getElement()).show();r.olMap.addOverlay(r.elevationMarker);r.elevationMarker.setPosition(o[a[0].index])}};TC.wrap.control.ResultsPanel.prototype.hideElevationMarker=function(){this.elevationMarker&&$(this.elevationMarker.getElement()).hide()};TC.wrap.control.Coordinates.prototype.coordsActivate=function(){this.olMap.on(e.MapBrowserEventType.SINGLECLICK,this._coordsTrigger)};TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){this.olMap.un(e.MapBrowserEventType.SINGLECLICK,this._coordsTrigger)};TC.wrap.Parser=function(){};TC.wrap.Parser.prototype.read=function(e){var t=[];if(this.parser){TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");t=$.map(this.parser.readFeatures(e),function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})}return t};TC.wrap.parser={WFS:function(t){this.parser=new e.format.WFS(t)},JSON:function(t){this.parser=new e.format.GeoJSON(t)}};TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser);TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser);TC.wrap.control.OverviewMap.prototype.register=function(t){var r=this;$.when(r.parent.layer.wrap.getLayer()).then(function(a){r.ovMap=new e.control.OverviewMap({target:r.parent.div,collapsed:!1,collapsible:!1,className:r.parent.CLASS+" ol-overviewmap",layers:[a]});r.ovMap._wrap=r;r.ovMap.ovmap_.removeOverlay(r.ovMap.boxOverlay_);var n=document.createElement("DIV");n.className="ol-overviewmap-box";n.style.boxSizing="border-box";r.ovMap.boxOverlay_=new e.Overlay({position:[0,0],positioning:e.OverlayPositioning.BOTTOM_LEFT,element:n});r.ovMap.ovmap_.addOverlay(r.ovMap.boxOverlay_);r._$boxElm=$(r.ovMap.boxOverlay_.getElement()).parents(".ol-overlay-container").first();TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var e,a,n=r.ovMap.ovmap_;r._$boxElm.drag("start",function(r,o){var i=$(this);o.$dragged=i.clone().addClass(TC.Consts.classes.ACTIVE);i.after(o.$dragged);e=parseInt(i.css("bottom"));a=parseInt(i.css("left"));var s=n.getPixelFromCoordinate([t.maxExtent[0],t.maxExtent[1]]),l=n.getPixelFromCoordinate([t.maxExtent[2],t.maxExtent[3]]),p=n.getSize();o.limit={bottom:p[1]-s[1],left:s[0],top:p[1]-l[1]-i.height(),right:l[0]-i.width()}}).drag("end",function(e,a){a.$dragged.remove();var o=r.ovMap.getMap().getView(),i=n.getPixelFromCoordinate(o.getCenter()),s=n.getCoordinateFromPixel([i[0]+a.deltaX,i[1]+a.deltaY]),l=t.getExtent(),p=(l[2]-l[0])/2,c=(l[3]-l[1])/2;s[0]+p>t.maxExtent[2]?s[0]=t.maxExtent[2]-p:s[0]-p<t.maxExtent[0]&&(s[0]=t.maxExtent[0]+p);s[1]+c>t.maxExtent[3]?s[1]=t.maxExtent[3]-c:s[1]-c<t.maxExtent[1]&&(s[1]=t.maxExtent[1]+c);t.setCenter(s,{animate:!0})}).drag(function(t,r){parseInt(r.$dragged.css("bottom")),parseInt(r.$dragged.css("left"));if(r.limit.top){r.$dragged.css("bottom",Math.min(Math.max(e-r.deltaY,r.limit.bottom),r.limit.top)+"px");r.$dragged.css("left",Math.min(Math.max(a+r.deltaX,r.limit.left),r.limit.right)+"px")}else{r.$dragged.css("bottom",e-r.deltaY+"px");r.$dragged.css("left",a+r.deltaX+"px")}})});$.when(t.wrap.getMap()).then(function(e){r.reset();var t=$(r.parent.div).find("."+r.parent.CLASS+"-load");a._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){t.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)});a._wrap.$events.on(TC.Consts.event.TILELOAD,function(){t.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)});e.addControl(r.ovMap);r.parent.isLoaded=!0;r.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD))})})};TC.wrap.control.OverviewMap.prototype.reset=function(t){var r=this;const a=new $.Deferred,n=function(t,n){if(t.type===TC.Consts.layerType.WMTS){var o={crs:n||r.parent.map.crs,oldCrs:t.wrap.layer.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t.setProjection(o)}$.when(t.wrap.getLayer()).then(function(n){var o=new e.View(C(r.parent.map.wrap,n._wrap.parent));if(o.getResolutions()){o.setResolution(o.getResolutions().filter(function(e){return e>o.getResolutionForExtent(r.parent.map.getExtent(),i.getSize())}).reverse()[0]);i.setView(o)}else o.getProjection().getCode()!==i.getView().getProjection().getCode()&&i.setView(o);n._wrap.$events.one(TC.Consts.event.TILELOAD,function(){i.getLayers().getArray()[0].getSource().refresh()});if(t!==r.parent.layer){i.getLayers().forEach(function(t){(t instanceof e.layer.Image||t instanceof e.layer.Tile)&&i.removeLayer(t)});var s=$(r.parent.div).find("."+r.parent.CLASS+"-load");n._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){s.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)});n._wrap.$events.on(TC.Consts.event.TILELOAD,function(){s.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)});i.getLayers().insertAt(0,n)}a.resolve(t)})};var o=(t=t||{}).layer||r.parent.layer;if(r.parent.map&&o&&r.ovMap){var i=r.ovMap.ovmap_;o.getCapabilitiesPromise().then(function(){var e=o;o.isCompatible(r.parent.map.crs)||0!==o.wrap.getCompatibleMatrixSets(r.parent.map.crs).length?n(o):(o=o.getFallbackLayer()||r.parent.defaultLayer).getCapabilitiesPromise().then(function(){r.parent.map.on3DView&&!o.isCompatible(r.parent.map.crs)?r.parent.map.loadProjections({crsList:e.getCompatibleCRS(),orderBy:"name"}).then(function(t){n(e,t[0].code)}):o.isCompatible(r.parent.map.crs)&&n(o)})})}return a};TC.wrap.control.OverviewMap.prototype.get3DCameraLayer=function(){var t=null;this.ovMap&&(r=this.ovMap.getOverviewMap()).getLayers().forEach(function(e){"3DCamera"===e.get("id")&&(t=e)});if(!t){var r=this.ovMap.getOverviewMap(),a=I({});a[0].getFill().setColor([0,0,0,0]);t=new e.layer.Vector({id:"3DCamera",source:new e.source.Vector,style:a});r.addLayer(t)}return t};TC.wrap.control.OverviewMap.prototype.draw3DCamera=function(t){this.is3D=!!t;var r=this.get3DCameraLayer();if(r){var a,n=(t=t||{}).fov,o=r.getSource();if(n&&n.length){var i=o.getFeatures();if(i.length)a=i[0];else{a=new e.Feature;o.addFeature(a)}a.setGeometry(new e.geom.Polygon([n]))}else o.clear();var s="number"==typeof t.heading?t.heading:0;this._$boxElm.css("transform","rotate("+s+"rad)")}};TC.wrap.control.OverviewMap.prototype.enable=function(){if(this.parent.layer&&this.parent.layer.setVisibility){this.parent.layer.setVisibility(!0);this.parent.wrap.ovMap.ovmap_.updateSize();$(this.parent.map.div).trigger("resize")}};TC.wrap.control.OverviewMap.prototype.disable=function(){this.parent.layer&&this.parent.layer.setVisibility&&this.parent.layer.setVisibility(!1)};TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var a=t._trigger;t._trigger=function(r){var n=a.call(t,r);n?t.parent.beforeRequest({xy:r.pixel}):e.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{control:t.parent}));return n}})};var V=function(e){var t=e.innerHTML||e.textContent;(U=U||document.createElement("textarea")).innerHTML=t;return U.value},W={readFeatures:function(t){var r=[],a=(new DOMParser).parseFromString(t,"text/xml");if("FeatureInfoResponse"===a.documentElement.tagName)for(var n=a.documentElement.getElementsByTagName("FeatureInfoCollection"),o=0,i=n.length;o<i;o++)for(var s=n[o],l=s.getAttribute("layername"),p=s.getElementsByTagName("FeatureInfo"),c=0,u=p.length;c<u;c++){for(var f=p[c].getElementsByTagName("Field"),g={},m=0,y=f.length;m<y;m++){var d=f[m];g[V(d.getElementsByTagName("FieldName")[0])]=V(d.getElementsByTagName("FieldValue")[0])}var h=new e.Feature(g);h.setId(l+"."+TC.getUID());r[r.length]=h}return r}},K=function(e,t,r){var a=t.getPath(r);e.layers.push({name:r,title:a[a.length-1],path:a.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(t,r,a){var n=this,o=a||{},i=n.parent.map;$.when(i.wrap.getMap()).then(function(a){var s={},l={},p=[],c=[],u=[];T=(T=a.getLayers().getArray()).filter(function(t){return t instanceof e.layer.Image&&t.getVisible()});for(var f=0;f<T.length;f++){var g=T[f],m=g._wrap.parent;if((S=g.getSource()).getGetFeatureInfoUrl&&$.inArray(m,i.workLayers)>=0&&m.names.length>0&&(!o.serviceUrl||o.serviceUrl===m.url)){var y={};if(s[m.url]&&s[m.url].title===m.title)y=s[m.url];else{y={layers:[],mapLayer:m,title:m.title,request:null};s[m.url]=y;l[m.url]={source:jQuery.extend(!0,{},S),layers:[]}}var d=m.getDisgregatedLayerNames();if(o.layerName){if(d.indexOf(o.layerName)>=0&&g._wrap.getInfo(o.layerName).queryable){K(y,m,o.layerName);l[m.url].layers.push(o.layerName)}}else{for(var h=0;h<d.length;h++){var v=d[h];if(g._wrap.getInfo(v).queryable)K(y,m,v);else{TC.Util.consoleRegister('Capa "'+d[h]+'" no queryable, la eliminamos de la petici\xf3n GFI');d.splice(h,1);h-=1}}d.length>0&&(l[m.url].layers=l[m.url].layers.concat(d))}}}for(var C in s){u.push(s[C]);y=s[C];var T,S=l[C].source;if((T=l[C].layers)&&(!T||0!==T.length)){var w=S.getParams();S.params_.LAYERS=T.join(",");var E=S.getGetFeatureInfoUrl(t,r,i.crs,{QUERY_LAYERS:T.join(","),INFO_FORMAT:w.INFO_FORMAT,FEATURE_COUNT:1e3,radius:i.options.pixelTolerance,buffer:i.options.pixelTolerance}),L=E=E.replace(/sld_body=[a-zA-Z%0-9._]*/);E=y.mapLayer.getFeatureInfoUrl(E);var M=$.ajax({url:E});M.originalUrl=E;M.serviceUrl=C;M.requestedFormat=w.INFO_FORMAT;M.expandUrl=L;TC.Util.consoleRegister("Lanzamos GFI");p.push(M)}}if(p.length>0)$.when.apply(n,p).then(function(){for(var a=p.length>1?arguments:[arguments],l=!1,u=0,f=[],g=0;g<a.length;g++){var m=a[g],y=s[p[g].serviceUrl],d=m[2];if("success"===m[1]){l=!0;y.text=d.responseText;var h,v=d.getResponseHeader("Content-type");v&&v.indexOf(";")>-1&&(v=v.substr(0,v.indexOf(";")).trim());v||(v=d.requestedFormat);if(v===d.requestedFormat){switch(v){case"application/json":h=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":h=d.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:i.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":h=new e.format.GML3Patched({srsName:i.crs});break;case"application/vnd.esri.wms_featureinfo_xml":h=W;break;default:h=null}if(h){var C=h.readFeatures(d.responseText,{featureProjection:e.proj.get(i.crs)});u+=C.length;for(var T=function(e,t,r){var a=!1;if(t===r)a=!0;else{var n=e.getNodePath(t),o=e.getNodePath(r);if(n.length>0&&o.length>=n.length){a=!0;for(var i=0;i<n.length;i++)if(e.wrap.getName(n[i])!==e.wrap.getName(o[i])){a=!1;break}}}return a},S={},w=0;w<C.length;w++){var E=C[w];if(E instanceof e.Feature){for(var L=E.getId()||TC.getUID(),M=!1,R=L.substr(0,L.lastIndexOf(".")),_=0;_<y.layers.length;_++){var P=y.layers[_],x=P.name.substr(P.name.indexOf(":")+1);if(T(y.mapLayer,x,R)){M=!0;if(!o.featureId||E.getId()===o.featureId){c.push(TC.wrap.Feature.createFeature(E));f.push(P.features)}break}}if(!M){var A;if(S[R])A=S[R];else{A={name:R,title:R,path:[R],features:[]};S[R]=A;y.layers.push(A)}if(!o.featureId||E.getId()===o.featureId){c.push(TC.wrap.Feature.createFeature(E));f.push(A.features)}}}}}else{var I={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};y.layers[y.layers.length]=I;I.features[0]={rawUrl:d.originalUrl,expandUrl:d.expandUrl,rawContent:d.responseText,rawFormat:v};u+=1}}else{TC.Util.consoleRegister("Respuesta GFI: lo m\xe1s probable es que el servidor est\xe9 devolviendo una excepci\xf3n");TC.Util.consoleRegister("Lanzamos los eventos que corresponde y mostramos tostada");n.parent.responseError({message:d.responseText,status:d.status});i.toast(n.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}}else n.parent.responseError({message:d.responseText,status:d.status})}if(l){var F=c;if(c.length){var O=$.Deferred();F=F.concat(O);TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){O.resolve()})}$.when.apply(this,F).then(function(){var e;if(arguments.length)for(var a=0;a<arguments.length;a++){var o=arguments[a];if(o){o.attributes=[];for(var i in o.data){var l=o.data[i];"object"!=typeof l&&o.attributes.push({name:i,value:"number"==typeof l?l.toLocaleString(TC.Util.getMapLocale(n.parent.map)):l})}!e&&TC.Geometry.isInside(t,o.geometry)&&(e=o);f[a].push(o)}}var p=[];for(var c in s)s.hasOwnProperty(c)&&p.push(s[c]);n.parent.responseCallback({coords:t,resolution:r,services:p,featureCount:u,defaultFeature:e})})}},function(e,t,r){n.parent.responseCallback({});i.toast(n.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})});else{i.workLayers.filter(function(e){return e instanceof TC.layer.Raster}).length>0&&i.toast(n.parent.getLocaleString("featureInfo.notQueryableLayers"),{type:TC.Consts.msgType.INFO});if(u&&0==u.length)for(var C in s)u.push(s[C]);i.$events.on(TC.Consts.event.BEFOREFEATUREINFO,function(){n.parent.responseCallback({coords:t,resolution:r,services:u,featureCount:0})});n.parent.responseCallback({coords:t,resolution:r,services:u,featureCount:0})}})};TC.wrap.control.GeometryFeatureInfo.prototype.register=function(t){var r=this;$.when(t.wrap.getMap()).then(function(a){TC.wrap.control.Click.prototype.register.call(r,t);var n=r._trigger;r._trigger=function(t){r.hasEligibleLayers().then(function(a){a&&(r.parent._isSearching||t.type!=e.MapBrowserEventType.SINGLECLICK||r.parent._isDrawing||r.parent._isSearching||n.call(r,t))})}})};TC.wrap.control.GeometryFeatureInfo.prototype.hasEligibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;$.when(t.wrap.getMap()).then(function(a){a.getLayers().forEach(function(e){var a=e._wrap.parent;if(e.getSource().getGetFeatureInfoUrl&&$.inArray(a,t.workLayers)>=0){r=!0;return!1}});e.resolve(r)});return e};TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw=function(t){var r=this,a=(t=t||{}).xy,n=t.layer,o=t.callback,i=t.geometryType,s=!1;if(r.drawCtrl){r.drawCtrl.setActive(!0);r.drawCtrl.startDrawing_({coordinate:a})}else $.when(n.wrap.getLayer()).then(function(t){var n;switch(i){case TC.Consts.geom.POLYLINE:n=e.geom.GeometryType.LINE_STRING;break;default:n=e.geom.GeometryType.POLYGON}r.drawCtrl=new e.interaction.Draw({source:t.getSource(),type:n,style:t.getStyle()});var l=function(e){e.parent.showsPopup=!1};t.getSource().on(e.source.VectorEventType.ADDFEATURE,function(e){e.feature._wrap?l(e.feature._wrap):e.feature._wrapDeferred.then(l)});r.drawCtrl.handleEvent=function(t){if(t.type==e.MapBrowserEventType.SINGLECLICK){var r=n===e.geom.GeometryType.POLYGON?this.sketchCoords_[0]:this.sketchCoords_;s&&2==r.length&&null!==this.sketchFeature_?this.addToDrawing_(t):s=!0}return e.interaction.Draw.handleEvent.call(this,t)};r.parent.map.wrap.getMap().addInteraction(r.drawCtrl);r.drawCtrl.on(e.interaction.DrawEventType.DRAWSTART,function(t){r.parent._isDrawing=!0;var a=r.parent.map;$.when(a.wrap.getMap()).then(function(t){t.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})})});r.drawCtrl.startDrawing_({coordinate:a});r.drawCtrl.on(e.interaction.DrawEventType.DRAWEND,function(a){r.parent._isDrawing=!1;var n=r.parent.map;$.when(n.wrap.getMap()).then(function(t){t.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})});o&&TC.wrap.Feature.createFeature(a.feature).then(function(e){o(e)});this.setActive(!1);r.parent.map.wrap.getMap().removeInteraction(r.drawCtrl);r.drawCtrl=null;t.getSource().clear();r.parent._drawToken=!0;setTimeout(function(){r.parent._drawToken=!1},500)})})};TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw=function(e,t,r){if(this.drawCtrl&&this.parent._isDrawing){this.parent._isDrawing=!1;this.drawCtrl.setActive(!1);this.drawCtrl.source_.clear()}};var B=function(e,t,r,a){var n=[],o={},i=function(e){return e.mapLayer.title||e.mapLayer.tree&&e.mapLayer.tree.title||e.mapLayer.capabilities.Service.Title};$.when(e.wrap.getMap()).then(function(s){s.getLayers().forEach(function(s){var l=s._wrap.parent;if(s.getVisible()&&!($.inArray(l,e.workLayers)<0)&&l.type===TC.Consts.layerType.WMS){var p=l.getDisgregatedLayerNames()||l.availableNames;o[l.url.toLowerCase()]||(o[l.url.toLowerCase()]={layers:[],mapLayer:l,layerNames:[]});for(var c=0;c<p.length;c++){var u=p[c];if((l.isVisibleByScale(u)||a)&&l.wrap.getInfo(u).queryable){o[l.url.toLowerCase()].layerNames.push(u);var f=l.getPath(u);o[l.url.toLowerCase()].layers.push({name:u,title:f[f.length-1],path:f.slice(1),features:[]})}}if(0!=o[l.url.toLowerCase()].layerNames.length&&void 0===o[l.url.toLowerCase()].request){o[l.url.toLowerCase()].request=l.getWFSCapabilitiesPromise();o[l.url.toLowerCase()].defer=$.Deferred();n.push(o[l.url.toLowerCase()].defer);$.when(o[l.url.toLowerCase()].request).then(function(e){var n=null,s=[];for(var l in o)o[l].request&&o[l].request.promise()==this&&(n=o[l]);var p=null,c=n.layerNames,u=n.defer;if(c instanceof Array&&c.length)if(void 0!==e.Operations.GetFeature){for(var f=[],g=0;g<c.length;g++){for(var m=c[g].substring(c[g].indexOf(":")+1);"_"===m[m.length-1];)m=m.substring(0,m.lastIndexOf("_"));if(e.FeatureTypes.hasOwnProperty(m))f.indexOf(m)<0&&f.push(m);else{var y=n.mapLayer.getPath(m);s.push({key:TC.Consts.WFSErrors.LayersNotAvailable,params:{serviceTitle:i(n),layerName:y[y.length-1]}})}}if(0!=f.length){e.Operations.GetFeature.CountDefault&&(p=e.Operations.GetFeature.CountDefault.DefaultValue);if("1.0.0"===e.version&&!e.Operations.GetFeature.Operations.hasOwnProperty("Query")||("2.0.0"===e.version||"1.1.0"===e.version)&&e.Operations.QueryExpressions.AllowedValues.Value.indexOf("wfs:Query")<0){s.push({key:TC.Consts.WFSErrors.QueryNotAvailable,params:{serviceTitle:i(n)}});u.resolve({errors:s})}else{l=e.Operations.GetFeature.DCPType?e.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource:e.Operations.GetFeature.DCP.HTTP.Post["xlink:href"];var d=n.mapLayer.getFeatureUrl(l);p?jQuery.ajax({url:d,data:TC.Util.WFSQueryBuilder(f,t,e,r,!0),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){if(arguments[0]instanceof XMLDocument){var o=xml2json(arguments[0]);if(o.Exception){u.resolve({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:o.Exception.exceptionCode,errorThrown:o.Exception.ExceptionText,serviceTitle:n.mapLayer.title}}]});return}}var c=parseInt(o.numberMatched||o.numberOfFeatures,10);isNaN(c)||c>parseInt(p,10)?u.resolve({errors:[{key:TC.Consts.WFSErrors.NumMaxFeatures,params:{limit:p,serviceTitle:i(n)}}]}):0===c?u.resolve({errors:[{key:TC.Consts.WFSErrors.NoFeatures,params:{serviceTitle:i(n)}}]}):a&&u.resolve({url:l,data:TC.Util.WFSQueryBuilder(f,t,e,r,!1),service:n,numFeatures:c,errors:s})},function(e,t,r){u.resolve({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:t,errorThrown:r,serviceTitle:i(n)}}]})}):a||u.resolve({url:d,data:TC.Util.WFSQueryBuilder(f,t,e,r,!1),service:n,errors:s});a&&!p&&u.resolve({url:l,data:TC.Util.WFSQueryBuilder(f,t,e,r,!1),service:n,errors:s});a||jQuery.ajax({url:d,data:TC.Util.WFSQueryBuilder(f,t,e,r,!1),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){if("success"==arguments[1]){if(arguments[0]instanceof XMLDocument){var e=xml2json(arguments[0]);if(e.Exception){u.resolve({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:e.Exception.exceptionCode,errorThrown:e.Exception.ExceptionText,serviceTitle:n.mapLayer.title}}]});return}}u.resolve({service:n,response:arguments,errors:s})}else u.reject(arguments)},function(e,t,r){u.resolve({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:t,errorThrown:r,serviceTitle:i(n)}}]})})}}else{s.push({key:TC.Consts.WFSErrors.NoValidLayers,params:{serviceTitle:i(n)}});u.resolve({errors:s})}}else{s.push({key:TC.Consts.WFSErrors.GetFeatureNotAvailable,params:{serviceTitle:i(n)}});u.resolve({errors:s})}},function(e,t,r){var a=null;for(var n in o)o[n].request&&o[n].request.promise()==this&&(a=o[n]);a.defer.resolve({errors:[{key:TC.Consts.WFSErrors.GetCapabilities,params:{err:r,serviceTitle:i(a)}}]})})}}})});return n};TC.WFSGetFeatureBuilder=B;var X=function(t,r,a){var n,o=a.getResponseHeader("Content-type");o&&o.indexOf(";")>-1&&(o=o.substr(0,o.indexOf(";")).trim());o||(o=r.requestedFormat);switch(o){case"application/json":n=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":n=r.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:t.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":n=new e.format.GML3Patched({srsName:t.crs});break;case"text/xml":case"application/xml":(a=xml2json(r)).ServiceException&&TC.error(a.ServiceException);n=null;break;default:n=null}return n?n.readFeatures(a.responseText,{featureProjection:e.proj.get(t.crs)}):null},Y=function(t,r){for(var a=[],n=[],o=$.Deferred(),i=function(e,t,r){var a=!1;if(t===r||0===t.indexOf(r))a=!0;else{var n=e.getPath(t),o=e.getPath(r);if(n.length>0&&o.length>=n.length){a=!0;for(var i=0;i<n.length;i++)if(n[i]!==o[i]){a=!1;break}}}return a},s=0;s<t.length;s++){var l=t[s];if(l instanceof e.Feature){for(var p=l.getId()||TC.getUID(),c=!1,u=p.substr(0,p.lastIndexOf(".")),f=0;f<r.layers.length;f++){var g=r.layers[f],m=g.name.substr(g.name.indexOf(":")+1);if(i(r.mapLayer,m,u)){c=!0;a.push(TC.wrap.Feature.createFeature(l));n[l.id_]=g.features;break}}if(!c){var y;if(fakeLayers[u])y=fakeLayers[u];else{y={name:u,title:u,features:[]};fakeLayers[u]=y;r.layers.push(y)}if(!opts.featureId||l.getId()===opts.featureId){a.push(TC.wrap.Feature.createFeature(l));n.push(y.features)}}}}$.when.apply(this,a).done(function(){if(arguments.length)for(var e=0;e<arguments.length;e++){var t=arguments[e];t.attributes=[];t.showsPopup=!1;for(var a in t.data){var i=t.data[a];"object"!=typeof i&&t.attributes.push({name:a,value:i})}n[t.id].push(t)}o.resolve({service:r})});return o};TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry=function(t,r){var a=this,n=a.parent.map;a.parent.filterFeature=t;t.layer=a.parent.filterLayer;$.when(n.wrap.getMap()).then(function(o){var i=t.wrap.feature.getGeometry(),s=i.stride,l=i.getFlatCoordinates();if(!r){for(var p=null,c=1,u=l.length;c<u;c+=s)(!p||p[1]<l[c])&&(p=[l[c-1],l[c]]);r=o.getPixelFromCoordinate(new e.geom.Point(p).getCoordinates())}a.parent.beforeRequest({xy:r});var f=B(n,new TC.filter.intersects(t),"JSON"),g=[];$.when.apply($,f).then(function(){for(var e=[],t=0,o=0;o<arguments.length;o++){g[g.length]=new $.Deferred;if(arguments[o]){if(arguments[o].errors&&arguments[o].errors.length){for(var i=0;i<arguments[o].errors.length;i++){var s,l=TC.Consts.msgType.WARNING;!0;var p=arguments[o].errors[i];switch(p.key){case TC.Consts.WFSErrors.NumMaxFeatures:s=a.parent.getLocaleString("wfs.tooManyFeatures",p.params);break;case TC.Consts.WFSErrors.GetCapabilities:s=a.parent.getLocaleString("wfsGFI.inValidService",p.params);break;case TC.Consts.WFSErrors.NoFeatures:!1;continue;case TC.Consts.WFSErrors.Indeterminate:s=a.parent.getLocaleString("wfs.IndeterminateError");TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:p.params.err,descripcion:p.params.errorThrown,serviceName:p.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);l=TC.Consts.msgType.ERROR;break;default:s=a.parent.getLocaleString("wfsGFI."+p.key,p.params)}n.toast(s,{type:l})}if(!arguments[o].response){g[g.length-1].resolve();continue}}var c=arguments[o].response?X(n,arguments[o].response[0],arguments[o].response[2]):[];g[g.length-1]=Y(c,arguments[o].service);e.push(arguments[o].service);t+=c.length}}$.when.apply($,g).then(function(){a.parent.responseCallback({xy:r||null,services:e,featureCount:t})})},function(e){a.parent.responseCallback({})})})};TC.wrap.control.Popup.prototype=function(){this.popup=null};TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc";TC.Consts.event.PANANIMATIONEND="pananimationend.tc";TC.wrap.control.Popup.prototype.fitToView=function(){var t=this,r=t.parent.map,a=t.parent.map.wrap.map,n=t.parent.$popupDiv[0].getBoundingClientRect(),o=r._$div[0].getBoundingClientRect(),i=a.getCoordinateFromPixel([n.left-o.left,n.top-o.top]),s=a.getCoordinateFromPixel([n.right-o.left,n.bottom-o.top]),l=i[0],p=i[1],c=s[0],u=[l,s[1],c,p],f=r.getExtent();if(!e.extent.containsExtent(f,u)){var g={left:Math.max(f[0]-u[0],0),bottom:Math.max(f[1]-u[1],0),right:Math.max(u[2]-f[2],0),top:Math.max(u[3]-f[3],0)};if(t.parent.dragged){var m=t.popup.getPosition();g.right?m[0]=m[0]-g.right:g.left&&(m[0]=m[0]+g.left);g.top?m[1]=m[1]-g.top:g.bottom&&(m[1]=m[1]+g.bottom);var y=a.getPixelFromCoordinate(m);y[1]=a.getSize()[1]-y[1];t.parent._previousContainerPosition=y;t.popup._oldUpdatePixelPosition(m)}else if(t.parent.isVisible()){var d=a.getView(),h=d.getCenter().slice();g.top?h[1]+=g.top:g.bottom&&(h[1]-=g.bottom);g.right?h[0]+=g.right:g.left&&(h[0]-=g.left);d.animate({center:h,easing:function(e){0===e&&t.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONSTART));1===e&&t.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONEND));return e}})}}};TC.wrap.control.Popup.prototype.setDragged=function(t){var r=this.popup;if(t){if(!r._oldUpdatePixelPosition){r._oldUpdatePixelPosition=r.updatePixelPosition;r.updatePixelPosition=function(){}}if(!r._newHandleOffsetChanged){r._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()};e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r.handleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r._newHandleOffsetChanged,r)}}else{delete this.parent._previousContainerPosition;if(r._oldUpdatePixelPosition){r.updatePixelPosition=r._oldUpdatePixelPosition;delete r._oldUpdatePixelPosition}if(r._newHandleOffsetChanged){e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r._newHandleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r.handleOffsetChanged,r);delete r._newHandleOffsetChanged}}};TC.wrap.Feature.prototype.getLegend=function(){var t={},r=A(this.feature);if(r){var a=r.getImage();if(a){if(a instanceof e.style.Icon){t.src=a.getSrc();var n=a.getScale();if(n){t.scale=n;var o=a.getImage();if(o.width){t.width=o.width*n;t.height=o.height*n}}}else a instanceof e.style.Circle&&(t.src=a.canvas_.toDataURL());if(this.parent.options.radius)t.height=t.width=2*this.parent.options.radius;else{t.width=t.width||this.parent.options.width;t.height=t.height||this.parent.options.height}}else{var i=r.getStroke(),s=r.getFill();if(i){var l=i.getColor();l&&(t.strokeColor=e.color.asString(l));var p=i.getWidth();p&&(t.strokeWidth=p)}if(s){var c=s.getColor();c&&(t.fillColor=e.color.asString(c))}}}return t};var z=function(t,r,a){var n,o={};o[a||"geometry"]=new r(t);n=new e.Feature(o);a&&n.setGeometryName(a);return n};TC.wrap.Feature.prototype.createPoint=function(t,r){if($.isArray(t))this.feature=z(t,e.geom.Point,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;this.feature.setStyle(I({styles:{point:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMarker=function(t,r){var a=TC.Util.getPointIconUrl(r);if(a){r.url=a;if($.isArray(t))this.feature=z(t,e.geom.Point,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;this.feature.setStyle(I({styles:{marker:r}},this.feature));this.setData(this.parent.data)}else this.createPoint(t,r)};TC.wrap.Feature.prototype.createPolyline=function(t,r){if($.isArray(t))this.feature=z(t,e.geom.LineString,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;r&&this.feature.setStyle(I({styles:{line:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createPolygon=function(t,r){if($.isArray(t)){if(t.length){var a=t[0];if($.isArray(a)&&a.length){var n=a[0];$.isArray(n)||(t=[t]);for(var o=0;o<t.length;o++){var i=(a=t[o])[0],s=a[a.length-1];i[0]===s[0]&&i[1]===s[1]||(a[a.length]=i);this.parent.geometry=t;this.feature=z(t,e.geom.MultiLineString,r.geometryName)}this.parent.geometry=t;this.feature=z(t,e.geom.Polygon,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;var l=r||{};(l.strokeColor||l.strokeWidth||l.fillColor||l.fillOpacity)&&this.feature.setStyle(I({styles:{polygon:l}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMultiPolyline=function(t,r){if($.isArray(t)){if(t.length){var a=t[0];if($.isArray(a)&&a.length){var n=a[0];$.isArray(n)||(t=[t]);this.parent.geometry=t;this.feature=z(t,e.geom.MultiLineString,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;r&&this.feature.setStyle(I({styles:{line:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMultiPolygon=function(t,r){if($.isArray(t)){if(t.length){var a=t[0];if($.isArray(a)&&a.length){var n=a[0];if($.isArray(n)&&n.length){var o=n[0];$.isArray(o)||(t=[t])}else t=[[t]];for(var i=0,s=t.length;i<s;i++)for(var l=0,p=(a=t[i]).length;l<p;l++){var c=(n=a[l])[0],u=n[n.length-1];c[0]===u[0]&&c[1]===u[1]||(n[n.length]=c)}this.parent.geometry=t;this.feature=z(t,e.geom.MultiPolygon,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;var f=r||{};(f.strokeColor||f.strokeWidth||f.fillColor||f.fillOpacity)&&this.feature.setStyle(I({styles:{polygon:f}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createCircle=function(t,r){if($.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){var a={};a[r.geometryName||"geometry"]=new e.geom.Circle(t[0],t[1]);this.feature=new e.Feature(a);r.geometryName&&this.feature.setGeometryName(r.geometryName)}else if(this.isNative(t)){this.feature=t;var n=t.getGeometry();this.parent.geometry=[n.getCenter(),n.getRadius()]}this.feature._wrap=this;r&&this.feature.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:r.strokeColor,width:r.strokeWidth,lineDash:r.lineDash}),fill:new e.style.Fill({color:v(r.fillColor,r.fillOpacity)})}));this.setData(this.parent.data)};TC.wrap.Feature.createFeature=function(t,r){var a,n=new $.Deferred,o=t.getGeometry(),i={id:t.getId()};switch(!0){case o instanceof e.geom.Point:var s=t.getStyle();$.isFunction(s)&&(s=s.call(t));for(var l=s?$.isArray(s)?s:[s]:[],p=0,c=l.length;p<c;p++)if((s=l[p]).getImage()instanceof e.style.Icon){a="Marker";break}a=a||"Point";break;case o instanceof e.geom.LineString:a="Polyline";break;case o instanceof e.geom.Polygon:a="Polygon";break;case o instanceof e.geom.MultiLineString:a="MultiPolyline";break;case o instanceof e.geom.MultiPolygon:a="MultiPolygon"}a?TC.loadJS(!TC.feature||TC.feature&&!TC.feature[a],[TC.apiLocation+"TC/feature/"+a],function(){var e=new TC.feature[a](t,i);e.data=e.wrap.getData();n.resolve(e)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature"],function(){var e=new TC.Feature(t,i);e.data=e.wrap.getData();n.resolve(e)});return n};TC.wrap.Feature.prototype.cloneFeature=function(){return this.feature.clone()};TC.wrap.Feature.prototype.getStyle=function(){var t={},r=this.feature.getStyle();$.isFunction(r)&&(r=r.call(this.feature));var a=r?$.isArray(r)?r:[r]:[];const n=function(e,t){if(e){const r=e.getFill();if(r){t.fillColor=r.getColor();$.isArray(t.fillColor)&&(t.fillOpacity=t.fillColor[3])}}},o=function(e,t){if(e){const r=e.getStroke();if(r){t.strokeColor=r.getColor();t.strokeWidth=r.getWidth()}}};for(var i=0,s=a.length;i<s;i++){n(r=a[i],t);o(r,t);const s=r.getImage();if(s instanceof e.style.Icon){t.url=s.getSrc();const e=s.getSize(),r=s.getScale()||1;if(e){t.width=e[0]*r;t.height=e[1]*r}var l=s.getAnchor();if(l){t.anchor=[l[0]*r,l[1]*r];if(e){t.anchor[0]=t.anchor[0]/e[0];t.anchor[1]=t.anchor[1]/e[1]}}}else{n(s,t);o(s,t)}var p=r.getText();if(p){t.label=p.getText();var c=p.getFont();c&&(t.fontSize=parseInt(c.match(/\d+pt/))||.75*parseInt(c.match(/\d+px/)));var u=p.getRotation();u&&(t.angle=-180*u/Math.PI);t.labelOffset=[p.getOffsetX(),p.getOffsetY()];fill=p.getFill();fill&&(t.fontColor=fill.getColor());stroke=p.getStroke();if(stroke){t.labelOutlineColor=stroke.getColor();t.labelOutlineWidth=stroke.getWidth()}}}$.extend(this.parent.options,t);return t};TC.wrap.Feature.prototype.getGeometry=function(){var t;if(this.feature&&this.feature.getGeometry){var r=this.feature.getGeometry();r&&(r.getCoordinates?t=r.getCoordinates():r instanceof e.geom.Circle&&(t=[r.getCenter(),r.getRadius()]))}return t};TC.wrap.Feature.prototype.setGeometry=function(t){var r=!1;if(this.feature&&this.feature.getGeometry){var a,n,o,i,s,l,p,c=this.feature.getGeometry();switch(!0){case c instanceof e.geom.MultiPolygon:s=!0;i=t;$.isArray(i)&&(o=t[0]);case c instanceof e.geom.Polygon||c instanceof e.geom.MultiLineString:l=!0;o=s?o:t;$.isArray(o)&&(n=o[0]);case c instanceof e.geom.LineString:p=!0;n=l?n:t;$.isArray(n)&&(a=n[0]);case c instanceof e.geom.Point:a=p?a:t;if($.isArray(a)&&"number"==typeof a[0]&&"number"==typeof a[1]){var u;switch(a.length){case 3:u=e.geom.GeometryLayout.XYZ;break;case 4:u=e.geom.GeometryLayout.XYZM;break;default:u=e.geom.GeometryLayout.XY}c.setCoordinates(t,u);r=!0}break;case c instanceof e.geom.Circle:if($.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){c.setCenterAndRadius(t[0],t[1]);r=!0}}}return r};TC.wrap.Feature.prototype.getId=function(){var e;this.feature&&(e=this.feature.getId());return e};TC.wrap.Feature.prototype.setId=function(e){this.feature&&this.feature.setId(e)};TC.wrap.Feature.prototype.getLength=function(t){const r=this;t=t||{};const a=r.feature.getGeometry();var n;if(a instanceof e.geom.Polygon){n=a.getLinearRing(0).getCoordinates();t.crs&&(n=TC.Util.reproject(n,r.parent.layer.map.crs,t.crs));const o=new e.geom.Polygon([n]).getLinearRing(0);return e.geom.flat.length.linearRing(o.flatCoordinates,0,o.flatCoordinates.length,o.stride)}if(a instanceof e.geom.LineString){n=a.getCoordinates();t.crs&&(n=TC.Util.reproject(n,r.parent.layer.map.crs,t.crs));return new e.geom.LineString(n).getLength()}};TC.wrap.Feature.prototype.getArea=function(t){const r=this;t=t||{};const a=r.feature.getGeometry();var n;if(a instanceof e.geom.Polygon){n=a.getLinearRing(0).getCoordinates();t.crs&&(n=TC.Util.reproject(n,r.parent.layer.map.crs,t.crs));return new e.geom.Polygon([n]).getArea()}};const q=function(t){var r=this.getStyle();$.isFunction(r)&&(r=r.call(this));$.isArray(r)&&(r=r[r.length-1]);if(!r&&!t){r=new e.style.Style;this.setStyle(r)}return r};TC.wrap.Feature.prototype.setStyle=function(t){const r=this.feature;if(null===t){r.setStyle(null);return}const a=this.parent,n=r.getGeometry();var o,i=q.call(r);a.layer&&(o=function(t){var r=this.getStyle();$.isFunction(r)&&(r=r(t));$.isArray(r)&&(r=r[r.length-1]);r||(r=new e.style.Style);return r}.call(a.layer.wrap.layer,a.wrap.feature));if(n instanceof e.geom.Point||n instanceof e.geom.MultiPoint){var s;if(t.anchor||t.url||t.cssClass){const r={};if((s=i.getImage())instanceof e.style.Icon){r.src=t.url||TC.Util.getBackgroundUrlFromCss(t.cssClass)||s.getSrc();t.width&&t.height?r.size=[x(t.width,a),x(t.height,a)]:r.size=s.getSize();r.anchor=x(t.anchor,a)||s.getAnchor().map(function(e,t){return e/r.size[t]})}else{r.src=TC.Util.getPointIconUrl(t);r.anchor=x(t.anchor,a);r.size=[x(t.width,a),x(t.height,a)]}t.angle&&(r.angle=t.angle);s=new e.style.Icon(r)}else if(!i.getImage()&&i.getText())if(void 0!==t.label){i=q.call(r);t.label.length?i.setText(F(t,a)):i.setText()}else i.setText();else{(s=i.getImage())||(s=new e.style.Circle);const r={radius:x(t.radius,a)||(x(t.height,a)+x(t.width,a))/4};isNaN(r.radius)&&(r.radius=s.getRadius());t.fillColor?r.fill=new e.style.Fill({color:v(x(t.fillColor,a),x(t.fillOpacity,a))}):r.fill=s.getFill();r.stroke=s.getStroke();const n=o&&o.getStroke();if(t.strokeColor||t.strokeWidth){r.stroke||(r.stroke=new e.style.Stroke);if(t.strokeColor)r.stroke.setColor(x(t.strokeColor,a));else{const e=r.stroke.getColor()||n&&n.getColor()||TC.Cfg.styles.point.strokeColor;r.stroke.setColor(x(e,a))}if(t.strokeWidth)r.stroke.setWidth(x(t.strokeWidth,a));else{const e=r.stroke.getWidth()||n&&n.getWidth()||TC.Cfg.styles.point.strokeWidth;r.stroke.setWidth(x(e,a))}}s=new e.style.Circle(r)}i.setImage(s)}else{var l=i.getStroke(),p=!1;l||(l=new e.style.Stroke);if(t.strokeColor){l.setColor(x(t.strokeColor,a));p=!0}if(t.strokeWidth){l.setWidth(x(t.strokeWidth,a));p=!0;i.setStroke(l)}if(t.lineDash){l.setLineDash(t.lineDash);p=!0;i.setStroke(l)}p&&i.setStroke(l);if((n instanceof e.geom.Polygon||n instanceof e.geom.MultiPolygon)&&(t.fillColor||t.fillOpacity)){var c=i.getFill()||new e.style.Fill;c.setColor(v(x(t.fillColor,a),x(t.fillOpacity,a)));i.setFill(c)}}if(void 0!==t.label){i=q.call(r);t.label.length?i.setText(F(t,a)):i.setText()}r.changed()};TC.wrap.Feature.prototype.getInnerPoint=function(t){var r,a=t||{},n=this.feature.getGeometry(),o=function e(t){if(a.clipBox&&$.isArray(t))if($.isArray(t[0]))for(var r=0,n=t.length;r<n;r++)e(t[r]);else!function(e){var t=a.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]);e[1]=Math.min(Math.max(e[1],t[1]),t[3])}(t)};r=n.getFirstCoordinate();switch(n.getType()){case e.geom.GeometryType.MULTI_POLYGON:var i=0;n=n.getPolygons().reduce(function(e,t){const r=t.getArea(),a=r>i?t:e;i=r;return a});case e.geom.GeometryType.POLYGON:var s=function(e,t){for(var r=!1,a=0,n=t.length-1;a<t.length;n=a++){var o=t[a][0],i=t[a][1],s=t[n][0],l=t[n][1];i>e[1]!=l>e[1]&&e[0]<(s-o)*(e[1]-i)/(l-i)+o&&(r=!r)}return r};o(u=n.getCoordinates());r=(n=new e.geom.Polygon(u)).getInteriorPoint().getCoordinates();for(var l=n.getLinearRings(),p=1;p<l.length;p++)if(s(r,l[p].getCoordinates())){r=n.getClosestPoint(r);break}break;case e.geom.GeometryType.MULTI_LINE_STRING:var c=0;n=n.getLineStrings().reduce(function(e,t){const r=t.getLength(),a=r>c?t:e;c=r;return a});case e.geom.GeometryType.LINE_STRING:var u,f=[0,0];o(u=n.getCoordinates());n=new e.geom.LineString(u);for(p=0;p<u.length;p++){f[0]+=u[p][0];f[1]+=u[p][1]}f[0]/=u.length;f[1]/=u.length;r=n.getClosestPoint(f)}return r};TC.wrap.Feature.prototype.showPopup=function(t){var r=t.map;if(r){var a=this.feature;if(a){r.currentFeature=this.parent;var n=r.getExtent();this._innerCentroid=this.getInnerPoint({clipBox:n});t.$contentDiv.html(this.parent.getInfo());t.$menuDiv.empty();if(t.options.closeButton||void 0===t.options.closeButton){$("<div>").addClass(t.CLASS+"-close").attr("title",t.getLocaleString("close")).appendTo(t.$menuDiv).on(TC.Consts.event.CLICK,function(){t.hide()});t.$contentDiv.addClass(t.CLASS+"-has-btn");t.$contentDiv.find(".tc-ctl-finfo").css("width","auto").css("height","auto")}var o,i=this.parent.options;if(i.anchor)o=i.anchor;else{for(var s,l=a._wrap.parent,p=0;p<r.workLayers.length;p++){var c=r.workLayers[p];if(!c.isRaster()&&$.inArray(l,c.features)>=0){s=c.wrap.styleFunction(a);break}}if($.isArray(s)){const t=s[0].getImage();o=!t||t instanceof e.style.Icon?[.5,0]:[.5,.5]}}const f=[0,0];if(o)if(i.height)f[1]=-i.height*o[1];else{var u=q.call(a,!0);if(u){const t=u.getImage();t instanceof e.style.Icon&&(f[1]=t.getImageSize()[1]*-t.getScale())}}t.wrap.popup.setOffset(f);t.wrap.popup.setPosition(this._innerCentroid);t.$popupDiv.addClass(TC.Consts.classes.VISIBLE)}else r.wrap.hidePopup(t)}};TC.wrap.Feature.prototype.isNative=function(t){return t instanceof e.Feature};TC.wrap.Feature.prototype.getPath=function(){var e=[];this.feature&&this.feature._folders&&(e=this.feature._folders);return e};TC.wrap.Feature.prototype.getBounds=function(){var e=null;this.feature&&(e=this.feature.getGeometry().getExtent());return e};TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this.feature.getStyle();"function"==typeof t&&(t=t.call(this.feature));if($.isArray(t))for(var r=0;r<t.length;r++)if(t[r]._balloon){if(t[r]._balloon.getText()){t=t[r]._balloon;break}}t&&!$.isArray(t)&&t.getText&&(e=t.getText());return e};TC.wrap.Feature.prototype.getData=function(){var e=this.feature.getProperties();$.isArray(e.features)&&(e=1===e.features.length?e.features[0].getProperties():e.features.length+" elementos");var t=this.feature.getGeometryName();e[t]&&delete e[t];return e};TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)};TC.wrap.Feature.prototype.clearData=function(){const e=this.feature,t=e.getGeometryName();e.getKeys().forEach(function(r){r!==t&&e.unset(r)})};TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){var t=e.data;t.sketch&&t.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData()))};TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){var t=e.data;if(t.sketch&&t.hoverCoordinate){t.pushCoordinate(t.hoverCoordinate);t.hoverCoordinate=null}};TC.wrap.control.Draw.prototype.clickHandler=function(e){const t=this;if(t._mdPx){const r=t._mdPx[0]-e.clientX,a=t._mdPx[1]-e.clientY;if(r*r+a*a>t.interaction.squaredClickTolerance_)return}if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:r[r.length-1]}))}};TC.wrap.control.Draw.prototype.mousedownHandler=function(e){this._mdPx=[e.clientX,e.clientY]};TC.wrap.control.Draw.prototype.getMeasureData=function(){var t=this,r={units:e.proj.Units.METERS};if(this.sketch){var a=this.sketch.getGeometry();a instanceof e.geom.Polygon?function(r,a){r=new e.geom.Polygon([TC.Util.reproject(r.getLinearRing(0).getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs)]);a.area=r.getArea();var n=r.getLinearRing(0);a.perimeter=e.geom.flat.length.linearRing(n.flatCoordinates,0,n.flatCoordinates.length,n.stride)}(a,r):a instanceof e.geom.LineString&&function(r,a){r=new e.geom.LineString(TC.Util.reproject(r.getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs));a.length=r.getLength()}(a,r)}return r};TC.wrap.control.Draw.prototype.activate=function(t){var r,a=this;switch(t){case TC.Consts.geom.POLYGON:r=e.geom.GeometryType.POLYGON;break;case TC.Consts.geom.POINT:r=e.geom.GeometryType.POINT;break;default:r=e.geom.GeometryType.LINE_STRING}a.parent.map&&$.when(a.parent.map.wrap.getMap(),a.parent.getLayer()).then(function(o,i){$.when(i&&i.wrap.getLayer()).then(function(i){a.$viewport||(a.$viewport=$(o.getViewport()));if(a.interaction){o.removeInteraction(a.interaction);a.$viewport.off("mousedown.tc").off(TC.Consts.event.CLICK);a.parent.measure&&a.$viewport.off(n+".draw",a.mouseMoveHandler).off("mouseover.tc",a.mouseOverHandler)}a.snapInteraction&&o.removeInteraction(a.snapInteraction);if(t){a.$viewport.on("mousedown.tc",$.proxy(a.mousedownHandler,a)).on(TC.Consts.event.CLICK,a,$.proxy(a.clickHandler,a));a.parent.measure&&a.$viewport.on(n+".draw",a,a.mouseMoveHandler).on("mouseover.tc",a,a.mouseOverHandler);var s={type:r,snapTolerance:0,condition:function(){e.events.condition.shiftKeyOnly(arguments[0])&&(hole=o.forEachFeatureAtPixel(o.getPixelFromCoordinate(arguments[0].coordinate),function(t){return e.geom.GeometryType.POLYGON==t.getGeometry().getType()||e.geom.GeometryType.MULTI_POLYGON==t.getGeometry().getType()?t:null},{hitTolerance:p}));return!0}};i&&(s.source=i.getSource());switch(t){case TC.Consts.geom.RECTANGLE:s.style=I({styles:{line:a.parent.styles.line}});s.type=e.geom.GeometryType.LINE_STRING;s.maxPoints=2;s.geometryFunction=function(t,r){r||(r=new e.geom.Polygon(null));var a=t[0],n=t[1];r.setCoordinates([[a,[a[0],n[1]],n,[n[0],a[1]],a]]);return r};break;case TC.Consts.geom.POLYGON:s.style=I({styles:{polygon:a.parent.styles.polygon}});break;case TC.Consts.geom.POINT:s.style=I({styles:{point:a.parent.styles.point}});break;default:s.style=I({styles:{line:a.parent.styles.line}})}a.interaction=new e.interaction.Draw(s);a.interaction.on(e.interaction.DrawEventType.DRAWSTART,function(e){a.sketch=e.feature;a.parent.$events.trigger($.Event(TC.Consts.event.DRAWSTART))},this);a.interaction.on(e.interaction.DrawEventType.DRAWEND,function(e){e.feature.setStyle(e.target.overlay_.getStyle().map(function(e){return e.clone()}));a.parent.measure&&a.parent.$events.trigger($.Event(TC.Consts.event.MEASURE,a.getMeasureData()));b(a.sketch).then(function(e){a.parent.$events.trigger($.Event(TC.Consts.event.DRAWEND,{feature:e}));a.sketch=null})},this);a._projectionChangeHandler=function(t){!function(t,r){if(t.sketch){const n=r.oldValue.getProjection(),o=r.target.get(r.key).getProjection();if(n.getCode()!==o.getCode()){const r=t.sketch.getGeometry();r.transform(n,o);t.interaction.sketchPoint_.getGeometry().transform(n,o);const i=[];var a;a=t.interaction.mode_===e.interaction.Draw.Mode_.POLYGON?t.interaction.sketchCoords_[0]:t.interaction.sketchCoords_;e.geom.flat.deflate.coordinates(i,0,a,r.stride);e.proj.getTransform(n,o)(i,i,r.stride);a=e.geom.flat.inflate.coordinates(i,0,i.length,r.stride);t.interaction.mode_===e.interaction.Draw.Mode_.POLYGON?t.interaction.sketchCoords_=[a]:t.interaction.sketchCoords_=a}}}(a,t)};o.on("change:view",a._projectionChangeHandler);o.addInteraction(a.interaction);if(a.parent.snapping){var l={};i?l.source=i.getSource():a.parent.snapping instanceof TC.Layer&&(l.source=a.parent.snapping.wrap.layer.getSource());a.snapInteraction=new e.interaction.Snap(l);o.addInteraction(a.snapInteraction)}}a.redoStack=[]})})};TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&$.when(e.parent.map.wrap.getMap(),e.parent.getLayer()).then(function(t,r){e.$viewport&&e.$viewport.off("mousedown.tc").off(TC.Consts.event.CLICK);r&&!e.parent.persistent&&r.clearFeatures();if(e.interaction){t.removeInteraction(e.interaction);e.interaction=null}t.un("change:view",e._projectionChangeHandler)})};TC.wrap.control.Draw.prototype.popCoordinate=function(){var t=null;if(this.interaction){var r=this.interaction.sketchFeature_;if(r){var a,n=r.getGeometry();n instanceof e.geom.Polygon?a=n.getCoordinates()[0]:n instanceof e.geom.LineString&&(a=n.getCoordinates());if(a.length>1){var o;n instanceof e.geom.Polygon?o=this.interaction.sketchCoords_[0]:n instanceof e.geom.LineString&&(o=this.interaction.sketchCoords_);var i,s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<a.length;p++)if(a[p][0]==l[0]&&a[p][1]==l[1]){s=!0;break}t=o[i=s?o.length-2:o.length-1];o.splice(i,1);if(n instanceof e.geom.Polygon){n.setCoordinates([o]);this.interaction.sketchLine_.getGeometry().setCoordinates(o)}else n.setCoordinates(o);r.setGeometry(n)}}}return t};TC.wrap.control.Draw.prototype.pushCoordinate=function(t){var r=!1;if(this.interaction){var a=this.interaction.sketchFeature_;if(a){var n,o=a.getGeometry();o instanceof e.geom.Polygon?n=o.getCoordinates()[0]:o instanceof e.geom.LineString&&(n=o.getCoordinates());var i;o instanceof e.geom.Polygon?i=this.interaction.sketchCoords_[0]:o instanceof e.geom.LineString&&(i=this.interaction.sketchCoords_);var s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<n.length;p++)if(n[p][0]==l[0]&&n[p][1]==l[1]){s=!0;break}index=s?i.length-1:i.length;i.splice(index,0,t);if(o instanceof e.geom.LineString)o.setCoordinates(i,e.geom.GeometryLayout.XY);else{o.setCoordinates([i],e.geom.GeometryLayout.XY);this.interaction.sketchLine_.getGeometry().setCoordinates(i)}r=!0}}return r};TC.wrap.control.Draw.prototype.undo=function(){var e=!1,t=this.popCoordinate();if(t){this.redoStack.push(t);e=!0}this.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData()));return e};TC.wrap.control.Draw.prototype.redo=function(){var e=!1;if(this.redoStack.length>0){this.pushCoordinate(this.redoStack.pop());e=!0}this.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData()));return e};TC.wrap.control.Draw.prototype.end=function(){this.interaction&&this.interaction.sketchFeature_&&this.interaction.finishDrawing()};TC.wrap.control.Draw.prototype.setStyle=function(e){const t=this;t.interaction&&t.interaction.overlay_.setStyle(I({styles:e}))};TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,a=new Array(r.length),n=0,o=a.length;n<o;n++){var i=r[n],s={layerId:i.id},l=i.wrap.layer.getSource();l.getUrls&&(s.url=l.getUrls()[0]);if(l.getTileGrid){for(var p=l.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),f=i.getLayerNodeByName(i.layerNames),g=null,m=0,y=f.TileMatrixSetLink.length;m<y;m++){var d=f.TileMatrixSetLink[m];if(d.TileMatrixSet===i.matrixSet){g=d.TileMatrixSetLimits;break}}s.tileMatrixLimits=[];m=0;for(var h=c.length;m<h;m++){var v=p.getOrigin(m),C=p.getTileSize(m),T=c[m],S=C*T,w={mId:u[m],res:T,origin:v,tSize:C,cl:Math.floor((t[0]-v[0])/S),cr:Math.floor((t[2]-v[0])/S),rt:Math.floor((v[1]-t[3])/S),rb:Math.floor((v[1]-t[1])/S)};if(g){var E=g[m];if(E){w.cl=Math.max(w.cl,E.MinTileCol);w.cr=Math.min(w.cr,E.MaxTileCol);w.rt=Math.max(w.rt,E.MinTileRow);w.rb=Math.min(w.rb,E.MaxTileRow)}}w.cl<=w.cr&&w.rt<=w.rb&&s.tileMatrixLimits.push(w)}}a[n]=s}return a};TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();r.getUrls&&(t=r.getUrls()[0]);if(e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL){t.indexOf("?")<0&&(t+="?");t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")}return t};const H=function(t){return new e.style.Stroke({color:"#ffffff",width:t+4})},J=function(t){return new e.style.Stroke({color:"#000000",width:t+6})},Z=function(t){t instanceof e.style.Style&&(t=[t]);const r=(t=t.slice())[0],a=r.getImage();var n;if(a instanceof e.style.RegularShape){n=a.getStroke().getWidth();const o=a.getRadius(),i=r.clone();i.setImage(new e.style.Circle({radius:o,stroke:H(n)}));t.unshift(i);const s=r.clone();s.setImage(new e.style.Circle({radius:o,stroke:J(n)}));t.unshift(s)}else{n=r.getStroke().getWidth();t.unshift(new e.style.Style({stroke:H(n)}));t.unshift(new e.style.Style({stroke:J(n)}))}return t},Q=function(e){e._originalStyle=e._originalStyle||e.getStyle();return $.isFunction(e._originalStyle)?function(t,r){return Z(e._originalStyle(t,r))}:Z(e._originalStyle)},ee=function(e){e.setStyle(e._originalStyle);e._originalStyle=null},te=function(){this.style_=Q(this);this.styleFunction_=this.style_?e.Feature.createStyleFunction(this.style_):void 0};TC.wrap.control.Modify.prototype.activate=function(){const t=this;t.parent.map&&$.when(t.parent.map.wrap.getMap(),t.parent.layer.wrap.getLayer()).then(function(r,a){t.selectInteraction&&r.removeInteraction(t.selectInteraction);var o=new e.interaction.Select({layers:[a],hitTolerance:p});t.selectInteraction=o;r.addInteraction(o);var i=function(e){return e._wrap.parent};o.on("select",function(r){if(r.selected.length>0){r.selected.forEach(function(t){t.setStyle(Q(t));e.events.listen(t,e.events.EventType.CHANGE,te,t)});t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESSELECT,{ctrl:t,features:r.selected.map(i)}))}if(r.deselected.length>0){r.deselected.forEach(function(t){e.events.unlisten(t,e.events.EventType.CHANGE,te,t);ee(t)});0==r.selected.length&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:t.parent,features:r.deselected.map(i)}))}});t.modifyInteraction&&r.removeInteraction(t.modifyInteraction);var s=new e.interaction.Modify({features:o.getFeatures()});s.on(e.interaction.ModifyEventType.MODIFYEND,function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry();t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:t.parent.layer}))})});t.modifyInteraction=s;r.addInteraction(s);t.snapInteraction&&r.removeInteraction(t.snapInteraction);if(t.parent.snapping){t.snapInteraction=new e.interaction.Snap({source:a.getSource()});r.addInteraction(t.snapInteraction)}t._onMouseMove||(t._onMouseMove=function(e){const a=r.getTarget();var n,o=r.getEventPixel(e.originalEvent);n=r.forEachFeatureAtPixel(o,function(e,r){return r===t.parent.layer.wrap.getLayer()},{hitTolerance:p});a.style.cursor=n?"pointer":""});$(r.getViewport()).on(n,t._onMouseMove)})};TC.wrap.control.Modify.prototype.deactivate=function(){const t=this;if(t.modifyInteraction){t.selectInteraction.getFeatures().forEach(function(t){e.events.unlisten(t,e.events.EventType.CHANGE,te,t);ee(t)});t.modifyInteraction.setActive(!1);t.selectInteraction.setActive(!1);$.when(t.parent.map.wrap.getMap()).then(function(e){$(e.getViewport()).off(n,t._onMouseMove);e.removeInteraction(t.modifyInteraction);e.removeInteraction(t.selectInteraction);t.modifyInteraction=null;t.selectInteraction=null})}};TC.wrap.control.Modify.prototype.getSelectedFeatures=function(){var e=[];this.selectInteraction&&this.selectInteraction.getFeatures().forEach(function(t){e[e.length]=t._wrap.parent});return e};TC.wrap.control.Modify.prototype.setSelectedFeatures=function(e){if(this.selectInteraction){var t=this.selectInteraction.featureOverlay_.getSource();t.clear();t.addFeatures(e.map(function(e){return e.wrap.feature}))}};TC.wrap.control.Modify.prototype.unselectFeatures=function(e){e=e||[];const t=this,r=t.selectInteraction?t.selectInteraction.getFeatures():null;if(r){const a=[];r.getArray().slice().forEach(function(t){if(!e.length||e.indexOf(t)>=0){r.remove(t);a[a.length]=t._wrap.parent}});a.length&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{features:a}))}};TC.wrap.control.Edit.prototype.activate=function(e){this.cancel(!0);e===TC.Consts.editMode.SELECT&&TC.wrap.control.Modify.prototype.activate.call(this)};TC.wrap.control.Edit.prototype.deactivate=function(){var e=this;TC.wrap.control.Modify.prototype.deactivate.call(e);if(e.drawInteraction){e.drawInteraction.abortDrawing_();e.drawInteraction.setActive(!1);$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.drawInteraction);e.drawInteraction=null})}e.parent.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{ctrl:e}))};TC.wrap.control.Edit.prototype.cancel=function(e,t){this.points=[];this.histPoints=[];this.control&&this.control.layer||this.modifyInteraction&&this.modifyInteraction.layer;if(this.selectInteraction){var r=this.selectInteraction.getFeatures();this.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:this.parent,feature:r.get(0)}));r.clear();this.selectInteraction.setActive(!1)}};TC.wrap.control.Edit.prototype.getSelectedFeatures=function(){return TC.wrap.control.Modify.prototype.getSelectedFeatures.call(this)};TC.wrap.control.Edit.prototype.setSelectedFeatures=function(e){TC.wrap.control.Modify.prototype.setSelectedFeatures.call(this,e)};TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if($.isArray(e)){var r=e.map(function(e){return e.wrap.feature});$.when(t.parent.layer.wrap.getLayer()).then(function(e){for(var a=t.selectInteraction?t.selectInteraction.getFeatures():null,n=0,o=r.length;n<o;n++){var i=r[n];if(a){a.remove(i);t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent}))}e.getSource().removeFeature(i);t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent}))}})}};TC.wrap.Feature.prototype.toGML=function(t,r){var a=(new e.format.GML).writeGeometryNode(this.feature.getGeometry());return(new XMLSerializer).serializeToString(a.firstChild).replace(/\<\/?\w/gm,function(e){var t=e.indexOf("/")>0?e.indexOf("/")+1:1;return e.substring(0,t)+"gml:"+e.substring(t)})};TC.wrap.Feature.prototype.toGeoJSON=function(){return(new e.format.GeoJSON).writeGeometry(this.feature.getGeometry())};TC.wrap.Geometry.write=function(t){var r;(t=t||{}).format;t.parser=new e.format.GeoJSON;switch(t.type){case TC.Consts.geom.POLYLINE:r=new e.geom.LineString(t.coordinates);break;case TC.Consts.geom.POLYGON:r=new e.geom.Polygon(t.coordinates);break;case TC.Consts.geom.MULTIPOINT:r=new e.geom.MultiPoint(t.coordinates);break;case TC.Consts.geom.MULTIPOLYLINE:r=new e.geom.MultiLineString(t.coordinates);break;case TC.Consts.geom.MULTIPOLYGON:r=new e.geom.MultiPolygon(t.coordinates);break;case TC.Consts.geom.POINT:default:r=new e.geom.Point(t.coordinates)}return t.parser.writeGeometry(r)};TC.wrap.Geometry.toGeoJSON=function(e){return TC.wrap.Geometry.write(e)};return e});