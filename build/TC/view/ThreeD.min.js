var TC=TC||{};TC.view=TC.view||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.view.ThreeD=function(){var e={VIEWNAME:"ThreeD",CLASS:"tc-view-3d",Consts:{BLANK_BASE:"blank",DEFAULT_TILE_SIZE:256},classes:{MAP3D:"tc-map-3d",LOADING:"tc-loading",CAMERACTRARROWDISABLED:"disabled-arrow",FOCUS:"focus",HIGHLIGHTED:"highlighted",DISABLED:"disabled",OUTFOCUS:"outfocus"},allowedControls:[],template:{},viewer:null,mapView:null,terrainProvider:null,getLocaleString:function(e,t){var i=this.map?this.map.options.locale:TC.Cfg.locale;return TC.Util.getLocaleString(i,e,t)},getRenderedHtml:function(e,t,i){return TC.Control.prototype.getRenderedHtml.call(this,e,t,i)}};TC.isDebug&&(TC.Consts.url.CESIUM=TC.apiLocation+"lib/cesium/debug/Cesium.js");TC.Consts.classes.THREED=TC.Consts.classes.THREED||"tc-3d";TC.Consts.classes.THREED_HIDDEN=TC.Consts.classes.THREED_HIDDEN||"tc-3d-hidden";TC.Consts.event.TERRAINLOADED=TC.Consts.event.TERRAINLOADED||"terrainloaded.tc.threed";TC.Consts.event.TERRAINRECEIVING=TC.Consts.event.TERRAINRECEIVING||"terrainreceiving.tc.threed";TC.Consts.event.TERRAIN404=TC.Consts.event.TERRAIN404||"terrain404.tc.threed";e.template[e.CLASS]={compiler:[8,">= 4.3.0"],main:function(e,t,i,r,n){var a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<button class="tc-ctl-3d-btn tc-beta-button" title="'+e.escapeExpression(a(i,"i18n").call(null!=t?t:e.nullContext||{},"threed.tip",{name:"i18n",hash:{},data:n,loc:{start:{line:1,column:52},end:{line:1,column:73}}}))+'"></button>'},useData:!0};e.template[e.CLASS+"-overlay"]={compiler:[8,">= 4.3.0"],main:function(e,t,i,r,n){return'<div class="tc-view-3d-overlay" hidden>\r\n    <svg class="tc-view-3d-overlay-svg">\r\n        <defs>\r\n            <filter id="fGaussian" x="0" y="0">\r\n                <feGaussianBlur in="SourceGraphic" stdDeviation="3" />\r\n            </filter>\r\n        </defs>\r\n        <rect width="100%" height="100%" fill="white" fill-opacity="0.1" filter="url(#fGaussian)" />  \r\n    </svg>    \r\n</div>'},useData:!0};e.template[e.CLASS+"-cm-ctls"]={compiler:[8,">= 4.3.0"],main:function(e,t,i,r,n){var a=null!=t?t:e.nullContext||{},o=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div>\r\n    <svg xmlns:dc="http://purl.org/dc/elements/1.1/"\r\n         xmlns:cc="http://creativecommons.org/ns#"\r\n         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\r\n         xmlns:svg="http://www.w3.org/2000/svg"\r\n         xmlns="http://www.w3.org/2000/svg"\r\n         xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\r\n         xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\r\n         width="220"\r\n         height="135"\r\n         viewBox="0 0 63.40233 35.531682"\r\n         version="1.1"\r\n         id="threedControls">\r\n        <g inkscape:groupmode="layer"\r\n           id="backgroundLayer"\r\n           inkscape:label="backgroundLayer"\r\n           transform="translate(-2.3693123,-42.387899)">\r\n            <path style="fill:#ffffff;fill-opacity:0.23999999;stroke:none;stroke-width:0.2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:0.3169643;paint-order:stroke fill markers"\r\n                  d="M 48.005285,42.387899 A 17.766048,17.766048 0 0 0 34.067635,49.16888 17.754217,17.754217 0 0 0 20.123267,42.399784 17.754217,17.754217 0 0 0 2.3693123,60.153739 a 17.754217,17.754217 0 0 0 17.7539547,17.75447 17.754217,17.754217 0 0 0 13.923699,-6.76961 17.766048,17.766048 0 0 0 13.958319,6.78098 17.766048,17.766048 0 0 0 17.766357,-17.76584 17.766048,17.766048 0 0 0 -17.766357,-17.76584 z"\r\n                  id="background"\r\n                  inkscape:connector-curvature="0" />\r\n        </g>\r\n        <g inkscape:label="tiltLayer"\r\n           inkscape:groupmode="layer"\r\n           id="tiltLayer"\r\n           transform="translate(-26.69084,-42.254264)"\r\n           style="display:inline">\r\n            <g class="tc-view-3d-cm-tilt-indicator">\r\n                <path class="tc-view-3d-cm-tilt-inner"\r\n                      id="tiltInner"\r\n                      d="m 44.44423,52.861576 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"\r\n                      inkscape:connector-curvature="0">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.tilt.reset",{name:"i18n",hash:{},data:n,loc:{start:{line:33,column:27},end:{line:33,column:55}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-tilt-inner-image"\r\n                      d="m 40.116095,64.124648 c -0.12075,-0.119221 -0.171366,-0.928328 -0.171366,-2.739326 0,-2.143319 0.03709,-2.606753 0.223349,-2.79065 0.19727,-0.194769 0.269957,-0.196719 0.622509,-0.01671 0.219537,0.112088 0.761654,0.542242 1.204705,0.955894 l 0.805547,0.752098 v 0.939855 c 0,0.51692 -0.06955,1.085596 -0.154558,1.263727 -0.173436,0.363428 -1.919571,1.804317 -2.186551,1.804317 -0.09475,0 -0.249383,-0.07614 -0.343635,-0.169192 z m 3.287741,-0.05029 c -0.307698,-0.212789 -0.317387,-0.295835 -0.317387,-2.721198 0,-1.757783 0.05096,-2.552024 0.171366,-2.670904 0.120776,-0.119243 0.941399,-0.169194 2.779684,-0.169194 2.432612,0 2.618273,0.01838 2.756146,0.27272 0.08484,0.156511 0.147831,1.267987 0.147831,2.608402 0,3.088986 0.189068,2.899662 -2.895738,2.899662 -1.872744,0 -2.3862,-0.04266 -2.641902,-0.219488 z m 0.586357,-6.180807 c -0.314529,-0.267117 -0.397432,-0.458143 -0.397432,-0.915756 0,-0.785501 0.427643,-1.207722 1.223233,-1.207722 1.162181,0 1.675866,1.23538 0.851939,2.048861 -0.522115,0.515494 -1.126934,0.542392 -1.67774,0.07462 z m 2.780604,-0.09201 c -0.374474,-0.369724 -0.423284,-0.501051 -0.3506,-0.943285 0.118405,-0.72038 0.53618,-1.088187 1.236028,-1.088187 0.699848,0 1.117624,0.367807 1.236028,1.088187 0.07269,0.442234 0.02388,0.573561 -0.3506,0.943285 -0.300932,0.297119 -0.573881,0.429526 -0.885428,0.429526 -0.311544,0 -0.584496,-0.132407 -0.885428,-0.429526 z"\r\n                      id="tiltImage"\r\n                      inkscape:connector-curvature="0">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.tilt.reset",{name:"i18n",hash:{},data:n,loc:{start:{line:39,column:27},end:{line:39,column:55}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-tilt-outer tc-view-3d-cm-tilt-outer-circle"\r\n                      id="tiltOuter"\r\n                      d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"\r\n                      inkscape:connector-curvature="0">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.tilt.drag",{name:"i18n",hash:{},data:n,loc:{start:{line:45,column:27},end:{line:45,column:54}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-tilt-outer tc-view-3d-cm-tilt-outer-shell-circle"\r\n                      sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"\r\n                      inkscape:connector-curvature="0"\r\n                      id="tiltShell"\r\n                      d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 C 37.721509,56.11715 36.90502,57.97796 36.90502,60.0297 c 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 h 3.029207 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.tilt.drag",{name:"i18n",hash:{},data:n,loc:{start:{line:52,column:27},end:{line:52,column:54}}}))+'</title>\r\n                </path>\r\n            </g>\r\n        </g>\r\n        <g id="rotateLayer"\r\n           inkscape:groupmode="layer"\r\n           inkscape:label="rotateLayer"\r\n           style="display:inline"\r\n           transform="translate(-2.3693123,-42.387899)">\r\n            <path class="tc-view-3d-cm-rotate-right"\r\n                  sodipodi:nodetypes="cccccccc"\r\n                  inkscape:connector-curvature="0"\r\n                  id="right"\r\n                  d="m 53.241331,72.907368 0.900176,1.930847 c 3.602027,-1.827343 6.291427,-4.493353 8.092762,-8.066897 l 0.969844,0.452626 -0.663464,-4.788009 -3.222445,2.974451 0.983506,0.459005 c -1.447339,3.107391 -3.949649,5.598011 -7.060379,7.037977 z">\r\n                <title>'+o(s(i,"i18n").call(a,"threed.rotate.right",{name:"i18n",hash:{},data:n,loc:{start:{line:66,column:23},end:{line:66,column:53}}}))+'</title>\r\n            </path>\r\n            <path class="tc-view-3d-cm-rotate-left"\r\n                  sodipodi:nodetypes="cccccccc"\r\n                  inkscape:connector-curvature="0"\r\n                  id="left"\r\n                  d="m 42.795431,72.906221 -0.900176,1.930846 c -3.602027,-1.827342 -6.291427,-4.493352 -8.092762,-8.066896 l -0.969844,0.452626 0.663465,-4.788009 3.222444,2.974451 -0.983506,0.459005 c 1.44734,3.107391 3.949649,5.598011 7.060379,7.037977 z">\r\n                <title>'+o(s(i,"i18n").call(a,"threed.rotate.left",{name:"i18n",hash:{},data:n,loc:{start:{line:73,column:23},end:{line:73,column:52}}}))+'</title>\r\n            </path>\r\n            <path class="tc-view-3d-cm-tilt-up"\r\n                  sodipodi:nodetypes="cccccccc"\r\n                  inkscape:connector-curvature="0"\r\n                  id="up"\r\n                  d="M 7.737296,54.610066 5.80645,53.70989 c 1.827342,-3.602027 4.493352,-6.291427 8.066896,-8.092762 l -0.452626,-0.969844 4.788009,0.663465 -2.974451,3.222444 -0.459005,-0.983506 c -3.107391,1.44734 -5.598011,3.949649 -7.037977,7.060379 z">\r\n                <title>'+o(s(i,"i18n").call(a,"threed.tilt.left",{name:"i18n",hash:{},data:n,loc:{start:{line:80,column:23},end:{line:80,column:50}}}))+'</title>\r\n            </path>\r\n            <path class="tc-view-3d-cm-tilt-down"\r\n                  sodipodi:nodetypes="cccccccc"\r\n                  inkscape:connector-curvature="0"\r\n                  id="down"\r\n                  d="m 7.684579,65.708846 -1.930847,0.900176 c 1.827343,3.602027 4.493353,6.291427 8.066897,8.092762 l -0.452626,0.969844 4.788009,-0.663464 -2.974451,-3.222445 -0.459005,0.983506 C 11.615165,71.321886 9.124545,68.819576 7.684579,65.708846 Z">\r\n                <title>'+o(s(i,"i18n").call(a,"threed.tilt.right",{name:"i18n",hash:{},data:n,loc:{start:{line:87,column:23},end:{line:87,column:51}}}))+'</title>\r\n            </path>\r\n            <g class="tc-view-3d-cm-rotate-indicator">\r\n                <path class="tc-view-3d-cm-rotate-inner"\r\n                      inkscape:connector-curvature="0"\r\n                      d="m 48.010487,52.995444 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"\r\n                      id="rotateInner">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.rotate.reset",{name:"i18n",hash:{},data:n,loc:{start:{line:94,column:27},end:{line:94,column:57}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-rotate-inner-image"\r\n                      d="m 45.461645,60.604061 c 0.860585,-1.857231 1.777009,-3.864779 2.036499,-4.461218 0.471802,-1.084433 0.471802,-1.084433 0.66474,-0.667935 2.070474,4.46957 3.86201,8.443545 3.825603,8.485934 -0.02561,0.02982 -0.943964,-0.165127 -2.040793,-0.433206 -1.994234,-0.487419 -1.994234,-0.487419 -3.881098,-0.01711 -1.037775,0.258673 -1.950491,0.470314 -2.028258,0.470314 -0.07777,0 0.562721,-1.519553 1.423307,-3.376784 z m 1.23418,2.027617 c 1.353421,-0.310159 1.353421,-0.310159 1.353421,-2.998288 0,-1.534227 -0.05572,-2.627602 -0.129797,-2.547123 -0.101525,0.110295 -2.316061,4.831583 -2.659547,5.670031 -0.09645,0.23543 -0.15884,0.240844 1.435923,-0.12462 z"\r\n                      id="rotateImage"\r\n                      inkscape:connector-curvature="0">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.rotate.reset",{name:"i18n",hash:{},data:n,loc:{start:{line:100,column:27},end:{line:100,column:57}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-rotate-outer tc-view-3d-cm-rotate-outer-circle"\r\n                      inkscape:connector-curvature="0"\r\n                      d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"\r\n                      id="rotateOuter">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.rotate.drag",{name:"i18n",hash:{},data:n,loc:{start:{line:106,column:27},end:{line:106,column:56}}}))+'</title>\r\n                </path>\r\n                <path class="tc-view-3d-cm-rotate-outer tc-view-3d-cm-rotate-outer-shell-circle"\r\n                      d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 c -1.326946,1.360319 -2.143435,3.221129 -2.143435,5.272869 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 H 58.8088 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"\r\n                      id="rotateShell"\r\n                      inkscape:connector-curvature="0"\r\n                      sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc">\r\n                    <title>'+o(s(i,"i18n").call(a,"threed.rotate.drag",{name:"i18n",hash:{},data:n,loc:{start:{line:113,column:27},end:{line:113,column:56}}}))+"</title>\r\n                </path>\r\n            </g>            \r\n        </g>\r\n    </svg>\r\n</div>"},useData:!0};const t=function(e,t){var i=this;i.map=e;i.parent=t;Promise.resolve(i.map.getViewHTML()).then(function(e){i.viewHTML=e}.bind(i));i.metersPerUnit=e.getMetersPerUnit();i.maxResolution=null;i._oldMapSetCenter=e.setCenter;e.setCenter=function(r,n){e.on3DView?e.view3D.flyToMapCoordinates.call(t,r):i._oldMapSetCenter.call(e,r,n)}};t.prototype.getCenter=function(){return this.map.getCenter()};t.prototype.getExtent=function(){return this.map.getExtent()};t.prototype.getResolution=function(){return this.map.getResolution()};t.prototype.getRotation=function(){return this.map.getRotation()};t.prototype.getMaxResolution=function(){if(this.maxResolution)return this.maxResolution;if(null!==this.map.getResolutions())this.maxResolution=this.map.getResolutions()[0];else{var e=this.map.options.baselayerExtent;this.maxResolution=(e[2]-e[0])/this.parent.Consts.DEFAULT_TILE_SIZE}return this.maxResolution};t.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};t.prototype.setCenter=function(e){this._oldMapSetCenter.call(this.map,e)};t.prototype.setExtent=function(e){this.map.setExtent(e)};t.prototype.setResolution=function(e){this.map.setResolution(e)};t.prototype.setRotation=function(e){this.map.setRotation(e)};var i=function(e,t){return e.type===TC.Consts.layerType.WMTS?e.wrap.getCompatibleMatrixSets(t).length>0:e.isCompatible(t)},r=function(e,t){var i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r},n=function(e){if((e=e||{}).nearMapCoords){var t=e.bottomPixel.clone();t.y=Math.round(9*t.y/10);var i=a.call(this,t);if(i){var n=[e.nearMapCoords,i].sort(function(t,i){return r(e.cameraPosition,t)-r(e.cameraPosition,i)});return function(e,t){var i=t[0]-e[0],r=t[1]-e[1],n=Math.atan(r/i);i<0&&(n+=Math.PI);return[e[0]+1e6*Math.cos(n),e[1]+1e6*Math.sin(n)]}.apply(this,n)}}return null},a=function(e){var t=l(this.viewer.scene,e);if(t){t=Cesium.Cartographic.fromCartesian(t);return this.view3D.crs!==this.view3D.view2DCRS?TC.Util.reproject([Cesium.Math.toDegrees(t.longitude),Cesium.Math.toDegrees(t.latitude)],this.view3D.crs,this.view3D.view2DCRS):[Cesium.Math.toDegrees(t.longitude),Cesium.Math.toDegrees(t.latitude)]}return null},o=function(e,t){var i=this.viewer.scene.canvas,r=this.viewer.camera.frustum.fovy,n=2*e*Math.tan(r/2),a=Math.cos(Math.abs(t)),o=n/this.mapView.metersPerUnit/a,s=o/i.clientHeight,l=this.map.getResolutions();if(null===l){l=new Array(22);for(var c=0,u=l.length;c<u;++c)l[c]=this.mapView.getMaxResolution()/Math.pow(2,c)}for(var c=0;c<l.length;c++){if(l[c]<Math.abs(s)){s=l[c-1];break}if(l[c]===Math.abs(s)){s=l[c];break}c===l.length-1&&(s=l[c])}return s},s=function(e,t,i,r,n){var a,o=Cesium.Math.clamp,s=Cesium.defaultValue,l=n||{},c=s(l.duration,500),u=s(l.easing,function(e){return e}),v=l.callback,d=0,m=new Cesium.Matrix4;return new Promise(function(n,s){requestAnimationFrame(function s(l){a||(a=l);var C=u(o((l-a)/c,0,1));e.transform.clone(m);var p=(C-d)*t;d=C;e.lookAtTransform(r);e.rotate(i,p);e.lookAtTransform(m);if(C<1)requestAnimationFrame(s);else{v&&v();n()}})})},l=function(e,t){var i=e.camera.getPickRay(t),r=e.globe.pick(i,e);return r||e.camera.pickEllipsoid(t)},c=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return l(e,i)},u=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return l(e,i)},v=function(e,t,i,r){var n=e.camera,a=m(e,i),o=n.right,l=Cesium.Quaternion.fromAxisAngle(o,a),c=Cesium.Matrix3.fromQuaternion(l),u=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(n.position,i,u);var v=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,u,v);Cesium.Cartesian3.add(v,i,v);var d=Cesium.Matrix4.fromTranslation(v);s(n,t,v,d,r)},d=function(e,t,i){var r=new Cesium.Cartesian3,n=new Cesium.Cartesian3,a=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,r);Cesium.Cartesian3.normalize(t,n);Cesium.Cartesian3.cross(r,n,a);var o=Cesium.Cartesian3.dot(r,n),s=Cesium.Cartesian3.magnitude(a),l=Cesium.Cartesian3.dot(i,a),c=Math.atan2(s,o);return l>=0?c:-c},m=function(e,t){var i=e.camera,r=i.frustum.fovy/2,n=function(e){var t=e.camera,i=t.frustum.fovy/2,r=t.direction,n=Cesium.Quaternion.fromAxisAngle(t.right,i),a=Cesium.Matrix3.fromQuaternion(n),o=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(a,r,o);return new Cesium.Ray(t.position,o)}(e),a=Cesium.Cartesian3.clone(n.direction);Cesium.Cartesian3.negate(a,a);var o=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,o);var s=new Cesium.Cartesian3;Cesium.Cartesian3.negate(i.right,s);var l=d(o,a,s);return l+r};const C=function(e){this.parent=e;var t=function(e,t){var i=e.getBBox();value="rotate("+Cesium.Math.toDegrees(t)+" "+(i.x+i.width/2)+" "+(i.y+i.height/2)+")";document.getElementsByClassName(e.className.baseVal)[0].setAttribute("transform",value)};this.outControlsEvents=TC.Util.detectMouse()?["mouseleave"]:["touchleave","touchend"];this.outControls=function(e){this.isFocusingCameraCtrls=!1}.bind(this);this.inControlsEvents=TC.Util.detectMouse()?["mouseenter"]:["touchmove","touchstart"];this.inControls=function(){this.isFocusingCameraCtrls=!0;this.lastFocused=performance.now();if(this.div.classList.contains(this.parent.classes.OUTFOCUS)){this.div.classList.remove(this.parent.classes.OUTFOCUS);this.tiltIndicatorOuterCircle.classList.remove(this.parent.classes.OUTFOCUS);this.tiltIndicatorOuterShellCircle.classList.remove(this.parent.classes.OUTFOCUS);this.rotateIndicatorOuterCircle.classList.remove(this.parent.classes.OUTFOCUS);this.rotateIndicatorOuterShellCircle.classList.remove(this.parent.classes.OUTFOCUS)}}.bind(this);this.moveStart=function(){this.moving=!0}.bind(this);this.moveEnd=function(){this.moving=!1}.bind(this);this.postRender=function(){var e=this,i=e.parent;e.parent.view3D.isLoadingTiles.call(e.parent)&&e.customCollisionDetection();var r=e.getCamera(),s=r.positionCartographic;if(e.moving){t(e.tiltIndicator,r.pitch);t(e.rotateIndicator,-r.heading);e.disableRotate();e.disableTilt(5);i.view3D.crs!==i.view3D.view2DCRS?e._coordsXY=TC.Util.reproject([Cesium.Math.toDegrees(s.longitude),Cesium.Math.toDegrees(s.latitude)],i.view3D.crs,i.view3D.view2DCRS):e._coordsXY=[Cesium.Math.toDegrees(s.longitude),Cesium.Math.toDegrees(s.latitude)];i.mapView.setCenter(e._coordsXY);i.mapView.setResolution(o.call(i,s.height,s.latitude))}if(e._coordsXY){i._ovMap=i._ovMap||i.map.getControlsByClass("TC.control.OverviewMap")[0];i._ovMap&&i._ovMap.renderPromise().then(function(){var t=i.viewer.scene,o=t.canvas,s=new Cesium.Cartesian2(0,o.clientHeight-1),l=new Cesium.Cartesian2(o.clientWidth-1,o.clientHeight-1),c=[s,l,new Cesium.Cartesian2(o.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(e){return a.call(i,e)}).filter(function(e){return null!==e});if(c.length&&c.length<4){var u=n.call(i,{nearMapCoords:c[0],bottomPixel:s,cameraPosition:e._coordsXY}),v=n.call(i,{nearMapCoords:c[1],bottomPixel:l,cameraPosition:e._coordsXY});if(u&&v){c[2]=v;c[3]=u}}i._ovMap.wrap.draw3DCamera({position:e._coordsXY,heading:r.heading,fov:c})})}}.bind(this);this.selectors={tilt:"-cm-tilt",rotate:"-cm-rotate",indicator:"-indicator",leftArrow:"-left",rightArrow:"-right",downArrow:"-down",upArrow:"-up"};this.MIN_TILT=Cesium.Math.toRadians(-89);this.MAX_TILT=Cesium.Math.toRadians(-1);this.render()};C.prototype.bind=function(){var e=this;e.getCamera().moveStart.addEventListener(e.moveStart);e.getCamera().moveEnd.addEventListener(e.moveEnd);e.parent.viewer.scene.postRender.addEventListener(e.postRender);e.outControlsEvents.forEach(function(t){e.div.addEventListener(t,e.outControls)});e.inControlsEvents.forEach(function(t){e.div.addEventListener(t,e.inControls)});e.rAFInOutControls=requestAnimationFrame(function t(){e.lastFocused||(e.lastFocused=performance.now());var i=performance.now()-e.lastFocused;if(i>5e3&&!0!==e.isFocusingCameraCtrls&&!e.div.classList.contains(e.parent.classes.OUTFOCUS)){e.div.classList.add(e.parent.classes.OUTFOCUS);e.tiltIndicatorOuterCircle.classList.add(e.parent.classes.OUTFOCUS);e.tiltIndicatorOuterShellCircle.classList.add(e.parent.classes.OUTFOCUS);e.rotateIndicatorOuterCircle.classList.add(e.parent.classes.OUTFOCUS);e.rotateIndicatorOuterShellCircle.classList.add(e.parent.classes.OUTFOCUS)}e.rAFInOutControls=requestAnimationFrame(t)})};C.prototype.unbind=function(){var e=this;e.div.classList.add(TC.Consts.classes.HIDDEN);e.getCamera().moveStart.removeEventListener(e.moveStart);e.getCamera().moveEnd.removeEventListener(e.moveEnd);e.parent.viewer.scene.postRender.removeEventListener(e.postRender);e.outControlsEvents.forEach(function(t){e.div.removeEventListener(t,e.outControls)});e.inControlsEvents.forEach(function(t){e.div.removeEventListener(t,e.inControls)});window.cancelAnimationFrame(e.rAFInOutControls);e.lastFocused=void 0;e.rAFInOutControls=void 0};C.prototype.getCamera=function(){return this.parent.viewer.scene.camera};C.prototype.getCameraState=function(){if(this.parent.viewer){var e=this.parent.viewer.scene.camera,t=e.positionCartographic,i=u(this.parent.viewer.scene);if(i){var r=Cesium.Cartesian3.distance(e.position,i);return{cp:[t.longitude,t.latitude,t.height],chpr:[e.heading,e.pitch,e.roll],bcpd:r}}}};C.prototype.render=function(){var e=this;if(e.div){e.div.classList.remove(TC.Consts.classes.HIDDEN);e.bind()}else e.parent.getRenderedHtml(e.parent.CLASS+"-cm-ctls",{},function(t){e.div=document.createElement("div");e.div.classList.add(e.parent.CLASS+"-cm-ctls");e.div.innerHTML=t;e.parent.map.div.appendChild(e.div);var i="."+e.parent.CLASS+e.selectors.tilt;e.tiltIndicatorInner=e.div.querySelector("[class^="+i.replace(".","")+"-inner]");e.tiltIndicatorInner.addEventListener(TC.Consts.event.CLICK,e.resetTilt.bind(e));e.tiltIndicator=e.div.querySelector(i+"-indicator");e.tiltIndicatorOuterCircle=e.div.querySelector(i+"-outer-circle");e.tiltIndicatorOuterShellCircle=e.div.querySelector(i+"-outer-shell-circle");e.tiltIndicatorCircle=e.div.querySelector("[class^="+i.replace(".","")+"-outer]");e.tiltIndicatorCircle.addEventListener("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,r=e.currentTarget.getBoundingClientRect(),n=new Cesium.Cartesian2((r.right-r.left)/2,(r.bottom-r.top)/2),a=new Cesium.Cartesian2(e.clientX-r.left,e.clientY-r.top),o=Cesium.Cartesian2.subtract(a,n,t);this.draggingTilt.call(this,i,o);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.tiltUp=e.div.querySelector(i+e.selectors.upArrow);e.tiltUp.addEventListener(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(t.target.disabled){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0;e.tilt.call(e,5);e.tiltUpInterval=setInterval(function(){e.isTiltUpDisabled?e.tiltUpMouseUpFunction():e.tilt.call(e,5)}.bind(e),101);e.tiltUpMouseUpFunction=function(){clearInterval(e.tiltUpInterval);e.tiltUpInterval=void 0;document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0};document.addEventListener(i,e.tiltUpMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.tiltDown=e.div.querySelector(i+e.selectors.downArrow);e.tiltDown.addEventListener(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(t.target.disabled){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0;e.tilt.call(e,-5);e.tiltDownInterval=setInterval(function(){e.isTiltDownDisabled?e.tiltDownMouseUpFunction():e.tilt.call(e,-5)}.bind(e),101);e.tiltDownMouseUpFunction=function(){clearInterval(e.tiltDownInterval);e.tiltDownInterval=void 0;document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0};document.addEventListener(i,e.tiltDownMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));var r="."+e.parent.CLASS+e.selectors.rotate;e.rotateIndicatorInner=e.div.querySelector("[class^="+r.replace(".","")+"-inner]");e.rotateIndicatorInner.addEventListener(TC.Consts.event.CLICK,e.resetRotation.bind(e));e.rotateIndicator=e.div.querySelector(r+"-indicator");e.rotateIndicatorOuterCircle=e.div.querySelector(r+"-outer-circle");e.rotateIndicatorOuterShellCircle=e.div.querySelector(r+"-outer-shell-circle");e.rotateIndicatorCircle=e.div.querySelector("[class^="+r.replace(".","")+"-outer]");e.rotateIndicatorCircle.addEventListener("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,r=e.currentTarget.getBoundingClientRect(),n=new Cesium.Cartesian2((r.right-r.left)/2,(r.bottom-r.top)/2),a=new Cesium.Cartesian2(e.clientX-r.left,e.clientY-r.top),o=Cesium.Cartesian2.subtract(a,n,t);this.draggingRotate.call(this,i,o);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.rotateLeft=e.div.querySelector(r+e.selectors.leftArrow);e.rotateLeft.addEventListener(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0;e.rotate.call(e,-15);e.rotateLeftInterval=setInterval(function(){e.rotate.call(e,-15)}.bind(e),101);e.rotateLeftMouseUpFunction=function(){clearInterval(e.rotateLeftInterval);e.rotateLeftInterval=void 0;document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0};document.addEventListener(i,e.rotateLeftMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.rotateRight=e.div.querySelector(r+e.selectors.rightArrow);e.rotateRight.addEventListener(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0;e.rotate.call(e,15);e.rotateRightInterval=setInterval(function(){e.rotate.call(e,15)}.bind(e),101);e.rotateRightMouseUpFunction=function(){clearInterval(e.rotateRightInterval);e.rotateRightInterval=void 0;document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0};document.addEventListener(i,e.rotateRightMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.bind()}.bind(this))};C.prototype.disableTilt=function(e){var t=Cesium.Math.toRadians(e),i=this.getCamera().pitch;this.isTiltDownDisabled=i+-t<this.MIN_TILT;this.isTiltUpDisabled=i+t>this.MAX_TILT;this.tiltUp.disabled=this.isTiltUpDisabled;this.tiltUp.classList.toggle(this.parent.classes.CAMERACTRARROWDISABLED,this.isTiltUpDisabled);this.tiltDown.disabled=this.isTiltDownDisabled;this.tiltDown.classList.toggle(this.parent.classes.CAMERACTRARROWDISABLED,this.isTiltDownDisabled)};C.prototype.disableRotate=function(){var e=!0,t=this.parent.viewer.scene,i=t.canvas,r=new Cesium.Cartesian2(0,i.clientHeight-1),n=new Cesium.Cartesian2(i.clientWidth-1,i.clientHeight-1),o=[r,n,new Cesium.Cartesian2(i.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(e){return a.call(this,e)}.bind(this.parent)).filter(function(e){return null!==e});o.length&&o.length>=2&&(e=!1);this.rotateIndicatorInner.disabled=e;this.rotateLeft.disabled=e;this.rotateLeft.classList.toggle(this.parent.classes.CAMERACTRARROWDISABLED,e);this.rotateRight.disabled=e;this.rotateRight.classList.toggle(this.parent.classes.CAMERACTRARROWDISABLED,e);return e};C.prototype.tilt=function(e){this.disableTilt(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateUp(Cesium.Math.toRadians(e));else{null==c(this.parent.viewer.scene)&&(e>0?this.getCamera().lookUp():this.getCamera().lookDown());if(e>=Cesium.Math.PI_OVER_TWO&&this.isTiltUpDisabled||e<=-Cesium.Math.PI_OVER_TWO&&this.isTiltDownDisabled)return;var t=Cesium.Math.toRadians(e),i=c(this.parent.viewer.scene);if(i){var r=Cesium.Matrix4.fromTranslation(i);this.parent.view3D.rotateAroundAxis(this.getCamera(),-t,this.getCamera().right,r,{duration:100})}}};C.prototype.rotate=function(e){e=Cesium.Math.toRadians(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateRight(-e);else{var t=u(this.parent.viewer.scene);t&&v(this.parent.viewer.scene,e,t,{duration:100})}};C.prototype.draggingTilt=function(e,t){var i=this;i.tiltIndicatorOuterCircle.classList.add(i.parent.classes.HIGHLIGHTED);var r=new Cesium.Matrix4,n=new Cesium.Matrix4,a=new Cesium.Cartesian2;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0;i.isTilting=!0;var o=i.parent.viewer.scene,s=o.camera,l=c(o);if(l){i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(l,Cesium.Ellipsoid.WGS84,n);i.tiltIsLook=!1}else{i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(s.positionWC,Cesium.Ellipsoid.WGS84,n);i.tiltIsLook=!0}i.startCursorAngle=Math.atan2(-t.y,t.x);var u=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(i.tiltFrame);i.initialCameraAngle=Math.atan2(s.position.y,s.position.x);s.lookAtTransform(u);i.tiltMouseMoveFunction=function(t){o=this.parent.viewer.scene;s=o.camera;var i=e.getBoundingClientRect();center=new Cesium.Cartesian2((i.right-i.left)/2,(i.bottom-i.top)/2);var n=new Cesium.Cartesian2(t.clientX-i.left,t.clientY-i.top),l=Cesium.Cartesian2.subtract(n,center,a);console.log("Entra: "+l.toString());var c=Math.atan2(-l.y,l.x),v=c-this.startCursorAngle,d=Cesium.Math.zeroToTwoPi(this.initialCameraAngle-v);try{u=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(this.tiltFrame);var m=Math.atan2(s.position.y,s.position.x),C=d-m,p=s.pitch;(p+=C)<this.MIN_TILT?s.rotate(s.right,s.pitch-this.MIN_TILT):p>this.MAX_TILT?s.rotate(s.right,s.pitch-this.MAX_TILT):s.rotate(s.right,-C);this.disableTilt(5);s.lookAtTransform(u)}catch(t){this.tiltMouseUpFunction()}}.bind(i);i.tiltMouseUpFunction=function(e){i.tiltIndicatorOuterCircle.classList.remove(i.parent.classes.HIGHLIGHTED);i.isTilting=!1;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0};document.addEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.addEventListener("mouseup",i.tiltMouseUpFunction,!1)};C.prototype.draggingRotate=function(e,t){var i=this;document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0;i.rotateMouseMoveFunction=function(t){var n=e.getBoundingClientRect(),o=new Cesium.Cartesian2((n.right-n.left)/2,(n.bottom-n.top)/2),l=new Cesium.Cartesian2(t.clientX-n.left,t.clientY-n.top),c=Cesium.Cartesian2.subtract(l,o,a),u=Math.atan2(-c.y,c.x),d=u-i.rotateInitialCursorAngle,m=Cesium.Math.zeroToTwoPi(i.rotateInitialCameraAngle-d);s=i.parent.viewer.scene.camera;try{v=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(i.rotateFrame);var C=Math.atan2(s.position.y,s.position.x);s.rotateRight(m-C);s.lookAtTransform(v)}catch(t){i.rotateMouseUpFunction()}};i.rotateMouseUpFunction=function(e){i.isRotating=!1;i.rotateIndicatorOuterCircle.classList.remove(i.parent.classes.HIGHLIGHTED);document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0};if(i.disableRotate())i.rotateMouseUpFunction();else{i.rotateIndicatorOuterCircle.classList.add(i.parent.classes.HIGHLIGHTED);var r=new Cesium.Matrix4,n=new Cesium.Matrix4,a=new Cesium.Cartesian2;i.isRotating=!0;i.rotateInitialCursorAngle=Math.atan2(-t.y,t.x);var o=i.parent.viewer.scene,s=o.camera,l=c(i.parent.viewer.scene);if(null==l||null==l)if(null==(l=u(i.parent.viewer.scene))||null==l){i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(s.positionWC,Cesium.Ellipsoid.WGS84,n);i.rotateIsLook=!0}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(l,Cesium.Ellipsoid.WGS84,n);i.rotateIsLook=!1}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(l,Cesium.Ellipsoid.WGS84,n);i.rotateIsLook=!1}try{var v=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(i.rotateFrame);i.rotateInitialCameraAngle=Math.atan2(s.position.y,s.position.x);i.rotateInitialCameraDistance=Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(s.position.x,s.position.y,0));s.lookAtTransform(v)}catch(e){i.rotateMouseUpFunction()}document.addEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.addEventListener("mouseup",i.rotateMouseUpFunction,!1)}};C.prototype.resetTilt=function(){var e=-this.getCamera().pitch-Cesium.Math.toRadians(50);this.tilt(Cesium.Math.toDegrees(e))};C.prototype.resetRotation=function(e){const t=this;return new Promise(function(i,r){var n;n=-t.getCamera().heading;for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;e?e.callback=function(){i()}:i();if(this.parent.viewer&&this.parent.viewer.trackedEntity){var a=t.getCamera();a.rotate(Cesium.Cartesian3.fromDegrees(0,90),n)}else{var o=u(t.parent.viewer.scene);o&&v(t.parent.viewer.scene,n,o,e)}})};C.prototype.customCollisionDetection=function(){var e,t,i=new Cesium.Matrix4,r=new Cesium.Cartographic,n=this.parent.viewer.scene,a=this.parent.viewer.scene.camera,o=n.screenSpaceCameraController,s=(o.enableCollisionDetection,o.minimumCollisionTerrainHeight),l=o.minimumZoomDistance,c=n.globe,u=c.ellipsoid;n.mapProjection;if(!Cesium.Matrix4.equals(a.transform,Cesium.Matrix4.IDENTITY)){e=Cesium.Matrix4.clone(a.transform,i);t=Cesium.Cartesian3.magnitude(a.position);a._setTransform(Cesium.Matrix4.IDENTITY)}var v=r;u.cartesianToCartographic(a.position,v);var d=!1;if(v.height<s){var m=c.getHeight(v);if(null!=m){m+=l;if(v.height<m){v.height=m;u.cartographicToCartesian(v,a.position);d=!0}}}if(null!=e){a._setTransform(e);if(d){Cesium.Cartesian3.normalize(a.position,a.position);Cesium.Cartesian3.negate(a.position,a.direction);Cesium.Cartesian3.multiplyByScalar(a.position,Math.max(t,l),a.position);Cesium.Cartesian3.normalize(a.direction,a.direction);Cesium.Cartesian3.cross(a.direction,a.up,a.right);Cesium.Cartesian3.cross(a.right,a.direction,a.up)}}};C.prototype.limitCameraToInitExtent=function(){var e=this.viewer.camera.positionCartographic.clone();if(!(e.longitude>=this.initExtent.west&&e.longitude<=this.initExtent.east&&e.latitude>=this.initExtent.south&&e.latitude<=this.initExtent.north)){var t=this.viewer.scene.screenSpaceCameraController.maximumZoomDistance,i=.05*e.height/t;e.longitude=Math.max(this.initExtent.west-i,e.longitude);e.latitude=Math.max(this.initExtent.south-i,e.latitude);e.longitude=Math.min(this.initExtent.east+i,e.longitude);e.latitude=Math.min(this.initExtent.north+i,e.latitude);this.viewer.camera.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(e),orientation:{heading:this.viewer.camera.heading,pitch:this.viewer.camera.pitch}})}this.viewer.scene.screenSpaceCameraController.minimumZoomDistance=e.height>1800?400:200};var p=function(e){var t,i=!1,r=null,n=null,a=null,o=e.map.getResolution,s=function(t){if(n)return Promise.resolve();{const a={content:"table",titles:{main:TC.Util.getLocaleString(e.map.options.locale,"threed.rs.panel.gfi"),max:TC.Util.getLocaleString(e.map.options.locale,"threed.rs.panel.gfi")}};var i,r=e.map.getControlsByClass("TC.control.ControlContainer")[0];if(r){a.position=r.POSITION.RIGHT;i=r.addControl("resultsPanel",a)}else{a.div=document.createElement("div");e.map.div.appendChild(a.div);i=e.map.addControl("resultsPanel",a)}return i.then(function(e){e.caller=t;n=e;t.resultsPanel=n})}},l=function(){e.view3D.removeFeature.call(e,r);r=null};if(a=e.map.getControlsByClass(TC.control.FeatureInfo)[0]){t=a.displayMode;s(a).then(function(){a.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);e.map.on(TC.Consts.event.RESULTSPANELCLOSE,function(e){e.control===a.getDisplayControl()&&(a.querying||l())})})}this.clear=function(){a.closeResults();l()};this.reset=function(){this.clear();a.setDisplayMode(t);e.map.getResolution=o};this.send=function(t){return new Promise(function(n,o){i=!0;a.displayMode!==TC.Consts.infoContainer.RESULTS_PANEL&&a.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);a.resultsPanel&&a.resultsPanel.close();e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());!function(t){if(r)r.position=t;else{TC.control.FeatureInfoCommons.prototype.markerStyle;var i={position:t,billboard:{image:TC.Util.getBackgroundUrlFromCss(e.CLASS+"-marker"),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};r=e.view3D.addNativeFeature.call(e,i)}e.viewer.scene.requestRender()}(t);s(a).then(function(){var r,o=Cesium.Ellipsoid.WGS84.cartesianToCartographic(t);r=e.view3D.crs!==e.view3D.view2DCRS?TC.Util.reproject([Cesium.Math.toDegrees(o.longitude),Cesium.Math.toDegrees(o.latitude)],e.view3D.crs,e.view3D.view2DCRS):[Cesium.Math.toDegrees(o.longitude),Cesium.Math.toDegrees(o.latitude)];e.map.options.pixelTolerance||TC.Cfg.pixelTolerance;for(var s,c=e.viewer.scene.globe._surface._tilesToRender,u=0;!s&&u<c.length;++u){var v=c[u];Cesium.Rectangle.contains(v.rectangle,o)&&(s=v)}if(s){for(var d=s.data.imagery,m=d.length-1;m>=0;--m){var C=d[m],p=C.readyImagery;if(!p){n();return}}var h=s.tilingScheme.tileXYToNativeRectangle(s.x,s.y,s.level),f=(d.filter(function(e){return e.readyImagery.imageryLayer.isBaseLayer()})[0]||{}).readyImagery;e.map.getResolution=function(){var t=e.view3D.crs!==e.view3D.view2DCRS?TC.Util.reproject([h.west,h.south],e.view3D.crs,e.view3D.view2DCRS):[h.west,h.south],i=e.view3D.crs!==e.view3D.view2DCRS?TC.Util.reproject([h.east,h.north],e.view3D.crs,e.view3D.view2DCRS):[h.east,h.north],r=(i[0]-t[0])/(f&&f.imageryLayer.imageryProvider.tileWidth||256),n=(i[1]-t[1])/(f&&f.imageryLayer.imageryProvider.tileHeight||256);return Math.max(r,n)}.bind(e,f,h);e.map.one(TC.Consts.event.NOFEATUREINFO,function(e){i=!1;n(e)}.bind(a));e.map.one(TC.Consts.event.FEATUREINFO,function(e){i=!1;n(e)});e.map.on(TC.Consts.event.FEATURECLICK,function(e){l();n(e)});savedIsActive=a.isActive;a.isActive=!0;a.beforeRequest({xy:[0,0]});a.callback(r)}else n()})})};this.get2DMarker=function(){return a.filterFeature};this.isPending=function(){return i}},h=function(e){this.layerCrs=null;var t,i={CRS:["Capability","Layer","CRS"],TILEMATRIXSET:["Contents","TileMatrixSet","Identifier"],TILEMATRIXSETLABELS:["Contents","TileMatrixSet"]},r=function(e,t,i){if(i<t.length-1)return e.hasOwnProperty(t[i])?r(e[t[i]],t,++i):null;if(e instanceof Array){for(var n=[],a=0;a<e.length;a++)e[a].hasOwnProperty(t[i])&&n.push(e[a][t[i]]);return n}return e[t[i]]},n=function(e){const n=this;return new Promise(function(a,o){var s=function(e,t){if((capsURL=TC.Util.isOnCapabilities(e.url))&&(caps=TC.capabilities[capsURL]))for(var n=r(caps,i.TILEMATRIXSETLABELS,0),a=0;a<n.length;a++)if(TC.Util.CRSCodesEqual(t,n[a].SupportedCRS))return{id:n[a].Identifier,labels:r(n[a],["TileMatrix","Identifier"],0)};return null}(e,n.layerCrs),l={url:new t({url:e.options.urlPattern},e),layer:e.layerNames,style:"default",format:e.format||e.options.format,tileMatrixSetID:s.id,tileMatrixLabels:s.labels,tilingScheme:new Cesium.GeographicTilingScheme};a(new Cesium.WebMapTileServiceImageryProvider(l))})},a=function(){try{var e=new XMLHttpRequest;e.open("GET","#",!0);e.responseType="blob";return"blob"===e.responseType}catch(e){return!1}}();function o(e,t){var i=e.request;i.url=e.url;i.requestFunction=function(){var i=e.url,r=!1;e.isDataUri||e.isBlobUri||(r=e.isCrossOriginUrl);var n=Cesium.when.defer();!function(e,t,i,r){e.getWebGLUrl.call(e,t).then(function(t){var n=new Image;n.onload=function(e){r.resolve(n)}.bind(n,e);n.onerror=function(e,t){r.reject(t)}.bind(n,e);i&&(Cesium.TrustedServers.contains(t)?n.crossOrigin="use-credentials":n.crossOrigin="");n.src=t},function(e){r.reject(e)})}(e.layer,i,r&&t,n);return n.promise};var r=Cesium.RequestScheduler.request(i);if(Cesium.defined(r))return r.otherwise(function(e){return Cesium.when.reject(e)})}var s=function(e,t){Cesium.defined(t)&&Cesium.deprecationWarning("Resource.fetchImage.allowCrossOrigin","The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.");e=Cesium.defaultValue(e,!1);t=Cesium.defaultValue(t,!0);!function(e){if(e.state===Cesium.RequestState.ISSUED||e.state===Cesium.RequestState.ACTIVE)throw new Cesium.RuntimeError("The Resource is already being fetched.");e.state=Cesium.RequestState.UNISSUED;e.deferred=void 0}(this.request);if(!a||this.isDataUri||this.isBlobUri||!this.hasHeaders&&!e)return o(this,t);var i=this.fetchBlob();if(Cesium.defined(i)){var r,n;return i.then(function(e){if(Cesium.defined(e)){n=e;var t=window.URL.createObjectURL(e);return o(r=new Cesium.Resource({url:t}))}}).then(function(e){if(Cesium.defined(e)){window.URL.revokeObjectURL(r.url);e.blob=n;return e}}).otherwise(function(e){Cesium.defined(r)&&window.URL.revokeObjectURL(r.url);return Cesium.when.reject(e)})}};this.convert=function(e,i){this.layerCrs=i;t||function(){(t=function(e,t){Cesium.Resource.call(this,e);this.layer=t}).prototype.constructor=t;t.prototype=Object.create(Cesium.Resource.prototype,{});t.prototype.clone=function(e){var i=Cesium.Resource.prototype.clone.call(this,e);Cesium.defined(e)||(e=new t({url:this._url},this.layer));e._url=i._url;e._queryParameters=i._queryParameters;e._templateValues=i._templateValues;e.headers=i.headers;e.proxy=i.proxy;e.retryCallback=i.retryCallback;e.retryAttempts=i.retryAttempts;e._retryCount=0;e.request=i.request;return e};t.prototype.fetchImage=s}();switch(!0){case TC.Consts.layerType.WMTS==e.type:return n.call(this,e);case TC.Consts.layerType.WMS==e.type:return function(e){return new Promise(function(i,r){var n={url:new t({url:e.url},e),layers:e.layerNames,parameters:{version:"1.3.0",transparent:!0,format:e.format||e.options.format}},a=function(){var t=[];if(e.capabilities&&e.capabilities.Capability&&e.capabilities.Capability.Layer&&e.names.length>0)for(var i=e.names.slice(0),r=function t(i,r){if(i){for(var n=0;n<i.length;n++){var a=i[n];if(e.compareNames(e.wrap.getName(a),r))return a.EX_GeographicBoundingBox}return t(a.Layer,r)}};i.length>0;){var n=r([e.capabilities.Capability.Layer],i.pop());null!==n&&t.push(n)}return t}();a&&(e.geoBBox=a);i(new Cesium.WebMapServiceImageryProvider(n))})}.call(this,e)}}},f=function(){var e=null,t=function(e,t){e instanceof Array&&(e="rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")");var i=Cesium.Color.fromCssColorString(e);return void 0!==t?i.withAlpha(t):i},i=function(e,t,i){for(var r in t){var n=e[t[r].prop];if(void 0!==n)if("function"==typeof n){var a=n(i);a&&(t[r].val=a)}else t[r].val=n}},r=function(e){var t;t=null==(t=!e.layer||e.layer&&!e.layer.hasOwnProperty("styles")?TC.Defaults.styles:e.layer.styles)[e.STYLETYPE]?t["polyline"===e.STYLETYPE?"line":e.STYLETYPE]:t["multipolygon"===e.STYLETYPE?"polygon":e.STYLETYPE];return t=TC.Util.extend({},t,e.options,e.getStyle())};function n(e,t,i,r){var n=new Cesium.Entity({name:e,polyline:{positions:t,width:i.width,material:i.material,clampToGround:!0}});r(n)}var a=function(e){var a={},o=r(e);a.options=function(){var r,n={},a={color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(o,a,e);a.color.hasOwnProperty("val")&&(r=a.opacity.hasOwnProperty("val")?t(a.color.val,a.opacity.val):t(a.color.val));n.color=Cesium.ColorGeometryInstanceAttribute.fromColor(r);a.outlineColor.hasOwnProperty("val")&&(r=a.outlineOpacity.hasOwnProperty("val")?t(a.outlineColor.val,a.outlineOpacity.val):t(a.outlineColor.val));n.outlineColor=r;a.width.hasOwnProperty("val")&&(n.width=a.width.val);return n};TC.feature.MultiPolygon&&"TC.feature.MultiPolygon"==e.CLASSNAME?a.geometryType=function(t,i){return new Promise(function(r,a){for(var o,s=[],l=[],c=[],u=function(t){return new Promise(function(r,a){n(e.id,t,{material:i.outlineColor,width:i.width},function(e){c.push(e);r()})})},v=0;v<t.length;v++){for(var d=0;d<t[v].length;d++){var m;if(0==d){s.push(u.call(this,t[v][0]));m=new Cesium.PolygonHierarchy(t[v][0])}else{s.push(u.call(this,t[v][d]));m.holes.push(new Cesium.PolygonHierarchy(t[v][d]))}}l.push((o=m,new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:o}),attributes:{color:i.color}})))}Promise.all(s).then(function(){s=[];r([new Cesium.GroundPrimitive({releaseGeometryInstances:!1,geometryInstances:l}),c])})})}:TC.feature.Polygon&&"TC.feature.Polygon"==e.CLASSNAME&&(a.geometryType=function(t,i){return new Promise(function(r,a){Array.isArray(t)&&1===t.length&&Array.isArray(t[0])&&(t=t[0]);n(e.id,t,{material:i.outlineColor,width:i.width},function(n){r([new Cesium.GroundPrimitive({releaseGeometryInstances:!1,geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(t)}),attributes:{color:i.color}})}),n])})})});return a},o=function(a){var o={},s=r(a);o.options=function(){var e,r={},n={color:{prop:"strokeColor"},opacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(s,n,a);n.width.hasOwnProperty("val")&&(r.width=n.width.val);n.color.hasOwnProperty("val")&&(e=n.opacity.hasOwnProperty("val")?t(n.color.val,n.opacity.val):t(n.color.val));r.color=e;return r};TC.feature.MultiPolyline&&"TC.feature.MultiPolyline"==a.CLASSNAME?o.geometryType=function(t,i){return new Promise(function(r,o){var s=[],l=[];if(1==t.length){t=t[0];l.push(new Promise(function(e,r){n(a.id,t,{material:i.color,width:i.width},function(t){s.push(t);e()})}))}else{!function(t){var i;if(1==t.length){var r,n,a,o,s=t[0];r=new Cesium.Cartesian3(s.x-1e3,s.y,s.z);n=new Cesium.Cartesian3(s.x,s.y-1e3,s.z);a=new Cesium.Cartesian3(s.x+1e3,s.y,s.z);o=new Cesium.Cartesian3(s.x,s.y+1e3,s.z);i=Cesium.Rectangle.fromCartesianArray([r,n,a,o],Cesium.Ellipsoid.WGS84)}else i=Cesium.Rectangle.fromCartesianArray(t,Cesium.Ellipsoid.WGS84);var l=e.camera.getRectangleCameraCoordinates(i),c=Cesium.Cartesian3.distance(l,Cesium.BoundingSphere.fromPoints(t).center),u=e.camera.frustum.getPixelDimensions(e.drawingBufferWidth,e.drawingBufferHeight,c,new Cesium.Cartesian2);u=Math.max(u.x,u.y);Math.round(u)}((t=t.sort(function(e,t){return e.length>t.length?-1:e.length<t.length?1:0}))[0]);for(var c=0;c<t.length;c++)l.push(new Promise(function(e,r){n(a.id,t[c],{material:i.color,width:i.width},function(t){s.push(t);e()})}))}Promise.all(l).then(function(){l=[];r(s)})})}:TC.feature.Polyline&&"TC.feature.Polyline"==a.CLASSNAME&&(o.geometryType=function(e,t){return new Promise(function(i,r){n(a.id,e,{material:t.color,width:t.width},function(e){i(e)})})});return o},s=function(e){var n={},a=r(e);n.options=function(){var r={},n={rotation:{prop:"angle"},label:{prop:"label"},fontSize:{prop:"fontSize"},fontColor:{prop:"fontColor"},outlineLabelColor:{prop:"labelOutlineColor"},outlineLabelWidth:{prop:"labelOutlineWidth"},anchor:{prop:"anchor"},height:{prop:"height"},width:{prop:"width"},url:{prop:"url"},color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},outlineWidth:{prop:"strokeWidth"},radius:{prop:"radius"}};i(a,n,e);if(n.anchor.hasOwnProperty("val")){!n.url.hasOwnProperty("val")&&e.options.url?r.url=e.options.url:r.url=n.url.val;r.anchor=n.anchor.val}n.height.hasOwnProperty("val")&&(r.height=n.height.val);n.width.hasOwnProperty("val")&&(r.width=n.width.val);n.rotation.hasOwnProperty("val")&&(r.rotation=n.rotation.val);n.label.hasOwnProperty("val")&&(r.label=n.label.val);n.fontSize.hasOwnProperty("val")&&(r.fontSize=n.fontSize.val);n.fontColor.hasOwnProperty("val")&&(r.fontColor=t(n.fontColor.val));n.outlineLabelColor.hasOwnProperty("val")&&(r.outlineLabelColor=t(n.outlineLabelColor.val));n.outlineLabelWidth.hasOwnProperty("val")&&(r.outlineLabelWidth=n.outlineLabelWidth.val);n.color.hasOwnProperty("val")&&(n.opacity.hasOwnProperty("val")?r.color=t(n.color.val,n.opacity.val):r.color=t(n.color.val));n.outlineColor.hasOwnProperty("val")&&(n.outlineOpacity.hasOwnProperty("val")?r.outlineColor=t(n.outlineColor.val,n.outlineOpacity.val):r.outlineColor=t(n.outlineColor.val));n.outlineWidth.hasOwnProperty("val")&&(r.outlineWidth=n.outlineWidth.val);n.radius.hasOwnProperty("val")&&(r.radius=n.radius.val);return r};if(TC.feature.Marker&&"TC.feature.Marker"==e.CLASSNAME)n.geometryType=function(t,i){var r={name:e.id,position:t[0],billboard:{image:i.url,width:i.width,height:i.height,eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};i.anchor&&i.anchor.length>0&&(r.billboard.pixelOffset=new Cesium.Cartesian2(i.anchor[0],i.anchor[1]));if(i.label){r.label={text:i.label,font:"14pt sans-serif",heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,fillColor:i.fontColor,showBackground:!0,eyeOffset:new Cesium.Cartesian3(3e3,0,-100)};return new Cesium.Entity(r)}return new Cesium.Entity(r)};else if(TC.feature.Point&&"TC.feature.Point"==e.CLASSNAME){var o=new Cesium.PinBuilder;n.geometryType=function(t,i){var r=i.label;switch(!0){case r&&/^([A-Z])\w+$/gi.test(r):case r&&!/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(r):return new Cesium.Entity({name:e.id,position:t[0],label:{text:i.label,eyeOffset:new Cesium.Cartesian3(0,0,-100),heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BASELINE,font:"16px san-serif Helvetica",fillColor:Cesium.Color.BLACK,outlineColor:Cesium.Color.WHITE,outlineWidth:5,style:Cesium.LabelStyle.FILL_AND_OUTLINE}});case/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(r):return new Cesium.Entity({name:e.id,position:t[0],billboard:{image:o.fromText(r,i.fontColor,48).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});case i.radius&&i.radius>0:var n=new Array(2);const a=function(e,t,i){var r=(t=t.darken(.15,new Cesium.Color)).toCssColorString().replace("rgb","rgba").replace(")",",0)");e.save();e.scale(i/24,i/24);e.strokeStyle=r;e.miterLimit=4;e.font="normal normal 400 normal 15px / 21.4286px ''";e.font="   15px ";e.save();e.restore();e.save();e.restore();e.save();e.font="   15px ";e.save();e.fillStyle="#b3b3b3";e.fillStyle="rgba(179, 179, 179, 1)";e.strokeStyle=r;e.lineWidth=1.5;e.lineJoin="round";e.miterLimit="4";e.font="   15px ";e.beginPath();e.moveTo(11.578125,11.71875);e.lineTo(12.421875,11.71875);e.lineTo(12.421875,24);e.lineTo(11.578125,24);e.closePath();e.fill();e.stroke();e.restore();e.save();e.fillStyle=t.toCssColorString().replace("rgb","rgba").replace(")",", 1)");e.strokeStyle=r;e.lineWidth=1.5;e.lineJoin="round";e.miterLimit="4";e.font="   15px ";e.beginPath();e.moveTo(17,7);e.translate(12,7);e.rotate(0);e.arc(0,0,5,0,1.5707963267948966,0);e.rotate(0);e.translate(-12,-7);e.translate(12,7);e.rotate(0);e.arc(0,0,5,1.5707963267948966,3.141592653589793,0);e.rotate(0);e.translate(-12,-7);e.translate(12,7);e.rotate(0);e.arc(0,0,5,3.141592653589793,4.71238898038469,0);e.rotate(0);e.translate(-12,-7);e.translate(12,7);e.rotate(0);e.arc(0,0,5,-1.5707963267948966,0,0);e.rotate(0);e.translate(-12,-7);e.closePath();e.fill();e.stroke();e.restore()},s=function(e,t){o._cache||(o._cache={});n[0]=e;n[1]=t;var i=JSON.stringify(n),r=o._cache[i];if(r)return r;var s=document.createElement("canvas");s.width=t;s.height=t;var l=s.getContext("2d");a(l,e,t);o._cache[i]=s;return s};return new Cesium.Entity({name:e.id,position:t[0],billboard:{image:s(Cesium.Color.fromCssColorString(e.options.strokeColor?e.options.strokeColor:TC.Cfg.styles.point.strokeColor),48).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});default:return new Cesium.Entity({name:e.id,position:t[0],billboard:{image:o.fromColor(Cesium.Color.fromCssColorString(e.options.fillColor?e.options.fillColor:TC.Cfg.styles.point.fillColor),32).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}})}}}return n};this.convert=function(n,l,c,u){e=n;var v,d,m,C,p,h=!1,f=[],w=function(e,t){if(Array.isArray(e)){c!==u&&(e=TC.Util.reproject(e,c,u));t.push(e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1]))}},g=l.geometry,y=function(e,t){if(Array.isArray(e))for(var i=0;i<e.length;i++)w(e[i],t)},T=function(e,t){if(Array.isArray(e))for(var i=0;i<e.length;i++){t.push([]);y(e[i],t[t.length-1])}};switch(!0){case TC.feature.Circle&&"TC.feature.Circle"==l.CLASSNAME:y(g,f);d=function(e){var n={},a=r(e);n.options=function(){var r,n={},o={color:{prop:"strokeColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"fillColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(a,o,e);o.color.hasOwnProperty("val")&&(r=o.opacity.hasOwnProperty("val")?t(o.color.val,o.opacity.val):t(o.color.val));n.color=Cesium.ColorGeometryInstanceAttribute.fromColor(r);o.outlineColor.hasOwnProperty("val")&&(r=o.outlineOpacity.hasOwnProperty("val")?t(o.outlineColor.val,o.outlineOpacity.val):t(o.outlineColor.val));n.outlineColor=Cesium.ColorGeometryInstanceAttribute.fromColor(r);o.width.hasOwnProperty("val")&&(n.width=o.width.val);return n};n.geometryType=function(t,i){return new Cesium.GroundPrimitive({releaseGeometryInstances:!1,geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.CircleGeometry({center:t[0],radius:e.geometry[1]}),attributes:{color:i.color}})})};return n}.call(self,l);break;case TC.feature.MultiPolygon&&"TC.feature.MultiPolygon"==l.CLASSNAME:p=g;if(Array.isArray(p)){!function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){f.push([]);T(e[t],f[f.length-1])}}(p);d=a.call(self,l);h=!0}break;case TC.feature.Polygon&&"TC.feature.Polygon"==l.CLASSNAME||TC.feature.MultiPolyline&&"TC.feature.MultiPolyline"==l.CLASSNAME:C=g;if(Array.isArray(C)){T(C,f);if("TC.feature.Polygon"==l.CLASSNAME){d=a(l);h=!0}else if("TC.feature.MultiPolyline"==l.CLASSNAME){d=o(l);h=!0}}break;case TC.feature.Polyline&&"TC.feature.Polyline"==l.CLASSNAME:m=g;if(Array.isArray(m)){y(m,f);d=o(l);h=!0}break;case TC.feature.Marker&&"TC.feature.Marker"==l.CLASSNAME:case TC.feature.Point&&"TC.feature.Point"==l.CLASSNAME:y(m=[g],f);d=s(l)}if(0==f.length)return null;(v={id:l.id,attributes:l.data,boundigSphere:Cesium.BoundingSphere.fromPoints(f)}).geometry=h?function(e){d.provider=e;return d.geometryType(f,d.options())}:d.geometryType(f,d.options());return v}};const w={baseMap:"",baseMaps:[],baseVector:""};e.init=function(e){const i=this;i.events=i.map.$events;i.selectors={divThreedMap:e.divMap};if(!e.terrain)throw Error("Falta configuraci\xf3n del terreno");i.terrain=e.terrain;if(e.terrainFallback&&e.terrainFallback.url&&e.terrainFallback.coverageName&&e.terrainFallback.noDataValue)i.terrainFallback={url:e.terrainFallback.url.trim(),layerName:e.terrainFallback.coverageName,format:e.terrainFallback.format,noDataValue:e.terrainFallback.noDataValue};else if(e.terrainFallback&&(!e.terrainFallback.url||!e.terrainFallback.coverageName||!e.terrainFallback.noDataValue))throw Error("Faltan datos sobre el terreno de respaldo");e.controls&&(i.allowedControls=e.controls);i.mapView=new t(i.map,i);i.map.on(TC.Consts.event.PROJECTIONCHANGE,function(e){i.mapView.metersPerUnit=i.map.getMetersPerUnit()});i.map.view3D=i.view3D;i.getRenderedHtml(i.CLASS+"-overlay",{},function(e){const t=new DOMParser;i.overlay=t.parseFromString(e,"text/html").body.firstChild})};e.apply=function(e){const t=this;if(!(e=e||{}).map)throw Error("Falta referencia al mapa 2D");t.map=e.map;if(!t.map.view3D){var r=t.VIEWNAME=t.VIEWNAME.substr(0,1).toLowerCase()+t.VIEWNAME.substr(1);if(!t.map.options.views||!t.map.options.views.hasOwnProperty(r))throw Error("Falta configuraci\xf3n de la vista");t.init(t.map.options.views[r])}t.view3D.view2DCRS=e.map.crs;e.map.on(TC.Consts.event.PROJECTIONCHANGE,function(e){t.view3D.view2DCRS=e.newCrs});e.state&&t.map.toast(TC.Util.getLocaleString(t.map.options.locale,"threed.apply3DState"),{type:TC.Consts.msgType.INFO});t.waiting||(t.waiting=t.map.getLoadingIndicator().addWait());if(!t.ctrlsToMng){for(var n=[],a=0,o=t.allowedControls.length;a<o;a++){var s=t.allowedControls[a];s=s.substr(0,1).toUpperCase()+s.substr(1);var l=t.map.getControlsByClass("TC.control."+s);0===l.length&&t.map.on(TC.Consts.event.CONTROLADD,function(e,i){try{var r=new Function("return new "+e+"()")();r.CLASS===i.control.CLASS&&t.ctrlsToMng.push(i.control)}catch(e){console.warn("Error al obtener la clase CSS de un control soportado")}}.bind(t,"TC.control."+s));n=n.concat(l)}t.ctrlsToMng=n}t.map.on3DView=!0;t.map.div.classList.add(TC.Consts.classes.THREED);t.divThreedMap=document.querySelector("#"+t.selectors.divThreedMap);t.divThreedMap.classList.add(t.classes.MAP3D,t.classes.LOADING);t.view3D.container=t.divThreedMap;const c=function(){console.log("Llega a applyEnd");t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting;e.callback&&e.callback()};try{t.view3D.loadViewer.call(t).then(function(){t.divThreedMap.classList.remove(t.CLASS+"-divMap-fadeOut");t.divThreedMap.classList.add(t.CLASS+"-divMap-fadeIn");t.mapView.viewHTML.classList.remove(t.CLASS+"-divMap-fadeIn");t.mapView.viewHTML.classList.add(t.CLASS+"-divMap-fadeOut");e.state||t.divThreedMap.classList.remove(t.classes.LOADING);(function(e){const t=this;return new Promise(function(r,n){var a=e.baseLayer instanceof TC.layer.Raster;if(a){if(!i(e.baseLayer,t.view3D.crs)){var o=e.baseLayer.getFallbackLayer();o&&o._capabilitiesPromise.then(function(){o.isCompatible(t.view3D.crs)||e.toast(t.getLocaleString("threed.baseLayerNoCompatible",{name:e.baseLayer.layerNames}))})}}else w.baseVector=e.baseLayer;0===w.baseMaps.length&&Promise.all(e.baseLayers.map(function(e){if(i(e,t.view3D.crs))return Promise.resolve(!1);var r=e.getFallbackLayer();return r?r._capabilitiesPromise.then(function(){return!r.isCompatible(t.view3D.crs)}):Promise.resolve(!0)})).then(function(t){if(t.length>0)for(var i=0;i<e.baseLayers.length;i++)e.baseLayers[i].mustReproject=t[i];r()});w.baseMap=a?e.baseLayer:t.Consts.BLANK_BASE})}).call(t,t.map).then(function(){t.view3D.setCameraFromMapView.call(t);t.view3D.setBaseLayer.call(t,t.map.baseLayer);t.map.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS}).reverse().forEach(function(e){t.view3D.addLayer.call(t,e)});t.viewer.readyPromise.then(function(){t.view3D.cameraControls?t.view3D.cameraControls.render.call(t.view3D.cameraControls):t.view3D.cameraControls=new C(t);e.animateRendering||e.state||(e.animateRendering=!0);if(e.state){t.divThreedMap.classList.remove(t.classes.LOADING);var i=t.view3D.cameraControls.getCamera();i.flyTo({destination:Cesium.Cartesian3.fromRadians(e.state.cp[0],e.state.cp[1],e.state.cp[2]),orientation:{heading:e.state.chpr[0],pitch:e.state.chpr[1],roll:e.state.chpr[2]},complete:c})}else if(e.animateRendering){let e=Cesium.Math.toRadians(50),i=u(t.viewer.scene);const r=function(i){let r=Cesium.Matrix4.fromTranslation(i);t.view3D.rotateAroundAxis(t.viewer.scene.camera,-e,t.viewer.scene.camera.right,r,{duration:2e3,callback:n})},n=function(){Cesium.Camera.DEFAULT_VIEW_RECTANGLE=t.view3D.initialRectangle=t.viewer.camera.computeViewRectangle();Cesium.Camera.DEFAULT_VIEW_FACTOR=0;c()};if(i)r(i);else{let e,i=(new Date).getTime();const a=function(){let a=u(t.viewer.scene);if(a){clearInterval(e);r(a)}else if((new Date).getTime()-i>15e3){clearInterval(e);let t=document.querySelectorAll("."+TC.control.NavBarHome.prototype.CLASS+"-btn");t&&t.length>0&&t[0].click();n();return}};e=setInterval(a,50)}}else c();t.map.trigger(TC.Consts.event.VIEWCHANGE,{view:TC.Consts.view.THREED});t.events.on(TC.Consts.event.TERRAINLOADED,function(){const e=function(e){var i=Cesium.Ellipsoid.WGS84.cartesianToCartographic(e),r=t.viewer.scene.globe.getHeight(i)||0,n={longitude:i.longitude,latitude:i.latitude,height:i.height+r};return Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)};var i=t.viewer.entities.values.filter(function(e){return e.billboard});i.length>0&&i.forEach(function(t){t.position=e(Cesium.Property.getValueOrUndefined(t.position,Cesium.JulianDate.now))});if(t.viewer.billboardCollection){for(var r=0;r<t.viewer.billboardCollection.length;r++)t.viewer.billboardCollection.get(r).position=e(t.viewer.billboardCollection.get(r).position);t.viewer.scene.requestRender()}})}.bind(t)).catch(()=>{console.log("3051");c()})}).catch(()=>{console.log("3053");c()})}).catch(()=>{console.log("3055");c()})}catch(e){c();throw e}};e.unapply=function(e){const t=this;t.waiting||(t.waiting=t.map.getLoadingIndicator().addWait());t.map.on3DView=!1;t.view3D.cameraControls.resetRotation({duration:1e3}).then(function(){var i=u(t.viewer.scene),r=Cesium.Matrix4.fromTranslation(i),n=m(t.viewer.scene,i);t.view3D.rotateAroundAxis(t.viewer.scene.camera,-n,t.viewer.scene.camera.right,r,{duration:1500,callback:function(){t.map.div.classList.remove(TC.Consts.classes.THREED);t.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE,{terrainProvider:t.viewer.scene.terrainProvider});t.viewer.scene.terrainProvider.fallbackProvider&&t.viewer.scene.terrainProvider.fallbackProvider.forEach(function(e){t.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE,{terrainProvider:e})});t.view3D.setViewFromCameraView.call(t).then(function(){t.divThreedMap.classList.remove(t.classes.MAP3D,t.CLASS+"-divMap-fadeIn");t.divThreedMap.classList.add(t.CLASS+"-divMap-fadeOut");t.mapView.viewHTML.classList.remove(t.CLASS+"-divMap-fadeOut");t.mapView.viewHTML.classList.add(t.CLASS+"-divMap-fadeIn");t.view3D.destroy.call(t);t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting;e.callback&&e.callback()});t.mapView.setRotation(0);t._ovMap.wrap.draw3DCamera(null)}})})};e.view3D=function(){const t=new h(/(EPSG\:?4326)/i),r=new f,n=function(e){var t=e;switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.add(e);break;case e instanceof Object&&e.hasOwnProperty("billboard"):this.viewer.billboardCollection||(this.viewer.billboardCollection=this.viewer.scene.primitives.add(new Cesium.BillboardCollection({scene:this.viewer.scene})));var i=this.viewer.billboardCollection.add({position:e.position,image:e.billboard.image,verticalOrigin:e.billboard.verticalOrigin,heightReference:e.billboard.heightReference});t=i;break;case e instanceof Object:(t=this.viewer.entities.getById(e.id))||(t=this.viewer.entities.add(e))}this.viewer.scene.requestRender();return t},a=function(e,t,i,r){if(e.vector2DFeatures.hasOwnProperty(t))e.vector2DFeatures[t].hasOwnProperty(r)?e.vector2DFeatures[t][r].push(i):e.vector2DFeatures[t][r]=[i];else{e.vector2DFeatures[t]={};e.vector2DFeatures[t][r]=[i]}},l=[TC.Consts.event.BEFOREBASELAYERCHANGE,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.LAYERADD,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERORDER,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.FEATURESCLEAR,TC.Consts.event.ZOOMTO],v=function(){var e=this;if(e.map.on3DView&&!e.view3D.trackingEntity){var t=e.view3D.linked2DControls.geolocation,i=t.layerTracking.features.filter(function(e){return"TC.feature.Polyline"==e.CLASSNAME});if(i&&i.length>0){var r=[];const a=new Cesium.CallbackProperty(function(e,t){if(i[0].geometry.length>r.length){var n=i[0].geometry.slice(r.length).map(function(e){var t=e;this.view3D.view2DCRS!==this.view3D.crs&&(t=TC.Util.reproject(e,this.view3D.view2DCRS,this.view3D.crs));return Cesium.Cartographic.fromDegrees(t[0],t[1],e[2])}.bind(this)),a=[];a=n instanceof Array?Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(n):[Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)];return r=r.concat(a)}return r}.bind(this),!1);var n=new Cesium.Entity({id:"trackingEntity",polyline:{positions:a,clampToGround:!0,width:3,material:new Cesium.PolylineDashMaterialProperty({color:new Cesium.CallbackProperty(function(i,r){e.viewer.scene.requestRender();return Cesium.Color.fromAlpha(new Cesium.Color(0,255,209),t.track.renderTrack.checked?1:0)}.bind(this),!1),gapColor:Cesium.Color.TRANSPARENT})}});e.view3D.trackingEntity=e.viewer.entities.add(n);e.viewer.scene.requestRender()}}},d=function(e){var t=this.view3D.linked2DControls.geolocation;switch(!0){case t.Const.Event.IMPORTEDTRACK.indexOf(e.type)>-1:case e.target.className.indexOf("draw")>-1&&e.target.parentElement.classList.contains(t.Const.Classes.SELECTEDTRACK):case!(e.target.parentElement&&e.target.parentElement.classList.contains(t.Const.Classes.SELECTEDTRACK)):case e.target.className.indexOf("stop")>-1:if(this.map.on3DView){this.viewer.clock.shouldAnimate=!1;this.viewer.clock.currentTime=Cesium.JulianDate.fromDate(new Date)}if(this.view3D.trackDataSource){if(this.view3D.trackDataSource.length>0){var i=this.view3D.trackDataSource.get(0).entities.values[0];this.viewer.entities.removeById(i.id)}this.view3D.trackDataSource.destroy();delete this.view3D.trackDataSource}t.chartProgressClear();if(e.custom){const e=t.getSelectedTrack();e&&e.querySelector(t.Const.Selector.STOP).click()}break;case e.target.className.indexOf("play")>-1:this.viewer.clock.shouldAnimate=!1;break;case e.target.className.indexOf("pause")>-1:this.viewer.clock.shouldAnimate=!0;break;case e.target.className.indexOf("back")>-1:case e.target.className.indexOf("for")>-1:this.viewer.clock.multiplier=t.simulate_speed}},m=function(e){var t=this;const i=t.ctrlsToMng.map(function(e){return e.CLASS});t.map.controls.forEach(function(t){if(i.indexOf(t.CLASS)<0)switch(!0){case TC.Consts.view.DEFAULT==e:t.enable();break;case TC.Consts.view.THREED==e:t.disable()}});switch(!0){case TC.Consts.view.DEFAULT==e:document.querySelectorAll("[data-no-3d]").forEach(function(e){e.classList.remove(TC.Consts.classes.THREED_HIDDEN)});t.ctrlsToMng.forEach(function(e){e.div.classList.remove(TC.Consts.classes.THREED)});break;case TC.Consts.view.THREED==e:document.querySelectorAll("[data-no-3d]").forEach(function(e){e.classList.add(TC.Consts.classes.THREED_HIDDEN)});t.ctrlsToMng.forEach(function(e){e.div.classList.add(TC.Consts.classes.THREED)})}const r=e=>{if(t.viewer.trackedEntity)return;const i=function(){var i=t.viewer.camera.getPickRay(e.position),r=t.viewer.scene.globe.pick(i,t.viewer.scene);r&&t.view3D.getInfoOnPickedPosition.call(t,r)};var r=t.viewer.scene.pick(e.position);if(r&&r.id){var n=r.id instanceof Cesium.Entity?r.id.name:r.id,a=!1;for(var o in t.view3D.vector2DFeatures)if(t.view3D.vector2DFeatures[o].hasOwnProperty(n)){var s=t.map.workLayers.filter(function(e){return e.id===o})[0].features.filter(function(e){return n.indexOf(e.id)>-1&&e.showsPopup});if(s&&s.length>0){a=!0;if("TC.feature.Point"!==s.CLASSNAME&&"TC.feature.Marker"!==s.CLASSNAME){var l=t.viewer.camera.getPickRay(e.position),c=t.viewer.scene.globe.pick(l,t.viewer.scene),u=t.map.view3D.addNativeFeature.call(t.map,{position:c,billboard:{image:TC.Util.getBackgroundUrlFromCss(t.CLASS+"-marker"),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});const i=function(e){if(e.control){const r=e.control,n=function(e){if(e.control===r){t.map.off(TC.Consts.event.RESULTSPANELCLOSE,n);t.map.view3D.removeFeature.call(t,u)}};t.map.on(TC.Consts.event.RESULTSPANELCLOSE,n);t.map.off(TC.Consts.event.DRAWTABLE,i)}};t.map.on(TC.Consts.event.DRAWTABLE,i)}t.map.trigger(TC.Consts.event.FEATURECLICK,{feature:s[0]});break}}a||i()}else i()},n=e=>{if(!t.viewer.trackedEntity){var i=t.viewer.scene.pick(e.endPosition);i&&i.id?t.viewer.canvas.style.cursor="pointer":t.viewer.canvas.style.cursor="default"}};if(TC.Consts.view.THREED===e){t.view3D.linked2DControls.featureInfo||(t.view3D.linked2DControls.featureInfo=new p(t));t.eventHandlers||(t.eventHandlers={});t.eventHandlers.handlerOfFeatures=new Cesium.ScreenSpaceEventHandler(t.viewer.scene.canvas);t.eventHandlers.handlerOfFeatures.setInputAction(r,Cesium.ScreenSpaceEventType.LEFT_CLICK);t.eventHandlers.handlerOfFeatures.setInputAction(n,Cesium.ScreenSpaceEventType.MOUSE_MOVE)}else TC.Consts.view.DEFAULT===e&&t.eventHandlers.handlerOfFeatures&&t.eventHandlers.handlerOfFeatures.destroy();!t.view3D.linked2DControls.geolocation&&t.allowedControls.indexOf("geolocation")>-1&&(t.view3D.linked2DControls.geolocation=t.ctrlsToMng.filter(function(e){return e instanceof TC.control.Geolocation})[0]);if(t.view3D.linked2DControls.geolocation){var a=t.view3D.linked2DControls.geolocation;if(TC.Consts.view.THREED===e){var o=[a.Const.Selector.STOP,a.Const.Selector.PAUSE,a.Const.Selector.BACKWARD,a.Const.Selector.FORWARD,a.Const.Selector.DRAW],s=d.bind(t),l=function(e){o.some(function(t){return e.target.classList.contains(t.replace(".",""))})&&s(e)};a.reset=function(){TC.wrap.control.Geolocation.prototype.setTracking=a._setTracking;TC.wrap.control.Geolocation.prototype.simulateTrack=a._wrap_simulateTrack;TC.wrap.control.Geolocation.prototype.showElevationMarker=a._wrap_showElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=a._wrap_hideElevationMarker;a.simulateTrack=a._simulateTrack;a.elevationTrack=a._elevationTrack;o.forEach(function(e){document.removeEventListener("click",l)});a.off(a.Const.Event.IMPORTEDTRACK,s)};document.addEventListener("click",l);a.on(a.Const.Event.IMPORTEDTRACK,s);a._setTracking=TC.wrap.control.Geolocation.prototype.setTracking;TC.wrap.control.Geolocation.prototype.setTracking=function(e){a._setTracking.call(a.wrap,e);if(e)a.on(a.Const.Event.POSITIONCHANGE,v.bind(t));else{a.off(a.Const.Event.POSITIONCHANGE,v.bind(t));if(t.view3D.trackingEntity){t.viewer.entities.removeById(t.view3D.trackingEntity.id);delete t.view3D.trackingEntity}}};a._elevationTrack=a.elevationTrack;a.elevationTrack=function(e,i){i&&d.call(t,{target:{className:"stop"},custom:!0});return a._elevationTrack.call(a,e,i)};const e=a.getSelectedTrack();e&&a.hasElevation&&a.elevationTrack.call(t,e,!0);var c;a._simulateTrack=a.simulateTrack;a.simulateTrack=function(e){var t=this.view3D.linked2DControls.geolocation;t.map.toast(t.getLocaleString("threed.interactionSimulation"),{type:TC.Consts.msgType.INFO});if(this.viewer.clock.shouldAnimate&&this.view3D.trackDataSource){c();d.call(this,{target:{className:"stop"},custom:!0})}t.simulate_speed=1;t.drawTrack(e,!1).then(function(){t.wrap.simulateTrack();if(t.layerTrack&&t.layerTrack.features){var i=t.layerTrack.features.filter(function(e){return"TC.feature.Polyline"==e.CLASSNAME})[0];i&&function(e,t,i,r,n,a){const o=this;return new Promise(function(n,s){var l=e.map(function(e){var t=e;o.view3D.view2DCRS!==o.view3D.crs&&(t=TC.Util.reproject(e,o.view3D.view2DCRS,o.view3D.crs));return Cesium.Cartographic.fromDegrees(t[0],t[1])});Cesium.when(o.viewer.terrainProvider.sampleTerrainMostDetailed(l),function(o){var s,l,c=0;if(t===ol.geom.GeometryLayout.XYZM){s=e[0][3];l=e[e.length-1][3]}else if(t===ol.geom.GeometryLayout.XYM){s=e[0][2];l=e[e.length-1][2]}else{e[0][3]=o[0].time=Date.now();for(var u=1;u<o.length;u++){var v,d=[];o[u].time=0;d=u+1<o.length?o.slice(u-1,u+1):o.slice(u-1);v=new Cesium.EllipsoidGeodesic(d[0],d[1]).surfaceDistance;c+=v;e[u][3]=o[u].time=o[u-1].time+36e5*v/a}s=o[0].time;l=o[o.length-1].time}if(0===c)for(var u=1;u<o.length;u++){var d=[];d=u+1<o.length?o.slice(u-1,u+1):o.slice(u-1);c+=new Cesium.EllipsoidGeodesic(d[0],d[1]).surfaceDistance}s=new Date(s).toISOString();l=new Date(l).toISOString();var m=[{id:"document",name:"CZML Model",version:"1.0"},{id:"path",name:i,availability:s+"/"+l,position:{epoch:s,cartographicRadians:o.map(function(i,r){return t===ol.geom.GeometryLayout.XYZM?[new Date(e[r][3]).toISOString(),i.longitude,i.latitude,i.height]:t===ol.geom.GeometryLayout.XYM?[new Date(e[r][2]).toISOString(),i.longitude,i.latitude,i.height]:[new Date(i.time).toISOString(),i.longitude,i.latitude,i.height]}).reduce(function(e,t){return e.concat(t)})},point:{heightReference:"CLAMP_TO_GROUND",pixelSize:r.radius,color:{rgba:r.fillColor},outlineColor:{rgba:r.strokeColor},outlineWidth:r.strokeWidth}}];n({czml:m,totalDistance:c,coordinates2D:e})})})}.call(this,i.geometry,i.wrap.feature.getGeometry().layout,"track",t.markerStyle,t.lineStyle,t.walkingSpeed).then(function(t){var r=t.czml,n=t.totalDistance,a=t.coordinates2D;this.view3D.trackDataSource=new Cesium.DataSourceCollection;var o=new Cesium.DataSourceDisplay({scene:this.viewer.scene,dataSourceCollection:this.view3D.trackDataSource});this.viewer.scene.preRender.addEventListener(function(e,t){o.update(t)});this.view3D.trackDataSource.add(Cesium.CzmlDataSource.load(r)).then(function(t,i,r){this.viewer.clock.shouldAnimate=!1;var a,o;a=r.clock.startTime;o=r.clock.stopTime;this.viewer.clock.startTime=a.clone();this.viewer.clock.stopTime=o.clone();this.viewer.clock.currentTime=a.clone();this.viewer.clock.clockStep=Cesium.ClockStep.TICK_DEPENDENT;this.viewer.clock.clockRange=Cesium.ClockRange.CLAMPED;this.viewer.clock.multiplier=1;var s=r.entities.values[0];s.layout=t;s.tagLI=e;s.availability=new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({start:a,stop:o})]);if(this.viewer.trackedEntity){this.viewer.entities.removeById(this.viewer.trackedEntity.id);this.viewer.trackedEntity=null}this.viewer.entities.add(s);this.viewer.flyTo(s).then(function(){this.viewer.trackedEntity=s;function e(e,t){for(var i,r=0,n=this.view3D.view2DCRS!==this.view3D.crs?TC.Util.reproject(e[0],this.view3D.view2DCRS,this.view3D.crs):e[0],a=new Cesium.Cartographic.fromDegrees(n[0],n[1]),o=1;o<e.length;o++){n=this.view3D.view2DCRS!==this.view3D.crs?TC.Util.reproject(e[o],this.view3D.view2DCRS,this.view3D.crs):e[o];var l=new Cesium.Cartographic.fromDegrees(n[0],n[1]);r+=new Cesium.EllipsoidGeodesic(a,l).surfaceDistance;a=l;if(r>t){i=e[o-1];break}}if(i){var c=s.layout===ol.geom.GeometryLayout.XYZM?2:s.layout===ol.geom.GeometryLayout.XYZ?2:-1;if(c>-1)return i[c]}return 0}var t,r=0;c=this.viewer.scene.preUpdate.addEventListener(function(a,o){const l=this.view3D.linked2DControls.geolocation.getSelectedTrack();if(!l||l.getAttribute("data-id")!==s.tagLI.getAttribute("data-id")||Cesium.JulianDate.greaterThanOrEquals(o,s.availability.stop)){c();d.call(this,{target:{className:"stop"},custom:!0})}else if(this.viewer.clock.shouldAnimate&&s.isAvailable(o)){t||(t=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(s.position,s.availability.start)));currentPosition=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(s.position,o));if(this.view3D.linked2DControls.geolocation.hasElevation){s.layout===ol.geom.GeometryLayout.XYZM||(s.layout,ol.geom.GeometryLayout.XYM);this.view3D.linked2DControls.geolocation.chartSetProgress({p:[t.longitude,t.latitude,t.height],d:r},[currentPosition.longitude,currentPosition.latitude,e.call(this,i,r)],n,(s.layout===ol.geom.GeometryLayout.XYZM||s.layout===ol.geom.GeometryLayout.XYM)&&this.view3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(s.availability.start),Cesium.JulianDate.toDate(o)))}r+=new Cesium.EllipsoidGeodesic(t,currentPosition).surfaceDistance;t=currentPosition;this.viewer.scene.requestRender()}}.bind(this));this.viewer.clock.shouldAnimate=!0}.bind(this));this.viewer.scene.requestRender()}.bind(this,i.wrap.feature.getGeometry().layout,a))}.bind(this))}}.bind(this))}.bind(t);a._wrap_simulateTrack=TC.wrap.control.Geolocation.prototype.simulateTrack;TC.wrap.control.Geolocation.prototype.simulateTrack=function(){};a._wrap_showElevationMarker=TC.wrap.control.Geolocation.prototype.showElevationMarker;TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){const t=this.view3D.linked2DControls.geolocation,i=t.elevationChartData.coords;if(t.layerTrack.getVisibility()&&t.layerTrack.getOpacity()>0){var r=this.viewer.camera,n=this.view3D.view2DCRS!==this.view3D.crs?TC.Util.reproject(i[e[0].index],this.view3D.view2DCRS,this.view3D.crs):i[e[0].index];if(t.elevationMarker){t.elevationMarker.position=Cesium.Cartesian3.fromDegrees(n[0],n[1],r.positionCartographic.height);this.viewer.scene.requestRender()}else{var a=new Cesium.Entity({position:Cesium.Cartesian3.fromDegrees(n[0],n[1]),name:"elevationMarker",billboard:{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==",eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});t.elevationMarker=this.view3D.addNativeFeature.call(this,a)}}}.bind(t);a._wrap_hideElevationMarker=TC.wrap.control.Geolocation.prototype.hideElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){const e=this.view3D.linked2DControls.geolocation;this.view3D.removeFeature.call(this,e.elevationMarker);e.elevationMarker=null}.bind(t)}else{const e=t.view3D.linked2DControls.geolocation.getSelectedTrack();e&&t.view3D.linked2DControls.geolocation.hasElevation&&a._elevationTrack.call(t.view3D.linked2DControls.geolocation,e,!0)}}};var C,g,y;const T=function(e){var t=this,i=function(e){var t=new Cesium.Cartesian2(this.viewer.scene.canvas.clientWidth/2,this.viewer.scene.canvas.clientHeight/2);this.view3D.zoomToCartesian.call(this,{endPosition:t},e)};if(e){C=function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=this.view3D.view2DCRS;this.map.options.crs!==this.view3D.view2DCRS&&(t=this.map.options.crs);var i=TC.Util.reproject(this.map.options.initialExtent.slice(0,2),t,this.view3D.crs),r=TC.Util.reproject(this.map.options.initialExtent.slice(2),t,this.view3D.crs),n=Cesium.Rectangle.fromDegrees(i[0],i[1],r[0],r[1]);this.view3D.flyToRectangle.call(this,n,{duration:.1});return!1}.bind(t);g=function(e){i.call(t,200)}.bind(t);y=function(e){i.call(t,-200)}.bind(t);document.querySelectorAll("."+TC.control.NavBarHome.prototype.CLASS+"-btn").forEach(function(e){e.addEventListener("click",C)});document.querySelectorAll("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").forEach(function(e){e.addEventListener("click",g)});document.querySelectorAll("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").forEach(function(e){e.addEventListener("click",y)})}else{document.querySelectorAll("."+TC.control.NavBarHome.prototype.CLASS+"-btn").forEach(function(e){e.removeEventListener("click",C)});document.querySelectorAll("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").forEach(function(e){e.removeEventListener("click",g)});document.querySelectorAll("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").forEach(function(e){e.removeEventListener("click",y)})}};return{container:null,crs:"EPSG:4326",crsPattern:/(EPSG\:?4326)/i,view2DCRS:null,customRender:null,baseLayer:null,workLayers:[],vector2DLayers:[],vector2DFeatures:{},linked2DControls:{},isLoadingTiles:function(){var e=this.viewer.scene.globe._surface;return!e._tileProvider.ready||e._tileLoadQueueHigh.length>0||e._tileLoadQueueMedium.length>0||e._tileLoadQueueLow.length>0||e._debug.tilesWaitingForChildren>0},loadViewer:function(){const e=this;return new Promise(function(t,i){e.viewer?t(e.viewer):TC.loadJS(!window.Cesium,TC.Consts.url.CESIUM,function(){var i=Cesium.Resource.fetchJson({url:TC.apiLocation+"/dataSource/contornoNavarra.json"}).then(function(e){return e&&e.features&&e.features.length>0?e.features[0].geometry.coordinates[0]:[]});Cesium.when.all([Cesium.ApproximateTerrainHeights.initialize(),i],function(){var i,r,n=Array.prototype.slice.call(arguments[0])[1];e.terrainFallback&&(i={url:e.terrainFallback.url.trim(),layerName:e.terrainFallback.layerName,format:e.terrainFallback.format,noDataValue:e.terrainFallback.noDataValue});if(i)r=new Cesium.MergeTerrainProvider(e.terrain,e,{boundaries:n,fallback:[i]});else{(r=new Cesium.CesiumTerrainProvider({url:e.terrain.url.trim()})).sampleTerrainMostDetailed=function(e){return Cesium.sampleTerrainMostDetailed(r,e)};r.attributions={};if(e.terrain.attributions){r.getAttribution=function(){return r.attributions};r.attributions=e.terrain.attributions;e.map.trigger(TC.Consts.event.TERRAINPROVIDERADD,{terrainProvider:r})}}var a=new Cesium.Globe;a.baseColor=Cesium.Color.WHITE;a.enableLighting=!1;a.tileCacheSize=1e3;a.maximumScreenSpaceError=5;e.viewer=e.view3D.viewer=new Cesium.Viewer(e.selectors.divThreedMap,{terrainProvider:r,terrainExaggeration:1,animation:!1,timeline:!1,fullscreenButton:!1,baseLayerPicker:!1,imageryProvider:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,globe:a,skyBox:!1,skyAtmosphere:!1,requestRenderMode:!0,maximumRenderTimeChange:1/0});e.viewer.scene.backgroundColor=Cesium.Color.WHITE;e.viewer.scene.screenSpaceCameraController.enableCollisionDetection=!0;e.viewer.scene.screenSpaceCameraController.maximumZoomDistance=1e6;e.viewer.scene.imageryLayers.removeAll();e.viewer.terrainProvider.errorEvent.addEventListener(function(e){if(e.error)switch(e.error.statusCode){case 403:case 404:console.log("es un 404 de terreno")}},e);e.viewer.scene.renderError.addEventListener(function(e,t){if(t&&18===t.code);else{this.divThreedMap.classList.remove(this.classes.LOADING);this.map.toast(this.getLocaleString("fi.error"),{type:TC.Consts.msgType.ERROR});this.unapply()}},e);e.viewer.readyPromise=new Promise(function(t,i){e.view3D.tileLoadingHandler=new Cesium.EventHelper;e.view3D.tileLoadingHandler.add(e.viewer.scene.globe.tileLoadProgressEvent,function(i){e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());if((e.viewer.scene.terrainProvider.allReady||!e.viewer.scene.terrainProvider.allReady&&e.viewer.scene.terrainProvider.ready)&&0===i){e.map.getLoadingIndicator().removeWait(e.waiting);delete e.waiting;t();e.events.trigger(TC.Consts.event.TERRAINLOADED,{})}else e.events.trigger(TC.Consts.event.TERRAINRECEIVING,{})}.bind(e))});T.call(e,!0);document.querySelectorAll(".cesium-viewer-bottom").forEach(function(e){e.parentElement.removeChild(e)});e.view3D._event2DHandler=function(e){var t=this;switch(!0){case e.type==TC.Consts.event.BEFOREBASELAYERCHANGE:t.waiting||(t.waiting=t.map.getLoadingIndicator().addWait());break;case e.type==TC.Consts.event.BASELAYERCHANGE:t.view3D.setBaseLayer.call(t,e.layer);break;case e.type==TC.Consts.event.LAYERADD:t.view3D.addLayer.call(t,e.layer);break;case e.type==TC.Consts.event.LAYERREMOVE:t.view3D.removeLayer.call(t,e.layer);break;case e.type==TC.Consts.event.LAYERVISIBILITY:t.view3D.setRenderOptionsLayer.call(t,e.layer,{visibility:e.layer.getVisibility()});break;case e.type==TC.Consts.event.LAYEROPACITY:t.view3D.setRenderOptionsLayer.call(t,e.layer,{opacity:e.layer.getOpacity()});t.viewer.scene.requestRender();break;case e.type==TC.Consts.event.LAYERORDER:for(var i=0;i<t.view3D.workLayers.length;i++)if(t.view3D.workLayers[i].imageryProvider&&t.view3D.workLayers[i].imageryProvider.layers.join(",")===e.layer.names.join(",")){if(e.oldIndex>e.newIndex)for(var r=e.oldIndex-e.newIndex,n=0;n<r;n++)t.viewer.scene.imageryLayers.lower(t.view3D.workLayers[i]);else for(var r=e.newIndex-e.oldIndex,n=0;n<r;n++)t.viewer.scene.imageryLayers.raise(t.view3D.workLayers[i]);t.view3D.workLayers.splice(e.newIndex,0,t.view3D.workLayers.splice(e.oldIndex,1)[0]);break}break;case e.type==TC.Consts.event.FEATUREADD:t.view3D.addFeature.call(t.view3D,e.feature);break;case e.type==TC.Consts.event.FEATUREREMOVE:if(t.view3D.vector2DFeatures&&t.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)){const i=function(i){if(t.view3D.vector2DFeatures[e.layer.id].hasOwnProperty(i.id)){for(var r=t.view3D.vector2DFeatures[e.layer.id][i.id],n=0;n<r.length;n++)t.view3D.removeFeature.call(t,r[n]);delete t.view3D.vector2DFeatures[e.layer.id][i.id]}};e.feature instanceof Array?e.feature.forEach(i):i(e.feature)}break;case e.type==TC.Consts.event.FEATURESCLEAR:if(t.view3D.vector2DFeatures&&t.view3D.vector2DFeatures.hasOwnProperty(e.layer.id))for(var a in t.view3D.vector2DFeatures[e.layer.id]){for(var o=t.view3D.vector2DFeatures[e.layer.id][a],i=0;i<o.length;i++)t.view3D.removeFeature.call(t,o[i]);delete t.view3D.vector2DFeatures[e.layer.id][a]}break;case e.type==TC.Consts.event.ZOOM:if(t.view3D.cameraControls&&!t.view3D.cameraControls.moving){var s=t.view3D.viewer.scene.canvas.clientWidth,l=t.view3D.viewer.scene.canvas.clientHeight;if(!t.view3D._canvasClientHeight||!t.view3D._canvasClientWidth||s!==t.view3D._canvasClientWidth||l!==t.view3D._canvasClientHeight){t.view3D._canvasClientWidth||(t.view3D._canvasClientWidth=t.view3D.viewer.scene.canvas.clientWidth);t.view3D._canvasClientHeight||(t.view3D._canvasClientHeight=t.view3D.viewer.scene.canvas.clientHeight);t.view3D._canvasClientWidth=s;t.view3D._canvasClientHeight=l;return}t.view3D.flyToMapCoordinates.call(t,t.mapView.getCenter())}break;case e.type==TC.Consts.event.ZOOMTO:if(t.lastZoom&&performance.now()-t.lastZoom<50)return;t.lastZoom=performance.now();var c=t.view3D.view2DCRS!==t.view3D.crs?TC.Util.reproject(e.extent.slice(0,2),t.view3D.view2DCRS,t.view3D.crs):e.extent.slice(0,2),u=t.view3D.view2DCRS!==t.view3D.crs?TC.Util.reproject(e.extent.slice(2),t.view3D.view2DCRS,t.view3D.crs):e.extent.slice(2),v=Cesium.Rectangle.fromDegrees(c[0],c[1],u[0],u[1]);t.view3D.flyToRectangle.call(t,v)}}.bind(e);e.map.on(l.join(" "),e.view3D._event2DHandler);m.call(e,TC.Consts.view.THREED);e.viewer.readyPromise.then(function(){(function(){var e=this;e.map.workLayers.filter(function(e){return e instanceof TC.layer.Vector}).forEach(function(t){t.features.forEach(function(t){e.view3D.addFeature.call(e.view3D,t)})})}).call(e)});t(e.viewer)})})})},setBaseLayer:function(e){var t=this,r=function(e){if(!i(e,t.view3D.crs))if(null!==e.getFallbackLayer()&&i(e.getFallbackLayer(),t.view3D.crs))e=e.getFallbackLayer();else{t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.title}));e=null}return e};if(t.view3D.baseLayer){if(t.viewer.scene.imageryLayers.contains(t.view3D.baseLayer)){t.viewer.scene.imageryLayers.raiseToTop(t.view3D.baseLayer);t.viewer.scene.imageryLayers.remove(t.view3D.baseLayer,!0)}if(e instanceof TC.layer.Vector){t.view3D.baseLayer=t.Consts.BLANK_BASE;t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting}else if(e=r(e)){e.map=t.map;e.isBase=!0;t.view3D.addLayer.call(t,e)}}else if(e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS){if(e.options.relatedWMTS){t.map.baseLayer=e=t.map.getLayer(e.options.relatedWMTS);t.map.trigger(TC.Consts.event.BASELAYERCHANGE,{layer:t.map.baseLayer})}else if(e=r(e)){e.isBase||(e.isBase=!0);t.view3D.addLayer.call(t,e)}}else t.view3D.baseLayer=t.Consts.BLANK_BASE;w.baseMap=t.map.baseLayer},addLayer:function(e){var i=this;switch(!0){case TC.Consts.layerType.VECTOR==e.type:i.view3D.vector2DLayers.push(e);break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:e.isBase||e.isCompatible(i.view3D.crs)?t.convert(e,i.view3D.crs).then(function(t){if(t){if(void 0!==t.enablePickFeatures){t.enablePickFeatures=!1;t.tcLayer=e}if(e.isBase&&i.view3D.baseLayer&&i.viewer.scene.imageryLayers.contains(i.view3D.baseLayer)){i.viewer.scene.imageryLayers.raiseToTop(i.view3D.baseLayer);i.viewer.scene.imageryLayers.remove(i.view3D.baseLayer,!0)}var r=i.viewer.scene.imageryLayers.addImageryProvider(t);if(e.isBase){i.view3D.baseLayer=r;i.viewer.scene.imageryLayers.lowerToBottom(r)}else{r.show=e.getVisibility();r.alpha=e.getOpacity();i.view3D.workLayers.push(r)}}}):i.map.toast(i.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}))}},removeLayer:function(e){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.view3D.vector2DFeatures&&this.view3D.vector2DFeatures.hasOwnProperty(e.id)){for(var t in this.view3D.vector2DFeatures[e.id])for(var i=this.view3D.vector2DFeatures[e.id][t],r=0;r<i.length;r++)this.view3D.removeFeature.call(this,i[r]);delete this.view3D.vector2DFeatures[e.id]}break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(var r=0;r<this.view3D.workLayers.length;r++)if(e.names&&this.view3D.workLayers[r].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.view3D.workLayers[r].imageryProvider.layers.join(",")===e.title){this.viewer.scene.imageryLayers.raiseToTop(this.view3D.workLayers[r]);this.viewer.scene.imageryLayers.remove(this.view3D.workLayers[r],!0);this.view3D.workLayers.splice(r,1);break}}},setRenderOptionsLayer:function(e,t){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.view3D.vector2DFeatures[e.id]){for(var i in this.view3D.vector2DFeatures[e.id])for(var r=this.view3D.vector2DFeatures[e.id][i],n=0;n<r.length;n++)this.view3D.setRenderOptionsFeature(r[n],{show:e.getVisibility()});this.viewer.scene.requestRender()}break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(var n=0;n<this.view3D.workLayers.length;n++)if(e.names&&this.view3D.workLayers[n].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.view3D.workLayers[n].imageryProvider.layers.join(",")===e.title){t.hasOwnProperty("visibility")&&(this.view3D.workLayers[n].show=t.visibility);t.hasOwnProperty("opacity")&&(this.view3D.workLayers[n].alpha=t.opacity);break}this.viewer.scene.requestRender()}},flyToMapCoordinates:function(e){var t=this.view3D.view2DCRS!==this.view3D.crs?TC.Util.reproject(e,this.view3D.view2DCRS,this.view3D.crs):e,i=Cesium.Cartesian3.fromDegrees(t[0],t[1],this.viewer.camera.positionCartographic.height),r=this.viewer.camera;r.flyTo({destination:i,orientation:{heading:r.heading,pitch:r.pitch}})}.bind(e),flyToRectangle:function(e,t){const i=this;i.viewer.scene.camera.cancelFlight();return new Promise(function(r,n){t=t||{};var a=Cesium.Math.EPSILON3;if(e.east===e.west){e.east+=a;e.west-=a}if(e.north===e.south){e.north+=a;e.south-=a}var o=.2*e.width/2,s=.2*e.height/2;e.east-=o;e.west+=s;e.north+=s;e.south-=s;var l=i.viewer.scene,c=l.camera,v=c.getRectangleCameraCoordinates(e),d=Cesium.Ellipsoid.WGS84.cartesianToCartographic(v);Cesium.when(l.globe.terrainProvider.sampleTerrainMostDetailed([Cesium.Rectangle.center(e)]),function(e){var n={longitude:d.longitude,latitude:d.latitude,height:d.height+e[0].height||0};c.flyTo({duration:t.duration||1,destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(n),complete:function(){var e=Cesium.Math.toRadians(50),t=u(this.viewer.scene);t=Cesium.Matrix4.fromTranslation(t);this.view3D.rotateAroundAxis(this.viewer.scene.camera,-e,this.viewer.scene.camera.right,t,{duration:250,callback:function(){r()}})}.bind(i)})})})}.bind(e),zoomToCartesian:function(e,t){var i=this,r=i.viewer.scene;if(!e||!e.endPosition){var n=r.canvas,a=new Cesium.Cartesian2(n.clientWidth/2,n.clientHeight/2);e={endPosition:a}}var o=r.camera.getPickRay(e.endPosition),s=r.globe.pick(o,r);if(s){var l=Cesium.Cartesian3.distance(o.origin,s);if(l<1)return;i.view3D._zoomTo||(i.view3D._zoomTo={amount:0});i.view3D._zoomTo.direction=t>0?1:0;i.view3D._zoomTo.amount+=5*l/100;i.view3D._zoomTo.endPosition=e.endPosition}setTimeout(function(){(function(t){var i=this.viewer.scene,r=i.camera.getPickRay(e.endPosition||t.endPosition),n=i.globe.pick(r,i);if(n){var a=Cesium.Cartesian3.distance(r.origin,n);if(a<1)return;var o=i.camera.position,s=(i.camera.direction,toGo=new Cesium.Cartesian3);Cesium.Cartesian3.multiplyByScalar(r.direction,1==t.direction?t.amount:-t.amount,s);Cesium.Cartesian3.add(o,s,toGo);var l=new Cesium.Ray(toGo,r.direction),c=i.globe.pick(l,i);c&&(Cesium.Cartesian3.distance(toGo,c)<1||Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height)<i.screenSpaceCameraController.minimumZoomDistance?function(){this.view3D._zoomTo={direction:1,amount:0,endPosition:{}}}.call(this):this.viewer.camera.flyTo({destination:toGo,orientation:{heading:i.camera.heading,pitch:i.camera.pitch,roll:i.camera.roll},duration:1,easingFunction:Cesium.EasingFunction.LINEAR_NONE,complete:function(e){this.view3D._zoomTo={direction:1,amount:0,endPosition:{}}}.bind(this,Cesium.Cartesian3.distance(toGo,c))}))}}).call(i,i.view3D._zoomTo)}.bind(i),50)},rotateAroundAxis:function(e,t,i,r,n){return s(e,t,i,r,n)},addFeature:function(e,t){var i=this,o=function(){var t=r.convert(i.viewer.scene,e,i.view2DCRS,i.crs);if(t)if("function"==typeof t.geometry)t.geometry(i.viewer.terrainProvider).then(function(t){if(t instanceof Array)t.forEach(function(t){if(t instanceof Array)t.forEach(function(t){t=n.call(i,t);a(i,e.layer.id,t,e.id)});else{t=n.call(i,t);a(i,e.layer.id,t,e.id)}});else{var r=n.call(i,t);a(i,e.layer.id,r,e.id)}});else if(t.geometry instanceof Array)t.geometry.forEach(function(t){t=n.call(i,t);a(i,e.layer.id,t,e.id)});else{var o=n.call(i,t.geometry);a(i,e.layer.id,o,e.id)}};if(i.linked2DControls.featureInfo&&i.linked2DControls.featureInfo.get2DMarker()===e||i.linked2DControls.featureInfo&&i.linked2DControls.featureInfo.isPending())setTimeout(function(){i.linked2DControls.featureInfo.get2DMarker()!==e&&o()},5);else{if(i.linked2DControls.geolocation&&i.linked2DControls.geolocation.layerTracking===e.layer&&e instanceof TC.feature.Polyline)return;o()}},removeFeature:function(e){if(this.viewer&&e){switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.remove(e);break;case e instanceof Cesium.Billboard:this.viewer.billboardCollection.remove(e);break;case e instanceof Object:this.viewer.entities.removeById(e.id)}this.viewer.scene.requestRender()}},setRenderOptionsFeature:function(e,t){e&&(e.show=t.show)},addNativeFeature:function(e){return n.call(this.view3D,e)},setCameraFromMapView:function(){var e=this;e.viewer.scene.globe.terrainProvider.readyPromise.then(function(){var t=e.mapView.getCenter();if(t){var i=e.view3D.view2DCRS!==e.view3D.crs?TC.Util.reproject(t,e.view3D.view2DCRS,e.view3D.crs):t,r=function(e,t){var i=this.viewer.camera.frustum.fovy,r=e*this.mapView.viewHTML.getBoundingClientRect().height,n=Math.cos(Math.abs(t));return r*this.mapView.metersPerUnit*n/2/Math.tan(i/2)}.call(e,e.mapView.getResolution()||0,Cesium.Math.toRadians(i[0])),i=e.view3D.view2DCRS!==e.view3D.crs?TC.Util.reproject(t,e.view3D.view2DCRS,e.view3D.crs):t,n=new Cesium.Cartographic(Cesium.Math.toRadians(i[0]),Cesium.Math.toRadians(i[1]));e.viewer.scene.globe&&(n.height=e.viewer.scene.globe.getHeight(n)||0);var a=function(){if(e.map.on3DView){var t=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n),i={pitch:Cesium.Math.toRadians(-90),heading:-e.mapView.getRotation(),roll:0};e.viewer.camera.setView({destination:t,orientation:i});e.viewer.camera.moveBackward(r)}};0===n.height?TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){e.view3D.elevationTool=new TC.tool.Elevation;e.view3D.elevationTool.getElevation({crs:e.view3D.crs,coordinates:[i]}).then(function(e){if(e&&e.length>0){n.height=e[0][2]?e[0][2]:0;a()}}).catch(e=>console.log(e))}):a()}})},setViewFromCameraView:function(){const e=this;var t=Cesium.Ellipsoid.WGS84,i=e.viewer.scene;target_=c(i);if(!target_){var r=e.viewer.scene.globe,n=e.viewer.camera.positionCartographic.clone(),a=r.getHeight(n);n.height=a||0;target_=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)}var s=Cesium.Cartesian3.distance(target_,e.viewer.camera.position),l=t.cartesianToCartographic(target_),u=e.view3D.crs!==e.view3D.view2DCRS?TC.Util.reproject([Cesium.Math.toDegrees(l.longitude),Cesium.Math.toDegrees(l.latitude)],e.view3D.crs,e.view3D.view2DCRS):[Cesium.Math.toDegrees(l.longitude),Cesium.Math.toDegrees(l.latitude)];e.mapView.setCenter(u);e.mapView.setResolution(o.call(e,s,l?l.latitude:0));return Promise.resolve()},lookAt:function(e){const t=this;t.crs!==t.view2DCRS&&(e=TC.Util.reproject(e,t.view2DCRS,t.crs));var i=t.viewer.camera,r=i.positionCartographic,n=r.height,a=new Cesium.Cartographic(Cesium.Math.toRadians(e[0]),Cesium.Math.toRadians(e[1]),n);i.flyTo({destination:Cesium.Cartesian3.fromRadians(a.longitude,a.latitude,a.height),duration:1})},getInfoOnPickedPosition:function(e){var t=this;if(e){t.map.one(TC.Consts.event.DRAWTABLE,function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting});t.view3D.linked2DControls.featureInfo.send.call(t,e).then(function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting})}},on:function(e,t){const i=this;i.eventHandlers||(i.eventHandlers={});i.eventHandlers.handlerOfMovementConversion=new Cesium.ScreenSpaceEventHandler(i.viewer.scene.canvas);i.eventHandlers.handlerOfMovementConversion.setInputAction(function(e){if(e.endPosition||e.position){if(i.viewer.trackedEntity)return;t(function(e){if(i.viewer&&i.viewer.cesiumWidget){var t=i.viewer.camera.getPickRay(e.endPosition||e.position),r=i.viewer.scene.globe.pick(t,i.viewer.scene);if(r){var n,a,o,s=Cesium.Ellipsoid.WGS84.cartesianToCartographic(r);n=Cesium.Math.toDegrees(s.latitude);a=Cesium.Math.toDegrees(s.longitude);o=Math.round(s.height);return{lon:a,lat:n,ele:o}}}return null}(e))}else t(e)},(r=e,TC.Consts.event.MOUSEMOVE===r?TC.Util.detectMobile()?Cesium.ScreenSpaceEventType.LEFT_CLICK:Cesium.ScreenSpaceEventType.MOUSE_MOVE:TC.Consts.event.CLICK===r?Cesium.ScreenSpaceEventType.LEFT_CLICK:r));var r},getHeightFromMDT:function(e){var t=new Cesium.Cartographic(Cesium.Math.toRadians(e[0]),Cesium.Math.toRadians(e[1]));return this.viewer.scene.globe.getHeight(t)||0},destroy:function(){var e=this;e.map.on3DView=!1;e.view3D.vector2DLayers=[];e.view3D.vector2DFeatures={};e.map.off(l.join(" "),e.view3D._event2DHandler);m.call(e,TC.Consts.view.DEFAULT);T.call(e,!1);Promise.all(e.map.baseLayers.map(function(t){return Promise.resolve(!i(t,e.view3D.view2DCRS))})).then(function(t){if(t.length>0){for(var i,r=0;r<e.map.baseLayers.length;r++){i||t[r]||(i=e.map.baseLayers[r]);e.map.baseLayers[r].mustReproject=t[r]}var n=!0;const o=function(t,i,r){const a={layer:i};r&&(a.fallbackLayer=r);var o=e.map.getControlsByClass(t?TC.control.BasemapSelector:TC.control.Coordinates);if(o.length>0){o[0]instanceof TC.control.Coordinates&&(n=!1);a.closeCallback=function(){e.map.trigger(TC.Consts.event.VIEWCHANGE,{view:TC.Consts.view.DEFAULT})};o[0].showProjectionChangeDialog(a)}};var a=w.baseMap==e.Consts.BLANK_BASE?w.baseVector:w.baseMap;if(a.isCompatible(e.map.getCRS()))e.map.setBaseLayer(a);else if(a.fallbackLayer){a.getFallbackLayer();a.getFallbackLayer().isCompatible(e.map.getCRS())?TC.confirm(e.getLocaleString("threed.changeBaselayer"),function(){o(!1,a,a.fallbackLayer)},function(){e.map.setBaseLayer(a.fallbackLayer)}):o(!0,a)}else o(!0,a)}w.baseMap="";e.view3D.baseLayer=null;e.view3D.workLayers=[];e.view3D.cameraControls.unbind();e.view3D.linked2DControls.featureInfo&&e.view3D.linked2DControls.featureInfo.reset();if(e.view3D.linked2DControls.geolocation){e.view3D.linked2DControls.geolocation.isGeo=!1;e.view3D.linked2DControls.geolocation.reset()}e.view3D.tileLoadingHandler.removeAll();delete e.view3D.tileLoadingHandler;e.viewer.destroy();e.viewer=null;n&&e.map.trigger(TC.Consts.event.VIEWCHANGE,{view:TC.Consts.view.DEFAULT})})}}}();return{init:e.init.bind(e),apply:e.apply.bind(e),unapply:e.unapply.bind(e),VIEWNAME:e.VIEWNAME}}();
//# sourceMappingURL=../maps/view/ThreeD.min.js.map