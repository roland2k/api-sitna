TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");!function(){var e={};TC.layer.Vector=function(){var e=this;e._capabilitiesPromise=null;e.capabilities=null;TC.Layer.apply(e,arguments);e.type=e.options.type||TC.Consts.layerType.VECTOR;e.features=[];e.selectedFeatures=[];const t=function(e){var t=(e=e||"").indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return e.substr(e.lastIndexOf(".")).toLowerCase()}(e.url),i=function(e){switch(e){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(e.options.format)||function(e){switch(e){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(t);if(i||e.type===TC.Consts.layerType.KML){i===TC.Consts.format.KML&&(e.type=TC.Consts.layerType.KML);e.title=e.options.title||function(e){for(var i=e=e||"",n=new RegExp("([^/]+"+t+")","i"),r=0;r<3;r++){e=decodeURIComponent(e);var o=n.exec(e);if(o.length>1){i=o[1];break}}return i}(e.url)}e.wrap=new TC.wrap.layer.Vector(e);e.wrap._promise=new Promise((t,i)=>{var n;n=e.wrap.createVectorLayer();e.wrap.setLayer(n);t(n)})};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var t=TC.layer.Vector.prototype;t.getTree=function(){const e=this;var t=null;if(!e.options.stealth){(t={}).children=[];for(var i=0;i<e.features.length;i++){var n=e.features[i].getPath();if(n.length){var r=TC.Util.addArrayToTree(n,t);r&&(r.legend=e.features[i].getLegend())}}if(e.styles){const i=Object.keys(e.styles).length>1,n=e.map?e.map.options.locale:null;if(e.styles.point){(i?TC.Util.addArrayToTree([TC.Util.getLocaleString(n,"points")],t):t).legend={src:TC.Util.getLegendImageFromStyle(e.styles.point,{geometryType:TC.Consts.geom.POINT})}}if(e.styles.line){(i?TC.Util.addArrayToTree([TC.Util.getLocaleString(n,"lines")],t):t).legend={src:TC.Util.getLegendImageFromStyle(e.styles.line,{geometryType:TC.Consts.geom.POLYLINE})}}if(e.styles.polygon){(i?TC.Util.addArrayToTree([TC.Util.getLocaleString(n,"polygons")],t):t).legend={src:TC.Util.getLegendImageFromStyle(e.styles.polygon,{geometryType:TC.Consts.geom.POLYGON})}}}t.name=e.name||t.name;t.customLegend=e.options.customLegend;t.title=e.title||t.title;t.uid=e.id}return t};var i=function(e,t,i,n){return new Promise(function(r,o){t.call(e,[i],n).then(function(t){r(t[0]);e.map&&e.map.trigger(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]})})})},n=function(e,t,i,n,r){var o=TC.Util.extend(!0,{},r);return new Promise(function(s,a){var l;const c=function(){l=l||TC.feature[i];for(var a=new Array(t.length),c=[],u=0,C=t.length;u<C;u++){var f,p=t[u];const s=TC.wrap.Feature.prototype.isNative(p);if(p instanceof l||"TC.feature."+i===p.CLASSNAME)f=p;else{s&&(f=p._wrap&&p._wrap.parent);if(!f){o.layer=e;const t=e.styles&&e.styles[n];!TC.Util.hasStyleOptions(o)&&t||TC.Util.extend(!0,o,TC.Cfg.styles[n],t||{},r);f=new l(p,o)}}f.layer=e;a[u]=f;e.features.push(f);s||c.push(f.wrap.feature);f.options.showPopup&&f.showPopup()}c.length&&e.wrap.addFeatures(c);s(a)};if(i)TC.loadJS(!TC.feature||TC.feature&&!TC.feature[i],[TC.apiLocation+"TC/feature/"+i],c);else{l=TC.Feature;c()}})};t.addPoint=function(e,t){return i(this,this.addPoints,e,t)};t.addPoints=function(e,t){return n(this,e,"Point",TC.Consts.geom.POINT,t)};t.addMarker=function(e,t){return i(this,this.addMarkers,e,t)};t.addMarkers=function(e,t){return n(this,e,"Marker","marker",t)};t.addPolyline=function(e,t){return i(this,this.addPolylines,e,t)};t.addPolylines=function(e,t){return n(this,e,"Polyline","line",t)};t.addMultiPolyline=function(e,t){return i(this,this.addMultiPolylines,e,t)};t.addMultiPolylines=function(e,t){return n(this,e,"MultiPolyline","line",t)};t.addPolygon=function(e,t){return i(this,this.addPolygons,e,t)};t.addPolygons=function(e,t){return n(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};t.addMultiPolygon=function(e,t){return i(this,this.addMultiPolygons,e,t)};t.addMultiPolygons=function(e,t){return n(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};t.addCircle=function(e,t){return i(this,this.addCircles,e,t)};t.addCircles=function(e,t){return n(this,e,"Circle",TC.Consts.geom.POLYGON,t)};t.addFeature=function(e){const t=this;var i;TC.feature&&(i=TC.feature.Point&&e instanceof TC.feature.Point||"TC.feature.Point"===e.CLASSNAME?t.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline||"TC.feature.Polyline"===e.CLASSNAME?t.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon||"TC.feature.Polygon"===e.CLASSNAME?t.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||"TC.feature.MultiPolygon"===e.CLASSNAME?t.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline||"TC.feature.MultiPolyline"===e.CLASSNAME?t.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle||"TC.feature.Circle"===e.CLASSNAME?t.addCircle(e):n(t,[e]));return i};t.addFeatures=function(e){return n(this,e)};t.removeFeature=function(e){const t=this;if(e.layer&&t.features.indexOf(e)>=0){if(t.map){const i=t=>t.currentFeature===e&&t.isVisible();t.map.getControlsByClass("TC.control.Popup").filter(i).forEach(e=>e.hide());t.map.getControlsByClass("TC.control.ResultsPanel").filter(i).forEach(e=>e.close())}e.layer&&t.wrap.removeFeature(e);e.layer=null}};t.getFeatureById=function(e){let t=null;var i=this.wrap.getFeatureById(e);i&&(t=i._wrap.parent);return t};t.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};t.getDescribeFeatureTypeUrl=function(e){const t=this.options.version||this.capabilities.version||"1.1.0",i=Array.isArray(e)?e:[e];return this.url+"?service=WFS&version="+t+"&request=DescribeFeatureType&typename="+i.join(",")+"&outputFormat="+encodeURIComponent(this.capabilities.Operations.DescribeFeatureType.outputFormat)};t.describeFeatureType=function(e,t,i){const n=this;e||(e=n.options.featureType);const r=new Promise(function(t,i){n.getCapabilitiesPromise().then(function(r){if(r.Operations.DescribeFeatureType)if(window.hasOwnProperty("Worker")){var o={};const r=async function(){var e=TC.apiLocation+"TC/workers/tc-dft-web-worker.js";if(TC.Util.isSameOrigin(TC.apiLocation))return e;try{const i=(await TC.ajax({url:e,method:"GET",responseType:"text"})).data;var t=new Blob([i],{type:"text/javascript"});return window.URL.createObjectURL(t)}catch(e){throw e}},a=async function(){try{n.WebWorkerDFT||(n.WebWorkerDFT=new Worker(await r()));n.WebWorkerDFT.onmessage=async function(e){if(e.data instanceof Object){if("success"!==e.data.state)throw"Ha habido problemas procesando el Describe feature type";{let t=Object.keys(e.data.DFTCollection).join(",");if(!o.hasOwnProperty(t))throw"No se encuentra la clave "+t+" en la colecci\xf3n";o[t].call(null,e.data.DFTCollection);TC.describeFeatureType=Object.assign(TC.describeFeatureType,e.data.DFTCollection)}}else{var t=await n.toolProxification.fetchXML(e.data);n.WebWorkerDFT.postMessage({url:e.data,response:t.documentElement.outerHTML})}}}catch(e){throw e}},l=async function(e,t){var i=await n.toolProxification.fetchXML(n.getDescribeFeatureTypeUrl(e||n.featureType));if(i.querySelector("Exception")||i.querySelector("exception"))throw(i.querySelector("Exception")||i.querySelector("exception")).textContent.trim();n.WebWorkerDFT.postMessage({layerName:e,xml:i.documentElement.outerHTML,url:TC.apiLocation.indexOf("http")>=0?TC.apiLocation:document.location.protocol+TC.apiLocation});o[e instanceof Array?e.join(","):e]=t};try{a()}catch(e){i(e)}e instanceof Array||(e=e.split(","));var s=Object.entries(e.reduce(function(e,t){let i=t.substring(0,t.indexOf(":"));if(e[i]){e[i].push(t);return e}{let n={};n[i]=[t];return Object.assign(e,n)}},{})).map(function(e){var t=e[1];return new Promise(async function(e,i){if(TC.describeFeatureType[t])e(function(e,t){e instanceof Array||(e=e.split(","));return e.reduce(function(e,i){var n=[];n[i]=t[i];return Object.assign(e,n)},{})}(t,TC.describeFeatureType));else try{await l(t,function(t){e(t)})}catch(e){i(e)}})});Promise.all(s).then(function(e){let i=e.reduce(function(e,t){return Object.assign(e,t)},{});t(1===Object.keys(i).length?i[Object.keys(i)[0]]:i)}).catch(i)}else i("No esta disponible el WebWorker");else i("No esta disponible el m\xe9todo describeFeatureType")}).catch(e=>i(e))});r.then(function(e){TC.Util.isFunction(t)&&t(e)},function(e){TC.Util.isFunction(i)&&i(e)});return r};t.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.";t.import=function(e){this.wrap.import(e)};t.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.trigger(TC.Consts.event.BEFOREUPDATE);this.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:this});this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var i,n,r=!1;for(i=0;i<this.features.length;i++)if((n=this.features[i]).id==e){r=!0;n.setVisibility(t);break}if(!r)for(i=0;i<this.features.length;i++){void 0===(n=this.features[i])._path&&(n._path="/"+n.getPath().join("/"));n._path===e&&n.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:this});this.map.trigger(TC.Consts.event.UPDATE)};t.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var i=this._cache.visibilityStates[e];void 0!==i&&(t=i)}return t};t.setModifiable=function(e){this.wrap.setModifiable(e)};t.applyEdits=function(e,t,i){return this.wrap.sendTransaction(e,t,i)};t.refresh=function(){return this.wrap.reloadSource()};t.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};t.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};t.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:t});t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:t})}};t.setStyles=function(e){this.styles=TC.Util.extend({},e);this.wrap.setStyles(e)};t.exportState=function(e){const t=this;e=e||{};const i={id:t.id};t.map&&t.map.crs!==t.map.options.crs&&(i.crs=t.map.crs);var n=Math.pow(10,(t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);const r=e.features||t.features;i.features=r.map(function(i){const r={};var o;switch(!0){case TC.feature.Marker&&i instanceof TC.feature.Marker:r.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.marker;break;case TC.feature.Point&&i instanceof TC.feature.Point:r.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.point;break;case TC.feature.Polyline&&i instanceof TC.feature.Polyline:r.type=TC.Consts.geom.POLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.MultiPolyline&&i instanceof TC.feature.MultiPolyline:r.type=TC.Consts.geom.MULTIPOLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.Polygon&&i instanceof TC.feature.Polygon:r.type=TC.Consts.geom.POLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.MultiPolygon&&i instanceof TC.feature.MultiPolygon:r.type=TC.Consts.geom.MULTIPOLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.Circle&&i instanceof TC.feature.Circle:r.type=TC.Consts.geom.CIRCLE;o=t.options.styles&&t.options.styles.polygon}r.id=i.id;r.geom=TC.Util.compactGeometry(i.geometry,n);r.data=i.getData();r.showsPopup=i.showsPopup;if(void 0===e.exportStyles||e.exportStyles){o=TC.Util.extend({},o);for(var s in o){var a=o[s];TC.Util.isFunction(a)&&(o[s]=a(i))}r.style=TC.Util.extend(o,i.getStyle())}return r});return i};t.importState=function(e){const t=this;return new Promise(function(i,n){const r=new Array(e.features.length);e.features.forEach(function(i,n){const o=TC.Util.extend(i.style,{data:i.data,id:i.id,showsPopup:i.showsPopup});var s;switch(i.type){case TC.Consts.geom.POLYGON:s=t.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:s=t.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:s=t.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:s=t.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:s=t.addCircle;break;case TC.Consts.geom.POINT:s=i.style&&(i.style.url||i.style.className)?t.addMarker:t.addPoint}if(s){var a=TC.Util.explodeGeometry(i.geom);e.crs&&t.map.crs!==e.crs?r[n]=new Promise(function(e,i){t.map.one(TC.Consts.event.PROJECTIONCHANGE,function(n){s.call(t,a,o).then(function(){e()},function(){i(Error("addFn failed"))})})}):r[n]=s.call(t,a,o)}});Promise.all(r).then(function(){i()},function(e){n(e instanceof Error?e:Error(e))})})};t.getGetCapabilitiesUrl=function(){const e=this;if(e.type===TC.Consts.layerType.WFS){const i=function(){return e.options.url||e.url};var t={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};return(!TC.Util.isSecureURL(i())&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(i()))?e.getBySSL_(i()):i())+"?"+TC.Util.getParamString(t)}return null};t.getCapabilitiesPromise=function(){const t=this;return t.type===TC.Consts.layerType.WFS?new Promise((i,n)=>{var r=(t.options.url||t.url).replace(/https ?:/gi,"");if(t.capabilities){i(t.capabilities);t._capabilitiesPromise=Promise.resolve(t.capabilities)}if(TC.capabilitiesWFS[r]){i(TC.capabilitiesWFS[r]);t._capabilitiesPromise=Promise.resolve(TC.capabilitiesWFS[r])}t.toolProxification=new TC.tool.Proxification(TC.proxify);const o=e[r];e[r]=t._capabilitiesPromise=o||new Promise(function(e,i){const n=t.getCapabilitiesOnline(),r=t.getCapabilitiesFromStorage();n.then(function(t){e(t)}).catch(function(e){r.catch(function(){i(e)})});r.then(function(t){e(t)}).catch(function(){n.catch(function(e){i(e)})})});e[r].then(function(e){!function(e){t.capabilities=t.capabilities||e;TC.capabilitiesWFS[t.options.url||t.url]=TC.capabilitiesWFS[t.options.url||t.url]||e;TC.capabilitiesWFS[r]=TC.capabilitiesWFS[r]||e;i(e)}(e)}).catch(function(e){t.map&&t.map.trigger(TC.Consts.event.LAYERERROR,{layer:t,reason:"couldNotGetCapabilities"});n(e)})}):Promise.reject(new Error(`Layer "${t.id}" does not have capabilities document`))}}()}();
//# sourceMappingURL=../maps/layer/Vector.min.js.map