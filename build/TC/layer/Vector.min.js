TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");!function(){var e={};TC.layer.Vector=function(){var e=this;e._capabilitiesPromise=null;e.capabilities=null;TC.Layer.apply(e,arguments);e.type=e.options.type||TC.Consts.layerType.VECTOR;e.features=[];e.selectedFeatures=[];const t=function(e){var t=(e=e||"").indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return e.substr(e.lastIndexOf(".")).toLowerCase()}(e.url),i=function(e){switch(e){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(e.options.format)||function(e){switch(e){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(t);if(i||e.type===TC.Consts.layerType.KML){i===TC.Consts.format.KML&&(e.type=TC.Consts.layerType.KML);e.title=e.options.title||function(e){for(var i=e=e||"",n=new RegExp("([^/]+"+t+")","i"),s=0;s<3;s++){e=decodeURIComponent(e);var r=n.exec(e);if(r.length>1){i=r[1];break}}return i}(e.url)}e.wrap=new TC.wrap.layer.Vector(e);e.wrap._promise=new Promise((t,i)=>{var n;n=e.wrap.createVectorLayer();e.wrap.setLayer(n);t(n)})};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var t=TC.layer.Vector.prototype;const i=function(e){let t=0;const i=e.map(e=>e.replace("data:image/svg+xml,","")).map(e=>decodeURIComponent(e)),n=i.map(e=>parseFloat(e.match(/ width="([\d\.]*)"/)[1])),s=i.map(e=>parseFloat(e.match(/ height="([\d\.]*)"/)[1])),r=n.reduce((e,t)=>e+t+2,0),o=Math.max.apply(Math,s),a=i.map((e,i)=>{const r=e.replace('<svg xmlns="http://www.w3.org/2000/svg"',`<svg x="${t}" y="${(o-s[i])/2}" `);t+=n[i]+2;return r});return"data:image/svg+xml,"+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${r}" height="${o}">${a.join("")}</svg>`)};t.getTree=function(){const e=this;let t=null;if(!e.options.stealth){(t={}).children=[];for(var n=0;n<e.features.length;n++){var s=e.features[n].getPath();if(s.length){var r=TC.Util.addArrayToTree(s,t);r&&(r.legend=e.features[n].getLegend())}}if(e.styles||e.cluster){const n=[];e.cluster&&n.push(TC.Util.getLegendImageFromStyle(TC.Util.extend({},e.cluster.styles.point,{radius:TC.Cfg.styles.point.radius+2,offset:[0,6]}),{geometryType:TC.Consts.geom.POINT}));e.styles.point&&n.push(TC.Util.getLegendImageFromStyle(e.styles.point,{geometryType:TC.Consts.geom.POINT}));e.styles.line&&n.push(TC.Util.getLegendImageFromStyle(e.styles.line,{geometryType:TC.Consts.geom.POLYLINE}));e.styles.polygon&&n.push(TC.Util.getLegendImageFromStyle(e.styles.polygon,{geometryType:TC.Consts.geom.POLYGON}));t.legend={src:i(n)}}t.name=e.name||t.name;t.customLegend=e.options.customLegend;t.title=e.title||t.title;t.uid=e.id}return t};var n=function(e,t,i,n){return new Promise(function(s,r){t.call(e,[i],n).then(function(t){s(t[0]);e.map&&e.map.trigger(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]})})})},s=function(e,t,i,n,s){var r=TC.Util.extend(!0,{},s);return new Promise(function(o,a){var l;const c=function(){l=l||TC.feature[i];for(var a=new Array(t.length),c=[],u=0,C=t.length;u<C;u++){var p,f=t[u];const o=TC.wrap.Feature.prototype.isNative(f);if(f instanceof l||"TC.feature."+i===f.CLASSNAME)p=f;else{o&&(p=f._wrap&&f._wrap.parent);if(!p){r.layer=e;const t=e.styles&&e.styles[n];if(TC.Util.hasStyleOptions(r)||!t){const i=TC.Util.extend(!0,{},TC.Cfg.styles,e.map?e.map.options.styles:null);TC.Util.extend(!0,r,i[n],t||{},s)}p=new l(f,r)}}p.layer=e;a[u]=p;e.features.push(p);o||c.push(p.wrap.feature);p.options.showPopup&&p.showInfo()}c.length&&e.wrap.addFeatures(c);o(a)};if(i)TC.loadJS(!TC.feature||TC.feature&&!TC.feature[i],[TC.apiLocation+"TC/feature/"+i],c);else{l=TC.Feature;c()}})};t.addPoint=function(e,t){return n(this,this.addPoints,e,t)};t.addPoints=function(e,t){return s(this,e,"Point",TC.Consts.geom.POINT,t)};t.addMultiPoint=function(e,t){return n(this,this.addMultiPoints,e,t)};t.addMultiPoints=function(e,t){return s(this,e,"MultiPoint","point",t)};t.addMarker=function(e,t){return n(this,this.addMarkers,e,t)};t.addMarkers=function(e,t){return s(this,e,"Marker","marker",t)};t.addMultiMarker=function(e,t){return n(this,this.addMultiMarkers,e,t)};t.addMultiMarkers=function(e,t){return s(this,e,"MultiMarker","marker",t)};t.addPolyline=function(e,t){return n(this,this.addPolylines,e,t)};t.addPolylines=function(e,t){return s(this,e,"Polyline","line",t)};t.addMultiPolyline=function(e,t){return n(this,this.addMultiPolylines,e,t)};t.addMultiPolylines=function(e,t){return s(this,e,"MultiPolyline","line",t)};t.addPolygon=function(e,t){return n(this,this.addPolygons,e,t)};t.addPolygons=function(e,t){return s(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};t.addMultiPolygon=function(e,t){return n(this,this.addMultiPolygons,e,t)};t.addMultiPolygons=function(e,t){return s(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};t.addCircle=function(e,t){return n(this,this.addCircles,e,t)};t.addCircles=function(e,t){return s(this,e,"Circle",TC.Consts.geom.POLYGON,t)};t.addFeature=function(e){const t=this;var i;TC.feature&&(i=TC.feature.Point&&e instanceof TC.feature.Point||"TC.feature.Point"===e.CLASSNAME?t.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline||"TC.feature.Polyline"===e.CLASSNAME?t.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon||"TC.feature.Polygon"===e.CLASSNAME?t.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||"TC.feature.MultiPolygon"===e.CLASSNAME?t.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline||"TC.feature.MultiPolyline"===e.CLASSNAME?t.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle||"TC.feature.Circle"===e.CLASSNAME?t.addCircle(e):s(t,[e]));return i};t.addFeatures=function(e){return s(this,e)};t.removeFeature=function(e){const t=this;if(e.layer&&t.features.indexOf(e)>=0){t.wrap.removeFeature(e);e.layer=null}};t.getFeatureById=function(e){let t=null;var i=this.wrap.getFeatureById(e);i&&(t=i._wrap.parent);return t};t.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};t.getDescribeFeatureTypeUrl=function(e){const t=this.options.version||this.capabilities.version||"1.1.0";let i=e||this.featureType;i=Array.isArray(i)?i:[i];return this.url+"?service=WFS&version="+t+"&request=DescribeFeatureType&typename="+i.join(",")+"&outputFormat="+encodeURIComponent(this.capabilities.Operations.DescribeFeatureType.outputFormat)};t.describeFeatureType=function(e,t,i){const n=this;e||(e=n.options.featureType);const s=new Promise(function(t,i){n.getCapabilitiesPromise().then(function(s){if(s.Operations.DescribeFeatureType)if(window.hasOwnProperty("Worker")){const s=async function(){var e=TC.apiLocation+"TC/workers/tc-dft-web-worker.js";if(TC.Util.isSameOrigin(TC.apiLocation))return e;try{const i=(await TC.ajax({url:e,method:"GET",responseType:"text"})).data;var t=new Blob([i],{type:"text/javascript"});return window.URL.createObjectURL(t)}catch(e){throw e}},o=async function(){try{n.WebWorkerDFT||(n.WebWorkerDFT=new Worker(await s()));n.WebWorkerDFT.onmessage=async function(e){if(e.data instanceof Object){if("success"!==e.data.state)throw"Ha habido problemas procesando el Describe feature type";{let t=Object.keys(e.data.DFTCollection).join(",");if(!TC.describeFeatureType[t])throw"No se encuentra la clave "+t+" en la colecci\xf3n";"function"==typeof TC.describeFeatureType[t]&&TC.describeFeatureType[t].call(null,e.data.DFTCollection);TC.describeFeatureType=Object.assign(TC.describeFeatureType,e.data.DFTCollection)}}else{var t=await n.toolProxification.fetchXML(e.data);n.WebWorkerDFT.postMessage({url:e.data,response:t.documentElement.outerHTML})}}}catch(e){throw e}},a=async function(e,t){var i=await n.toolProxification.fetchXML(n.getDescribeFeatureTypeUrl(e||n.featureType));if(i.querySelector("Exception")||i.querySelector("exception"))throw(i.querySelector("Exception")||i.querySelector("exception")).textContent.trim();n.WebWorkerDFT.postMessage({layerName:e,xml:i.documentElement.outerHTML,url:TC.apiLocation.indexOf("http")>=0?TC.apiLocation:document.location.protocol+TC.apiLocation});TC.describeFeatureType[e instanceof Array?e.join(","):e]=t};try{o()}catch(e){i(e)}e instanceof Array||(e=e.split(","));var r=Object.entries(e.reduce(function(e,t){let i=t.substring(0,t.indexOf(":"));if(e[i]){e[i].push(t);return e}{let n={};n[i]=[t];return Object.assign(e,n)}},{})).map(function(e){var t=e[1];return new Promise(async function(e,i){if(TC.describeFeatureType[t])e(function(e,t){e instanceof Array||(e=e.split(","));return e.reduce(function(e,i){var n=[];n[i]=t[i];return Object.assign(e,n)},{})}(t,TC.describeFeatureType));else try{await a(t,function(t){e(t)})}catch(e){i(e)}})});Promise.all(r).then(function(e){let i=e.reduce(function(e,t){return Object.assign(e,t)},{});t(1===Object.keys(i).length?i[Object.keys(i)[0]]:i)}).catch(i)}else i("No esta disponible el WebWorker");else i("No esta disponible el m\xe9todo describeFeatureType")}).catch(e=>i(e))});s.then(function(e){TC.Util.isFunction(t)&&t(e)},function(e){TC.Util.isFunction(i)&&i(e)});return s};t.import=function(e){this.wrap.import(e)};t.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.trigger(TC.Consts.event.BEFOREUPDATE);this.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:this});this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var i,n,s=!1;for(i=0;i<this.features.length;i++)if((n=this.features[i]).id==e){s=!0;n.setVisibility(t);break}if(!s)for(i=0;i<this.features.length;i++){void 0===(n=this.features[i])._path&&(n._path="/"+n.getPath().join("/"));n._path===e&&n.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:this});this.map.trigger(TC.Consts.event.UPDATE)};t.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var i=this._cache.visibilityStates[e];void 0!==i&&(t=i)}return t};t.setModifiable=function(e){this.wrap.setModifiable(e)};t.applyEdits=function(e,t,i){return this.wrap.sendTransaction(e,t,i)};t.refresh=function(){this.clearFeatures();return this.wrap.reloadSource()};t.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};t.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};t.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:t});t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:t})}};t.setStyles=function(e){this.styles=TC.Util.extend({},e);this.wrap.setStyles(e)};t.exportState=function(e){const t=this;e=e||{};const i={id:t.id};t.map&&t.map.crs!==t.map.options.crs&&(i.crs=t.map.crs);var n=Math.pow(10,(t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);const s=e.features||t.features;i.features=s.map(function(i){const s={};var r;switch(!0){case TC.feature.Marker&&i instanceof TC.feature.Marker:s.type=TC.Consts.geom.POINT;r=t.options.styles&&t.options.styles.marker;break;case TC.feature.Point&&i instanceof TC.feature.Point:s.type=TC.Consts.geom.POINT;r=t.options.styles&&t.options.styles.point;break;case TC.feature.MultiPoint&&i instanceof TC.feature.MultiPoint:s.type=TC.Consts.geom.MULTIPOINT;break;case TC.feature.Polyline&&i instanceof TC.feature.Polyline:s.type=TC.Consts.geom.POLYLINE;r=t.options.styles&&t.options.styles.line;break;case TC.feature.MultiPolyline&&i instanceof TC.feature.MultiPolyline:s.type=TC.Consts.geom.MULTIPOLYLINE;r=t.options.styles&&t.options.styles.line;break;case TC.feature.Polygon&&i instanceof TC.feature.Polygon:s.type=TC.Consts.geom.POLYGON;r=t.options.styles&&t.options.styles.polygon;break;case TC.feature.MultiPolygon&&i instanceof TC.feature.MultiPolygon:s.type=TC.Consts.geom.MULTIPOLYGON;r=t.options.styles&&t.options.styles.polygon;break;case TC.feature.Circle&&i instanceof TC.feature.Circle:s.type=TC.Consts.geom.CIRCLE;r=t.options.styles&&t.options.styles.polygon}s.id=i.id;s.geom=TC.Util.compactGeometry(i.geometry,n);s.data=i.getData();s.showsPopup=i.showsPopup;if(void 0===e.exportStyles||e.exportStyles){r=TC.Util.extend({},r);for(var o in r){var a=r[o];TC.Util.isFunction(a)&&(r[o]=a(i))}s.style=TC.Util.extend(r,i.getStyle())}return s});return i};t.importState=function(e){const t=this;return new Promise(function(i,n){const s=new Array(e.features.length);e.features.forEach(function(i,n){const r=TC.Util.extend(i.style,{data:i.data,id:i.id,showsPopup:i.showsPopup});var o;switch(i.type){case TC.Consts.geom.POLYGON:o=t.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:o=t.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:o=t.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:o=t.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:o=t.addCircle;break;case TC.Consts.geom.MULTIPOINT:o=i.style&&(i.style.url||i.style.className)?t.addMultiMarker:t.addMultiPoint;break;case TC.Consts.geom.POINT:o=i.style&&(i.style.url||i.style.className)?t.addMarker:t.addPoint}if(o){var a=TC.Util.explodeGeometry(i.geom);e.crs&&t.map.crs!==e.crs?s[n]=new Promise(function(e,i){t.map.one(TC.Consts.event.PROJECTIONCHANGE,function(n){o.call(t,a,r).then(function(){e()},function(){i(Error("addFn failed"))})})}):s[n]=o.call(t,a,r)}});Promise.all(s).then(function(){i()},function(e){n(e instanceof Error?e:Error(e))})})};t.clone=function(){const e=TC.Layer.prototype.clone.call(this);this.features.forEach(t=>e.addFeature(t.clone()));return e};t.getGetCapabilitiesUrl=function(){const e=this;if(e.type===TC.Consts.layerType.WFS){const i=function(){return e.options.url||e.url};var t={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};return(!TC.Util.isSecureURL(i())&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(i()))?e.getBySSL_(i()):i())+"?"+TC.Util.getParamString(t)}return null};t.getCapabilitiesPromise=function(){const t=this;return t.type===TC.Consts.layerType.WFS?new Promise((i,n)=>{var s=(t.options.url||t.url).replace(/https ?:/gi,"");if(t.capabilities){i(t.capabilities);t._capabilitiesPromise=Promise.resolve(t.capabilities)}if(TC.capabilitiesWFS[s]){i(TC.capabilitiesWFS[s]);t._capabilitiesPromise=Promise.resolve(TC.capabilitiesWFS[s])}t.toolProxification=new TC.tool.Proxification(TC.proxify);const r=e[s];e[s]=t._capabilitiesPromise=r||new Promise(function(e,i){const n=t.getCapabilitiesOnline(),s=t.getCapabilitiesFromStorage();n.then(function(t){e(t)}).catch(function(e){s.catch(function(){i(e)})});s.then(function(t){e(t)}).catch(function(){n.catch(function(e){i(e)})})});e[s].then(function(e){!function(e){t.capabilities=t.capabilities||e;TC.capabilitiesWFS[t.options.url||t.url]=TC.capabilitiesWFS[t.options.url||t.url]||e;TC.capabilitiesWFS[s]=TC.capabilitiesWFS[s]||e;i(e)}(e)}).catch(function(e){t.map&&t.map.trigger(TC.Consts.event.LAYERERROR,{layer:t,reason:"couldNotGetCapabilities"});n(e)})}):Promise.reject(new Error(`Layer "${t.id}" does not have capabilities document`))}}()}();
//# sourceMappingURL=../maps/layer/Vector.min.js.map