TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.Consts.BLANK_IMAGE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7";!function(){var e={},i=!TC.isLegacy&&window.hasOwnProperty("Worker"),t=$.Deferred();if(i){var a=TC.apiLocation+"TC/workers/tc-caps-web-worker.js";TC.Util.isSameOrigin(TC.apiLocation)?t.resolve(a):$.ajax({url:a,type:"GET",dataType:"text"}).then(function(e){var i=new Blob([e],{type:"text/javascript"}),a=window.URL.createObjectURL(i);t.resolve(a)},function(e){t.reject()})}var r=function(e,t){TC._capabilitiesRequests=TC._capabilitiesRequests||[];return TC._capabilitiesRequests[e]=!t&&TC._capabilitiesRequests[e]||$.ajax({url:t?TC.proxify(e):e,type:"GET",dataType:i?"text":"xml"})},s=function(e,i){var t="No se pudo obtener el documento de capacidades de servicio "+e.url+": ["+i+"]";e._capabilitiesPromise.reject(t);TC.error(t);e.map&&e.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:e,reason:"couldNotGetCapabilities"}));e.wrap.setLayer(null)},o=function(e,i){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=e.CAPABILITIES_STORE_KEY_PREFIX+e.options.url,a=function(){i.hasOwnProperty("error")||$.when(e._capabilitiesPromise).then(function(){var e=i._capabilitiesURL;delete i._capabilitiesURL;localforage.setItem(t,i).then(function(){i._capabilitiesURL=e}).catch(function(e){console.log(e)})})};e.map?e.map.loaded(a):a()})},n=function(a,r){var s;if(r.documentElement){if($(r).find("ServiceException").length>0)s={error:$(r).find("ServiceException").text()};else{var n=a.type===TC.Consts.layerType.WMTS?new a.wrap.WmtsParser:new a.wrap.WmsParser;s=n.read(r);a.type===TC.Consts.layerType.WMTS&&s.Contents&&s.Contents.Layer&&$("Layer",r).each(function(e,i){var t=TC.Util.getElementByNodeName(i,"ows:Identifier")[0].firstChild.data,a=$(i),r=s.Contents.Layer.filter(function(e){return e.Identifier==t});if(r.length){r=r[0];for(var o=0;o<r.TileMatrixSetLink.length;o++){var n=r.TileMatrixSetLink[o];matrixId=n.TileMatrixSet;xmlLink=a.find("TileMatrixSetLink").each(function(e,i){return $(i).find("TileMatrixSet:first").text()==matrixId});if(xmlLink.length){xmlLink=xmlLink[0];n.TileMatrixSetLimits=[];$(xmlLink).find("TileMatrixLimits").each(function(e,i){var t=$(i);n.TileMatrixSetLimits.push({TileMatrix:t.find("TileMatrix").text(),MinTileRow:parseInt(t.find("MinTileRow").text()),MinTileCol:parseInt(t.find("MinTileCol").text()),MaxTileRow:parseInt(t.find("MaxTileRow").text()),MaxTileCol:parseInt(t.find("MaxTileCol").text())})})}}}})}e[a.url].resolve(s);o(a,s)}else if(i&&"string"==typeof r)t.then(function(i){var t=new Worker(i);t.onmessage=function(i){if("success"===i.data.state){s=i.data.capabilities;o(a,s)}else s={error:"Web worker error"};e[a.url].resolve(s);t.terminate()};t.postMessage({type:a.type,text:r})});else{s=r;e[a.url].resolve(s)}},l=function(e){var i;if(!e.wrap.layer){switch(e.type){case TC.Consts.layerType.GROUP:break;case TC.Consts.layerType.WMTS:i=g(e);break;default:i=c(e)}e.wrap.setLayer(i)}},c=function(e){var i=$.isArray(e.names)?e.names.join(","):e.names,t=e.options.format,a=e.options,r={LAYERS:i,FORMAT:t,TRANSPARENT:e.transparent,VERSION:e.capabilities.version||"1.3.0"};e.params&&$.extend(r,e.params);e.queryParams&&$.extend(r,e.queryParams);var s=e.getPreferredInfoFormat();null!==s&&(r.INFO_FORMAT=s);return e.wrap.createWMSLayer(e.getGetMapUrl(),r,a)},g=function(e){return e.wrap.createWMTSLayer(e.options)},p=function e(i,t){var a=$.inArray(t.name,i.availableNames);if(-1===a)for(var r=0,s=t.children.length;r<s&&-1===(a=e(i,t.children[r]));r++);return a},m=function e(i,t,a){var r=!1;a.count=a.count+1;if(i.name===t)r=!0;else for(var s=i.children.length-1;s>=0;s--)if(e(i.children[s],t,a)){r=!0;break}return r},u=function(e,i,t){var a=$.Deferred();r(e,!1).done(function(e){a.resolve(!0);i&&$.isFunction(i)&&i(e)}).fail(function(e){a.resolve(!1);t&&$.isFunction(t)&&t(e)});return a.promise()},f=function(e,i,t){return u(e.replace(this.PROTOCOL_REGEX,"https://"),i,t)},d=function(e,i,t){return u(e,i,t)},C=function(e,i){var t,a,r=$.Deferred(),s=document.createElement("img");s.crossOrigin="anonymous";$.isFunction(s.onload)&&(t=s.onload);s.onload=function(){try{var e=function(e){var i=document.createElement("CANVAS"),t=i.getContext("2d");i.height=e.height;i.width=e.width;t.drawImage(e,0,0);return i}(s);result=e.toDataURL("image/png");if(i){i.image_=s;i.state=ol.ImageState.LOADED;i.changed()}r.resolve(!0)}catch(e){if(18===e.code)r.resolve(!1);else{if(i){i.image_=s;i.state=ol.ImageState.LOADED;i.changed()}r.resolve(!0)}}s.onload=void 0;s.onerror=void 0;t&&$.isFunction(t)&&t()};$.isFunction(s.onerror)&&(a=s.onerror);s.onerror=function(){s.onload=void 0;s.onerror=void 0;r.resolve(!1);a&&$.isFunction(a)&&a()};s.src=e;return r.promise()};TC.layer.Raster=function(){this._capabilitiesPromise=null;TC.Layer.apply(this,arguments);this.wrap=new TC.wrap.layer.Raster(this);this.transparent=!1!==this.options.transparent;this.url=this.options.url;this.params=this.options.params;if("string"==typeof this.options.layerNames)this.names=this.availableNames=this.options.layerNames.split(",");else{this.names=[];this.availableNames=[];if($.isArray(this.options.layerNames))for(var i=0;i<this.options.layerNames.length;i++){if("string"==typeof(g=this.options.layerNames[i])){this.names.push(g);this.availableNames.push(g)}else if(g.hasOwnProperty("name")){this.availableNames.push(g.name);(void 0===g.isVisible||g.isVisible)&&this.names.push(g.name)}}else{var t=this.options.params?this.options.params.sld_body:null;if(t){var a=$.parseXML(t),o=TC.Util.getElementByNodeName(a,"sld:NamedLayer");if(o&&o.length>0){var c=TC.Util.getElementByNodeName(o[0],"sld:Name");if(c&&c.length>0){var g=$(c[0]).text();this.names.push(g);this.availableNames.push(g)}}}}}this.ignorePrefixes=void 0===this.options.ignorePrefixes||this.options.ignorePrefixes;this._capabilitiesNodes={};!function(i,t,a){var o=i.url;i._capabilitiesPromise=$.Deferred();var n=e[o];n||(n=e[o]=$.Deferred());var c,g=function(e){if(e.error){s(i,e.error);i._capabilitiesPromise.reject()}else{i.capabilities=i.capabilities||e;i.capabilitiesUrl_?e._capabilitiesURL=i.capabilitiesUrl_:i.capabilitiesUrl_=e._capabilitiesURL;var t=i.getGetMapUrl();TC.capabilities[i.options.url]=TC.capabilities[i.options.url]||e;TC.capabilities[t]=TC.capabilities[t]||e;l(i);i._capabilitiesPromise.resolve(e)}},p={};if(i.type===TC.Consts.layerType.WMTS)if(i.options.encoding===TC.Consts.WMTSEncoding.RESTFUL){var m="/1.0.0/WMTSCapabilities.xml";const e=o.indexOf(m);if(e<0||e<o.length-m.length){"/"===o[o.length-1]&&(m=m.substr(1));c=o+m}else c=o}else{c=o;p.SERVICE="WMTS";p.VERSION="1.0.0";p.REQUEST="GetCapabilities"}else{c=o;p.SERVICE="WMS";p.VERSION="1.3.0";p.REQUEST="GetCapabilities"}c=c+"?"+$.param($.extend(p,i.queryParams));TC._capabilitiesRequests=TC._capabilitiesRequests||{};var u=i.setCapabilitiesUrl_(c,t,a);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(i.CAPABILITIES_STORE_KEY_PREFIX+o).then(function(t){if(t){e[i.url].then(g);u.then(function(){e[i.url].resolve(t)})}})});u.then(function(e){e===i.capabilitiesState_.PENDING&&r(i.capabilitiesUrl_(c)).then(function(e){t(i,e)},function(e,s,o){r(c,!0).then(function(e){t(i,e)},function(e){a(i,e.responseText)})})});$.when(u,n).done(function(e,t){e===i.capabilitiesState_.DONE&&t?g(t):t&&g(t)})}(this,n,s);this._disgregatedLayerNames=null;TC.Consts.layerType.WMTS==this.type&&this.wrap.setWMTSUrl()};TC.inherit(TC.layer.Raster,TC.Layer);var T=TC.layer.Raster.prototype;T.PROTOCOL_REGEX=/^(f|ht)tp?:\/\//i;T.capabilitiesState_={PENDING:0,DONE:1};T.getByProxy_=function(e){return TC.proxify(e)};T.getBySSL_=function(e){return e.replace(this.PROTOCOL_REGEX,"https://")};T.getByUrl_=function(e){return e};T.getCapabilitiesUrl_promise_=function(){this.capabilitiesUrl_promise_||(this.capabilitiesUrl_promise_=$.Deferred());return this.capabilitiesUrl_promise_};T.getCapabilitiesUrl_ServiceWorker_=function(e){var i=this,t=e&&e.trim()||i.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTPS + ServiceWorker");TC.Util.consoleRegister("Service worker nos obliga a estar en HTTPS");TC.Util.consoleRegister("Comprobamos si el servicio a solicitar es HTTPS, si no lo es producir\xe1 contenido mixto y el service worker no lo acepta");if(TC.Util.isSecureURL(t)){TC.Util.consoleRegister("S\xed lo es: validamos si cuenta con CORS");d(t,i.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Tiene cabeceras CORS");i.capabilitiesUrl_=i.getByUrl_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("NO tiene cabeceras CORS -> proxificamos:");TC.Util.consoleRegister("GetCapabilities, GFI, 3D");TC.Util.consoleRegister("GetMap");i.capabilitiesUrl_=i.getByProxy_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.PENDING)}})}else{TC.Util.consoleRegister("No lo es: validamos si soporta SSL, ya que: aunque cuente con cabeceras CORS si el protocolo es distinto, el navegador bloquear\xe1 la petici\xf3n");i.getCapabilitiesUrl_MixedContent_FromHTTPS_(t)}};T.getCapabilitiesUrl_MixedContent_FromHTTPS_=function(e){var i=this,t=e&&e.trim()||i.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTPS y servicio en HTTP");TC.Util.consoleRegister("Validamos si soporta SSL, ya que: aunque cuente con cabeceras CORS si el protocolo es distinto, el navegador bloquea la petici\xf3n");f.call(i,t,i.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Dado que estamos en un escenario de cross origin y si la petici\xf3n/comprobaci\xf3n de SSL ha funcionado correctamente: podemos afirmar que el servicio cuenta con cabeceras CORS");i.capabilitiesUrl_=i.getBySSL_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("Realmente no sabemos si el error se produce por no soportar HTTPS o porque no tiene CORS, sea como sea: es necesario proxificar");i.capabilitiesUrl_=i.getByProxy_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.PENDING)}})};T.getCapabilitiesUrl_MixedContent_FromHTTP_=function(e){var i=e&&e.trim()||this.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTP y servicio en HTTPS");this.getCapabilitiesUrl_CORSSupport_.call(this,i)};T.getCapabilitiesUrl_MixedContent_=function(e,i){var t=e&&e.trim()||this.url.trim(),a=i||document.location.href;TC.Util.consoleRegister("\xbfEstamos en HTTPS?");if(TC.Util.isSecureURL(a)){TC.Util.consoleRegister("Al ser un sitio seguro, validamos si existe un service worker (es m\xe1s restrictivo)");if(TC.Util.isServiceWorker()){TC.Util.consoleRegister("S\xed hay ServiceWorker");this.getCapabilitiesUrl_ServiceWorker_.call(this,t)}else{TC.Util.consoleRegister("No hay ServiceWorker");this.getCapabilitiesUrl_MixedContent_FromHTTPS_.call(this,t)}}else{TC.Util.consoleRegister("No lo estamos");this.getCapabilitiesUrl_MixedContent_FromHTTP_.call(this,t)}};T.getCapabilitiesUrl_ProtocolSiblings_=function(e,i){var t=e&&e.trim()||this.url.trim(),a=i||document.location.href;TC.Util.consoleRegister("Validamos si estamos en HTTPS y si hay ServiceWorker (es m\xe1s restrictivo)");if(TC.Util.isSecureURL(a)&&TC.Util.isServiceWorker()){TC.Util.consoleRegister("S\xed hay ServiceWorker");this.getCapabilitiesUrl_ServiceWorker_.call(this,t)}else{TC.Util.consoleRegister("No hay ServiceWorker");this.getCapabilitiesUrl_CORSSupport_.call(this,t)}};T.getCapabilitiesUrl_CORSSupport_=function(e){var i=this,t=e&&e.trim()||i.url.trim();TC.Util.consoleRegister("Validamos si soporta CORS");d(t,i.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Cuenta con cabeceras CORS");i.capabilitiesUrl_=i.getByUrl_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("NO tiene cabeceras CORS -> proxificamos:");TC.Util.consoleRegister("Capabilities");i.capabilitiesUrl_=i.getByProxy_;i.getCapabilitiesUrl_promise_().resolve(i.capabilitiesState_.PENDING)}})};T.setCapabilitiesUrl_=function(e,i,t,a){var r=this;r.capabilitiesUrl_promise_=$.Deferred();var s=e&&e.trim()||r.url.trim(),o=a||document.location.href;r.capabilitiesLoad_||(r.capabilitiesLoad_=function(e){i(r,e)});r.capabilitiesLoadError_||(r.capabilitiesLoadError_=function(e){t(r,e)});TC.Util.consoleRegister("No hay capa hermana");TC.Util.consoleRegister("Validamos si existe cross origin");if(TC.Util.isSameOriginByLocation(s,o)){TC.Util.consoleRegister("Tenemos mismo origen, cargamos directamente");r.capabilitiesUrl_=r.getByUrl_;r.getCapabilitiesUrl_promise_().resolve(r.capabilitiesState_.PENDING)}else if(TC.Util.isSameProtocol(s,o)){TC.Util.consoleRegister("Hay cross origin");TC.Util.consoleRegister("Sin contenido mixto");r.getCapabilitiesUrl_ProtocolSiblings_.call(r,s)}else{TC.Util.consoleRegister("Tenemos contenido mixto");r.getCapabilitiesUrl_MixedContent_.call(r,s)}return r.getCapabilitiesUrl_promise_()};T.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.";T.setVisibility=function(e){this.tree=null;this._cache.visibilityStates={};TC.Layer.prototype.setVisibility.call(this,e)};var h=function e(i,t,a){var r=!1,s=i.wrap.getLayerNodes(a);if(s.length){for(var o=0,n=s.length;o<n;o++)e(i,t,s[o])&&(r=!0);var l,c,g=$.map(s,function(e){return i.wrap.getName(e)}).reverse(),p=!1;c=l=$.inArray(g[0],t);if(l<0)p=!0;else for(o=1,n=g.length;o<n;o++)if(g[o]!=t[++l]){p=!0;break}if(!p){var m=i.wrap.getName(a);if(m&&g.length>1){t.splice(c,g.length,m);r=!0}}}return r},y=function(e,i){for(var t=[],a=i.slice(),r=e.wrap.getRootLayerNode(),s=0,o=a.length;s<o;s++)t=t.concat(b(e,a[s],r));return t},b=function e(i,t,a,r){for(var s=[],o=i.wrap.getName(a),n=i.compareNames(t,o),l=!1,c=i.wrap.getLayerNodes(a),g=0;g<c.length;g++){var p=e(i,t,c[g],r||n);p.length?s=s.concat(p):l=!0}c.length&&!l||(r||n)&&(s=[o]);return s},v=function(e){return $.extend({aggregate:!0,lazy:!1},e)},L=function(e,i,t){var a,r,s=[];a=i||[];r=t||[];for(var o=(e||[]).concat(a),n=0;n<o.length;n++)$.inArray(o[n],o)===n&&-1===$.inArray(o[n],r)&&(s[s.length]=o[n]);return s},S=function(e,i){var t="string"==typeof i?i.split(","):i;if(e.capabilities){var a=e.getTree();t.sort(function(e,i){var t={count:0},r={count:0};m(a,e,t);m(a,i,r);return t.count-r.count})}return t},_=function(e,i,t,a){return $.grep(t,function(t){return e.compareNames(i,t,a)}).length>0};T.getLimitedMatrixSet=function(){return function(e){var i=e.layerNames,t=e.matrixSet,a=e.capabilities,r=[],s=a.Contents.TileMatrixSet.filter(function(e){return e.Identifier==t});if(s.length){s=s[0];var o=a.Contents.Layer.filter(function(e){return e.Identifier==i})[0];if(o.TileMatrixSetLink&&o.TileMatrixSetLink.length&&o.TileMatrixSetLink[0].TileMatrixSetLimits){for(var n,l=o.TileMatrixSetLink[0].TileMatrixSetLimits,c=0;c<l.length;c++){n=l[c];var g=s.TileMatrix.filter(function(e){return e.Identifier==n.TileMatrix});if(g.length){var p=$.extend({matrixIndex:s.TileMatrix.indexOf(g[0])},g[0],n);r.push(p)}}return r}return s.TileMatrix}return null}(this)};T.setLayerNames=function(e,i){var t=this,a=new $.Deferred;$.when(t.wrap.getLayer()).then(function(){var r=$.isArray(e)?e:e.split(",");t.names=r;var s=v(i);s.aggregate&&(r=function(e,i){if(e.type!==TC.Consts.layerType.WMS)return i;var t=i.slice();h(e,t,e.wrap.getRootLayerNode());return t}(t,r));t._disgregatedLayerNames=null;var o={LAYERS:r.join(","),TRANSPARENT:!0};r.length||t.setVisibility(!1);if(s.lazy){var n=t._newParams||t.wrap.getParams();t._newParams=$.extend(n,o)}else{t.map&&t.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATEPARAMS,{layer:t}));t.tree=null;t._cache.visibilityStates={};t.wrap.setParams(o);!s.reset&&t.map||(t.availableNames=t.names);t.map&&t.map.$events.trigger($.Event(TC.Consts.event.UPDATEPARAMS,{layer:t}))}a.resolve(t.names)});return a};T.addLayerNames=function(e,i){var t=this,a=new $.Deferred;$.when(t.wrap.getLayer()).then(function(){var r=v(i),s=$.isArray(e)?e:e.split(","),o=t.wrap.getParams().LAYERS;if(r.aggregate){s=y(t,s);o=t.getDisgregatedLayerNames()}$.when(t.setLayerNames(S(t,L(o,s,null)),i)).then(function(e){a.resolve(e)})});return a};T.removeLayerNames=function(e,i){var t=this,a=new $.Deferred;$.when(t.wrap.getLayer()).then(function(){var r=v(i),s=$.isArray(e)?e:e.split(","),o=t.wrap.getParams().LAYERS;if(r.aggregate){s=y(t,s);o=t.getDisgregatedLayerNames()}$.when(t.setLayerNames(S(t,L(o,null,s)),i)).then(function(e){a.resolve(e)})});return a};T.toggleLayerNames=function(e,i){var t=this,a=new $.Deferred;$.when(t.wrap.getLayer()).then(function(){var r=v(i),s=$.isArray(e)?e:e.split(","),o=t.wrap.getParams().LAYERS;if(r.aggregate){s=y(t,s);o=t.getDisgregatedLayerNames()}for(var n=[],l=[],c=0;c<s.length;c++){var g=s[c];$.inArray(g,o)<0?n[n.length]=g:l[l.length]=g}var p=[];n.length>0&&p.push(t.addLayerNames(n,r));l.length>0&&p.push(t.removeLayerNames(l,r));$.when.apply(this,p).then(function(e,i){e?i?a.resolve(e.concat(i)):a.resolve(e):a.resolve([])})});return a};T.getDisgregatedLayerNames=function(){var e=this.wrap.getLayer();if(this.wrap.isNative(e)&&this.type===TC.Consts.layerType.WMS){if(!this._disgregatedLayerNames){var i=this.wrap.getParams().LAYERS;i=$.isArray(i)?i:i.split(",");this._disgregatedLayerNames=y(this,i)}}else this._disgregatedLayerNames=this.names;return this._disgregatedLayerNames.slice()};T.isValidFromNames=function(){for(var e=!0,i=0,t=this.names.length;i<t;i++)if(!this.getLayerNodeByName(this.names[i])){e=!1;break}return e};T.isCompatible=function(e){var i=!1;switch(this.type){case TC.Consts.layerType.WMTS:case TC.Consts.layerType.WMS:i=this.wrap.isCompatible(e)}return i};T.getCompatibleCRS=function(e){const i=this;e=e||{};var t=i.wrap.getCompatibleCRS();if(e.includeFallback&&i.fallbackLayer){const e=i.getFallbackLayer();e instanceof TC.Layer&&(t=t.concat(e.wrap.getCompatibleCRS()))}e.normalized&&(t=t.map(function(e){return TC.Util.getCRSCode(e)}).filter(function(e){return null!==e}).reduce(function(e,i){e.indexOf(i)<0&&(e[e.length]=i);return e},[]).map(function(e){return"EPSG:"+e}));return t};T.getProjection=function(){switch(this.type){case TC.Consts.layerType.WMTS:return this.wrap.layer.getSource().getProjection().getCode();case TC.Consts.layerType.WMS:return this.map.crs}};T.setProjection=function(e){if((e=e||{}).crs)switch(this.type){case TC.Consts.layerType.WMTS:var i=this.wrap.getCompatibleMatrixSets(e.crs)[0];if(i){this.matrixSet=i;this.wrap.setMatrixSet(i)}else this.wrap.setProjection(e);this.mustReproject=!i;break;case TC.Consts.layerType.WMS:this.wrap.setProjection(e);this.mustReproject=!this.isCompatible(e.crs)}};T.isVisibleByScale=function(e,i){var t,a,r,s=this,o=function(){return s.map.wrap.getResolution()*s.map.getMetersPerUnit()/28e-5};switch(s.type){case TC.Consts.layerType.WMTS:t=!1;var n=s.wrap.getTileMatrix(s.options.matrixSet);if(n){a=o();for(r=0;r<n.length;r++){if((p=s.wrap.getScaleDenominators(n[r]))[0]===a){t=!0;break}}}break;case TC.Consts.layerType.WMS:t=!0;var l=s.wrap.getAllLayerNodes();if(l.length>0){a=o();var c;if("number"==typeof e)c=s._capabilitiesNodes[e];else for(r=0;r<l.length;r++){var g=l[r];if(s.compareNames(s.wrap.getName(g),e,i)){c=g;break}}if(c){var p=s.wrap.getScaleDenominators(c);t=!(parseFloat(p[1])>a||parseFloat(p[0])<a)}}break;default:t=!0}return t};T.isVisibleByName=function(e,i){var t=this,a=!1;switch(t.type){case TC.Consts.layerType.WMTS:if(t.wrap.getWMTSLayer()){a=!0;break}break;case TC.Consts.layerType.WMS:var r=function e(a,r){var s=null,o=t.wrap.getName(r);if(t.compareNames(o,a,i))s=[o];else for(var n=t.wrap.getLayerNodes(r),l=0;l<n.length;l++){var c=e(a,n[l]);if(c){TC.Util.fastUnshift(c,o);s=c;break}}return s},s=function(e){return r(e,t.wrap.getRootLayerNode())}(e);if(s)for(var o=0;o<s.length;o++)if(_(t,s[o],t.names)){a=!0;break}break;default:a=!0}return a};T.getTree=function(){var e=this,i=e.tree;if(!i){var t,a=function i(a,r,s){var o;for(var n in e._capabilitiesNodes)if(e._capabilitiesNodes[n]===a){o=n;break}if(!o){o=TC.getUID();e._capabilitiesNodes[o]=a}var l,c,g={name:e.wrap.getName(a),title:a.title||a.Title,uid:o,children:[]};s&&(t=g);_(e,g.name,e.availableNames)&&(r=!0);if(e.options.isBase){g.name=e.names.join(",");g.title=e.title||g.title;g.isBase=e.isDefault;e.options.thumbnail&&(g.legend={src:e.options.thumbnail})}else{g.isVisible=g===t?e.getVisibility():e.isVisibleByName(g.name);var p,m=e.wrap.getLayerNodes(a);for(p=0;p<m.length;p++){var u=i(m[p],r);u&&(l=g,c=u,e.options.inverseTree?TC.Util.fastUnshift(l.children,c):l.children[l.children.length]=c)}g.legend=e.wrap.getLegend(a);if(!r&&!s){t.children=t.children.concat(g.children);g=null}}return g};switch(e.type){case TC.Consts.layerType.WMTS:i=a(e.wrap.getWMTSLayer(),!e.options.hideTree,!0);break;case TC.Consts.layerType.WMS:if(e.capabilities){i=a(e.wrap.getRootLayerNode(),!e.options.hideTree,!0);var r=e._cache.visibilityStates;!function e(i){var t=TC.Consts.visibility.NOT_VISIBLE;if(i){if(void 0!==r[i.uid])t=r[i.uid];else{if(i.children)for(var a=!1,s=!1,o=0,n=i.children.length;o<n;o++){switch(e(i.children[o])){case TC.Consts.visibility.VISIBLE:a=!0;break;case TC.Consts.visibility.NOT_VISIBLE:s=!0;break;case TC.Consts.visibility.HAS_VISIBLE:a=!0;s=!0}a&&(t=s?TC.Consts.visibility.HAS_VISIBLE:TC.Consts.visibility.VISIBLE)}i.isVisible&&(t=TC.Consts.visibility.VISIBLE);r[i.uid]=t}i.visibilityState=t}return t}(i);e.options.hideTree&&function e(i,t){t.children.sort(function(e,t){return p(i,t)-p(i,e)});for(var a=0,r=t.children.length;a<r;a++)e(i,t.children[a])}(e,i)}}i||(i={name:e.name,title:e.title});i.title=e.title||i.title;i.customLegend=e.customLegend||i.customLegend;e.tree=i}return i};T.setNodeVisibility=function(e,i){var t=this;t.tree||(t.tree=t.getTree());var a=t.findNode(e,t.tree);if(a===t.tree)i&&0===t.names.length?t.addLayerNames(t.availableNames).then(function(){t.setVisibility(!0)}):t.setVisibility(i);else{var r=function e(i){var t=[];if(i.name)t[0]=i.name;else for(var a=0;a<i.children.length;a++)t=t.concat(e(i.children[a]));return t}(a);i?t.addLayerNames(r):t.removeLayerNames(r)}};T.getNodeVisibility=function(e){this.tree||(this.tree=this.getTree());return this._cache.visibilityStates[e]};T.getNodePath=function(e,i){var t=this,a=[];if(t.type===TC.Consts.layerType.WMS&&t.capabilities){e=e||t.names[0];a=function a(r){var s=[],o=t.wrap.getName(r);if(t.compareNames(o,e,i))s.push(r);else for(var n=t.wrap.getLayerNodes(r),l=0;l<n.length;l++){var c=a(n[l]);if(c.length){s=c;TC.Util.fastUnshift(s,r);break}}return s}(t.wrap.getRootLayerNode())}return a};T.getPath=function(e,i){return $.map(this.getNodePath(e,i),function(e){return e.title||e.Title})};T.getLayerNodeByName=function(e){for(var i=null,t=this.wrap.getServiceType()===TC.Consts.layerType.WMTS?this.wrap.getIdentifier:this.wrap.getName,a=this.wrap.getAllLayerNodes(),r=0,s=a.length;r<s;r++)if(this.compareNames(t(a[r]),e)){i=a[r];break}return i};T.getChildrenLayers=function(e){var i=[],t=function(e,i){if(e&&e.Layer&&e.Layer.length)for(var a=0;a<e.Layer.length;a++){i[i.length]=e.Layer[a];t(e.Layer[a],i)}};t(e,i);return i};T.compareNames=function(e,i,t){var a=e===i,r=void 0!==t?t:this.ignorePrefixes;if(!a&&r&&e&&i){var s=e.indexOf(":"),o=i.indexOf(":");s>=0&&o<0?a=e.substr(s+1)===i:o>=0&&s<0&&(a=e===i.substr(o+1))}return a};T.getCapabilitiesPromise=function(){return this._capabilitiesPromise};T.getResolutions=function(){return this.wrap.getResolutions()};T.searchSubLayers=function(e){this.patternFn||(this.patternFn=function(e){return e=(e=(e=(e=(e=(e=(e=e.replace(/[^a-z\d\xe1\xe9\xed\xf3\xfa\xfc\xf1]/gi,"\\$&")).replace(/(a|\xe1)/gi,"(a|\xe1)")).replace(/(e|\xe9)/gi,"(e|\xe9)")).replace(/(i|\xed)/gi,"(i|\xed)")).replace(/(o|\xf3)/gi,"(o|\xf3)")).replace(/(u|\xfa|\xfc)/gi,"(u|\xfa|\xfc)")).replace(/n/gi,"(n|\xf1)")});if(e&&e.length&&e.length>=3){var i=this,t=null;if(this.lastPattern&&e.indexOf(this.lastPattern)>=0)t=this.lastMatches;else if(i.availableNames&&i.availableNames.length>0){t=[];for(var a=0;a<i.availableNames.length;a++){var r=i.getLayerNodeByName(i.availableNames[a]);if(r){t[t.length]=r;t=t.concat(i.getChildrenLayers(r))}}}else t=i.wrap.getAllLayerNodes();var s=this.patternFn(e),o=new RegExp(s,"i"),n=t.map(function(e,t){delete e.tcScore;e.tcPosition=t;i.wrap.normalizeLayerNode(e);var a=e.Title.trim(),r=o.exec(a),s=r?r.index:-1,n=-1;if(e.Abstract){var l=e.Abstract.trim(),c=o.exec(l);n=c?c.index:-1}r&&a==r[0]?e.tcScore=20:0==s?e.tcScore=15:s>-1?e.tcScore=10:0==n?e.tcScore=5:n>-1&&(e.tcScore=1);return e.tcScore?e:null}).filter(function(e){return null!=e}).sort(function(e,i){if(i.tcScore===e.tcScore){var t=TC.Util.replaceAccent(e.Title),a=TC.Util.replaceAccent(i.Title);return t<a?-1:t>a?1:0}return i.tcScore-e.tcScore});this.lastPattern=e;this.lastMatches=n;return n}return[]};T.getGetMapUrl=function(){return function(e){var i=e;if(e){var t=e.match(/\??SERVICE=\w+&/i);t&&(i=i.replace(t[0],""))}return i}(this.wrap.getGetMapUrl())};T.getPreferredInfoFormat=function(){for(var e=null,i=this.wrap.getInfoFormats(),t=0;t<TC.wrap.layer.Raster.infoFormatPreference.length;t++){var a=TC.wrap.layer.Raster.infoFormatPreference[t];if($.inArray(a,i)>=0){e=a;break}}return e};T.getLegendGraphicImage=function(){var e=this,i=$.Deferred();if(e.options.params.base64LegendSrc)return i.resolve(e.options.params.base64LegendSrc);if("function"==typeof window.btoa){for(var t=e.names[0],a=e.wrap.getInfo(t),r=new XMLHttpRequest,s=a.legend[0].src.split("?"),o=s[1].split("&"),n=e.options.params.sld_body?"sld_body="+e.options.params.sld_body:"",l=0;l<o.length;l++){var c=o[l].split("=");c&&c.length>1&&c[1]&&(n+="&"+o[l])}e.options.params.env&&(n+="&"+e.options.params.env);r.open("POST",s[0],!0);r.setRequestHeader("Content-Type","application/x-www-form-urlencoded");r.responseType="arraybuffer";r.onload=function(t){if(200===this.status){for(var a=new Uint8Array(this.response),s=a.length,o=new Array(s);s--;)o[s]=String.fromCharCode(a[s]);var n=o.join(""),l=r.getResponseHeader("content-type");if(0===l.indexOf("image")){var c;c="data:"+l+";base64,"+window.btoa(n);e.options.params.base64LegendSrc=c;i.resolve(c)}}};r.send(n)}else i.reject("Funci\xf3n window.btoa no soportada por el navegador");return i.promise()};T.getUrl=function(e){return e};T._onQuarantine=function(e){return e};T.getWebGLUrl=function(e,i){var t=this,a=new $.Deferred;if(t.getWebGLUrl!==T.getWebGLUrl)a.resolve(t.getWebGLUrl.call(t,e));else{TC.Util.consoleRegister("Buscamos en las capas de trabajo si exite alguna del mismo servicio.");TC.Util.consoleRegister("Si hay capa hermana asignamos la misma funci\xf3n de carga de im\xe1genes sin validar nada.");var r=t.getSiblingLoadedLayer.call(t,function(e){return e.getWebGLUrl.toString()!==T.getWebGLUrl.toString()});if(r){TC.Util.consoleRegister("Tenemos capa hermana, no validamos nada m\xe1s.");t.getWebGLUrl=r.getWebGLUrl;a.resolve(t.getWebGLUrl.call(t,e))}else if(TC.Util.detectIE()){t.getWebGLUrl=t.capabilitiesUrl_;a.resolve(t.capabilitiesUrl_.call(t,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(t.url))?t.getBySSL_(e):e))}else{TC.Util.consoleRegister("No hay capa hermana.");var s=i||document.location.href;if(TC.Util.isSameOrigin(e)){TC.Util.consoleRegister("Escenario mismo origen");t.getWebGLUrl=t.getByUrl_;a.resolve(t.getByUrl_(e))}else{TC.Util.consoleRegister("Escenario cross origin");var o=function(){if(t.geoBBox&&t.geoBBox.length>0){var i=decodeURIComponent(e.split("&").filter(function(e){return e.indexOf("bbox")>-1})[0]).replace("bbox=","").split(",").map(function(e){return parseInt(e)}),r=t.geoBBox[0];if(!r||i[0]>=r[0]&&i[2]<=r[2]&&i[1]>=r[1]&&i[3]<=r[3]){t.getWebGLUrl=t.getByProxy_;a.resolve(t.getByProxy_(e))}else{t.getWebGLUrl=t._onQuarantine;a.resolve(t._onQuarantine(e))}}else{t.getWebGLUrl=t.getByProxy_;a.resolve(t.getByProxy_(e))}};TC.Util.consoleRegister("Comprobamos si existe service worker");if(TC.Util.isSecureURL(s)&&TC.Util.isServiceWorker()){TC.Util.consoleRegister("Hay serviceworker");TC.Util.consoleRegister("Comprobar si tenemos contenido mixto, ya que en la comprobaci\xf3n de CORS el service worker bloquear\xe1 la petici\xf3n si tenemos contenido mixto");if(TC.Util.isSameProtocol(e,s)){TC.Util.consoleRegister("No hay contenido mixto");TC.Util.consoleRegister("Validamos si tiene CORS");C(e).then(function(i){if(i){TC.Util.consoleRegister("Tiene CORS");t.getWebGLUrl=t.getByUrl_;a.resolve(t.getByUrl_(e))}else{TC.Util.consoleRegister("No tiene CORS");o()}})}else{TC.Util.consoleRegister("Comprobamos si soporta SSL: si no, habr\xe1 que proxificar");f.call(t,e,function(){TC.Util.consoleRegister("Validamos si tiene CORS");C(e).then(function(i){if(i){TC.Util.consoleRegister("Tiene CORS");t.getWebGLUrl=t.getBySSL_;a.resolve(t.getBySSL_(e))}else{TC.Util.consoleRegister("No tiene CORS");t.getWebGLUrl=t.getByProxy_;a.resolve(t.getByProxy_(e))}})},function(){TC.Util.consoleRegister("Al no soportar SSL tenemos contenido mixto, que bloquear\xe1 el service worker: proxificamos");t.getWebGLUrl=t.getByProxy_;a.resolve(t.getByProxy_(e))})}}else{TC.Util.consoleRegister("No hay serviceworker");C(e).then(function(i){if(i){TC.Util.consoleRegister("Tiene cabeceras CORS");t.getWebGLUrl=t.getByUrl_;a.resolve(t.getByUrl_(e))}else{TC.Util.consoleRegister("NO tiene cabeceras CORS");o()}})}}}}return a};T.getLegendUrl=function(e,i){var t=this,a=i||document.location.href,r=/^(https?:\/\/)/i,s=function(e){return!TC.Util.isSameProtocol(e,t.url)&&r.test(e)&&r.test(t.url)&&TC.Util.isSecureURL(t.url.match(r)[1])?e.replace(e.match(r)[1],t.url.match(r)[1]):TC.Util.isServiceWorker()?TC.Util.isSecureURL(e)?e:t.getBySSL_(e):e};return TC.Util.isServiceWorker()?s(e):TC.Util.isSameProtocol(e,a)?/^(https?:)?\/\//i.test(e)?e.substr(e.indexOf("//")):e:TC.Util.isSecureURL(a)&&!TC.Util.isSecureURL(e)?s(e):e};T.getFeatureInfoUrl=function(e){return this.capabilitiesUrl_.call(this,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(e):e)};T.getFeatureUrl=function(e){return this.capabilitiesUrl_.call(this,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(e):e)};T.getSiblingLoadedLayer=function(e){var i=this;if(i.map){return i.map.baseLayers.slice(0).concat(i.map.workLayers.slice(0)).filter(function(t){return(t.type===TC.Consts.layerType.WMS||t.type===TC.Consts.layerType.WMTS)&&(t.capabilities===i.capabilities||t.url===i.url)&&(!e||!$.isFunction(e)||e(t))})[0]||null}return null};T.getImageLoad=function(e,i,t){var a=this,r=t||document.location.href,s="POST"===a.options.method;if(a.type===TC.Consts.layerType.WMTS){var o,n,l;if("KVP"!=a.encoding){var c=i.replace("."+a.format.split("/")[1],"");o=(g=c.split("/").slice(c.split("/").length-3).map(function(e){return parseInt(e)}))[0];n=g[1];l=g[2]}else{var g;if((g=/.*TileMatrix=(\d*)&TileCol=(\d*)&TileRow=(\d*)/i.exec(i))&&4==g.length){o=(g=g.slice(1).map(function(e){return parseInt(e)}))[0];n=g[2];l=g[1]}}if(o&&n&&l){var p=a.wrap.getWMTSLayer();if(p){var m=p.TileMatrixSetLink.filter(function(e){return e.TileMatrixSet===a.matrixSet});if(m.length>0&&m[0].TileMatrixSetLimits.length>0){var u=m[0].TileMatrixSetLimits.sort(function(e,i){return parseInt(e.TileMatrix)>parseInt(i.TileMatrix)?1:parseInt(e.TileMatrix)<parseInt(i.TileMatrix)?-1:0})[o];if(u&&a.map&&a.map.on3DView&&!(u.MinTileRow<=n&&u.MaxTileRow>=n&&u.MinTileCol<=l&&u.MaxTileCol>=l)){console.log("Prevenimos petici\xf3n fuera de matrix set, cargamos imagen en blanco");a.imageLoad_blank_.call(a,e);return}}}}}if(a.imageLoad_)a.imageLoad_.call(a,e,i);else{TC.Util.consoleRegister("Buscamos en las capas de trabajo si exite alguna del mismo servicio.");TC.Util.consoleRegister("Si hay capa hermana asignamos la misma funci\xf3n de carga de im\xe1genes sin validar nada.");var f=a.getSiblingLoadedLayer.call(a,function(e){return $.isFunction(e.imageLoad_)});if(!s&&f){TC.Util.consoleRegister("Hay capa hermana cargada, asignamos mismo m\xe9todo de carga");a.imageLoad_=f.imageLoad_;a.getUrl=f.getUrl;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("No hay capa hermana, pasamos a gestionar");if(TC.Util.isSameOrigin(i)){TC.Util.consoleRegister("Escenario mismo origen");a.imageLoad_=s?T.imageLoadHttpRequest_:T.imageLoad;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("Escenario cross origin");if(s){a.imageLoad_=T.imageLoad_POST;a.imageLoad_.call(a,e,i);return}TC.Util.consoleRegister("Comprobamos si existe service worker");if(TC.Util.isSecureURL(r)&&TC.Util.isServiceWorker())a.imageLoad_ServiceWorkerCrossOrigin.call(a,e,i);else{TC.Util.consoleRegister("No hay serviceworker");TC.Util.consoleRegister("Siguiente paso: valoramos si el canvas debe mantenerse exportable");if(!a.map||a.map&&!a.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");a.imageLoad_=T.imageLoad;a.imageLoad_.call(a,e,i)}else a.imageLoad_ExportableCrossOrigin.call(a,e,i)}}}}};T.imageLoad_POST=function(e,i){this.getUrl=this.capabilitiesUrl_;this.imageLoadHttpRequest_.call(this,e,!TC.Util.isSecureURL(i)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(i):i)};T.imageLoad_ServiceWorkerCrossOrigin=function(e,i,t){var a=this,r=t||document.location.href;TC.Util.consoleRegister("Hay serviceworker");TC.Util.consoleRegister("Comprobar si tenemos contenido mixto, ya que en la comprobaci\xf3n de CORS el service worker bloquear\xe1 la petici\xf3n si tenemos contenido mixto");if(TC.Util.isSameProtocol(i,r)){TC.Util.consoleRegister("No tenemos contenido mixto");TC.Util.consoleRegister("Valoramos si el canvas debe mantenerse exportable");if(!a.map||a.map&&!a.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");a.imageLoad_=T.imageLoad;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("Hay exportaci\xf3n a imagen");TC.Util.consoleRegister("Validamos si tiene CORS");$.when(C(a.names.length?a.getUrl(i):TC.Consts.BLANK_IMAGE,e)).then(function(t){if(t){TC.Util.consoleRegister("Tiene cabeceras CORS");a.imageLoad_=T.imageLoad_CrossOrigin;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("No tiene cabeceras CORS");a.imageLoad_=T.imageLoad_CrossOriginNoCORS;a.imageLoad_.call(a,e,i)}})}}else{TC.Util.consoleRegister("Comprobamos si soporta SSL: si no, habr\xe1 que proxificar");f.call(a,i,function(){TC.Util.consoleRegister("Validamos si debemos mantener un canvas limpio");if(!a.map||a.map&&!a.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");a.imageLoad_=T.imageLoad;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("Hay exportaci\xf3n a imagen");TC.Util.consoleRegister("Validamos si tiene CORS");$.when(C(a.names.length?a.getBySSL_(i):TC.Consts.BLANK_IMAGE,e)).then(function(t){if(t){TC.Util.consoleRegister("Tiene CORS");a.getUrl=a.getBySSL_;a.imageLoad_=T.imageLoad_CrossOrigin;a.imageLoad_.call(a,e,i)}else{TC.Util.consoleRegister("No tiene CORS");a.imageLoad_=T.imageLoad_CrossOriginNoCORS;a.imageLoad_.call(a,e,i)}})}},function(){TC.Util.consoleRegister("Al no soportar SSL tenemos contenido mixto, que bloquear\xe1 el service worker: proxificamos");a.imageLoad_=T.imageLoad_CrossOriginNoCORS;a.imageLoad_.call(a,e,i)})}};T.imageLoad_ExportableCrossOrigin=function(e,i){var t=this;TC.Util.consoleRegister("El canvas debe manternerse exportable");TC.Util.consoleRegister("Primer paso: validamos si navegamos mediante InternetExplorer. IE es m\xe1s restrictivo en cuanto a la exportaci\xf3n en casos de cross origin");if(TC.Util.detectIE()){TC.Util.consoleRegister("Segundo paso: al navegar mediante IE y haber crossOrigin comprobamos si el servicio cuenta con cabeceras CORS o no");$.when(C(t.names.length?t.getUrl(i):TC.Consts.BLANK_IMAGE,e)).then(function(a){if(a){TC.Util.consoleRegister("Tiene cabeceras CORS");t.imageLoad_=T.imageLoad_CrossOrigin;t.imageLoad_.call(t,e,i)}else{TC.Util.consoleRegister("No tiene cabeceras CORS");t.imageLoad_=T.imageLoad_IE_CrossOriginNoCORS;t.imageLoad_.call(t,e,i)}})}else{TC.Util.consoleRegister("No es IE");t.imageLoad_=T.imageLoad_CrossOrigin;t.imageLoad_.call(t,e,i)}};T.imageLoad_CrossOriginNoCORS=function(e,i){TC.Util.consoleRegister("Proxificamos la url de la imagen para esta petici\xf3n y las siguientes.");this.getUrl=this.getByProxy_;this.imageLoadHttpRequest_.call(this,e,i)};T.imageLoad_IE_CrossOriginNoCORS=function(e,i){this.imageLoad_CrossOriginNoCORS.call(this,e,i)};T.imageLoad_CrossOrigin=function(e,i){var t=this,a=e.getImage();a.crossOrigin="anonymous";a.onerror=function(){if(t.ignoreProxification)t.imageLoad_blank_.call(t,e);else{TC.Util.consoleRegister("La carga de imagen ha dado un error, verificamos si se trata de un 404 u otro tipo de error, tenemos que repetir la petici\xf3n por ajax para poder conocer el status del error, la carga por src no muestra el tipo de error");$.when(u(i,function(e){TC.Util.consoleRegister("Habr\xe1 sido algo moment\xe1neo, no hago nada")},function(r){if(r&&404===r.status){TC.Util.consoleRegister("Se trata de un 404, cargo imagen en blanco y nada m\xe1s.");t.imageLoad_blank_.call(t,e)}else if(400===r.status);else{TC.Util.consoleRegister("No es un 404");t.getUrl=t.getByProxy_;a.onerror=t.imageLoadingError_.bind(t,e,"blob",t.imageLoadedBlob_);a.src=t.names.length?t.getUrl(i):TC.Consts.BLANK_IMAGE;e.load()}}))}};a.src=t.names.length?t.getUrl(i):TC.Consts.BLANK_IMAGE};T.imageLoad=function(e,i){var t=this,a=e.getImage();a.onerror=function(){a.crossOrigin="anonymous";a.onerror=t.imageLoadingError_.bind(t,e,"blob",t.imageLoadedBlob_);a.src=t.names.length?t.getUrl(i):TC.Consts.BLANK_IMAGE};a.src=t.names.length?t.getUrl(i):TC.Consts.BLANK_IMAGE};var U=function(){return this.wrap&&this.wrap.$events?this.wrap.$events:$(this)};T.imageLoadHttpRequest_=function(e,i){var t="",a="POST"===this.options.method;if(a){U.call(this).trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e}));for(var r=i.split("?"),s=r[1].split("&"),o=0;o<s.length;o++){var n=s[o].split("=");n&&n.length>1&&n[1]&&"LAYERS"!==n[0]&&(t+="&"+s[o])}i=r[0]}var l=new XMLHttpRequest;try{l.open(a?this.options.method:"GET",this.names.length?this.getUrl(i):TC.Consts.BLANK_IMAGE);a&&l.setRequestHeader("Content-Type","application/x-www-form-urlencoded");l.responseType="blob";l.onload=this.imageLoadedBlob_.bind(this,l,e);l.onerror=this.imageLoadingError_.bind(this,e,"blob",this.imageLoadedBlob_);t?l.send(t):l.send()}catch(i){this.imageLoadingError_.call(this,e,"blob",this.imageLoadedBlob_)}};T.imageLoadingError_=function(e,i,t){var a=this;e.getImage().onerror=void 0;if(a.ignoreProxification)a.imageLoad_blank_.call(a,e);else{TC.Util.consoleRegister("Se ha producido un error en la petici\xf3n de imagen. Proxificamos la url de la imagen para esta petici\xf3n y las siguientes.");a.getUrl=a.getByProxy_;var r=new XMLHttpRequest;r.open("GET",a.getUrl(e.getImage().getAttribute("src")||e.src_));r.responseType=i;TC.Util.consoleRegister("Si en la gesti\xf3n del error vuelve a dar error, no intentamos nada m\xe1s, cargamos una imagen en blanco y lanzamos el evento de error.");r.onerror=function(){U.call(a).trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}));a.imageLoad_blank_.call(a,e)};r.onload=t.bind(a,r,e);r.send()}};T.imageLoadedBlob_=function(e,i){var t=this;if(t.imageLoad_!==T.imageLoadHttpRequest_){TC.Util.consoleRegister("Si hemos llegado hasta aqu\xed es que hemos gestionado un error, por lo tanto: modificamos el m\xe9todo de carga layerProto.imageLoadHttpRequest_");t.imageLoad_=T.imageLoadHttpRequest_}var a=i.getImage();if(e.status>=400&&e.status<=500){U.call(t).trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:i,error:{code:e.status,text:e.statusText}}));t.imageLoad_blank_.call(t,i)}else if(e.response&&e.response.type&&-1===e.response.type.indexOf("image"))t.imageLoad_blank_.call(t,i);else if(200===e.status){var r=URL.createObjectURL(e.response);a.onload=function(e){URL.revokeObjectURL(e.target.src);U.call(t).trigger($.Event(TC.Consts.event.TILELOAD,{tile:i}))};a.setAttribute("src",r)}};T.imageLoad_blank_=function(e){var i=e.getImage();i.crossOrigin="anonymous";i.src=TC.Consts.BLANK_IMAGE};T.getWFSCapabilitiesPromise=function(){"undefined"==typeof WFSCapabilities&&TC.syncLoadJS(TC.apiLocation+"TC/layer/WFSCapabilitiesParser");var e=this.options.url.replace(/service=wms/i,"service=wfs").replace(/\/wms(\/|\?|\b)/i,"$'/wfs/"),i=$.Deferred(),t=e.substring(e.indexOf("://")<0?0:e.indexOf("://")+3);if(TC.WFScapabilities[t]){setTimeout(function(){i.resolve(TC.WFScapabilities[t])},100);return i}var a={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};$.ajax({url:this.getUrl(e+"?"+$.param(a)),type:"GET"}).then(function(){var e,a;a=jQuery.isXMLDoc(arguments[0])?arguments[0]:(new DOMParser).parseFromString(arguments[0],"text/xml");var r=$(a).find("ServiceException");0===r.length&&(r=$(a).find("ExceptionText"));if(r.length>0)i.reject(null,"error",r.html());else{try{e=WFSCapabilities.Parse(a)}catch(e){i.reject(e);return}if(e.Operations){var s=e.Operations.GetCapabilities.DCP&&e.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||e.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.WFScapabilities[s]=e;TC.WFScapabilities[t]=e;i.resolve(e)}else i.reject(null)}},function(e,t,a){i.reject(e,t,a)});return i};T.getFallbackLayer=function(){const e=this;if(e.fallbackLayer instanceof TC.Layer)return e.fallbackLayer;if(e.options.fallbackLayer){var i=e.options.fallbackLayer;if("string"==typeof i){(e.map?e.map.options.availableBaseLayers:TC.Cfg.availableBaseLayers).forEach(function(i){if(e.options.fallbackLayer===i.id){e.fallbackLayer=new TC.layer.Raster($.extend({},i,{isBase:!0,stealth:!0,map:e.map}));e.fallbackLayer.firstOption=e}})}else if(i instanceof TC.Layer){e.fallbackLayer=i;e.fallbackLayer.firstOption=e}else{e.fallbackLayer=new TC.layer.Raster($.extend({},i,{id:TC.getUID(),isBase:!0,stealth:!0,title:layer.title,map:e.map}));e.fallbackLayer.firstOption=e}return e.fallbackLayer}return null}}();var esriParser={parse:function(e){var i=[],t=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===t.documentElement.tagName)for(var a=t.documentElement.getElementsByTagName("FeatureInfoCollection"),r=0,s=a.length;r<s;r++)for(var o=a[r],n=o.getAttribute("layername"),l=o.getElementsByTagName("FeatureInfo"),c=0,g=l.length;c<g;c++){for(var p=l[c].getElementsByTagName("Field"),m={},u=0,f=p.length;u<f;u++){var d=p[u];m[getElementText(d.getElementsByTagName("FieldName")[0])]=getElementText(d.getElementsByTagName("FieldValue")[0])}var C=new ol.Feature(m);C.setId(n+"."+TC.getUID());i[i.length]=C}return i}};