TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[];TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS);TC.control.StreetView=function(){this._sv=null;this._mapActiveControl=null;TC.Control.apply(this,arguments);this.viewDiv=null;this._startLonLat=null};TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv";t.template={};t.template[t.CLASS]={compiler:[8,">= 4.3.0"],main:function(e,t,o,n,i){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-sv-btn" title="'+e.escapeExpression(s(o,"i18n").call(null!=t?t:e.nullContext||{},"sv.tip",{name:"i18n",hash:{},data:i,loc:{start:{line:1,column:34},end:{line:1,column:51}}}))+'">\r\n    <div class="tc-ctl-sv-drag"></div>\r\n</div>'},useData:!0};t.template[t.CLASS+"-view"]={compiler:[8,">= 4.3.0"],main:function(e,t,o,n,i){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-sv-btn-close" title="'+e.escapeExpression(s(o,"i18n").call(null!=t?t:e.nullContext||{},"closeStreetView",{name:"i18n",hash:{},data:i,loc:{start:{line:1,column:40},end:{line:1,column:66}}}))+'"></div>'},useData:!0};const o=function(){var e=document.createEvent("HTMLEvents");e.initEvent("resize",!0,!1);this.map.div.querySelector("canvas").dispatchEvent(e)};var n=function(e){const t=e.viewDiv,n=function(){t.removeEventListener("transitionend",n);o.call(e)};t.addEventListener("transitionend",n);setTimeout(function(){o.call(e)},1e3);e.layer.clearFeatures();e.div.querySelector("."+e.CLASS+"-btn").classList.remove(TC.Consts.classes.CHECKED);e.div.querySelector("."+e.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);e.map.div.classList.remove(e.CLASS+"-active");e._startLonLat=null};t.register=function(t){const o=this;if(!o.viewDiv){o.viewDiv=TC.Util.getDiv(o.options.viewDiv);o.viewDiv.classList.add(o.CLASS+"-view",TC.Consts.classes.HIDDEN);o.options.viewDiv||t.div.insertAdjacentElement("beforebegin",o.viewDiv)}const i=TC.Control.prototype.register.call(o,t),s=o.options.googleMapsKey||t.options.googleMapsKey;s&&(e+="&key="+s);o.layer=null;for(var a=o.getUID(),r=0;r<t.workLayers.length;r++){var l=t.workLayers[r];if(l.type===TC.Consts.layerType.VECTOR&&l.id===a){o.layer=l;break}}o.layer||t.loaded(function(){t.addLayer({id:a,owner:o,stealth:!0,type:TC.Consts.layerType.VECTOR}).then(function(e){o.layer=e})});o.renderPromise().then(function(){TC.loadJS(!window.Draggabilly,[TC.apiLocation+TC.Consts.url.DRAGGABILLY],function(){const e=new Draggabilly(o.div.querySelector("."+o.CLASS+"-drag"),{containment:o.map.div});e.on("dragStart",function(e){!function(e){e.div.querySelector("."+e.CLASS+"-btn").classList.add(TC.Consts.classes.CHECKED);e.map.div.classList.add(e.CLASS+"-active")}(o)});e.on("dragEnd",function(t){!function(e){var t=!1;const o=e.div.querySelector("."+e.CLASS+"-btn"),i=e.div.querySelector("."+e.CLASS+"-drag");var s=o.getBoundingClientRect(),a=i.getBoundingClientRect();i.classList.add(TC.Consts.classes.HIDDEN);if(a.top<s.top||a.top>s.bottom||a.left<s.left||a.left>s.right){t=!0;for(var r=e.map.getExtent(),l=[r[2],r[3]],c=0;c<16;c++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+c,width:48,height:48,anchor:[0,1]});var v=e.map.div.getBoundingClientRect(),d=(a.left*window.devicePixelRatio+a.right*window.devicePixelRatio)/2-v.left*window.devicePixelRatio,p=a.bottom*window.devicePixelRatio-v.top*window.devicePixelRatio,C=e.map.wrap.getCoordinateFromPixel([d,p]);e.callback(C)}else n(e)}(o);e.setPosition(0,0)})});o.viewDiv.querySelector("."+o.CLASS+"-btn-close").addEventListener(TC.Consts.event.CLICK,function(e){e.stopPropagation();o.closeView()},{passive:!0})},function(e,t,o){TC.error("Error de renderizado StreetView")});return i};t.render=function(){const e=this;return e._set1stRenderPromise(new Promise(function(t,o){e.renderData(null,function(){e.getRenderedHtml(e.CLASS+"-view",null).then(function(o){setTimeout(function(){e.viewDiv.innerHTML=o;t(e)},300)}).catch(function(e){TC.error(e)})})}))};var i=0;t.callback=function(t){var s=this,a=function(e){if(s._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],s.map.crs,"EPSG:4326");s._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},r=function(e){if(s._sv){var t=e.getBounds();s._startLonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],s.map.crs,"EPSG:4326")}},l=s.map.getLoadingIndicator();l&&(i=l.addWait(i));const c=s.map.div;var v=function(e,o){s.layer.clearFeatures();var n,i;if(e){var l=e.getPosition();n=TC.Util.reproject([l.lng(),l.lat()],"EPSG:4326",s.map.crs);i=e.getPov().heading}else{n=t;i=0}s.map.addMarker(n,{cssClass:"tc-marker-sv-"+(Math.round(16*i/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:s.layer,showsPopup:!1});Promise.all(s.map._markerPromises).then(function(){s.layer.wrap.setDraggable(!0,a,r)});if(o){var v=function(){s.map.setCenter(n)};c.classList.contains(TC.Consts.classes.COLLAPSED)?v():setTimeout(v,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){v();const e=s.viewDiv,a=TC.Util.reproject(t,s.map.crs,"EPSG:4326"),r=new google.maps.LatLng(a[1],a[0]);(new google.maps.StreetViewService).getPanorama({location:r,preference:google.maps.StreetViewPreference.BEST},function(t,a){if(a!==google.maps.StreetViewStatus.OK){l&&l.removeWait(i);setTimeout(function(){TC.alert(a===google.maps.StreetViewStatus.ZERO_RESULTS?s.getLocaleString("noStreetView"):s.getLocaleString("streetViewUnknownError"));s.layer.wrap.setDraggable(!1);n(s)},100)}else{const t=function(n){if(s._transitioning&&("width"===n.propertyName||"height"===n.propertyName)){s._transitioning=!1;l&&l.removeWait(i);const n=document.createEvent("HTMLEvents");n.initEvent("resize",!1,!1);c.dispatchEvent(n);o.call(s);e.removeEventListener("transitionend",t);var a={position:r,pov:{heading:0,pitch:0},zoom:1,fullscreenControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},imageDateControl:!0};if(s._sv){s._sv.setOptions(a);s._sv.setVisible(!0)}else{s._sv=new google.maps.StreetViewPanorama(e,a);google.maps.event.addListener(s._sv,"position_changed",function(){v(s._sv,e.classList.contains(TC.Consts.classes.VISIBLE))});google.maps.event.addListener(s._sv,"pov_changed",function(){if(s.layer.features&&s.layer.features.length>0){var e=s.layer.features[0];delete e.options.url;e.options.cssClass="tc-marker-sv-"+(Math.round(16*s._sv.getPov().heading/360)+16)%16;e.setStyle(e.options)}});google.maps.event.addListener(s._sv,"status_changed",function(){var e=s._sv.getStatus();if(e!==google.maps.StreetViewStatus.OK){s._sv.setVisible(!1);TC.alert(e===google.maps.StreetViewStatus.ZERO_RESULTS?s.getLocaleString("noStreetView"):s.getLocaleString("streetViewUnknownError"));if(s._startLonLat){s._sv.setVisible(!0);s._sv.setPosition({lng:s._startLonLat[0],lat:s._startLonLat[1]})}else{s.layer.wrap.setDraggable(!1);s.closeView()}}})}}};s._transitioning=!0;e.addEventListener("transitionend",t);if(!s.options.viewDiv){const e=c.getBoundingClientRect();s.viewDiv.style.height=e.height+"px";s.viewDiv.style.width=e.width+"px"}c.classList.add(TC.Consts.classes.COLLAPSED);e.style.left="";e.style.top="";e.classList.remove(TC.Consts.classes.HIDDEN);e.classList.add(TC.Consts.classes.VISIBLE);setTimeout(function(){t({propertyName:"width"})},1e3);const n=document.body.querySelector("header");n&&(n.style.display="none");if(s.map.activeControl){s._previousActiveControl=s.map.activeControl;s.map.activeControl.deactivate(!0)}v(s._sv)}})}else n(s)},!1,!0)};t.closeView=function(){const e=this,t=e.map.div,o=e.viewDiv,i=function(){t.classList.remove(TC.Consts.classes.COLLAPSED);const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);t.dispatchEvent(e)},s=function(e){if("width"===e.propertyName||"height"===e.propertyName){o.removeEventListener("transitionend",s);i()}};o.removeEventListener("transitionend",s);o.addEventListener("transitionend",s);setTimeout(i,1e3);if(!e.options.viewDiv){e.viewDiv.style.removeProperty("height");e.viewDiv.style.removeProperty("width")}o.classList.add(TC.Consts.classes.HIDDEN);o.classList.remove(TC.Consts.classes.VISIBLE);e.div.querySelector("."+e.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);e.layer.wrap.setDraggable(!1);n(e);e._sv.setVisible(!1);const a=document.body.querySelector("header");a&&(a.style.display="");e._previousActiveControl&&e._previousActiveControl.activate()}}();
//# sourceMappingURL=../maps/control/StreetView.min.js.map