TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[];TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS);TC.control.StreetView=function(){this._templatePromise=$.Deferred();this._sv=null;this._mapActiveControl=null;TC.Control.apply(this,arguments);this.options.googleMapsKey&&(e+="&key="+this.options.googleMapsKey);this.viewDiv=null;this._$viewDiv=null;this._startLonLat=null};TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/StreetView.html";t.template[t.CLASS+"-view"]=TC.apiLocation+"TC/templates/StreetViewView.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn" title="').h("i18n",t,{},{$key:"sv.tip"}).w('"><div class="tc-ctl-sv-drag"></div></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-view"]=function(){dust.register(t.CLASS+"-view",e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn-close" title="').h("i18n",t,{},{$key:"closeStreetView"}).w('"></div>')}e.__dustBody=!0;return e}}var s=function(e){e.layer.clearFeatures();e._$div.find("."+e.CLASS+"-btn").removeClass(TC.Consts.classes.CHECKED);e._$div.find("."+e.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN);$(e.map.div).removeClass(e.CLASS+"-active");e._startLonLat=null};t.register=function(e){var t=this;if(!t._$viewDiv){t.viewDiv=TC.Util.getDiv(t.options.viewDiv);t._$viewDiv=$(t.viewDiv).addClass(t.CLASS+"-view "+TC.Consts.classes.HIDDEN);t.options.viewDiv||t._$viewDiv.insertBefore(e.div)}TC.Control.prototype.register.call(t,e);t.layer=null;for(var o=t.getUID(),a=0;a<e.workLayers.length;a++){var i=e.workLayers[a];if(i.type===TC.Consts.layerType.VECTOR&&i.id===o){t.layer=i;break}}t.layer||e.loaded(function(){e.addLayer({id:o,stealth:!0,type:TC.Consts.layerType.VECTOR}).then(function(e){t.layer=e})});t._templatePromise.then(function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var e=t._$div.find("."+t.CLASS+"-drag");e.drag(function(t,s){e.css({transform:"translate("+s.deltaX+"px, "+s.deltaY+"px)"})}).drag("start",function(e,s){!function(e){e._$div.find("."+e.CLASS+"-btn").addClass(TC.Consts.classes.CHECKED);$(e.map.div).addClass(e.CLASS+"-active")}(t);e.preventDefault();e.stopPropagation()}).drag("end",function(o,a){!function(e){var t=!1,o=e._$div.find("."+e.CLASS+"-btn"),a=e._$div.find("."+e.CLASS+"-drag"),i=o[0].getBoundingClientRect(),n=a[0].getBoundingClientRect();a.addClass(TC.Consts.classes.HIDDEN);if(n.top<i.top||n.top>i.bottom||n.left<i.left||n.left>i.right){t=!0;for(var r=e.map.getExtent(),l=[r[2],r[3]],C=(new Array(16),0);C<16;C++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+C,width:48,height:48,anchor:[0,1]});var c=e.map.div.getBoundingClientRect(),v=(n.left+n.right)/2-c.left,d=n.bottom-c.top,p=e.map.wrap.getCoordinateFromPixel([v,d]);e.callback(p)}else s(e)}(t);e.css({transform:"none"})})});var e=t._$viewDiv;e.find("."+t.CLASS+"-btn-close").on("mouseup",function(o){const a=$(t.map.div),i=function(){a.hasClass(TC.Consts.classes.COLLAPSED)&&a.removeClass(TC.Consts.classes.COLLAPSED).trigger("resize")};e.off("transitionend.tc").on("transitionend.tc",function(t){if("width"===t.originalEvent.propertyName||"height"===t.originalEvent.propertyName){e.off("transitionend.tc");i()}});setTimeout(i,1e3);e.addClass(TC.Consts.classes.HIDDEN).removeClass(TC.Consts.classes.VISIBLE);t._$div.find("."+t.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN);t.layer.wrap.setDraggable(!1);s(t);t._sv.setVisible(!1);o.stopPropagation();var n=t._$div.parents("body").find("header");n.length>0&&n.css("display","");t._previousActiveControl&&t._previousActiveControl.activate()})},function(e,t,s){TC.error("Error de renderizado Streetview")})};t.render=function(){var e=this;TC.Control.prototype.render.call(e,function(){dust.cache[e.CLASS+"-view"]?dust.render(e.CLASS+"-view",null,function(t,s){setTimeout(function(){e._$viewDiv.html(s);t&&TC.error(t);e._templatePromise.resolve()},300)}):TC.error("No hay dust.cache para StreetView")})};var o=0;t.callback=function(t){var a=this,i=function(e){if(a._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],a.map.crs,"EPSG:4326");a._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},n=function(e){if(a._sv){var t=e.getBounds();a._startLonLat=[(t[0]+t[2])/2,(t[1]+t[3])/2]}},r=a.map.getLoadingIndicator();r&&(o=r.addWait(o));var l=$(a.map.div),C=function(e,s){a.layer.clearFeatures();var o,r;if(e){var C=e.getPosition();o=TC.Util.reproject([C.lng(),C.lat()],"EPSG:4326",a.map.crs);r=e.getPov().heading}else{o=t;r=0}a.map.addMarker(o,{cssClass:"tc-marker-sv-"+(Math.round(16*r/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:a.layer,showsPopup:!1});$.when.apply(this,a.map._markerDeferreds).then(function(e){a.layer.wrap.setDraggable(!0,i,n)});if(s){var c=function(){a.map.setCenter(o)};l.hasClass(TC.Consts.classes.COLLAPSED)?c():setTimeout(c,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){C();var e=a._$viewDiv,i=TC.Util.reproject(t,a.map.crs,"EPSG:4326"),n=e.hasClass(TC.Consts.classes.VISIBLE),c={position:new google.maps.LatLng(i[1],i[0]),pov:{heading:0,pitch:0},zoom:1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};if(a._sv)a._sv.setOptions(c);else{a._sv=new google.maps.StreetViewPanorama(e[0],c);google.maps.event.addListener(a._sv,"position_changed",function(){C(a._sv,e.hasClass(TC.Consts.classes.VISIBLE))});google.maps.event.addListener(a._sv,"pov_changed",function(){if(a.layer.features&&a.layer.features.length>0){var e=a.layer.features[0];delete e.options.url;e.options.cssClass="tc-marker-sv-"+(Math.round(16*a._sv.getPov().heading/360)+16)%16;e.setStyle(e.options);a.layer.refresh()}});google.maps.event.addListener(a._sv,"status_changed",function(){var t=a._sv.getStatus();r&&r.removeWait(o);if(t===google.maps.StreetViewStatus.OK){l.addClass(TC.Consts.classes.COLLAPSED).trigger("resize");const t=function(){google.maps.event.trigger(a._sv,"resize")};e.off("transitionend.tc").on("transitionend.tc",function(s){if(("width"===s.originalEvent.propertyName||"height"===s.originalEvent.propertyName)&&!n){n=!0;e.off("transitionend.tc");t()}});setTimeout(t,1e3);if(!e.hasClass(TC.Consts.classes.VISIBLE)){a._sv.setVisible(!0);C(a._sv,!0);if(a.map.activeControl){a._previousActiveControl=a.map.activeControl;a.map.activeControl.deactivate(!0)}setTimeout(function(){e.css("left","").css("top","");e.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)},200);var i=a._$div.parents("body").find("header");i.length>0&&i.css("display","none")}}else{TC.alert(t===google.maps.StreetViewStatus.ZERO_RESULTS?a.getLocaleString("noStreetView"):a.getLocaleString("streetViewUnknownError"));if(a._startLonLat)a.callback(a._startLonLat);else{a.layer.wrap.setDraggable(!1);s(a)}}})}C(a._sv)}else s(a)},!1,!0)}}();