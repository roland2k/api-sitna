TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FileImport=function(){TC.Control.apply(this,arguments);Array.isArray(this.options.formats)?this.formats=this.options.formats:this.formats=[TC.Consts.format.KML,TC.Consts.format.KMZ,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.JSON,TC.Consts.format.WKT,"ZIP",TC.Consts.format.GPKG,"shp","dbf","prj","cst","cpg",TC.Consts.format.GPX];this.layers=[];this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[];this.exportsState=!0};TC.inherit(TC.control.FileImport,TC.Control);!function(){var e=TC.control.FileImport.prototype;e.CLASS="tc-ctl-file";e.template={1:function(e,t,n,o,r){var a,i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return(null!=(a=i(n,"unless").call(null!=t?t:e.nullContext||{},r&&i(r,"first"),{name:"unless",hash:{},fn:e.program(2,r,0),inverse:e.noop,data:r,loc:{start:{line:5,column:163},end:{line:5,column:193}}}))?a:"")+"."+e.escapeExpression(e.lambda(t,t))},2:function(e,t,n,o,r){return","},compiler:[8,">= 4.3.0"],main:function(e,t,n,o,r){var a,i=null!=t?t:e.nullContext||{},s=e.escapeExpression,l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+s(l(n,"i18n").call(i,"openFile",{name:"i18n",hash:{},data:r,loc:{start:{line:1,column:4},end:{line:1,column:23}}}))+"</h2>\r\n<div>\r\n    <p>"+s(l(n,"i18n").call(i,"fileImport.instructions",{name:"i18n",hash:{},data:r,loc:{start:{line:3,column:7},end:{line:3,column:41}}}))+'</p>\r\n    <div class="tc-ctl-file-open">\r\n        <label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" multiple accept="'+(null!=(a=l(n,"each").call(i,null!=t?l(t,"formats"):t,{name:"each",hash:{},fn:e.program(1,r,0),inverse:e.noop,data:r,loc:{start:{line:5,column:146},end:{line:5,column:211}}}))?a:"")+'" />'+s(l(n,"i18n").call(i,"openFile",{name:"i18n",hash:{},data:r,loc:{start:{line:5,column:215},end:{line:5,column:234}}}))+"</label>\r\n    </div>\r\n</div>\r\n"},useData:!0};e.register=function(t){var n=this;const o=TC.Control.prototype.register.call(n,t);if(n.options.enableDragAndDrop){var r=t.wrap.enableDragAndDrop(n.options);e.loadFile=(e=>{r.ProcessFile(e)})}t._bufferFeatures=[];t._fileDropLoadingIndicator=null;document.addEventListener("paste",e=>{if(e.clipboardData.files&&e.clipboardData.files.length)for(var o=0;o<e.clipboardData.files.length;o++)n.loadFile(e.clipboardData.files[o]);else e.clipboardData.items.length||t.toast(n.getLocaleString("fileImport.pasteNotSupported"),{type:TC.Consts.msgType.WARNING})});t.on(TC.Consts.event.FEATURESIMPORT,function(e){const o=e.fileName,r=e.dropTarget,a=e.features,i=e.timeStamp;var s="."+TC.Consts.format.GPX.toLowerCase();if(o.toLowerCase().indexOf(s)!==o.length-s.length&&(r===n.map.div||r===n)){t._fileDropLoadingIndicator||(t._fileDropLoadingIndicator=t.getLoadingIndicator().addWait());t.addLayer({id:n.getUID(),title:o,owner:n,type:TC.Consts.layerType.VECTOR}).then(function(e){e._timeStamp=i;n.layers.push(e);const o=function(e,t){return e.concat(t)};for(var r=function(e){var t=e.geometry;if(t){var r;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:r=[t];break;case TC.feature.MultiPoint&&e instanceof TC.feature.MultiPoint:case TC.feature.Polyline&&e instanceof TC.feature.Polyline:r=t;break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:case TC.feature.Polygon&&e instanceof TC.feature.Polygon:r=t.reduce(o);break;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:r=t.reduce(o).reduce(o)}r&&r.every(function(e){return Math.abs(e[0])<=180&&Math.abs(e[1])<=90})&&e.setCoords(TC.Util.reproject(t,"EPSG:4326",n.map.crs))}return e},s=0,l=a.length;s<l;s++){var c=r(a[s]);e.addFeature(c)}t._bufferFeatures=t._bufferFeatures.concat(e.features);window.dropFilesCounter--;if(0===dropFilesCounter){t.zoomToFeatures(t._bufferFeatures);t._bufferFeatures=[];delete window.dropFilesCounter;var f=n.map.getLoadingIndicator();if(f){f.removeWait(t._fileDropLoadingIndicator);t._fileDropLoadingIndicator=null}}})}}).on(TC.Consts.event.FEATURESIMPORTERROR,function(e){var t,o=e.file.name;t=".kmz"===o.toLowerCase().substr(o.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown";TC.error(e.message?n.getLocaleString(e.message):n.getLocaleString(t,{fileName:o}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(e){TC.error("Nombre del archivo: "+o+" \n Contenido del archivo: \n\n"+e.target.result,TC.Consts.msgErrorMode.EMAIL,"Error en la subida de un archivo")};window.dropFilesCounter--;r.readAsText(e.file);if(0===dropFilesCounter){delete window.dropFilesCounter;var a=n.map.getLoadingIndicator();a&&a.removeWait(n.map.wrap._featureImportWaitId)}}).on(TC.Consts.event.FEATURESIMPORTPARTIAL,function(e){n.map.toast(n.getLocaleString("fileImport.partial.problem",{fileName:e.file.name,table:e.table,reason:e.reason}),{type:TC.Consts.msgType.ERROR})}).on(TC.Consts.event.FEATUREREMOVE,function(e){const t=e.layer;n.layers.indexOf(t)>=0&&(t.features.length||n.map.removeLayer(t))}).on(TC.Consts.event.LAYERREMOVE,function(e){const t=n.layers.indexOf(e.layer);t>=0&&n.layers.splice(t,1)});return o};e.render=function(){const e=this;return e._set1stRenderPromise(e.renderData({formats:e.formats},function(){const t=e.div.querySelector("input[type=file]");t.addEventListener(TC.Consts.event.CLICK,function(e){const t=document.createElement("form"),n=this.parentElement;n.insertBefore(t,this);t.appendChild(this);t.reset();t.insertAdjacentElement("afterend",this);n.removeChild(t)},{passive:!0});t.addEventListener("change",function(t){if(e.map){console.log("salta el change");e.map.wrap.loadFiles(t.target.files,{control:e})}})}))};e.exportState=function(){const e=this;return e.exportsState&&e.layers.length?{id:e.id,layers:e.layers.map(function(e){return{title:e.title,state:TC.Util.extend(e.exportState(),{path:e.features?e.features[0].getPath():void 0})}})}:null};e.importState=function(e){const t=this;if(t.map){const n=[];e.layers.forEach(function(e){n.push(t.map.addLayer({id:t.getUID(),title:e.title,owner:t,type:TC.Consts.layerType.VECTOR}))});Promise.all(n).then(function(n){for(var o=0,r=n.length;o<r;o++){const r=n[o],a=o;r.importState(e.layers[o].state).then(function(){for(var t=0;t<r.features.length;t++)r.features[t].folders=e.layers[a].state.path});t.layers.push(r)}})}}}();
//# sourceMappingURL=../maps/control/FileImport.min.js.map