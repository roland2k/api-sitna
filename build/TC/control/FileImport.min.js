TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FileImport=function(){TC.Control.apply(this,arguments);$.isArray(this.options.formats)?this.formats=this.options.formats:this.formats=[TC.Consts.format.KML,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.WKT,TC.Consts.format.GPX];this.layers=[];this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[]};TC.inherit(TC.control.FileImport,TC.Control);!function(){var t=TC.control.FileImport.prototype;t.CLASS="tc-ctl-file";TC.isDebug?t.template=TC.apiLocation+"TC/templates/FileImport.html":t.template=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"openFile"}).w("</h2><div><p>").h("i18n",e,{},{$key:"fileImport.instructions"}).w('</p><div class="tc-ctl-file-open"><label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" accept="').s(e.get(["formats"],!1),e,{block:o},{}).w('" />').h("i18n",e,{},{$key:"openFile"}).w("</label></div></div>")}e.__dustBody=!0;function o(t,e){return t.w(".").f(e.getPath(!0,[]),e,"h").h("sep",e,{block:n},{})}o.__dustBody=!0;function n(t,e){return t.w(",")}n.__dustBody=!0;return e};t.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);e.options.enableDragAndDrop&&t.wrap.enableDragAndDrop(e.options);t.on(TC.Consts.event.FEATURESIMPORT,function(o){var n="."+TC.Consts.format.GPX.toLowerCase();o.fileName.toLowerCase().indexOf(n)!==o.fileName.length-n.length&&t.addLayer({id:e.getUID(),title:o.fileName,type:TC.Consts.layerType.VECTOR}).then(function(n){e.layers.push(n);const r=function(t,e){return t.concat(e)};for(var a=function(t){var o=t.geometry;if(o){var n;switch(!0){case TC.feature.Point&&t instanceof TC.feature.Point:n=[o];break;case TC.feature.MultiPoint&&t instanceof TC.feature.MultiPoint:case TC.feature.Polyline&&t instanceof TC.feature.Polyline:n=o;break;case TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline:case TC.feature.Polygon&&t instanceof TC.feature.Polygon:n=o.reduce(r);break;case TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon:n=o.reduce(r).reduce(r)}n.every(function(t){return Math.abs(t[0])<=180&&Math.abs(t[1])<=90})&&t.setCoords(TC.Util.reproject(o,"EPSG:4326",e.map.crs))}return t},i=0,s=o.features.length;i<s;i++){var l=a(o.features[i]);n.addFeature(l)}setTimeout(function(){t.zoomToFeatures(n.features)},100)})}).on(TC.Consts.event.FEATURESIMPORTERROR,function(t){var o,n=t.file.name;o=".kmz"===n.toLowerCase().substr(n.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown";TC.error(e.getLocaleString(o,{fileName:n}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(t){TC.error("Nombre del archivo: "+n+" \n Contenido del archivo: \n\n"+t.target.result,TC.Consts.msgErrorMode.EMAIL,"Error en la subida de un archivo")};r.readAsText(t.file)}).on(TC.Consts.event.LAYERREMOVE,function(t){const o=e.layers.indexOf(t.layer);o>=0&&e.layers.splice(o,1)})};t.render=function(){var t=this;t.renderData({formats:t.formats},function(){t._$div.find("input[type=file]").on(TC.Consts.event.CLICK,function(t){$(this).wrap("<form>").closest("form").get(0).reset();$(this).unwrap()}).on("change",function(e){if(t.map){console.log("salta el change");t.map.wrap.loadFiles(e.target.files)}})})};t.exportState=function(){return{id:this.id,layers:this.layers.map(function(t){return{title:t.title,state:t.exportState()}})}};t.importState=function(t){const e=this;if(e.map){const o=[];t.layers.forEach(function(t){o.push(e.map.addLayer({id:e.getUID(),title:t.title,type:TC.Consts.layerType.VECTOR}))});$.when.apply($,o).then(function(){for(var o=0,n=arguments.length;o<n;o++){const n=arguments[o];n.importState(t.layers[o].state);e.layers.push(n)}})}}}();