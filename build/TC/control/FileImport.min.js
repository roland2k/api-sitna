TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FileImport=function(){TC.Control.apply(this,arguments);Array.isArray(this.options.formats)?this.formats=this.options.formats:this.formats=[TC.Consts.format.KML,TC.Consts.format.KMZ,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.JSON,TC.Consts.format.WKT,"ZIP",TC.Consts.format.GPKG,"shp","dbf","prj","cst","cpg",TC.Consts.format.GPX];this.layers=[];this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[];this.exportsState=!0};TC.inherit(TC.control.FileImport,TC.Control);!function(){var t=TC.control.FileImport.prototype;t.CLASS="tc-ctl-file";t.template={1:function(t,e,n,o,r){var a,s=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return(null!=(a=s(n,"unless").call(null!=e?e:t.nullContext||{},r&&s(r,"first"),{name:"unless",hash:{},fn:t.program(2,r,0),inverse:t.noop,data:r,loc:{start:{line:5,column:163},end:{line:5,column:193}}}))?a:"")+"."+t.escapeExpression(t.lambda(e,e))},2:function(t,e,n,o,r){return","},compiler:[8,">= 4.3.0"],main:function(t,e,n,o,r){var a,s=null!=e?e:t.nullContext||{},l=t.escapeExpression,i=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return"<h2>"+l(i(n,"i18n").call(s,"openFile",{name:"i18n",hash:{},data:r,loc:{start:{line:1,column:4},end:{line:1,column:23}}}))+"</h2>\r\n<div>\r\n    <p>"+l(i(n,"i18n").call(s,"fileImport.instructions",{name:"i18n",hash:{},data:r,loc:{start:{line:3,column:7},end:{line:3,column:41}}}))+'</p>\r\n    <div class="tc-ctl-file-open">\r\n        <label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" multiple accept="'+(null!=(a=i(n,"each").call(s,null!=e?i(e,"formats"):e,{name:"each",hash:{},fn:t.program(1,r,0),inverse:t.noop,data:r,loc:{start:{line:5,column:146},end:{line:5,column:211}}}))?a:"")+'" />'+l(i(n,"i18n").call(s,"openFile",{name:"i18n",hash:{},data:r,loc:{start:{line:5,column:215},end:{line:5,column:234}}}))+"</label>\r\n    </div>\r\n</div>\r\n"},useData:!0};t.register=function(t){var e=this;const n=TC.Control.prototype.register.call(e,t);e.options.enableDragAndDrop&&t.wrap.enableDragAndDrop(e.options);t.on(TC.Consts.event.FEATURESIMPORT,function(n){const o=n.fileName,r=n.dropTarget,a=n.features;var s="."+TC.Consts.format.GPX.toLowerCase();o.toLowerCase().indexOf(s)===o.length-s.length||r!==e.map.div&&r!==e||t.addLayer({id:e.getUID(),title:o,owner:e,type:TC.Consts.layerType.VECTOR}).then(function(n){e.layers.push(n);const o=function(t,e){return t.concat(e)};for(var r=function(t){var n=t.geometry;if(n){var r;switch(!0){case TC.feature.Point&&t instanceof TC.feature.Point:r=[n];break;case TC.feature.MultiPoint&&t instanceof TC.feature.MultiPoint:case TC.feature.Polyline&&t instanceof TC.feature.Polyline:r=n;break;case TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline:case TC.feature.Polygon&&t instanceof TC.feature.Polygon:r=n.reduce(o);break;case TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon:r=n.reduce(o).reduce(o)}r&&r.every(function(t){return Math.abs(t[0])<=180&&Math.abs(t[1])<=90})&&t.setCoords(TC.Util.reproject(n,"EPSG:4326",e.map.crs))}return t},s=0,l=a.length;s<l;s++){var i=r(a[s]);n.addFeature(i)}setTimeout(function(){t.zoomToFeatures(n.features)},100)})}).on(TC.Consts.event.FEATURESIMPORTERROR,function(t){var n,o=t.file.name;n=".kmz"===o.toLowerCase().substr(o.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown";TC.error(e.getLocaleString(n,{fileName:o}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(t){TC.error("Nombre del archivo: "+o+" \n Contenido del archivo: \n\n"+t.target.result,TC.Consts.msgErrorMode.EMAIL,"Error en la subida de un archivo")};r.readAsText(t.file)}).on(TC.Consts.event.FEATURESIMPORTPARTIAL,function(t){e.map.toast(e.getLocaleString("fileImport.partial.problem",{fileName:t.file.name,table:t.table,reason:t.reason}),{type:TC.Consts.msgType.ERROR})}).on(TC.Consts.event.FEATUREREMOVE,function(t){const n=t.layer;e.layers.indexOf(n)>=0&&(n.features.length||e.map.removeLayer(n))}).on(TC.Consts.event.LAYERREMOVE,function(t){const n=e.layers.indexOf(t.layer);n>=0&&e.layers.splice(n,1)});return n};t.render=function(){const t=this;return t._set1stRenderPromise(t.renderData({formats:t.formats},function(){const e=t.div.querySelector("input[type=file]");e.addEventListener(TC.Consts.event.CLICK,function(t){const e=document.createElement("form"),n=this.parentElement;n.insertBefore(e,this);e.appendChild(this);e.reset();e.insertAdjacentElement("afterend",this);n.removeChild(e)},{passive:!0});e.addEventListener("change",function(e){if(t.map){console.log("salta el change");t.map.wrap.loadFiles(e.target.files,{control:t})}})}))};t.exportState=function(){const t=this;return t.exportsState&&t.layers.length?{id:t.id,layers:t.layers.map(function(t){return{title:t.title,state:t.exportState()}})}:null};t.importState=function(t){const e=this;if(e.map){const n=[];t.layers.forEach(function(t){n.push(e.map.addLayer({id:e.getUID(),title:t.title,owner:e,type:TC.Consts.layerType.VECTOR}))});Promise.all(n).then(function(n){for(var o=0,r=n.length;o<r;o++){const r=n[o];r.importState(t.layers[o].state);e.layers.push(r)}})}}}();
//# sourceMappingURL=../maps/control/FileImport.min.js.map