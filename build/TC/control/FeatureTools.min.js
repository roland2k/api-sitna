TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.infoShare||TC.syncLoadJS(TC.apiLocation+"TC/control/infoShare");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.Consts.event.DIALOG=TC.Consts.event.DIALOG||"dialog.tc";TC.Consts.event.FEATUREHIGHLIGHT=TC.Consts.event.FEATUREHIGHLIGHT||"featurehighlight.tc";TC.Consts.event.FEATUREDOWNPLAY=TC.Consts.event.FEATUREDOWNPLAY||"featuredownplay.tc";TC.control.FeatureTools=function(){const t=this;TC.Control.apply(t,arguments);t.exportsState=!0;const e=t._classSelector="."+t.CLASS;t._selectors={ELEVATION_CHECKBOX:e+"-dialog-elev input[type=checkbox]",INTERPOLATION_RADIO:"input[type=radio][name=finfo-ip-coords]",INTERPOLATION_DISTANCE:e+"-dialog-ip-m"};t._dialogDiv=TC.Util.getDiv(t.options.dialogDiv);window.$&&(t._$dialogDiv=$(t._dialogDiv));t.options.dialogDiv||document.body.appendChild(t._dialogDiv)};TC.inherit(TC.control.FeatureTools,TC.Control);TC.mix(TC.control.FeatureTools,TC.control.infoShare);!function(){var t=TC.control.FeatureTools.prototype;t.CLASS="tc-ctl-ftools";t.TITLE_SEPARATOR=" \u2022 ";t.FILE_TITLE_SEPARATOR="__";t.template={};t.template[t.CLASS]={compiler:[8,">= 4.3.0"],main:function(t,e,n,o,a){var l=null!=e?e:t.nullContext||{},r=t.escapeExpression,i=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="tc-ctl-ftools">\r\n    <button class="tc-icon-btn tc-ctl-ftools-dl-btn" title="'+r(i(n,"i18n").call(l,"downloadFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:2,column:60},end:{line:2,column:86}}}))+'">'+r(i(n,"i18n").call(l,"download",{name:"i18n",hash:{},data:a,loc:{start:{line:2,column:88},end:{line:2,column:107}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-share-btn" title="'+r(i(n,"i18n").call(l,"shareFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:63},end:{line:3,column:86}}}))+'">'+r(i(n,"i18n").call(l,"share",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:88},end:{line:3,column:104}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-zoom-btn" title="'+r(i(n,"i18n").call(l,"zoomToFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:4,column:62},end:{line:4,column:86}}}))+'">'+r(i(n,"i18n").call(l,"zoomToFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:4,column:88},end:{line:4,column:112}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-elev-btn tc-hidden" title="'+r(i(n,"i18n").call(l,"viewElevation",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:72},end:{line:5,column:96}}}))+'">'+r(i(n,"i18n").call(l,"viewElevation",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:98},end:{line:5,column:122}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-prof-btn tc-hidden" title="'+r(i(n,"i18n").call(l,"viewElevationProfile",{name:"i18n",hash:{},data:a,loc:{start:{line:6,column:72},end:{line:6,column:103}}}))+'">'+r(i(n,"i18n").call(l,"viewElevationProfile",{name:"i18n",hash:{},data:a,loc:{start:{line:6,column:105},end:{line:6,column:136}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-del-btn" title="'+r(i(n,"i18n").call(l,"deleteFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:7,column:61},end:{line:7,column:85}}}))+'">'+r(i(n,"i18n").call(l,"deleteFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:7,column:87},end:{line:7,column:111}}}))+"</button>\r\n</div>"},useData:!0};t.template[t.CLASS+"-dialog"]={compiler:[8,">= 4.3.0"],main:function(t,e,n,o,a){var l=null!=e?e:t.nullContext||{},r=t.escapeExpression,i=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="tc-ctl-ftools-dialog tc-ctl-ftools-share-dialog tc-modal">\r\n    <div class="tc-modal-background tc-modal-close"></div>\r\n    <div class="tc-modal-window">\r\n        <div class="tc-modal-header">\r\n            <h3>'+r(i(n,"i18n").call(l,"feature",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:16},end:{line:5,column:34}}}))+" - "+r(i(n,"i18n").call(l,"share",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:37},end:{line:5,column:53}}}))+'</h3>\r\n            <div class="tc-modal-close"></div>\r\n        </div>\r\n        <div class="tc-modal-body">\r\n            <div class="tc-ctl-ftools-share-dialog-ctl"></div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n'},useData:!0};t.register=function(t){const e=this;t.on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(t){const n=t.control;(n.caller||!n.caller&&n.currentFeature)&&e.addUI(n)}).on(TC.Consts.event.FEATUREHIGHLIGHT,function(t){e.addUI(t.control.getDisplayControl())}).on(TC.Consts.event.FEATUREDOWNPLAY,function(t){e.updateUI(t.control.getDisplayControl())});return new Promise(function(n,o){Promise.all([TC.Control.prototype.register.call(e,t),e.renderPromise()]).then(function(){e.getShareDialog().then(function(){n(e)}).catch(function(t){o(t instanceof Error?t:Error(t))})})})};t.render=function(){const t=this;return t._set1stRenderPromise(Promise.all([t.renderData({elevation:t.options.displayElevation}),t.getRenderedHtml(t.CLASS+"-dialog",{checkboxId:t.getUID(),elevation:t.options.displayElevation},function(e){t._dialogDiv.innerHTML=e})]))};t.addUI=function(t){const e=this,n=t.getMenuElement(),o=function(){return n&&!n.querySelector("."+e.CLASS)};e.getCurrentFeature(t)&&(o()?e.getRenderedHtml(e.CLASS,null,function(a){TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){if(o()){let l=Promise.resolve();const r=t.getContainerElement();if(!r.querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn").length){const o=!t.caller&&t.currentFeature?t.currentFeature:t.caller.highlightedFeature;if(o&&!0===o.showsPopup){e.printControl=new TC.control.Print({target:n,printableElement:r,title:o.id});l=e.printControl.renderPromise()}}l.then(function(){if(o()){const o=(new DOMParser).parseFromString(a,"text/html").body.firstChild;n.appendChild(o);e.updateUI(t);e._setToolButtonHandlers(t);e._decorateDisplay(t)}})}})}):e.updateUI(t))};t._decorateDisplay=function(t){const e=this;t.getContainerElement().querySelectorAll("table.tc-attr").forEach(function(n){if(!t.caller&&t.currentFeature){n.addEventListener(TC.Consts.event.CLICK,function(n){e.zoomToFeatures([e.getCurrentFeature(t)])},{passive:!0});n.classList.add(e.CLASS+"-zoom");n.setAttribute("title",e.getLocaleString("clickToCenter"))}n.querySelectorAll("a, label, input, video, audio").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,function(t){t.stopPropagation()},{passive:!0})})})};t.updateUI=function(t){const e=this,n=t.getMenuElement().querySelector("."+e.CLASS),o=e.getCurrentFeature(t),a=o&&o.layer&&o.layer.owner?o.layer.owner.filterLayer!==o.layer:o&&!!o.layer;if(a)if(o){n.dataset.layerId=o.layer.id;n.dataset.featureId=o.id;const a=!!o.layer.cluster&&o.features.length>1,l=n.querySelector(`.${e.CLASS}-share-btn`);l&&l.classList.toggle(TC.Consts.classes.HIDDEN,a);n.querySelector(`.${e.CLASS}-dl-btn`).classList.toggle(TC.Consts.classes.HIDDEN,a);n.querySelector(`.${e.CLASS}-del-btn`).classList.toggle(TC.Consts.classes.HIDDEN,a);e.getElevationTool().then(function(l){const r=n.querySelector(`.${e.CLASS}-prof-btn`);r&&r.classList.toggle(TC.Consts.classes.HIDDEN,!l||!(TC.feature.Polyline&&o instanceof TC.feature.Polyline||TC.feature.MultiPolyline&&o instanceof TC.feature.MultiPolyline)||!!t.chart);const i=n.querySelector(`.${e.CLASS}-elev-btn`);i&&i.classList.toggle(TC.Consts.classes.HIDDEN,!l||!(o instanceof TC.feature.Point)||a)})}else{delete n.dataset.layerId;delete n.dataset.featureId}e.printControl&&o&&(e.printControl.title=o.id);if(n){n.classList.remove(TC.Consts.classes.ACTIVE);setTimeout(function(){n.classList.toggle(TC.Consts.classes.ACTIVE,!!a)},100)}};const e=function(t){return t&&Array.isArray(t.features)?1===t.features.length?t.features[0]:null:t};t.onDownloadButtonClick=function(t){const n=this;let o=e(n.getFeatureFromElement(t.target.parentElement));o&&n.showDownloadDialog(o)};t.onShareButtonClick=function(t){const o=this,a=e(o.getFeatureFromElement(t.target.parentElement));if(!a)throw"FeatureTools: there is not a feature to share";n(o,{feature:a}).then(async function(t){o.toShare={feature:t};o.showShareDialog()})};t.onZoomButtonClick=function(t){const e=this,n=(o=e.getFeatureFromElement(t.target.parentElement))?Array.isArray(o.features)?o.features:[o]:[];var o;n.length&&e.zoomToFeatures(n)};t.onDeleteButtonClick=function(t){this.removeFeature(this.getFeatureFromElement(t.target.parentElement))};t.onProfileButtonClick=function(t){const n=this,o=e(n.getFeatureFromElement(t.target.parentElement)),a={};o&&n.getElevationControl().then(function(t){if(t){if(o.getGeometryStride()>2){a.originalElevation=!0;a.onlyOriginalElevation=!1;t.setElevationToolOptions({resolution:n.options.resolution||0,sampleNumber:n.options.sampleNumber||0})}else t.setElevationToolOptions(Object.assign({},n.map.elevation&&n.map.elevation.options,n.options.displayElevation));t.displayElevationProfile(o,a)}})};t.onElevationButtonClick=function(t){const n=this;n.getElevationControl().then(o=>o&&o.displayElevationValue(e(n.getFeatureFromElement(t.target.parentElement))))};t._setToolButtonHandlers=function(t){const e=this,n=t.getMenuElement();n.querySelector("."+e.CLASS+"-dl-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.onDownloadButtonClick(t)},{passive:!0});n.querySelector("."+e.CLASS+"-share-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.onShareButtonClick(t)},{passive:!0});n.querySelector("."+e.CLASS+"-zoom-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.onZoomButtonClick(t)},{passive:!0});const o=n.querySelector(`.${e.CLASS}-prof-btn`);o&&o.addEventListener(TC.Consts.event.CLICK,function(t){e.onProfileButtonClick(t)},{passive:!0});const a=n.querySelector(`.${e.CLASS}-elev-btn`);a&&a.addEventListener(TC.Consts.event.CLICK,function(t){e.onElevationButtonClick(t)},{passive:!0});n.querySelector("."+e.CLASS+"-del-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.onDeleteButtonClick(t)},{passive:!0})};t.getElevationControl=async function(){const t=this;if(!t.options.displayElevation)return null;t.elevationControl||(t.elevationControl=await t.map.addControl("elevation",t.options.displayElevation));return t.elevationControl};t.showDownloadDialog=async function(t){const e=this,n=await e.getDownloadDialog();var o={title:e.getLocaleString("feature")+" - "+e.getLocaleString("download"),fileName:e._getFeatureFilename(t)};(e.map.elevation||e.options.displayElevation)&&(o=Object.assign({},o,{elevation:Object.assign({},e.map.elevation&&e.map.elevation.options,e.options.displayElevation)}));o.openCallback=function(){e.map.trigger(TC.Consts.event.DIALOG,{control:n,action:"download"})};n.open(t,o)};t.getCurrentFeature=function(t){return t&&(t.caller&&t.caller.highlightedFeature||t.currentFeature)};t.getFeatureFromElement=function(t){const e=this.map.getLayer(t.dataset.layerId);return e?e.getFeatureById(t.dataset.featureId):null};t.zoomToFeatures=function(t){const e=this;e.map&&e.map.zoomToFeatures(t,{animate:!0})};t.removeFeature=function(t){const e=this,n=function(){t&&t.layer&&t.layer.removeFeature(t)},o=function(){const n=e=>e.caller&&e.caller.highlightedFeature===t&&e.isVisible();e.map.getControlsByClass(TC.control.Popup).filter(n).forEach(t=>t.hide());e.map.getControlsByClass(TC.control.ResultsPanel).filter(n).forEach(t=>t.close())};if(t&&t.layer&&t.layer.owner&&t.layer===t.layer.owner.resultsLayer){n();o()}else TC.confirm(e.getLocaleString("deleteFeature.confirm"),function(){n();o()})};const n=function(t,e){e=e||{};return new Promise(function(n,o){const a=e.feature;if(a){const r=a.clone();r.setId(a.id);r.layer=a.layer;if(e.elevation){var l=!0;!e.elevation.resolution&&r.getGeometryStride()>2&&(l=!1);if(l){const a={crs:t.map.crs,features:[r],maxCoordQuantity:t.options.displayElevation&&t.options.displayElevation.maxCoordQuantity,resolution:e.elevation.resolution,sampleNumber:0};t.getElevationTool().then(function(t){t.setGeometry(a).then(function(t){n(t[0])},function(t){o(t instanceof Error?t:Error(t))})})}else n(r)}else{const t=r.getCoordsArray(),e=t[0];if(e&&e.length>2){t.forEach(function(t){t.length=2});r.setCoords(r.geometry)}n(r)}}else n(null)})};t.getFeatureTitle=function(t){var e="";t&&(e=t.id);return e};t._getFeatureFilename=function(t){return(this.getFeatureTitle(t).toString().replace(new RegExp(this.TITLE_SEPARATOR,"g"),this.FILE_TITLE_SEPARATOR)||this.getLocaleString("feature")).toLowerCase().replace(/\s/gi,"_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)};t.exportState=function(){const t=this;if(t.toShare){const e={};t.toShare.doZoom&&(e.doZoom=t.toShare.doZoom);e.id=t.id;if(t.toShare.feature){let n;const o=t.toShare.feature.clone();o.showsPopup=!0;n=t.toShare.feature.layer.exportState({features:[o]});e.features=n.features;n.crs&&(e.crs=n.crs)}else if(t.toShare.features){e.features=t.toShare.features;if(t.sharedFeaturesLayer){let n=t.sharedFeaturesLayer.exportState();e.features=n.features}t.toShare.crs&&(e.crs=t.toShare.crs)}return e}return null};t.importState=function(t){const e=this;if(e.map&&t.features&&t.features.length){e.toShare={features:t.features};t.crs&&(e.toShare.crs=t.crs);e.map.addLayer({id:e.getUID(),owner:e,type:TC.Consts.layerType.VECTOR,title:e.getLocaleString("foi"),stealth:!0}).then(function(n){e.sharedFeaturesLayer=n;n.importState({features:t.features,crs:t.crs}).then(function(){t.doZoom&&e.map.zoomToFeatures(n.features)})})}}}();
//# sourceMappingURL=../maps/control/FeatureTools.min.js.map