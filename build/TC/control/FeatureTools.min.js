TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.Consts.event.DIALOG=TC.Consts.event.DIALOG||"dialog.tc";TC.Consts.event.FEATUREHIGHLIGHT=TC.Consts.event.FEATUREHIGHLIGHT||"featurehighlight.tc";TC.Consts.event.FEATUREDOWNPLAY=TC.Consts.event.FEATUREDOWNPLAY||"featuredownplay.tc";TC.control.FeatureTools=function(){const e=this;TC.Control.apply(e,arguments);const t=e._classSelector="."+e.CLASS;e._selectors={ELEVATION_CHECKBOX:t+"-dialog-elev input[type=checkbox]",INTERPOLATION_RADIO:"input[type=radio][name=finfo-ip-coords]",INTERPOLATION_DISTANCE:t+"-dialog-ip-m"};e._dialogDiv=TC.Util.getDiv(e.options.dialogDiv);window.$&&(e._$dialogDiv=$(e._dialogDiv));e.options.dialogDiv||document.body.appendChild(e._dialogDiv)};TC.inherit(TC.control.FeatureTools,TC.Control);!function(){var e=TC.control.FeatureTools.prototype;e.CLASS="tc-ctl-ftools";e.TITLE_SEPARATOR=" \u2022 ";e.FILE_TITLE_SEPARATOR="__";e.template={};e.template[e.CLASS]={compiler:[8,">= 4.3.0"],main:function(e,t,n,o,a){var l=null!=t?t:e.nullContext||{},r=e.escapeExpression,i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-ftools">\r\n    <button class="tc-icon-btn tc-ctl-ftools-dl-btn" title="'+r(i(n,"i18n").call(l,"downloadFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:2,column:60},end:{line:2,column:86}}}))+'">'+r(i(n,"i18n").call(l,"download",{name:"i18n",hash:{},data:a,loc:{start:{line:2,column:88},end:{line:2,column:107}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-share-btn" title="'+r(i(n,"i18n").call(l,"shareFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:63},end:{line:3,column:86}}}))+'">'+r(i(n,"i18n").call(l,"share",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:88},end:{line:3,column:104}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-zoom-btn" title="'+r(i(n,"i18n").call(l,"zoomToFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:4,column:62},end:{line:4,column:86}}}))+'">'+r(i(n,"i18n").call(l,"zoomToFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:4,column:88},end:{line:4,column:112}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-del-btn" title="'+r(i(n,"i18n").call(l,"deleteFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:61},end:{line:5,column:85}}}))+'">'+r(i(n,"i18n").call(l,"deleteFeature",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:87},end:{line:5,column:111}}}))+"</button>\r\n</div>"},useData:!0};e.template[e.CLASS+"-dialog"]={compiler:[8,">= 4.3.0"],main:function(e,t,n,o,a){var l=null!=t?t:e.nullContext||{},r=e.escapeExpression,i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-ftools-dialog tc-ctl-ftools-share-dialog tc-modal">\r\n    <div class="tc-modal-background tc-modal-close"></div>\r\n    <div class="tc-modal-window">\r\n        <div class="tc-modal-header">\r\n            <h3>'+r(i(n,"i18n").call(l,"feature",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:16},end:{line:5,column:34}}}))+" - "+r(i(n,"i18n").call(l,"share",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:37},end:{line:5,column:53}}}))+'</h3>\r\n            <div class="tc-modal-close"></div>\r\n        </div>\r\n        <div class="tc-modal-body">\r\n            <div class="tc-ctl-ftools-share-dialog-ctl"></div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n\r\n'},useData:!0};e.register=function(e){const t=this;e.on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(e){const n=e.control;(n.caller||!n.caller&&n.currentFeature)&&t.addUI(n)}).on(TC.Consts.event.FEATUREHIGHLIGHT,function(e){t.addUI(e.control.getDisplayControl())}).on(TC.Consts.event.FEATUREDOWNPLAY,function(e){t.updateUI(e.control.getDisplayControl())});return new Promise(function(n,o){Promise.all([TC.Control.prototype.register.call(t,e),t.renderPromise()]).then(function(){t.map.addControl("share",{id:t.getUID(),div:t._dialogDiv.querySelector(".tc-modal-body ."+t.CLASS+"-share-dialog-ctl"),includeControls:!1}).then(function(e){t._shareCtl=e;n(t)}).catch(function(e){o(e instanceof Error?e:Error(e))})})})};e.render=function(){const e=this;return e._set1stRenderPromise(Promise.all([e.renderData({elevation:e.options.displayElevation}),e.getRenderedHtml(e.CLASS+"-dialog",{checkboxId:e.getUID(),elevation:e.options.displayElevation},function(t){e._dialogDiv.innerHTML=t})]))};e.addUI=function(e){const t=this,n=e.getMenuElement(),o=function(){return n&&!n.querySelector("."+t.CLASS)};o()?t.getRenderedHtml(t.CLASS,null,function(a){TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){if(o()){let l=Promise.resolve();const r=e.getContainerElement();if(!r.querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn").length){const o=!e.caller&&e.currentFeature?e.currentFeature:e.caller.highlightedFeature;if(o&&!0===o.showsPopup){t.printControl=new TC.control.Print({target:n,printableElement:r,title:o.id});l=t.printControl.renderPromise()}}l.then(function(){if(o()){const o=(new DOMParser).parseFromString(a,"text/html").body.firstChild;n.appendChild(o);t.updateUI(e);if(!t.map.options.stateful){const e=o.querySelector("."+t.CLASS+"-share-btn");e.parentElement.removeChild(e)}t._setToolButtonHandlers(e);t._decorateDisplay(e)}})}})}):t.updateUI(e)};e._decorateDisplay=function(e){const t=this;if(!e.caller&&e.currentFeature){const n=e.getContainerElement().querySelector("table.tc-attr");if(n){n.addEventListener(TC.Consts.event.CLICK,function(n){t.zoomToFeature(t.getCurrentFeature(e))},{passive:!0});n.querySelectorAll("a, table label, table input").forEach(function(e){e.addEventListener(TC.Consts.event.CLICK,function(e){e.stopPropagation()},{passive:!0})});n.classList.add(t.CLASS+"-zoom");n.setAttribute("title",t.getLocaleString("clickToCenter"))}}};e.updateUI=function(e){const t=this,n=e.getMenuElement().querySelector("."+t.CLASS),o=t.getCurrentFeature(e),a=o&&o.layer&&o.layer.owner?o.layer.owner.filterLayer!==o.layer:o&&!!o.layer;if(a)if(o){n.dataset.layerId=o.layer.id;n.dataset.featureId=o.id;const e=n.querySelector(`.${t.CLASS}-prof-btn`);e&&e.classList.toggle(TC.Consts.classes.HIDDEN,!(o instanceof TC.feature.Polyline||o instanceof TC.feature.MultiPolyline))}else{delete n.dataset.layerId;delete n.dataset.featureId}t.printControl&&o&&(t.printControl.title=o.id);if(n){n.classList.remove(TC.Consts.classes.ACTIVE);setTimeout(function(){n.classList.toggle(TC.Consts.classes.ACTIVE,!!a)},100)}};e._setToolButtonHandlers=function(e){const t=this,n=e.getMenuElement();n.querySelector("."+t.CLASS+"-dl-btn").addEventListener(TC.Consts.event.CLICK,function(e){t.showDownloadDialog(t.getFeatureFromElement(this.parentElement))},{passive:!0});t.map.options.stateful&&n.querySelector("."+t.CLASS+"-share-btn").addEventListener(TC.Consts.event.CLICK,function(e){t.showShareDialog(t.getFeatureFromElement(this.parentElement))},{passive:!0});n.querySelector("."+t.CLASS+"-zoom-btn").addEventListener(TC.Consts.event.CLICK,function(e){t.zoomToFeature(t.getFeatureFromElement(this.parentElement))},{passive:!0});const o=n.querySelector(`.${t.CLASS}-prof-btn`);o&&o.addEventListener(TC.Consts.event.CLICK,function(n){t.getElevationControl().then(n=>n&&n.displayElevationProfile(t.getCurrentFeature(e)))},{passive:!0});n.querySelector("."+t.CLASS+"-del-btn").addEventListener(TC.Consts.event.CLICK,function(e){t.removeFeature(t.getFeatureFromElement(this.parentElement))},{passive:!0})};e.getElevationControl=async function(){const e=this;if(!e.options.displayElevation)return null;e.elevationControl||(e.elevationControl=await e.map.addControl("elevation"));return e.elevationControl};e.showDownloadDialog=async function(e){const t=this,n=await t.getDownloadDialog();var o={title:t.getLocaleString("feature")+" - "+t.getLocaleString("download"),fileName:t._getFeatureFilename(e)};(t.map.elevation||t.options.displayElevation)&&(o=Object.assign({},o,{elevation:Object.assign({},t.map.elevation&&t.map.elevation.options,t.options.displayElevation)}));o.openCallback=function(){t.map.trigger(TC.Consts.event.DIALOG,{control:n})};n.open(e,o)};e.showShareDialog=function(e){const t=this,n=t._dialogDiv.querySelector("."+t.CLASS+"-share-dialog");n.dataset.layerId=e.layer.id;n.dataset.featureId=e.id;TC.Util.showModal(n,{openCallback:function(){t.onShowShareDialog(n)},closeCallback:function(){t._shareCtl.featureToShare=null}})};e.getCurrentFeature=function(e){return e&&(e.caller&&e.caller.highlightedFeature||e.currentFeature)};e.getFeatureFromElement=function(e){const t=this.map.getLayer(e.dataset.layerId);return t?t.getFeatureById(e.dataset.featureId):null};e.zoomToFeature=function(e){const t=this;t.map&&t.map.zoomToFeatures([e],{animate:!0})};e.removeFeature=function(e){const t=this,n=function(){e&&e.layer&&e.layer.removeFeature(e)},o=function(){const n=t=>t.caller&&t.caller.highlightedFeature===e&&t.isVisible();t.map.getControlsByClass(TC.control.Popup).filter(n).forEach(e=>e.hide());t.map.getControlsByClass(TC.control.ResultsPanel).filter(n).forEach(e=>e.close())};if(e&&e.layer.owner&&e.layer===e.layer.owner.resultsLayer){n();o()}else TC.confirm(t.getLocaleString("deleteFeature.confirm"),function(){n();o()})};e.onShowShareDialog=function(e){const t=this._shareCtl;t.extraParams=null;(function(e,t){t=t||{};return new Promise(function(n,o){const a=t.feature;if(a){const r=a.clone();r.setId(a.id);r.layer=a.layer;if(t.elevation){var l=!0;!t.elevation.resolution&&r.getGeometryStride()>2&&(l=!1);if(l){const a={crs:e.map.crs,features:[r],maxCoordQuantity:e.options.displayElevation&&e.options.displayElevation.maxCoordQuantity,resolution:t.elevation.resolution,sampleNumber:0};e.getElevationToool().then(function(e){e.setGeometry(a).then(function(e){n(e[0])},function(e){o(e instanceof Error?e:Error(e))})})}else n(r)}else{const e=r.getCoordsArray(),t=e[0];if(t&&t.length>2){e.forEach(function(e){e.length=2});r.setCoords(r.geometry)}n(r)}}else n(null)})})(this,{feature:this.getFeatureFromElement(e)}).then(async function(e){t.featureToShare=e;const n=t.div,o=await t.generateLink(),a=n.querySelector(".tc-url input[type=text]");a.value=o;delete a.dataset.update;delete a.dataset.shortened;n.querySelector(".tc-iframe input[type=text]").value=await t.generateIframe(o)})};e.getFeatureTitle=function(e){var t="";e&&(t=e.id);return t};e._getFeatureFilename=function(e){return(this.getFeatureTitle(e).toString().replace(new RegExp(this.TITLE_SEPARATOR,"g"),this.FILE_TITLE_SEPARATOR)||this.getLocaleString("feature")).toLowerCase().replace(/\s/gi,"_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)}}();
//# sourceMappingURL=../maps/control/FeatureTools.min.js.map