Math.hypot=Math.hypot||function(){for(var t=0,e=arguments.length,a=0;a<e;a++){if(arguments[a]===1/0||arguments[a]===-1/0)return 1/0;t+=arguments[a]*arguments[a]}return Math.sqrt(t)};!function(){for(var t=0,e=["ms","moz","webkit","o"],a=!(!window.performance||!window.performance.now),i=0,o=e.length;i<o&&!window.requestAnimationFrame;i+=1){window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(e,a){var i=(new Date).getTime(),o=Math.max(0,16-(i-t)),n=window.setTimeout(function(){e(i+o)},o);t=i+o;return n});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});if(!a){var n=window.requestAnimationFrame,r=+new Date;window.requestAnimationFrame=function(t,e){n(function(e){return t(e<1e12?e:e-r)},e)}}}();!function(){if(window.performance){if(window.performance&&!window.performance.now){window.performance.offset=Date.now();window.performance.now=function(){return Date.now()-window.performance.offset}}}else window.performance={offset:Date.now(),now:function(){return Date.now()-this.offset}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Geolocation=function(t){this.$events=$(this);this._classSelector="."+this.CLASS;this.Const={Classes:{ACTIVE:"tc-ctl-geolocation-active",CLOSED:"closed",SELECTEDTRACK:"selectedTrack",DRAWACTIVATED:"draw-activated",SIMULATIONACTIVATED:"simulation-activated"},Selector:{SIMULATE:".tc-btn-simulate",DRAW:".tc-draw",EDIT:".tc-btn-edit",DELETE:".tc-btn-delete",SAVE:".tc-btn-save",CANCEL:".tc-btn-cancel",EXPORT_GPX:".tc-btn-export-gpx",EXPORT_KML:".tc-btn-export-kml",STOP:".tc-btn-stop",PAUSE:".tc-btn-pause",BACKWARD:".tc-btn-backward",FORWARD:".tc-btn-forward",SPEED:".tc-spn-speed"},LocalStorageKey:{TRACKING:"trk",TRACKINGTEMP:"trktemp",TRACKINGSHOWADVERTISEMENT:"trkAdvertisement",GPSSHOWADVERTISEMENT:"gpsAdvertisement",TEST:"test"},Message:{VALIDATENAME:""},Event:{POSITIONCHANGE:"positionchange.tc.geolocation",GPSPOSITIONCHANGE:"gpspositionchange.tc.geolocation",GPSPOSITIONERROR:"positionerror.tc.geolocation",STATEUPDATED:"stateupdated.tc.geolocation",GPSADD:"gpsadd.tc.geolocation",TRACKSNAPPING:"tracksnapping.tc.geolocation",DRAWTRACK:"drawtrack.tc.geolocation",CLEARTRACK:"cleartrack.tc.geolocation",IMPORTEDTRACK:"importedtrack.tc.geolocation"},MimeMap:{KML:"application/vnd.google-earth.kml+xml",GPX:"application/gpx+xml"},SupportedFileExtensions:[".kml",".gpx"],Tabs:{GPS:"gps"},Layers:{GPS:"gps",TRACK:"track",TRACKING:"tracking"}};TC.Control.apply(this,arguments);var e=t||{};this._$dialogDiv=$(TC.Util.getDiv(e.dialogDiv));e.dialogDiv||this._$dialogDiv.appendTo("body");this.delta=500;this.walkingSpeed=5e3;this.gapHill=this.options.gapHill||20;this.snappingTolerance=this.options.snappingTolerance||50;this.exportsState=!0;this.storageCRS="EPSG:4326";this._trackingLayerDeferred=$.Deferred()};TC.inherit(TC.control.Geolocation,TC.Control);!function(){var t=TC.control.Geolocation.prototype;t.CLASS="tc-ctl-geolocation";t.CHART_SIZE={MIN_HEIGHT:70,MAX_HEIGHT:128,MIN_WIDTH:215,MEDIUM_WIDTH:310,MAX_WIDTH:445};TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/Geolocation.html";t.template[t.CLASS+"-track-node"]=TC.apiLocation+"TC/templates/GeolocationTrackNode.html";t.template[t.CLASS+"-track-snapping-node"]=TC.apiLocation+"TC/templates/GeolocationTrackSnappingNode.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/GeolocationDialog.html";t.template[t.CLASS+"-tracking-toast"]=TC.apiLocation+"TC/templates/GeolocationTrackingToast.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"geo"}).w(' <span class="tc-beta tc-hidden">').h("i18n",e,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-geolocation-content"> <div class="tc-ctl-geolocation-track"><div class="tc-ctl-geolocation-track-snap-info"></div><div class="tc-ctl-geolocation-info-tracking tc-hidden"><div class="tc-ctl-p-results"><div class="prpanel-group prsidebar-body "><div class="prpanel prpanel-default"><div class="prpanel-heading"><h4 class="prpanel-title"><label>').h("i18n",e,{},{$key:"geo.mylocation"}).w('</label> <span id="trackingInfoClose" class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-close" title="').h("i18n",e,{},{$key:"close"}).w('"><i class="fa fa-times"></i></span><span id="trackingInfoMin" class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-min" title="').h("i18n",e,{},{$key:"hide"}).w('"><i class="fa fa-chevron-left"></i></span> </h4></div><div id="results" class="prpanel-collapse"><div class="prpanel-body list-group"> </div> </div></div></div><div id="trackingInfoMax" class="prcollapsed prcollapsed-max prcollapsed-pull-left" style="display: none;" title="').h("i18n",e,{},{$key:"geo.trk.panel.3"}).w('"><i class="fa fa-list-alt tracking"></i></div></div></div>\x3c!-- img se insertan en el div del mapa--\x3e <div id="tc-ctl-geolocation-track-elevation-marker" class="tc-ctl-geolocation-trackMarker elevation" style="display: none;" /> <div class="tc-ctl-geolocation-track-panel-block" ><input id="tc-ctl-geolocation-track-panel-opened" type="checkbox" checked/><label for="tc-ctl-geolocation-track-panel-opened" title="').h("i18n",e,{},{$key:"geo.trk.panel.help.1"}).w('">').h("i18n",e,{},{$key:"geo.trk.panel.help.2"}).w('</label><i class="tc-ctl-geolocation-track-panel-help icon-question-sign" title="').h("i18n",e,{},{$key:"geo.trk.panel.help.3"}).w('"></i></div><div class="tc-ctl-geolocation-track-mng"><div class="tc-ctl-geolocation-select"><form> <label class="tc-ctl-geolocation-btn-track" title="').h("i18n",e,{},{$key:"geo.track.title"}).w('"><input type="radio" name="mode" checked value="tracks" /><span>').h("i18n",e,{},{$key:"geo.gps"}).w('</span></label><label class="tc-ctl-geolocation-btn-tracks" title="').h("i18n",e,{},{$key:"geo.tracks.title"}).w('"><input type="radio" name="mode" value="track-available" /><span>').h("i18n",e,{},{$key:"geo.tracks"}).w('</span></label> </form></div> <div class="tc-ctl-geolocation-track-available tc-ctl-geolocation-track-cnt tc-ctl-geolocation-panel tc-hidden"><i class="tc-ctl-geolocation-track-search-icon"></i><input id="tc-ctl-geolocation-track-available-srch" type="search" list="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-srch tc-textbox" placeholder="').h("i18n",e,{},{$key:"geo.filter.plhr"}).w('" maxlength="200" /> <ol id="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-lst"><li class="tc-ctl-geolocation-track-available-empty"><span>').h("i18n",e,{},{$key:"geo.noTracks"}).w('</span></li><li class="tc-ctl-geolocation-track-not" hidden><span>').h("i18n",e,{},{$key:"noMatches"}).w('</span></li></ol><div class="tc-ctl-geolocation-track-cnt"><input name="uploaded-file" id="uploaded-file" type="file" class="tc-ctl-geolocation-track-import tc-button" accept=".gpx,.kml" disabled /><label class="tc-button tc-icon-button" for="uploaded-file" title="').h("i18n",e,{},{$key:"geo.trk.import.upload"}).w('">').h("i18n",e,{},{$key:"geo.trk.import.lbl"}).w('</label></div></div><div class="tc-ctl-geolocation-tracks tc-ctl-geolocation-panel"> <div class="tc-alert alert-warning tc-hidden" ><p id="panel-msg">').h("i18n",e,{},{$key:"geo.trk.panel.1"}).w(" <ul><li>").h("i18n",e,{},{$key:"geo.trk.panel.2"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.3"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.4"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.5"}).w('</li></ul></p></div> <div class="tc-ctl-geolocation-track-ui"> <div class="tc-ctl-geolocation-track-render"><input id="tc-ctl-geolocation-track-render" type="checkbox" hidden checked /><label for="tc-ctl-geolocation-track-render" class="tc-ctl-geolocation-track-render" title="').h("i18n",e,{},{$key:"geo.trk.render"}).w('">').h("i18n",e,{},{$key:"geo.trk.render"}).w('</label></div><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-activate" title="').h("i18n",e,{},{$key:"geo.track.activate.title"}).w('">').h("i18n",e,{},{$key:"geo.track.activate"}).w('</button><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-deactivate tc-hidden" title="').h("i18n",e,{},{$key:"geo.track.deactivate.title"}).w('">').h("i18n",e,{},{$key:"geo.track.deactivate"}).w('</button></div><div class="tc-ctl-geolocation-track-current tc-ctl-geolocation-track-cnt"><input type="text" class="tc-ctl-geolocation-track-title tc-textbox" disabled placeholder="').h("i18n",e,{},{$key:"geo.trk.name.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-save" disabled title="').h("i18n",e,{},{$key:"geo.trk.name.save"}).w('"></button><input type="text" class="tc-ctl-geolocation-track-waypoint tc-textbox" disabled placeholder="').h("i18n",e,{},{$key:"geo.trk.wyp.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-add-wpt" disabled title="').h("i18n",e,{},{$key:"geo.trk.wyp.save"}).w('"></button></div></div></div></div></div>\x3c!--se inserta en el div del mapa--\x3e<div class="tc-ctl-geolocation-track-center tc-hidden"> <button class="tc-ctl-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"geo.trk.center"}).w('"></button></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-track-node"]=function(){dust.register(t.CLASS+"-track-node",e);function e(t,e){return t.w('<li data-id="').f(e.get(["id"],!1),e,"h").w('" data-uid="').f(e.get(["uid"],!1),e,"h").w('"><span class="tc-draw tc-selectable" title="').f(e.get(["name"],!1),e,"h").w('">').f(e.get(["name"],!1),e,"h").w('</span><input class="tc-textbox tc-hidden" type="text" value="').f(e.get(["name"],!1),e,"h").w('" /> <button class="tc-btn-simulate" title="').h("i18n",e,{},{$key:"tr.lst.simulate"}).w('"></button><button hidden class="tc-btn-stop" title="').h("i18n",e,{},{$key:"tr.lst.stop"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",e,{},{$key:"tr.lst.edit"}).w('"></button><button hidden class="tc-btn-pause" title="').h("i18n",e,{},{$key:"tr.lst.pause"}).w('"></button> <button hidden class="tc-btn-backward" title="').h("i18n",e,{},{$key:"tr.lst.backward"}).w('"></button><label hidden class="tc-spn-speed" title="').h("i18n",e,{},{$key:"tr.lst.velocity"}).w('"></label><button hidden class="tc-btn-forward" title="').h("i18n",e,{},{$key:"tr.lst.forward"}).w('"></button> <button class="tc-btn-save tc-hidden" title="').h("i18n",e,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",e,{},{$key:"tr.lst.cancel"}).w('"></button><button class="tc-btn-delete" title="').h("i18n",e,{},{$key:"tr.lst.delete"}).w('"></button><button class="tc-btn-export-gpx" title="').h("i18n",e,{},{$key:"tr.lst.exportGPX"}).w('"></button><button class="tc-btn-export-kml" title="').h("i18n",e,{},{$key:"tr.lst.exportKML"}).w('"></button> </li>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-track-snapping-node"]=function(){dust.register(t.CLASS+"-track-snapping-node",e);function e(t,e){return t.w("<ul>").x(e.get(["n"],!1),e,{block:a},{}).w("<li> <span>").x(e.get(["isGeo"],!1),e,{else:i,block:o},{}).w(":</span> ").f(e.get(["x"],!1),e,"h").w("</li><li> <span>").x(e.get(["isGeo"],!1),e,{else:n,block:r},{}).w(":</span> ").f(e.get(["y"],!1),e,"h").w(" </li>").x(e.get(["z"],!1),e,{block:s},{}).x(e.get(["m"],!1),e,{block:l},{}).w("</ul>")}e.__dustBody=!0;function a(t,e){return t.w("<li><span>").h("i18n",e,{},{$key:"geo.trk.snapping.name"}).w(":</span> ").f(e.get(["n"],!1),e,"h").w("</li>")}a.__dustBody=!0;function i(t,e){return t.w("X")}i.__dustBody=!0;function o(t,e){return t.h("i18n",e,{},{$key:"lon"})}o.__dustBody=!0;function n(t,e){return t.w("Y")}n.__dustBody=!0;function r(t,e){return t.h("i18n",e,{},{$key:"lat"})}r.__dustBody=!0;function s(t,e){return t.h("ne",e,{block:c},{key:e.get(["z"],!1),value:0})}s.__dustBody=!0;function c(t,e){return t.w("<li> <span>Z:</span> ").f(e.get(["z"],!1),e,"h").w(" </li>")}c.__dustBody=!0;function l(t,e){return t.w("<li> ").f(e.get(["m"],!1),e,"h").w(" </li>")}l.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-geolocation-continue-track-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"geo.gps"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><button class="tc-button tc-ctl-geolocation-track-continue"> ').h("i18n",e,{},{$key:"geo.trk.dialog.cnt"}).w(' </button><button class="tc-button tc-ctl-geolocation-track-new"> ').h("i18n",e,{},{$key:"geo.trk.dialog.new"}).w(' </button> <button class="tc-button tc-modal-close"> ').h("i18n",e,{},{$key:"geo.trk.dialog.cancel"}).w(' </button></div></div></div><div class="tc-ctl-geolocation-track-advert-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"geo.track.activate.title"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p id="pageBlurMsg">').h("i18n",e,{},{$key:"geo.trk.page.blur"}).w('</p><p class="tc-ctl-geolocation-track-advertisement p"> <label> <input type="checkbox" name="checkbox" id="advertisement"> ').h("i18n",e,{},{$key:"geo.trk.dialog.advertisement"}).w(' </label> </p></div><div class="tc-modal-footer"><button class="tc-button tc-ctl-geolocation-track-advert-ok"> ').h("i18n",e,{},{$key:"ok"}).w(" </button></div></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-tracking-toast"]=function(){dust.register(t.CLASS+"-tracking-toast",e);function e(t,e){return t.w("<ul><li><span>").x(e.get(["isGeo"],!1),e,{else:a,block:i},{}).w(":</span> ").f(e.get(["x"],!1),e,"h").w("<br /><span>").x(e.get(["isGeo"],!1),e,{else:o,block:n},{}).w(":</span> ").f(e.get(["y"],!1),e,"h").w("<br />").x(e.get(["z"],!1),e,{block:r},{}).w("</li><li>").x(e.get(["accuracy"],!1),e,{block:l},{}).x(e.get(["speed"],!1),e,{block:d},{}).x(e.get(["mdt"],!1),e,{block:A},{}).w("</li></ul>")}e.__dustBody=!0;function a(t,e){return t.w("X")}a.__dustBody=!0;function i(t,e){return t.h("i18n",e,{},{$key:"lon"})}i.__dustBody=!0;function o(t,e){return t.w("Y")}o.__dustBody=!0;function n(t,e){return t.h("i18n",e,{},{$key:"lat"})}n.__dustBody=!0;function r(t,e){return t.w("<span>").x(e.get(["isGeo"],!1),e,{else:s,block:c},{}).w(":</span> ").f(e.get(["z"],!1),e,"h").w(" m<br />")}r.__dustBody=!0;function s(t,e){return t.w("Z")}s.__dustBody=!0;function c(t,e){return t.h("i18n",e,{},{$key:"ele"})}c.__dustBody=!0;function l(t,e){return t.w("<span>").h("i18n",e,{},{$key:"geo.trk.accuracy"}).w(":</span> ").f(e.get(["accuracy"],!1),e,"h").w(" m<br />")}l.__dustBody=!0;function d(t,e){return t.w("<span>").h("i18n",e,{},{$key:"geo.trk.speed"}).w(":</span> ").f(e.get(["speed"],!1),e,"h").w(" km/h<br />")}d.__dustBody=!0;function A(t,e){return t.w('<span title="').h("i18n",e,{},{$key:"mdt.title"}).w('">').h("i18n",e,{},{$key:"ele"}).w(" (").h("i18n",e,{},{$key:"mdt"}).w("):</span> ").f(e.get(["mdt"],!1),e,"h").w(" m<br />")}A.__dustBody=!0;return e}}t.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);e.wrap=new TC.wrap.control.Geolocation(e);e.wrap.register(t);t.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Posicionar.GPS"}).then(function(t){e.layerGPS=t});t.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Posicionar.Tracking",styles:{point:{radius:3,fillColor:"#00ced1",fillOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(e),strokeColor:"#ffffff",fontColor:"#00ced1",labelOutlineColor:"#ffffff",labelOutlineWidth:1,label:function(t){var e=t.getData().name;return e=e&&(e+"").trim().length>0?(e+"").trim().toLowerCase():""}},line:{strokeOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(e),strokeWidth:2,strokeColor:"#00ced1",lineDash:[.1,6]}}}).then(function(t){e.layerTracking=t;e._trackingLayerDeferred.resolve(t)});var a=function(t){if(t.layer==this.layerTrack)switch(!0){case t.type+"."+t.namespace===TC.Consts.event.LAYERREMOVE:this.wrap.deactivateSnapping();this.getSelectedTrack()&&this.clearSelectedTrack();this.resultsPanelChart&&this.resultsPanelChart.close();this.layerTrack=void 0;break;case t.opacity>0&&t.opacity<1:return;case 0==t.layer.getVisibility():this.resultsPanelChart&&this.resultsPanelChart.minimize();case 0==t.opacity:this.wrap.deactivateSnapping();break;case 1==t.layer.getVisibility():this.resultsPanelChart&&this.resultsPanelChart.maximize();case 1==t.opacity:this.wrap.activateSnapping()}}.bind(e);e._trackLayerBindEvents=function(e){e?t.on(TC.Consts.event.LAYERVISIBILITY+" "+TC.Consts.event.LAYEROPACITY+" "+TC.Consts.event.LAYERREMOVE,a):t.off(TC.Consts.event.LAYERVISIBILITY+" "+TC.Consts.event.LAYEROPACITY+" "+TC.Consts.event.LAYERREMOVE,a)};t.on(TC.Consts.event.FEATURESIMPORT,function(t){const e=this,a=/.kml$/g.test(t.fileName.toLowerCase())&&e.importedByMe||!1;if(/.gpx$/g.test(t.fileName.toLowerCase())||a){if(a){for(var i=0;i<e.map.workLayers.slice().reverse().length;i++){var o=e.map.workLayers.slice().reverse()[i];if(o.title&&o.title.toLowerCase().trim()===t.fileName.toLowerCase().trim()){e.map.removeLayer(o);break}}e.importedByMe=!1}e.importTrack(t);a&&e.layerTrack&&e.layerTrack.styles&&e.layerTrack.features.forEach(function(t){t instanceof TC.feature.Point&&e.layerTrack.styles.point?t.setStyle(e.layerTrack.styles.point):t instanceof TC.feature.Polyline&&e.layerTrack.styles.line&&t.setStyle(e.layerTrack.styles.line)})}}.bind(e))};t.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.render.call(e,t)})};t.importTrack=function(t){var e=this;if(e.isDisabled)/.gpx$/g.test(t.fileName.toLowerCase())&&e.map.toast(e.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else if(t.fileName&&t.features&&t.features.length>0){if(e.layerTrack){e.map.removeLayer(e.layerTrack);e.layerTrack=void 0}e.getLayer(e.Const.Layers.TRACK).then(function(a){e._trackLayerBindEvents(!1);e.layerTrack.setVisibility(!1);e._trackLayerBindEvents(!0);var i=e.getLoadingIndicator().addWait();e.importedFileName=t.fileName;for(var o=0,n=t.features.length;o<n;o++)e.layerTrack.addFeature(t.features[o]);e.wrap.processImportedFeatures(i);if(e.layerTrack){e.map&&e.map.layout&&e.map.layout.accordion&&e._$div.hasClass(TC.Consts.classes.COLLAPSED)&&e.map.controls.filter(function(t){return t!==e&&!t.containerControl}).forEach(function(t){t._$div.addClass(TC.Consts.classes.COLLAPSED)});e._$div.removeClass(TC.Consts.classes.COLLAPSED);$("."+e.CLASS+"-btn-tracks > span").click();e.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{})}})}};var e=!0;t.renderData=function(r,s){var c=this,l=function(t,e){return(e.match(/(moveTop.*)/g)||[]).join(" ")};c.trackingActive={isTrackingActive:!1,get:function(){return this.isTrackingActive},set:function(t){this.isTrackingActive=t;c.$geoInfoResult||(c.$geoInfoResult=$("."+c.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isTrackingActive){case!0:if(c.elevationActiveCollapsed.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop57");c.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}else if(c.elevationActive.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop159");c.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}else{c.$geoInfoResult.removeClass(l).addClass("moveTop33");c.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}}}};c.elevationActive={isElevationActive:!1,get:function(){return this.isElevationActive},set:function(t){this.isElevationActive=t;c.$geoInfoResult||(c.$geoInfoResult=$("."+c.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isElevationActive){case!0:if(c.trackingActive.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop159");c.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}break;case!1:if(c.trackingActive.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop33");c.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}}}};c.elevationActiveCollapsed={isElevationActiveCollapsed:!1,get:function(){return this.isElevationActiveCollapsed},set:function(t){this.isElevationActiveCollapsed=t;c.$geoInfoResult||(c.$geoInfoResult=$("."+c.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isElevationActiveCollapsed){case!0:if(c.trackingActive.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop57");c.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}break;case!1:if(c.trackingActive.get()){c.$geoInfoResult.removeClass(l).addClass("moveTop159");c.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");c.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}}}};var A=c.Const.Selector;TC.Control.prototype.renderData.call(c,r,function(){var r=c._$div.find(c._classSelector+"-panel");c._$div.find(".tc-ctl-geolocation-select span").on(TC.Consts.event.CLICK,function(t){var e=$(this).closest("label").find("input[type=radio][name=mode]").val();r.removeClass(TC.Consts.classes.HIDDEN);r.not(".tc-ctl-geolocation-"+e).addClass(TC.Consts.classes.HIDDEN)});c.gps={};c.gps.$activateButton=c._$div.find(c._classSelector+"-locate-show");c.gps.$deactivateButton=c._$div.find(c._classSelector+"-locate-hide");c.track={};c.track.$activateButton=c._$div.find(c._classSelector+"-track-ui-activate");c.track.$deactivateButton=c._$div.find(c._classSelector+"-track-ui-deactivate");c.track.$info=c._$div.find(c._classSelector+"-info-tracking").appendTo(c.map._$div);$(document).on("click","#trackingInfoMin",function(){var t=$(this).closest("div.tc-ctl-p-results");t.find(".prsidebar-body").toggle("slide",function(){t.find(".prcollapsed-max").fadeIn()})});$(document).on("click","#trackingInfoMax",function(){var t=$(this).closest("div.tc-ctl-p-results");t.find(".prsidebar-body").toggle("slide");t.find(".prcollapsed-max").hide()});$(document).on("click","#trackingInfoClose",function(){$(this).closest("div.tc-ctl-p-results").find(".prsidebar-body").fadeOut("slide")});c.track.$trackSearch=c._$div.find(c._classSelector+"-track-available-srch");c.track.$trackList=c._$div.find(c._classSelector+"-track-available-lst");c.track.$trackToolPanelOpened=c._$div.find("#tc-ctl-geolocation-track-panel-opened");c._$div.find("."+t.CLASS+"-track-panel-help").on("click",function(){n.call(c)});c.track.$trackName=c._$div.find(c._classSelector+"-track-title");c.track.$trackSave=c._$div.find(c._classSelector+"-track-save");c.track.$trackWPT=c._$div.find(c._classSelector+"-track-waypoint");c.track.$trackAdd=c._$div.find(c._classSelector+"-track-add-wpt");c.track.$trackContinue=c._$dialogDiv.find(".tc-ctl-geolocation-track-continue");c.track.$trackRenew=c._$dialogDiv.find(".tc-ctl-geolocation-track-new");c.track.$trackClose=c._$dialogDiv.find(".tc-ctl-geolocation-continue-track-dialog button.tc-modal-close");c.track.$trackAddSegment=c._$div.find("#tc-ctl-geolocation-track-segment");c.track.$trackAdvertisementOK=c._$dialogDiv.find(".tc-ctl-geolocation-track-advert-ok");c.track.$trackImportFile=c._$div.find(c._classSelector+"-track-import");TC.Util.detectMobile()&&Modernizr.mq("screen and (max-height: 50em) and (max-width: 50em)")&&c.track.$trackToolPanelOpened.prop("checked",!1);if(window.File&&window.FileReader&&window.FileList&&window.Blob){c.track.$trackImportFile.prop("disabled",!1);c.track.$trackImportFile.on(TC.Consts.event.CLICK,function(t){$(this).wrap("<form>").closest("form").get(0).reset();$(this).unwrap()});c.track.$trackImportFile.on("change",function(t){if(!c._cleaning){c.clear(c.Const.Layers.TRACK);if(c.map){c.map.on(TC.Consts.event.LAYERERROR,a);c.importedByMe=!0;c.map.wrap.loadFiles(t.target.files)}}})}else console.log("no es posible la importaci\xf3n");c.gps.$activateButton.on("click",function(){c.activateGPS()});c.gps.$deactivateButton.on("click",function(){c.deactivateGPS()});c.track.$activateButton.on("click",function(){c.activateTracking();i.call(c)});c.track.$deactivateButton.on("click",function(){c.deactivateTracking();o.call(c)});var s=function(t){t=t.toLowerCase();var e=c.track.$trackList.find("li").hide(),a=e.filter("li:not([class]),li."+c.Const.Classes.SELECTEDTRACK);if(0===t.length){a.show();c._$div.find(c._classSelector+"-track-search-icon").css("visibility","visible")}else{c._$div.find(c._classSelector+"-track-search-icon").css("visibility","hidden");var i=new RegExp(t,"i");a.each(function(){var t=$(this);t.toggle(i.test(t.children("span").text()))});0===a.filter(":visible").length&&e.filter('[class^="tc-ctl-geolocation-track-not"]').show()}};c.track.$trackSearch.on("keyup search",function(){s($(this).val().toLowerCase().trim())});try{if(c.track.$trackSearch.has($("::-ms-clear"))){c.track.$trackSearch.on("mouseup",function(t){""!==c.track.$trackSearch.val()&&setTimeout(function(){var t=c.track.$trackSearch.val();""===t&&s(t)},1)})}}catch(t){}c.track.$trackSave.on("click",$.proxy(c.saveTrack,c));c.track.$trackAdd.on("click",$.proxy(c.addWaypoint,c));var l=function(t,e){e.is("li")||(e=e.parent());if(t){e.find("input").first().removeClass(TC.Consts.classes.HIDDEN);e.find("span").first().addClass(TC.Consts.classes.HIDDEN);e.find("input").first().focus().val(e.find("span").first().text());e.find(A.SIMULATE).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.EDIT).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.DELETE).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.DRAW).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.EXPORT_GPX).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.EXPORT_KML).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.SAVE).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.CANCEL).first().removeClass(TC.Consts.classes.HIDDEN)}else{e.find("input").first().addClass(TC.Consts.classes.HIDDEN);e.find("span").first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.SIMULATE).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.EDIT).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.DELETE).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.DRAW).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.EXPORT_GPX).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.EXPORT_KML).first().removeClass(TC.Consts.classes.HIDDEN);e.find(A.SAVE).first().addClass(TC.Consts.classes.HIDDEN);e.find(A.CANCEL).first().addClass(TC.Consts.classes.HIDDEN)}};c.uiSimulate=function(t,e){var a=[A.SIMULATE,A.EDIT,A.DELETE,A.EXPORT_GPX,A.EXPORT_KML],i=[A.STOP,A.PAUSE,A.BACKWARD,A.FORWARD,A.SPEED],o=e.is("li")?e:e.parent();if(t){for(var n=0;n<a.length;n++)$(o).find(a[n]).first().attr("hidden","hidden");for(n=0;n<i.length;n++)$(o).find(i[n]).first().removeAttr("hidden")}else{for(n=0;n<i.length;n++)$(o).find(i[n]).first().attr("hidden","hidden");for(n=0;n<a.length;n++)$(o).find(a[n]).first().removeAttr("hidden")}};$(document).on("click",A.SIMULATE,function(){var t=c.getLoadingIndicator().addWait();$(this).parent().find(A.SPEED).text("x 1");$.when(p(c,this)).then(function(){c.getLoadingIndicator().removeWait(t)})});$(document).on("click",A.DRAW,function(){var t=c.getLoadingIndicator().addWait();$.when(u(c,this)).then(function(){c.getLoadingIndicator().removeWait(t)})});c.$events.on(c.Const.Event.IMPORTEDTRACK,function(t,e){if(c.isDisabled)c.map.toast(c.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else{var a=c.track.$trackList.find('li[data-id="'+e+'"]');u(c,a.find(A.DRAW));c.track.$trackList.animate({scrollTop:e*a.outerHeight()},"slow")}});var g=function(t,e){for(var a=t.track.$trackList.find("li[data-id]"),i=0;i<a.length;i++){var o=$(a[i]);if(o&&o.attr("data-id")!==e){var n=o.find(A.SIMULATE),r=o.find(A.PAUSE);n.toggleClass(t.Const.Classes.SIMULATIONACTIVATED,!1);n.attr("title",t.getLocaleString("tr.lst.simulate"));r.toggleClass("play",!1);r.attr("title",t.getLocaleString("tr.lst.pause"));t.uiSimulate(!1,o);l(!1,o)}}t.clear(t.Const.Layers.TRACK)},u=function(t,e){var a=$.Deferred(),i=$(e).parent();setTimeout(function(){if(i.hasClass(t.Const.Classes.SELECTEDTRACK)){t.uiSimulate(!1,$(e));t.clear(t.Const.Layers.TRACK);$(e).attr("title",$(e).text());t.elevationActive.set(!1);if(void 0!==t.layerTrack){t.map.removeLayer(t.layerTrack);t.layerTrack=void 0}}else if(t.getSelectedTrack().length>0){g(t,i.attr("data-id"));t.drawTrack(i)}else t.drawTrack(i);a.resolve()},0);return a.promise()},p=function(t,e){var a=$.Deferred();setTimeout(function(){var i=$(e).parent();t.getLayer(t.Const.Layers.TRACK).then(function(o){g(t,i.attr("data-id"));t.uiSimulate(!1,t.getSelectedTrack());$(this).parent().addClass(t.Const.Classes.SELECTEDTRACK);t.uiSimulate(!0,$(e));t.simulate_paused=!1;t.simulateTrack($(e).parent());a.resolve()})},0);return a.promise()};$(document).on("click",c._classSelector+" "+A.EDIT,function(){l(!0,$(this))});$(document).on("click",c._classSelector+" "+A.DELETE,function(){c.removeTrack($(this).parent())});$(document).on("click",c._classSelector+" "+A.SAVE,function(){if(0==$(this).parent().find("input").first().val().trim().length)TC.alert(c.getLocaleString("geo.trk.edit.alert"));else{c.editTrackName($(this).parent().attr("data-id"),$(this).parent().find("input").first().val());l(!1,$(this))}});$(document).on("click",c._classSelector+" "+A.CANCEL,function(){l(!1,$(this))});$(document).on("click",c._classSelector+" "+A.EXPORT_GPX+","+c._classSelector+" "+A.EXPORT_KML,function(){var t=this,e=$.grep($(this).attr("class").split(" "),function(t){return 0===t.indexOf("tc-btn-export-")})[0].replace("tc-btn-export-","").toUpperCase();c.export(e,$(this).parent()).then(function(a){if(a){var i=$(t).parent().find("span").first().text(),o=new RegExp(c.Const.SupportedFileExtensions.join("|"),"gi"),n=i.replace(o,"");TC.Util.downloadFile(n+"."+e.toLowerCase(),c.Const.MimeMap[e],a)}else TC.alert(c.getLocaleString("geo.error.export"))})});$(document).on("click",c._classSelector+" "+A.STOP,function(){c.uiSimulate(!1,$(this));c.wrap.simulateTrackEnd();var t=$(this).parent().find(A.PAUSE);t.toggleClass("play",!1);t.attr("title",c.getLocaleString("tr.lst.pause"));$(this).parent().find(A.SPEED).text("x 1");c.simulate_speed=1});$(document).on("click",c._classSelector+" "+A.PAUSE,function(){c.simulate_paused=!$(this).hasClass("play");c.simulate_paused&&(c.simulate_pausedElapse=-1);$(this).attr("title",c.getLocaleString(c.simulate_paused?"tr.lst.play":"tr.lst.pause"));$(this).toggleClass("play",c.simulate_paused)});$(document).on("click",c._classSelector+" "+A.BACKWARD,function(){1==c.simulate_speed?c.simulate_speed=.5:c.simulate_speed=c.simulate_speed/2;$(c._classSelector+" "+A.FORWARD).removeAttr("disabled");$(this).parent().find(A.SPEED).text(c.simulate_speed<1?"/ "+1/c.simulate_speed:"x "+c.simulate_speed);.000244140625==c.simulate_speed&&$(this).attr("disabled","disabled")});$(document).on("click",c._classSelector+" "+A.FORWARD,function(){c.simulate_speed=c.simulate_speed/.5;$(this).parent().find(A.SPEED).text(c.simulate_speed<1?"/ "+1/c.simulate_speed:"x "+c.simulate_speed);$(c._classSelector+" "+A.BACKWARD).removeAttr("disabled");4096==c.simulate_speed&&$(this).attr("disabled","disabled")});c.track.$trackContinue.on("click",function(){TC.Util.closeModal();d.call(c)});c.track.$trackRenew.on("click",function(){delete c.sessionTracking;TC.Util.storage.setSessionLocalValue(c.Const.LocalStorageKey.TRACKINGTEMP,void 0);localforage.removeItem(c.Const.LocalStorageKey.TRACKINGTEMP);TC.Util.closeModal();d.call(c)});c.track.$trackClose.on("click",function(){o.call(c)});c.track.$trackAddSegment.on("click",function(){TC.alert("pendiente");TC.Util.closeModal()});c.track.$trackAdvertisementOK.on("click",function(){var t=$("body").find('input[name*="Advertisement"]:checked');if(t.length>0){var e=new $.Deferred;window.localforage?e.resolve():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){e.resolve()});e.then(function(){localforage.setItem(t.first().attr("name"),!1)})}TC.Util.closeModal()});c.track.renderTrack=$("#tc-ctl-geolocation-track-render").on("change",function(){c.track.$activateButton.hasClass(TC.Consts.classes.HIDDEN)&&c.layerTracking.setVisibility(this.checked);e=this.checked});window.localforage?c.bindTracks():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){c.bindTracks()})});$.isFunction(s)&&s()};t.activate=function(){};t.deactivate=function(){TC.Util.closeModal();this.clearSelection();this.deactivateTracking()};var a=function(){this.map.off(TC.Consts.event.LAYERERROR,a);this.clearFileInput(this.track.$trackImportFile);TC.alert(this.getLocaleString("geo.trk.upload.error3"))},i=function(){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!1)},o=function(){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)},n=function(){this.map.toast(this._$div.find(".alert-warning").html(),{duration:1e4})};t.markerStyle={radius:7,fillColor:[255,0,0,100],strokeColor:[255,255,255,255],strokeWidth:2};t.lineStyle={strokeWidth:2,strokeColor:[0,206,209,255]};t.getLayer=function(t){var e,a=this,i="";switch(!0){case t==a.Const.Layers.TRACKING:void 0!==a.layerTracking;i="layerTracking";break;case t==a.Const.Layers.TRACK:void 0!==a.layerTrack;i="layerTrack";e={line:{strokeWidth:2,strokeColor:"#C52737"},point:{radius:function(t){var e=t.getData().name;return e&&(e+"").trim().length>0?3:6},fillColor:"#C52737",strokeColor:"#ffffff",fontColor:"#C52737",fontSize:10,labelOutlineColor:"#ffffff",labelOutlineWidth:2,label:function(t){var e=t.getData().name;return e=e&&(e+"").trim().length>0?(e+"").trim().toLowerCase():""}}};break;case t==a.Const.Layers.GPS:void 0!==a.layerGPS;i="layerGPS"}if(this[i]){var o=new $.Deferred;o.resolve(this[i]);return o}if(a.layerPromise&&"resolved"!==a.layerPromise.state())return a.layerPromise;a.layerPromise=new $.Deferred;var n={id:a.getUID(),type:TC.Consts.layerType.VECTOR,title:a.getLocaleString("geo")+" - "+t,stealth:!0};e&&(n.styles=e);a.map.addLayer(n).then(function(t){this[i]=t;this[i].map.putLayerOnTop(t);a.layerPromise.resolve(this[i])}.bind(a));return a.layerPromise};t.activateGPS=function(){var t=this;t.deactivateTracking();C.call(t,t.Const.LocalStorageKey.GPSSHOWADVERTISEMENT);A.apply(t);h.apply(t);t.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);t.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);t.track.$trackToolPanelOpened.prop("checked")||t.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{});$.when(t.getLayer(t.Const.Layers.GPS)).then(function(e){t.currentPositionWaiting=t.getLoadingIndicator().addWait();if(navigator.geolocation){var a=function(a){a=a.coords;t.geopositionGPS=!0;var i=TC.Util.reproject([a.longitude,a.latitude],"EPSG:4326",t.map.crs);t.getLoadingIndicator().removeWait(t.currentPositionWaiting);e&&e.clearFeatures();var o;o=i,function(t,e){return!(t instanceof Array)||e[0]>=t[0]&&e[0]<=t[2]&&e[1]>=t[1]&&e[1]<=t[3]}(t.map.options.maxExtent,o)?$.when(e.addCircle([i,a.accuracy/t.map.getMetersPerUnit()]),e.addMarker(i,{title:"GPS",cssClass:TC.Consts.classes.POINT,anchor:[.5,.5]})).then(function(a,i){t.gps.accuracyCircle=a;t.gps.geoPosition=i;if(!t.wrap.pulsated){t.map.zoomToFeatures(e.features,{animate:!1});t.wrap.pulsate(a)}}):TC.alert(t.getLocaleString("geo.error.out"))};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(e){t.data=e;a(e);t.currentPosition=navigator.geolocation.watchPosition(a,t.onGeolocateError.bind(t))},t.onGeolocateError.bind(t));setTimeout(function(){if(!t.data){t.getLoadingIndicator().removeWait(t.currentPositionWaiting);t.map.toast(t.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING});t.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);t.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)}},61e3)}else alert("not supported")}else t.onGeolocateError()})};t.deactivateGPS=function(){delete this.geopositionGPS;g();f();delete this.wrap.pulsated;navigator.geolocation&&this.currentPosition&&navigator.geolocation.clearWatch(this.currentPosition);$.when(this.getLayer(this.Const.Layers.GPS)).then(function(t){t&&t.clearFeatures()});this.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);this.currentPositionWaiting&&this.getLoadingIndicator().removeWait(this.currentPositionWaiting);return!0};t.setFormatInfoNewPosition=function(t){var e={},a=TC.Util.getMapLocale(this.map);e.x=Math.round(t.position[0]).toLocaleString(a);e.y=Math.round(t.position[1]).toLocaleString(a);e.z=Math.round(t.altitude).toLocaleString(a);e.accuracy=Math.round(t.accuracy).toLocaleString(a);e.speed=t.speed.toLocaleString(a,{minimumFractionDigits:1,maximumFractionDigits:1});return e};t.renderInfoNewPosition=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-tracking-toast",e.setFormatInfoNewPosition(t.pd),function(t){e.track.$info.find(".prpanel-body").html(t);e.track.$info.hasClass(TC.Consts.classes.HIDDEN)&&e.track.$info.removeClass(TC.Consts.classes.HIDDEN);e.trackingActive.set(!0)})};var r,s,c,l=function(){this.track.$trackToolPanelOpened.prop("checked")||this.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})},d=function(){var t=this;t.activate();i.call(t);l.call(t);t.track.$info.find(".prsidebar-body").show();t.$events.on(t.Const.Event.POSITIONCHANGE,function(e){t.currentPoint=e.pd;t.renderInfoNewPosition(e);t.track.$trackName.removeAttr("disabled");t.track.$trackSave.removeAttr("disabled");t.track.$trackWPT.removeAttr("disabled");t.track.$trackAdd.removeAttr("disabled");TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP,t.wrap.formattedToStorage(t.layerTracking).features)});t.$events.on(t.Const.Event.STATEUPDATED,function(t){});t.clear(t.Const.Layers.TRACKING);C.call(t,t.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);t.wrap.setTracking(!0)},A=function(){if(!this.videoScreenOn){var t={WebM:"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=",MP4:"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw=="};this.videoScreenOn=document.createElement("video");this.videoScreenOn.setAttribute("loop","");this.videoScreenOn.setAttribute("muted","");this.videoScreenOn.setAttribute("webkit-playsinline","");this.videoScreenOn.setAttribute("playsinline","");this.videoScreenOn.setAttribute("style","transform: translateZ(0px);");var e=document.createElement("source");e.src=t.WebM;e.type="video/webm";this.videoScreenOn.appendChild(e);var a=document.createElement("source");a.src=t.MP4;a.type="video/mp4";this.videoScreenOn.appendChild(a)}this.videoScreenOn.play()},g=function(){this.videoScreenOn&&this.videoScreenOn.pause()},u=function(){this.videoScreenOn.paused&&this.videoScreenOn.play();k.apply(this)},p=function(){var t=function(){var t=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var e=0;e<t.length;e++)if(t[e]+"Hidden"in document)return t[e]+"Hidden";return null}();document[t]||u.apply(this);console.log("video is: "+this.videoScreenOn.paused)},h=function(){c||(c=p.bind(this));r||(r=function(){v.apply(this)}.bind(this));s||(s=u.bind(this));window.addEventListener("visibilitychange",c,!1);if(TC.Util.detectSafari()&&Modernizr.touch&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.addEventListener("pagehide",r,!1);window.addEventListener("pageshow",s,!1)}else{window.addEventListener("blur",r,!1);window.addEventListener("focus",s,!1)}},f=function(){window.removeEventListener("visibilitychange",c,!1);if(TC.Util.detectSafari()&&Modernizr.touch&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.removeEventListener("pagehide",r,!1);window.removeEventListener("pageshow",s,!1)}else{window.removeEventListener("blur",r,!1);window.removeEventListener("focus",s,!1)}},v=function(){var t=TC.Util.storage.getSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP);t&&t.length>0&&localforage.setItem(this.Const.LocalStorageKey.TRACKINGTEMP,"string"==typeof t?t:JSON.stringify(t))},k=function(){var t=this;localforage.getItem(t.Const.LocalStorageKey.TRACKINGTEMP).then(function(e){null!==e&&"null"!==e&&e.length>0&&TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP,e)})},C=function(t){var e=this,a=new $.Deferred;window.localforage?a.resolve():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){a.resolve()});a.then(function(){localforage.getItem(t).then(function(a){if(null==a){var i=e._$dialogDiv.find(".tc-ctl-geolocation-track-advert-dialog");i.find('input[type="checkbox"]').first().attr("name",t).removeAttr("checked");TC.Util.detectMobile()?$("#pageBlurMsg").text(e.getLocaleString("geo.trk.page.blur")):$("#pageBlurMsg").text(e.getLocaleString("geo.trk.page.blur.desktop"));t==e.Const.LocalStorageKey.GPSSHOWADVERTISEMENT?i.find("h3").text(e.getLocaleString("geo.track.activate")+" "+e.getLocaleString("geo.gps")):i.find("h3").text(e.getLocaleString("geo.track.activate.title"));TC.Util.showModal(e._$dialogDiv.find(".tc-ctl-geolocation-track-advert-dialog"))}})});e.map.toast(TC.Util.detectMobile()?e.getLocaleString("geo.trk.page.blur"):e.getLocaleString("geo.trk.page.blur.desktop"),{type:TC.Consts.msgType.WARNING})};t._askTracking=function(t){TC.Util.showModal(this._$dialogDiv.find(".tc-ctl-geolocation-continue-track-dialog"),{closeCallback:function(){$.isFunction(t)&&t()}});return!0};t.activateTracking=function(){var t=this,e=!0;t.isActive||t.activate();t.clear(t.Const.Layers.TRACKING);try{TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TEST,t.Const.LocalStorageKey.TEST)}catch(a){a.code===DOMException.QUOTA_EXCEEDED_ERR?TC.alert(t.getLocaleString("geo.error.trackinglocalstorage")):TC.error(a);e=!1}if(e){A.apply(t);h.apply(t);t.sessionTracking=TC.Util.storage.getSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP);if(t.sessionTracking){t._askTracking(function(){o.call(t)})||t.track.$trackRenew.click()}else d.call(t)}else o.call(t)};t.deactivateTracking=function(){var t=this,a=function(){t.track.$info.addClass(TC.Consts.classes.HIDDEN);$("#trackingInfoMax").hide();v.apply(t);t.wrap.setTracking(!1);delete t.geopositionTracking;e||$(t._classSelector+"-track-render").find("label").click();g.apply(t);f.apply(t);t.$events.off(t.Const.Event.POSITIONCHANGE);t.$events.off(t.Const.Event.STATEUPDATED);o.call(t);t.trackingActive.set(!1);t.track.$trackName.val("");t.track.$trackName.attr("disabled","disabled");t.track.$trackSave.attr("disabled","disabled");t.track.$trackWPT.val("");t.track.$trackWPT.attr("disabled","disabled");t.track.$trackAdd.attr("disabled","disabled");t.clear(t.Const.Layers.TRACKING);t.clear(t.Const.Layers.GPS);return!0};if(t.wrap.hasCoordinates()){t.map.toast(t.getLocaleString("geo.trk.deactivate.alert"),{duration:1e4});return a()}return a()};t.getStoredTracks=function(){var t=this,e=new $.Deferred,a=[];localforage.keys().then(function(i){var o=[];if(0==(i=i.filter(function(e){if(!e.startsWith(t.Const.LocalStorageKey.TRACKINGTEMP)&&e.startsWith(t.Const.LocalStorageKey.TRACKING)){if(/trk#\d/i.exec(e)){o.push(new $.Deferred);return!0}return!1}return!1})).length){t.availableTracks=a;e.resolve(a)}o.forEach(function(t,e){localforage.getItem(i[e],function(e,a){t.resolve(a)})});$.when.apply($,o).then(function(){var i=Array.prototype.slice.call(arguments,0);if(i&&i.length){i.forEach(function(t){(t=JSON.parse(t))instanceof Array?a=a.concat(t):a.push(t)});var o=a.length>1?m(a):a;t.availableTracks=o;e.resolve(o)}})});return e};var m=function(t){var e=[];for(var a in t)if(t[a]&&"object"==typeof t[a]){e.push(t[a]);e.sort(function(t,e){return"string"==typeof t.name&&$.isFunction(t.name.localeCompare)?t.name.localeCompare(e.name):0})}return e};t.setStoredTracks=function(t){var e=this,a=new $.Deferred,i=[];t.forEach(function(t){i.push(new $.Deferred);var a=i[i.length-1];localforage.setItem(e.Const.LocalStorageKey.TRACKING+"#"+t.uid,JSON.stringify(t),function(t,e){a.resolve(e)})});$.when.apply($,i).then(function(){e.getStoredTracks().then(function(){e.bindTracks();a.resolve()})});return a};t.getAvailableTracks=function(){var t=new $.Deferred;this.availableTracks?t.resolve(this.availableTracks):this.getStoredTracks().then(function(e){t.resolve(e)});return t};t.bindTracks=function(){var t=this;t.track.$trackList.find('li:not([class^="tc-ctl-geolocation-track-available-empty"])').hide();t.track.$trackList.find('li[class^="tc-ctl-geolocation-track-available-empty"]').hide();t.getAvailableTracks().then(function(e){if(T(e)){t.track.$trackList.find('li[class^="tc-ctl-geolocation-track-available-empty"]').show();t.track.$trackSearch.attr("disabled","disabled")}else{var a=$(t.getSelectedTrack()[0]).attr("data-uid");t.track.$trackList.find("li[data-id]").remove();for(var i=0;i<e.length;i++){var o=e[i];"object"==typeof o&&t.getRenderedHtml(t.CLASS+"-track-node",{id:i,uid:o.uid,name:o.name?o.name.trim():""},function(e){t.track.$trackList.append(e)})}a&&t.setSelectedTrack(t.track.$trackList.find('li[data-uid="'+a+'"]'));t.track.$trackSearch.removeAttr("disabled")}})};t.chartProgressInit=function(){window.d3||TC.syncLoadJS(TC.Consts.url.D3C3);var t=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();$("body").append('<div class="miDiv">');this.miDiv=$("div.miDiv");this.miDiv.width(t.width);this.miDiv.height(t.height);this.miDiv.append('<div class="miProgressDiv">');this.miProgressDiv=$("div.miProgressDiv");this.miProgressDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress");this.miProgressDiv.width("0%");this.miProgressDiv.height(t.height);this.miProgressDiv.append('<div class="miProgressTextDiv">');this.miProgressTextDiv=$("div.miProgressTextDiv");this.miProgressTextDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress text");this.miProgressTextDiv.width(t.width);this.miProgressTextDiv.height(t.height);this.miDiv.css({top:t.top,left:t.left,bottom:t.bottom,right:t.right,position:"absolute","z-index":10007})};t.chartProgressClear=function(){$(this.miProgressTextDiv).remove();$(this.miProgressDiv).remove();$(this.miDiv).remove()};t.chartSetProgress=function(t,e,a,i){var o=t.d,n=(o+Math.hypot(t.p[0]-e[0],t.p[1]-e[1]))/a*100;this.miProgressDiv.width(n+"%");var r,s,c=this.map.options.locale&&this.map.options.locale.replace("_","-")||void 0,l=parseInt(e[2].toFixed(0)).toLocaleString(c);if(o/1e3<1){r=Math.round(o/1e3*1e3);s=" m"}else{r=Math.round(o/1e3*100)/100;s=" km"}r=r.toLocaleString(c);this.miProgressTextDiv.html("<div><span>"+l+" m</span><br><span>"+r+s+"</span></div>"+(i?"<br><span>"+i.toString+"</span>":""))};t._getTime=function(t,e){var a=e-t,i={},o=Math.floor(a/1e3/60/60/24);a-=1e3*o*60*60*24;var n=Math.floor(a/1e3/60/60);a-=1e3*n*60*60;i.h=n+24*o;var r=Math.floor(a/1e3/60);a-=1e3*r*60;i.m=r;i.s=Math.floor(a/1e3);return $.extend({},i,{toString:("00000"+i.h).slice(-2)+":"+("00000"+i.m).slice(-2)+":"+("00000"+i.s).slice(-2)})};t.simulateTrack=function(t){this.simulate_speed=1;this.drawTrack(t,!1);this.wrap.simulateTrack()};t.drawTrack=function(t,e){var a=this;l.call(a);a.getLayer(a.Const.Layers.TRACK).then(function(e){a.setSelectedTrack(t);a.drawTrackingData(t);a.elevationTrack(t);a.activate()})};t.elevationTrack=function(e,a){var i=this;if(a){i.resultsPanelChart.close();i.wrap.simulateTrackEnd();i.uiSimulate(!1,e)}if(!i.onResize){i.onResize=i.elevationTrack.bind(i,e,!0);window.addEventListener("resize",i.onResize,!1)}i.chart={coordinates:[]};i.track.elevationChart&&(i.track.elevationChart=i.track.elevationChart.destroy());(function(t){var e=new $.Deferred;TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){i.getTrackingData(t).then(function(t){var a=t.data;if(a){var o,n;o=[];n=[];var r,s,c,l=!0,d={},A={},g=function(){if(c.getLayout()==ol.geom.GeometryLayout.XYZ||c.getLayout()==ol.geom.GeometryLayout.XYZM){var t=0;if(i.map.crs!==i.map.options.utmCrs){line=new ol.geom.LineString(TC.Util.reproject(c.getCoordinates(),i.map.crs,i.map.options.utmCrs));t=line.getLength()}else t=c.getLength();return parseFloat((t/1e3).toFixed(2))}return null},u=function(){if(c.getLayout()==ol.geom.GeometryLayout.XYZM||c.getLayout()==ol.geom.GeometryLayout.XYM){var t=c.getLastCoordinate()[3]-c.getFirstCoordinate()[3];return{s:Math.floor(t/1e3%60),m:Math.floor(t/6e4%60),h:Math.floor(t/36e5%24)}}return null},p=function(t){if(i.chart.coordinates.length>0){var e=0;i.chart.coordinates.forEach(function(a,o,n){var r=0===o?a:n[o-1];if(i.map.crs!==i.map.options.utmCrs){a=TC.Util.reproject(a,i.map.crs,i.map.options.utmCrs);r=TC.Util.reproject(r,i.map.crs,i.map.options.utmCrs)}const s=a[0]-r[0],c=a[1]-r[1];e+=Math.sqrt(s*s+c*c);t.push(parseFloat(e.toFixed(2)))})}},h=function(t){for(var a=0;a<i.chart.coordinates.length;a++){if(!(i.chart.coordinates[a].length>2))return e.resolve(null);var o=Math.round(10*i.chart.coordinates[a][2])/10;l&&o>0&&(l=!1);t.push(o);0==a&&(r=s=o);r=Math.min(r,o);s=Math.max(s,o)}};(new ol.format.GeoJSON).readFeatures(a).filter(function(t){return"linestring"===t.getGeometry().getType().toLowerCase()||"multilinestring"===t.getGeometry().getType().toLowerCase()}).forEach(function(e){switch((c=e.getGeometry()).getType().toLowerCase()){case"linestring":if(t.layout===ol.geom.GeometryLayout.XYZM||t.layout===ol.geom.GeometryLayout.XYZ){A=u();g();d=TC.tool.Elevation.getElevationGain({coords:c.getCoordinates(),hillDeltaThreshold:i.gapHill});i.chart.coordinates=i.chart.coordinates.concat(c.getCoordinates());p(o);h(n)}break;case"multilinestring":if(t.layout===ol.geom.GeometryLayout.XYZM||t.layout===ol.geom.GeometryLayout.XYZ)for(var a,r=c.getLineStrings(),s=0;s<r.length;s++){g(r[s]);r[s].getLayout()==ol.geom.GeometryLayout.XYZM&&(a+=r[s].getLastCoordinate()[3]-r[s].getFirstCoordinate()[3]);i.chart.coordinates=i.chart.coordinates.concat(r[s].getCoordinates());a&&(A=u());p(o);h(n)}break;default:return null}});n instanceof Array&&0==n.length&&(l=!0);i.chartData=l?null:$.extend({},{time:A,ele:n,x:o,miny:r,maxy:s},d);return e.resolve(i.chartData)}return e.resolve(null)})});return e})(e).then(function(e){TC.Util.getMapLocale(i.map);if(null!=e){e.time&&(e.time=("00000"+e.time.h).slice(-2)+":"+("00000"+e.time.m).slice(-2)+":"+("00000"+e.time.s).slice(-2));e.coords=i.chart.coordinates;i.hasElevation=!0;i.elevationActive.set(!0)}else{i.hasElevation=!1;e={msg:i.getLocaleString("geo.trk.chart.chpe.empty")};i.elevationActive.set(!1)}e.minHeight=i.CHART_SIZE.MIN_HEIGHT;e.maxHeight=i.CHART_SIZE.MAX_HEIGHT;e.minWidth=i.CHART_SIZE.MIN_WIDTH;e.mediumWidth=i.CHART_SIZE.MEDIUM_WIDTH;e.maxWidth=i.CHART_SIZE.MAX_WIDTH;if(i.resultsPanelChart){i.resultsPanelChart.show();i.map.$events.trigger($.Event(i.Const.Event.DRAWTRACK),{data:e})}else{window.c3||TC.syncLoadJS(TC.Consts.url.D3C3||TC.apiLocation+"lib/d3c3/d3c3.min.js");i.map.addControl("resultsPanel",{div:$("<div>").appendTo(i.map._$div),content:"chart",titles:{main:i.getLocaleString("geo.trk.chart.chpe"),max:i.getLocaleString("geo.trk.chart.chpe")},openOn:i.Const.Event.DRAWTRACK,closeOn:i.Const.Event.CLEARTRACK,chart:{ctx:i,onmouseout:t.removeElevationTooltip,tooltip:t.getElevationTooltip}}).then(function(t){i.resultsPanelChart=t;t.renderPromise().then(function(){t.activateSnapping=function(t){i.layerTrack&&!i.layerTrack.getVisibility()&&0==i.layerTrack.getOpacity()&&i.wrap.deactivateSnapping.call(i.wrap)};t.deactivateSnapping=function(t){i.layerTrack&&i.layerTrack.getVisibility()&&i.layerTrack.getOpacity()>0&&i.wrap.activateSnapping.call(i.wrap)};t._$div.on("mouseover",t.deactivateSnapping);t._$div.on("mouseout",t.activateSnapping);i.map.$events.on(TC.Consts.event.RESULTSPANELMIN,function(){$(i.miDiv).hide();i.elevationActiveCollapsed.set(!0)}).on(TC.Consts.event.RESULTSPANELMAX,function(){$(i.miDiv).show();i.elevationActiveCollapsed.set(!1)}).on(TC.Consts.event.RESULTSPANELCLOSE,function(){$(i.miDiv).hide();i.elevationActive.set(!1)});t.show();i.map.$events.trigger($.Event(i.Const.Event.DRAWTRACK),{data:e})})})}})};t.clear=function(t){var e=this;if(e.onResize){window.removeEventListener("resize",e.onResize,!1);e.onResize=void 0}if(t==e.Const.Layers.TRACK){e.resultsPanelChart&&e.resultsPanelChart.close();delete e.chartData;e.wrap.simulateTrackEnd();e.wrap.clear();e.track.$trackList.find("li").removeClass(e.Const.Classes.SELECTEDTRACK);if(void 0!==e.layerTrack){e.map.removeLayer(e.layerTrack);e.layerTrack=void 0}e.map.$events.trigger($.Event(e.Const.Event.CLEARTRACK),{})}else e.getLayer(t).then(function(t){e.wrap.clear(t)})};t.saveTrack=function(){var t=this,e=new $.Deferred,a=arguments.length>0&&"string"==typeof arguments[0]?arguments[0]:t.getLocaleString("geo.trk.save.alert"),i=function(i){t.getLayer(i).then(function(i){var o;o=t.getLoadingIndicator().addWait();var n=t.importedFileName||t.track.$trackName.val().trim(),r=t.availableTracks;r||(r=[]);var s=TC.getUID(),c=t.wrap.formattedToStorage(i,!0);r.push({name:n,data:c.features,layout:c.layout,uid:parseInt(s),crs:t.storageCRS});r=m(r);var d=function(e){t.track.$trackName.val("");t.track.$trackName.attr("disabled","disabled");t.track.$trackSave.attr("disabled","disabled");t.track.$trackWPT.val("");t.track.$trackWPT.attr("disabled","disabled");t.track.$trackAdd.attr("disabled","disabled");t.getLoadingIndicator().removeWait(e);l.call(t)};try{t.setStoredTracks(r).then(function(){t.map.toast(a,{duration:3e3});d(o);for(var i,n=0;n<r.length;n++)if(parseInt(r[n].uid)===parseInt(s)){i=n;break}e.resolve(i)})}catch(a){TC.alert(t.getLocaleString("geo.error.savelocalstorage")+": "+a.message);d(o);e.reject()}})};if(t.importedFileName)i(t.Const.Layers.TRACK);else if(0==t.track.$trackName.val().trim().length){t.track.$trackName.val((new Date).toLocaleString());i(t.Const.Layers.TRACKING)}else i(t.Const.Layers.TRACKING);return e};t.addWaypoint=function(){var t=this.track.$trackWPT.val().trim();t||(t=(new Date).toLocaleString());var e=this.getLoadingIndicator().addWait();l.call(this);this.wrap.addWaypoint(this.currentPoint.position,{name:t,ele:this.currentPoint.heading,time:(new Date).getTime()});this.track.$trackWPT.val("");this.track.$trackWPT.attr("disabled","disabled");this.track.$trackAdd.attr("disabled","disabled");TC.Util.storage.setSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP,this.wrap.formattedToStorage(this.layerTracking).features);this.getLoadingIndicator().removeWait(e)};t.editTrackName=function(t,e){var a=this;a.getAvailableTracks().then(function(i){if(i&&i[t]){i[t].name=e;a.setStoredTracks(i)}})};t.removeTrack=function(t){var e=this;e.getAvailableTracks().then(function(a){if(a){var i=$(t).attr("data-id");if(a[i]){var o=a[i].uid;TC.confirm(e.getLocaleString("geo.trk.delete.alert"),function(){e.getSelectedTrack().length>0&&$(e.getSelectedTrack()[0]).attr("data-id")==i&&e.clear(e.Const.Layers.TRACK);localforage.removeItem(e.Const.LocalStorageKey.TRACKING+"#"+o).then(function(){e.getStoredTracks().then(function(){e.bindTracks()})}).catch(function(t){console.log(t)})},function(){})}}})};t.setSelectedTrack=function(t){this.isActive||this.activate();this.track.$trackList.find("li[data-id] > span").each(function(){$(this).attr("title",$(this).text())});this.track.$trackList.find("li").removeClass(this.Const.Classes.SELECTEDTRACK);t.addClass(this.Const.Classes.SELECTEDTRACK);$(t).attr("title",this.getLocaleString("tr.lst.clear")+" "+$(t).find("span").text());$(t).find(this.Const.Selector.DRAW).attr("title",$(t).attr("title"))};t.getSelectedTrack=function(){return this.track.$trackList.find("li."+this.Const.Classes.SELECTEDTRACK)};t.clearSelectedTrack=function(){var t=this.getSelectedTrack();if(t){if(this.onResize){window.removeEventListener("resize",this.onResize,!1);this.onResize=void 0}t.removeClass(this.Const.Classes.SELECTEDTRACK);t.attr("title",t.text());t.find(this.Const.Selector.DRAW).attr("title",t.attr("title"))}};t.clearSelection=function(){this.wrap.deactivateSnapping();this.getSelectedTrack()&&this.clearSelectedTrack();if(this.resultsPanelChart){this.resultsPanelChart._$div.off("mouseover",this.resultsPanelChart.deactivateSnapping);this.resultsPanelChart._$div.off("mouseout",this.resultsPanelChart.activateSnapping);this.resultsPanelChart.close()}this.clear(this.Const.Layers.TRACK)};t.drawTrackingData=function(t){var e=this;e.wrap.clear();e.getTrackingData(t).then(function(t){t.data;t.data&&e.wrap.drawTrackingData(t).then(function(){var t=e.layerTrack.features;if(t&&t.length>0){var a=t.filter(function(t){t.showsPopup=!1;return!!(TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline)||t instanceof TC.feature.Polyline}).map(function(t){return TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline?t.geometry[0]:t instanceof TC.feature.Polyline?t.geometry:void 0})[0];if(a){var i=a[0],o=a[a.length-1];i&&i!==o&&e.layerTrack.addMarker(i.slice().splice(0,2),{showsPopup:!1,cssClass:e.CLASS+"-track-marker-icon-end",anchor:[.5,1]});o&&e.layerTrack.addMarker(o.slice().splice(0,2),{showsPopup:!1,cssClass:e.CLASS+"-track-marker-icon",anchor:[.5,1]})}}e.layerTrack.setVisibility(!0)})})};t.getTrackingData=function(t){var e=this,a=t,i=new $.Deferred;e.getAvailableTracks().then(function(t){if(t){var o=$(a).attr("data-id");if(t[o]){var n=t[o].data;n=e.wrap.formattedFromStorage(n);return i.resolve({data:n,layout:t[o].layout})}}return i.resolve()});return i};t.export=function(t,e){return this.wrap.export(t,e)};t.getElevationTooltip=function(t){this.wrap.showElevationMarker(t);return this.resultsPanelChart.getElevationChartTooltip(t)};t.removeElevationTooltip=function(){this.wrap.hideElevationMarker()};t.clearFileInput=function(t){var e=$(t);e.wrap("<form>").closest("form").get(0).reset();e.unwrap()};t.getLoadingIndicator=function(){if(!this.loading){this.loading=this.map.getControlsByClass(TC.control.LoadingIndicator);this.loading&&this.loading.length>0&&(this.loading=this.loading[0])}return this.loading};t.onGeolocateError=function(t){var e;if(navigator.geolocation){this.currentPosition&&navigator.geolocation.clearWatch(this.currentPosition);if(this.currentPositionTrk){this.currentPositionTrk=this.currentPositionTrk instanceof Array?this.currentPositionTrk:[this.currentPositionTrk];this.currentPositionTrk.forEach(function(t){navigator.geolocation.clearWatch(t)});this.currentPositionTrk=[]}}this.currentPositionWaiting&&this.getLoadingIndicator().removeWait(this.currentPositionWaiting);switch(t.code){case t.PERMISSION_DENIED:e=this.getLocaleString("geo.error.permission_denied");break;case t.POSITION_UNAVAILABLE:e=this.getLocaleString("geo.error.position_unavailable");break;case t.TIMEOUT:e=this.getLocaleString("geo.error.timeout");break;default:e=this.getLocaleString("geo.error.default")}this.map.toast(e,{type:TC.Consts.msgType.WARNING});if(!this.geopositionTracking&&this.track){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)}};t.getTrackingLayer=function(){return this._trackingLayerDeferred};var T=function(t){return!t||0===t.length};t.exportState=function(){const t=this;if(t.exportsState){const e={};if(t.layerTrack){const a=t.layerTrack.exportState();e.id=t.id;e.features=a.features;e.trackName=t.getSelectedTrack().find("span").html()}return e}return null};t.importState=function(t){const e=this;if(e.map&&t.features.length){e.enable();const a=new TC.layer.Vector;a.importState({features:t.features}).then(function(){e.importTrack({features:a.features,fileName:t.trackName})})}}}();