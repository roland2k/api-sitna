TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.RESULTTOOLTIP="resulttooltip.tc";TC.Consts.event.RESULTTOOLTIPEND="resulttooltipend.tc";TC.Consts.event.DRAWCHART="drawchart.tc";TC.Consts.event.DRAWTABLE="drawtable.tc";TC.Consts.event.RESULTSPANELMIN="resultspanelmin.tc";TC.Consts.event.RESULTSPANELMAX="resultspanelmax.tc";TC.Consts.event.RESULTSPANELCLOSE="resultspanelclose.tc";TC.control.ResultsPanel=function(){TC.Control.apply(this,arguments);this.wrap=new TC.wrap.control.ResultsPanel(this);this.data={};this.classes={FA:"fa"};this.contentType={TABLE:{fnOpen:TC.control.ResultsPanel.prototype.openTable,collapsedClass:".fa-list-alt"},CHART:{fnOpen:TC.control.ResultsPanel.prototype.openChart,collapsedClass:".fa-area-chart"}};this.content=this.contentType.TABLE;if(this.options){this.options.content&&(this.content=this.contentType[this.options.content.toUpperCase()]);this.options.chart&&(this.chart=this.options.chart);this.options.table&&(this.table=this.options.table);this.options.save&&(this.save=this.options.save)}};TC.inherit(TC.control.ResultsPanel,TC.Control);!function(){const ctlProto=TC.control.ResultsPanel.prototype;ctlProto.CLASS="tc-ctl-p-results";ctlProto.template={};ctlProto.CHART_SIZE={MIN_HEIGHT:70,MAX_HEIGHT:128,MIN_WIDTH:215,MEDIUM_WIDTH:310,MAX_WIDTH:445};if(TC.isDebug){ctlProto.template[ctlProto.CLASS]=TC.apiLocation+"TC/templates/ResultsPanel.html";ctlProto.template[ctlProto.CLASS+"-table"]=TC.apiLocation+"TC/templates/ResultsPanelTable.html";ctlProto.template[ctlProto.CLASS+"-chart"]=TC.apiLocation+"TC/templates/ResultsPanelChart.html"}else{ctlProto.template[ctlProto.CLASS]=function(){dust.register(ctlProto.CLASS,t);function t(t,e){return t.w('<div class="prpanel-group prsidebar-body " style="display: none" data-no-cb><div class="prpanel prpanel-default"><div class="prpanel-heading"><h4 class="prpanel-title"><span class="prpanel-title-text"></span> <span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-close" title="').h("i18n",e,{},{$key:"close"}).w('"><i class="fa fa-times"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-min" title="').h("i18n",e,{},{$key:"hide"}).w('"><i class="fa fa-chevron-left"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-csv" hidden title="').h("i18n",e,{},{$key:"export.excel"}).w('"><i class="fa fa-file-excel-o"></i></span></h4></div><div id="results" class="prpanel-collapse collapse in"><div class="prpanel-body list-group tc-ctl-p-results-table"> </div><div class="prpanel-body list-group tc-ctl-p-results-chart"></div></div></div></div><div class="prcollapsed prcollapsed-max prcollapsed-pull-left" style="display: none;" title="').h("i18n",e,{},{$key:"expand"}).w('" data-no-cb><i class="fa-list-alt" hidden></i><i class="fa-area-chart" hidden></i></div>')}t.__dustBody=!0;return t};ctlProto.template[ctlProto.CLASS+"-table"]=function(){dust.register(ctlProto.CLASS+"-table",t);function t(t,n){return t.w('<table class="table" style="display:none;"><thead>').s(n.get(["columns"],!1),n,{block:e},{}).w("</thead><tbody>").s(n.get(["results"],!1),n,{block:i},{}).w("</tbody></table>")}t.__dustBody=!0;function e(t,e){return t.w("<th>").f(e.getPath(!0,[]),e,"h").w("</th>")}e.__dustBody=!0;function i(t,e){return t.w("<tr>").h("iterate",e,{block:n},{on:e.getPath(!0,[])}).w("</tr>")}i.__dustBody=!0;function n(t,e){return t.w("<td>").f(e.get(["value"],!1),e,"h").w("</td>")}n.__dustBody=!0;return t};ctlProto.template[ctlProto.CLASS+"-chart"]=function(){dust.register(ctlProto.CLASS+"-chart",t);function t(t,n){return t.w('<div id="track-chart">').x(n.get(["msg"],!1),n,{else:e,block:i},{}).w("</div>")}t.__dustBody=!0;function e(t,e){return t.w('<span id="elevationGain" >').h("i18n",e,{},{$key:"geo.trk.chart.elevationGain"}).w(": +").f(e.get(["upHill"],!1),e,"h").w("m, -").f(e.get(["downHill"],!1),e,"h").w('m</span><div id="chart"></div>')}e.__dustBody=!0;function i(t,e){return t.f(e.get(["msg"],!1),e,"h")}i.__dustBody=!0;return t}}ctlProto.isVisible=function(){this._$div.find(".prsidebar-body").is(":visible")||this._$div.find(".prcollapsed-max").is(":visible")};ctlProto.render=function(t){var e=this;TC.Control.prototype.render.call(e,function(){e.$mainTitle=e._$div.find(".prpanel-title-text");e.$minimize=e._$div.find(".prcollapsed-slide-submenu-min");e.$minimize.on("click",function(){e.minimize()});e.$close=e._$div.find(".prcollapsed-slide-submenu-close");e.$close.on("click",function(){e.close()});e.$maximize=e._$div.find(".prcollapsed-max");e.$maximize.on("click",function(){e.maximize()});if(e.save){e.$save=e._$div.find(".prcollapsed-slide-submenu-csv");e.$save.on("click",function(){e.exportToExcel()});e.$save.removeAttr("hidden")}if(e.content){e.content=e.content;if(e.options.titles){if(e.options.titles.main){e.$mainTitle.attr("title",e.options.titles.main);e.$mainTitle.html(e.options.titles.main)}e.options.titles.max&&e.$maximize.attr("title",e.options.titles.max)}}e._$div.find(e.content.collapsedClass).removeAttr("hidden").addClass(e.classes.FA);e.$divTable=e._$div.find("."+e.CLASS+"-table");e.$divChart=e._$div.find("."+e.CLASS+"-chart");TC.loadJS(Modernizr.touch,TC.apiLocation+"lib/jQuery/jquery.touchSwipe.min.js",function(){if(Modernizr.touch)e._$div.swipe({swipeLeft:function(){e.minimize()}})});t&&"function"==typeof t&&t.call()})};ctlProto.minimize=function(){var t=this;if(0==t._$div.find(t.content.collapsedClass+":visible").length){t._$div.find(t.content.collapsedClass).hasClass(t.classes.FA)||t._$div.find(t.content.collapsedClass).addClass(t.classes.FA);t._$div.find(t.content.collapsedClass).removeAttr("hidden");t._$div.find(".prsidebar-body").toggle("slide",function(){t._$div.find(".prcollapsed-max").fadeIn()});t.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMIN),{})}};ctlProto.maximize=function(){if(0==this._$div.find(this.content.collapsedClass+":hidden").length){this._$div.find(this.content.collapsedClass).attr("hidden","hidden");this._$div.find(".prsidebar-body").toggle("slide");this._$div.find(".prcollapsed-max").hide();this.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMAX),{})}};ctlProto.isMinimized=function(){return 1===this._$div.find(".prcollapsed-max:visible").length&&0===this._$div.find(".prsidebar-body:visible").length};ctlProto.close=function(){this._$div.find(".prsidebar-body").fadeOut("slide");this._$div.find(".prcollapsed-max").hide();this._$div.find(this.content.collapsedClass).attr("hidden","hidden").removeClass(this.classes.FA);this.chart&&this.chart.chart&&(this.chart.chart=this.chart.chart.destroy());this.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELCLOSE,{control:this}))};ctlProto.openChart=function(t){const e=this;if(t)if(t.msg)e.map.toast(t.msg);else{e.elevationProfileCoordinates=t.coords;e.renderElevationProfileChart({data:t,div:e._$div.find("."+ctlProto.CLASS+"-chart")})}else e.map.toast(options.msg);e.map.getLoadingIndicator().hide()};ctlProto.renderElevationProfileChart=function(options){const self=this;options=options||{};TC.loadJS(!window.c3,TC.Consts.url.D3C3||TC.apiLocation+"lib/d3c3/d3c3.min.js",function(){const data=options.data,$div=$(options.div);var locale=TC.Util.getMapLocale(self.map);self.getRenderedHtml(ctlProto.CLASS+"-chart",{upHill:data.upHill.toLocaleString(locale),downHill:data.downHill.toLocaleString(locale)},function(out){$div.html(out);$div.show();if(self.options.titles){if(self.options.titles.main){self._$div.find(".prpanel-title-text").attr("title",self.options.titles.main);self._$div.find(".prpanel-title-text").html(self.options.titles.main)}self.options.titles.max&&self._$div.find(".prcollapsed-max").attr("title",self.options.titles.max)}var chartOptions=$.extend({bindto:$div.find(".tc-chart")[0],padding:{top:0,right:15,bottom:0,left:45},legend:{show:!1}},self.createChartOptions(data));self.chart.tooltip&&(chartOptions.tooltip={contents:function(d){var fn=self.chart.tooltip;"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.tooltip));return fn.call(eval(self.chart.ctx),d)}});self.chart&&self.chart.onmouseout&&(chartOptions.onmouseout=function(){var fn=self.chart.onmouseout;"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.onmouseout));fn.call(eval(self.chart.ctx))});chartOptions.onrendered=function(){$.isFunction(chartOptions._onrendered)&&chartOptions._onrendered.call(this);self.map.$events.trigger($.Event(TC.Consts.event.DRAWCHART,{control:self,svg:this.svg[0][0],chart:this}))};if(window.c3){if(!c3._isOverriden){window.c3.chart.internal.fn.generateDrawLine=function(t,e){var i=this,n=i.config,s=i.d3.svg.line(),o=i.generateGetLinePoints(t,e),l=e?i.getSubYScale:i.getYScale,a=function(t){return(e?i.subxx:i.xx).call(i,t)},r=function(t,e){return n.data_groups.length>0?o(t,e)[0][1]:l.call(i,t.id)(t.value)};s=n.axis_rotated?s.x(r).y(a):s.x(a).y(r);n.line_connectNull||(s=s.defined(function(t){return null!=t.value}));return function(t){var o,a=n.line_connectNull?i.filterRemoveNull(t.values):t.values,r=e?i.x:i.subX,c=l.call(i,t.id),d=0,p=0;if(i.isLineType(t))if(n.data_regions[t.id])o=i.lineWithRegions(a,r,c,n.data_regions[t.id]);else{i.isStepType(t)&&(a=i.convertValuesToStep(a));o=s.interpolate("linear")(a)}else{if(a[0]){d=r(a[0].x);p=c(a[0].value)}o=n.axis_rotated?"M "+p+" "+d:"M "+d+" "+p}return o||"M 0 0"}};window.c3.chart.internal.fn.generateDrawArea=function(t,e){var i=this,n=i.config,s=i.d3.svg.area(),o=i.generateGetAreaPoints(t,e),l=e?i.getSubYScale:i.getYScale,a=function(t){return(e?i.subxx:i.xx).call(i,t)},r=function(t,e){return n.data_groups.length>0?o(t,e)[0][1]:l.call(i,t.id)(0)},c=function(t,e){return n.data_groups.length>0?o(t,e)[1][1]:l.call(i,t.id)(t.value)};s=n.axis_rotated?s.x0(r).x1(c).y(a):s.x(a).y0(r).y1(c);n.line_connectNull||(s=s.defined(function(t){return null!==t.value}));return function(t){var e,o=n.line_connectNull?i.filterRemoveNull(t.values):t.values,l=0,a=0;if(i.isAreaType(t)){i.isStepType(t)&&(o=i.convertValuesToStep(o));e=s.interpolate("linear")(o)}else{if(o[0]){l=i.x(o[0].x);a=i.getYScale(t.id)(o[0].value)}e=n.axis_rotated?"M "+a+" "+l:"M "+l+" "+a}return e||"M 0 0"}};c3._isOverriden=!0}self.chart.chart=c3.generate(chartOptions)}})})};ctlProto.openTable=function(){var t=this;if(i=arguments[0]){var e;i.css&&(e=i.css);var i,n=i.callback,s=i.columns;if((i=i.data)&&i.length>0){if(!s){s=[];for(var o in i[0])s.push(o)}t.tableData={columns:s,results:i,css:e,callback:n};t.getRenderedHtml(t.CLASS+"-table",t.tableData).then(function(e){var i=t._$div.find("."+t.CLASS+"-table"),n=i.parent();i.detach();i.append(e);n.append(i);t.tableData.callback&&t.tableData.callback(i)});t._$div.find("."+t.CLASS+"-chart").hide();t._$div.find(".prsidebar-body").fadeIn("slide")}}t.map.getLoadingIndicator().hide()};ctlProto.open=function(t){var e=this._$div.find("."+this.CLASS+"-table");this.requestIsRendered=window.requestAnimationFrame(function(){var t=e[0].getBoundingClientRect();if(t&&t.width>100){window.cancelAnimationFrame(this.requestIsRendered);this.map.$events.trigger($.Event(TC.Consts.event.DRAWTABLE),{})}}.bind(this));if(t){this._$div.find("."+this.CLASS+"-table").html(t);this._$div.find("."+this.CLASS+"-table").show()}this._$div.find("."+this.CLASS+"-chart").hide();if(this.options.titles){if(this.options.titles.main){this._$div.find(".prpanel-title-text").attr("title",this.options.titles.main);this._$div.find(".prpanel-title-text").html(this.options.titles.main)}this.options.titles.max&&this._$div.find(".prcollapsed-max").attr("title",this.options.titles.max)}1==this._$div.find(this.content.collapsedClass+":visible").length&&this.maximize();this._$div.find(".prsidebar-body").fadeIn("slide");this.map.getLoadingIndicator().hide()};ctlProto.createChartOptions=function(t){const e=this;var i={};const n=(t=t||{}).locale||TC.Util.getMapLocale(e.map);t.chartType;if(null!=t.ele){const l=function(){const i=document.documentElement.clientWidth/100*40;return{height:i>445?t.maxHeight||e.CHART_SIZE.MAX_HEIGHT:t.minHeight||e.CHART_SIZE.MIN_HEIGHT,width:i>445?t.maxWidth||e.CHART_SIZE.MAX_WIDTH:i>310?t.mediumWidth||e.CHART_SIZE.MEDIUM_WIDTH:t.minWidth||e.CHART_SIZE.MIN_WIDTH}};var s=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;t.ele.forEach(function(t){if("number"==typeof t){s=Math.max(t,s);o=Math.min(t,o)}});const a="grad"+TC.getUID();i={data:{x:"x",columns:[["x"].concat(t.x),["ele"].concat(t.ele)],types:{ele:"area-spline"},colors:{ele:"url(#"+a+")"}},size:l(),point:{show:!1},axis:{x:{tick:{outer:!1,count:5,format:function(t){var e,i;if((t/=1e3)<1){e=Math.round(1e3*t);i=" m"}else{e=Math.round(100*t)/100;i=" km"}return(e=e.toLocaleString(n))+i}}},y:{padding:{top:0,bottom:0},max:s,min:o,tick:{count:2,format:function(t){return(parseInt(t.toFixed(0))||0).toLocaleString(n)+"m"}}}},onresize:function(){this.api.resize(l())}};t.time&&(i.time=("00000"+t.time.h).slice(-2)+":"+("00000"+t.time.m).slice(-2)+":"+("00000"+t.time.s).slice(-2));i._onrendered=function(){const t=this.svg[0][0];var i=t.getElementsByTagName("defs")[0],n="http://www.w3.org/2000/svg",s=document.createElementNS(n,"linearGradient");s.setAttributeNS(null,"id",a);s.setAttributeNS(null,"x1","0%");s.setAttributeNS(null,"x2","0%");s.setAttributeNS(null,"y1","0%");s.setAttributeNS(null,"y2","100%");s.setAttributeNS(null,"gradientUnits","userSpaceOnUse");const o=document.createElementNS(n,"stop");o.setAttributeNS(null,"offset","0%");o.setAttributeNS(null,"stop-color","red");o.setAttributeNS(null,"stop-opacity","0.7");s.appendChild(o);const l=document.createElementNS(n,"stop");l.setAttributeNS(null,"offset","50%");l.setAttributeNS(null,"stop-color","orange");l.setAttributeNS(null,"stop-opacity","0.9");s.appendChild(l);const r=document.createElementNS(n,"stop");r.setAttributeNS(null,"offset","100%");r.setAttributeNS(null,"stop-color","green");r.setAttributeNS(null,"stop-opacity","1");s.appendChild(r);i.appendChild(s);$(d3.select(".c3-brush").node()).remove();d3.select(".c3-event-rects,.c3-event-rects-single").selectAll("rect").style("cursor","pointer").on("click",function(t){d3.event.stopPropagation();const i=e.elevationProfileCoordinates[t.index].slice(0,2);i&&TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point"],function(){e.map.zoomToFeatures([new TC.feature.Point(i)])})});var c=d3.select(".c3-axis.c3-axis-x").select("path").attr("d");if(/^M\d\,(\d)V\dH\d{3}V(\d)$/i.exec(c)){c=c.replace(/(M\d\,)\d/i,"$10").replace(/(H\d{3}V)(\d)/i,"$10");d3.select(".c3-axis.c3-axis-x").select("path").attr("d",c)}else{if(/^M\s\d\s(\d)\sV\s\d\sH\s\d{3}\sV\s(\d)$/i.exec(c)){c=c.replace(/(M\s\d\s)\d/i,"$10").replace(/(H\s\d{3}\sV\s)(\d)/i,"$10");d3.select(".c3-axis.c3-axis-x").select("path").attr("d",c)}}const d=$(t),p={width:d.width(),height:d.height()};var u=function(){var t=d3.scale.ordinal().rangeRoundBands([0,p.width],.1,.3);d3.select(".c3-axis-x").selectAll("text:not(.c3-axis-x-label)").call(function(t,e){t.each(function(){t.each(function(t,e){if(0!=e){d3text=d3.select(this);if(!d3text.attr("edited")){d3text.attr("edited",!0);var i=d3text.select("tspan").node().cloneNode(),n=d3text.text().split(" ");d3text.select("tspan").text(n[0]);i.textContent=n[1];var s=i.getAttribute("dy");s=(s=s?parseFloat(i.getAttribute("dy")):.71)+.18+"em";i.setAttribute("dy",s);d3text.node().appendChild(i)}}})})},t.rangeBand())};if(d3.select(".c3-axis-x").node().getBoundingClientRect().width)(d3.select(".c3-axis-x").node().getBoundingClientRect().width>=p.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width||100*d3.select(".c3-axis-x").node().getBoundingClientRect().width/(p.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width)>90)&&u();else{if(e.elevationChartLabelsRAF){window.cancelAnimationFrame(e.elevationChartLabelsRAF);e.elevationChartLabelsRAF=void 0}e.elevationChartLabelsRAF=requestAnimationFrame(function t(){if(d3.select(".c3-axis-x").length&&!d3.select(".c3-axis-x").node())e.elevationChartLabelsRAF=requestAnimationFrame(t);else if(d3.select(".c3-axis-x").length&&d3.select(".c3-axis-x").node()&&!d3.select(".c3-axis-x").node().getBoundingClientRect().width)e.elevationChartLabelsRAF=requestAnimationFrame(t);else{window.cancelAnimationFrame(e.elevationChartLabelsRAF);e.elevationChartLabelsRAF=void 0;(d3.select(".c3-axis-x").node().getBoundingClientRect().width>=p.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width||100*d3.select(".c3-axis-x").node().getBoundingClientRect().width/(p.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width)>90)&&u()}})}e.isMinimized()||e._$div.find(".prsidebar-body").fadeIn("slide");e._$div.find("."+e.CLASS+"-table").hide()}}else i={msg:e.getLocaleString("geo.trk.chart.chpe.empty")};return i};const getTime=function(t,e){var i=e-t,n={},s=Math.floor(i/1e3/60/60/24);i-=1e3*s*60*60*24;var o=Math.floor(i/1e3/60/60);i-=1e3*o*60*60;n.h=o+24*s;var l=Math.floor(i/1e3/60);i-=1e3*l*60;n.m=l;n.s=Math.floor(i/1e3);return $.extend({},n,{toString:("00000"+n.h).slice(-2)+":"+("00000"+n.m).slice(-2)+":"+("00000"+n.s).slice(-2)})};ctlProto.getElevationChartTooltip=function(t){const e=this.elevationProfileCoordinates;var i=t[0].x;i/=1e3;const n=e[t[0].index];var s;4==e[0].length&&e[0][3]>0&&(s=getTime(e[0][3],n[3]));const o=this.map.options.locale&&this.map.options.locale.replace("_","-")||void 0,l=parseInt(t[0].value.toFixed(0)).toLocaleString(o);var a,r;if(i<1){a=Math.round(1e3*i);r=" m"}else{a=Math.round(100*i)/100;r=" km"}return'<div class="track-elevation-tooltip"><div><span>'+l+" m </span><br><span>"+(a=a.toLocaleString(o))+r+" </span></div>"+(s?"<span>"+s.toString+"</span><div/>":"")};ctlProto.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);e.wrap.register(t);e.openOn&&e.map.$events.one(e.openOn,function(t,i){e.content.fnOpen.call(e,i.data)});e.closeOn&&e.map.$events.one(e.closeOn,function(t,i){e.close()});e.options.openOn&&e.map.$events.on(e.options.openOn,function(t,i){e.content.fnOpen.call(e,i.data)});e.options.closeOn&&e.map.$events.on(e.options.closeOn,function(t,i){e.close()})};ctlProto.exportToExcel=function(){var t=this,e=[t.tableData.columns];$.each(t.tableData.results,function(t,i){var n=[];for(var s in i)i.hasOwnProperty(s)&&"Id"!==s&&"Geom"!==s&&n.push(i[s]);e.push(n)});var i=function(i){var n=t.save.fileName?t.save.fileName:"resultados.xls",s=t.options.titles&&t.options.titles.main?t.options.titles.main:null;i.Save(n,e,s)};TC.Util.ExcelExport?i(new TC.Util.ExcelExport):TC.loadJS(!0,TC.apiLocation+"TC/TC.Util.ExcelExport",function(){i(new TC.Util.ExcelExport)})}}();