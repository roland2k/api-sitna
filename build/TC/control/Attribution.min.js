TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Attribution=function(){TC.Control.apply(this,arguments);this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[];this.options.dataAttributions&&(this.dataAttributions=this.options.dataAttributions instanceof Array?this.options.dataAttributions:[this.options.dataAttributions])};TC.inherit(TC.control.Attribution,TC.Control);!function(){var t=TC.control.Attribution.prototype;t.CLASS="tc-ctl-attrib";TC.isDebug?t.template=TC.apiLocation+"TC/templates/Attribution.html":t.template=function(){dust.register(t.CLASS,n);function n(t,n){return t.w("<div><span>&copy; ").f(n.get(["api"],!1),n,"h",["s"]).w("</span> - ").h("i18n",n,{},{$key:"data"}).w(": ").x(n.getPath(!1,["mainData","site"]),n,{else:i,block:a},{}).x(n.get(["otherData"],!1),n,{block:r},{}).w('<div class="tc-ctl-attrib-other tc-collapsed">').s(n.get(["otherData"],!1),n,{block:e},{}).w("</div></div>")}n.__dustBody=!0;function i(t,n){return t.w("<span>&copy; ").f(n.getPath(!1,["mainData","name"]),n,"h").w("</span>")}i.__dustBody=!0;function a(t,n){return t.w('<span>&copy; <a href="').f(n.getPath(!1,["mainData","site"]),n,"h").w('" target="_blank">').f(n.getPath(!1,["mainData","name"]),n,"h").w("</a></span>")}a.__dustBody=!0;function r(t,n){return t.w(' - <span class="tc-ctl-attrib-cmd">').h("i18n",n,{},{$key:"others"}).w("...</span>")}r.__dustBody=!0;function e(t,n){return t.x(n.getPath(!1,["otherData",n.get(["$idx"],!1),"site"]),n,{else:o,block:s},{}).h("sep",n,{block:u},{})}e.__dustBody=!0;function o(t,n){return t.w("<span>&copy; ").f(n.getPath(!1,["otherData",n.get(["$idx"],!1),"name"]),n,"h").w("</span>")}o.__dustBody=!0;function s(t,n){return t.w('<span>&copy; <a href="').f(n.getPath(!1,["otherData",n.get(["$idx"],!1),"site"]),n,"h").w('" target="_blank">').f(n.getPath(!1,["otherData",n.get(["$idx"],!1),"name"]),n,"h").w("</a></span>")}s.__dustBody=!0;function u(t,n){return t.w(", ")}u.__dustBody=!0;return n};t.register=function(t){var n=this;TC.Control.prototype.register.call(n,t);n.apiAttribution=n.map.options.attribution||n.apiAttribution;var i=function(t){if(t){var i=t.getAttribution();if(i)if(/IDENA/.test(i.name))n.mainDataAttribution={name:"IDENA",site:"http://idena.navarra.es/"};else{for(var a=!1,r=0;r<n.dataAttributions.length;r++)if(i.name===n.dataAttributions[r].name){a=!0;break}a||n.dataAttributions.push(i)}}},a=function(t){if(t){if(!(t instanceof TC.Layer)||function(){if(t.map.workLayers.length>0){for(var n=t.map.workLayers.slice().reverse(),i=0;i<n.length;i++)if(n[i].url==t.url&&n[i].getVisibility())return!1;return!0}return!0}()){var i=t.getAttribution();if(i){var a=n.dataAttributions.reduce(function(t,n,a){return n.name===i.name?a:t},-1);a>-1&&n.dataAttributions.splice(a,1)}}}};n.render();t.on(TC.Consts.event.LAYERADD,function(t){if(t.layer.wrap.getAttribution){i(t.layer.wrap);n.render()}});t.on(TC.Consts.event.LAYERREMOVE,function(t){if(t.layer.wrap.getAttribution){a(t.layer.wrap);n.render()}});t.on(TC.Consts.event.TERRAINPROVIDERADD,function(t){if(t.terrainProvider.getAttribution){i(t.terrainProvider);n.render()}});t.on(TC.Consts.event.TERRAINPROVIDERREMOVE,function(t){if(t.terrainProvider.getAttribution){a(t.terrainProvider);n.render()}});t.on(TC.Consts.event.LAYERVISIBILITY,function(t){if(t.layer.wrap.getAttribution){t.layer.getVisibility()?i(t.layer.wrap):a(t.layer.wrap);n.render()}})};t.render=function(t){var n=this;n.renderData({api:n.apiAttribution,mainData:n.mainDataAttribution,otherData:n.dataAttributions},function(){n._$div.find("."+n.CLASS+"-cmd").on(TC.Consts.event.CLICK,function(){n._$div.find("."+n.CLASS+"-other").toggleClass(TC.Consts.classes.COLLAPSED)});$.isFunction(t)&&t()})}}();