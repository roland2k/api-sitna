TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");!function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline";TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi";TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile";TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";var e=window.applicationCache;TC._appCacheBuilders||(TC._appCacheBuilders=[]);TC._appCacheUpdater||(TC._appCacheUpdater=function(e,t){TC.Util.getQueryStringParams(t);for(var a=0,s=TC._appCacheBuilders.length;a<s;a++){var n=TC._appCacheBuilders[a];switch(e.type){case"cached":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:t}));break;case"obsolete":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:t}));break;case"checking":break;case"progress":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:t,loaded:e.loaded,total:e.total}));break;case"error":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:e.reason,status:e.status}));break;case"noupdate":case"updateready":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:"already_exists",status:e.status}))}}});var t,a=function(){var e=$.Deferred(),t=$("html").attr("manifest");t?$.ajax({url:t,type:"GET",dataType:"text"}).done(function(t){TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var a=hex_md5(t),s=t.indexOf("NETWORK:");s>=0&&(t=t.substr(0,s));(s=t.indexOf("FALLBACK:"))>=0&&(t=t.substr(0,s));(s=t.indexOf("SETTINGS:"))>=0&&(t=t.substr(0,s));var n=$.grep(t.split(/[\n\r]/),function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});n.shift();e.resolve({hash:a,urls:n})})}).fail(function(){e.reject()}):e.reject();return e};if(e){const a=(t=window.parent!==window&&document.referrer&&TC.Util.isSameOrigin(document.referrer)&&parent.TC&&parent.TC._appCacheUpdater,function(e){t&&parent.TC._appCacheUpdater(e,location.href)});e.addEventListener("cached",a,!1);e.addEventListener("error",a,!1);e.addEventListener("noupdate",a,!1);e.addEventListener("obsolete",a,!1);e.addEventListener("progress",a,!1);e.addEventListener("updateready",a,!1)}TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var t=e._classSelector="."+e.CLASS;e._selectors={DRAW:t+"-draw",DRAWING:t+"-drawing",PROGRESS:t+"-progress",NEW:t+"-new",LIST:t+"-list",LISTITEM:t+"-list > li",DELBTN:t+"-btn-del",OKBTN:t+"-btn-ok",NEWBTN:t+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:t+"-tile-count",NAMETB:t+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:t+"-link-exit",OFFPANEL:t+"-off-panel",BLLIST:t+"-bl-list",BLLISTITEM:t+"-bl-list > li",BLLISTTEXT:t+"-bl-panel-txt",RNGMAXRES:t+"-rng-maxres",SEARCH:t+"-map-available-srch",EMPTYLIST:t+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"};e.storedMaps=[];TC._appCacheBuilders.push(e);try{if(window.localStorage){for(var a=0,s=localStorage.length;a<s;a++){var i=localStorage.key(a);if(0===i.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)&&i!==e.LOCAL_STORAGE_KEY_PREFIX+e.ROOT_CACHE_NAME+".hash"){var r=localStorage.getItem(i).split(" "),l=n(r.shift()),o={name:r.join(" "),extent:l,url:decodeURIComponent(i.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(o)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}}catch(t){TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}var c=$.extend({},s>1?arguments[1]:arguments[0]);e._$dialogDiv=$(TC.Util.getDiv(c.dialogDiv));c.dialogDiv||e._$dialogDiv.appendTo("body");e.mapIsOffline=location.pathname.indexOf("/"+e.CACHE_REQUEST_PATH)===location.pathname.length-e.CACHE_REQUEST_PATH.length-1;e.mapIsOffline&&$(e._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN);TC.Control.apply(e,arguments);e.wrap=new TC.wrap.control.CacheBuilder(e);e.isDownloading=!1;e.baseLayers=[];e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize;e.requestSchemas=[];e.minResolution=0;e.currentMap=null;e._loadedCount=0;var d=history.pushState;history.pushState=function(t){var a;a=d.apply(history,arguments);if(e._$offlinePanelDiv){var s=location.pathname.replace("/"+e.CACHE_REQUEST_PATH,"/"),n=TC.Util.getQueryStringParams();delete n[e.MAP_DEFINITION_PARAM_NAME];delete n[e.MAP_EXTENT_PARAM_NAME];delete n[e.SERVICE_WORKER_FLAG];var i=$.param(n);i.length&&(i="?"+i);var r=s+i+location.hash;e._$offlinePanelDiv.find(e._selectors.EXIT).attr("href",r)}return a};var C=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},u=function(){if(e._$offlinePanelDiv){var t=e._$offlinePanelDiv.find(e._selectors.OFFPANEL);t.removeClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);switch(C.type){case 1:case 2:case void 0:t.addClass(TC.Consts.classes.CONNECTION_WIFI);break;default:t.addClass(TC.Consts.classes.CONNECTION_MOBILE)}}};C.addEventListener&&C.addEventListener("typechange",u);window.addEventListener("online",u);window.addEventListener("offline",function(){e._$offlinePanelDiv&&e._$offlinePanelDiv.find(e._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI)})};TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var s=TC.control.CacheBuilder.prototype;s.CLASS="tc-ctl-cbuild";s.MAP_DEFINITION_PARAM_NAME="map-def";s.MAP_EXTENT_PARAM_NAME="map-extent";s.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.";s.ROOT_CACHE_NAME="root";s.COOKIE_KEY_PREFIX="TC.offline.map.";s.CACHE_REQUEST_PATH="offline";s.SERVICE_WORKER_FLAG="sw";s._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"};s._actions={CREATE:"create",DELETE:"delete"};s.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"];TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc";TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc";TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc";TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc";s.template={};if(TC.isDebug){s.template[s.CLASS]=TC.apiLocation+"TC/templates/CacheBuilder.html";s.template[s.CLASS+"-map-node"]=TC.apiLocation+"TC/templates/CacheBuilderMapNode.html";s.template[s.CLASS+"-bl-node"]=TC.apiLocation+"TC/templates/CacheBuilderBaseLayerNode.html";s.template[s.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CacheBuilderDialog.html";s.template[s.CLASS+"-off-panel"]=TC.apiLocation+"TC/templates/CacheBuilderOfflinePanel.html"}else{s.template[s.CLASS]=function(){dust.register(s.CLASS,e);function e(e,s){return e.w("<h2>").h("i18n",s,{},{$key:"offlineMaps"}).w('</h2><div class="tc-ctl-cbuild-content"><div class="tc-ctl-cbuild-draw tc-hidden"></div><i class="tc-ctl-cbuild-map-search-icon"></i><input type="search" list="').f(s.get(["listId"],!1),s,"h").w('" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="').h("i18n",s,{},{$key:"cb.filter.plhr"}).w('"').x(s.get(["storedMaps"],!1),s,{else:t,block:a},{}).w(' maxlength="200" /> <ul id="').f(s.get(["listId"],!1),s,"h").w('" class="tc-ctl-cbuild-list"><li class="tc-ctl-cbuild-map-available-empty"').x(s.get(["storedMaps"],!1),s,{block:n},{}).w("><span>").h("i18n",s,{},{$key:"cb.noMaps"}).w('</span></li><li class="tc-ctl-cbuild-map-not" hidden><span>').h("i18n",s,{},{$key:"noMatches"}).w("</span></li>").s(s.get(["storedMaps"],!1),s,{block:i},{}).w('</ul><div class="tc-ctl-cbuild-new"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="').h("i18n",s,{},{$key:"newofflinemap"}).w('">').h("i18n",s,{},{$key:"newOfflineMap"}).w('</button></div><div class="tc-ctl-cbuild-drawing tc-hidden"><div class="tc-ctl-cbuild-tile-cmd"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="').h("i18n",s,{},{$key:"cancel"}).w('">').h("i18n",s,{},{$key:"cancel"}).w('</button></div></div><div class="tc-ctl-cbuild-progress tc-hidden"><p>').h("i18n",s,{},{$key:"cb.DownloadingMap|s"}).w(': <span class="tc-ctl-cbuild-progress-count"></span></p><div class="tc-ctl-cbuild-progress-bar"><div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div></div><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="').h("i18n",s,{},{$key:"cancel"}).w('">').h("i18n",s,{},{$key:"cancel"}).w("</button></div></div>")}e.__dustBody=!0;function t(e,t){return e.w(" disabled")}t.__dustBody=!0;function a(e,t){return e}a.__dustBody=!0;function n(e,t){return e.w(" hidden")}n.__dustBody=!0;function i(e,t){return e.p("tc-ctl-cbuild-map-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return e};s.template[s.CLASS+"-map-node"]=function(){dust.register(s.CLASS+"-map-node",e);function e(e,t){return e.w('<li data-extent="').f(t.get(["extent"],!1),t,"h").w('"><span><a href="').f(t.get(["url"],!1),t,"h").w('" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</a></span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /><button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"cancel"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"editMapName"}).w('">').h("i18n",t,{},{$key:"editMapName"}).w('</button><button class="tc-btn-view" title="').h("i18n",t,{},{$key:"viewMapExtent"}).w('">').h("i18n",t,{},{$key:"viewMapExtent"}).w('</button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"deleteMap"}).w('">').h("i18n",t,{},{$key:"deleteMap"}).w("</button></li>")}e.__dustBody=!0;return e};s.template[s.CLASS+"-bl-node"]=function(){dust.register(s.CLASS+"-bl-node",e);function e(e,t){return e.w('<li class="tc-ctl-cbuild-bl-node" data-tc-layer-uid="').f(t.get(["id"],!1),t,"h").w('"><label style="background-size: 100% 100%; background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"><input type="checkbox" name="cbbl" value="').f(t.get(["id"],!1),t,"h").w('" disabled><span>').f(t.get(["title"],!1),t,"h").w("</span></label></li>")}e.__dustBody=!0;return e};s.template[s.CLASS+"-dialog"]=function(){dust.register(s.CLASS+"-dialog",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"newOfflineMap"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><input type="text" class="tc-ctl-cbuild-txt-name" placeholder="').h("i18n",t,{},{$key:"nameRequired"}).w('" required /><div class="tc-ctl-cbuild-bl-panel"><h4>').h("i18n",t,{},{$key:"availableOfflineMaps"}).w("</h4><p>").h("i18n",t,{},{$key:"selectAtLeastOne"}).w(':</p><ul class="tc-ctl-cbuild-bl-list"></ul></div><div class="tc-ctl-cbuild-res-panel"><h4>').h("i18n",t,{},{$key:"maxRes"}).w('</h4><div class="tc-ctl-cbuild-res"></div><input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="').h("i18n",t,{},{$key:"maxRes"}).w('"></div><div class="tc-ctl-cbuild-tile-count"></div></div><div class="tc-modal-footer"><button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>').h("i18n",t,{},{$key:"ok"}).w('</button><button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div></div>")}e.__dustBody=!0;return e};s.template[s.CLASS+"-off-panel"]=function(){dust.register(s.CLASS+"-off-panel",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-off-panel tc-conn-wifi"><span>').h("i18n",t,{},{$key:"offlineMap"}).w('</span> <a href="" class="tc-ctl-cbuild-link-exit" title="').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w('"><span>').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w("</span></a></div>")}e.__dustBody=!0;return e}}var n=function(e){return $.map(decodeURIComponent(e).split(","),function(e){return parseFloat(e)})},i=function(e){e._state=e._states.READY;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).removeClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.extent=null;e._loadedCount=0;e.boxDraw&&e.boxDraw.cancel()},r=function(e,t){t.find("span").first().removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.SAVEBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).removeClass(TC.Consts.classes.HIDDEN)},l=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},o=function(e,t){var a,s,n,i=t||{},r=e._$dialogDiv.find(e._classSelector+"-res"),l=e._$dialogDiv.find(e._selectors.RNGMAXRES),o=e.getResolutions();if(o.length){if(e.minResolution){if(void 0===i.rangeValue)for(var c=0,d=o.length;c<d;c++)if(e.minResolution>=o[c]){l.val(c);break}}else void 0===i.rangeValue&&l.val(Math.floor(o.length/2));s=parseInt(l.attr("max",o.length-1).val());var C=Math.floor(1e3*new Number(o[s]))/1e3;a=e.getLocaleString("metersPerPixel",{value:C.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))});n=100*(s+1)/(o.length+1)+"%";l.prop("disabled",!1);e.minResolution=o[l.val()]}else{s=0;a="";l.val(0);n="0";e.minResolution=0;l.prop("disabled",!0)}r.css("left",n).html(a)},c=function(e){e._$dialogDiv.find(e._classSelector+"-bl-node input[type=checkbox]").each(function(t,a){var s=$(a);if(s.prop("checked")){var n=e.requestSchemas.filter(function(e){return e.layerId===s.val()})[0];if(n){var i=function(e,t){for(var a=null,s=0,n=e.tileMatrixLimits.length;s<n&&!((a=e.tileMatrixLimits[s]).res<=t);s++);return a}(n,e.minResolution);if(i){var r=n.url;if(r.indexOf("{TileMatrix}")<0){var l=r.indexOf("?");l>=0&&(r=r.substr(0,l));for(var o=0,c=e.baseLayers.length;o<c;o++){var d=e.baseLayers[o];if(d.id===n.layerId){r=r+"?layer="+d.layerNames+"&style=default&tilematrixset="+d.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+d.format+"&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}";break}}}s.parent("label").css("background-size","auto").css("background-position","left bottom").css("background-image","url("+r.replace("{TileMatrix}",i.mId).replace("{TileRow}",i.rt).replace("{TileCol}",i.cl)+")")}}}})},d=function(e,t){return t<1?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:l(t)})},C=function(e){var t="";e.tileCount=0;for(var a=0,s=e.requestSchemas.length;a<s;a++)for(var n=e.requestSchemas[a],i=0,r=n.tileMatrixLimits.length;i<r;i++){var o=n.tileMatrixLimits[i];e.tileCount+=(o.cr-o.cl+1)*(o.rb-o.rt+1);if(o.res<e.minResolution)break}if(e.tileCount){e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576);t=e.getLocaleString("xTiles",{quantity:l(e.tileCount)})+" ("+d(e,e.estimatedMapSize)+")"}e._$dialogDiv.find(e._selectors.TILECOUNT).html(t)},u=function(e,t){var a=t.indexOf("#");a>=0&&(t=t.substr(0,a));return e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().attr("href")===t})},f=function(e,t){$("<iframe>").css("display","none").attr("src",t).appendTo(e._$div)},p=function(e,t){e._$div.find('iframe[src="'+t+'"]').remove()},T=function(e,t){var a=!1;if(window.localStorage){localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name);a=!0}return a},v=function(e,t){var a=e.findStoredMap({url:t});if(a){(function(e,t){var a=!1;if(window.localStorage){localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t));a=!0}return a})(e,t)&&function(e,t){return e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().html()===t})}(e,a.name).remove();var s=$.inArray(a,e.storedMaps);e.storedMaps.splice(s,1);if(!e.storedMaps.length){e._$div.find(e._selectors.SEARCH).prop("disabled",!0);e._$div.find(e._selectors.EMPTYLIST).removeAttr("hidden")}return a.name}return null},E=function(e){e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!e.extent||0===e._$dialogDiv.find(e._selectors.NAMETB).val().length||e._$dialogDiv.find(e._selectors.RNGMAXRES).prop("disabled"))};s.render=function(e){var t=this,s={storedMaps:t.storedMaps,listId:t.CLASS+"-list-"+TC.getUID()};t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e);t._$dialogDiv.find(t._selectors.NAMETB).on(TC.Consts.event.CLICK,function(e){e.preventDefault();this.selectionStart=0;this.selectionEnd=this.value.length;this.focus()})}).then(function(){t.renderData(s,function(){t._$dialogDiv.find(t._selectors.OKBTN).on(TC.Consts.event.CLICK,function(){var e={mapName:t._$dialogDiv.find(t._selectors.NAMETB).val()};if(t.findStoredMap({name:e.mapName}))TC.alert(t.getLocaleString("cb.mapNameAlreadyExists.error",e));else{var s=function(){t._$div.find(t._classSelector+"-name").html(e.mapName);t.map.toast(t.getLocaleString("downloadingMap",{mapName:e.mapName}));!function(e){e._state=e._states.DOWNLOADING;TC.Util.closeModal();e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).removeClass(TC.Consts.classes.HIDDEN);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e.layer.clearFeatures();e.boxDraw.cancel()}(t);t.requestCache(e)},n=navigator.temporaryStorage||navigator.webkitTemporaryStorage||{};if(n.queryUsageAndQuota)n.queryUsageAndQuota(function(a,n){var i=(n-a)/1048576;t.estimatedMapSize<i?s():TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:e.mapName,mapSize:d(t,t.estimatedMapSize),availableStorage:d(t,Math.round(i))}),s)},function(e){TC.error(e)});else{var i=TC.Util.detectIE();if(i){var r=i<12?1e3:2e3,o=0,c=function(){var a=t.tileCount+o;a>r?TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonCount",{mapName:e.mapName,resourceCount:l(a),maxResourceCount:l(r)}),s):s()};a().done(function(e){o=e.urls.length;c()}).fail(c)}else s()}}});t._$dialogDiv.find(t._selectors.NAMETB).on("input",function(){E(t)});t._$div.find(t._selectors.NEWBTN).on(TC.Consts.event.CLICK,function(){!function(e){e._state=e._states.EDITING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).removeClass(TC.Consts.classes.HIDDEN);e.map.toast(e.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO});e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.NAMETB).val("");e.boxDraw.activate()}(t)});t._$div.find(t._classSelector+"-btn-cancel-draw").on(TC.Consts.event.CLICK,function(){i(t)});t._$div.find(t._classSelector+"-btn-cancel-dl").on(TC.Consts.event.CLICK,function(){t.cancelCacheRequest()});t._$div.find(t._selectors.LIST).on(TC.Consts.event.CLICK,t._selectors.DELETEBTN,function(e){if(navigator.onLine){$btn=$(e.target);var a=$btn.parent().find("a").html();if(a){var s=t.getLocaleString("cb.delete.confirm",{mapName:a});t.serviceWorkerEnabled||(s=s+" "+t.getLocaleString("cb.delete.confirm.connect.warning"));if(confirm(s))if(navigator.onLine){!function(e){e._state=e._states.DELETING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).addClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.boxDraw.cancel()}(t);t.deleteMap(a)}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}).on(TC.Consts.event.CLICK,t._selectors.EDITBTN,function(e){!function(e,t){t.find("span").first().addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).removeClass(TC.Consts.classes.HIDDEN).val(t.find("span a").html()).focus();t.find(e._selectors.SAVEBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).addClass(TC.Consts.classes.HIDDEN)}(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.CANCELBTN,function(e){var a=$(e.target).parent();a.find(t._selectors.TEXTBOX).val(a.find("a").html());r(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.SAVEBTN,function(e){var a=$(e.target).parent();r(t,a);var s=a.find("a"),n=(s.html(),a.find(t._selectors.TEXTBOX).val()),i=t.findStoredMap({url:s.attr("href")});if(i){i.name=n;s.html(n);s.attr("title",n);T(t,i)}}).on(TC.Consts.event.CLICK,t._selectors.VIEWBTN,function(e){$btn=$(e.target);var a=!$btn.hasClass(TC.Consts.classes.ACTIVE);t._$div.find(t._selectors.VIEWBTN).removeClass(TC.Consts.classes.ACTIVE).parent().removeClass(TC.Consts.classes.ACTIVE);var s=$btn.parent().find("a").html();if(s){var i=t.findStoredMap({name:s});if(i){var r=n(i.extent);t.layer.clearFeatures();if(a){t.layer.addPolygon([[[r[0],r[1]],[r[0],r[3]],[r[2],r[3]],[r[2],r[1]]]],{showsPopup:!1}).then(function(){t.layer.map.zoomToFeatures(t.layer.features)});$btn.addClass(TC.Consts.classes.ACTIVE);$btn.parent().addClass(TC.Consts.classes.ACTIVE);$btn.attr("title",t.getLocaleString("removeMapExtent"))}}}});var s=function(e){e=e.toLowerCase();var a=t._$div.find(t._selectors.LISTITEM).hide(),s=a.filter("li:not([class]),li."+TC.Consts.classes.ACTIVE);if(0===e.length){s.show();t._$div.find(t._classSelector+"-map-search-icon").css("visibility","visible")}else{t._$div.find(t._classSelector+"-map-search-icon").css("visibility","hidden");var n=new RegExp(e,"i");s.each(function(){var e=$(this);e.toggle(n.test(e.find("a").text()))});0===s.filter(":visible").length&&a.filter('[class^="tc-ctl-cbuild-map-not"]').show()}},f=t._$div.find(t._selectors.SEARCH);f.on("keyup search",function(){s($(this).val().toLowerCase().trim())});try{if(f.has($("::-ms-clear"))){f.on("mouseup",function(e){""!==f.val()&&setTimeout(function(){var e=f.val();""===e&&s(e)},1)})}}catch(e){}t._$dialogDiv.find(t._selectors.BLLIST).on("change","input[type=checkbox]",function(e){t.baseLayers.length=0;t._$dialogDiv.find(t._selectors.BLLIST+" input[type=checkbox]").each(function(e,a){var s=$(a);if(s.prop("checked"))for(var n=s.val(),i=0,r=t.map.baseLayers.length;i<r;i++){var l=t.map.baseLayers[i];if(l.id===n&&l.type===TC.Consts.layerType.WMTS){t.baseLayers[t.baseLayers.length]=l;break}}});t.updateRequestSchemas();o(t);c(t);E(t);C(t)});t._$dialogDiv.find(t._selectors.RNGMAXRES).on("input change",function(e){o(t,{rangeValue:$(e.target).val()});c(t);C(t)});TC.Util.getQueryStringParams();u(t,location.href).addClass(TC.Consts.classes.ACTIVE);$.isFunction(e)&&e()})});window.addEventListener("beforeunload",function(e){if(t.isDownloading){var a=t.getLocaleString("cb.mapDownloading.warning");e.returnValue=a;return a}},!0)};s.register=function(e){var t=this;TC.control.SWCacheClient.prototype.register.call(t,e);if(navigator.serviceWorker){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total}));break;case"cached":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name}));break;case"deleted":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name}));break;case"error":e.data.action===t._actions.CREATE&&TC.error(t.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}});a().then(function(e){const a=t.LOCAL_STORAGE_KEY_PREFIX+t.ROOT_CACHE_NAME+".hash";var s;window.localStorage&&(s=localStorage.getItem(a));if(s!==e.hash){t.cacheUrlList(e.urls);t.one(TC.Consts.event.MAPCACHEDOWNLOAD,function(){window.localStorage&&localStorage.setItem(a,e.hash)})}})}if(t.mapIsOffline){e._$div.addClass(TC.Consts.classes.OFFLINE);t._$offlinePanelDiv=$(TC.Util.getDiv(t.options.offlinePanelDiv));t.options.offlinePanelDiv||t._$offlinePanelDiv.appendTo(e._$div);t.getRenderedHtml(t.CLASS+"-off-panel",null,function(e){t._$offlinePanelDiv.html(e);navigator.onLine||t._$offlinePanelDiv.find(t._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);t._$offlinePanelDiv.find(t._selectors.EXIT).on(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})}const s=t.getUID(),r=t.getUID();t.layer=null;$.when(t.renderPromise(),e.addControl("draw",{id:s,div:t._$div.find(t._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,persistent:!1}),e.addLayer({id:r,type:TC.Consts.layerType.VECTOR,stealth:!0,styles:{line:e.options.styles.line}})).then(function(a,s,n){t.boxDraw=s;t.layer=n;s.setLayer(n);s.$events.on(TC.Consts.event.DRAWSTART,function(e){t.map.toast(t.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(e){var a=e.feature.geometry[0],s=a[0],n=a[2],i=Math.min(s[0],n[0]),r=Math.max(s[0],n[0]),l=Math.min(s[1],n[1]),o=Math.max(s[1],n[1]);t.setExtent([i,l,r,o]);var d,u=t._$dialogDiv.find("input[type=checkbox]");u.each(function(e,a){for(var s=0,n=t.map.baseLayers.length;s<n;s++){var i=t.map.baseLayers[s];if(a.value===i.id){var r=$(a),l=r.parents("li").first(),o=i.getResolutions(),c=t.wrap.getRequestSchemas({extent:t.extent,layers:[i]})[0].tileMatrixLimits;if(c.length&&o[o.length-1]==c[c.length-1].res)l.removeClass(TC.Consts.classes.HIDDEN);else{r.prop("checked",!1);l.addClass(TC.Consts.classes.HIDDEN)}break}}});d=t._$dialogDiv.find(t._selectors.BLLISTITEM).filter(":not(."+TC.Consts.classes.HIDDEN+")").length?"selectAtLeastOne":"cb.noMapsAtSelectedExtent";t._$dialogDiv.find(t._selectors.BLLISTTEXT).html(t.getLocaleString(d));c(t);C(t);TC.Util.showModal(t._$dialogDiv.find(t._classSelector+"-dialog"),{openCallback:function(){u.prop("disabled",!1);var e;if(Date.prototype.toLocaleString){var a={};a.year=a.month=a.day=a.hour=a.minute=a.second="numeric";e=(new Date).toLocaleString(t.map.options.locale.replace("_","-"),a)}else e=(new Date).toString();t._$dialogDiv.find(t._selectors.NAMETB).val(e)[0];E(t)},closeCallback:function(){u.prop("disabled",!0);t.layer.clearFeatures()}})});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){s===e.control&&t._state===t._states.EDITING&&i(t)})});var l=function(e){var a=!1,s=t._$dialogDiv.find(t._selectors.BLLIST),n=function(){return s.find('li[data-tc-layer-uid="'+e.id+'"]').length>0},i=e.type===TC.Consts.layerType.WMTS&&!e.mustReproject;TC.Util.detectSafari()&&TC.Util.detectIOS()&&(i=i&&TC.Util.isSameOrigin(e.url));if(i&&!n()){a=!0;t.getRenderedHtml(t.CLASS+"-bl-node",e,function(e){n()||s.append(e)})}return a};e.on(TC.Consts.event.LAYERADD,function(e){l(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){e.layer.type===TC.Consts.layerType.WMTS&&t._$dialogDiv.find(t._selectors.BLLIST).find('li[data-tc-layer-uid="'+e.layer.id+'"]').remove()});var o=TC.Util.getQueryStringParams(),d=o[t.MAP_DEFINITION_PARAM_NAME],f=o[t.MAP_EXTENT_PARAM_NAME];e.ready(function(){if(t.mapIsOffline){for(var a=[],s=0,n=t.offlineControls.length;s<n;s++){var i=t.offlineControls[s];i=i.substr(0,1).toUpperCase()+i.substr(1);a=a.concat(e.getControlsByClass("TC.control."+i))}for(s=0,n=e.controls.length;s<n;s++){var r=e.controls[s];a.indexOf(r)<0&&r.disable()}$(t._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN)}});e.loaded(function(){e.putLayerOnTop(t.layer);t._firstRender.then(function(){t._$div.find(t._selectors.NEWBTN).prop("disabled",!1);for(var a=0,s=e.baseLayers.length;a<s;a++)l(e.baseLayers[a])});if(t.mapIsOffline){var a=JSON.parse(window.atob(decodeURIComponent(d))),s=[],i=$.grep(e.baseLayers,function(e){var t=!1;if(e.type===TC.Consts.layerType.WMTS)for(var n=0,i=a.layers.length;n<i;n++){var r=a.layers[n];if((0===e.url.indexOf("//")?location.protocol+e.url:e.url)===a.url[r.urlIdx]&&e.layerNames===r.id&&e.matrixSet===a.tms[r.tmsIdx]){t=!0;break}}t||e.type!==TC.Consts.layerType.VECTOR&&(s[s.length]=e);return t})[0];i&&e.setBaseLayer(i);for(var r=0,o=s.length;r<o;r++)e.removeLayer(s[r]);e.setExtent(n(f))}});t.$events.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(a){t.isDownloading=!1;var s=function(e){var t=e.indexOf("#");return t>=0?e.substr(0,t):e}(a.url),n=u(t,s);if(n.length&&!t.serviceWorkerEnabled){n.removeClass(TC.Consts.classes.DISABLED);n.find(t._selectors.DELBTN).prop("disabled",!1);TC.alert(t.getLocaleString("cb.delete.error"))}else if(t.currentMap&&s===t.currentMap.url){!function(e){var t=e.currentMap;if(T(e,t)){e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){e._$div.find(e._selectors.LIST).append(t);e._$div.find(e._selectors.EMPTYLIST).attr("hidden","hidden");e._$div.find(e._selectors.SEARCH).prop("disabled",!1)});e.storedMaps.push(t)}}(t);e.toast(t.getLocaleString("mapDownloaded",{mapName:t.currentMap.name}))}t.currentMap=null;p(t,a.url);i(t)}).on(TC.Consts.event.MAPCACHEDELETE,function(a){t.isDownloading=!1;var s=v(t,a.url)||t.currentMap&&t.currentMap.name;p(t,a.url);t.currentMap=null;if(s){document.cookie=t.COOKIE_KEY_PREFIX+"delete=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";e.toast(t.getLocaleString("mapDeleted",{mapName:s}))}i(t)}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var a=e.total;!a&&t.requestSchemas&&(a=t.requestSchemas[0].tileCount);var s=e.loaded;if(s)t._loadedCount=s;else{t._loadedCount+=1;s=t._loadedCount}t.showDownloadProgress(s,a)}).on(TC.Consts.event.MAPCACHEERROR,function(e){t.isDownloading=!1;p(t,e.url);i(t);var a=t.getLocaleString("cb.mapCreation.error"),s=!0;switch(e.reason){case"quota":a+=". "+t.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":a+=". "+t.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==e.status&&v(t,e.url);s=!1;break;case"already_exists":a+=". "+t.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}if(s)if(TC.Util.detectIE()){TC.error(a);TC.alert(t.getLocaleString("cb.mapCreation.error.reasonIE"))}else TC.alert(a);t.currentMap=null})};s.setExtent=function(e){if($.isArray(e)&&e.length>=4){this.extent=e;this.updateRequestSchemas()}};s.cacheUrlList=function(e,t){var a=t||{};this.createCache(a.name||this.LOCAL_STORAGE_KEY_PREFIX+this.ROOT_CACHE_NAME,{urlList:e,silent:a.silent})};s.requestCache=function(e){var t=this,a=e||{};if(t.map){var s=a.extent||t.extent||t.map.getExtent();t.updateRequestSchemas({extent:s});if(t.requestSchemas){for(var n=function(e,a,s){var n=e.res>=t.minResolution;!n&&a>0&&(n=s[a-1].res>t.minResolution);return n},i=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},r=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(n)}}),l=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],o=0,c=r.length;o<c;o++){var d=r[o],C=(O=d.tileMatrixLimits[d.tileMatrixLimits.length-1]).res*O.tSize;l[0]=Math.min(l[0],O.origin[0]+C*O.cl);l[1]=Math.min(l[1],O.origin[1]-C*(O.rb+1));l[2]=Math.max(l[2],O.origin[0]+C*(O.cr+1));l[3]=Math.max(l[3],O.origin[1]-C*O.rt);d.tileMatrixLimits=d.tileMatrixLimits.map(i)}var u=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),p={bBox:l=l.map(function(e,t){return(t<3?Math.ceil:Math.floor)(e*u)/u}),res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)};for(o=0,c=t.baseLayers.length;o<c;o++){var T=t.baseLayers[o],v=0===T.url.indexOf("//")?location.protocol+T.url:T.url,E=$.inArray(v,p.url);E<0&&(E=p.url.push(v)-1);var h=$.inArray(T.matrixSet,p.tms);h<0&&(h=p.tms.push(T.matrixSet)-1);var g=T.format.substr(T.format.indexOf("/")+1),_=$.inArray(g,p.format);_<0&&(_=p.format.push(g)-1);p.layers[o]={urlIdx:E,id:T.layerNames,tmsIdx:h,formatIdx:_}}var b=TC.Util.getQueryStringParams(),N=b[t.MAP_EXTENT_PARAM_NAME]=l.toString();b[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(p));t.serviceWorkerEnabled&&(b[t.SERVICE_WORKER_FLAG]=1);var I=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+t.CACHE_REQUEST_PATH+"?"+$.param(b);t.currentMap={name:a.mapName,extent:N,url:I};t.isDownloading=!0;if(t.serviceWorkerEnabled)for(o=0,c=r.length;o<c;o++){for(var S=r[o],L=null,A=0,D=t.baseLayers.length;A<D;A++){var M=t.baseLayers[A];if(M.id===S.layerId){L=t.wrap.getGetTilePattern(M);break}}if(L){urlList=[];var y=0;for(k=0,lenk=S.tileMatrixLimits.length;k<lenk;k++){var O;for(M=(O=S.tileMatrixLimits[k]).cl;M<=O.cr;M++)for(m=O.rt;m<=O.rb;m++)urlList[y++]=L.replace("{TileMatrix}",O.mId).replace("{TileCol}",M).replace("{TileRow}",m)}urlList.push(I);t.cacheUrlList(urlList,{name:I})}}else f(t,I)}}};s.cancelCacheRequest=function(){var e=this;if(e.currentMap){p(e,e.currentMap.url);e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)})}e.isDownloading=!1;i(e)};s.deleteMap=function(e){var t=this,a=t.findStoredMap({name:e});if(a){var s=TC.Util.getQueryStringParams(a.url);t.deleteCache(a.url).then(function(e){if(!e){document.cookie=t.COOKIE_KEY_PREFIX+"delete="+atob(decodeURIComponent(s[t.MAP_DEFINITION_PARAM_NAME]));f(t,a.url)}})}};s.findStoredMap=function(e){return $.grep(this.storedMaps,function(t){var a=!0;e.name&&e.name!==t.name&&(a=!1);a&&e.url&&e.url!==t.url&&(a=!1);return a})[0]};s.showDownloadProgress=function(e,t){var a=this._classSelector,s=this._$div.find(a+"-progress-count");if(t){var n=Math.min(Math.round(100*e/t),100)+"%";this._$div.find(a+"-progress-ratio").css("width",n);s.html(n)}else{this._$div.find(a+"-progress-bar").addClass(TC.Consts.classes.HIDDEN);s.html(this.getLocaleString("xFiles",{quantity:e}))}};s.updateRequestSchemas=function(e){var t=e||{};t.extent=t.extent||this.extent;t.layers=t.layers||this.baseLayers;this.requestSchemas=this.wrap.getRequestSchemas(t);return this.requestSchemas};s.getResolutions=function(){for(var e=[],t=function(e){return e.res},a=this.requestSchemas.map(function(e){return e.tileMatrixLimits.map(t)}),s=Number.POSITIVE_INFINITY,n=0,i=0,r=a.length;i<r;i++){var l=a[i];s=Math.min(s,l[0]);n=Math.max(n,l[l.length-1])}for(i=0,r=a.length;i<r;i++)e=e.concat(a[i].filter(function(t){return t<=s&&t>=n&&e.indexOf(t)<0}));e.sort(function(e,t){return t-e});return e}}();