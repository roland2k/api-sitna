TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");!function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline";TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi";TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile";TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var n=e._classSelector="."+e.CLASS;e._selectors={DRAW:n+"-draw",DRAWING:n+"-drawing",PROGRESS:n+"-progress",NEW:n+"-new",LIST:n+"-list",LISTITEM:n+"-list > li",OKBTN:n+"-btn-ok",NEWBTN:n+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:n+"-tile-count",NAMETB:n+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:n+"-link-exit",OFFPANEL:n+"-off-panel",BLLIST:n+"-bl-list",BLLISTITEM:n+"-bl-list > li",BLLISTTEXT:n+"-bl-panel-txt",RNGMAXRES:n+"-rng-maxres",SEARCH:n+"-map-available-srch",EMPTYLIST:n+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"};e.storedMaps=[];const a=TC.Util.getParameterByName(e.MAP_DEFINITION_PARAM_NAME),s=TC.Util.getParameterByName(e.MAP_EXTENT_PARAM_NAME);e.mapIsOffline=!!a;a&&(e.currentMapDefinition=JSON.parse(window.atob(decodeURIComponent(a))));s&&(e.currentMapExtent=t(s));try{e.localStorage=window.localStorage;const t="__delete_me__";e.localStorage.setItem(t,t);e.localStorage.removeItem(t)}catch(t){e.localStorage=null;TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}if(e.localStorage){for(var l=0,r=e.localStorage.length;l<r;l++){var o=e.localStorage.key(l);if(0===o.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)&&o!==e.LOCAL_STORAGE_KEY_PREFIX+e.ROOT_CACHE_NAME+".hash"){var i=e.localStorage.getItem(o).split(" "),c=t(i.shift()),d={name:i.join(" "),extent:c,url:decodeURIComponent(o.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(d)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}var u=TC.Util.extend({},r>1?arguments[1]:arguments[0]);e._dialogDiv=TC.Util.getDiv(u.dialogDiv);window.$&&(e._$dialogDiv=$(e._dialogDiv));u.dialogDiv||document.body.appendChild(e._dialogDiv);e.mapIsOffline&&document.querySelectorAll(e._selectors.OFFLINEHIDDEN).forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)});TC.Control.apply(e,arguments);e.wrap=new TC.wrap.control.CacheBuilder(e);e.isDownloading=!1;e.baseLayers=[];e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize;e.requestSchemas=[];e.minResolution=0;e.currentMap=null;e._loadedCount=0;var C=history.pushState;history.pushState=function(t){var n;n=C.apply(history,arguments);if(e._offlinePanelDiv){const t=TC.Util.getQueryStringParams();delete t[e.MAP_DEFINITION_PARAM_NAME];delete t[e.MAP_EXTENT_PARAM_NAME];delete t[e.SERVICE_WORKER_FLAG];var a=TC.Util.getParamString(t);a.length&&(a="?"+a);const n=location.pathname+a+location.hash;e._offlinePanelDiv.querySelector(e._selectors.EXIT).setAttribute("href",n)}return n};var m=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},p=function(){if(e._offlinePanelDiv){const t=e._offlinePanelDiv.querySelector(e._selectors.OFFPANEL);t.classList.remove(TC.Consts.classes.CONNECTION_OFFLINE,TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI);switch(m.type){case 1:case 2:case void 0:t.classList.add(TC.Consts.classes.CONNECTION_WIFI);break;default:t.classList.add(TC.Consts.classes.CONNECTION_MOBILE)}}};m.addEventListener&&m.addEventListener("typechange",p);window.addEventListener("online",p);window.addEventListener("offline",function(){if(e._offlinePanelDiv){const t=e._offlinePanelDiv.querySelector(e._selectors.OFFPANEL);t.classList.add(TC.Consts.classes.CONNECTION_OFFLINE);t.classList.remove(TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI)}})};TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var e=TC.control.CacheBuilder.prototype;e.CLASS="tc-ctl-cbuild";e.MAP_DEFINITION_PARAM_NAME="map-def";e.MAP_EXTENT_PARAM_NAME="map-extent";e.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.";e.ROOT_CACHE_NAME="root";e.SERVICE_WORKER_FLAG="sw";e._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"};e._actions={CREATE:"create",DELETE:"delete"};e.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"];TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc";TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc";TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc";TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc";e.template={};e.template[e.CLASS]={1:function(e,t,n,a,s){return" disabled"},3:function(e,t,n,a,s){return" hidden"},5:function(e,t,n,a,s){var l,r=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return null!=(l=e.invokePartial(r(a,"tc-ctl-cbuild-map-node"),t,{name:"tc-ctl-cbuild-map-node",data:s,indent:"        ",helpers:n,partials:a,decorators:e.decorators}))?l:""},compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var l,r=null!=t?t:e.nullContext||{},o=e.escapeExpression,i=e.lambda,c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+o(c(n,"i18n").call(r,"offlineMaps",{name:"i18n",hash:{},data:s,loc:{start:{line:1,column:4},end:{line:1,column:26}}}))+'</h2>\r\n<div class="tc-ctl-cbuild-content">\r\n    <div class="tc-ctl-cbuild-draw tc-hidden"></div>\r\n    <i class="tc-ctl-cbuild-map-search-icon"></i>\r\n    <input type="search" list="'+o(i(null!=t?c(t,"listId"):t,t))+'" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="'+o(c(n,"i18n").call(r,"cb.filter.plhr",{name:"i18n",hash:{},data:s,loc:{start:{line:5,column:108},end:{line:5,column:133}}}))+'"'+(null!=(l=c(n,"unless").call(r,null!=t?c(t,"storedMaps"):t,{name:"unless",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s,loc:{start:{line:5,column:134},end:{line:5,column:176}}}))?l:"")+' maxlength="200" />                \r\n    <ul id="'+o(i(null!=t?c(t,"listId"):t,t))+'" class="tc-ctl-cbuild-list">\r\n        <li class="tc-ctl-cbuild-map-available-empty"'+(null!=(l=c(n,"if").call(r,null!=t?c(t,"storedMaps"):t,{name:"if",hash:{},fn:e.program(3,s,0),inverse:e.noop,data:s,loc:{start:{line:7,column:53},end:{line:7,column:85}}}))?l:"")+"><span>"+o(c(n,"i18n").call(r,"cb.noMaps",{name:"i18n",hash:{},data:s,loc:{start:{line:7,column:92},end:{line:7,column:112}}}))+'</span></li>\r\n        <li class="tc-ctl-cbuild-map-not" hidden><span>'+o(c(n,"i18n").call(r,"noMatches",{name:"i18n",hash:{},data:s,loc:{start:{line:8,column:55},end:{line:8,column:75}}}))+"</span></li>\r\n"+(null!=(l=c(n,"each").call(r,null!=t?c(t,"storedMaps"):t,{name:"each",hash:{},fn:e.program(5,s,0),inverse:e.noop,data:s,loc:{start:{line:9,column:8},end:{line:11,column:17}}}))?l:"")+'    </ul>\r\n    <div class="tc-ctl-cbuild-new">\r\n        <button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="'+o(c(n,"i18n").call(r,"newofflinemap",{name:"i18n",hash:{},data:s,loc:{start:{line:14,column:87},end:{line:14,column:111}}}))+'">'+o(c(n,"i18n").call(r,"newOfflineMap",{name:"i18n",hash:{},data:s,loc:{start:{line:14,column:113},end:{line:14,column:137}}}))+'</button>\r\n    </div>\r\n    <div class="tc-ctl-cbuild-drawing tc-hidden">\r\n        <div class="tc-ctl-cbuild-tile-cmd">\r\n            <button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="'+o(c(n,"i18n").call(r,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:18,column:90},end:{line:18,column:107}}}))+'">'+o(c(n,"i18n").call(r,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:18,column:109},end:{line:18,column:126}}}))+'</button>\r\n        </div>\r\n    </div>\r\n    <div class="tc-ctl-cbuild-progress tc-hidden">\r\n        <p>'+o(c(n,"i18n").call(r,"cb.DownloadingMap",!0,{name:"i18n",hash:{},data:s,loc:{start:{line:22,column:11},end:{line:22,column:44}}}))+': <span class="tc-ctl-cbuild-progress-count"></span></p>\r\n        <div class="tc-ctl-cbuild-progress-bar">\r\n            <div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div>\r\n        </div>\r\n        <button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="'+o(c(n,"i18n").call(r,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:26,column:84},end:{line:26,column:101}}}))+'">'+o(c(n,"i18n").call(r,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:26,column:103},end:{line:26,column:120}}}))+"</button>\r\n    </div>\r\n</div>\r\n"},usePartial:!0,useData:!0};e.template[e.CLASS+"-map-node"]={compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var l=e.lambda,r=e.escapeExpression,o=null!=t?t:e.nullContext||{},i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<li data-extent="'+r(l(null!=t?i(t,"extent"):t,t))+'">\r\n    <span><a href="'+r(l(null!=t?i(t,"url"):t,t))+'" title="'+r(l(null!=t?i(t,"name"):t,t))+'">'+r(l(null!=t?i(t,"name"):t,t))+'</a></span>\r\n    <input class="tc-textbox tc-hidden" type="text" value="'+r(l(null!=t?i(t,"name"):t,t))+'" />\r\n    <button class="tc-btn-save tc-hidden" title="'+r(i(n,"i18n").call(o,"save",{name:"i18n",hash:{},data:s,loc:{start:{line:4,column:49},end:{line:4,column:64}}}))+'"></button>\r\n    <button class="tc-btn-cancel tc-hidden" title="'+r(i(n,"i18n").call(o,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:5,column:51},end:{line:5,column:68}}}))+'"></button>\r\n    <button class="tc-btn-edit" title="'+r(i(n,"i18n").call(o,"editMapName",{name:"i18n",hash:{},data:s,loc:{start:{line:6,column:39},end:{line:6,column:61}}}))+'">'+r(i(n,"i18n").call(o,"editMapName",{name:"i18n",hash:{},data:s,loc:{start:{line:6,column:63},end:{line:6,column:85}}}))+'</button>\r\n    <button class="tc-btn-view" title="'+r(i(n,"i18n").call(o,"viewMapExtent",{name:"i18n",hash:{},data:s,loc:{start:{line:7,column:39},end:{line:7,column:63}}}))+'">'+r(i(n,"i18n").call(o,"viewMapExtent",{name:"i18n",hash:{},data:s,loc:{start:{line:7,column:65},end:{line:7,column:89}}}))+'</button>\r\n    <button class="tc-btn-delete" title="'+r(i(n,"i18n").call(o,"deleteMap",{name:"i18n",hash:{},data:s,loc:{start:{line:8,column:41},end:{line:8,column:61}}}))+'">'+r(i(n,"i18n").call(o,"deleteMap",{name:"i18n",hash:{},data:s,loc:{start:{line:8,column:63},end:{line:8,column:83}}}))+"</button>\r\n</li>\r\n"},useData:!0};e.template[e.CLASS+"-bl-node"]={compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var l=e.lambda,r=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<li class="tc-ctl-cbuild-bl-node" data-layer-uid="'+r(l(null!=t?o(t,"id"):t,t))+'">\r\n    <label style="background-size: 100% 100%; background-image: url('+r(l(null!=t?o(t,"thumbnail"):t,t))+')">\r\n        <input type="checkbox" name="cbbl" value="'+r(l(null!=t?o(t,"id"):t,t))+'" disabled><span>'+r(l(null!=t?o(t,"title"):t,t))+"</span>\r\n    </label>\r\n</li>"},useData:!0};e.template[e.CLASS+"-dialog"]={compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var l=null!=t?t:e.nullContext||{},r=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-cbuild-dialog tc-modal">\r\n    <div class="tc-modal-background tc-modal-close"></div>\r\n    <div class="tc-modal-window">\r\n        <div class="tc-modal-header">\r\n            <h3>'+r(o(n,"i18n").call(l,"newOfflineMap",{name:"i18n",hash:{},data:s,loc:{start:{line:5,column:16},end:{line:5,column:40}}}))+'</h3>\r\n            <div class="tc-modal-close"></div>\r\n        </div>\r\n        <div class="tc-modal-body">\r\n            <input type="text" class="tc-ctl-cbuild-txt-name" placeholder="'+r(o(n,"i18n").call(l,"nameRequired",{name:"i18n",hash:{},data:s,loc:{start:{line:9,column:75},end:{line:9,column:98}}}))+'" required />\r\n            <div class="tc-ctl-cbuild-bl-panel">\r\n                <h4>'+r(o(n,"i18n").call(l,"availableOfflineMaps",{name:"i18n",hash:{},data:s,loc:{start:{line:11,column:20},end:{line:11,column:51}}}))+'</h4>\r\n                <p class="tc-ctl-cbuild-bl-panel-txt">'+r(o(n,"i18n").call(l,"selectAtLeastOne",{name:"i18n",hash:{},data:s,loc:{start:{line:12,column:54},end:{line:12,column:81}}}))+'</p>\r\n                <ul class="tc-ctl-cbuild-bl-list"></ul>\r\n            </div>\r\n            <div class="tc-ctl-cbuild-res-panel">\r\n                <h4>'+r(o(n,"i18n").call(l,"maxRes",{name:"i18n",hash:{},data:s,loc:{start:{line:16,column:20},end:{line:16,column:37}}}))+'</h4>\r\n                <div class="tc-ctl-cbuild-res"></div>\r\n                <input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="'+r(o(n,"i18n").call(l,"maxRes",{name:"i18n",hash:{},data:s,loc:{start:{line:18,column:95},end:{line:18,column:112}}}))+'">\r\n            </div>\r\n            <div class="tc-ctl-cbuild-tile-count"></div>\r\n        </div>\r\n        <div class="tc-modal-footer">\r\n            <button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>'+r(o(n,"i18n").call(l,"ok",{name:"i18n",hash:{},data:s,loc:{start:{line:23,column:83},end:{line:23,column:96}}}))+'</button>\r\n            <button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">'+r(o(n,"i18n").call(l,"cancel",{name:"i18n",hash:{},data:s,loc:{start:{line:24,column:92},end:{line:24,column:109}}}))+"</button>\r\n        </div>\r\n    </div>\r\n</div>\r\n"},useData:!0};e.template[e.CLASS+"-off-panel"]={compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var l=null!=t?t:e.nullContext||{},r=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="tc-ctl-cbuild-off-panel tc-conn-wifi">\r\n    <span>'+r(o(n,"i18n").call(l,"offlineMap",{name:"i18n",hash:{},data:s,loc:{start:{line:2,column:10},end:{line:2,column:31}}}))+'</span> <a href="" class="tc-ctl-cbuild-link-exit" title="'+r(o(n,"i18n").call(l,"returnToOnlineMaps",{name:"i18n",hash:{},data:s,loc:{start:{line:2,column:89},end:{line:2,column:118}}}))+'"><span>'+r(o(n,"i18n").call(l,"returnToOnlineMaps",{name:"i18n",hash:{},data:s,loc:{start:{line:2,column:126},end:{line:2,column:155}}}))+"</span></a>\r\n</div>"},useData:!0};const t=function(e){return decodeURIComponent(e).split(",").map(function(e){return parseFloat(e)})},n=function(e,t){t.querySelector("span").classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.TEXTBOX).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.SAVEBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.CANCELBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.EDITBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.VIEWBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.DELETEBTN).classList.remove(TC.Consts.classes.HIDDEN)};var a=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},s=function(e,t){var n=t||{};const a=e._dialogDiv.querySelector(e._classSelector+"-res"),s=e._dialogDiv.querySelector(e._selectors.RNGMAXRES);var l,r,o,i=e.getResolutions();if(i.length){s.setAttribute("max",i.length-1);if(e.minResolution){if(void 0===n.rangeValue)for(var c=0,d=i.length;c<d;c++)if(e.minResolution>=i[c]){s.value=c;break}}else if(void 0===n.rangeValue){const t=e.map.getResolution();s.value=i.filter(e=>e>t).length}r=parseInt(s.value);var u=Math.floor(1e3*new Number(i[r]))/1e3;l=e.getLocaleString("metersPerPixel",{value:u.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))});o=100*(r+1)/(i.length+1)+"%";s.disabled=!1;e.minResolution=i[s.value]}else{r=0;l="";s.value=0;o="0";e.minResolution=0;s.disabled=!0}a.style.left=o;a.innerHTML=l};const l=function(e){e._dialogDiv.querySelectorAll(e._classSelector+"-bl-node input[type=checkbox]").forEach(function(t,n){if(t.checked){var a=e.requestSchemas.filter(function(e){return e.layerId===t.value})[0];if(a){var s=function(e,t){for(var n=null,a=0,s=e.tileMatrixLimits.length;a<s&&!((n=e.tileMatrixLimits[a]).res<=t);a++);return n}(a,e.minResolution);if(s){var l=a.url;if(l.indexOf("{TileMatrix}")<0){var r=l.indexOf("?");r>=0&&(l=l.substr(0,r));for(var o=0,i=e.baseLayers.length;o<i;o++){var c=e.baseLayers[o];if(c.id===a.layerId){l=l+"?layer="+c.layerNames+"&style=default&tilematrixset="+c.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+c.format+"&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}";break}}}for(;t&&"LABEL"!==t.tagName;)t=t.parentElement;if(t){t.style.backgroundSize="auto";t.style.backgroundPosition="left bottom";t.style.backgroundImage="url("+l.replace("{TileMatrix}",s.mId).replace("{TileRow}",s.rt).replace("{TileCol}",s.cl)+")"}}}}})},r=function(e,t){return t<1?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:a(t)})},o=function(e){var t="";e.tileCount=0;for(var n=0,s=e.requestSchemas.length;n<s;n++)for(var l=e.requestSchemas[n],o=0,i=l.tileMatrixLimits.length;o<i;o++){var c=l.tileMatrixLimits[o];e.tileCount+=(c.cr-c.cl+1)*(c.rb-c.rt+1);if(c.res<e.minResolution)break}if(e.tileCount){e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576);t=e.getLocaleString("xTiles",{quantity:a(e.tileCount)})+" ("+r(e,e.estimatedMapSize)+")"}e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML=t},i=function(e,t){var n=t.indexOf("#");n>=0&&(t=t.substr(0,n));const a=e.div.querySelectorAll(e._selectors.LISTITEM);for(var s=0,l=a.length;s<l;s++){const e=a[s],n=e.querySelector("a");if(n&&n.getAttribute("href")===t)return e}return null};var c=function(e,t){var n=!1;if(e.localStorage){e.localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name);n=!0}return n};const d=function(e,t){const n=e.findStoredMap({url:t});if(n){if(function(e,t){var n=!1;if(e.localStorage){e.localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t));n=!0}return n}(e,t)){const t=function(e,t){const n=e.div.querySelectorAll(e._selectors.LISTITEM);for(var a=0,s=n.length;a<s;a++){const e=n[a],s=e.querySelector("a");if(s&&s.innerHTML===t)return e}return null}(e,n.name);t&&t.parentElement.removeChild(t)}var a=e.storedMaps.indexOf(n);e.storedMaps.splice(a,1);if(!e.storedMaps.length){e.div.querySelector(e._selectors.SEARCH).disabled=!0;e.div.querySelector(e._selectors.EMPTYLIST).removeAttribute("hidden")}return n.name}return null};e.render=function(e){const a=this;return a._set1stRenderPromise(new Promise(function(r,d){var u={storedMaps:a.storedMaps,listId:a.CLASS+"-list-"+TC.getUID()};a.getRenderedHtml(a.CLASS+"-dialog",null,function(e){a._dialogDiv.innerHTML=e;a._dialogDiv.querySelector(a._selectors.NAMETB).addEventListener(TC.Consts.event.CLICK,function(e){e.preventDefault();this.selectionStart=0;this.selectionEnd=this.value.length;this.focus()})}).then(function(){a.renderData(u,function(){a._dialogDiv.querySelector(a._selectors.OKBTN).addEventListener(TC.Consts.event.CLICK,function(){a.generateCache()},{passive:!0});a._dialogDiv.querySelector(a._selectors.NAMETB).addEventListener("input",function(){a._updateReadyState()});a.div.querySelector(a._selectors.NEWBTN).addEventListener(TC.Consts.event.CLICK,function(){a.setEditState()},{passive:!0});a.div.querySelector(a._classSelector+"-btn-cancel-draw").addEventListener(TC.Consts.event.CLICK,function(){a.setReadyState()},{passive:!0});a.div.querySelector(a._classSelector+"-btn-cancel-dl").addEventListener(TC.Consts.event.CLICK,function(){a.cancelCacheRequest()},{passive:!0});const r=a.div.querySelector(a._selectors.LIST);r.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(a._selectors.DELETEBTN,function(e){a.startDeleteMap(e.target.parentElement.querySelector("a").innerHTML)}),{passive:!0});r.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(a._selectors.EDITBTN,function(e){!function(e,t){t.querySelector("span").classList.add(TC.Consts.classes.HIDDEN);const n=t.querySelector(e._selectors.TEXTBOX);n.classList.remove(TC.Consts.classes.HIDDEN);n.value=t.querySelector("span a").innerHTML;n.focus();t.querySelector(e._selectors.SAVEBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.CANCELBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.EDITBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.VIEWBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.DELETEBTN).classList.add(TC.Consts.classes.HIDDEN)}(a,e.target.parentElement)}),{passive:!0});r.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(a._selectors.CANCELBTN,function(e){const t=e.target.parentElement;t.querySelector(a._selectors.TEXTBOX).value=t.querySelector("a").innerHTML;n(a,t)}),{passive:!0});r.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(a._selectors.SAVEBTN,function(e){const t=e.target.parentElement;n(a,t);const s=t.querySelector("a"),l=t.querySelector(a._selectors.TEXTBOX).value,r=a.findStoredMap({url:s.getAttribute("href")});if(r){r.name=l;s.innerHTML=l;s.setAttribute("title",l);c(a,r)}}),{passive:!0});r.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(a._selectors.VIEWBTN,function(e){const n=e.target;var s=!n.classList.contains(TC.Consts.classes.ACTIVE);const l=a.div.querySelector(a._selectors.VIEWBTN);l.classList.remove(TC.Consts.classes.ACTIVE);l.parentElement.classList.remove(TC.Consts.classes.ACTIVE);const r=n.parentElement.querySelector("a").innerHTML;if(r){var o=a.findStoredMap({name:r});if(o){var i=t(o.extent);a.layer.clearFeatures();if(s){a.layer.addPolygon([[[i[0],i[1]],[i[0],i[3]],[i[2],i[3]],[i[2],i[1]]]],{showsPopup:!1}).then(function(){a.layer.map.zoomToFeatures(a.layer.features)});n.classList.add(TC.Consts.classes.ACTIVE);n.parentElement.classList.add(TC.Consts.classes.ACTIVE);n.setAttribute("title",a.getLocaleString("removeMapExtent"))}}}}),{passive:!0});const d=a.div.querySelector(a._selectors.SEARCH),u=function(){!function(e){e=e.toLowerCase();const t=a.div.querySelectorAll(a._selectors.LISTITEM);t.forEach(function(e){e.style.display="none"});const n=[];t.forEach(function(e){e.matches("li:not([class]),li."+TC.Consts.classes.ACTIVE)&&n.push(e)});if(0===e.length){n.forEach(function(e){e.style.removeProperty("display")});a.div.querySelector(a._classSelector+"-map-search-icon").style.visibility="visible"}else{a.div.querySelector(a._classSelector+"-map-search-icon").style.visibility="hidden";var s=new RegExp(e,"i");n.forEach(function(e){e.style.display=s.test(e.querySelector("a").textContent)?"":"none"});n.some(function(e){return!e.hidden})||t.forEach(function(e){e.matches('[class^="tc-ctl-cbuild-map-not"]')&&e.style.removeProperty("display")})}}(this.value.toLowerCase().trim())};d.addEventListener("keyup",u);d.addEventListener("search",u);a._dialogDiv.querySelector(a._selectors.BLLIST).addEventListener("change",TC.EventTarget.listenerBySelector("input[type=checkbox]",function(e){const t=e.target;if(t.checked)a.baseLayers.push(a.map.getLayer(t.value));else for(var n=0,r=a.baseLayers.length;n<r;n++){if(a.baseLayers[n].id===t.value){a.baseLayers.splice(n,1);break}}a.updateRequestSchemas();s(a);l(a);a._updateReadyState();o(a)}));const C=a._dialogDiv.querySelector(a._selectors.RNGMAXRES),m=function(e){s(a,{rangeValue:e.target.value});l(a);o(a)};C.addEventListener("input",m);C.addEventListener("change",m);const p=i(a,location.href);p&&p.classList.add(TC.Consts.classes.ACTIVE);TC.Util.isFunction(e)&&e()}).then(function(){r()}).catch(function(e){d(e instanceof Error?e:Error(e))})});window.addEventListener("beforeunload",function(e){if(a.isDownloading){var t=a.getLocaleString("cb.mapDownloading.warning");e.returnValue=t;return t}},!0)}))};e.register=function(e){var t=this;const n=TC.control.SWCacheClient.prototype.register.call(t,e);t.getServiceWorker().then(function(){navigator.serviceWorker.ready.then(function(){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":t.trigger(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total});break;case"cached":t.trigger(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name});break;case"deleted":t.trigger(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name});break;case"error":e.data.action===t._actions.CREATE&&TC.error(t.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}})});navigator.onLine&&new Promise(function(e,t){var n=document.documentElement.getAttribute("manifest")||"manifest.appcache";n?TC.ajax({url:n,method:"GET",responseType:"text"}).then(function(t){var n=t.data;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var t=hex_md5(n),a=n.indexOf("NETWORK:");a>=0&&(n=n.substr(0,a));(a=n.indexOf("FALLBACK:"))>=0&&(n=n.substr(0,a));(a=n.indexOf("SETTINGS:"))>=0&&(n=n.substr(0,a));var s=n.split(/[\n\r]/).filter(function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});s.shift();e({hash:t,urls:s})})}).catch(function(e){t(e)}):t(Error("There is no manifest in document"))}).then(function(e){const n=t.LOCAL_STORAGE_KEY_PREFIX+t.ROOT_CACHE_NAME+".hash";var a;t.localStorage&&(a=t.localStorage.getItem(n));if(a!==e.hash){t.cacheUrlList(e.urls);t.one(TC.Consts.event.MAPCACHEDOWNLOAD,function(){const s=!a;t.localStorage&&t.localStorage.setItem(n,e.hash);s||TC.confirm(t.getLocaleString("newAppVersionAvailable"),function(){location.reload()})})}})},function(e){t.renderPromise().then(function(){const n=t.div.querySelector(`.${t.CLASS}-new`),a=document.createElement("div");a.classList.add("tc-alert","alert-warning");const s=document.createElement("p"),l=document.createElement("strong");l.innerHTML=t.getLocaleString("offlineMap.error");s.appendChild(l);const r=document.createElement("p");r.innerHTML=e.message;a.appendChild(s);a.appendChild(r);n.querySelector(t._selectors.NEWBTN).classList.add(TC.Consts.classes.HIDDEN);n.appendChild(a)})}).catch(()=>console.log("No SW available: no events handled"));if(t.mapIsOffline){e.div.classList.add(TC.Consts.classes.OFFLINE);t._offlinePanelDiv=TC.Util.getDiv(t.options.offlinePanelDiv);t.options.offlinePanelDiv||e.div.appendChild(t._offlinePanelDiv);t.getRenderedHtml(t.CLASS+"-off-panel",null,function(e){t._offlinePanelDiv.innerHTML=e;if(!navigator.onLine){const e=t._offlinePanelDiv.querySelector(t._selectors.OFFPANEL);e.classList.add(TC.Consts.classes.CONNECTION_OFFLINE);e.classList.remove(TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI)}t._offlinePanelDiv.querySelector(t._selectors.EXIT).addEventListener(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})}const a=t.getUID(),s=t.getUID();t.layerPromise=e.addLayer({id:s,type:TC.Consts.layerType.VECTOR,stealth:!0,owner:t,styles:{line:e.options.styles.line}});t.layer=null;Promise.all([t.layerPromise,t.renderPromise(),e.addControl("draw",{id:a,div:t.div.querySelector(t._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,persistent:!1})]).then(function(n){const a=t.layer=n[0],s=t.boxDraw=n[2];s.setLayer(a);s.on(TC.Consts.event.DRAWSTART,function(e){t.map.toast(t.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(n){var a=n.feature.geometry[0],s=a[0],r=a[2],i=Math.min(s[0],r[0]),c=Math.max(s[0],r[0]),d=Math.min(s[1],r[1]),u=Math.max(s[1],r[1]);t.setExtent([i,d,c,u]);const C=t._dialogDiv.querySelectorAll("input[type=checkbox]");C.forEach(function(n){const a=t.map.getLayer(n.value);for(var s=n;s&&"LI"!==s.tagName;)s=s.parentElement;if(a.wrap.getCompatibleMatrixSets(e.crs).includes(a.matrixSet)){const e=t.wrap.getRequestSchemas({extent:t.extent,layers:[a]})[0].tileMatrixLimits;s.classList.toggle(TC.Consts.classes.HIDDEN,!e.length)}else s.classList.add(TC.Consts.classes.HIDDEN)});const m=t._dialogDiv.querySelector(t._selectors.BLLISTITEM+":not(."+TC.Consts.classes.HIDDEN+")");t._dialogDiv.querySelector(t._selectors.BLLISTTEXT).innerHTML=t.getLocaleString(m?"selectAtLeastOne":"cb.noMapsAtSelectedExtent");l(t);o(t);TC.Util.showModal(t._dialogDiv.querySelector(t._classSelector+"-dialog"),{openCallback:function(){setTimeout(function(){C.forEach(function(e){e.disabled=!1})},100);var e;if(Date.prototype.toLocaleString){var n={};n.year=n.month=n.day=n.hour=n.minute=n.second="numeric";e=(new Date).toLocaleString(t.map.options.locale.replace("_","-"),n)}else e=(new Date).toString();t._dialogDiv.querySelector(t._selectors.NAMETB).value=e;t._updateReadyState()},closeCallback:function(){C.forEach(function(e){e.disabled=!0});t.boxDraw.layer.clearFeatures()}})});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){s===e.control&&t._state===t._states.EDITING&&t.setReadyState()})});var r=function(e){var n=!1;const a=t._dialogDiv.querySelector(t._selectors.BLLIST),s=function(){return!!a.querySelector('li[data-layer-uid="'+e.id+'"]')};var l=e.type===TC.Consts.layerType.WMTS&&!e.mustReproject;TC.Util.detectSafari()&&TC.Util.detectIOS()&&(l=l&&TC.Util.isSameOrigin(e.url));if(l&&!s()){n=!0;t.getRenderedHtml(t.CLASS+"-bl-node",e,function(e){if(!s()){const t=new DOMParser;a.appendChild(t.parseFromString(e,"text/html").body.firstChild)}})}return n};const u=function(e){if(e.isBase&&t.mapIsOffline){const n=e.getResolutions();if(n){const a=n.filter(e=>e>=t.currentMapDefinition.res);a.length&&e.setResolutions(a)}}t.renderPromise().then(function(){r(e)})};e.on(TC.Consts.event.LAYERADD,function(e){u(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){t.renderPromise().then(function(){const n=e.layer;if(n.type===TC.Consts.layerType.WMTS){const e=t._dialogDiv.querySelector(t._selectors.BLLIST).querySelector('li[data-layer-uid="'+n.id+'"]');e.parentElement.removeChild(e)}})}).on(TC.Consts.event.PROJECTIONCHANGE,function(t){e.baseLayers.forEach(e=>u(e))});e.ready(function(){if(t.mapIsOffline){var n,a,s=[];for(n=0,a=t.offlineControls.length;n<a;n++){var l=t.offlineControls[n];l=l.substr(0,1).toUpperCase()+l.substr(1);s=s.concat(e.getControlsByClass("TC.control."+l))}for(n=0,a=e.controls.length;n<a;n++){var r=e.controls[n];s.indexOf(r)<0&&r.disable()}document.querySelectorAll(t._selectors.OFFLINEHIDDEN).forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)})}});e.loaded(function(){t.layerPromise.then(function(t){e.putLayerOnTop(t)});t.renderPromise().then(function(){t.div.querySelector(t._selectors.NEWBTN).disabled=!1;e.baseLayers.forEach(r)});if(t.mapIsOffline){const n=t.currentMapDefinition,a=function(e,t){return(0===e.url.indexOf("//")?location.protocol+e.url:e.url)===n.url[t.urlIdx]&&e.layerNames===t.id&&e.matrixSet===n.tms[t.tmsIdx]},s=e.options.availableBaseLayers.filter(e=>e.type===TC.Consts.layerType.WMTS).filter(e=>n.layers.some(t=>a(e,t))).filter(t=>!e.baseLayers.some(e=>e.id===t.id));Promise.all(s.map(t=>e.addLayer(TC.Util.extend({},t,{isBase:!0})))).finally(function(){const s=[];for(var l=0,r=n.layers.length;l<r;l++)for(var o=0,i=e.baseLayers.length;o<i;o++){const t=e.baseLayers[o];if(t.type===TC.Consts.layerType.WMTS&&a(t,n.layers[l])){s.push(t);break}}s.length&&e.setBaseLayer(s[0],function(){for(var n=e.baseLayers.length-1;n>=0;n--){const t=e.baseLayers[n];t.type===TC.Consts.layerType.VECTOR||s.includes(t)||e.removeLayer(t)}e.setExtent(t.currentMapExtent,{animate:!1})})})}});t.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(n){t.isDownloading=!1;const a=function(e){const t=e.indexOf("#");return t>=0?e.substr(0,t):e}(n.url),s=i(t,a);if(s&&!t.serviceWorkerEnabled){s.classList.remove(TC.Consts.classes.DISABLED);TC.alert(t.getLocaleString("cb.delete.error"))}else if(t.currentMap&&a===t.currentMap.url){!function(e){const t=e.currentMap;if(c(e,t)){e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){const n=new DOMParser;e.div.querySelector(e._selectors.LIST).appendChild(n.parseFromString(t,"text/html").body.firstChild);e.div.querySelector(e._selectors.EMPTYLIST).setAttribute("hidden","hidden");e.div.querySelector(e._selectors.SEARCH).disabled=!1});e.storedMaps.push(t)}}(t);e.toast(t.getLocaleString("mapDownloaded",{mapName:t.currentMap.name}))}t.currentMap=null;t.setReadyState()}).on(TC.Consts.event.MAPCACHEDELETE,function(n){t.isDownloading=!1;var a=d(t,n.url)||t.currentMap&&t.currentMap.name;t.currentMap=null;a&&e.toast(t.getLocaleString("mapDeleted",{mapName:a}));t.setReadyState()}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var n=e.total;!n&&t.requestSchemas&&(n=t.requestSchemas[0].tileCount);var a=e.loaded;if(a)t._loadedCount=a;else{t._loadedCount+=1;a=t._loadedCount}t.showDownloadProgress(a,n)}).on(TC.Consts.event.MAPCACHEERROR,function(e){t.isDownloading=!1;t.setReadyState();var n=t.getLocaleString("cb.mapCreation.error"),a=!0;switch(e.reason){case"quota":n+=". "+t.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":n+=". "+t.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==e.status&&d(t,e.url);a=!1;break;case"already_exists":n+=". "+t.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}if(a)if(TC.Util.detectIE()){TC.error(n);TC.alert(t.getLocaleString("cb.mapCreation.error.reasonEdge"))}else TC.alert(n);t.currentMap=null});return n};e.setExtent=function(e){if(Array.isArray(e)&&e.length>=4){this.extent=e;this.updateRequestSchemas()}};e._updateReadyState=function(){this._dialogDiv.querySelector(this._selectors.OKBTN).disabled=!this.extent||0===this._dialogDiv.querySelector(this._selectors.NAMETB).value.length||this._dialogDiv.querySelector(this._selectors.RNGMAXRES).disabled};e.setReadyState=function(){const e=this;e._state=e._states.READY;e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.NEW).classList.remove(TC.Consts.classes.HIDDEN);e.div.querySelectorAll(e._selectors.LISTITEM).forEach(function(e){e.classList.remove(TC.Consts.classes.DISABLED)});e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!1;e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML="";e.extent=null;e._loadedCount=0;e.boxDraw&&e.boxDraw.cancel()};e.setEditState=function(){this._state=this._states.EDITING;this.showDownloadProgress(0,1);this.div.querySelector(this._selectors.NEW).classList.add(TC.Consts.classes.HIDDEN);this.div.querySelector(this._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);this.div.querySelector(this._selectors.DRAWING).classList.remove(TC.Consts.classes.HIDDEN);this.map.toast(this.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO});this._dialogDiv.querySelector(this._selectors.OKBTN).disabled=!0;this.div.querySelector(this._selectors.NEWBTN).disabled=!0;this._dialogDiv.querySelector(this._selectors.NAMETB).value="";this.boxDraw.activate()};e.generateCache=function(){const e=this,t={mapName:e._dialogDiv.querySelector(e._selectors.NAMETB).value};if(e.findStoredMap({name:t.mapName}))TC.alert(e.getLocaleString("cb.mapNameAlreadyExists.error",t));else{var n=function(){e.div.querySelector(e._classSelector+"-name").innerHTML=t.mapName;e.map.toast(e.getLocaleString("downloadingMap",{mapName:t.mapName}));!function(e){e._state=e._states.DOWNLOADING;TC.Util.closeModal();e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.NEW).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.remove(TC.Consts.classes.HIDDEN);e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!0;e.layer.clearFeatures();e.boxDraw.cancel()}(e);e.requestCache(t)};navigator.storage&&navigator.storage.estimate?navigator.storage.estimate().then(function(a){const s=(a.quota-a.usage)/1048576;e.estimatedMapSize<s?n():TC.confirm(e.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:t.mapName,mapSize:r(e,e.estimatedMapSize),availableStorage:r(e,Math.round(s))}),n)}):n()}};e.cacheUrlList=function(e,t){var n=t||{};this.createCache(n.name||this.LOCAL_STORAGE_KEY_PREFIX+this.ROOT_CACHE_NAME,{urlList:e,silent:n.silent})};e.requestCache=function(e){var t=this,n=e||{};if(t.map){var a=n.extent||t.extent||t.map.getExtent();t.updateRequestSchemas({extent:a});if(t.requestSchemas){for(var s=function(e,n,a){var s=e.res>=t.minResolution;!s&&n>0&&(s=a[n-1].res>t.minResolution);return s},l=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},r=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(s)}}),o=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],i=0,c=r.length;i<c;i++){var d=r[i],u=(M=d.tileMatrixLimits[d.tileMatrixLimits.length-1]).res*M.tSize;o[0]=Math.min(o[0],M.origin[0]+u*M.cl);o[1]=Math.min(o[1],M.origin[1]-u*(M.rb+1));o[2]=Math.max(o[2],M.origin[0]+u*(M.cr+1));o[3]=Math.max(o[3],M.origin[1]-u*M.rt);d.tileMatrixLimits=d.tileMatrixLimits.map(l)}var C=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),m={bBox:o=o.map(function(e,t){return(t<3?Math.ceil:Math.floor)(e*C)/C}),res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)};for(i=0,c=t.baseLayers.length;i<c;i++){var p=t.baseLayers[i],f=0===p.url.indexOf("//")?location.protocol+p.url:p.url,T=m.url.indexOf(f);T<0&&(T=m.url.push(f)-1);var v=m.tms.indexOf(p.matrixSet);v<0&&(v=m.tms.push(p.matrixSet)-1);var E=p.format.substr(p.format.indexOf("/")+1),h=m.format.indexOf(E);h<0&&(h=m.format.push(E)-1);m.layers[i]={urlIdx:T,id:p.layerNames,tmsIdx:v,formatIdx:h}}var S=TC.Util.getQueryStringParams(),g=S[t.MAP_EXTENT_PARAM_NAME]=o.toString();S[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(m));t.serviceWorkerEnabled&&(S[t.SERVICE_WORKER_FLAG]=1);var L=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+"?"+TC.Util.getParamString(S);t.currentMap={name:n.mapName,extent:g,url:L};t.isDownloading=!0;if(t.serviceWorkerEnabled){const e=[];for(i=0,c=r.length;i<c;i++){for(var y=r[i],b=null,N=0,I=t.baseLayers.length;N<I;N++){var _=t.baseLayers[N];if(_.id===y.layerId){b=t.wrap.getGetTilePattern(_);_.getFallbackLayer&&_.getFallbackLayer();_.thumbnail&&e.push(_.thumbnail);break}}if(b)for(var D=0,A=y.tileMatrixLimits.length;D<A;D++)for(var M,O=(M=y.tileMatrixLimits[D]).rt;O<=M.rb;O++)for(var R=M.cl;R<=M.cr;R++)e.push(b.replace("{TileMatrix}",M.mId).replace("{TileCol}",R).replace("{TileRow}",O))}e.push(L);t.cacheUrlList(e,{name:L})}}}};e.cancelCacheRequest=function(){var e=this;e.currentMap&&e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)});e.isDownloading=!1;e.setReadyState()};e.deleteMap=function(e){var t=this.findStoredMap({name:e});t&&this.deleteCache(t.url)};e.startDeleteMap=function(e){const t=this;if(navigator.onLine){if(e){var n=t.getLocaleString("cb.delete.confirm",{mapName:e});t.serviceWorkerEnabled||(n=n+" "+t.getLocaleString("cb.delete.confirm.connect.warning"));if(confirm(n))if(navigator.onLine){!function(e){e._state=e._states.DELETING;e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.NEW).classList.remove(TC.Consts.classes.HIDDEN);e.div.querySelectorAll(e._selectors.LISTITEM).forEach(function(e){e.classList.add(TC.Consts.classes.DISABLED)});e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!1;e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML="";e.boxDraw.cancel()}(t);t.deleteMap(e)}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))};e.findStoredMap=function(e){return this.storedMaps.filter(function(t){var n=!0;e.name&&e.name!==t.name&&(n=!1);n&&e.url&&e.url!==t.url&&(n=!1);return n})[0]};e.showDownloadProgress=function(e,t){const n=this,a=n._classSelector,s=n.div.querySelector(a+"-progress-count");if(t){var l=Math.min(Math.round(100*e/t),100)+"%";const r=n.div.querySelector(a+"-progress-ratio");r&&(r.style.width=l);s&&(s.innerHTML=l)}else{const t=n.div.querySelector(a+"-progress-bar");t&&t.classList.add(TC.Consts.classes.HIDDEN);s&&(s.innerHTML=n.getLocaleString("xFiles",{quantity:e}))}};e.updateRequestSchemas=function(e){var t=e||{};t.extent=t.extent||this.extent;t.layers=t.layers||this.baseLayers;this.requestSchemas=this.wrap.getRequestSchemas(t);return this.requestSchemas};e.getResolutions=function(){var e=[];const t=function(e){return e.res},n=this.requestSchemas.map(function(e){return e.tileMatrixLimits.map(t)});(e=e.concat.apply(e,n)).sort(function(e,t){return t-e});return e}}();
//# sourceMappingURL=../maps/control/CacheBuilder.min.js.map