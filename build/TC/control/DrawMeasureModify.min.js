TC.control=TC.control||{};TC.control.Measure||TC.syncLoadJS(TC.apiLocation+"TC/control/Measure");TC.control.DrawMeasureModify=function(){var e=this;TC.control.Measure.apply(e,arguments);e._dialogDiv=TC.Util.getDiv(e.options.dialogDiv);window.$&&(e._$dialogDiv=$(e._dialogDiv));e.options.dialogDiv||document.body.appendChild(e._dialogDiv);const t=e._classSelector="."+e.CLASS;e._selectors={ELEVATION_CHECKBOX:t+"-dialog-elev input[type=checkbox]"};e.persistentDrawControls=!0;e.renderPromise().then(function(){e._1stCoordText=e.div.querySelector(".tc-ctl-meas-val-coord-1-t");e._2ndCoordText=e.div.querySelector(".tc-ctl-meas-val-coord-2-t");e._1stCoordValue=e.div.querySelector(".tc-ctl-meas-val-coord-1-v");e._2ndCoordValue=e.div.querySelector(".tc-ctl-meas-val-coord-2-v");e._elevationText=e.div.querySelector(".tc-ctl-meas-val-coord-ele-t");e._elevationValue=e.div.querySelector(".tc-ctl-meas-val-coord-ele-v")})};TC.inherit(TC.control.DrawMeasureModify,TC.control.Measure);!function(){var e=TC.control.DrawMeasureModify.prototype;e.CLASS="tc-ctl-dmm";TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc";TC.Consts.event.FEATURESSELECT=TC.Consts.event.FEATURESSELECT||"featuresselect.tc";e.template={compiler:[8,">= 4.3.0"],main:function(e,t,n,o,a){var l=null!=t?t:e.nullContext||{},s=e.escapeExpression,r=e.lambda,i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+s(i(n,"i18n").call(l,"drawAndMeasure",{name:"i18n",hash:{},data:a,loc:{start:{line:1,column:4},end:{line:1,column:29}}}))+'</h2>\r\n<div class="tc-ctl-meas-select">\r\n    <label class="tc-ctl-meas-btn-pt"><input type="radio" name="'+s(r(null!=t?i(t,"controlId"):t,t))+'-mode" value="point" /><span>'+s(i(n,"i18n").call(l,"points",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:106},end:{line:3,column:123}}}))+'</span></label><label \r\n\tclass="tc-ctl-meas-btn-len"><input type="radio" name="'+s(r(null!=t?i(t,"controlId"):t,t))+'-mode" value="polyline" /><span>'+s(i(n,"i18n").call(l,"lines",{name:"i18n",hash:{},data:a,loc:{start:{line:4,column:100},end:{line:4,column:116}}}))+'</span></label><label \r\n\tclass="tc-ctl-meas-btn-area"><input type="radio" name="'+s(r(null!=t?i(t,"controlId"):t,t))+'-mode" value="polygon" /><span>'+s(i(n,"i18n").call(l,"polygons",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:100},end:{line:5,column:119}}}))+'</span></label>\r\n</div>\r\n<div class="tc-ctl-meas-mode tc-ctl-meas-pt tc-hidden">\r\n    <div class="tc-ctl-meas-point"></div>\r\n    <div class="tc-ctl-meas-txt">'+s(i(n,"i18n").call(l,"search.list.coordinates",{name:"i18n",hash:{},data:a,loc:{start:{line:9,column:33},end:{line:9,column:67}}}))+' <span class="tc-ctl-meas-val-coord">\r\n           <span class="tc-ctl-meas-val-coord-1-t"></span> <span class="tc-ctl-meas-val-coord-1-v"></span> <span class="tc-ctl-meas-val-coord-2-t"></span> <span class="tc-ctl-meas-val-coord-2-v"></span> <span class="tc-ctl-meas-val-coord-ele-t"></span> <span class="tc-ctl-meas-val-coord-ele-v"></span>\r\n        </span>\r\n    </div>\r\n</div>\r\n<div class="tc-ctl-meas-mode tc-ctl-meas-len tc-hidden">\r\n    <div class="tc-ctl-meas-line"></div>\r\n    <div class="tc-ctl-meas-txt">'+s(i(n,"i18n").call(l,"2dLength",{name:"i18n",hash:{},data:a,loc:{start:{line:16,column:33},end:{line:16,column:52}}}))+': <span class="tc-ctl-meas-val-len"></span><button class="tc-ctl-meas-prof-btn tc-active" title="'+s(i(n,"i18n").call(l,"deactivateElevationProfile",{name:"i18n",hash:{},data:a,loc:{start:{line:16,column:149},end:{line:16,column:186}}}))+'">'+s(i(n,"i18n").call(l,"geo.trk.chart.chpe",{name:"i18n",hash:{},data:a,loc:{start:{line:16,column:188},end:{line:16,column:217}}}))+'</button></div>\r\n</div>\r\n<div class="tc-ctl-meas-mode tc-ctl-meas-area tc-hidden">\r\n    <div class="tc-ctl-meas-polygon"></div>\r\n    <div class="tc-ctl-meas-txt">'+s(i(n,"i18n").call(l,"area",{name:"i18n",hash:{},data:a,loc:{start:{line:20,column:33},end:{line:20,column:48}}}))+': <span class="tc-ctl-meas-val-area"></span>, '+s(i(n,"i18n").call(l,"2dPerimeter",{name:"i18n",hash:{},data:a,loc:{start:{line:20,column:94},end:{line:20,column:116}}}))+': <span class="tc-ctl-meas-val-peri"></span></div>\r\n</div>\r\n<div class="tc-ctl-dmm-tool">\r\n    <div class="tc-ctl-dmm-mod"></div>\r\n    <div class="tc-ctl-dmm-cmd">\r\n        <button class="tc-ctl-dmm-btn-clr" disabled title="'+s(i(n,"i18n").call(l,"deleteAll",{name:"i18n",hash:{},data:a,loc:{start:{line:25,column:59},end:{line:25,column:79}}}))+'">'+s(i(n,"i18n").call(l,"deleteAll",{name:"i18n",hash:{},data:a,loc:{start:{line:25,column:81},end:{line:25,column:101}}}))+'</button><button \r\n\t\tclass="tc-ctl-dmm-btn-dl" disabled title="'+s(i(n,"i18n").call(l,"download",{name:"i18n",hash:{},data:a,loc:{start:{line:26,column:44},end:{line:26,column:63}}}))+'">'+s(i(n,"i18n").call(l,"download",{name:"i18n",hash:{},data:a,loc:{start:{line:26,column:65},end:{line:26,column:84}}}))+"...</button>\r\n    </div>\r\n</div>\r\n"},useData:!0};e.render=function(e){const t=this;return t._set1stRenderPromise(TC.control.Measure.prototype.render.call(t,function(){t._clearBtn=t.div.querySelector(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-clr");t._clearBtn.addEventListener(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("deleteAll.confirm"),function(){t.clear()})},{passive:!0});t._downloadBtn=t.div.querySelector(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-dl");t._downloadBtn.addEventListener(TC.Consts.event.CLICK,function(e){t.showSketchDownloadDialog()},{passive:!0});t._elevProfileBtn=t.div.querySelector(".tc-ctl-meas-prof-btn");t._elevProfileBtn.addEventListener(TC.Consts.event.CLICK,function(e){t.elevationProfileActive?t.deactivateElevationProfile():t.activateElevationProfile()},{passive:!0});t.options.displayElevation||(t._elevProfileBtn.style.display="none");TC.Util.isFunction(e)&&e()}))};e.register=function(e){const t=this;return new Promise(function(n,o){TC.control.Measure.prototype.register.call(t,e).then(function(){const o=t.getUID(),a=t.getUID();Promise.all([t.layerPromise,t.renderPromise(),t.getElevationTool()]).then(function(l){const s=l[0];t.elevationProfileActive=!!l[2];s.title=t.getLocaleString("sketch");t._modifyPromise=e.addControl("modify",{id:a,div:t.div.querySelector("."+t.CLASS+"-mod"),layer:s});t._modifyPromise.then(function(n){t.modify=n;n.on(TC.Consts.event.FEATURESSELECT,function(e){t.getElevationControl().then(function(n){n.resultsPanel&&!e.features.some(function(e){return n.resultsPanel.currentFeature===e})&&n.resultsPanel.setCurrentFeature(null);const o=e.features[e.features.length-1];if(o){t.showMeasurements(t.getFeatureMeasureData(o));const e=o._originalStyle||o.getStyle();switch(!0){case TC.feature.Polygon&&o instanceof TC.feature.Polygon:t.displayMode(TC.Consts.geom.POLYGON);t.polygonDrawControl.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth);break;case TC.feature.Polyline&&o instanceof TC.feature.Polyline:t.displayMode(TC.Consts.geom.POLYLINE);t.lineDrawControl.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth);t.elevationProfileActive&&n.displayElevationProfile(o);break;case TC.feature.Point&&o instanceof TC.feature.Point:t.displayMode(TC.Consts.geom.POINT);t.pointDrawControl.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth)}t.modify.setFontColorWatch(e.fontColor).setFontSizeWatch(e.fontSize)}})}).on(TC.Consts.event.FEATURESUNSELECT,function(e){t.modify.getSelectedFeatures().length||t.resetDrawWatches();t.getElevationControl().then(function(e){e.resetElevationProfile();e.resultsPanel&&e.resultsPanel.close()})}).on(TC.Consts.event.FEATUREMODIFY,function(e){if(e.layer===t.layer){const n=function(e){const n=t.getFeatureMeasureData(e);t.showMeasurements(n);t.setFeatureMeasureData(e)};n(e.feature);TC.feature.Point&&e.feature instanceof TC.feature.Point&&t.getElevationTool().then(function(o){o&&o.setGeometry({features:[e.feature],crs:t.map.crs}).then(function(e){n(e[0])})});t.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.currentFeature===e.feature&&t.isVisible()&&t.hide()})}});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){const n=e.control;if(n===t.modify||n===t.lineDrawControl){t.resetDrawWatches();t.getElevationControl().then(function(e){e.resetElevationProfile();if(e.resultsPanel){n===t.modify&&e.resultsPanel.setCurrentFeature(null);e.resultsPanel.close()}})}}).on(TC.Consts.event.POPUP,function(e){const n=e.control.currentFeature;if(TC.feature.Polyline&&n instanceof TC.feature.Polyline&&t.layer.features.indexOf(n)>=0&&t.elevationProfileActive){e.control.hide();t.getElevationControl().then(function(e){if(e.resultsPanel){e.resultsPanel.setCurrentFeature(n);e.resultsPanel.isMinimized()&&e.resultsPanel.maximize()}e.displayElevationProfile(n)})}}).on(TC.Consts.event.PROJECTIONCHANGE,function(e){t.elevationChartData&&(t.elevationChartData.coords=TC.Util.reproject(t.elevationChartData.coords,e.oldCrs,e.newCrs))})});t._lineDrawControlPromise.then(function(e){e.on(TC.Consts.event.DRAWSTART,function(){t.getElevationControl().then(function(e){e.resultsPanel&&e.resultsPanel.currentFeature&&e.resultsPanel.setCurrentFeature(null);t.resetValues()})}).on(TC.Consts.event.DRAWUNDO+" "+TC.Consts.event.DRAWREDO,function(){const e=this;t.getElevationControl().then(function(n){t.elevationProfileActive&&(e.historyIndex?n.displayElevationProfile(e.history.slice(0,e.historyIndex)):n.closeElevationProfile())})}).on(TC.Consts.event.DRAWEND,function(e){t.getElevationControl().then(function(t){t.resultsPanel&&(t.resultsPanel.currentFeature=e.feature)})}).on(TC.Consts.event.POINT,function(e){const n=this.history.slice(0,this.historyIndex),o=n[n.length-1];o[0]===e.point[0]&&o[1]===e.point[1]||n.push(e.point);t.getElevationControl().then(function(e){t.elevationProfileActive&&e.displayElevationProfile(n)})}).on(TC.Consts.event.STYLECHANGE,function(e){t.onStyleChange(e)})});t._polygonDrawControlPromise.then(function(e){e.on(TC.Consts.event.DRAWSTART,function(){t.resetValues()}).on(TC.Consts.event.STYLECHANGE,function(e){t.onStyleChange(e)})});t._pointDrawControlPromise=e.addControl("draw",{id:o,div:t.div.querySelector("."+TC.control.Measure.prototype.CLASS+"-point"),mode:TC.Consts.geom.POINT,persistent:t.persistentDrawControls,styling:!0,layer:t.layer});t._pointDrawControlPromise.then(function(n){n.containerControl=t;t.drawControls.push(n);t.pointDrawControl=n;t.resetValues();n.on(TC.Consts.event.DRAWEND,function(n){const o=function(n){t.showMeasurements({coords:n.geometry,units:e.wrap.isGeo()?"degrees":"m"});t.setFeatureMeasureData(n)};o(n.feature);t.getElevationTool().then(function(e){e&&e.setGeometry({features:[n.feature],crs:t.map.crs}).then(function(e){o(e[0])})})}).on(TC.Consts.event.DRAWCANCEL,function(e){setTimeout(function(){t.cancel()},100)}).on(TC.Consts.event.STYLECHANGE,function(e){t.onStyleChange(e)});n.exportsState=!1});t._elevationControlPromise=e.addControl("elevation",t.options.displayElevation);t.setMode(t.options.mode);e.on(TC.Consts.event.FEATUREADD,function(e){const n=e.layer,o=e.feature;if(n===t.layer){t.setFeatureMeasureData(o);t._modifyPromise.then(function(e){e.displayLabelText(o.getStyle().label)});t._clearBtn.disabled=!1;t._downloadBtn.disabled=!1}}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(e){if(e.layer===t.layer&&0===t.layer.features.length){t._clearBtn.disabled=!0;t._downloadBtn.disabled=!0;t.resetValues()}}).on(TC.Consts.event.RESULTSPANELCLOSE,function(e){t.getElevationControl().then(function(t){t===e.control&&t.setCurrentFeature(null)})});n(t)})}).catch(function(e){o(e)})})};e.displayMode=function(e){const t=this;e===TC.Consts.geom.POINT&&(t._activeMode=t.div.querySelector(".tc-ctl-meas-pt"));t.modify&&t.modify.div.classList.remove(TC.Consts.classes.COLLAPSED);return TC.control.Measure.prototype.displayMode.call(t,e)};e.setMode=function(e){const t=this;e===TC.Consts.geom.POINT?t._pointDrawControlPromise.then(function(n){n.activate();TC.control.Measure.prototype.setMode.call(t,e)}):TC.control.Measure.prototype.setMode.call(t,e)};e.setFeatureMeasureData=function(e){const t=this,n={};switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:const o=t._1stCoordText.innerHTML,a=t._2ndCoordText.innerHTML,l=t._elevationText.innerHTML;if(t._1stCoordValue.textContent.trim().length>0&&t._2ndCoordValue.textContent.trim().length>0){n.CRS=t.map.crs;n[o.substr(0,o.indexOf(":"))]=parseFloat(t._1stCoordValue.dataset.value);n[a.substr(0,a.indexOf(":"))]=parseFloat(t._2ndCoordValue.dataset.value);l&&(n[t.getLocaleString("ele")]=parseFloat(t._elevationValue.dataset.value));e.setData(n)}break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:if(t._len.innerHTML.trim()!==t.NOMEASURE){n[t.getLocaleString("2dLength")]=t._len.innerHTML;e.setData(n)}break;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:if(t._area.innerHTML.trim()!==t.NOMEASURE&&t._peri.innerHTML.trim()!==t.NOMEASURE){n[t.getLocaleString("area")]=t._area.innerHTML;n[t.getLocaleString("2dPerimeter")]=t._peri.innerHTML;e.setData(n)}}return t};e.getFeatureMeasureData=function(e){const t=this,n={units:"m"},o={crs:t.map.options.utmCrs};switch(!0){case TC.feature.Polygon&&e instanceof TC.feature.Polygon:n.area=e.getArea(o);n.perimeter=e.getLength(o);break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:n.length=e.getLength(o);t.getElevationControl().then(n=>{t.elevationProfileActive&&n.displayElevationProfile(e)});break;case TC.feature.Point&&e instanceof TC.feature.Point:n.coords=e.geometry}return n};e.showMeasurements=function(e){const t=this;TC.control.Measure.prototype.showMeasurements.call(t,e);e=e||{};const n=t.map.options.locale||TC.Cfg.locale;if(e.coords){var o,a,l;if("m"===e.units){o=TC.Consts.METER_PRECISION;a=e.coords[0];l=e.coords[1];t._1stCoordText.innerHTML="x: ";t._2ndCoordText.innerHTML="y: "}else{o=TC.Consts.DEGREE_PRECISION;a=e.coords[1];l=e.coords[0];t._1stCoordText.innerHTML="lat: ";t._2ndCoordText.innerHTML="lon: "}const s=Math.pow(10,o),r=function(e){return Math.round(e*s)/s};t._1stCoordValue.innerHTML=TC.Util.formatNumber(a.toFixed(o),n);t._1stCoordValue.dataset.value=r(a);t._2ndCoordValue.innerHTML=TC.Util.formatNumber(l.toFixed(o),n);t._2ndCoordValue.dataset.value=r(l);if(e.coords.length>2){const o=Math.round(e.coords[2]);t._elevationText.innerHTML=t.getLocaleString("ele").toLowerCase()+": ";t._elevationValue.innerHTML=TC.Util.formatNumber(o.toFixed(TC.Consts.METER_PRECISION),n)+" m";t._elevationValue.dataset.value=o}else{t._elevationText.innerHTML="";t._elevationValue.innerHTML="";t._elevationValue.dataset.value=""}}return t};e.resetValues=function(){const e=this;TC.control.Measure.prototype.resetValues.call(e);if(e._1stCoordText){e._1stCoordText.innerHTML=e.NOMEASURE;e._2ndCoordText.innerHTML="";e._1stCoordValue.innerHTML="";e._1stCoordValue.dataset.value="";e._2ndCoordValue.innerHTML="";e._2ndCoordValue.dataset.value="";e._elevationText.innerHTML="";e._elevationValue.innerHTML="";e._elevationValue.dataset.value=""}return e};e.resetDrawWatches=function(){this.drawControls.forEach(function(e){e.setStrokeColorWatch().setStrokeWidthWatch()})};e.clear=function(){const e=this;e.resetValues();e.layer.clearFeatures();e.modify.isActive&&e.modify.deactivate();e.options.displayElevation&&e.getElevationControl().then(function(e){e.resetElevationProfile();e.resultsPanel&&e.resultsPanel.close()});e._clearBtn.disabled=!0;e._downloadBtn.disabled=!0;return e};e.showSketchDownloadDialog=function(e){const t=this;t.getDownloadDialog().then(function(e){var n={title:t.getLocaleString("downloadSketch"),fileName:t.getLocaleString("sketch").toLowerCase().replace(" ","_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)};(t.map.elevation||t.options.displayElevation)&&(n=Object.assign({},n,{elevation:Object.assign({},t.map.elevation&&t.map.elevation.options,t.options.displayElevation)}));e.open(t.layer.features,n)});return t};e.onStyleChange=function(e){const t=this;var n;switch(e.target.mode){case TC.Consts.geom.POLYGON:n=TC.feature.Polygon;break;case TC.Consts.geom.POLYLINE:n=TC.feature.Polyline;break;case TC.Consts.geom.POINT:n=TC.feature.Point}n&&t.modify.getSelectedFeatures().forEach(function(t){if(t instanceof n){const n={};n[e.property]=e.value;t.setStyle(n)}})};e.activateElevationProfile=async function(){const e=this;e.elevationProfileActive=!0;e._elevProfileBtn.classList.add(TC.Consts.classes.ACTIVE);e._elevProfileBtn.setAttribute("title",e.getLocaleString("deactivateElevationProfile"));var t=!1;const n=await e.getElevationControl();if(e.lineDrawControl.historyIndex>1){n.displayElevationProfile(e.lineDrawControl.history.slice(0,e.lineDrawControl.historyIndex));t=!0}else{const o=e.modify.getActiveFeatures().filter(function(e){return TC.feature.Polyline&&e instanceof TC.feature.Polyline});if(o.length){const e=o[o.length-1];n.displayElevationProfile(e.geometry);t=!0}}t||n.resetElevationProfile();n.resultsPanel&&n.resultsPanel.show()};e.deactivateElevationProfile=async function(){this.elevationProfileActive=!1;this._elevProfileBtn.classList.remove(TC.Consts.classes.ACTIVE);this._elevProfileBtn.setAttribute("title",this.getLocaleString("activateElevationProfile"));const e=await this.getElevationControl();e.resetElevationProfile();e.resultsPanel&&e.resultsPanel.close()};e.resetElevationProfile=function(){const e=this;if(e.options.displayElevation&&e.resultsPanelChart){e.elevationChartData={x:[0],ele:[0],coords:[0,0,0],upHill:0,downHill:0};e.resultsPanelChart.openChart(e.elevationChartData)}};e.getElevationControl=function(){return this._elevationControlPromise}}();
//# sourceMappingURL=../maps/control/DrawMeasureModify.min.js.map