TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Elevation=function(){TC.Control.apply(this,arguments);this.displayElevation=!0;this.resultsPanel=null};TC.inherit(TC.control.Elevation,TC.Control);!function(){const t=TC.control.Elevation.prototype;t.CLASS="tc-ctl-elev";t.template={};t.template[t.CLASS]={compiler:[8,">= 4.3.0"],main:function(t,e,n,o,l){var a=null!=e?e:t.nullContext||{},i=t.escapeExpression,r=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="tc-ctl-ftools">\r\n    <button class="tc-icon-btn tc-ctl-ftools-dl-btn" title="'+i(r(n,"i18n").call(a,"downloadFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:2,column:60},end:{line:2,column:86}}}))+'">'+i(r(n,"i18n").call(a,"download",{name:"i18n",hash:{},data:l,loc:{start:{line:2,column:88},end:{line:2,column:107}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-share-btn" title="'+i(r(n,"i18n").call(a,"shareFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:3,column:63},end:{line:3,column:86}}}))+'">'+i(r(n,"i18n").call(a,"share",{name:"i18n",hash:{},data:l,loc:{start:{line:3,column:88},end:{line:3,column:104}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-zoom-btn" title="'+i(r(n,"i18n").call(a,"zoomToFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:4,column:62},end:{line:4,column:86}}}))+'">'+i(r(n,"i18n").call(a,"zoomToFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:4,column:88},end:{line:4,column:112}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-elev-btn tc-hidden" title="'+i(r(n,"i18n").call(a,"viewElevation",{name:"i18n",hash:{},data:l,loc:{start:{line:5,column:72},end:{line:5,column:96}}}))+'">'+i(r(n,"i18n").call(a,"viewElevation",{name:"i18n",hash:{},data:l,loc:{start:{line:5,column:98},end:{line:5,column:122}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-prof-btn tc-hidden" title="'+i(r(n,"i18n").call(a,"viewElevationProfile",{name:"i18n",hash:{},data:l,loc:{start:{line:6,column:72},end:{line:6,column:103}}}))+'">'+i(r(n,"i18n").call(a,"viewElevationProfile",{name:"i18n",hash:{},data:l,loc:{start:{line:6,column:105},end:{line:6,column:136}}}))+'</button>\r\n    <button class="tc-icon-btn tc-ctl-ftools-del-btn" title="'+i(r(n,"i18n").call(a,"deleteFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:7,column:61},end:{line:7,column:85}}}))+'">'+i(r(n,"i18n").call(a,"deleteFeature",{name:"i18n",hash:{},data:l,loc:{start:{line:7,column:87},end:{line:7,column:111}}}))+"</button>\r\n</div>"},useData:!0};t.template[t.CLASS+"-val"]={1:function(t,e,n,o,l){var a=null!=e?e:t.nullContext||{},i=t.escapeExpression,r=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<tr class="tc-ctl-elev-pair-elev-orig">\r\n    <th><span>'+i(r(n,"i18n").call(a,"ele",{name:"i18n",hash:{},data:l,loc:{start:{line:3,column:14},end:{line:3,column:28}}}))+" ("+i(r(n,"i18n").call(a,"original",{name:"i18n",hash:{},data:l,loc:{start:{line:3,column:30},end:{line:3,column:49}}}))+")</span></th>\r\n    <td>"+i(t.lambda(null!=e?r(e,"originalValue"):e,e))+" m</td>\r\n</tr>\r\n"},3:function(t,e,n,o,l){var a,i=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<tr class="tc-ctl-elev-pair-elev">\r\n    <th><span>'+(null!=(a=i(n,"if").call(null!=e?e:t.nullContext||{},null!=e?i(e,"originalValue"):e,{name:"if",hash:{},fn:t.program(4,l,0),inverse:t.program(6,l,0),data:l,loc:{start:{line:9,column:14},end:{line:9,column:101}}}))?a:"")+"</span></th>\r\n    <td>"+t.escapeExpression(t.lambda(null!=e?i(e,"elevationValue"):e,e))+" m</td>\r\n</tr>\r\n"},4:function(t,e,n,o,l){var a=null!=e?e:t.nullContext||{},i=t.escapeExpression,r=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return i(r(n,"i18n").call(a,"ele",{name:"i18n",hash:{},data:l,loc:{start:{line:9,column:35},end:{line:9,column:49}}}))+" ("+i(r(n,"i18n").call(a,"mdt",{name:"i18n",hash:{},data:l,loc:{start:{line:9,column:51},end:{line:9,column:65}}}))+")"},6:function(t,e,n,o,l){var a=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return t.escapeExpression(a(n,"i18n").call(null!=e?e:t.nullContext||{},"elevation",{name:"i18n",hash:{},data:l,loc:{start:{line:9,column:74},end:{line:9,column:94}}}))},8:function(t,e,n,o,l){var a=t.escapeExpression,i=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<tr class="tc-ctl-elev-pair-height">\r\n    <th><span>'+a(i(n,"i18n").call(null!=e?e:t.nullContext||{},"heightOverTerrain",{name:"i18n",hash:{},data:l,loc:{start:{line:15,column:14},end:{line:15,column:42}}}))+"</span></th>\r\n    <td>"+a(t.lambda(null!=e?i(e,"heightValue"):e,e))+" m</td>\r\n</tr>\r\n"},compiler:[8,">= 4.3.0"],main:function(t,e,n,o,l){var a,i=null!=e?e:t.nullContext||{},r=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return(null!=(a=r(n,"if").call(i,null!=e?r(e,"originalValue"):e,{name:"if",hash:{},fn:t.program(1,l,0),inverse:t.noop,data:l,loc:{start:{line:1,column:0},end:{line:6,column:7}}}))?a:"")+(null!=(a=r(n,"if").call(i,null!=e?r(e,"elevationValue"):e,{name:"if",hash:{},fn:t.program(3,l,0),inverse:t.noop,data:l,loc:{start:{line:7,column:0},end:{line:12,column:7}}}))?a:"")+(null!=(a=r(n,"if").call(i,null!=e?r(e,"heightValue"):e,{name:"if",hash:{},fn:t.program(8,l,0),inverse:t.noop,data:l,loc:{start:{line:13,column:0},end:{line:18,column:7}}}))?a:"")},useData:!0};const e=new Map,n=function(t){if(t){const n=t.getCoords();n&&e.delete(n.toString())}};t.register=function(t){const e=this;return new Promise(function(o,l){TC.Control.prototype.register.call(e,t).then(function(){t.on(TC.Consts.event.FEATUREMODIFY+" "+TC.Consts.event.FEATUREREMOVE,function(t){n(t.feature)}).on(TC.Consts.event.FEATUREREMOVE,function(t){n(t.feature)}).on(TC.Consts.event.LAYERREMOVE,function(t){t.layer.features&&t.layer.features.forEach(t=>n(t))});o(e)}).catch(function(t){l(t)})})};t.getElevationTool=function(){const t=this;return new Promise(function(e,n){const o={options:{displayElevation:t.options||!0},elevation:t.elevation,map:t.map};TC.Control.prototype.getElevationTool.call(o).then(n=>{t.elevation=n;e(n)})})};t.setElevationToolOptions=function(t){const e=this;TC.Util.extend(e.options,t);e.elevation&&TC.Util.extend(e.elevation.options,e.options)};t.displayElevationValue=function(t){const e=this;t instanceof TC.feature.Point&&e.getElevationTool().then(function(n){n.getElevation({crs:e.map.crs,coordinates:[t.geometry]}).then(function(n){if(n.length){const o=[],l=e.map.options.locale||TC.Cfg.locale,a=n[0],i=a[2],r=a.length>3?a[3]:null,c=e.map.getControlsByClass("TC.control.Popup").concat(e.map.getControlsByClass("TC.control.ResultsPanel"));c.filter(e=>(e.caller&&e.caller.highlightedFeature)===t).forEach(function(e){const n=e.caller.getFeatureElement(t);if(n){target=n.querySelector("tbody");o.push(target)}});c.filter(e=>e.currentFeature===t).forEach(function(t){let e;switch(!0){case TC.control.Popup&&t instanceof TC.control.Popup:e=t.getContainerElement();break;case TC.control.ResultsPanel&&t instanceof TC.control.ResultsPanel:e=t.getInfoContainer()}if(e){target=e.querySelector("tbody");o.push(target)}});o.forEach(function(n){e.getRenderedHtml(e.CLASS+"-val",{originalValue:t.geometry[2]?TC.Util.formatNumber(Math.round(t.geometry[2]),l):"",elevationValue:null!==i?TC.Util.formatNumber(Math.round(i),l):"",heightValue:r?r.toLocaleString(l,{maximumFractionDigits:1}):""},function(t){n.querySelectorAll(`tr[class|=${e.CLASS}-pair]`).forEach(t=>t.remove());n.insertAdjacentHTML("beforeend",t)})})}})})};t.displayElevationProfile=function(t,n){const o=this,l=n||{};let a;switch(!0){case TC.feature.Polyline&&t instanceof TC.feature.Polyline:a=t.geometry;break;case TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline:a=t.geometry[0];break;case t instanceof TC.Feature:return;default:a=t}o.getProfilePanel().then(function(t){t.open()});const i=function(t){o.getProfilePanel().then(function(e){e.renderPromise().then(function(){o.renderElevationProfile(t)})})};if(t instanceof TC.Feature){o.getProfilePanel().then(function(e){e.setCurrentFeature(t)});const n=function(t){if(t){const n=t.getCoords();return n?e.get(n.toString()):null}}(t);if(n){i(n);return}}const r=o.map.getLoadingIndicator(),c=r&&r.addWait(),s=function(n,l){let a=0,r=Number.NEGATIVE_INFINITY,c=Number.POSITIVE_INFINITY;o.map.crs!==o.map.options.utmCrs&&(n=TC.Util.reproject(n,o.map.crs,o.map.options.utmCrs));const s=n.map(function(t,e,n){let o=0===e?t:n[e-1];const l=t[0]-o[0],i=t[1]-o[1];a+=Math.sqrt(l*l+i*i);var s=t[2]||0;if("number"==typeof s){r=Math.max(s,r);c=Math.min(s,c)}return[a,s]});1===s.length&&s.push(s[0]);let u={x:s.map(function(t){return t[0]}),ele:s.map(function(t){return t[1]||0}),coords:n,min:c,max:r};const h={coords:n};"object"==typeof o.options&&o.map.options.elevation&&(h.hillDeltaThreshold=o.options.hillDeltaThreshold||o.map.options.elevation.hillDeltaThreshold);0===c&&0===r&&l.onlyOriginalElevation&&(u={msg:o.getLocaleString("geo.trk.chart.chpe.empty")});TC.Util.extend(u,TC.tool.Elevation.getElevationGain(h),l);if(l.isSecondary&&o.elevationProfileChartData)if(o.elevationProfileChartData.secondaryElevationProfileChartData)o.elevationProfileChartData.secondaryElevationProfileChartData[0]=u;else{o.elevationProfileChartData.showLegend=!0;o.elevationProfileChartData.secondaryElevationProfileChartData=[];o.elevationProfileChartData.secondaryElevationProfileChartData.push(u)}t instanceof TC.Feature&&!l.ignoreCaching&&function(t,n){if(t){const o=t.getCoords();o&&e.set(o.toString(),n)}}(t,u);i(u)};o.getElevationTool().then(function(t){l.originalElevation&&s(a,l);if(l.onlyOriginalElevation){r&&r.removeWait(c);return}const e=Date.now();o._depTimestamp=e;const n={crs:o.map.crs,coordinates:a,partialCallback:function(t){e===o._depTimestamp&&s(t,{isSecondary:0!==Object.keys(l).length,ignoreCaching:l.ignoreCaching})}};t.options.hasOwnProperty("resolution")&&(n.resolution=t.options.resolution);t.options.hasOwnProperty("sampleNumber")&&0!==t.options.sampleNumber&&(n.resolution=0);t.getElevation(n).then(function(){l.callback&&TC.Util.isFunction(l.callback)&&l.callback();r&&r.removeWait(c)}).catch(function(t){o.resetElevationProfile();r&&r.removeWait(c)})})};t.createProfilePanel=function(){const e=this,n={id:e.getUID(),content:"chart",titles:{main:e.getLocaleString("geo.trk.chart.chpe"),max:e.getLocaleString("geo.trk.chart.chpe")},chart:{ctx:e,onmouseout:t.removeElevationTooltip,tooltip:t.getElevationTooltip}};return new Promise(function(t,o){var l;const a=function(t){n.position=t.POSITION.RIGHT;l=t.addControl("resultsPanel",n)};if(e.options.displayOn){var i=e.map.getControlsByClass("TC.control."+e.options.displayOn[0].toUpperCase()+e.options.displayOn.substring(1))[0];i?a(i):e.map.addControl(e.options.displayOn).then(a)}else{n.div=document.createElement("div");e.map.div.appendChild(n.div);l=e.map.addControl("resultsPanel",n)}l.then(function(n){n.caller=e;e.resultsPanel=n;e._decorateChartPanel();t(n)})})};t.getProfilePanel=async function(){const t=this;t._resultsPanelPromise||(t._resultsPanelPromise=t.createProfilePanel());return await t._resultsPanelPromise};t.resetElevationProfile=function(){const t=this;if(t.options.displayElevation&&t.resultsPanel){t.elevationProfileChartData={x:[0],ele:[0],coords:[0,0,0],upHill:0,downHill:0};t.resultsPanel.openChart(t.elevationProfileChartData)}};t.renderElevationProfile=function(t){const e=this;t.isSecondary||(e.elevationProfileChartData=t||e.elevationProfileChartData);e.getProfilePanel().then(function(n){if(!n.div.classList.contains(TC.Consts.classes.HIDDEN)){t.isSecondary?n.loadDataOnChart(e.elevationProfileChartData):n.openChart(e.elevationProfileChartData);n.isMinimized()||n.doVisible()}})};t.closeElevationProfile=function(){this.getProfilePanel().then(function(t){t.close()})};t._decorateChartPanel=function(){this.resultsPanel.setCurrentFeature=function(t){const e=this;e.currentFeature&&e.currentFeature.toggleSelectedStyle(!1);e.currentFeature=t;t&&t.toggleSelectedStyle(!0)};const t=this.resultsPanel.close;this.resultsPanel.close=function(){const e=this;e.currentFeature&&e.currentFeature.toggleSelectedStyle(!1);t.call(e)}};t.getElevationTooltip=function(t){this.resultsPanel.wrap.showElevationMarker({data:t,layer:this.resultsPanel.currentFeature&&this.resultsPanel.currentFeature.layer,coords:this.elevationProfileChartData.coords});return this.resultsPanel.getElevationChartTooltip(t)};t.removeElevationTooltip=function(){const t=this;if(t.resultsPanel){t.resultsPanel.chart&&t.resultsPanel.chart.chart&&t.resultsPanel.chart.chart.tooltip.hide();t.resultsPanel.wrap.hideElevationMarker()}}}();
//# sourceMappingURL=../maps/control/Elevation.min.js.map