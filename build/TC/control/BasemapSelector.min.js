TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");!function(){TC.control.BasemapSelector=function(){var e=this;TC.control.MapContents.apply(e,arguments);e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv));e.options.dialogDiv||e._$dialogDiv.appendTo("body");e._$dialogDiv.on(TC.Consts.event.CLICK,"button:not(.tc-modal-close)",function(a){TC.Util.closeModal();const o=$(a.target),s=o.data(t.PROJCODE),n=e._$dialogDiv.find("."+e.CLASS+"-crs-dialog");n.addClass(TC.Consts.classes.HIDDEN);const i=n.data(t.LAYER);if(i)if(s)TC.loadProjDef({crs:s,callback:function(){e.map.setProjection({crs:s,baseLayer:i})}});else{o.data(t.FALLBACK_LAYER)&&e.map.setBaseLayer(i)}})};TC.inherit(TC.control.BasemapSelector,TC.control.MapContents);var e=TC.control.BasemapSelector.prototype;e.CLASS="tc-ctl-bms";var t={LAYER:"tcLayer",FALLBACK_LAYER:"tcFallbackLayer",PROJCODE:"tcProjCode"};e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/BasemapSelector.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/BasemapSelectorNode.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/BasemapSelectorDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"backgroundMaps"}).w('</h2><div class="tc-ctl-bms-tree"><form><ul class="tc-ctl-bms-branch">').s(t.get(["baseLayers"],!1),t,{block:a},{}).s(t.get(["dialogMore"],!1),t,{block:o},{}).w("</ul></form></div>")}t.__dustBody=!0;function a(e,t){return e.p("tc-ctl-bms-node",t,t.rebase(t.getPath(!0,[])),{})}a.__dustBody=!0;function o(e,t){return e.w('<li class="tc-ctl-bms-node"><label class="tc-ctl-bms-more-node" title="').h("i18n",t,{},{$key:"moreBackgroundMaps"}).w('"><input type="radio" name="bms" value="moreLayers" /><span></span></label></li>')}o.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.w('<li class="tc-ctl-bms-node" data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('" ><label').x(t.get(["legend"],!1),t,{block:a},{}).x(t.get(["thumbnail"],!1),t,{block:o},{}).w('><input type="radio" name="bms" value="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["mustReproject"],!1),t,{block:s},{}).w(" /><span>").f(t.get(["title"],!1),t,"h").w("</span></label></li>")}t.__dustBody=!0;function a(e,t){return e.w(' style="background-image: url(').f(t.getPath(!1,["legend","src"]),t,"h").w(')"')}a.__dustBody=!0;function o(e,t){return e.w(' style="background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"')}o.__dustBody=!0;function s(e,t){return e.w(' class="tc-disabled"')}s.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-bms-more-dialog tc-modal tc-hidden"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"backgroundMaps"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w('</button></div></div></div><div class="tc-ctl-bms-crs-dialog tc-modal tc-hidden"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"baseLayerNotCompatible"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"baseLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-bms-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}const a=function(e,a){const o=this;var s=!0,n=$(e.target),i=n.closest("li").data(t.LAYER);o.options.dialogMore&&n.closest("."+o.CLASS+"-more-dialog").length>0&&o._$div.find("input[type=radio]").each(function(e,a){var o=$(a).closest("li").data(t.LAYER);if(o)switch(!0){case o.id===i.id:i=o;n=$(a);return!1}});if(i!=o.map.getBaseLayer())if(i.mustReproject){if(o.map.on3DView){if(!i.getFallbackLayer()){o._$currentSelection.prop("checked",!0);e.stopPropagation();return}if(i.getFallbackLayer()){const e=i.getFallbackLayer();e&&e._capabilitiesPromise.then(function(){e.isCompatible(o.map.getCRS())&&o.map.setBaseLayer(i)});s=!0}}else{o._$currentSelection&&o._$currentSelection.prop("checked",!0);const e={layer:i},t=i.getFallbackLayer();t?t._capabilitiesPromise.then(function(){t.isCompatible(o.map.getCRS())&&(e.fallbackLayer=t);o.showProjectionChangeDialog(e)}):o.showProjectionChangeDialog(e)}s=!1}else{(i.type===TC.Consts.layerType.WMS||i.type===TC.Consts.layerType.WMTS&&i.getProjection()!==o.map.crs)&&i.setProjection({crs:o.map.crs});o.map.setBaseLayer(i)}this._$currentSelection&&this._$currentSelection.prop("checked",!0);a&&a(s)};e.register=function(e){var t=this;TC.control.MapContents.prototype.register.call(t,e);t.options.dialogMore&&e.on(TC.Consts.event.VIEWCHANGE,function(){t._getMoreBaseLayers()});e.on(TC.Consts.event.BASELAYERCHANGE+" "+TC.Consts.event.PROJECTIONCHANGE+" "+TC.Consts.event.VIEWCHANGE,function(e){t.update(t._$div,e.layer)});t._$div.on("change","input[type=radio]",function(e){const t=this;"moreLayers"==$(e.target).val()?t.showMoreLayersDialog():a.call(t,e);e.stopPropagation()}.bind(t))};e.render=function(e){var t=this;TC.control.MapContents.prototype.render.call(t,e,t.options);t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e);if(t.options.dialogMore){t._$dialogDiv.find("."+t.CLASS+"-more-dialog").on("change","input[type=radio]",function(e){a.call(this,e,function(e){e&&TC.Util.closeModal()});e.stopPropagation()}.bind(t))}})};e.update=function(e,a){var o=this;(e=e||o._$div).find("ul."+o.CLASS+"-branch").children("li").each(function(e,s){var n=$(s),i=n.data(t.LAYER);if(i){var r=a||o.map.baseLayer,l=n.find("input[type=radio]").first(),c=r&&(r===i||r.id===i.id||i.getFallbackLayer&&(r===i.getFallbackLayer()||i.getFallbackLayer()&&r.id===i.getFallbackLayer().id));if(o.map.on3DView&&i.mustReproject&&i.fallbackLayer&&i.getFallbackLayer)i.getFallbackLayer().getCapabilitiesPromise().then(function(){var e=!i.getFallbackLayer().isCompatible(o.map.getCRS());l.prop("checked",c).toggleClass(TC.Consts.classes.DISABLED,e||!1);n.attr("title",e?o.map.on3DView?o.getLocaleString("notAvailableTo3D"):o.getLocaleString("reprojectionNeeded"):null)});else{l.prop("checked",c).toggleClass(TC.Consts.classes.DISABLED,i.mustReproject||!1);n.attr("title",i.mustReproject?o.map.on3DView?o.getLocaleString("notAvailableTo3D"):o.getLocaleString("reprojectionNeeded"):null)}c&&(o._$currentSelection=l)}});o.updateScale()};e.updateLayerTree=function(e){var a=this;if(e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(a,e);var o=a.CLASS+"-node";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(o,a.layerTrees[e.id],function(o,s){var n=$(s),i=n.data("tcLayerUid"),r=a._$div.find("."+a.CLASS+"-branch"),l=r.find('li[data-tc-layer-uid="'+i+'"]');if(1===l.length)l.html(n.html());else{n.data(t.LAYER,e);var c=a.map.baseLayers.filter(function(e){return!e.stealth}).map(function(e){return e.id}).indexOf(e.id);if(c<0)r.append(n);else{c>=r.find("li").length?r.append(n):n.insertBefore(r.find("li").get(c))}}o&&TC.error(o)});a.update()})}};e.updateLayerOrder=function(e,t,a){};e.removeLayer=function(e){if(e.isBase){this._$div.find("."+this.CLASS+"-branch").children("li").each(function(a,o){var s=$(o);if(s.data(t.LAYER)===e){s.remove();return!1}})}};e.showProjectionChangeDialog=function(e){const a=this,o=(e=e||{}).layer,s=a._$dialogDiv.find("."+a.CLASS+"-crs-dialog"),n=s.find(".tc-modal-body").addClass(TC.Consts.classes.LOADING);s.removeClass(TC.Consts.classes.HIDDEN);s.data(t.LAYER,o);const i=s.find("ul."+a.CLASS+"-crs-list").empty();a.map.loadProjections({crsList:a.map.getCompatibleCRS({layers:a.map.workLayers.concat(o)}),orderBy:"name"}).then(function(o){o.forEach(function(e){i.append($("<li>").append($("<button>").html(a.getLocaleString("changeMapToCrs",{crs:e.name+" ("+e.code+")"})).data(t.PROJCODE,e.code)))});e.fallbackLayer&&i.append($("<li>").append($("<button>").html(a.getLocaleString("reprojectOnTheFly")).data(t.FALLBACK_LAYER,e.fallbackLayer)));n.removeClass(TC.Consts.classes.LOADING)});s.find("."+a.CLASS+"-name").html(o.title||o.name);TC.Util.showModal(s)};e.showMoreLayersDialog=function(){const e=this,a=e._$dialogDiv.find("."+e.CLASS+"-more-dialog");e.map.on3DView?a.addClass(TC.Consts.classes.THREED):a.hasClass(TC.Consts.classes.THREED)&&a.removeClass(TC.Consts.classes.THREED);a.find(".tc-modal-body").empty();const o=a.find(".tc-modal-body").addClass(TC.Consts.classes.LOADING);a.removeClass(TC.Consts.classes.HIDDEN);TC.Util.showModal(a,{closeCallback:function(){this._$currentSelection.prop("checked",!0);this.update()}.bind(e)});a.find(".tc-modal-window").hasClass(e.CLASS+"-more-dialog")||a.find(".tc-modal-window").addClass(e.CLASS+"-more-dialog");e._getMoreBaseLayers().then(function(){e.getRenderedHtml(e.CLASS,{baseLayers:e._moreBaseLayers},function(a){o.html(a);o.removeClass(TC.Consts.classes.LOADING);o.find("li").each(function(a,o){$(o).data(t.LAYER,e._moreBaseLayers[a])});e.update(o)})})};const o=function(e){var t=new $.Deferred,a=new $.Deferred;$.when.apply(this,[e.getCapabilitiesPromise(),e.getFallbackLayer()?e.getFallbackLayer().getCapabilitiesPromise():a.resolve()]).then(function(){t.resolve()});return t};e._getMoreBaseLayers=function(){const e=this;if(e._moreBaseLayers||e._moreBaseLayersPromise){if(e._moreBaseLayers){$.when.apply(this,e._moreBaseLayers.filter(function(e){return e.type===TC.Consts.layerType.WMS||e.type===TC.Consts.layerType.WMTS}).map(function(t){return e.map.on3DView?o(t):t.getCapabilitiesPromise()})).then(function(){e._moreBaseLayers=e._moreBaseLayers.map(function(t){if(t.type===TC.Consts.layerType.WMTS){var a=t.wrap.getCompatibleMatrixSets(e.map.getCRS())[0];t.mustReproject=!a}else t.type===TC.Consts.layerType.WMS&&(t.mustReproject=!t.isCompatible(e.map.getCRS()));if(e.map.on3DView&&t.mustReproject&&t.getFallbackLayer&&t.getFallbackLayer()){t.mustReproject=!t.getFallbackLayer().isCompatible(e.map.getCRS());return t}return t})});e._moreBaseLayersPromise.resolve(e._moreBaseLayers)}}else{e._moreBaseLayersPromise=new $.Deferred;var t=TC.Cfg.availableBaseLayers.filter(function(e){return-1==TC.Cfg.availableBaseLayers.filter(function(e){return e.fallbackLayer}).map(function(e){return e.fallbackLayer}).indexOf(e.id)});$.when.apply(this,t.map(function(e){return e.type===TC.Consts.layerType.WMS||e.type===TC.Consts.layerType.WMTS?new TC.layer.Raster(e):e.type==TC.Consts.layerType.VECTOR?new TC.layer.Vector(e):void 0})).then(function(){var t=Array.prototype.slice.call(arguments);$.when.apply(this,t.filter(function(e){return e.type===TC.Consts.layerType.WMS||e.type===TC.Consts.layerType.WMTS}).map(function(t){return e.map.on3DView?o(t):t.getCapabilitiesPromise()})).then(function(){e._moreBaseLayers=t.map(function(t){t.map=e.map;t.isBase=t.options.isBase=!0;if(t.type===TC.Consts.layerType.WMTS){var a=t.wrap.getCompatibleMatrixSets(e.map.getCRS())[0];t.mustReproject=!a}else t.type===TC.Consts.layerType.WMS&&(t.mustReproject=!t.isCompatible(e.map.getCRS()));if(e.map.on3DView&&t.mustReproject&&t.getFallbackLayer&&t.getFallbackLayer()){t.mustReproject=!t.getFallbackLayer().isCompatible(e.map.getCRS());return t}return t});e._moreBaseLayersPromise.resolve(e._moreBaseLayers)})})}return e._moreBaseLayersPromise.promise()}}();