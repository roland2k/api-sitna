TC.control=TC.control||{};TC.control.MapInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/MapInfo");TC.control.PrintMap=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintMap,TC.control.MapInfo);!function(){var t=TC.control.PrintMap.prototype;t.CLASS="tc-ctl-prnmap";const e="portrait",n="landscape",i="A4",a="A3";var r={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:595,height:842},pageMargins:[29.5,14,29.5,22.5],content:[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",width:489,alignment:"center",margin:[0,10,0,0]},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:534,height:775.5}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",width:489,alignment:"center",margin:[0,10,0,0]},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:534,height:775.5}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},o={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:842,height:595},pageMargins:[30,14,30,22],content:[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:528}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:528}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},l={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:841.89,height:1190.55},pageMargins:[29.954,14,29.954,21.55],content:[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",width:489,margin:[0,10,0,0],alignment:"center"},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:1125}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",width:489,margin:[0,10,0,0],alignment:"center"},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:1125}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},c={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:1190.55,height:841.89},pageMargins:[28.775,14,28.775,14.89],content:[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:1131,height:783}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:1131,height:783}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}};const s=function(t,s){switch(t){case e:switch(s){case i:return r;case a:return l}break;case n:switch(s){case i:return o;case a:return c}break;default:return r}},d=function(t){return t.layoutPDF.content[0].columns[0]},u=function(t){return t.layoutPDF.content[0].columns[2]},g={sideLength:85};t.template={};t.template[t.CLASS]={compiler:[8,">= 4.3.0"],main:function(t,e,n,i,a){var r=null!=e?e:t.nullContext||{},o=t.escapeExpression,l=t.lambda,c=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return"<h2>"+o(c(n,"i18n").call(r,"print",{name:"i18n",hash:{},data:a,loc:{start:{line:1,column:4},end:{line:1,column:20}}}))+'</h2>\r\n<div>\r\n    <div class="tc-ctl-prnmap-div">\r\n        <div class="tc-group tc-ctl-prnmap-cnt">\r\n            <label>'+o(c(n,"i18n").call(r,"title",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:19},end:{line:5,column:35}}}))+':</label><input type="text" class="tc-ctl-prnmap-title tc-textbox" maxlength="30" placeholder="'+o(c(n,"i18n").call(r,"mapTitle",{name:"i18n",hash:{},data:a,loc:{start:{line:5,column:130},end:{line:5,column:149}}}))+'" />\r\n        </div>\r\n        <div class="tc-group tc-ctl-prnmap-cnt">\r\n            <label>'+o(c(n,"i18n").call(r,"layout",{name:"i18n",hash:{},data:a,loc:{start:{line:8,column:19},end:{line:8,column:36}}}))+':</label><select id="print-design" class="tc-combo">\r\n                <option value="landscape">'+o(c(n,"i18n").call(r,"landscape",{name:"i18n",hash:{},data:a,loc:{start:{line:9,column:42},end:{line:9,column:62}}}))+'</option>\r\n                <option value="portrait">'+o(c(n,"i18n").call(r,"portrait",{name:"i18n",hash:{},data:a,loc:{start:{line:10,column:41},end:{line:10,column:60}}}))+'</option>\r\n            </select>\r\n        </div>\r\n        <div class="tc-group tc-ctl-prnmap-cnt">\r\n            <label>'+o(c(n,"i18n").call(r,"size",{name:"i18n",hash:{},data:a,loc:{start:{line:14,column:19},end:{line:14,column:34}}}))+':</label><select id="print-size" class="tc-combo">\r\n                <option value="a4">A4</option>\r\n                <option value="a3">A3</option>\r\n            </select>\r\n        </div>\r\n        <div class="tc-group tc-ctl-prnmap-cnt tc-ctl-prnmap-cnt-btn">\r\n            <input id="tc-ctl-prnmap-image-qr-'+o(l(null!=e?c(e,"controlId"):e,e))+'" class="tc-hidden" type="checkbox" checked style="display:none;" />\r\n            <label for="tc-ctl-prnmap-image-qr-'+o(l(null!=e?c(e,"controlId"):e,e))+'" class="tc-ctl-prnmap-image-qr-label" title="'+o(c(n,"i18n").call(r,"createQrCodeToImage",{name:"i18n",hash:{},data:a,loc:{start:{line:21,column:106},end:{line:21,column:136}}}))+'">'+o(c(n,"i18n").call(r,"appendQRCode",{name:"i18n",hash:{},data:a,loc:{start:{line:21,column:138},end:{line:21,column:161}}}))+'</label>\r\n            <button class="tc-ctl-prnmap-btn tc-button tc-icon-button" title="'+o(c(n,"i18n").call(r,"printMap",{name:"i18n",hash:{},data:a,loc:{start:{line:22,column:78},end:{line:22,column:97}}}))+'">'+o(c(n,"i18n").call(r,"print",{name:"i18n",hash:{},data:a,loc:{start:{line:22,column:99},end:{line:22,column:115}}}))+'</button>\r\n        </div>\r\n        <div class="tc-group tc-ctl-prnmap-cnt">\r\n            <div class="tc-ctl-prnmap-alert tc-alert alert-warning tc-hidden">\r\n                <p>'+o(c(n,"i18n").call(r,"qrAdvice",!0,{name:"i18n",hash:{},data:a,loc:{start:{line:26,column:19},end:{line:26,column:43}}}))+"</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>"},useData:!0};t.template[t.CLASS+"-view"]={compiler:[8,">= 4.3.0"],main:function(t,e,n,i,a){return'<div class="tc-ctl-prnmap-view">    \r\n</div>'},useData:!0};t.template[t.CLASS+"-tools"]={compiler:[8,">= 4.3.0"],main:function(t,e,n,i,a){var r=null!=e?e:t.nullContext||{},o=t.escapeExpression,l=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="tc-ctl-prnmap-tools">\r\n    <div class="tc-ctl-prnmap-btn-pdf" title="'+o(l(n,"i18n").call(r,"printpdf",{name:"i18n",hash:{},data:a,loc:{start:{line:2,column:46},end:{line:2,column:65}}}))+'"></div>\r\n    <div class="tc-ctl-prnmap-btn-close" title="'+o(l(n,"i18n").call(r,"close",{name:"i18n",hash:{},data:a,loc:{start:{line:3,column:48},end:{line:3,column:64}}}))+'"></div>\r\n</div>    '},useData:!0};const p=function(){return this.map.workLayers.some(function(t){return t.type===TC.Consts.layerType.WMS&&t.getVisibility()})};t.register=function(t){const n=this,i=TC.control.MapInfo.prototype.register.call(n,t);n.map.mustBeExportable=!0;const a=function(){s(n.orientation||e,n.format.toString().toUpperCase()||"A4").reset()};n.div.addEventListener("click",TC.EventTarget.listenerBySelector("."+n.CLASS+"-btn",function(){n.map.setView(TC.Consts.view.PRINTING);var t=document.querySelector("."+n.CLASS+"-qrcode");const i=document.querySelector(`#${n.CLASS}-image-qr-${n.id}`);if(!i.disabled&&i.checked){if(!t){(t=document.createElement("div")).classList.add(n.CLASS+"-qrcode");n.map.div.appendChild(t)}t.innerHTML="";n.makeQRCode(t,g.sideLength,g.sideLength)}else t&&(t.innerHTML="");const r="."+n.CLASS+"-btn";n.map.on(TC.Consts.event.STARTLOADING,function(){const t=n.div.querySelector(r);t.classList.add("disabled");t.disabled=!0});n.map.on(TC.Consts.event.STOPLOADING,function(){const t=n.div.querySelector(r);t.classList.remove("disabled");t.disabled=!1});p.call(n)&&n.map.on(TC.Consts.event.ZOOM,a);const o=function(t){if(t){n.map.div.classList.add(t);var e=n.map.div.getBoundingClientRect();Number.isInteger(e.width)||(n.map.div.style.width=Math.round(e.width)+"px");Number.isInteger(e.height)||(n.map.div.style.height=Math.round(e.height)+"px");n.map.toast(n.getLocaleString("print.advice.title")+": "+n.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3})}n.map.wrap.map.updateSize()},l=function(){s(n.orientation||e,n.format.toString().toUpperCase()||"A4").reset();p.call(n)&&n.map.off(TC.Consts.event.ZOOM,a);n.map.toastHide(n.getLocaleString("print.advice.title")+": "+n.getLocaleString("print.advice.desc"));n.map.div.classList.remove(n.currentFormat,n.CLASS+"-printing");n.map.div.style.removeProperty("width");n.map.div.style.removeProperty("height");o();n.map.setView(TC.Consts.view.DEFAULT);n._viewDiv.classList.add(TC.Consts.classes.HIDDEN)};if(!n._viewDiv){n._viewDiv=TC.Util.getDiv();document.body.appendChild(n._viewDiv);n.getRenderedHtml(n.CLASS+"-view",null,function(t){n._viewDiv.innerHTML=t});n.getRenderedHtml(n.CLASS+"-tools",null,function(t){n.map.div.insertAdjacentHTML("beforeend",t);n.map.div.querySelector("."+n.CLASS+"-btn-close").addEventListener("click",l);n.map.div.querySelector("."+n.CLASS+"-btn-pdf").addEventListener("click",n.createPdf.bind(n))})}n.orientation=n.div.querySelector("#print-design").value;n.format=n.div.querySelector("#print-size").value;n.currentFormat=n.CLASS+"-"+n.orientation+"-"+n.format;n._viewDiv.classList.remove(TC.Consts.classes.HIDDEN);n.map.div.classList.add(n.CLASS+"-printing");o(n.currentFormat)}));n.div.addEventListener("click",TC.EventTarget.listenerBySelector(`#${n.CLASS}-image-qr-${n.id}`,function(t){n.generateLink()}));n.div.addEventListener("click",TC.EventTarget.listenerBySelector("h2",function(t){n.registeredListeners||n.generateLink();n.registerListeners()}));return i};t.render=function(t){return TC.Control.prototype.renderData.call(this,{controlId:this.id},t)};t.createPdf=function(){var t=this,n=t.map.getControlsByClass(TC.control.LoadingIndicator)[0],i=n.addWait();TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){const a=t.map.div.querySelectorAll(".ol-viewport");for(var r=0,o=a.length;r<o;r++){const e=a[r];if(!e.parentElement.classList.contains("ol-overviewmap-map")){t.canvas=e.querySelector("canvas");break}}var l=s(t.orientation||e,t.format.toString().toUpperCase()||"A4"),c=l.layoutPDF;const p=function(e){var a=window.location.host+"_",r=t.div.querySelector("."+t.CLASS+"-title").value.trim();if(r)a+=r;else{a+=TC.Util.getFormattedDate((new Date).toString(),!0)}try{pdfMake.createPdf(e).download(a.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")}catch(e){t.map.toast(t.getLocaleString("print.error"),{type:TC.Consts.msgType.ERROR});TC.error(e.message+"  "+e.stack,TC.Consts.msgErrorMode.EMAIL)}n.removeWait(i)},h=function(e){TC.error(t.getLocaleString("print.error"));TC.error("No se ha podido generar el base64 correspondiente a la imagen: "+e,TC.Consts.msgErrorMode.EMAIL,"Error en la impresi\xf3n")},m=function(){var e=[],n=t.map.workLayers.filter(function(t){return t.type===TC.Consts.layerType.WMS&&t.getVisibility()}),i=[],a=function(t,e,n){if(e.isVisibleByScale(t.name)){var i,a;e.options&&e.options.params&&e.options.params.base64LegendSrc?a=e.options.params.base64LegendSrc:t.legend&&(i=t.legend.src);result.push({src:i,title:t.title,level:n,srcBase64:a})}},r=function(t,e,n,i){if(Array.isArray(t))for(var a=0;a<t.length;a++)r(t[a],e,n,i);else if(t&&t.hasOwnProperty("children")&&t.children.length>0){t.title&&t.name&&result.push({header:t.title,level:i});r(t.children,e,n,++i)}if(t&&t.hasOwnProperty("children")&&0==t.children.length){e.apply(this,[t,n,i]);i--}};n.forEach(function(t){result=[];var e=t.options.hideTree;t.tree=null;t.options.hideTree=!0;r(t.getTree(),a,t,0);t.options.hideTree=e;result.length>0&&i.push({title:t.title,layers:result})});return new Promise(function(t,n){Promise.all(function(){for(var t=[],e=0;e<i.length;e++)for(var n=i[e].layers,a=0;a<n.length;a++)!function(n,a){var r=i[e].layers[a],o=r.src||r.srcBase64;if(o){TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");t.push(new Promise(function(t,e){new TC.tool.Proxification(TC.proxify,{allowedMixedContent:!0}).fetchImage(o,{exportable:!0}).then(function(e){if(e.complete){var n=TC.Util.imgTagToDataUrl(e,"image/png");r.image={base64:n.base64,canvas:n.canvas}}else h(o);t()},function(t){h(o);e(t)})}))}}(0,a);return t}()).then(function(){i.map(function(t,e){return{groupIndex:e,height:t.layers.filter(function(t){return t.image&&t.image.canvas}).reduce(function(t,e,n,i){return t+i[n].image.canvas.height},0)}}).sort(function(t,e){return t.height>e.height?1:t.height<e.height?-1:0}).forEach(function(t,n){!function(t,n){var i=[[{text:t.title,colSpan:2,alignment:"left",fontSize:11,margin:[0,n>0?10:0,0,5]},{}]];const a=(i=i.concat(t.layers.filter(function(e){return e.hasOwnProperty("header")&&e.header.trim().toLowerCase()!==t.title.trim().toLowerCase()}).map(function(t){return[{text:t.header.trim(),colSpan:2,alignment:"left",margin:[10*t.level,0,0,3]},{}]}))).length;var r=null,o=null;t.layers.forEach(function(t,e){if(t.header){r=t;o&&(o=null)}else{o||(o=1);var n;r&&(n=i.map(function(t){return t[0].text}).indexOf(r.header)+o++);if(t.image){var a=t.image.canvas.width/2,l=a*t.image.canvas.height/t.image.canvas.width,c=[{text:t.title,fontSize:9,width:"auto",margin:[10*t.level,0,0,2]},{image:t.image.base64,width:a,height:l,margin:[10*t.level,0,0,2]}];n?i.splice(n,0,c):i.push(c)}else{c=[{text:t.title,fontSize:9,colSpan:2,margin:[10*t.level,0,0,2]},{}];n?i.splice(n,0,c):i.push(c)}}});e.push({layout:"noBorders",table:{dontBreakRows:!0,keepWithHeaderRows:1,headerRows:a,body:i}})}(i[t.groupIndex],n)});t(e)},function(){n([])})})},f=[function(){const e=function(){var t=d(l);delete t.image;t.text="";return t};return t.options.logo?TC.Util.imgToDataUrl(t.options.logo).then(function(t){const e=t.canvas,n=t.dataUrl;TC.Util.calculateAspectRatioFit(e.width,e.height,l.logoWidth,l.logoHeight);var i=d(l);i.width||(i.width=e.width/e.height*i.height);i.image=n;return i},function(){h(t.options.logo);return e()}):e()},function(){var e=function(t){return t.layoutPDF.content[0].columns[1]}(l);e.text=t.div.querySelector("."+t.CLASS+"-title").value.trim();return e},function(){const e=function(){var t=u(l);delete t.image;t.text="";t.width="auto";return t};var n=t.map.getControlsByClass(TC.control.ScaleBar)[0];if(n){var i=document.getElementsByClassName("ol-scale-line-inner"),a=i[0].getBoundingClientRect();if(a){var r=getComputedStyle(i[0],null),o=parseInt(r.getPropertyValue("border-left-width").replace("px",""))||0,c=parseInt(r.getPropertyValue("border-right-width").replace("px",""))||0,s=u(l);s.table={widths:[.75*((a.width>a.height?a.width:a.height)-o-c)],body:[[{border:[!0,!1,!0,!0],text:n.getText(),fontSize:10,alignment:"center"}]]};s.layout={paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}};return s}return e()}return e()},function(){const e=document.querySelector(`#${t.CLASS}-image-qr-${t.id}`);if(!e.disabled&&e.checked){const e=document.querySelector("."+t.CLASS+"-qrcode");e.innerHTML="";return t.makeQRCode(e,g.sideLength,g.sideLength).then(function(e){return e?TC.Util.addToCanvas(t.canvas,e,{x:t.canvas.width-g.sideLength,y:t.canvas.height-g.sideLength},{width:g.sideLength,height:g.sideLength}).then(function(t){return t}):t.canvas})}return t.canvas}];Promise.all(f.map(function(t){return t()})).then(function(n){n[2].table&&(l.layoutPDF.content[0].columns[1].width=l.layoutPDF.pageSize.width-(l.layoutPDF.pageMargins[0]+l.layoutPDF.pageMargins[2])-l.layoutPDF.content[0].columns[0].width-(l.layoutPDF.content[0].columns[2].table.widths[0]+2));var i=function(t){return t.layoutPDF.content[1].table.body[0][0]}(l),a=n[3]||t.canvas;i.image=a.toDataURL();if(function(){return this.map.workLayers.some(function(t){if(t.type===TC.Consts.layerType.WMS&&t.getVisibility()){for(var e=0;e<t.names.length;e++)if(t.isVisibleByScale(t.names[e]))return!0;return!1}return!1})}.call(t)&&2==c.content.length){const n=t.div.querySelector("."+t.CLASS+"-title").value.trim();c.content.push({pageBreak:"before",pageOrientation:t.options.legend&&t.options.legend.orientation||e,text:n.length>0?n:"",fontSize:14,margin:[0,20,0,10]});m().then(function(t){c.content=c.content.concat(t);p(c)})}else p(c)})})};t.manageMaxLengthExceed=function(t){const e=this.div.querySelector("."+this.CLASS+"-alert"),n=document.querySelector(`#${this.CLASS}-image-qr-${this.id}`);n.disabled=t.qr;n.checked?e.classList.toggle(TC.Consts.classes.HIDDEN,!t.qr):e.classList.add(TC.Consts.classes.HIDDEN)};t.generateLink=async function(){const t=this.div.querySelector(`.${this.CLASS}-div input[id|="${this.CLASS}-image-qr-${this.id}"]`),e=this.div.querySelector(`label[for="${t.id}"]`);t.disabled=!0;e.classList.add(TC.Consts.classes.LOADING);const n=await TC.control.MapInfo.prototype.generateLink.call(this);e.classList.remove(TC.Consts.classes.LOADING);return n}}();
//# sourceMappingURL=../maps/control/PrintMap.min.js.map