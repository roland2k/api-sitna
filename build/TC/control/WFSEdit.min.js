TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.control.WFSEdit=function(){const e=this;TC.control.SWCacheClient.apply(this,arguments);e._classSelector="."+e.CLASS;e.layer=null;e.callback=TC.Util.isFunction(arguments[2])?arguments[2]:e.options.callback?e.options.callback:null;e.layersEditData={};e.showsOriginalFeatures="boolean"==typeof e.options.showOriginalFeatures&&e.options.showOriginalFeatures;e.highlightsAdded=e.highlightsModified=e.highlightsRemoved="boolean"!=typeof e.options.highlightChanges||e.options.highlightChanges;TC.Util.isFunction(e.options.getBeforeEditLayerStyleFunction)||(e.getBeforeEditLayerStyleFunction=e.getBeforeEditLayerStyle);e.styles=e.options.styles||{point:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1,radius:6},line:{strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1},polygon:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1}}};TC.inherit(TC.control.WFSEdit,TC.control.SWCacheClient);!function(){var e=0;const t=function(e){const t=e.getLayerEditData();e._saveBtn.disabled=!(navigator.onLine&&t&&t.checkedOut)||e.isSyncing},n=function(e,t){e.div.querySelector(e._classSelector+"-view").classList.toggle(TC.Consts.classes.HIDDEN,!t||!e.layer||!(e.layer.type===TC.Consts.layerType.WFS||e.layer.type===TC.Consts.layerType.WMS));if(e.layer&&e.layer.wfsLayer){const t=TC.filter&&TC.filter.Bbox&&e.layer.wfsLayer.properties instanceof TC.filter.Bbox;e._recropBtn.classList.toggle(TC.Consts.classes.HIDDEN,!t)}e.div.querySelector(e._classSelector+"-edit").classList.toggle(TC.Consts.classes.HIDDEN,!t)},a=function(e){t(e);const n=e.getLayerEditData();e._discardBtn.disabled=!n||!n.checkedOut},r=function(e,t){if(e.layer){const n=e.getLayerEditData();if(void 0!==t){n.checkedOut=t;a(e)}else TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=s(e);localforage.keys().then(function(r){if(r){for(var o=!0,i=0,s=r.length;i<s;i++)if(0===r[i].indexOf(t)){o=!1;break}n.checkedOut=!o;a(e)}})})}else a(e)},o=function(e,t){return new Promise(function(n,a){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var r,o;switch(!0){case t instanceof TC.feature.Polygon:o=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:o=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:o=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:o=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:o=TC.Consts.geom.MULTIPOLYLINE}r={id:t.id||t.provId,attributes:t.data,type:o,geometry:t.geometry};localforage.setItem(e,r).then(function(){n({feature:t})}).catch(function(e){a({feature:t,error:e})})})})},i=function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t(e)}).catch(function(e){n(Error(e))})})})},s=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+function(e){let t=e.options.featureType[0];t.indexOf(":")<0&&(t=e.options.featureNS+":"+t);return t+"@"+e.options.url}(t||e.layer.wfsLayer||e.layer)},l=function(e,t){return s(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},c=function(e,t){return s(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},d=function(e,t){return s(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},u=function(e){return e.getPath?e.getPath().join(" \u2022 "):e.title||e.id},y=TC.control.WFSEdit.prototype;y.CLASS="tc-ctl-wfsedit";y.template={1:function(e,t,n,a,r){var o=e.lambda,i=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <option value="'+i(o(null!=t?s(t,"id"):t,t))+'">'+i(o(null!=t?s(t,"title"):t,t))+"</option>\r\n"},3:function(e,t,n,a,r){return" checked"},compiler:[8,">= 4.3.0"],main:function(e,t,n,a,r){var o,i=null!=t?t:e.nullContext||{},s=e.escapeExpression,l=e.lambda,c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+s(c(n,"i18n").call(i,"featureEditing",{name:"i18n",hash:{},data:r,loc:{start:{line:1,column:4},end:{line:1,column:29}}}))+'</h2>\r\n<div class="tc-ctl-wfsedit-layer">\r\n    <select class="tc-combo tc-ctl-wfsedit-layer-sel" disabled>\r\n        <option value="">'+s(c(n,"i18n").call(i,"selectLayerToEdit",{name:"i18n",hash:{},data:r,loc:{start:{line:4,column:25},end:{line:4,column:53}}}))+"</option>\r\n"+(null!=(o=c(n,"each").call(i,null!=t?c(t,"layers"):t,{name:"each",hash:{},fn:e.program(1,r,0),inverse:e.noop,data:r,loc:{start:{line:5,column:8},end:{line:7,column:17}}}))?o:"")+'    </select>\r\n</div>\r\n<div class="tc-ctl-wfsedit-view tc-hidden">\r\n    <table>\r\n        <tbody>\r\n            <tr>\r\n                <th><img class="tc-ctl-wfsedit-view-watch" /></th>\r\n                <td>'+s(c(n,"i18n").call(i,"featuresInEditedLayer",{name:"i18n",hash:{},data:r,loc:{start:{line:15,column:20},end:{line:15,column:52}}}))+'</td>\r\n            </tr>\r\n            <tr>\r\n                <th><img class="tc-ctl-wfsedit-view-original-watch" /></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-original-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(o=c(n,"if").call(i,null!=t?c(t,"showOriginalFeatures"):t,{name:"if",hash:{},fn:e.program(3,r,0),inverse:e.noop,data:r,loc:{start:{line:19,column:93},end:{line:19,column:136}}}))?o:"")+' /><label class="tc-ctl-wfsedit-view-original" for="tc-ctl-wfsedit-view-original-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"featuresAsBeforeEditing",{name:"i18n",hash:{},data:r,loc:{start:{line:19,column:235},end:{line:19,column:269}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-added-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-added" /><label for="tc-ctl-wfsedit-view-clr-added-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:r,loc:{start:{line:22,column:193},end:{line:22,column:222}}}))+'"><img class="tc-ctl-wfsedit-view-added-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-added-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(o=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,r,0),inverse:e.noop,data:r,loc:{start:{line:23,column:90},end:{line:23,column:129}}}))?o:"")+' /><label class="tc-ctl-wfsedit-view-added" for="tc-ctl-wfsedit-view-added-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedAdded",{name:"i18n",hash:{},data:r,loc:{start:{line:23,column:222},end:{line:23,column:246}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-modified-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-modified" /><label for="tc-ctl-wfsedit-view-clr-modified-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:r,loc:{start:{line:26,column:202},end:{line:26,column:231}}}))+'"><img class="tc-ctl-wfsedit-view-modified-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-modified-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(o=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,r,0),inverse:e.noop,data:r,loc:{start:{line:27,column:93},end:{line:27,column:132}}}))?o:"")+' /><label class="tc-ctl-wfsedit-view-modified" for="tc-ctl-wfsedit-view-modified-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedModified",{name:"i18n",hash:{},data:r,loc:{start:{line:27,column:231},end:{line:27,column:258}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-removed-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-removed" /><label for="tc-ctl-wfsedit-view-clr-removed-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:r,loc:{start:{line:30,column:199},end:{line:30,column:228}}}))+'"><img class="tc-ctl-wfsedit-view-removed-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-removed-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(o=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,r,0),inverse:e.noop,data:r,loc:{start:{line:31,column:92},end:{line:31,column:131}}}))?o:"")+' /><label class="tc-ctl-wfsedit-view-removed" for="tc-ctl-wfsedit-view-removed-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedRemoved",{name:"i18n",hash:{},data:r,loc:{start:{line:31,column:228},end:{line:31,column:254}}}))+'</label></td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n    <button class="tc-ctl-wfsedit-btn-crop tc-hidden" title="'+s(c(n,"i18n").call(i,"refreshLayerToCurrentExtent",{name:"i18n",hash:{},data:r,loc:{start:{line:35,column:61},end:{line:35,column:99}}}))+'">'+s(c(n,"i18n").call(i,"refreshLayerToCurrentExtent",{name:"i18n",hash:{},data:r,loc:{start:{line:35,column:101},end:{line:35,column:139}}}))+'</button>\r\n</div>\r\n<div class="tc-ctl-wfsedit-edit tc-hidden"></div>\r\n<div class="tc-ctl-wfsedit-save">\r\n    <button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-save" disabled title="'+s(c(n,"i18n").call(i,"syncChanges",{name:"i18n",hash:{},data:r,loc:{start:{line:39,column:85},end:{line:39,column:107}}}))+'">'+s(c(n,"i18n").call(i,"syncChanges",{name:"i18n",hash:{},data:r,loc:{start:{line:39,column:109},end:{line:39,column:131}}}))+'</button>\r\n    <button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-discard" disabled title="'+s(c(n,"i18n").call(i,"discardChanges",{name:"i18n",hash:{},data:r,loc:{start:{line:40,column:88},end:{line:40,column:113}}}))+'">'+s(c(n,"i18n").call(i,"discardChanges",{name:"i18n",hash:{},data:r,loc:{start:{line:40,column:115},end:{line:40,column:140}}}))+"</button>\r\n</div>\r\n"},useData:!0};y.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";y.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";y.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";y.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";y.register=function(e){const n=this;return new Promise(function(a,i){TC.control.SWCacheClient.prototype.register.call(n,e).then(function(){window.addEventListener("online",function(){t(n)});window.addEventListener("offline",function(){t(n)});n._editPromise=e.addControl("edit",{id:n.getUID(),div:n.div.querySelector(`.${n.CLASS}-edit`),styles:n.styles,downloadElevation:n.options.downloadElevation,snapping:n.options.snapping});n._editPromise.then(function(t){n.editControl=t;n.editControl.getAvailableFeaturesToImport=function(){const t=Object.getPrototypeOf(n.editControl).getAvailableFeaturesToImport.call(n.editControl),a=n.getLayerEditData();return t.filter(t=>{const n=e.getLayer(t.id);return n!==a.addedFeaturesLayer&&n!==a.modifiedFeaturesLayer&&n!==a.removedFeaturesLayer&&n!==a.beforeEditLayer})};n.editControl.importFeatures=function(e){const t=e||this.featuresToImport||[],a=n.getLayerEditData(),r=a.attributes?t.map(function(e){const t={};for(let n in a.attributes)t[n]=e.data[n];return new e.constructor(e.geometry,{geometryName:a.geometryName,data:t})}):e;Object.getPrototypeOf(n.editControl).importFeatures.call(n.editControl,r)};n.editControl.on(TC.Consts.event.DRAWEND,function(e){n.getLayerEditData().serializable&&n._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREMODIFY,function(e){const t=e.feature,a=t.provId||t.id,i=function(){r(n,!0)},s=function(){TC.error(n.getLocaleString("failedWhenSavingModifyOperationInSession"))},d=n.getLayerEditData();if(d.serializable){let e=d.addedFeaturesLayer.getFeatureById(a);if(e){e.setCoords(t.geometry);e.setData(t.getData());o(l(n)+a,t).then(i,s)}else{if(e=d.modifiedFeaturesLayer.getFeatureById(a)){e.setCoords(t.geometry);e.setData(t.getData())}else d.modifiedFeaturesLayer.addFeature(n._createAuxFeature(t));o(c(n)+a,t).then(i,s)}}}).on(TC.Consts.event.FEATUREADD,function(e){n.getLayerEditData().serializable&&n._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREREMOVE,function(e){n.getLayerEditData().serializable&&n._storeFeatureRemove(e.feature)});e.workLayers.forEach(e=>n.addLayer(e));e.on(TC.Consts.event.LAYERUPDATE,function(e){const t=e.layer;t.type!==TC.Consts.layerType.WFS||t.options.readOnly||n.getEditableLayer(t).then(e=>n.cacheLayer(e)).catch(e=>console.log("Layer not editable: "+t.id))}).on(TC.Consts.event.ZOOM,function(t){e.workLayers.filter(e=>e.wfsLayer).filter(e=>n.layer!==e).forEach(function(e){e.wfsLayer=null;n.getEditableLayer(e)})}).on(TC.Consts.event.LAYERADD,function(e){n.addLayer(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){const t=e.layer;if(n._removingLayer===t)return;(n.layer===t||t.wmsLayer&&n.layer===t.wmsLayer)&&n.setLayer(null);const a=n._layerSelect.querySelector(`option[value="${t.id}"]`);a&&a.parentElement.removeChild(a)}).on(TC.Consts.event.LAYERERROR,function(t){const a=t.layer;if(a.type===TC.Consts.layerType.WFS&&!a.options.readOnly){t.reason===TC.Consts.WFSErrors.MAX_NUM_FEATURES&&e.toast(n.getLocaleString("query.msgTooManyResults",{limit:t.data.limit}),{type:TC.Consts.msgType.WARNING});if(n.layer===a||n.layer&&n.layer.wfsLayer===a){delete n.layersEditData[n.layer.id];n.setLayer(null)}if(a.wmsLayer){e.removeLayer(a);a.wmsLayer.wfsLayer=null}}});a(n)});e.loaded(function(){n._layerSelect.disabled=!1;if(n.options.layer)n.setLayer(n.options.layer);else{const t=e.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===t.length?n.setLayer(t[0].id):n.setLayer(null)}n.showOriginalFeatures(n.showsOriginalFeatures)});e.ready(function(){e.getControlsByClass("TC.control.WorkLayerManager").forEach(function(t){t.addLayerTool({renderFn:function(t,a){const r=n.CLASS+"-btn-edit";let o=t.querySelector("button."+r);if(!o){const i=n.getLocaleString("featureEditing");(o=document.createElement("button")).innerHTML=i;o.setAttribute("title",i);o.classList.add(r);o.dataset.layerId=a;t.appendChild(o);const s=e.getLayer(a);if(s.type===TC.Consts.layerType.WMS){o.classList.add(TC.Consts.classes.LOADING);s.getWFSCapabilities().catch(()=>o.classList.add(TC.Consts.classes.HIDDEN)).finally(()=>o.classList.remove(TC.Consts.classes.LOADING))}}return o},updateEvents:[TC.Consts.event.BEFORELAYERUPDATE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.LAYERERROR,TC.Consts.event.CONTROLACTIVATE,TC.Consts.event.CONTROLDEACTIVATE],updateFn:function(t){const a=this,r=e.getLayer(a.dataset.layerId);setTimeout(()=>{a.classList.toggle(TC.Consts.classes.ACTIVE,n.layer===r)},500);a.disabled=!r||r.isRaster()&&1!==r.names.length},actionFn:function(){const t=e.getLayer(this.dataset.layerId),a=n.layer;this.classList.remove(TC.Consts.classes.ACTIVE);(t.names&&1===t.names.length||!t.isRaster())&&(t&&a!==t?n.setLayer(t).then(()=>{n.openEditSession()}):n.setLayer(null))}})})})})})};y.render=function(e){const t=this;var a=[];if(t.map)for(var r=0,o=t.map.workLayers.length;r<o;r++){var i=t.map.workLayers[r];i.type!==TC.Consts.layerType.WFS||i.options.stealth||a.push({id:i.id,title:i.title||i.id})}return t._set1stRenderPromise(TC.Control.prototype.renderData.call(t,{layers:a,showOriginalFeatures:t.showsOriginalFeatures,highlightChanges:t.highlightsAdded||t.highlightsModified||t.highlightsRemoved,controlId:t.id},function(){t._layerDiv=t.div.querySelector(t._classSelector+"-layer");t._layerSelect=t._layerDiv.querySelector(t._classSelector+"-layer-sel");t._layerSelect.addEventListener("change",function(e){n(t,!1);t.getEditableLayer(t._layerSelect.value).then(function(e){t.setLayer(e.wmsLayer||e).then(function(){t.layer&&t.openEditSession()})}).catch(()=>{t.setLayer(null)})});const a=t.div.querySelector(t._classSelector+"-view");t._editingWatch=a.querySelector(`.${t.CLASS}-view-watch`);t._beforeEditLayerWatch=a.querySelector(`.${t.CLASS}-view-original-watch`);t._addedWatch=a.querySelector(`.${t.CLASS}-view-added-watch`);t._modifiedWatch=a.querySelector(`.${t.CLASS}-view-modified-watch`);t._removedWatch=a.querySelector(`.${t.CLASS}-view-removed-watch`);a.querySelector(`#${t.CLASS}-view-original-cb-${t.id}`).addEventListener("change",function(e){t.showOriginalFeatures(e.target.checked)});a.querySelector(`#${t.CLASS}-view-added-cb-${t.id}`).addEventListener("change",function(e){t.highlightAdded(e.target.checked)});a.querySelector(`#${t.CLASS}-view-modified-cb-${t.id}`).addEventListener("change",function(e){t.highlightModified(e.target.checked)});a.querySelector(`#${t.CLASS}-view-removed-cb-${t.id}`).addEventListener("change",function(e){t.highlightRemoved(e.target.checked)});const r=new RegExp(`${t.CLASS}-view-clr-(.+)-${t.id}`),o=function(e){const n=this.parentElement.querySelector("input[type=color]"),a=t.getLayerEditData(),o=a[n.id.match(r)[1]+"FeaturesLayer"];switch(a.geometryType){case TC.Consts.geom.POINT:n.value=o.styles.point.strokeColor;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:n.value=o.styles.line.strokeColor;break;default:n.value=o.styles.polygon.strokeColor}n.click()},i=function(e){const n=e.target,a=t.getLayerEditData(),o=n.id.match(r)[1],i=a[o+"FeaturesLayer"],s=a[o+"CustomColor"]=n.value;switch(a.geometryType){case TC.Consts.geom.POINT:i.styles.point.strokeColor=s;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:i.styles.line.strokeColor=s;break;default:i.styles.polygon.strokeColor=s;i.styles.polygon.fillColor=s}i.setStyles(i.styles);t[`_${o}Watch`].src=f(i,a.geometryType)},s=`${t.CLASS}-view-clr-added-${t.id}`;a.querySelector(`label[for="${s}"]`).addEventListener(TC.Consts.event.CLICK,o,{passive:!0});document.getElementById(s).addEventListener("change",i);const l=`${t.CLASS}-view-clr-modified-${t.id}`;a.querySelector(`label[for="${l}"]`).addEventListener(TC.Consts.event.CLICK,o,{passive:!0});document.getElementById(l).addEventListener("change",i);const c=`${t.CLASS}-view-clr-removed-${t.id}`;a.querySelector(`label[for="${c}"]`).addEventListener(TC.Consts.event.CLICK,o,{passive:!0});document.getElementById(c).addEventListener("change",i);t._saveBtn=t.div.querySelector(t._classSelector+"-btn-save");t._saveBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.applyEdits.confirm",{layerTitle:u(t.layer)}),function(){t.applyEdits()})},{passive:!0});t._discardBtn=t.div.querySelector(t._classSelector+"-btn-discard");t._discardBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.discardEdits.confirm",{layerTitle:u(t.layer)}),function(){t.discardEdits()})},{passive:!0});t._recropBtn=t.div.querySelector(`.${t.CLASS}-view button.${t.CLASS}-btn-crop`);t._recropBtn.addEventListener(TC.Consts.event.CLICK,function(){if(t.layer){const e=()=>{if(t.layer&&t.layer.wfsLayer&&TC.filter&&TC.filter.Bbox&&t.layer.wfsLayer.properties instanceof TC.filter.Bbox){const e=t.getLayerEditData();t.layer.wfsLayer.properties=new TC.filter.Bbox(null,t.map.getExtent(),t.map.getCRS());t.layer.wfsLayer.refresh();if(e.beforeEditLayer){e.beforeEditLayer.properties=t.layer.wfsLayer.properties;e.beforeEditLayer.refresh()}}},n=t.getLayerEditData(),a=n.addedFeaturesLayer.features.concat(n.modifiedFeaturesLayer.features,n.removedFeaturesLayer.features);a.length?TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){let n=!1;const r=t.map.getExtent(),o=[[r[0],r[1]],[r[0],r[3]],[r[2],r[3]],[r[2],r[1]]];for(var i=0,s=a.length;i<s;i++)if(!TC.Geometry.intersects(a[i].geometry,o)){n=!0;break}n?TC.confirm(t.getLocaleString("refreshLayerToCurrentExtent.confirm"),function(){e()}):e()}):e()}},{passive:!0});TC.Util.isFunction(e)&&e()}))};y.addLayer=function(e){const t=this;e.isBase||e.options.readOnly||e.options.stealth||t.getEditableLayer(e).then(function(n){!e.isRaster()&&n.wmsLayer||function(e){const n=document.createElement("option");n.setAttribute("value",e.id);n.innerHTML=u(e);t.renderPromise().then(function(){t._layerSelect.appendChild(n)})}(e)}).catch(t=>console.log(`Layer ${e.id} not editable. Reason: ${t.message}`))};y.setLayer=function(e){const t=this;return new Promise(function(a,r){const o=t.map,i=t.div.querySelector(t._classSelector+"-layer-sel");e=o.getLayer(e);const s=o.workLayers.filter(t=>t===e)[0],l=function(){if(s)t.getEditableLayer(s).then(function(e){const n=function(){t.layer=s;t._enableEditSerialization(s).then(function(){t.getEditControl().then(n=>{i.value=t.layer.id;n.setMode(null);n.setLayer(e);a(t.layer)})}).catch(e=>{t.setLayer(null);r(e)})};o.workLayers.indexOf(e)>=0?n():o.addLayer(e).then(n)}).catch(()=>{t.setLayer(null);a(null)});else{t.layer&&t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.getEditControl().then(e=>{n(t,!1);t.closeEditSession().then(()=>{i.value="";e.setMode(null);e.setLayer(null);t.layer=null;a(null)}).finally(()=>{delete t._removingLayer})})}};if(null!==e&&t.layer){t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.closeEditSession().then(()=>{s&&l()})}else l()})};y._storeFeatureAdd=function(t){const n=this;t.provId="NewFeature."+e++;const a=n.getLayerEditData(),i=n._createAuxFeature(t);a.addedFeaturesLayer.addFeature(i);o(l(n)+t.provId,i).then(function(){r(n,!0)},function(){TC.error(n.getLocaleString("failedWhenSavingAddOperationInSession"))})};y._storeFeatureRemove=function(e){const t=this;var n=e.provId||e.id,a=function(){r(t)},s=function(){TC.error(t.getLocaleString("failedWhenSavingRemoveOperationInSession"))};const u=t.getLayerEditData();if(u.serializable){let r=u.addedFeaturesLayer.getFeatureById(n);if(r){u.addedFeaturesLayer.removeFeature(r);i(l(t)+n).then(a,s)}else{var y=d(t);if(r=u.modifiedFeaturesLayer.getFeatureById(n)){u.modifiedFeaturesLayer.removeFeature(r);u.removedFeaturesLayer.addFeature(t._createAuxFeature(e));i(c(t)+n).then(function(){a();o(y+n,e).then(a,s)},s)}else if(!(r=u.removedFeaturesLayer.getFeatureById(n))){u.removedFeaturesLayer.addFeature(t._createAuxFeature(e));o(y+n,e).then(a,s)}}}};y._createAuxFeature=function(e){const t=e.provId||e.id,n=this.getLayerEditData(),a=new e.constructor(e.geometry,{geometryName:n.geometryName,data:e.getData()});a.setStyle(null);a.setId(t);return a};y.getEditControl=function(){const e=this;return e._editPromise||new Promise(function(t,n){e.renderPromise().then(()=>t(e.editControl))})};y.cacheLayer=function(e){const t=this;return new Promise(function(n,a){t.getServiceWorker().then(function(){if(navigator.onLine){const r=e.wrap.getGetFeatureUrl(),o=e.getDescribeFeatureTypeUrl();r&&o?t.createCache(s(t,e),{urlList:[r,o]}).then(()=>n(),e=>a(e)):n()}else n()}).catch(e=>a(e))})};y.getFeatureType=function(e){const t=this;return new Promise(function(n,a){e=e||t.layer;const r=map.getLoadingIndicator(),o=r&&r.addWait();e.describeFeatureType().then(function(a){t.getEditControl().then(function(r){const o=t.getLayerEditData(e);o.attributes={};for(var i in a){const e=a[i],t=r.getGeometryType(e.type);if(t){o.geometryName=e.name;o.geometryType="boolean"==typeof t?null:t}else o.attributes[i]=e}for(var i in o.attributes){const e=o.attributes[i];e.type=e.type.substr(e.type.indexOf(":")+1)}n(o)})}).catch(function(e){a(e)}).finally(()=>r&&r.removeWait(o))})};y._addAuxLayersToMap=function(e){const t=this;return new Promise(function(n,a){e=e||t.layer;const r=t.getLayerEditData(e),o=r.beforeEditLayer;if(o){const a=r.addedFeaturesLayer,i=r.modifiedFeaturesLayer,s=r.removedFeaturesLayer;Promise.all([map.addLayer(o),map.addLayer(a),map.addLayer(i),map.addLayer(s)]).then(function(){t.getEditableLayer(e).then(function(e){let l=map.layers.indexOf(e);o.setVisibility(t.showsOriginalFeatures);a.setVisibility(t.highlightsAdded);i.setVisibility(t.highlightsModified);s.setVisibility(t.highlightsRemoved);t.map.insertLayer(o,++l,function(){const c=l+1;map.insertLayer(a,c);map.insertLayer(i,c);map.insertLayer(s,c);o.setStyles(t.getBeforeEditLayerStyle(e));a.setStyles(t.getAddedFeaturesLayerStyle(e));i.setStyles(t.getModifiedFeaturesLayerStyle(e));s.setStyles(t.getRemovedFeaturesLayerStyle(e));t._editingWatch.src=f(e,r.geometryType);t._beforeEditLayerWatch.src=f(o,r.geometryType);t._addedWatch.src=f(a,r.geometryType);t._modifiedWatch.src=f(i,r.geometryType);t._removedWatch.src=f(s,r.geometryType);n()})})})}else a(new Error(`No auxiliary layers for ${e.id}`))})};y.openEditSession=function(){const e=this;return e.layer?new Promise(function(t,a){e.getFeatureType().then(function(o){e.getEditControl().then(function(i){e.getEditableLayer(e.layer).then(function(s){i.setLayer(s);switch(o.geometryType){case TC.Consts.geom.MULTIPOLYLINE:case TC.Consts.geom.MULTIPOLYGON:i.setComplexGeometry(!0);break;default:i.setComplexGeometry(!1)}i.activate();n(e,!0);r(e);const l=[TC.control.Edit.mode.MODIFY,TC.control.Edit.mode.OTHER];switch(o.geometryType){case TC.Consts.geom.POINT:l.push(TC.control.Edit.mode.ADDPOINT);break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:l.push(TC.control.Edit.mode.ADDLINE);break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:l.push(TC.control.Edit.mode.ADDPOLYGON)}i.constrainModes(l);i.setMode(TC.control.Edit.mode.MODIFY);e._addAuxLayersToMap().then(()=>t()).catch(e=>a(e))})})}).catch(function(r){e.layer&&e.layer.type===TC.Consts.layerType.VECTOR?e.getEditControl().then(function(a){a.activate();n(e,!0);a.setMode(TC.control.Edit.mode.MODIFY);t()}):a(r)})}):Promise.reject(Error("No layer set for editing"))};y.closeEditSession=function(){const e=this;return new Promise(function(t,n){e.renderPromise().then(function(){r(e,!1);e.getEditControl().then(e=>e.deactivate());const n=e.getLayerEditData();if(n&&n.beforeEditLayer){e._editingWatch.src=TC.Consts.BLANK_IMAGE;e._beforeEditLayerWatch.src=TC.Consts.BLANK_IMAGE;e._addedWatch.src=TC.Consts.BLANK_IMAGE;e._modifiedWatch.src=TC.Consts.BLANK_IMAGE;e._removedWatch.src=TC.Consts.BLANK_IMAGE;const a=e.layer;e.getEditableLayer(e.layer).then(function(e){const r=[],o=function(e){map.workLayers.indexOf(e)>=0&&r.push(map.removeLayer(e))};o(n.beforeEditLayer);o(n.beforeEditLayer);o(n.addedFeaturesLayer);o(n.modifiedFeaturesLayer);o(n.removedFeaturesLayer);if(a!==e){a.wfsLayer=null;o(e)}Promise.all(r).then(()=>t())})}else t()})})};y.getEditableLayer=function(e){const t=this;return new Promise(function(n,a){const r=`Layer ${e.id} not editable`;(e=t.map?map.getLayer(e):e)?e.type!==TC.Consts.layerType.WFS||!e.wmsLayer&&(e.options.stealth||e.options.readOnly)?e.type===TC.Consts.layerType.WMS?e.wfsLayer?e.wfsLayer.getCapabilitiesPromise().then(()=>n(e.wfsLayer)):e.getWFSCapabilities().then(function(o){const i=e.getDisgregatedLayerNames(),s=i[0],l=s.indexOf(":"),c=s.substring(l+1);1!==i.length||o.FeatureTypes.hasOwnProperty(c)?TC.loadJS(!TC.layer.Vector,TC.apiLocation+"TC/layer/Vector",async function(){const a={id:t.getUID(),type:TC.Consts.layerType.WFS,url:await e.getWFSURL(),properties:t.map?new TC.filter.Bbox(null,map.getExtent(),map.getCRS()):null,outputFormat:TC.Consts.format.JSON,title:`${e.getPath().join(" \u2022 ")} - ${t.getLocaleString("featureEditing")}`,geometryName:"geom",featureType:[s],featureNS:"Edicion",styles:t.styles,stealth:!0};e.wfsLayer=new TC.layer.Vector(a);e.wfsLayer.wmsLayer=e;n(e.wfsLayer)}):a(new Error(r))}).catch(e=>a(e)):e.type===TC.Consts.layerType.VECTOR?n(e):a(new Error(r)):e.getCapabilitiesPromise().then(()=>n(e)):a(new Error("No layer to edit"))})};y.isLayerEdited=function(e){const t=this;return new Promise(function(n,a){const r=s(t,e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(e){n(!!e&&e.some(e=>0===e.indexOf(r)))})})})};y.getLayerEditData=function(e){const t=e||this.layer;return t?this.layersEditData[t.id]=this.layersEditData[t.id]||{checkedOut:!1}:null};const f=function(e,t){switch(t){case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return TC.Util.getLegendImageFromStyle(e.styles.point,{geometryType:TC.Consts.geom.POINT});case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return TC.Util.getLegendImageFromStyle(e.styles.line,{geometryType:TC.Consts.geom.POLYLINE});default:return TC.Util.getLegendImageFromStyle(e.styles.polygon,{geometryType:TC.Consts.geom.POLYGON})}};y._enableEditSerialization=function(t){const n=this;return new Promise(function(a,r){n.getEditableLayer(t).then(function(r){const o=function(){const o=n.getLayerEditData(t),i=t.getPath?t.getPath().join(" \u2022 "):t.title||t.id;var u=o.beforeEditLayer;u||(u=o.beforeEditLayer=new TC.layer.Vector(TC.Util.extend({},r.options,{id:n.getUID(),title:`${i} - ${n.getLocaleString("dataBeforeEdits")}`,readOnly:!0,owner:n,stealth:!0})));var y=o.addedFeaturesLayer;let f=!0;if(!y){f=!1;y=o.addedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("addedFeatures")}`,owner:n,stealth:!0,zIndex:2})}var g=o.modifiedFeaturesLayer;let C=!0;if(!g){C=!1;g=o.modifiedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("modifiedFeatures")}`,owner:n,stealth:!0,zIndex:2})}var h=o.removedFeaturesLayer;let m=!0;if(!h){m=!1;h=o.removedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("removedFeatures")}`,owner:n,stealth:!0,zIndex:2})}const L=[];if(f&&C&&m){h.features.forEach(function(e){const t=r.getFeatureById(e.id);t&&r.removeFeature(t)});g.features.forEach(function(e){const t=r.getFeatureById(e.id);if(t){t.setCoords(e.geometry);t.setData(e.getData())}});y.features.forEach(function(e){r.getFeatureById(e.id)||L.push(r.addFeature(n._createAuxFeature(e)))});Promise.all(L).then(()=>{o.serializable=!0;a(r)})}else{const t=s(n,r),i=l(n,r),u=c(n,r),f=d(n,r);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){n&&n.filter(e=>0===e.indexOf(t)).forEach(function(t){L.push(new Promise(function(n,a){(function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(n){t({key:e,feature:n})}).catch(function(e){n(e)})})})})(t).then(function(t){var a,o=t.key;if(0===o.indexOf(f)){a=o.substr(f.length);const e=r.getFeatureById(a);r.removeFeature(e);h.addFeature(e).then(()=>n(e))}else if(0===o.indexOf(u)){a=o.substr(u.length);const e=r.getFeatureById(a);if(e){e.setCoords(t.feature.geometry);e.setData(t.feature.attributes);const a=e.clone();a.setId(e.id);g.addFeature(a).then(()=>n(e))}else n(e)}else if(0===o.indexOf(i)){a=o.substr(i.length);var s,l=parseInt(a.substr(a.lastIndexOf(".")+1));e=Math.max(e,l+1);switch(t.feature.type){case TC.Consts.geom.POINT:s=r.addPoint(t.feature.geometry);break;case TC.Consts.geom.POLYLINE:s=r.addPolyline(t.feature.geometry);break;case TC.Consts.geom.POLYGON:s=r.addPolygon(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:s=r.addMultiPolyline(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:s=r.addMultiPolygon(t.feature.geometry)}s.then(function(e){e.provId=a;e.setData(t.feature.attributes);const r=e.clone();r.setStyle(null);r.setId(e.provId);y.addFeature(r).then(()=>n(r))})}})}))});Promise.all(L).then(()=>{o.serializable=!0;a(r)})})})}};if(r.type===TC.Consts.layerType.WFS)if(r.state===TC.Layer.state.IDLE)o();else{const e=function(t){if(t.layer===r){o();n.map.off(TC.Consts.event.LAYERUPDATE,e)}};n.map.on(TC.Consts.event.LAYERUPDATE,e)}else a(r)})})};y.applyEdits=function(){const e=this;if(e.layer){const n=e.getLayerEditData();if(n.serializable){e.isSyncing=!0;t(e);const a=e.map.getLoadingIndicator(),r=a&&a.addWait(),o=n.modifiedFeaturesLayer.features.map(function(e){const t=new e.constructor(e.geometry,{geometryName:n.geometryName}),a=n.beforeEditLayer.features.filter(t=>t.id===e.id)[0];let r;if(a){r={};for(var o in e.data)if("id"!==o){const t=a.data[o],n=e.data[o];t!==n&&(r[o]=n)}}else r=e.data;t.setData(r);t.setId(e.id);return t});e.getEditableLayer(e.layer).then(function(i){i.applyEdits(n.addedFeaturesLayer.features,o,n.removedFeaturesLayer.features).then(function(t){if(t.transactionSummary.totalInserted!==n.addedFeaturesLayer.features.length||t.transactionSummary.totalUpdated!==o.length||t.transactionSummary.totalDeleted!==n.removedFeaturesLayer.features.length){TC.error("Error de concordancia de n\xfamero de entidades en transacci\xf3n");console.log(t,n.addedFeaturesLayer,o,n.removedFeaturesLayer);throw new Error(`Error en transacci\xf3n: Insertados ${t.transactionSummary.totalInserted}, hay ${n.addedFeaturesLayer.features.length} en capa`)}e.layer.type===TC.Consts.layerType.WMS&&e.layer.refresh();e.deleteCache(s(e)).then(function(){e.cacheLayer(i).then(function(){e.isSyncing=!1;a&&a.removeWait(r);e.discardEdits();e.map.toast(e.getLocaleString("changesSuccessfullySyncedWithServer"),{type:TC.Consts.msgType.INFO})})})}).catch(function(n){e.isSyncing=!1;t(e);TC.error(e.getLocaleString("errorSyncingChanges",{code:n.code,reason:n.reason}),{type:TC.Consts.msgType.ERROR})})})}}};y.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=s(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){if(n){for(var a=0,o=n.length;a<o;a++){var i=n[a];0===i.indexOf(t)&&localforage.removeItem(i)}if(e.layer){const t=e.getLayerEditData();if(t.serializable){t.addedFeaturesLayer.clearFeatures();t.modifiedFeaturesLayer.clearFeatures();t.removedFeaturesLayer.clearFeatures();e.editControl.setSelectedFeatures([]);e.editControl.modifyControl.closeAttributes();e.getEditableLayer(e.layer).then(e=>e.refresh())}}r(e,!1)}});e.editControl.setMode(null)})};y.showOriginalFeatures=function(e){this.showsOriginalFeatures=e;const t=this.getLayerEditData();t&&t.beforeEditLayer.setVisibility(e)};y.highlightAdded=function(e){this.highlightsAdded=e;const t=this.getLayerEditData();t&&t.addedFeaturesLayer&&t.addedFeaturesLayer.setVisibility(e)};y.highlightModified=function(e){this.highlightsModified=e;const t=this.getLayerEditData();t&&t.modifiedFeaturesLayer&&t.modifiedFeaturesLayer.setVisibility(e)};y.highlightRemoved=function(e){this.highlightsRemoved=e;const t=this.getLayerEditData();t&&t.removedFeaturesLayer&&t.removedFeaturesLayer.setVisibility(e)};const g=function(e,t){const n={};switch(e.getLayerEditData(t.wmsLayer||t).geometryType){case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:n.polygon=t.map.options.styles.polygon;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:n.line=t.map.options.styles.line;break;default:n.point=t.map.options.styles.point}return n};y.getBeforeEditLayerStyle=function(e){const t=function(t){const n=e.wrap.getRGBA(t);for(var a=0;a<3;a++)n[a]=255-n[a];return"#"+(65536*n[0]+256*n[1]+n[2]).toString(16).padStart(6,"0")},n=[1,3],a=TC.Util.extend(!0,{},e.options.styles||g(this,e));if(a.point){a.point.strokeColor=t(a.point.strokeColor);a.point.lineDash=n}if(a.line){a.line.strokeColor=t(a.line.strokeColor);a.line.lineDash=n}if(a.polygon){a.polygon.strokeColor=t(a.polygon.strokeColor);a.polygon.lineDash=n}return a};const C=function(e,t,n){const a=TC.Util.extend(!0,{},t.options.styles||g(e,t));if(a.point){a.point.strokeColor=n;a.point.fillColor=n}a.line&&(a.line.strokeColor=n);if(a.polygon){a.polygon.strokeColor=n;a.polygon.fillColor=n}return a};y.getAddedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.addedCustomColor||"#00ff00")};y.getModifiedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.modifiedCustomColor||"#ff7f00")};y.getRemovedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.removedCustomColor||"#ff0000")}}();
//# sourceMappingURL=../maps/control/WFSEdit.min.js.map