TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.control.WFSEdit=function(){const e=this;TC.control.SWCacheClient.apply(this,arguments);e.serviceWorkerIsRequired=e.options.serviceWorkerIsRequired||!1;e._classSelector="."+e.CLASS;e.layer=null;e.callback=TC.Util.isFunction(arguments[2])?arguments[2]:e.options.callback?e.options.callback:null;e.layersEditData={};e.showsOriginalFeatures="boolean"==typeof e.options.showOriginalFeatures&&e.options.showOriginalFeatures;e.highlightsAdded=e.highlightsModified=e.highlightsRemoved="boolean"!=typeof e.options.highlightChanges||e.options.highlightChanges;TC.Util.isFunction(e.options.getBeforeEditLayerStyleFunction)||(e.getBeforeEditLayerStyleFunction=e.getBeforeEditLayerStyle);e.styles=e.options.styles||{point:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1,radius:6},line:{strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1},polygon:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1}}};TC.inherit(TC.control.WFSEdit,TC.control.SWCacheClient);!function(){var e=0;const t=function(e){const t=e.getLayerEditData();e._saveBtn.disabled=!(navigator.onLine&&t&&t.checkedOut)||e.isSyncing},n=function(e,t){e.div.querySelector(e._classSelector+"-view").classList.toggle(TC.Consts.classes.HIDDEN,!t||!e.layer||!(e.layer.type===TC.Consts.layerType.WFS||e.layer.type===TC.Consts.layerType.WMS));if(e.layer&&e.layer.wfsLayer){const t=TC.filter&&TC.filter.Bbox&&e.layer.wfsLayer.properties instanceof TC.filter.Bbox;e._recropBtn.classList.toggle(TC.Consts.classes.HIDDEN,!t)}e.div.querySelector(e._classSelector+"-edit").classList.toggle(TC.Consts.classes.HIDDEN,!t)},r=function(e){t(e);const n=e.getLayerEditData();e._discardBtn.disabled=!n||!n.checkedOut},o=function(e,t){if(e.layer){const n=e.getLayerEditData();if(void 0!==t){n.checkedOut=t;r(e)}else TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=s(e);localforage.keys().then(function(o){if(o){for(var a=!0,i=0,s=o.length;i<s;i++)if(0===o[i].indexOf(t)){a=!1;break}n.checkedOut=!a;r(e)}})})}else r(e)},a=function(e,t){return new Promise(function(n,r){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var o,a;switch(!0){case t instanceof TC.feature.Polygon:a=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:a=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:a=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:a=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:a=TC.Consts.geom.MULTIPOLYLINE}o={id:t.id||t.provId,attributes:t.data,type:a,geometry:t.geometry};localforage.setItem(e,o).then(function(){n({feature:t})}).catch(function(e){r({feature:t,error:e})})})})},i=function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t(e)}).catch(function(e){n(Error(e))})})})},s=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+function(e){let t=e.options.featureType[0];t.indexOf(":")<0&&(t=e.options.featureNS+":"+t);return t+"@"+e.options.url}(t||e.layer.wfsLayer||e.layer)},l=function(e,t){return s(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},c=function(e,t){return s(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},d=function(e,t){return s(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},u=function(e){return e.getPath?e.getPath().join(" \u2022 "):e.title||e.id},y=TC.control.WFSEdit.prototype;y.CLASS="tc-ctl-wfsedit";y.template={1:function(e,t,n,r,o){var a=e.lambda,i=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <option value="'+i(a(null!=t?s(t,"id"):t,t))+'">'+i(a(null!=t?s(t,"title"):t,t))+"</option>\r\n"},3:function(e,t,n,r,o){return" checked"},compiler:[8,">= 4.3.0"],main:function(e,t,n,r,o){var a,i=null!=t?t:e.nullContext||{},s=e.escapeExpression,l=e.lambda,c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+s(c(n,"i18n").call(i,"featureEditing",{name:"i18n",hash:{},data:o,loc:{start:{line:1,column:4},end:{line:1,column:29}}}))+'</h2>\r\n<div class="tc-ctl-wfsedit-layer">\r\n    <select class="tc-combo tc-ctl-wfsedit-layer-sel" disabled>\r\n        <option value="">'+s(c(n,"i18n").call(i,"selectLayerToEdit",{name:"i18n",hash:{},data:o,loc:{start:{line:4,column:25},end:{line:4,column:53}}}))+"</option>\r\n"+(null!=(a=c(n,"each").call(i,null!=t?c(t,"layers"):t,{name:"each",hash:{},fn:e.program(1,o,0),inverse:e.noop,data:o,loc:{start:{line:5,column:8},end:{line:7,column:17}}}))?a:"")+'    </select>\r\n</div>\r\n<div class="tc-ctl-wfsedit-view tc-hidden">\r\n    <table>\r\n        <tbody>\r\n            <tr>\r\n                <th><img class="tc-ctl-wfsedit-view-watch" /></th>\r\n                <td>'+s(c(n,"i18n").call(i,"featuresInEditedLayer",{name:"i18n",hash:{},data:o,loc:{start:{line:15,column:20},end:{line:15,column:52}}}))+'</td>\r\n            </tr>\r\n            <tr>\r\n                <th><img class="tc-ctl-wfsedit-view-original-watch" /></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-original-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(a=c(n,"if").call(i,null!=t?c(t,"showOriginalFeatures"):t,{name:"if",hash:{},fn:e.program(3,o,0),inverse:e.noop,data:o,loc:{start:{line:19,column:93},end:{line:19,column:136}}}))?a:"")+' /><label class="tc-ctl-wfsedit-view-original" for="tc-ctl-wfsedit-view-original-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"featuresAsBeforeEditing",{name:"i18n",hash:{},data:o,loc:{start:{line:19,column:235},end:{line:19,column:269}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-added-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-added" /><label for="tc-ctl-wfsedit-view-clr-added-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:o,loc:{start:{line:22,column:193},end:{line:22,column:222}}}))+'"><img class="tc-ctl-wfsedit-view-added-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-added-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(a=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,o,0),inverse:e.noop,data:o,loc:{start:{line:23,column:90},end:{line:23,column:129}}}))?a:"")+' /><label class="tc-ctl-wfsedit-view-added" for="tc-ctl-wfsedit-view-added-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedAdded",{name:"i18n",hash:{},data:o,loc:{start:{line:23,column:222},end:{line:23,column:246}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-modified-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-modified" /><label for="tc-ctl-wfsedit-view-clr-modified-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:o,loc:{start:{line:26,column:202},end:{line:26,column:231}}}))+'"><img class="tc-ctl-wfsedit-view-modified-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-modified-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(a=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,o,0),inverse:e.noop,data:o,loc:{start:{line:27,column:93},end:{line:27,column:132}}}))?a:"")+' /><label class="tc-ctl-wfsedit-view-modified" for="tc-ctl-wfsedit-view-modified-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedModified",{name:"i18n",hash:{},data:o,loc:{start:{line:27,column:231},end:{line:27,column:258}}}))+'</label></td>\r\n            </tr>\r\n            <tr>\r\n                <th><input type="color" id="tc-ctl-wfsedit-view-clr-removed-'+s(l(null!=t?c(t,"controlId"):t,t))+'" class="tc-clt-wfsedit-view-clr-removed" /><label for="tc-ctl-wfsedit-view-clr-removed-'+s(l(null!=t?c(t,"controlId"):t,t))+'" title="'+s(c(n,"i18n").call(i,"clickToChangeColor",{name:"i18n",hash:{},data:o,loc:{start:{line:30,column:199},end:{line:30,column:228}}}))+'"><img class="tc-ctl-wfsedit-view-removed-watch" /></label></th>\r\n                <td><input type="checkbox" id="tc-ctl-wfsedit-view-removed-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'"'+(null!=(a=c(n,"if").call(i,null!=t?c(t,"highlightChanges"):t,{name:"if",hash:{},fn:e.program(3,o,0),inverse:e.noop,data:o,loc:{start:{line:31,column:92},end:{line:31,column:131}}}))?a:"")+' /><label class="tc-ctl-wfsedit-view-removed" for="tc-ctl-wfsedit-view-removed-cb-'+s(l(null!=t?c(t,"controlId"):t,t))+'">'+s(c(n,"i18n").call(i,"unsyncedRemoved",{name:"i18n",hash:{},data:o,loc:{start:{line:31,column:228},end:{line:31,column:254}}}))+'</label></td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n    <button class="tc-ctl-wfsedit-btn-crop tc-hidden" title="'+s(c(n,"i18n").call(i,"refreshLayerToCurrentExtent",{name:"i18n",hash:{},data:o,loc:{start:{line:35,column:61},end:{line:35,column:99}}}))+'">'+s(c(n,"i18n").call(i,"refreshLayerToCurrentExtent",{name:"i18n",hash:{},data:o,loc:{start:{line:35,column:101},end:{line:35,column:139}}}))+'</button>\r\n</div>\r\n<div class="tc-ctl-wfsedit-edit tc-hidden"></div>\r\n<div class="tc-ctl-wfsedit-save">\r\n    <button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-save" disabled title="'+s(c(n,"i18n").call(i,"syncChanges",{name:"i18n",hash:{},data:o,loc:{start:{line:39,column:85},end:{line:39,column:107}}}))+'">'+s(c(n,"i18n").call(i,"syncChanges",{name:"i18n",hash:{},data:o,loc:{start:{line:39,column:109},end:{line:39,column:131}}}))+'</button>\r\n    <button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-discard" disabled title="'+s(c(n,"i18n").call(i,"discardChanges",{name:"i18n",hash:{},data:o,loc:{start:{line:40,column:88},end:{line:40,column:113}}}))+'">'+s(c(n,"i18n").call(i,"discardChanges",{name:"i18n",hash:{},data:o,loc:{start:{line:40,column:115},end:{line:40,column:140}}}))+"</button>\r\n</div>\r\n"},useData:!0};y.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";y.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";y.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";y.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";y.register=function(e){const n=this;return new Promise(function(r,i){TC.control.SWCacheClient.prototype.register.call(n,e).then(function(){window.addEventListener("online",function(){t(n)});window.addEventListener("offline",function(){t(n)});n._editPromise=e.addControl("edit",{id:n.getUID(),div:n.div.querySelector(`.${n.CLASS}-edit`),styles:n.styles,downloadElevation:n.options.downloadElevation,snapping:n.options.snapping});n._editPromise.then(function(t){n.editControl=t;n.editControl.getAvailableFeaturesToImport=function(){const t=Object.getPrototypeOf(n.editControl).getAvailableFeaturesToImport.call(n.editControl),r=n.getLayerEditData();return t.filter(t=>{const n=e.getLayer(t.id);return n!==r.addedFeaturesLayer&&n!==r.modifiedFeaturesLayer&&n!==r.removedFeaturesLayer&&n!==r.beforeEditLayer})};n.editControl.importFeatures=function(e){const t=e||this.featuresToImport||[],r=n.getLayerEditData(),o=r.attributes?t.map(function(e){const t={};for(let n in r.attributes)t[n]=e.data[n];return new e.constructor(e.geometry,{geometryName:r.geometryName,data:t})}):e;Object.getPrototypeOf(n.editControl).importFeatures.call(n.editControl,o)};n.editControl.on(TC.Consts.event.DRAWEND,function(e){n.getLayerEditData().serializable&&n._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREMODIFY,function(e){const t=e.feature,r=t.provId||t.id,i=function(){o(n,!0)},s=function(){TC.error(n.getLocaleString("failedWhenSavingModifyOperationInSession"))},d=n.getLayerEditData();if(d.serializable){let e=d.addedFeaturesLayer.getFeatureById(r);if(e){e.setCoords(t.geometry);e.setData(t.getData());a(l(n)+r,t).then(i,s)}else{if(e=d.modifiedFeaturesLayer.getFeatureById(r)){e.setCoords(t.geometry);e.setData(t.getData())}else d.modifiedFeaturesLayer.addFeature(n._createAuxFeature(t));a(c(n)+r,t).then(i,s)}}}).on(TC.Consts.event.FEATUREADD,function(e){n.getLayerEditData().serializable&&n._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREREMOVE,function(e){n.getLayerEditData().serializable&&n._storeFeatureRemove(e.feature)});e.workLayers.forEach(e=>n.addLayer(e));e.on(TC.Consts.event.LAYERUPDATE,function(e){const t=e.layer;t.type!==TC.Consts.layerType.WFS||t.options.readOnly||n.getEditableLayer(t).then(e=>n.cacheLayer(e)).catch(e=>console.log("Layer not editable: "+t.id))}).on(TC.Consts.event.ZOOM,function(t){e.workLayers.filter(e=>e.wfsLayer).filter(e=>n.layer!==e).forEach(function(e){e.wfsLayer=null;n.getEditableLayer(e)})}).on(TC.Consts.event.LAYERADD,function(e){n.addLayer(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){const t=e.layer;if(n._removingLayer===t)return;(n.layer===t||t.wmsLayer&&n.layer===t.wmsLayer)&&n.setLayer(null);const r=n._layerSelect.querySelector(`option[value="${t.id}"]`);r&&r.parentElement.removeChild(r)}).on(TC.Consts.event.LAYERERROR,function(t){const r=t.layer;if(r.type===TC.Consts.layerType.WFS&&!r.options.readOnly){t.reason===TC.Consts.WFSErrors.MAX_NUM_FEATURES&&e.toast(n.getLocaleString("query.msgTooManyResults",{limit:t.data.limit}),{type:TC.Consts.msgType.WARNING});if(n.layer===r||n.layer&&n.layer.wfsLayer===r){delete n.layersEditData[n.layer.id];n.setLayer(null)}if(r.wmsLayer){e.removeLayer(r);r.wmsLayer.wfsLayer=null}}});r(n)});e.loaded(function(){n._layerSelect.disabled=!1;if(n.options.layer)n.setLayer(n.options.layer);else{const t=e.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===t.length?n.setLayer(t[0].id):n.setLayer(null)}n.showOriginalFeatures(n.showsOriginalFeatures)});e.ready(function(){e.getControlsByClass("TC.control.WorkLayerManager").forEach(function(t){t.addLayerTool({renderFn:function(t,r){const o=n.CLASS+"-btn-edit";let a=t.querySelector("button."+o);if(!a){const i=n.getLocaleString("featureEditing");(a=document.createElement("button")).innerHTML=i;a.setAttribute("title",i);a.classList.add(o);a.dataset.layerId=r;t.appendChild(a);const s=e.getLayer(r);if(s.type===TC.Consts.layerType.WMS){a.classList.add(TC.Consts.classes.LOADING);s.getWFSCapabilities().catch(()=>a.classList.add(TC.Consts.classes.HIDDEN)).finally(()=>a.classList.remove(TC.Consts.classes.LOADING))}}return a},updateEvents:[TC.Consts.event.BEFORELAYERUPDATE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.LAYERERROR,TC.Consts.event.CONTROLACTIVATE,TC.Consts.event.CONTROLDEACTIVATE],updateFn:function(t){const r=this,o=e.getLayer(r.dataset.layerId);setTimeout(()=>{r.classList.toggle(TC.Consts.classes.ACTIVE,n.layer===o)},500);r.disabled=!o||o.isRaster()&&1!==o.names.length},actionFn:function(){const t=e.getLayer(this.dataset.layerId),r=n.layer;this.classList.remove(TC.Consts.classes.ACTIVE);(t.names&&1===t.names.length||!t.isRaster())&&(t&&r!==t?n.setLayer(t).then(()=>{n.openEditSession()}):n.setLayer(null))}})})})})})};y.render=function(e){const t=this;var r=[];if(t.map)for(var o=0,a=t.map.workLayers.length;o<a;o++){var i=t.map.workLayers[o];i.type!==TC.Consts.layerType.WFS||i.options.stealth||r.push({id:i.id,title:i.title||i.id})}return t._set1stRenderPromise(TC.Control.prototype.renderData.call(t,{layers:r,showOriginalFeatures:t.showsOriginalFeatures,highlightChanges:t.highlightsAdded||t.highlightsModified||t.highlightsRemoved,controlId:t.id},function(){t._layerDiv=t.div.querySelector(t._classSelector+"-layer");t._layerSelect=t._layerDiv.querySelector(t._classSelector+"-layer-sel");t._layerSelect.addEventListener("change",function(e){n(t,!1);t.getEditableLayer(t._layerSelect.value).then(function(e){t.setLayer(e.wmsLayer||e).then(function(){t.layer&&t.openEditSession()})}).catch(()=>{t.setLayer(null)})});const r=t.div.querySelector(t._classSelector+"-view");t._editingWatch=r.querySelector(`.${t.CLASS}-view-watch`);t._beforeEditLayerWatch=r.querySelector(`.${t.CLASS}-view-original-watch`);t._addedWatch=r.querySelector(`.${t.CLASS}-view-added-watch`);t._modifiedWatch=r.querySelector(`.${t.CLASS}-view-modified-watch`);t._removedWatch=r.querySelector(`.${t.CLASS}-view-removed-watch`);r.querySelector(`#${t.CLASS}-view-original-cb-${t.id}`).addEventListener("change",function(e){t.showOriginalFeatures(e.target.checked)});r.querySelector(`#${t.CLASS}-view-added-cb-${t.id}`).addEventListener("change",function(e){t.highlightAdded(e.target.checked)});r.querySelector(`#${t.CLASS}-view-modified-cb-${t.id}`).addEventListener("change",function(e){t.highlightModified(e.target.checked)});r.querySelector(`#${t.CLASS}-view-removed-cb-${t.id}`).addEventListener("change",function(e){t.highlightRemoved(e.target.checked)});const o=new RegExp(`${t.CLASS}-view-clr-(.+)-${t.id}`),a=function(e){const n=this.parentElement.querySelector("input[type=color]"),r=t.getLayerEditData(),a=r[n.id.match(o)[1]+"FeaturesLayer"];switch(r.geometryType){case TC.Consts.geom.POINT:n.value=a.styles.point.strokeColor;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:n.value=a.styles.line.strokeColor;break;default:n.value=a.styles.polygon.strokeColor}n.click()},i=function(e){const n=e.target,r=t.getLayerEditData(),a=n.id.match(o)[1],i=r[a+"FeaturesLayer"],s=r[a+"CustomColor"]=n.value;switch(r.geometryType){case TC.Consts.geom.POINT:i.styles.point.strokeColor=s;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:i.styles.line.strokeColor=s;break;default:i.styles.polygon.strokeColor=s;i.styles.polygon.fillColor=s}i.setStyles(i.styles);t[`_${a}Watch`].src=f(i,r.geometryType)},s=`${t.CLASS}-view-clr-added-${t.id}`;r.querySelector(`label[for="${s}"]`).addEventListener(TC.Consts.event.CLICK,a,{passive:!0});document.getElementById(s).addEventListener("change",i);const l=`${t.CLASS}-view-clr-modified-${t.id}`;r.querySelector(`label[for="${l}"]`).addEventListener(TC.Consts.event.CLICK,a,{passive:!0});document.getElementById(l).addEventListener("change",i);const c=`${t.CLASS}-view-clr-removed-${t.id}`;r.querySelector(`label[for="${c}"]`).addEventListener(TC.Consts.event.CLICK,a,{passive:!0});document.getElementById(c).addEventListener("change",i);t._saveBtn=t.div.querySelector(t._classSelector+"-btn-save");t._saveBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.applyEdits.confirm",{layerTitle:u(t.layer)}),function(){t.applyEdits()})},{passive:!0});t._discardBtn=t.div.querySelector(t._classSelector+"-btn-discard");t._discardBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.discardEdits.confirm",{layerTitle:u(t.layer)}),function(){t.discardEdits()})},{passive:!0});t._recropBtn=t.div.querySelector(`.${t.CLASS}-view button.${t.CLASS}-btn-crop`);t._recropBtn.addEventListener(TC.Consts.event.CLICK,function(){if(t.layer){const e=()=>{if(t.layer&&t.layer.wfsLayer&&TC.filter&&TC.filter.Bbox&&t.layer.wfsLayer.properties instanceof TC.filter.Bbox){const e=t.getLayerEditData();t.layer.wfsLayer.properties=new TC.filter.Bbox(null,t.map.getExtent(),t.map.getCRS());t.layer.wfsLayer.refresh();if(e.beforeEditLayer){e.beforeEditLayer.properties=t.layer.wfsLayer.properties;e.beforeEditLayer.refresh()}}},n=t.getLayerEditData(),r=n.addedFeaturesLayer.features.concat(n.modifiedFeaturesLayer.features,n.removedFeaturesLayer.features);r.length?TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){let n=!1;const o=t.map.getExtent(),a=[[o[0],o[1]],[o[0],o[3]],[o[2],o[3]],[o[2],o[1]]];for(var i=0,s=r.length;i<s;i++)if(!TC.Geometry.intersects(r[i].geometry,a)){n=!0;break}n?TC.confirm(t.getLocaleString("refreshLayerToCurrentExtent.confirm"),function(){e()}):e()}):e()}},{passive:!0});TC.Util.isFunction(e)&&e()}))};y.addLayer=function(e){const t=this;e.isBase||e.options.readOnly||e.options.stealth||t.getEditableLayer(e).then(function(n){!e.isRaster()&&n.wmsLayer||function(e){const n=document.createElement("option");n.setAttribute("value",e.id);n.innerHTML=u(e);t.renderPromise().then(function(){t._layerSelect.appendChild(n)})}(e)}).catch(t=>console.log(`Layer ${e.id} not editable. Reason: ${t.message}`))};y.setLayer=function(e){const t=this;return new Promise(function(r,o){const a=t.map,i=t.div.querySelector(t._classSelector+"-layer-sel");e=a.getLayer(e);const s=a.workLayers.filter(t=>t===e)[0],l=function(){if(s)t.getEditableLayer(s).then(function(e){const n=function(){t.layer=s;t._enableEditSerialization(s).then(function(){t.getEditControl().then(n=>{i.value=t.layer.id;n.setMode(null);n.setLayer(e);r(t.layer)})}).catch(e=>{t.setLayer(null);o(e)})};a.workLayers.indexOf(e)>=0?n():a.addLayer(e).then(n)}).catch(()=>{t.setLayer(null);r(null)});else{t.layer&&t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.getEditControl().then(e=>{n(t,!1);t.closeEditSession().then(()=>{i.value="";e.setMode(null);e.setLayer(null);t.layer=null;r(null)}).finally(()=>{delete t._removingLayer})})}};if(null!==e&&t.layer){t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.closeEditSession().then(()=>{s&&l()})}else l()})};y._storeFeatureAdd=function(t){const n=this;t.provId="NewFeature."+e++;const r=n.getLayerEditData(),i=n._createAuxFeature(t);r.addedFeaturesLayer.addFeature(i);a(l(n)+t.provId,i).then(function(){o(n,!0)},function(){TC.error(n.getLocaleString("failedWhenSavingAddOperationInSession"))})};y._storeFeatureRemove=function(e){const t=this;var n=e.provId||e.id,r=function(){o(t)},s=function(){TC.error(t.getLocaleString("failedWhenSavingRemoveOperationInSession"))};const u=t.getLayerEditData();if(u.serializable){let o=u.addedFeaturesLayer.getFeatureById(n);if(o){u.addedFeaturesLayer.removeFeature(o);i(l(t)+n).then(r,s)}else{var y=d(t);if(o=u.modifiedFeaturesLayer.getFeatureById(n)){u.modifiedFeaturesLayer.removeFeature(o);u.removedFeaturesLayer.addFeature(t._createAuxFeature(e));i(c(t)+n).then(function(){r();a(y+n,e).then(r,s)},s)}else if(!(o=u.removedFeaturesLayer.getFeatureById(n))){u.removedFeaturesLayer.addFeature(t._createAuxFeature(e));a(y+n,e).then(r,s)}}}};y._createAuxFeature=function(e){const t=e.provId||e.id,n=this.getLayerEditData(),r=new e.constructor(e.geometry,{geometryName:n.geometryName,data:e.getData()});r.setStyle(null);r.setId(t);return r};y.getEditControl=function(){const e=this;return e._editPromise||new Promise(function(t,n){e.renderPromise().then(()=>t(e.editControl))})};y.cacheLayer=function(e){const t=this;return new Promise(function(n,r){t.getServiceWorker().then(function(){if(navigator.onLine){const o=e.wrap.getGetFeatureUrl(),a=e.getDescribeFeatureTypeUrl();o&&a?t.createCache(s(t,e),{urlList:[o,a]}).then(()=>n(),e=>r(e)):n()}else n()}).catch(e=>r(e))})};y.getFeatureType=function(e){const t=this;return new Promise(function(n,r){e=e||t.layer;const o=t.map.getLoadingIndicator(),a=o&&o.addWait();e.describeFeatureType().then(function(r){t.getEditControl().then(function(o){const a=t.getLayerEditData(e);a.attributes={};for(var i in r){const e=r[i],t=o.getGeometryType(e.type);if(t){a.geometryName=e.name;a.geometryType="boolean"==typeof t?null:t}else a.attributes[i]=e}for(var i in a.attributes){const e=a.attributes[i];e.type=e.type.substr(e.type.indexOf(":")+1)}n(a)})}).catch(function(e){r(e)}).finally(()=>o&&o.removeWait(a))})};y._addAuxLayersToMap=function(e){const t=this;return new Promise(function(n,r){const o=t.map;e=e||t.layer;const a=t.getLayerEditData(e),i=a.beforeEditLayer;if(i){const r=a.addedFeaturesLayer,s=a.modifiedFeaturesLayer,l=a.removedFeaturesLayer;Promise.all([o.addLayer(i),o.addLayer(r),o.addLayer(s),o.addLayer(l)]).then(function(){t.getEditableLayer(e).then(function(e){let c=o.layers.indexOf(e);i.setVisibility(t.showsOriginalFeatures);r.setVisibility(t.highlightsAdded);s.setVisibility(t.highlightsModified);l.setVisibility(t.highlightsRemoved);o.insertLayer(i,++c,function(){const d=c+1;o.insertLayer(r,d);o.insertLayer(s,d);o.insertLayer(l,d);i.setStyles(t.getBeforeEditLayerStyle(e));r.setStyles(t.getAddedFeaturesLayerStyle(e));s.setStyles(t.getModifiedFeaturesLayerStyle(e));l.setStyles(t.getRemovedFeaturesLayerStyle(e));t._editingWatch.src=f(e,a.geometryType);t._beforeEditLayerWatch.src=f(i,a.geometryType);t._addedWatch.src=f(r,a.geometryType);t._modifiedWatch.src=f(s,a.geometryType);t._removedWatch.src=f(l,a.geometryType);n()})})})}else r(new Error(`No auxiliary layers for ${e.id}`))})};y.openEditSession=function(){const e=this;return e.layer?new Promise(function(t,r){e.getFeatureType().then(function(a){e.getEditControl().then(function(i){e.getEditableLayer(e.layer).then(function(s){i.setLayer(s);switch(a.geometryType){case TC.Consts.geom.MULTIPOLYLINE:case TC.Consts.geom.MULTIPOLYGON:i.setComplexGeometry(!0);break;default:i.setComplexGeometry(!1)}i.activate();n(e,!0);o(e);const l=[TC.control.Edit.mode.MODIFY,TC.control.Edit.mode.OTHER];switch(a.geometryType){case TC.Consts.geom.POINT:l.push(TC.control.Edit.mode.ADDPOINT);break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:l.push(TC.control.Edit.mode.ADDLINE);break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:l.push(TC.control.Edit.mode.ADDPOLYGON)}i.constrainModes(l);i.setMode(TC.control.Edit.mode.MODIFY);e._addAuxLayersToMap().then(()=>t()).catch(e=>r(e))})})}).catch(function(o){e.layer&&e.layer.type===TC.Consts.layerType.VECTOR?e.getEditControl().then(function(r){r.activate();n(e,!0);r.setMode(TC.control.Edit.mode.MODIFY);t()}):r(o)})}):Promise.reject(Error("No layer set for editing"))};y.closeEditSession=function(){const e=this;return new Promise(function(t,n){e.renderPromise().then(function(){o(e,!1);e.getEditControl().then(e=>e.deactivate());const n=e.getLayerEditData();if(n&&n.beforeEditLayer){e._editingWatch.src=TC.Consts.BLANK_IMAGE;e._beforeEditLayerWatch.src=TC.Consts.BLANK_IMAGE;e._addedWatch.src=TC.Consts.BLANK_IMAGE;e._modifiedWatch.src=TC.Consts.BLANK_IMAGE;e._removedWatch.src=TC.Consts.BLANK_IMAGE;const r=e.layer;e.getEditableLayer(e.layer).then(function(e){const o=[],a=function(e){map.workLayers.indexOf(e)>=0&&o.push(map.removeLayer(e))};a(n.beforeEditLayer);a(n.beforeEditLayer);a(n.addedFeaturesLayer);a(n.modifiedFeaturesLayer);a(n.removedFeaturesLayer);if(r!==e){r.wfsLayer=null;a(e)}Promise.all(o).then(()=>t())})}else t()})})};y.getEditableLayer=function(e){const t=this;return new Promise(function(n,r){const o=`Layer ${e.id} not editable`,a=t.map;(e=a?a.getLayer(e):e)?e.type!==TC.Consts.layerType.WFS||!e.wmsLayer&&(e.options.stealth||e.options.readOnly)?e.type===TC.Consts.layerType.WMS?e.wfsLayer?e.wfsLayer.getCapabilitiesPromise().then(()=>n(e.wfsLayer)):e.getWFSCapabilities().then(function(i){const s=e.getDisgregatedLayerNames(),l=s[0],c=l.indexOf(":"),d=l.substring(c+1);1!==s.length||i.FeatureTypes.hasOwnProperty(d)?TC.loadJS(!TC.layer.Vector,TC.apiLocation+"TC/layer/Vector",function(){TC.loadJS(!TC.filter,TC.apiLocation+"TC/filter",async function(){const r={id:t.getUID(),type:TC.Consts.layerType.WFS,url:await e.getWFSURL(),properties:a?new TC.filter.Bbox(null,a.getExtent(),a.getCRS()):null,outputFormat:TC.Consts.format.JSON,title:`${e.getPath().join(" \u2022 ")} - ${t.getLocaleString("featureEditing")}`,geometryName:"geom",featureType:[l],featureNS:"Edicion",styles:t.styles,stealth:!0};e.wfsLayer=new TC.layer.Vector(r);e.wfsLayer.wmsLayer=e;n(e.wfsLayer)})}):r(new Error(o))}).catch(e=>r(e)):e.type===TC.Consts.layerType.VECTOR?n(e):r(new Error(o)):e.getCapabilitiesPromise().then(()=>n(e)):r(new Error("No layer to edit"))})};y.isLayerEdited=function(e){const t=this;return new Promise(function(n,r){const o=s(t,e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(e){n(!!e&&e.some(e=>0===e.indexOf(o)))})})})};y.getLayerEditData=function(e){const t=e||this.layer;return t?this.layersEditData[t.id]=this.layersEditData[t.id]||{checkedOut:!1}:null};const f=function(e,t){switch(t){case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return TC.Util.getLegendImageFromStyle(e.styles.point,{geometryType:TC.Consts.geom.POINT});case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return TC.Util.getLegendImageFromStyle(e.styles.line,{geometryType:TC.Consts.geom.POLYLINE});default:return TC.Util.getLegendImageFromStyle(e.styles.polygon,{geometryType:TC.Consts.geom.POLYGON})}};y._enableEditSerialization=function(t){const n=this;return new Promise(function(r,o){n.getEditableLayer(t).then(function(o){const a=function(){const a=n.getLayerEditData(t),i=t.getPath?t.getPath().join(" \u2022 "):t.title||t.id;var u=a.beforeEditLayer;u||(u=a.beforeEditLayer=new TC.layer.Vector(TC.Util.extend({},o.options,{id:n.getUID(),title:`${i} - ${n.getLocaleString("dataBeforeEdits")}`,readOnly:!0,owner:n,stealth:!0})));var y=a.addedFeaturesLayer;let f=!0;if(!y){f=!1;y=a.addedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("addedFeatures")}`,owner:n,stealth:!0,zIndex:2})}var g=a.modifiedFeaturesLayer;let C=!0;if(!g){C=!1;g=a.modifiedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("modifiedFeatures")}`,owner:n,stealth:!0,zIndex:2})}var h=a.removedFeaturesLayer;let L=!0;if(!h){L=!1;h=a.removedFeaturesLayer=new TC.layer.Vector({id:n.getUID(),title:`${i} - ${n.getLocaleString("removedFeatures")}`,owner:n,stealth:!0,zIndex:2})}const m=[];if(f&&C&&L){h.features.forEach(function(e){const t=o.getFeatureById(e.id);t&&o.removeFeature(t)});g.features.forEach(function(e){const t=o.getFeatureById(e.id);if(t){t.setCoords(e.geometry);t.setData(e.getData())}});y.features.forEach(function(e){o.getFeatureById(e.id)||m.push(o.addFeature(n._createAuxFeature(e)))});Promise.all(m).then(()=>{a.serializable=!0;r(o)})}else{const t=s(n,o),i=l(n,o),u=c(n,o),f=d(n,o);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){n&&n.filter(e=>0===e.indexOf(t)).forEach(function(t){m.push(new Promise(function(n,r){(function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(n){t({key:e,feature:n})}).catch(function(e){n(e)})})})})(t).then(function(t){var r,a=t.key;if(0===a.indexOf(f)){r=a.substr(f.length);const e=o.getFeatureById(r);o.removeFeature(e);h.addFeature(e).then(()=>n(e))}else if(0===a.indexOf(u)){r=a.substr(u.length);const e=o.getFeatureById(r);if(e){e.setCoords(t.feature.geometry);e.setData(t.feature.attributes);const r=e.clone();r.setId(e.id);g.addFeature(r).then(()=>n(e))}else n(e)}else if(0===a.indexOf(i)){r=a.substr(i.length);var s,l=parseInt(r.substr(r.lastIndexOf(".")+1));e=Math.max(e,l+1);switch(t.feature.type){case TC.Consts.geom.POINT:s=o.addPoint(t.feature.geometry);break;case TC.Consts.geom.POLYLINE:s=o.addPolyline(t.feature.geometry);break;case TC.Consts.geom.POLYGON:s=o.addPolygon(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:s=o.addMultiPolyline(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:s=o.addMultiPolygon(t.feature.geometry)}s.then(function(e){e.provId=r;e.setData(t.feature.attributes);const o=e.clone();o.setStyle(null);o.setId(e.provId);y.addFeature(o).then(()=>n(o))})}})}))});Promise.all(m).then(()=>{a.serializable=!0;r(o)})})})}};if(o.type===TC.Consts.layerType.WFS)if(o.state===TC.Layer.state.IDLE)a();else{const e=function(t){if(t.layer===o){a();n.map.off(TC.Consts.event.LAYERUPDATE,e)}};n.map.on(TC.Consts.event.LAYERUPDATE,e)}else r(o)})})};y.applyEdits=function(){const e=this;if(e.layer){const n=e.getLayerEditData();if(n.serializable){e.isSyncing=!0;t(e);const r=e.map.getLoadingIndicator(),o=r&&r.addWait(),a=n.modifiedFeaturesLayer.features.map(function(e){const t=new e.constructor(e.geometry,{geometryName:n.geometryName}),r=n.beforeEditLayer.features.filter(t=>t.id===e.id)[0];let o;if(r){o={};for(var a in e.data)if("id"!==a){const t=r.data[a],n=e.data[a];t!==n&&(o[a]=n)}}else o=e.data;t.setData(o);t.setId(e.id);return t});e.getEditableLayer(e.layer).then(function(i){i.applyEdits(n.addedFeaturesLayer.features,a,n.removedFeaturesLayer.features).then(function(t){if(t.transactionSummary.totalInserted!==n.addedFeaturesLayer.features.length||t.transactionSummary.totalUpdated!==a.length||t.transactionSummary.totalDeleted!==n.removedFeaturesLayer.features.length){TC.error("Error de concordancia de n\xfamero de entidades en transacci\xf3n");console.log(t,n.addedFeaturesLayer,a,n.removedFeaturesLayer);throw new Error(`Error en transacci\xf3n: Insertados ${t.transactionSummary.totalInserted}, hay ${n.addedFeaturesLayer.features.length} en capa`)}e.layer.type===TC.Consts.layerType.WMS&&e.layer.refresh();e.deleteCache(s(e)).then(function(){e.cacheLayer(i).finally(function(){e.isSyncing=!1;r&&r.removeWait(o);e.discardEdits();e.map.toast(e.getLocaleString("changesSuccessfullySyncedWithServer"),{type:TC.Consts.msgType.INFO})})})}).catch(function(n){e.isSyncing=!1;t(e);r&&r.removeWait(o);TC.error(e.getLocaleString("errorSyncingChanges",{code:n.code,reason:n.reason}),[TC.Consts.msgErrorMode.TOAST,TC.Consts.msgErrorMode.CONSOLE])})})}}};y.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=s(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){if(n){for(var r=0,a=n.length;r<a;r++){var i=n[r];0===i.indexOf(t)&&localforage.removeItem(i)}if(e.layer){const t=e.getLayerEditData();if(t.serializable){t.addedFeaturesLayer.clearFeatures();t.modifiedFeaturesLayer.clearFeatures();t.removedFeaturesLayer.clearFeatures();e.editControl.setSelectedFeatures([]);e.editControl.modifyControl.closeAttributes();e.getEditableLayer(e.layer).then(e=>e.refresh())}}o(e,!1)}});e.editControl.setMode(null)})};y.showOriginalFeatures=function(e){this.showsOriginalFeatures=e;const t=this.getLayerEditData();t&&t.beforeEditLayer.setVisibility(e)};y.highlightAdded=function(e){this.highlightsAdded=e;const t=this.getLayerEditData();t&&t.addedFeaturesLayer&&t.addedFeaturesLayer.setVisibility(e)};y.highlightModified=function(e){this.highlightsModified=e;const t=this.getLayerEditData();t&&t.modifiedFeaturesLayer&&t.modifiedFeaturesLayer.setVisibility(e)};y.highlightRemoved=function(e){this.highlightsRemoved=e;const t=this.getLayerEditData();t&&t.removedFeaturesLayer&&t.removedFeaturesLayer.setVisibility(e)};const g=function(e,t){const n={};switch(e.getLayerEditData(t.wmsLayer||t).geometryType){case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:n.polygon=t.map.options.styles.polygon;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:n.line=t.map.options.styles.line;break;default:n.point=t.map.options.styles.point}return n};y.getBeforeEditLayerStyle=function(e){const t=function(t){const n=e.wrap.getRGBA(t);for(var r=0;r<3;r++)n[r]=255-n[r];return"#"+(65536*n[0]+256*n[1]+n[2]).toString(16).padStart(6,"0")},n=[1,3],r=TC.Util.extend(!0,{},e.options.styles||g(this,e));if(r.point){r.point.strokeColor=t(r.point.strokeColor);r.point.lineDash=n}if(r.line){r.line.strokeColor=t(r.line.strokeColor);r.line.lineDash=n}if(r.polygon){r.polygon.strokeColor=t(r.polygon.strokeColor);r.polygon.lineDash=n}return r};const C=function(e,t,n){const r=TC.Util.extend(!0,{},t.options.styles||g(e,t));if(r.point){r.point.strokeColor=n;r.point.fillColor=n}r.line&&(r.line.strokeColor=n);if(r.polygon){r.polygon.strokeColor=n;r.polygon.fillColor=n}return r};y.getAddedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.addedCustomColor||"#00ff00")};y.getModifiedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.modifiedCustomColor||"#ff7f00")};y.getRemovedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.removedCustomColor||"#ff0000")}}();
//# sourceMappingURL=../maps/control/WFSEdit.min.js.map