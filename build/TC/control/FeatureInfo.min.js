TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.FeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments);e.wrap=new TC.wrap.control.FeatureInfo(e);TC.Consts.classes.FROMLEFT="tc-fromleft";TC.Consts.classes.FROMRIGHT="tc-fromright";e.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const t="boolean"==typeof e.options.displayElevation?{}:e.options.displayElevation;e.elevation=new TC.tool.Elevation(t)})};TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype;e.FEATURE_PARAM="showfeature";var t=function e(t,r){var a;if($.isArray(t))for(var o=0,n=(a=t.slice()).length;o<n;o++)a[o]=e(a[o]);else a="number"==typeof t?Math.round(t.toFixed(r)):t;return a};e.register=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.register.call(t,e);t._$div.appendTo("<div>");e.loaded(function(){t._layersDeferred.then(function(){var e=TC.Util.getParameterByName(t.FEATURE_PARAM);if(e){var r;try{r=JSON.parse(decodeURIComponent(escape(window.atob(e))))}catch(e){TC.error(TC.Util.getLocaleString(t.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}r&&function(e,t){if(0!==jQuery.grep(e.map.workLayers,function(e,r){return e.type===TC.Consts.layerType.WMS&&e.url===t.s&&e.getDisgregatedLayerNames().indexOf(t.l)>=0}).length){e.sharedFeatureInfo=t;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){const r=[-100,-100];e.beforeRequest({xy:r});e.filterLayer.clearFeatures();$.when(e.filterLayer.addMarker(r)).then(function(r){e.filterFeature=r;e.wrap.getFeatureInfo(t.xy,t.r,{serviceUrl:t.s,layerName:t.l,featureId:t.f})})})}else TC.error(TC.Util.getLocaleString(e.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}(t,r)}})})};e.onShowModal=function(){var e=this,r=$(e.getDisplayTarget()).find("ul."+e.CLASS+"-features li."+TC.Consts.classes.CHECKED),a=e._shareCtl;a.extraParams=null;var o=r.parents("li").first(),n=o.parents("li").first(),i=e.info.services[n.index()];if(i){var s=i.layers[o.index()];if(s){var l=s.features[r.index()];TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var r=hex_md5(JSON.stringify({data:l.getData(),geometry:t(l.geometry,TC.Consts.DEGREE_PRECISION)}));a.extraParams={};a.extraParams[e.FEATURE_PARAM]=window.btoa(unescape(encodeURIComponent(JSON.stringify({xy:l.wrap.getInnerPoint(),r:e.map.getResolution(),s:i.mapLayer.url,l:s.name,f:l.id,h:r}))));var o=a._$div;o.find(".tc-url input[type=text]").val(a.generateLink());o.find(".tc-iframe input[type=text]").val(a.generateIframe())})}}};e.callback=function(e,t){var r=this;if(r.elevation){r.querying=!0;r.elevationRequest=r.elevation.getElevation({crs:r.map.crs,coordinates:e})}if(r.map&&r.filterLayer){var a=r.getLocaleString("featureInfo"),o=$.extend({},r.map.options.styles.marker,r.markerStyle,{title:a,set:a});r.displayMode!==TC.control.FeatureInfoCommons.POPUP&&(o.showsPopup=!1);r.filterLayer.clearFeatures();$.when(r.filterLayer.addMarker(e,o)).then(function(t){r.map.putLayerOnTop(r.filterLayer);r.filterFeature=t;for(var a=!1,o=0;o<r.map.workLayers.length;o++){var n=r.map.workLayers[o];if(n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0){a=!0;break}}var i=r.map.getResolution();a?r.wrap.getFeatureInfo(e,i):r.responseCallback({coords:e})})}};e.responseCallback=function(e){var r=this;const a=function(a){TC.control.FeatureInfoCommons.prototype.responseCallback.call(r,e);r.querying=!0;if(r.filterFeature){var o=e.services;r.info={services:o,defaultFeature:e.defaultFeature};if(o)for(var n=0;n<o.length;n++){for(var i=o[n],s=0;s<i.layers.length;s++)if(!i.layers[s].features.length){i.layers.splice(s,1);s-=1}if(!i.layers.length){o.splice(n,1);n-=1}}var l=r.map.options.locale||TC.Cfg.locale;e.isGeo=r.map.wrap.isGeo();if(a.length){const t=a[0][2];e.elevation=null===t?null:TC.Util.formatNumber(Math.round(t),l)}if(e.coords){e.crs=r.map.crs;e.coords=e.coords.map(function(t){return TC.Util.formatNumber(t.toFixed(e.isGeo?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),l)})}if(o&&o.length||null!==e.elevation)r.renderData(e,function(){r.insertLinks();if(r.sharedFeatureInfo){r._$div.find("ul."+r.CLASS+"-services li").addClass(TC.Consts.classes.CHECKED);for(var e,a=r.sharedFeatureInfo,o=0,n=r.info.services.length;o<n;o++){var i=r.info.services[o];if(i.mapLayer.url===a.s){for(var s=0,l=i.layers.length;s<l;s++){var f=i.layers[s];if(f.name===a.l){for(var u=0,c=f.features.length;u<c;u++){var C=f.features[u];if(C.id===a.f){e=C;var p=hex_md5(JSON.stringify({data:C.getData(),geometry:t(C.geometry,TC.Consts.DEGREE_PRECISION)}));a.h!==p&&TC.alert(r.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}e&&r._addHighlightPopup().then(function(t){e.data=r._$div.html();r.getRenderedHtml(r.CLASS+"-del-btn",null,function(e){t.$popupDiv.append(e);t.$popupDiv.find("."+r.CLASS+"-del-btn").on(TC.Consts.event.CLICK,function(e){TC.confirm(r.getLocaleString("deleteFeature.confirm"),function(){r.map.removeLayer(r.sharedFeatureLayer);delete r.sharedFeatureLayer})})});e.showsPopup=!0;e.popup=t;r.map.addLayer({id:r.getUID(),type:TC.Consts.layerType.VECTOR,title:r.getLocaleString("foi")}).then(function(t){r.sharedFeatureLayer=t;r.filterLayer.clearFeatures();t.addFeature(e);r.map.zoomToFeatures([e])});r.map.on(TC.Consts.event.POPUP,function(a){a.control===t&&t.$popupDiv.find("table").on(TC.Consts.event.CLICK,function(t){r.map.zoomToFeatures([e])})})});delete r.sharedFeatureInfo}else r.displayResults()});else{r.resultsLayer.clearFeatures();r.filterLayer.clearFeatures()}r.querying=!1}};r.elevationRequest?r.elevationRequest.then(a):a([])}}();