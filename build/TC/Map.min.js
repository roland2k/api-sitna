var TC=TC||{};!function(){const e=function(e){return function(t,r,n,a){return r.id===e?n:t}},t={layers:[],contains:function(e){return this.layers.some(function(t){return t.id===e})},getIndex:function(t){return this.layers.reduce(e(t),-1)},add:function(e,r,n,a){var s;const o={id:e,deferred:r,isRaster:n,isBase:a};if(n){s=t.getRasterIndex();this.layers.splice(s,0,o)}else{s=this.layers.length;this.layers[s]=o}},remove:function(e){this.layers.splice(this.getIndex(e),1)},getMapLayers:function(){return this.layers.filter(function(e){return"resolved"===e.deferred.state()}).map(function(e){return e.mapLayer})},resolve:function(e,t,r){this.layers[this.getIndex(t.id)].mapLayer=t;e.layers=this.getMapLayers();r?e.baseLayers=e.layers.filter(function(e){return e.isBase}):e.workLayers=e.layers.filter(function(e){return!e.isBase})},getResolvedWorkLayerIndex:function(t,r){return this.layers.filter(function(e){return e.id===r||!e.isBase&&"pending"!==e.deferred.state()}).reduce(e(r),-1)},getResolvedVisibleLayerIndex:function(e,t){var r=this.getResolvedWorkLayerIndex(e,t);e.baseLayer&&(r+=1);return r},getRasterIndex:function(){return this.layers.reduce((e="isRaster",function(t,r,n){return r[e]?n:t}),-1)+1;var e},checkMapLoad:function(e){const t=this;if(e.options.baseLayers.concat(e.options.workLayers).every(function(e){return t.contains(e.id||e)})&&!this.layers.some(function(e){return"pending"===e.deferred.state()})){const r=function(){if(!e.isLoaded){e.isLoaded=!0;e.$events.trigger($.Event(TC.Consts.event.MAPLOAD));e._$div.removeClass(TC.Consts.classes.LOADING);delete t.state}};if(e.baseLayer)r();else{const t=TC.Cfg.availableBaseLayers.filter(function(t){return t.id===e.state.base});if(t.length>0){t[0].isBase=!0;e.addLayer(t[0]).then(function(t){e.wrap.setBaseLayer(t.wrap.getLayer());e.baseLayer=t;r()})}else{const t=e.baseLayers.filter(function(e){return!e.mustReproject})[0];e.wrap.setBaseLayer(t.wrap.getLayer());e.baseLayer=t;r()}}}}},r=function(e){return(this instanceof TC.Map?this.options.availableBaseLayers:TC.Cfg.availableBaseLayers).filter(function(t){return t.id===e})[0]};TC.Map=TC.Map||function(e,t){var a=this;a.$events=$(a);a.isReady=!1;a.isLoaded=!1;a.controls=[];a.activeControl=null;a.layers=[];a.baseLayers=[];a.workLayers=[];a.baseLayer=null;a.vectors=null;var i=0;a.div=TC.Util.getDiv(e);a._$div=$(a.div);a._$div.addClass(TC.Consts.classes.LOADING);a._$div.data("map",a);a._$div.addClass(TC.Consts.classes.MAP);a._markerDeferreds=[];if(!TC.ready){TC.Cfg=$.extend({},TC.Defaults,TC.Cfg);TC.ready=!0}if(t&&t.controls&&t.controls.search&&t.controls.search.allowedSearchTypes)for(var l in TC.Cfg.controls.search.allowedSearchTypes)t.controls.search.allowedSearchTypes.hasOwnProperty(l)||(t.controls.search.allowedSearchTypes[l]=!1);t=t||{};s.call(a,t);var c=function(){TC.loadJS(a.options.stateful&&!window.jsonpack,[TC.apiLocation+TC.Consts.url.JSONPACK],function(){if(a.options.stateful){u();a.state=a.checkLocation()}a.options.layout&&a.$events.trigger($.Event(TC.Consts.event.LAYOUTLOAD,{map:a}));t&&void 0!==t.workLayers&&(a.options.workLayers=t.workLayers);t&&void 0!==t.baseLayers&&(a.options.baseLayers=t.baseLayers);if(a.options.zoomToFeatures){a.on(TC.Consts.event.FEATURESADD,function e(t){clearTimeout(a._zoomToFeaturesTimeout);a._zoomToFeaturesTimeout=setTimeout(function(){a.zoomToFeatures(t.layer.features,{animate:!1});a.off(TC.Consts.event.FEATURESADD,e)},100)})}else{a.on(TC.Consts.event.LAYERADD,function e(t){if(t.layer.isBase&&t.layer===a.baseLayer){void 0!==a.state&&(a.state.crs?a.loaded(function(){a.setProjection({crs:a.state.crs,extent:a.state.ext})}):a.setExtent(a.state.ext,{animate:!1}));a.off(TC.Consts.event.LAYERADD,e)}})}if(a.state&&a.state.vw3){var e=a.state.vw3;a.loaded(function(){a.getControlsByClass(TC.control.ThreeD)[0].setMapState(e)})}a.crs=a.options.crs;a.initialExtent=a.options.initialExtent;a.maxExtent=a.options.maxExtent;a.wrap=new TC.wrap.Map(a);TC.loadJS(!(TC.isLegacy?window[TC.Consts.PROJ4JSOBJ_LEGACY]:window[TC.Consts.PROJ4JSOBJ]),[TC.url.proj4js],function(){TC.loadJSInOrder(!(TC.isLegacy?window[TC.Consts.OLNS_LEGACY]:window[TC.Consts.OLNS]),[TC.url.ol,TC.url.olConnector],function(){TC.loadProjDef({crs:a.options.crs,callback:function(){a.wrap.setMap();for(var e in a.options.controls){const t=a.options.controls[e];t&&a.addControl(e,"boolean"==typeof t?{}:t)}a.on(TC.Consts.event.BEFORELAYERUPDATE,T);a.on(TC.Consts.event.LAYERUPDATE,v);var t,n;for(t=0;t<a.options.baseLayers.length;t++){"string"==typeof(n=a.options.baseLayers[t])&&(n=r.call(a,n));a.addLayer($.extend({},n,{isBase:!0,map:a}))}var s=function(e){e.isRaster()&&!e.names&&e.setVisibility(!1)};a.options.workLayers.map(function(e){return $.extend({},e,{map:a})}).filter(function(e){return!a.state||!a.state.layers||!a.state.layers.some(function(t){const r=t.u===e.url&&e.layerNames.indexOf(t.n)>=0;r&&(t.id=e.id);return r})}).forEach(function(e){a.addLayer(e).then(s)});a.state&&a.state.layers&&a.state.layers.forEach(function(e){var t=e.o,r=e.v;a.addLayer({id:e.id||TC.getUID(),url:TC.Util.isOnCapabilities(e.u,e.u.indexOf(window.location.protocol)<0)||e.u,hideTitle:e.h,layerNames:e.n?e.n.split(","):"",renderOptions:{opacity:e.o,hide:!e.v}}).then(function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;401!==e.error.code&&403!==e.error.code||t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR});t.map.removeLayer(t)});var n=e.wrap.getRootLayerNode();e.title=n.Title||n.title;e.setOpacity(t);e.setVisibility(r)})});a.isReady=!0;a.$events.trigger($.Event(TC.Consts.event.MAPREADY));f(a._$div)}})})});a.on(TC.Consts.event.FEATURECLICK,function(e){a.activeControl&&a.activeControl.isExclusive()||e.feature.showPopup()});a.on(TC.Consts.event.NOFEATURECLICK,function(e){e.layer._noFeatureClicked=!0;for(var t=!0,r=0,n=a.workLayers.length;r<n;r++)if(!a.workLayers[r]._noFeatureClicked){t=!1;break}if(t){a.workLayers.forEach(function(e){delete e._noFeatureClicked});a.getControlsByClass(TC.control.Popup).forEach(function(e){e.hide()})}})})},u=function(){var e=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE].join(" ");a.on(TC.Consts.event.MAPLOAD,function(){a.loaded(function(){a.replaceCurrent=!0;C();a.on(e,$.proxy(C,a));var t;a.on(TC.Consts.event.LAYEROPACITY,function(e){clearTimeout(t);t=setTimeout(function(){C(e)},500)});window.addEventListener("popstate",function(t){var r;r=a.loadingCtrl&&a.loadingCtrl.addWait();setTimeout(function(){if(t&&null!=t.state){a.off(e,$.proxy(C,a));$.when(h(t.state)).then(function(){setTimeout(function(){a.on(e,$.proxy(C,a))},200);a.loadingCtrl&&a.loadingCtrl.removeWait(r)})}},4)})})})},y=null,p=null,C=function(e){var t=d();if(a.replaceCurrent){window.history.replaceState(t,null,null);delete a.replaceCurrent}else{a.lastEventType=e.type;var r=function(){p=y;(y=TC.Util.utf8ToBase64(t))!==p&&window.history.pushState(t,null,window.location.href.split("#").shift()+"#"+y)};if(e)switch(!0){case e.type==TC.Consts.event.BASELAYERCHANGE.replace(".tc",""):case e.type==TC.Consts.event.LAYERORDER.replace(".tc",""):case e.type==TC.Consts.event.ZOOM.replace(".tc",""):r();break;case e.type.toLowerCase().indexOf("LAYER".toLowerCase())>-1:e.layer.type==TC.Consts.layerType.WMS&&r()}}},d=function(e){var t={};a.crs!==a.options.crs&&(t.crs=a.crs);for(var r,n,s=a.getExtent(),o=0;o<s.length;o++)Math.abs(s[o])>180&&(s[o]=Math.floor(1e3*s[o])/1e3);t.ext=s;t.base=a.getBaseLayer().id;t.layers=[];for(o=0;o<a.workLayers.length;o++)if("WMS"==(r=a.workLayers[o]).type&&!r.options.stateless&&r.layerNames&&r.layerNames.length){n={u:TC.Util.isOnCapabilities(r.url),n:$.isArray(r.names)?r.names.join(","):r.names,o:r.getOpacity(),v:r.getVisibility(),h:r.options.hideTitle};t.layers.push(n)}var i=a.getControlsByClass(TC.control.ThreeD);if(i.length>0&&i[0].mapIs3D&&i[0].map3D.cameraControls){t.vw3=i[0].map3D.cameraControls.getCameraState();t.crs=i[0].map3D.crs;t.ext&&4==t.ext.length&&(t.ext=TC.Util.reproject(t.ext.slice().splice(0,2),a.crs,t.crs).concat(TC.Util.reproject(t.ext.slice().splice(2,2),a.crs,t.crs)))}window.jsonpack||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSONPACK);e&&$.extend(t,e);return jsonpack.pack(t)},h=function(e){var t=new $.Deferred,r=[];a.loadingctrl||(a.loadingCtrl=a.getControlsByClass("TC.control.LoadingIndicator")[0]);a.hasWait||(a.hasWait=a.loadingCtrl&&a.loadingCtrl.addWait());var n;if("string"==typeof e)try{n=jsonpack.unpack(e)}catch(t){try{n=JSON.parse(e)}catch(e){TC.error(TC.Util.getLocaleString(a.options.locale,"mapStateNotValid"))}}else n=e;if(n){if(n.crs&&n.crs!==a.crs||void 0===n.crs&&a.crs!==a.options.crs)r.push(a.setProjection({crs:n.crs||a.options.crs,oldCrs:a.crs,extent:n.ext,baseLayer:a.getLayer(n.base)}));else{if(n.base!=a.getBaseLayer().id){a.getLayer(n.base)&&a.setBaseLayer(n.base);const e=a.baseLayers.filter(function(e){return e.options.fallbackLayer===n.base})[0];if(e){const t=a.addLayer(e.getFallbackLayer());r.push(t);t.then(function(e){a.setBaseLayer(e)})}}n.ext&&r.push(a.setExtent(n.ext,{animate:!1}))}!function(){var e=[];a.workLayers.forEach(function(t){t instanceof TC.layer.Vector||e.push(t)});for(var t=0;t<e.length;t++)a.removeLayer(e[t])}();n.layers=n.layers||n.capas||[];if(n.layers.length>0)for(var s=0;s<n.layers.length;s++){var o=n.layers[s],i=o.o,l=o.v,c=!1;for(j=0;j<a.options.workLayers.length;j++){var u=$.extend({},a.options.workLayers[j],{map:a});if(o.u===u.url&&u.layerNames.indexOf(o.n)>=0){c=!0;u.renderOptions={opacity:o.o,hide:!o.v};r.push(a.addLayer(u).then(function(e){e.setVisibility(l);e.setOpacity(i,!0)}))}}c||r.push(a.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(o.u,o.u.indexOf(window.location.protocol)<0)||o.u,hideTitle:o.h,layerNames:o.n?o.n.split(","):"",renderOptions:{opacity:o.o,hide:!o.v}}).then(function(e){var t=e.wrap.getRootLayerNode();e.title=t.Title||t.title;e.setOpacity(i,!0);e.setVisibility(l)}))}$.when.apply($,r).always(function(){!function(){a.loadingCtrl&&a.loadingCtrl.removeWait(a.hasWait);delete a.hasWait;t.resolve()}()})}return t};o.getMapState=function(e){var t=d(e);return TC.Util.utf8ToBase64(t)};o.getPreviousMapState=function(){return p};o.checkLocation=function(){var e=window.location.hash;if(e&&e.length>1){e=e.substr(1);var t;try{t=jsonpack.unpack(TC.Util.base64ToUtf8(e))}catch(r){try{t=JSON.parse(TC.Util.base64ToUtf8(e))}catch(e){TC.error(TC.Util.getLocaleString(a.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return}}TC.Util.detectIE()&&2047===window.location.href.length&&TC.error(TC.Util.getLocaleString(a.options.locale,"mapStateNotValidForIE"),TC.Consts.msgErrorMode.TOAST);if(t){var r=!1;if(!t.hasOwnProperty("ext")){r=!0;t.ext=a.options.initialExtent}if(!t.hasOwnProperty("base")){r=!0;t.base=a.options.defaultBaseLayer}if(t.hasOwnProperty("layers"))for(var n=t.layers.length-1;n>=0;n--)if(t.layers[n]&&t.layers[n].hasOwnProperty("u")&&t.layers[n].hasOwnProperty("n")){if(!t.layers[n].hasOwnProperty("o")||!t.layers[n].hasOwnProperty("v")||!t.layers[n].hasOwnProperty("h")){r=!0;jQuery.extend(t.layers[n],{o:t.layers[n].o||1,v:t.layers[n].v||!0,h:t.layers[n].h||!1})}}else{r=!0;t.layers.length=t.layers.length-1}else{r=!0;t.layers=[]}t.hasOwnProperty("vw3")&&(t.vw3?(!t.vw3.cp||t.vw3.cp&&3!=t.vw3.cp.length||!t.vw3.chpr||t.vw3.chpr&&3!=t.vw3.chpr.length||!t.vw3.bcpd)&&(r=!0):r=!0);r&&TC.error(TC.Util.getLocaleString(a.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return t}TC.error(TC.Util.getLocaleString(a.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}};var T=function(e){if(i<=0){i=0;a.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE))}i+=1},v=function(e){if((i-=1)<=0){i=0;a.$events.trigger($.Event(TC.Consts.event.UPDATE))}},g=function(e){var t=$.Deferred();if("string"==typeof e){var r=e,n=/^(https?:)?\/\//i.test(r),a=function(t,a){var i=$.Deferred(),l=[r+"/"+a,o+r+"/"+a,o+"layout/responsive/"+a];n&&l.unshift(r+"/"+a);!function r(n){(function(e,t){var r=$.Deferred();$.ajax({type:"HEAD",url:e,complete:function(n,a){r.resolve({resource:t,found:404!==n.status,url:e})}});return r.promise()})(l[n],t).done(function(t){t.found?i.resolve(s(e,t)):r(++n)})}(0);return i.promise()},s=function(e,t){if(!(t.resource in e)){$.extend(!0,{},e);var n=t.found?t.url:o+r+"/"+i[t.resource];e[t.resource]=n}return e},o=TC.apiLocation+"TC/",i=(e={},{script:"script.js",style:"style.css",markup:"markup.html",config:"config.json",i18n:"resources"}),l=Object.keys(i).length;for(var c in i)a(c,i[c]).done(function(e){Object.keys(e).length===l&&t.resolve(e)})}else t.resolve(e);return t.promise()};TC.i18n=TC.i18n||{};TC.i18n.loadResources=TC.i18n.loadResources||function(e,t,r){var n;e?n=$.ajax({url:t+r+".json",type:"GET",dataType:"json",success:function(e){TC.i18n[r]=TC.i18n[r]||{};$.extend(TC.i18n[r],e);"undefined"!=typeof dust&&TC.loadJS(!window.dust.i18n,TC.apiLocation+TC.Consts.url.TEMPLATING_I18N,function(){dust.i18n.add(r,TC.i18n[r])})}}):dust.i18n.add(r,TC.i18n[r]);return n};var L=[],w=a.options.locale,m=$.Deferred();L.push(m);TC.loadJSInOrder(!window.dust||!window.dust.i18n,TC.url.templating,function(){if(w){dust.i18n.setLanguages([w]);L.push(TC.i18n.loadResources(!TC.i18n[w],TC.apiLocation+"TC/resources/",w))}m.resolve()});$.when.apply(this,L).always(function(){const e=TC.Util.getParameterByName(TC.Cfg.layoutURLParamName)||a.options.layout;e?g(e).done(function(e){a.$events.trigger($.Event(TC.Consts.event.BEFORELAYOUTLOAD,{map:a}));var r;"string"==typeof e?r={href:$.trim(e)}:(e.hasOwnProperty("config")||e.hasOwnProperty("markup")||e.hasOwnProperty("style")||e.hasOwnProperty("ie8Style")||e.hasOwnProperty("script")||e.hasOwnProperty("href")||e.hasOwnProperty("i18n"))&&(r=$.extend({},e));r.href&&(r.href+=r.href.match(/\/$/)?"":"/");r.config=r.config||r.href+"config.json";r.markup=r.markup||r.href+"markup.html";r.style=r.style||r.href+"style.css";r.ie8Style=r.ie8Style||r.href+"ie8.css";r.script=r.script||r.href+"script.js";r.i18n=r.i18n||r.href+"resources";r.i18n&&(r.i18n+=r.i18n.match(/\/$/)?"":"/");a.layout=r;var n=[],o=$.Deferred();n.push(o);r.config?n.push($.ajax({url:r.config,type:"GET",dataType:"json",success:function(e){o.resolve(e.i18n);s.call(a,e,t)},error:function(e,t,r){TC.error(t+": "+r);o.resolve(!1)}})):o.resolve(!1);if(r.style){a._$div.addClass("tc-lo");TC.loadCSS(r.style)}!Modernizr.canvas&&r.ie8Style&&TC.loadCSS(r.ie8Style);if(r.markup){var i;if(w){i=$.Deferred();n.push(i)}n.push($.ajax({url:r.markup,type:"GET",dataType:"html",success:function(e){o.then(function(t){if(t&&w)TC.i18n.loadResources(!0,r.i18n,w).always(function(){e=e.replace(/(?:\{\{([^\}\{]+)\}\}|\{@i18n \$key="([^\}\{]+)"\/\})/g,function(e,t,r){return TC.Util.getLocaleString(w,t||r)});a._$div.append(e);i.resolve()});else{a._$div.append(e);w&&i.resolve()}})},error:function(){i.reject()}}))}$.when.apply(this,n).always(function(){TC.loadJS(r.script,r.script,function(){f(a._$div);c()})})}):c()});a.$events.on(TC.Consts.event.UPDATEPARAMS,function(e){n(e.layer)});a.$events.on(TC.Consts.event.ZOOM,function(){for(var e=0;e<a.workLayers.length;e++)n(a.workLayers[e])});var b=TC.error;TC.error=function(e,t,r){TC.isDebug&&console.trace&&console.trace();if(t){var n=function(e,t,r){switch(t){case TC.Consts.msgErrorMode.TOAST:if(!a.toast){console.warn("No existe el objeto Toast");return}a.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration});break;case TC.Consts.msgErrorMode.EMAIL:TC.Cfg.loggingErrorsEnabled&&JL("onerrorLogger").fatalException(r?{msg:r,errorMsg:e}:e,null);break;case TC.Consts.msgErrorMode.CONSOLE:default:console.error(e)}};if($.isArray(t))for(var s=0;s<t.length;s++)n(e,t[s],r);else n(e,t,r)}else{b(e);a.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration})}}};var n=function(e){e.type===TC.Consts.layerType.WMS&&(e.tree=null)},a=function(e,t){var n=$.map(e,function(e){var r={};e&&(r[t]=e[t]);return r});"availableBaseLayers"===t&&console.log("layerOptions",n);var a={};a[t]=TC.Cfg[t];n.unshift(a);if("baseLayers"===t&&n[1].baseLayers){a=n[1];for(var s=0;s<a.baseLayers.length;s++)"object"==typeof a.baseLayers[s]&&$.extend(a.baseLayers[s],r.call(this,a.baseLayers[s].id))}else{n.unshift(!0);a=$.extend.apply(this,n);"availableBaseLayers"===t&&console.log("layerOption",a)}return a[t]},s=function(){const e=this.options=$.extend.apply(this,$.merge([!0,{},TC.Cfg],arguments));e.availableBaseLayers=TC.Cfg.availableBaseLayers.concat.apply(TC.Cfg.availableBaseLayers,Array.prototype.map.call(arguments,function(e){return e.availableBaseLayers||[]}));e.baseLayers=a.call(this,arguments,"baseLayers");e.workLayers=a.call(this,arguments,"workLayers");return e},o=TC.Map.prototype,i=function(e,t){var r,n='Layer "'+t.title+'" ("'+t.names+'"): ';r=t.isValidFromNames()?"layerSrsNotCompatible":"layerNameNotValid";n+=TC.Util.getLocaleString(e.options.locale,r);TC.error(n);e.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:t,reason:r}))};o.getCRS=function(){const e=this;return e.on3DView?e.view3D.crs:e.crs};o.addLayer=function(e,n){const a=this,s=new $.Deferred;s.then(function(e){t.resolve(a,e,e.isBase);a.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:e}));t.checkMapLoad(a);$.isFunction(n)&&n(e)},function(e){t.checkMapLoad(a)});const o=p(e);"object"!=typeof e||e.id||(e.id=TC.getUID());t.add(e.id||e,s,o,e.isBase);const l=function(e){if(e){var t={projection:a.wrap.map.getView().getProjection(),extent:a.initialExtent},r=a.baseLayer.getResolutions();if(r&&r.length)t.resolutions=r;else{t.minZoom=a.wrap.map.getView().getMinZoom();t.maxZoom=a.wrap.map.getView().getMaxZoom();var n=a.baseLayer.wrap.layer.getMinResolution();0!==n&&(t.minResolution=n);var s=a.baseLayer.wrap.layer.getMaxResolution();s!==Number.POSITIVE_INFINITY&&(t.maxResolution=s)}a.wrap.map.setView(new ol.View(t));a.wrap.map.getView().fit(a.initialExtent)}};var c,u,y;if(o){u=!TC.layer||!TC.layer.Raster;y=TC.apiLocation+"TC/layer/Raster"}else{u=!TC.layer||!TC.layer.Vector;y=TC.apiLocation+"TC/layer/Vector"}TC.loadJS(u,[y],function(){if("string"==typeof e)c=new TC.layer.Raster($.extend({},r.call(a,e),{map:a}));else if(e instanceof TC.Layer)(c=e).map=a;else{e.map=a;c=e.type===TC.Consts.layerType.VECTOR||e.type===TC.Consts.layerType.KML||e.type===TC.Consts.layerType.WFS?new TC.layer.Vector(e):new TC.layer.Raster(e)}a.$events.trigger($.Event(TC.Consts.event.BEFORELAYERADD,{layer:c}));$.when(a.wrap.getMap(),c.wrap.getLayer()).then(function(){var r;p(c)&&(r=a.wrap.indexOfFirstVector());-1===r&&(r=a.wrap.getLayerCount());const n=a.state&&a.state.crs?a.state.crs:a.getCRS(),o=c.isCompatible(n);if(c.isBase){if(!o)if(!c.type===TC.Consts.layerType.WMTS)c.mustReproject=!0;else{const e=c.wrap.getCompatibleMatrixSets(n)[0];e?c.wrap.setMatrixSet(e):c.mustReproject=!0}a.state?c.isDefault=a.state.base===c.id||a.state.base===c.options.fallbackLayer:"string"==typeof a.options.defaultBaseLayer?a.options.defaultBaseLayer===c.id&&(c.isDefault=!0):"number"==typeof a.options.defaultBaseLayer&&a.options.defaultBaseLayer===a.baseLayers.length&&(c.isDefault=!0);if(c.isDefault)if(c.mustReproject&&!c.type===TC.Consts.layerType.WMTS||c.mustReproject&&c.type===TC.Consts.layerType.WMTS&&!c.wrap.getCompatibleMatrixSets(n)[0])if(c.options.fallbackLayer&&c.getFallbackLayer){var u=null===a.baseLayer;a.baseLayer=c.getFallbackLayer();a.addLayer(a.baseLayer).then(function(e){a.wrap.setBaseLayer(e.wrap.getLayer());l(u);s.resolve(c)})}else{i(a,c);s.reject(e)}else{u=null===a.baseLayer;a.wrap.setBaseLayer(c.wrap.getLayer());a.baseLayer=c;l(u);s.resolve(c)}else s.resolve(c)}else if(o){a.wrap.insertLayer(c.wrap.getLayer(),t.getResolvedVisibleLayerIndex(a,c.id));s.resolve(c)}else{i(a,c);s.reject(e)}})});return s.promise()};o.removeLayer=function(e){var r=this,n=new $.Deferred;$.when(e.wrap.getLayer()).then(function(a){for(var s=0;s<r.layers.length;s++)r.layers[s]===e&&r.layers.splice(s,1);if(e.isBase){for(s=0;s<r.baseLayers.length;s++)if(r.baseLayers[s]===e){r.baseLayers.splice(s,1);r.baseLayer===e&&r.setBaseLayer(r.baseLayers[0]);break}}else{for(s=0;s<r.workLayers.length;s++)if(r.workLayers[s]===e){r.workLayers.splice(s,1);break}e===r.vectors&&(r.vectors=null)}r.wrap.removeLayer(a);t.remove(e.id);r.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e}));t.checkMapLoad(r);n.resolve(e)});return n};o.insertLayer=function(e,t,r){for(var n=this,a=-1,s=0;s<n.layers.length;s++)if(e===n.layers[s]){a=s;break}var o=[];o.push(e.wrap.getLayer());var i=n.layers[t];i&&o.push(i.wrap.getLayer());$.when.apply(this,o).then(function(s,o){var i=-1;if((i=o?n.wrap.getLayerIndex(o):n.wrap.getLayerCount())>=0){e.map=n;n.wrap.insertLayer(s,i);a>-1&&n.layers.splice(a,1);n.layers.splice(t,0,e);n.workLayers=n.layers.filter(function(e){return!e.isBase});n.$events.trigger($.Event(TC.Consts.event.LAYERORDER,{layer:e,oldIndex:a,newIndex:t}))}$.isFunction(r)&&r()})};o.setLayerIndex=function(e,t){this.wrap.setLayerIndex(e.wrap.getLayer(),t)};o.putLayerOnTop=function(e){var t=this.wrap.getLayerCount();this.setLayerIndex(e,t-1)};o.setBaseLayer=function(e,t){var n=this,a=null,s=!1;if("string"==typeof e){var o;for(o=0;o<n.layers.length;o++)if(n.layers[o].id===e){e=n.layers[o];s=!0;break}if(!s&&(e=r.call(n,e))){e=n.addLayer($.extend(!0,{},e,{isDefault:!0,map:n}));s=!0}}else{if($.inArray(e,n.layers)<0){e.isDefault=!0;e.map=n;n.addLayer(e).then(function(){n.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:e}));$.isFunction(t)&&t()})}s=!0}if(s)if(e.isCompatible(n.getCRS())||e.fallbackLayer&&(!e.fallbackLayer||e.fallbackLayer.isCompatible(n.getCRS()))){n.$events.trigger($.Event(TC.Consts.event.BEFOREBASELAYERCHANGE,{oldLayer:n.getBaseLayer(),newLayer:e}));a=e;$.when(n.wrap.getMap(),e).then(function(e,r){$.when(r.wrap.getLayer()).then(function(e){n.wrap.setBaseLayer(e).then(function(){n.baseLayer=r;n.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:r}));$.isFunction(t)&&t()})})})}else TC.error("Base layer must be reprojected");else TC.error("Base layer is not available");return a};o.on=function(e,t){this.$events.on(e,t);return this};o.one=function(e,t){this.$events.one(e,t);return this};o.off=function(e,t){this.$events.off(e,t);return this};o.ready=function(e){$.isFunction(e)&&(this.isReady?e():this.one(TC.Consts.event.MAPREADY,e))};o.loaded=function(e){$.isFunction(e)&&(this.isLoaded?e():this.one(TC.Consts.event.MAPLOAD,e))};o.getLayerTree=function(){var e={baseLayers:[],workLayers:[]};this.baseLayer&&(e.baseLayers[0]=this.baseLayer.getTree());for(var t=0;t<this.workLayers.length;t++){var r=this.workLayers[t].getTree();r&&e.workLayers.unshift(r)}return e};o.addControl=function(e,t){var r=this,n=new $.Deferred,a=function(e){r.controls.push(e);e.register(r);$dv=$(e.div);0===$dv.parent().length&&$dv.appendTo(r._$div);r.$events.trigger($.Event(TC.Consts.event.CONTROLADD,{control:e}));n.resolve(e)};if("string"==typeof e){e=e.substr(0,1).toUpperCase()+e.substr(1);TC.loadJS(!TC.Control||!TC.control[e],[TC.apiLocation+"TC/control/"+e],function(){a(new TC.control[e](null,t))})}else a(e);return n.promise()};o.getControlsByClass=function(e){var t=[],r=e;if("string"==typeof e){r=window;for(var n=e.split("."),a=0;a<n.length&&(r=r[n[a]]);a++);}if($.isFunction(r))for(a=0;a<this.controls.length;a++){var s=this.controls[a];s instanceof r&&t.push(s)}return t};o.getControlById=function(e){const t=this;for(var r=0,n=t.controls.length;r<n;r++){const n=t.controls[r];if(n.id===e)return n}return null};o.getDefaultControl=function(){var e=this.getControlsByClass("TC.control.FeatureInfo");return e&&e.length?e[0]:null};o.getLoadingIndicator=function(){var e=null,t=this.getControlsByClass("TC.control.LoadingIndicator");t.length&&(e=t[0]);return e};o.setExtent=function(e,t){return this.wrap.setExtent(e,t)};o.getExtent=function(){return this.wrap.getExtent()};o.setCenter=function(e,t){return this.wrap.setCenter(e,t)};o.getCenter=function(){return this.wrap.getCenter()};o.setRotation=function(e){this.wrap.setRotation(e)};o.getRotation=function(){return this.wrap.getRotation()};o.getViewHTML=function(){return this.wrap.getViewport()};o.getCompatibleCRS=function(e){const t=((e=e||{}).layers||this.workLayers.concat(this.baseLayer)).filter(function(e){return e.isRaster()}).map(function(t){return t.getCompatibleCRS({normalized:!0,includeFallback:e.includeFallbacks})}),r=t.slice(1);return t[0].filter(function(e){return r.every(function(t){return t.indexOf(e)>=0})})};o.loadProjections=function(e){e=e||{};const t=$.Deferred(),r=e.crsList||[];$.when.apply(this,r.map(function(e){return TC.getProjectionData({crs:TC.Util.getCRSCode(e)})})).then(function(){var r=Array.prototype.slice.call(arguments).filter(function(e){return"ok"===e.status&&e.number_result>0}).map(function(e){const t=e.results[0],r="EPSG:"+t.code;TC.loadProjDef({crs:r,def:t.def,name:t.name});return{code:r,name:t.name,proj4:t.proj4,unit:t.unit}});e.orderBy&&(r=r.sort(TC.Util.getSorterByProperty(e.orderBy)));t.resolve(r)},function(e){t.reject(e)});return t.promise()};o.setProjection=function(e){const t=this,r=$.Deferred();var n;if((e=e||{}).crs){e.baseLayer?n=e.baseLayer:e.allowFallbackLayer&&(t.baseLayer.isCompatible(e.crs)||0!==t.baseLayer.wrap.getCompatibleMatrixSets(e.crs).length?t.baseLayer.firstOption&&(t.baseLayer.firstOption.isCompatible(e.crs)||t.baseLayer.firstOption.wrap.getCompatibleMatrixSets(e.crs).length>0)&&(n=t.baseLayer.firstOption):t.baseLayer.options.fallbackLayer&&(n=t.baseLayer.getFallbackLayer()));n||(n=t.baseLayer);t.baseLayers.indexOf(n)<0&&t.addLayer(n);TC.loadProjDef({crs:e.crs,callback:function(){n.getCapabilitiesPromise().then(function(){const a=$.extend({},e,{oldCrs:t.crs}),s=function(e){e.setProjection(a)};if(n.isCompatible(e.crs)||n.wrap.getCompatibleMatrixSets(e.crs).length>0){n.setProjection(a);t.wrap.setProjection($.extend({},e,{baseLayer:n}));t.crs=e.crs;t.baseLayers.filter(function(e){return e!==n}).forEach(s);t.workLayers.forEach(s);const o=function(){t.$events.trigger($.Event(TC.Consts.event.PROJECTIONCHANGE,{crs:e.crs}));r.resolve()};n&&n!==t.baseLayer?t.setBaseLayer(n,o):o()}else r.reject()})}})}return r.promise()};o.getMetersPerUnit=function(){return this.wrap.getMetersPerUnit()};o.getCoordinateFromPixel=function(e){return this.wrap.getCoordinateFromPixel(e)};o.getPixelFromCoordinate=function(e){return this.wrap.getPixelFromCoordinate(e)};o.zoomToFeatures=function(e,t){if(e.length>0){var r=[1/0,1/0,-1/0,-1/0],n=t||{},a=n.pointBoundsRadius||this.options.pointBoundsRadius;a/=this.getMetersPerUnit();var s=n.extentMargin;"number"!=typeof s&&(s=this.options.extentMargin);for(var o=0;o<e.length;o++){var i=e[o].getBounds();if(i){r[0]=Math.min(r[0],i[0]);r[1]=Math.min(r[1],i[1]);r[2]=Math.max(r[2],i[2]);r[3]=Math.max(r[3],i[3])}}if(r[2]-r[0]==0){r[0]=r[0]-a;r[2]=r[2]+a}if(r[3]-r[1]==0){r[1]=r[1]-a;r[3]=r[3]+a}if(this.options.extentMargin){var l=(r[2]-r[0])*s/2,c=(r[3]-r[1])*s/2;r[0]=r[0]-l;r[1]=r[1]-c;r[2]=r[2]+l;r[3]=r[3]+c}if(this.options.maxExtent){r[0]=Math.max(r[0],this.options.maxExtent[0]);r[1]=Math.max(r[1],this.options.maxExtent[1]);r[2]=Math.min(r[2],this.options.maxExtent[2]);r[3]=Math.min(r[3],this.options.maxExtent[3])}this.wrap.setExtent(r,n);this.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:r}))}};o.zoomToMarkers=function(e){var t=this;$.when.apply(this,t._markerDeferreds).then(function(){for(var r=[],n=0;n<t.workLayers.length;n++){var a=t.workLayers[n];if(a.type===TC.Consts.layerType.VECTOR)for(var s=0;s<a.features.length;s++){var o=a.features[s];o instanceof TC.feature.Marker&&(r[r.length]=o)}}for(n=0;n<arguments.length;n++)r[r.length]=arguments[n];t.zoomToFeatures(r,e);t._markerDeferreds=[]})};o.getLayer=function(e){var t=null;if("string"==typeof e){for(var r=0;r<this.layers.length;r++)if(this.layers[r].id===e){t=this.layers[r];break}}else TC.Layer&&e instanceof TC.Layer&&(t=e);return t};var l=function(e){var t;if(e.vectors)t=e.vectors;else{t=e.addLayer({id:TC.getUID(),title:TC.i18n[e.options.locale].vectors,type:TC.Consts.layerType.VECTOR});e.vectors=t;t.then(function(t){e.vectors=t})}return t};o.addPoint=function(e,t){if(t&&t.layer){var r=this.getLayer(t.layer);r&&r.addPoint(e,t)}else $.when(l(this)).then(function(r){r.addPoint(e,t)})};o.addMarker=function(e,t){if(t&&t.layer){var r=this.getLayer(t.layer);r&&this._markerDeferreds.push(r.addMarker(e,t))}else{var n=new $.Deferred;this._markerDeferreds.push(n);$.when(l(this)).then(function(r){$.when(r.addMarker(e,t)).then(function(e){n.resolve(e)})})}};o.addPolyline=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolyline(e,t)}else $.when(l(this)).then(function(r){r.addPolyline(e,t)})};o.addPolygon=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolygon(e,t)}else $.when(l(this)).then(function(r){r.addPolygon(e,t)})};o.getBaseLayer=function(){return this.baseLayer||this.baseLayers[0]};o.getResolutions=function(){return this.wrap.getResolutions()};o.getResolution=function(){return this.wrap.getResolution()};o.setResolution=function(e){this.wrap.setResolution(e)};o.exportFeatures=function(e,t){var r=t||{},n=this.getLoadingIndicator(),a=n&&n.addWait(),s=this.wrap.exportFeatures(e,r),o=TC.Consts.mimeType[r.format],i=r.format||"";TC.Util.downloadFile((r.fileName||TC.getUID())+"."+i.toLowerCase(),o,s);n&&n.removeWait(a)};var c={},u=function(){var e=$(this),t=e.parent(".tc-toast-container"),r=e.html();e.addClass(TC.Consts.classes.HIDDEN);void 0!==c[r]&&(c[r]=void 0);setTimeout(function(){e.remove();t.find(".tc-toast").length||t.remove()},1e3)};o.toast=function(e,t){var r=t||{},n=r.duration||TC.Cfg.toastDuration,a=c[e];if(a){clearTimeout(a.timeout);a.$toast.remove()}var s=this._$div.find(".tc-toast-container");s.length||(s=$("<div>").addClass("tc-toast-container").appendTo(r.container?r.container:this._$div));a=c[e]={$toast:$("<div>").addClass("tc-toast").html(e).appendTo(s).on(TC.Consts.event.CLICK,u)};var o="";switch(r.type){case TC.Consts.msgType.INFO:o=TC.Consts.classes.INFO;break;case TC.Consts.msgType.WARNING:o=TC.Consts.classes.WARNING;break;case TC.Consts.msgType.ERROR:o=TC.Consts.classes.ERROR}a.$toast.addClass(o);a.timeout=setTimeout(function(){u.call(a.$toast)},n)};var y=!1,f=function(e){if(/iPad/i.test(navigator.userAgent)){var t=window.innerHeight;e.height()===t+(Modernizr.mq("only screen and (orientation : landscape)")?20:0)&&(y=!0)}var r=function(){e.toggleClass(TC.Consts.classes.IPAD_IOS7_FIX,Modernizr.mq("only screen and (orientation : landscape)"))};if(y){r();$(window).on("resize",r)}else $(window).off("resize",r)},p=function(e){return"string"==typeof e||e.type!==TC.Consts.layerType.VECTOR&&e.type!==TC.Consts.layerType.KML&&e.type!==TC.Consts.layerType.WFS};o.exportImage=function(){var e=null,t="El mapa actual no es compatible con la exportaci\xf3n de im\xe1genes",r=this.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0];if(r&&this.options.crossOrigin)try{e=r.toDataURL()}catch(e){TC.error(t+": "+e.message)}else TC.error(t);return e}}();