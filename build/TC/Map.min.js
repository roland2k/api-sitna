var TC=TC||{};TC.inherit=function(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;e._super=t.prototype};!function(){(this||{}).CustomEvent="function"==typeof CustomEvent?CustomEvent:function(e){t.prototype=new t("").constructor.prototype;return t;function t(e,t){t||(t={});var r=document.createEvent("CustomEvent");r.initCustomEvent(e,!!t.bubbles,!!t.cancelable,t.detail);return r}}();Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector);const e=function(e,t,r){const n=this;e.split(" ").forEach(function(e){n.$events.addEventListener(e,function(e,t){const r=function(e){const r={type:e.type,target:this,currentTarget:this};e.detail&&Object.keys(e.detail).forEach(function(t){t in r||(r[t]=e.detail[t])});return t.call(this,r)}.bind(this);(this._listeners[e]=this._listeners[e]||new Map).set(t,r);return r}.call(n,e,t),r)});return n};TC.EventTarget=function(){const e=this;e._listeners={};e.$events=document.createDocumentFragment();const t=["addEventListener","dispatchEvent","removeEventListener"];t.forEach(function(t){this[t]=e.$events[t].bind(e.$events)},e);t.push("on");t.push("one");t.push("off");t.push("trigger");t.forEach(function(t){e.$events[t]=e[t].bind(e)},e)};const t=TC.EventTarget.prototype;t.on=function(t,r){return e.call(this,t,r)};navigator.userAgent.indexOf("Trident")>=0||navigator.userAgent.indexOf("MSIE")>=0?t.one=function(e,t){const r=this,n=function(a){r.off(e,n);t.call(this,a)};r.on(e,n);return r}:t.one=function(t,r){return e.call(this,t,r,{once:!0})};t.off=function(e,t){const r=this,n=e.split(" ");t?n.forEach(function(e){const n=r._listeners[e];n&&n.has(t)&&r.$events.removeEventListener(e,n.get(t))}):n.forEach(function(e){const t=r._listeners[e];if(t){t.forEach(function(t){r.$events.removeEventListener(e,t)});t.clear()}});return r};t.trigger=function(e,t){if(window.$&&$.Event&&e instanceof $.Event){t={};Object.keys(e).forEach(function(r){"type"!==r&&(t[r]=e[r])});e=e.type}var r;t&&(r={detail:t});const n=new CustomEvent(e,r);this.dispatchEvent(n)};TC.EventTarget._onBySelectorMap=new WeakMap;TC.EventTarget.listenerBySelector=function(e,t){return function(r){const n=this,a=r.type;var o=TC.EventTarget._onBySelectorMap.get(n);if(!o){o={};TC.EventTarget._onBySelectorMap.set(n,o)}var s=o[a];s||(o[a]=s={});s[e]||(s[e]=t);if(!r._listenerBySelectorCalled)for(var i,l=!1,c=r.target;c&&c!==n;){for(e in s)if(c.matches&&c.matches(e)){l=!0;i=s[e].call(n,r);r._listenerBySelectorCalled=!0}if(l)return i;c=c.parentNode}}};var r=null,n=null;let a;const o={},s=function(e,t){return new Promise(function(r,n){(async function(){a||(a=TC.Util.getWebWorkerCrossOriginURL(TC.apiLocation+"TC/workers/tc-jsonpack-web-worker.js"));const e=await a,t=new Worker(e);t.onmessage=function(e){const r=o[e.data.id];if(r){e.data.error?r.reject(e.data.error):r.resolve(e.data.result);t.terminate();delete o[e.data.id]}};return t})().then(function(a){const s=TC.getUID();o[s]={resolve:r,reject:n};a.postMessage({id:s,action:e,object:t})})})},i=async function(e){const t=this;var a=await l.call(t);if(t.replaceCurrent){window.history.replaceState(a,null,null);delete t.replaceCurrent}else{var o=function(){n=r;(r=TC.Util.utf8ToBase64(a))!==n&&window.history.pushState(a,null,window.location.href.split("#").shift()+"#"+r)};if(e){t.lastEventType=e.type;switch(!0){case e.type==TC.Consts.event.BASELAYERCHANGE:case e.type==TC.Consts.event.LAYERORDER:case e.type==TC.Consts.event.ZOOM:o();break;case e.type.toLowerCase().indexOf("LAYER".toLowerCase())>-1:e.layer.type==TC.Consts.layerType.WMS&&o()}t.trigger(TC.Consts.event.MAPCHANGE)}}},l=function(e){const t=this;e=e||{};return new Promise(function(r,n){var a={};t.crs!==t.options.crs&&(a.crs=t.crs);for(var o=t.getExtent(),i=0;i<o.length;i++)Math.abs(o[i])>180&&(o[i]=Math.floor(1e3*o[i])/1e3);a.ext=o;var l,c,u=[];t.baseLayers&&(u=t.baseLayers.filter(function(e){return e.isRaster()&&e.fallbackLayer}).map(function(e){return{baseLayer:e,fallbackLayerID:e.fallbackLayer.id}}).filter(function(e){return e.fallbackLayerID===(t.baseLayer?t.baseLayer.id:t.baseLayers[0].id)}));u.length>0?a.base=u[0].baseLayer.id:(t.baseLayer||t.baseLayers&&t.baseLayers[0])&&(a.base=(t.baseLayer||t.baseLayers[0]).id);a.layers=[];for(i=0;i<t.workLayers.length;i++)if("WMS"==(l=t.workLayers[i]).type&&!l.options.stateless&&l.layerNames&&l.layerNames.length){c={u:TC.Util.isOnCapabilities(l.url),n:Array.isArray(l.names)?l.names.join(","):l.names,o:l.getOpacity(),v:l.getVisibility(),h:l.options.hideTitle,ur:l.unremovable,f:l.filter&&(l.filter instanceof TC.filter.Filter?l.filter.getText():l.filter),t:l.title};a.layers.push(c)}t.on3DView&&t.view3D.cameraControls&&(a.vw3=t.view3D.cameraControls.getCameraState());e.extraStates&&TC.Util.extend(a,e.extraStates);!e.cacheResult&&t._controlStatesCache&&delete t._controlStatesCache;t._controlStatesCache?r(t._controlStatesCache):s("pack",a).then(n=>{e.cacheResult&&(t._controlStatesCache=n);r(n)}).catch(e=>n(e))})},c=function(e){const t=this,r=[];if(!e)return Promise.resolve();t.loadingctrl||(t.loadingCtrl=t.getControlsByClass("TC.control.LoadingIndicator")[0]);t.hasWait||(t.hasWait=t.loadingCtrl&&t.loadingCtrl.addWait());return new Promise(function(n,a){var o=function(){t.loadingCtrl&&t.loadingCtrl.removeWait(t.hasWait);delete t.hasWait;n()};let i;(i="string"==typeof e?new Promise(function(r,n){s("unpack",e).then(e=>r(e)).catch(t=>r(JSON.parse(e))).catch(e=>{TC.error(TC.Util.getLocaleString(t.options.locale,"mapStateNotValid"));n(e)})}):Promise.resolve(e)).then(function(e){if(e.crs&&e.crs!==t.crs||void 0===e.crs&&t.crs!==t.options.crs)r.push(t.setProjection({crs:e.crs||t.options.crs,oldCrs:t.crs,extent:e.ext,baseLayer:t.getLayer(e.base)}));else{if(e.base!=t.getBaseLayer().id){t.getLayer(e.base)&&t.setBaseLayer(e.base);const n=t.baseLayers.filter(function(t){return t.options.fallbackLayer===e.base})[0];if(n){const e=t.addLayer(n.getFallbackLayer());r.push(e);e.then(function(e){t.setBaseLayer(e)})}}e.ext&&r.push(t.setExtent(e.ext,{animate:!1}))}(function(){const e=this;e.workLayers.filter(function(e){return!(e instanceof TC.layer.Vector)}).forEach(function(t){t.unremovable&&(t.unremovable=!1);e.removeLayer(t)})}).call(t);e.layers=e.layers||e.capas||[];if(e.layers.length>0)for(var n=0;n<e.layers.length;n++){var a=e.layers[n],s=!1;for(j=0;j<t.options.workLayers.length;j++){var i=TC.Util.extend({},t.options.workLayers[j],{map:t});if(a.u===i.url&&i.layerNames.indexOf(a.n)>=0){s=!0;i.renderOptions={opacity:a.o,hide:!a.v};i.unremovable=a.ur;i.title=a.t;r.push(t.addLayer(i).then(function(e){e.setVisibility(this.v);e.setOpacity(this.o,!0)}.bind(a)))}}s||r.push(t.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(a.u,a.u.indexOf(window.location.protocol)<0)||a.u,hideTitle:a.h,layerNames:a.n?a.n.split(","):"",unremovable:a.ur,title:a.t,renderOptions:{opacity:a.o,hide:!a.v}}).then(function(e){var t=e.wrap.getRootLayerNode();e.title=t.Title||t.title;e.setOpacity(this.o,!0);e.setVisibility(this.v)}.bind(a)))}Promise.all(r).then(function(){o()}).catch(function(){o()})}).catch(e=>o())})},u=function(e,t){return function(r,n,a){return n[e]===t?a:r}},f=function(e){return(this instanceof TC.Map?this.options.availableBaseLayers:TC.Cfg.availableBaseLayers).filter(function(t){return t.id===e})[0]};TC.Map=TC.Map||function(e,t){const r=this;TC.EventTarget.call(r);TC.Map._instances.push(r);r.isReady=!1;r.isLoaded=!1;r.controls=[];r.activeControl=null;r.layers=[];r.baseLayers=[];r.workLayers=[];r.baseLayer=null;r.vectors=null;var a=0;r.div=TC.Util.getDiv(e);TC._jQueryIsLoaded&&(r._$div=$(r.div));const o=function(){if(0===r.div.getBoundingClientRect().height){document.querySelectorAll("html,body").forEach(e=>e.classList.add("tc-fullscreen"));r.div.classList.add("tc-fullscreen")}};"complete"===document.readyState?o():window.addEventListener("load",o);r.div.classList.add(TC.Consts.classes.LOADING,TC.Consts.classes.MAP);r._markerPromises=[];r._layerBuffer={layers:[],contains:function(e){return this.layers.some(function(t){return t.id===e})},getIndex:function(e){return this.layers.reduce(u("id",e),-1)},add:function(e,t,r){const n={id:e,pending:!0,zIndex:t,isBase:r};this.layers.splice(this.getIndexForZIndex(t),0,n)},remove:function(e){this.layers.splice(this.getIndex(e),1)},getMapLayers:function(){return this.layers.filter(e=>!1===e.pending).filter(e=>!e.rejected).map(e=>e.mapLayer)},resolve:function(e,t,r){const n=this.layers[this.getIndex(t.id)];n.mapLayer=t;n.pending=!1;e.layers=this.getMapLayers();if(r){0===e.baseLayers.length&&(e.baseLayers=new Array(e.options.baseLayers.length));if((a=e.options.baseLayers.map(function(e){return e.id}).indexOf(t.id))<0){var a;(a=e.baseLayers.map(function(e){return e.type}).indexOf(TC.Consts.layerType.VECTOR))<0?e.baseLayers.push(t):e.baseLayers.splice(a,0,t)}else e.baseLayers.splice(a,1,t)}else e.workLayers=e.layers.filter(function(e){return!e.isBase})},reject:function(e,t){const r=this.layers[this.getIndex(t.layerId)];r.mapLayer=null;r.pending=!1;r.rejected=!0;var n=e.options.baseLayers.map(e=>e.id).indexOf(t.layerId);n>=0&&e.baseLayers.splice(n,1)},getResolvedWorkLayerIndex:function(e,t){return this.layers.filter(function(e){return e.id===t||!e.isBase&&!1===e.pending}).reduce(u("id",t),-1)},getResolvedVisibleLayerIndex:function(e,t){var r=this.getResolvedWorkLayerIndex(e,t);e.baseLayer&&(r+=1);return r},getIndexForZIndex:function(e){return this.layers.reduce(function(e){return function(t,r,n){return r.zIndex<=e?n:t}}(e),-1)+1},checkMapLoad:function(e){const t=this;if(e.options.baseLayers.concat(e.options.workLayers).every(function(e){return t.contains(e.id||e)})&&!this.layers.some(function(e){return!0===e.pending})){const t=function(){if(!e.isLoaded){const t=function(){e.options.stateful&&function(){const e=this;var t=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE].join(" ");let r=[TC.Consts.event.LAYERUPDATE,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.FEATUREMODIFY,TC.Consts.event.FEATURESADD,TC.Consts.event.FEATURESCLEAR].join(" ");e.on(r,()=>e.trigger(TC.Consts.event.MAPCHANGE));e.replaceCurrent=!0;i.call(e);const n=i.bind(e);e.on(t,n);var a;e.on(TC.Consts.event.LAYEROPACITY,function(t){clearTimeout(a);a=setTimeout(function(){i.call(e,t)},500)});window.addEventListener("popstate",function(r){var a;a=e.loadingCtrl&&e.loadingCtrl.addWait();setTimeout(async function(){if(r){e.off(t,n);var o=r.state;"[object Object]"===Object.prototype.toString.call(o)&&(o=await e.checkLocation());c.call(e,o).then(function(){setTimeout(function(){e.on(t,n)},200);e.loadingCtrl&&e.loadingCtrl.removeWait(a)})}},4)})}.call(e);e.isLoaded=!0;e.div.classList.remove(TC.Consts.classes.LOADING);e.trigger(TC.Consts.event.MAPLOAD)};if(e.state&&e.state.vw3){if(!e.div.classList.contains(TC.Consts.classes.THREED)){e.div.classList.add(TC.Consts.classes.THREED);TC.loadJS(!TC.view||!TC.view.ThreeD,TC.apiLocation+"TC/view/ThreeD",function(){TC.view.ThreeD.apply({map:e,state:e.state.vw3,callback:function(){t();e.getControlsByClass(TC.control.ThreeD)[0].button.removeAttribute("disabled")}})})}}else t()}};if(e.baseLayer)t();else{var r=[];e.state&&e.state.base&&(r=TC.Cfg.availableBaseLayers.filter(function(t){return t.id===e.state.base}));if(r.length>0){r[0].isBase=!0;e.addLayer(r[0]).then(function(e){t()})}else{const r=e.baseLayers.filter(function(e){return!e.mustReproject}).filter(function(e){return e.wrap&&e.wrap.layer});if(r.length>0){e.wrap.setBaseLayer(r[0].wrap.layer);e.baseLayer=r[0]}t()}}}}};r._layerBuffer.layers=[];if(!TC.ready){TC.Cfg=TC.Util.extend({},TC.Defaults,TC.Cfg);TC.ready=!0}if(t&&t.controls&&t.controls.search&&t.controls.search.allowedSearchTypes)for(var p in TC.Cfg.controls.search.allowedSearchTypes)t.controls.search.allowedSearchTypes.hasOwnProperty(p)||(t.controls.search.allowedSearchTypes[p]=!1);t=t||{};C.call(r,t);var T=async function(){r.options.stateful&&(r.state=await r.checkLocation());r.options.layout&&r.trigger(TC.Consts.event.LAYOUTLOAD,{map:r});t&&void 0!==t.workLayers&&(r.options.workLayers=t.workLayers);t&&void 0!==t.baseLayers&&(r.options.baseLayers=t.baseLayers);if(r.options.zoomToFeatures){r.on(TC.Consts.event.FEATURESADD,function e(t){clearTimeout(r._zoomToFeaturesTimeout);r._zoomToFeaturesTimeout=setTimeout(function(){r.zoomToFeatures(t.layer.features,{animate:!1});r.off(TC.Consts.event.FEATURESADD,e)},100)})}r.on(TC.Consts.event.LAYERADD,function e(t){if(t.layer.isBase&&(t.layer===r.baseLayer||r.baseLayer&&t.layer.fallbackLayer&&t.layer.fallbackLayer.id===r.baseLayer.id)){void 0!==r.state&&(r.state.crs?r.loaded(function(){r.setProjection({crs:r.state.crs,extent:r.state.ext})}):r.setExtent(r.state.ext,{animate:!1}));r.off(TC.Consts.event.LAYERADD,e)}});r.crs=r.options.crs;r.initialExtent=r.options.initialExtent;r.maxExtent=r.options.maxExtent;r.defaultInfoContainer=r.options.defaultInfoContainer;r.wrap=new TC.wrap.Map(r);TC.loadJS(!window[TC.Consts.PROJ4JSOBJ],[TC.url.proj4js],function(){TC.loadJSInOrder(!window[TC.Consts.OLNS],[TC.url.ol,TC.url.olConnector],function(){TC.loadProjDef({crs:r.options.crs,callback:function(){r.wrap.setMap();const e=[];for(var t in r.options.controls){var n=r.options.controls[t];if(n){"string"==typeof(n="boolean"==typeof n?{}:TC.Util.extend(!0,{},n)).div&&(n.div=r.div.querySelector("#"+n.div)||n.div);e.push(r.addControl(t,n))}}r.on(TC.Consts.event.BEFORELAYERUPDATE,h);r.on(TC.Consts.event.LAYERUPDATE,m);var a,o;for(a=0;a<r.options.baseLayers.length;a++){"string"==typeof(o=r.options.baseLayers[a])&&(o=f.call(r,o));r.addLayer(TC.Util.extend({},o,{isBase:!0,map:r}))}var s=function(e){e.isRaster()&&!e.names&&e.setVisibility(!1)};r.options.workLayers.map(function(e){return TC.Util.extend({},e,{map:r})}).filter(function(e){return!r.state||!r.state.layers||!r.state.layers.some(function(t){const r=t.u===e.url&&e.layerNames.indexOf(t.n)>=0;r&&(t.id=e.id);return r})}).forEach(function(e){r.addLayer(e).then(s)});r.state&&r.state.layers&&r.state.layers.forEach(function(e){r.addLayer({id:e.id||TC.getUID(),url:TC.Util.isOnCapabilities(e.u,e.u.indexOf(window.location.protocol)<0)||e.u,hideTitle:e.h,layerNames:e.n?e.n.split(","):"",unremovable:e.ur,title:e.t,filter:e.f,renderOptions:{opacity:e.o,hide:!e.v}}).then(function(t){var r=t.wrap.getRootLayerNode();t.title=e.t||r.Title||r.title;this.o<1&&t.setOpacity(this.o);this.v||t.setVisibility(this.v)}.bind(e)).catch(function(e){})});Promise.all(e).finally(function(){r.options.stateful&&r.state&&r.state.ctl&&r.importControlStates(r.state.ctl);r.isReady=!0;r.trigger(TC.Consts.event.MAPREADY)});L(r.div)}})})});r.on(TC.Consts.event.FEATURECLICK,function(e){r.activeControl&&r.activeControl.isExclusive()||e.feature.showInfo()});r.on(TC.Consts.event.NOFEATURECLICK,function(e){e.layer._noFeatureClicked=!0;for(var t=!0,n=0,a=r.workLayers.length;n<a;n++)if(!r.workLayers[n]._noFeatureClicked){t=!1;break}if(t){r.workLayers.forEach(function(e){delete e._noFeatureClicked});r.getControlsByClass(TC.control.Popup).forEach(function(e){e.isVisible()&&e.hide()})}})};d.getMapState=async function(e){var t=await l.call(this,e);return TC.Util.utf8ToBase64(t)};d.getPreviousMapState=function(){return n};d.checkLocation=async function(){const e=this;var t=window.location.hash;if(t&&t.length>1){t=t.substr(1);var r;try{r=await s("unpack",TC.Util.base64ToUtf8(t))}catch(n){try{r=JSON.parse(TC.Util.base64ToUtf8(t))}catch(t){TC.error(TC.Util.getLocaleString(e.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return}}TC.Util.detectIE()&&2047===window.location.href.length&&TC.error(TC.Util.getLocaleString(e.options.locale,"mapStateNotValidForEdge"),TC.Consts.msgErrorMode.TOAST);if(r){var n=!1;if(!r.hasOwnProperty("ext")){n=!0;r.ext=e.options.initialExtent}if(!r.hasOwnProperty("base")){n=!0;r.base=e.options.defaultBaseLayer}if(r.hasOwnProperty("layers"))for(var a=r.layers.length-1;a>=0;a--)if(r.layers[a]&&r.layers[a].hasOwnProperty("u")&&r.layers[a].hasOwnProperty("n")){if(!r.layers[a].hasOwnProperty("o")||!r.layers[a].hasOwnProperty("v")||!r.layers[a].hasOwnProperty("h")){n=!0;TC.Util.extend(r.layers[a],{o:r.layers[a].o||1,v:r.layers[a].v||!0,h:r.layers[a].h||!1})}}else{n=!0;r.layers.length=r.layers.length-1}else{n=!0;r.layers=[]}r.hasOwnProperty("vw3")&&(r.vw3?(!r.vw3.cp||r.vw3.cp&&3!=r.vw3.cp.length||!r.vw3.chpr||r.vw3.chpr&&3!=r.vw3.chpr.length||!r.vw3.bcpd)&&(n=!0):n=!0);n&&TC.error(TC.Util.getLocaleString(e.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return r}TC.error(TC.Util.getLocaleString(e.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}};var h=function(e){if(a<=0){a=0;r.trigger(TC.Consts.event.BEFOREUPDATE)}a+=1},m=function(e){if((a-=1)<=0){a=0;r.trigger(TC.Consts.event.UPDATE)}};TC.i18n=TC.i18n||{};TC.i18n.loadResources=TC.i18n.loadResources||function(e,t,r){var n;if(e)n=new Promise(function(e,n){TC.ajax({url:t+r+".json",method:"GET",responseType:TC.Consts.mimeType.JSON}).then(function(t){const n=t.data;TC.i18n[r]=TC.i18n[r]||{};TC.Util.extend(TC.i18n[r],n);TC.i18n.currentLocale=TC.i18n[r];e()}).catch(function(e){n(e)})});else{TC.i18n.currentLocale=TC.i18n[r];n=Promise.resolve()}return n};const g=r.options.locale;TC.i18n.loadResources(!TC.i18n[g],TC.apiLocation+"TC/resources/",g).finally(function(){if(r.options.layout){var e=r.options.layout;r.trigger(TC.Consts.event.BEFORELAYOUTLOAD,{map:r});var n={},a=!1;if("string"==typeof e){var o=e.trim();o+=o.match(/\/$/)?"":"/";n.config=o+"config.json";n.markup=o+"markup.html";n.style=o+"style.css";n.script=o+"script.js";n.i18n=o+"resources";a=!0}else(e.hasOwnProperty("config")||e.hasOwnProperty("markup")||e.hasOwnProperty("style")||e.hasOwnProperty("script")||e.hasOwnProperty("href")||e.hasOwnProperty("i18n"))&&(n=TC.Util.extend({},e));n.i18n&&(n.i18n+=n.i18n.match(/\/$/)?"":"/");r.layout=n;const s=[],i=function(e,t){this.status=e;this.url=t},l=function(e){if(!a||404!=e.status){const t=TC.Map.get(document.querySelector("."+TC.Consts.classes.MAP));TC.error(TC.Util.getLocaleString(t.options.locale,"urlFailedToLoad",{url:e.url}),[TC.Consts.msgErrorMode.TOAST,TC.Consts.msgErrorMode.EMAIL],"Error al cargar "+e.url)}},c=new Promise(function(e,a){n.config?s.push(fetch(n.config).then(function(e){if(!e.ok)throw new i(e.status,n.config);return e.json()}).then(function(n){e(n.i18n);C.call(r,n,t)}).catch(function(t){t.status&&l(t);e(!1)})):e(!1)});s.push(c);if(n.style){r.div.classList.add("tc-lo");fetch(n.style,{method:navigator.onLine?"HEAD":"GET"}).then(function(e){if(!e.ok)throw new i(e.status,n.style);return e}).then(function(){var e=document.createElement("link");e.rel="stylesheet";e.href=n.style;document.head.appendChild(e)}).catch(function(e){e.status&&l(e)})}n.markup&&s.push(new Promise(function(e,t){fetch(n.markup).then(function(e){if(!e.ok)throw new i(e.status,n.markup);return e.text()}).then(function(t){c.then(function(a){if(a&&g&&n.i18n)TC.i18n.loadResources(!0,n.i18n,g).finally(function(){t=t.replace(/\{\{i18n "([^\}\{]+)"\}\}|\{\{([^\}\{]+)\}\}|\{@i18n \$key="([^\}\{]+)"\/\}/g,function(e,t,r,n){return TC.Util.getLocaleString(g,t||r||n)});r.div.insertAdjacentHTML("beforeend",t);e()});else{r.div.insertAdjacentHTML("beforeend",t);e()}})}).catch(function(t){t.status&&l(t);e()})}));Promise.all(s).finally(function(){n.script?fetch(n.script).then(function(e){if(!e.ok)throw new i(e.status,n.script);return e.blob()}).then(function(e){var t=URL.createObjectURL(e),n=document.createElement("script");n.src=t;n.onload=function(){L(r.div);T()};document.head.appendChild(n)}).catch(function(e){e.status&&l(e);T()}):T()})}else T()});r.on(TC.Consts.event.UPDATEPARAMS,function(e){y(e.layer)});r.on(TC.Consts.event.ZOOM,function(){for(var e=0;e<r.workLayers.length;e++)y(r.workLayers[e])});var v=TC.error;TC.error=function(e,t,n){TC.isDebug&&console.trace&&console.trace();if(t){var a=function(e,t,n){switch(t){case TC.Consts.msgErrorMode.TOAST:if(!r.toast){console.warn("No existe el objeto Toast");return}r.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration});break;case TC.Consts.msgErrorMode.EMAIL:TC.Cfg.loggingErrorsEnabled&&JL("onerrorLogger").fatalException(n?{msg:n,errorMsg:e}:e,null);break;case TC.Consts.msgErrorMode.CONSOLE:default:console.error(e)}};if(Array.isArray(t))for(var o=0;o<t.length;o++)a(e,t[o],n);else a(e,t,n)}else{v(e);r.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration})}}};TC.Map._instances=[];TC.Map.get=function(e){for(var t=0,r=TC.Map._instances.length;t<r;t++){const r=TC.Map._instances[t];if(r.div===e)return r}};TC.inherit(TC.Map,TC.EventTarget);var y=function(e){e.type===TC.Consts.layerType.WMS&&(e.tree=null)},p=function(e,t){var r=Array.prototype.slice.call(e).map(function(e){var r={};e&&(r[t]=e[t]);return r});"availableBaseLayers"===t&&console.log("layerOptions",r);var n={};n[t]=TC.Cfg[t];r.unshift(n);if("baseLayers"===t&&r[1].baseLayers){n=r[1];for(var a=0;a<n.baseLayers.length;a++)"object"==typeof n.baseLayers[a]&&TC.Util.extend(n.baseLayers[a],f.call(this,n.baseLayers[a].id))}else{r.unshift(!0);n=TC.Util.extend.apply(this,r);"availableBaseLayers"===t&&console.log("layerOption",n)}return n[t]};const C=function(){const e=[!0,{},TC.Cfg].concat(Array.prototype.slice.call(arguments)),t=this.options=TC.Util.extend.apply(this,e);t.availableBaseLayers=TC.Cfg.availableBaseLayers.concat.apply(TC.Cfg.availableBaseLayers,Array.prototype.map.call(arguments,function(e){return e.availableBaseLayers||[]}));t.baseLayers=p.call(this,arguments,"baseLayers");t.workLayers=p.call(this,arguments,"workLayers");const r=Array.prototype.slice.call(arguments).filter(e=>e.controls).map(e=>e.controls);r.length>0&&(t.controls=TC.Util.extend(!0,t.controls,function(e){e.controlContainer&&(Array.isArray(e.controlContainer.controls)?e.controlContainer.controls.forEach(t=>{Object.keys(t).filter(e=>"position"!==e).forEach(r=>{if(void 0!==e[r]){"boolean"==typeof t[r]&&(t[r]={});TC.Util.extend(t[r],e[r]);delete e[r]}})}):Object.keys(e).filter(function(t){return Object.keys(e.controlContainer.controls).indexOf(t)>-1}).forEach(function(t){const r=e.controlContainer.controls[t];"boolean"==typeof r.options&&(r.options={});TC.Util.extend(r.options,e[t]);delete e[t]}));return e}(TC.Util.extend(!0,r[0],r[1]))));return t};var d=TC.Map.prototype,T=function(e,t){var r,n='Layer "'+t.title+'" ("'+t.names+'"): ';r=t.isValidFromNames()?"layerSrsNotCompatible":"layerNameNotValid";n+=TC.Util.getLocaleString(e.options.locale,r);TC.error(n);e.trigger(TC.Consts.event.LAYERERROR,{layer:t,reason:r})};d.getCRS=function(){const e=this;return e.on3DView?e.view3D.crs:e.crs};d.addLayer=function(e,t){const r=this,n=new Promise(function(t,n){w(e);"object"!=typeof e||e.id||(e.id=TC.getUID());let o=e.options?e.options.zIndex:e.zIndex;"number"!=typeof o&&(o=e.stealth?1:0);r._layerBuffer.add(e.id||e,o,e.isBase);if(r.getLayer(e.id)){const t=Error(`Layer "${e.id}" already exists`);t.layerId=e.id;n(t)}else{var s,i,l;if(w(e)){i=!TC.layer||!TC.layer.Raster;l=TC.apiLocation+"TC/layer/Raster"}else{i=!TC.layer||!TC.layer.Vector;l=TC.apiLocation+"TC/layer/Vector"}TC.loadJS(i,[l],function(){if("string"==typeof e)s=new TC.layer.Raster(TC.Util.extend({},f.call(r,e),{map:r}));else if(e instanceof TC.Layer)(s=e).map=r;else{e.map=r;s=e.type===TC.Consts.layerType.VECTOR||e.type===TC.Consts.layerType.KML||e.type===TC.Consts.layerType.WFS?new TC.layer.Vector(e):new TC.layer.Raster(e)}Promise.all([r.wrap.getMap(),s.wrap.getLayer()]).then(function(){r.trigger(TC.Consts.event.BEFORELAYERADD,{layer:s});var o;if(w(s)){!function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){if("404"!=t.error.code){const r=this;if(!r._tileloaderror){const n=e.getPath(),a=n.length?n[n.length-1]:e.title;e.map.toast(TC.Util.getLocaleString(e.map.options.locale,"tileload.error",{name:a,error:t.error.text}),{type:TC.Consts.msgType.ERROR});r._tileloaderror=!0;const o=function(e){if(e.tile.src&&e.tile.src!==TC.Consts.BLANK_IMAGE){delete r._tileloaderror;r.$events.off(TC.Consts.event.TILELOAD,o)}};r.$events.on(TC.Consts.event.TILELOAD,o)}}})}(s);o=r.wrap.indexOfFirstVector()}-1===o&&(o=r.wrap.getLayerCount());const i=r.state&&r.state.crs?r.state.crs:r.getCRS();TC.loadProjDef({crs:i,callback:function(){const o=s.isCompatible(i);if(s.isBase){if(!o)if(!s.type===TC.Consts.layerType.WMTS)s.mustReproject=!0;else{const e=s.wrap.getCompatibleMatrixSets(i)[0];e?s.wrap.setMatrixSet(e):s.mustReproject=!0}r.state?s.isDefault=r.state.base===s.id||r.state.base===s.options.fallbackLayer:"string"==typeof r.options.defaultBaseLayer?s.isDefault=r.options.defaultBaseLayer===s.id:"number"==typeof r.options.defaultBaseLayer&&(s.isDefault=r.options.defaultBaseLayer===r.baseLayers.length);if(s.isDefault){var l;if(s.mustReproject&&!s.type===TC.Consts.layerType.WMTS||s.mustReproject&&s.type===TC.Consts.layerType.WMTS&&!s.wrap.getCompatibleMatrixSets(i)[0])if(s.options.fallbackLayer&&s.getFallbackLayer)r.addLayer(s.getFallbackLayer()).then(function(e){r.wrap.setBaseLayer(e.wrap.layer);r.baseLayer=e.wrap.parent;a(l);t(s)});else{T(r,s);const t=Error("Layer "+s.id+" incompatible with CRS");t.layerId=e.id;n(t)}else{l=null===r.baseLayer;s.wrap.getLayer().then(function(e){r.wrap.setBaseLayer(e);r.baseLayer=s;a(l);t(s)})}}else t(s)}else if(o)s.wrap.getLayer().then(function(e){t(s)});else{T(r,s);if(s.isValidFromNames()){const t=Error("Layer "+s.id+" incompatible with CRS");t.layerId=e.id;n(t)}else{const t=Error("Layer "+(s.layerNames?s.layerNames.join(" "):s.id)+" not in capabilities");t.layerId=e.id;n(t)}}}})},function(t){t.layerId=e.id;n(t)})})}});n.then(function(e){r._layerBuffer.resolve(r,e,e.isBase);e.isBase||r.wrap.insertLayer(e.wrap.layer,r._layerBuffer.getResolvedVisibleLayerIndex(r,e.id));r.trigger(TC.Consts.event.LAYERADD,{layer:e});r._layerBuffer.checkMapLoad(r);TC.Util.isFunction(t)&&t(e)},function(e){r._layerBuffer.reject(r,e);r._layerBuffer.checkMapLoad(r)});const a=function(e){if(e){var t={projection:r.wrap.map.getView().getProjection(),extent:r.initialExtent},n=r.baseLayer.getResolutions();if(n&&n.length)t.resolutions=n;else{t.minZoom=r.wrap.map.getView().getMinZoom();t.maxZoom=r.wrap.map.getView().getMaxZoom();var a=r.baseLayer.wrap.layer.getMinResolution();0!==a&&(t.minResolution=a);var o=r.baseLayer.wrap.layer.getMaxResolution();o!==Number.POSITIVE_INFINITY&&(t.maxResolution=o)}r.wrap.map.setView(new ol.View(t));r.wrap.map.getView().fit(r.initialExtent)}};return n};d.removeLayer=function(e){const t=this;return new Promise(function(r,n){if(e.unremovable)return n("Unremovable");let a=!1;for(var o=0;o<t.layers.length;o++)if(t.layers[o]===e){t.layers.splice(o,1);a=!0;break}if(a){if(e.isBase){for(o=0;o<t.baseLayers.length;o++)if(t.baseLayers[o]===e){t.baseLayers.splice(o,1);t.baseLayer===e&&t.setBaseLayer(t.baseLayers[0]);break}}else{for(o=0;o<t.workLayers.length;o++)if(t.workLayers[o]===e){t.workLayers.splice(o,1);break}e===t.vectors&&(t.vectors=null)}e.wrap.getLayer().then(function(n){t.wrap.removeLayer(n);t._layerBuffer.remove(e.id);t.trigger(TC.Consts.event.LAYERREMOVE,{layer:e});t._layerBuffer.checkMapLoad(t);r(e)})}else n(new Error(`Layer ${e.id} not found in map`))})};d.insertLayer=function(e,t,r){const n=this;return new Promise(function(a,o){for(var s=-1,i=0;i<n.layers.length;i++)if(e===n.layers[i]){s=i;break}var l=[];l.push(e.wrap.getLayer());var c=n.layers[t];c&&l.push(c.wrap.getLayer());Promise.all(l).then(function(o){const i=o[0],l=o[1];var c=-1;if((c=l?n.wrap.getLayerIndex(l):n.wrap.getLayerCount())>=0){e.map=n;n.wrap.insertLayer(i,c);s>-1&&n.layers.splice(s,1);n.layers.splice(t,0,e);n.workLayers=n.layers.filter(function(e){return!e.isBase});n.trigger(TC.Consts.event.LAYERORDER,{layer:e,oldIndex:s,newIndex:t})}TC.Util.isFunction(r)&&r();a(e)})})};d.setLayerIndex=function(e,t){this.wrap.setLayerIndex(e.wrap.layer,t)};d.putLayerOnTop=function(e){var t=this.wrap.getLayerCount();this.setLayerIndex(e,t-1)};d.setBaseLayer=async function(e,t){var r=null,n=!1;if("string"==typeof e){var a;for(a=0;a<this.layers.length;a++)if(this.layers[a].id===e){e=this.layers[a];n=!0;break}if(!n&&(e=f.call(this,e))){e=await this.addLayer(TC.Util.extend(!0,{},e,{isDefault:!0,map:this}));n=!0}}else{if(this.layers.indexOf(e)<0){e.isDefault=!0;e.map=this;this.addLayer(e)}n=!0}if(n)if(e.isCompatible(this.getCRS())||e.fallbackLayer&&(!e.fallbackLayer||e.fallbackLayer.isCompatible(this.getCRS()))){this.trigger(TC.Consts.event.BEFOREBASELAYERCHANGE,{oldLayer:this.getBaseLayer(),newLayer:e});r=e;await this.wrap.getMap();const n=await e.wrap.getLayer();await this.wrap.setBaseLayer(n);this.baseLayer=e;this.trigger(TC.Consts.event.BASELAYERCHANGE,{layer:e});TC.Util.isFunction(t)&&t()}else TC.error("Base layer must be reprojected");else TC.error("Base layer is not available");return r};d.setView=function(e){this.view=e;this.trigger(TC.Consts.event.VIEWCHANGE,{view:e})};d.ready=function(e){TC.Util.isFunction(e)&&(this.isReady?e():this.one(TC.Consts.event.MAPREADY,e))};d.loaded=function(e){TC.Util.isFunction(e)&&(this.isLoaded?e():this.one(TC.Consts.event.MAPLOAD,e))};d.getLayerTree=function(){var e={baseLayers:[],workLayers:[]};this.baseLayer&&(e.baseLayers[0]=this.baseLayer.getTree());for(var t=0;t<this.workLayers.length;t++){var r=this.workLayers[t].getTree();r&&e.workLayers.unshift(r)}return e};d.addControl=function(e,t){const r=this;return new Promise(function(n,a){const o=function(e){r.controls.push(e);return Promise.resolve(e.register(r)).then(function(t){e.div.parentElement||r.div.appendChild(e.div);r.trigger(TC.Consts.event.CONTROLADD,{control:e});return t}).catch(function(e){a(e instanceof Error?e:Error(e))})};if("string"==typeof e){e=e.substr(0,1).toUpperCase()+e.substr(1);TC.loadJS(!TC.Control||!TC.control[e],[TC.apiLocation+"TC/control/"+e],function(){o(new TC.control[e](null,t)).then(function(e){n(e)})})}else o(e).then(function(e){n(e)})})};d.getControlsByClass=function(e){var t=[],r=e;if("string"==typeof e){r=window;for(var n=e.split("."),a=0;a<n.length&&(r=r[n[a]]);a++);}if(TC.Util.isFunction(r))for(a=0;a<this.controls.length;a++){var o=this.controls[a];o instanceof r&&t.push(o)}return t};d.getControlById=function(e){const t=this;for(var r=0,n=t.controls.length;r<n;r++){const n=t.controls[r];if(n.id===e)return n}return null};d.getDefaultControl=function(){const e=this;var t;e.options.defaultActiveControl&&(t=e.getControlsByClass("TC.control."+e.options.defaultActiveControl.substr(0,1).toUpperCase()+e.options.defaultActiveControl.substr(1))[0]);t||(t=(t=e.getControlsByClass("TC.control.MultiFeatureInfo")[0])?t.lastCtrlActive:e.getControlsByClass("TC.control.FeatureInfo")[0]);return t};d.getLoadingIndicator=function(){var e=null,t=this.getControlsByClass("TC.control.LoadingIndicator");t.length&&(e=t[0]);return e};d.setExtent=function(e,t){return this.wrap.setExtent(e,t)};d.getExtent=function(){return this.wrap.getExtent()};d.setCenter=function(e,t){return this.wrap.setCenter(e,t)};d.getCenter=function(){return this.wrap.getCenter()};d.setRotation=function(e){this.wrap.setRotation(e)};d.getRotation=function(){return this.wrap.getRotation()};d.getViewHTML=function(){return this.wrap.getViewport()};d.getCompatibleCRS=function(e){const t=((e=e||{}).layers||this.workLayers.concat(this.baseLayer)).filter(function(e){return e.isRaster()}).map(function(t){return t.getCompatibleCRS({normalized:!0,includeFallback:e.includeFallbacks})}),r=t.slice(1);return t[0].filter(function(e){return r.every(function(t){return t.indexOf(e)>=0})})};d.loadProjections=function(e){e=e||{};return new Promise(function(t,r){const n=e.crsList||[];Promise.all(n.map(function(e){return TC.getProjectionData({crs:TC.Util.getCRSCode(e)})})).then(function(r){var n=r.filter(function(e){return"ok"===e.status&&e.number_result>0}).map(function(e){const t=e.results[0],r="EPSG:"+t.code;TC.loadProjDef({crs:r,def:t.def,name:t.name});return{code:r,name:t.name,proj4:t.proj4,unit:t.unit}});e.orderBy&&(n=n.sort(TC.Util.getSorterByProperty(e.orderBy)));t(n)},function(e){r(e)})})};d.setProjection=function(e){const t=this;e=e||{};return new Promise(function(r,n){var a;if(e.crs){e.baseLayer?a=e.baseLayer:e.allowFallbackLayer&&(t.baseLayer.isCompatible(e.crs)||0!==t.baseLayer.wrap.getCompatibleMatrixSets(e.crs).length?t.baseLayer.firstOption&&(t.baseLayer.firstOption.isCompatible(e.crs)||t.baseLayer.firstOption.wrap.getCompatibleMatrixSets(e.crs).length>0)&&(a=t.baseLayer.firstOption):t.baseLayer.options.fallbackLayer&&(a=t.baseLayer.getFallbackLayer()));a||(a=t.baseLayer);const o=function(){TC.loadProjDef({crs:e.crs,callback:function(){const o=t.crs,s=function(a){const i=function(){const i=TC.Util.extend({},e,{oldCrs:t.crs}),l=function(e){e.setProjection(i)};if(a.isCompatible(e.crs)||a.wrap.getCompatibleMatrixSets(e.crs).length>0){a.setProjection(i);t.wrap.setProjection(TC.Util.extend({},e,{baseLayer:a}));t.crs=e.crs;t.baseLayers.filter(function(e){return e!==a}).forEach(l);t.workLayers.forEach(l);const n=function(){t.trigger(TC.Consts.event.PROJECTIONCHANGE,{oldCrs:o,newCrs:e.crs});r()};a&&a!==t.baseLayer?t.setBaseLayer(a,n):n()}else a.fallbackLayer?s(a.fallbackLayer):n(Error("Layer has no fallback"))};a.type===TC.Consts.layerType.WMS||a.type===TC.Consts.layerType.WMTS?a.getCapabilitiesPromise().then(i):i()};s(a)}})};t.baseLayers.indexOf(a)<0?t.addLayer(a).then(o):o()}})};d.getMetersPerUnit=function(){return this.wrap.getMetersPerUnit()};d.getCoordinateFromPixel=function(e){return this.wrap.getCoordinateFromPixel(e)};d.getPixelFromCoordinate=function(e){return this.wrap.getPixelFromCoordinate(e)};d.zoomToFeatures=function(e,t){if(e.length>0){var r=[1/0,1/0,-1/0,-1/0],n=t||{},a=n.pointBoundsRadius||this.options.pointBoundsRadius;a/=this.getMetersPerUnit();var o=n.extentMargin;"number"!=typeof o&&(o=this.options.extentMargin);for(var s=0;s<e.length;s++){var i=e[s].getBounds();if(i){r[0]=Math.min(r[0],i[0]);r[1]=Math.min(r[1],i[1]);r[2]=Math.max(r[2],i[2]);r[3]=Math.max(r[3],i[3])}}if(r[2]-r[0]==0){r[0]=r[0]-a;r[2]=r[2]+a}if(r[3]-r[1]==0){r[1]=r[1]-a;r[3]=r[3]+a}if(o){var l=(r[2]-r[0])*o/2,c=(r[3]-r[1])*o/2;r[0]=r[0]-l;r[1]=r[1]-c;r[2]=r[2]+l;r[3]=r[3]+c}if(this.options.maxExtent){r[0]=Math.max(r[0],this.options.maxExtent[0]);r[1]=Math.max(r[1],this.options.maxExtent[1]);r[2]=Math.min(r[2],this.options.maxExtent[2]);r[3]=Math.min(r[3],this.options.maxExtent[3])}this.wrap.setExtent(r,n);this.trigger(TC.Consts.event.ZOOMTO,{extent:r})}};d.zoomToMarkers=function(e){var t=this;Promise.all(t._markerPromises).then(function(){for(var r=[],n=0;n<t.workLayers.length;n++){var a=t.workLayers[n];if(a.type===TC.Consts.layerType.VECTOR)for(var o=0;o<a.features.length;o++){var s=a.features[o];s instanceof TC.feature.Marker&&r.push(s)}}t.zoomToFeatures(r,e);t._markerPromises=[]})};d.zoomToLayer=function(e,t){const r=this;if((e=r.getLayer(e)).isRaster()){const n=e.getExtent();if(n){"number"!=typeof(t=t||{}).extentMargin&&(t.extentMargin=r.options.extentMargin);r.setExtent(n,t)}}else e.features&&e.features.length&&r.zoomToFeatures(e.features,t)};d.getLayer=function(e){const t=this;var r=null;if("string"==typeof e){for(var n=0;n<t.layers.length;n++)if(t.layers[n].id===e){r=t.layers[n];break}}else TC.Layer&&e instanceof TC.Layer&&e.map===t&&(r=e);return r};var h=function(e){var t;if(e.vectors)t=Promise.resolve(e.vectors);else{t=e.addLayer({id:TC.getUID(),title:TC.i18n[e.options.locale].vectors,type:TC.Consts.layerType.VECTOR});e.vectors=t;t.then(function(t){e.vectors=t})}return t};d.addPoint=function(e,t){if(t&&t.layer){var r=this.getLayer(t.layer);if(!r)throw new Error('Layer "'+t.layer+'" not found');r.addPoint(e,t)}else h(this).then(function(r){r.addPoint(e,t)})};d.addMarker=function(e,t){var r=this;if(t&&t.layer){var n=r.getLayer(t.layer);n?r._markerPromises.push(n.addMarker(e,t)):r._markerPromises.push(Promise.reject(new Error('Layer "'+t.layer+'" not found')))}else r._markerPromises.push(new Promise(function(n,a){h(r).then(function(r){r.addMarker(e,t).then(function(e){n(e)})})}))};d.addPolyline=function(e,t){if(t&&t.layer){if(!this.getLayer(t.layer))throw new Error('Layer "'+t.layer+'" not found');t.layer.addPolyline(e,t)}else h(this).then(function(r){r.addPolyline(e,t)})};d.addPolygon=function(e,t){if(t&&t.layer){if(!this.getLayer(t.layer))throw new Error('Layer "'+t.layer+'" not found');t.layer.addPolygon(e,t)}else h(this).then(function(r){r.addPolygon(e,t)})};d.getBaseLayer=function(){return this.baseLayer||this.baseLayers[0]};d.getResolutions=function(){return this.wrap.getResolutions()};d.getResolution=function(){return this.wrap.getResolution()};d.setResolution=function(e){this.wrap.setResolution(e)};d.exportFeatures=async function(e,t){t=t||{};var r=this.getLoadingIndicator(),n=r&&r.addWait();const a=t.format===TC.Consts.format.GPX?Number.NaN:0;e.forEach(function(t,r){const n=t.getData();for(let e in n)if(/&(\w+|#\d{2,4});/g.test(e)){const r=n[e],a={},o=document.createElement("div");o.innerHTML=e;a[o.innerText]=r;t.unsetData(e);t.setData(a)}var o=t.getCoords({pointArray:!0});if(o.some(function(e){return null===e[2]})){const n=t.clone();n.setId(t.id);e[r]=t=n;(o=t.getCoords({pointArray:!0})).forEach(function(e){null===e[2]&&(e[2]=a)})}});const o=t.format||"";if(o===TC.Consts.format.SHP){const a="ISO-8859-1";var s=e.reduce(function(e,t){var r=t.id.substr(0,t.id.lastIndexOf("."));(e[r]=e[r]||[]).push(t);return e},{});const o=function(e){switch(!0){case"TC.feature.Point"===e:return"POINT";case"TC.feature.Polygon"===e:case"TC.feature.MultiPolygon"===e:return"POLYGON";case"TC.feature.Polyline"===e:case"TC.feature.MultiPolyline"===e:return"POLYLINE"}return"NULL"},f=await TC.getProjectionData({crs:this.crs});var i=[];for(var l in s){var c=c=s[l].reduce(function(e,t){(e[t.CLASSNAME]=e[t.CLASSNAME]||[]).push(t);return e},{});for(var u in c)i.push(new Promise(function(e){const r=u,n=c[r],a=n.reduce(function(e,t){for(var r in t.data){const e=t.data[r];t.data[r]="string"==typeof e?e.replace(/\\u2022/g,"&bull;"):e}return e.concat([t.data])},[]),s=n.reduce(function(e,t){t instanceof TC.feature.Polyline&&(t=new TC.feature.MultiPolyline(t.getCoords(),t.options));return e.concat([t.geometry])},[]);TC.loadJS(!window.shpWrite,TC.apiLocation+"lib/shp-write/shp-write",async function(){shpWrite.write(a,o(r),s,async function(n,a){const s=t.fileName.substring(t.fileName.lastIndexOf("_",t.fileName.lastIndexOf("_")-1)+1),i=l+(Object.keys(c).length>1?"_"+o(r):"")+(s?"_"+s:"");e({fileName:i,content:a})})})}))}Promise.all(i).then(function(e){TC.loadJS(!window.JSZip,TC.apiLocation+"lib/jszip/jszip",async function(){const o=new JSZip;for(var s=0;s<e.length;s++){o.file(e[s].fileName+".shp",e[s].content.shp.buffer);o.file(e[s].fileName+".shx",e[s].content.shx.buffer);o.file(e[s].fileName+".dbf",e[s].content.dbf.buffer);o.file(e[s].fileName+".prj",f.results[0].wkt);o.file(e[s].fileName+".cst",a);o.file(e[s].fileName+".cpg",a)}o.generateAsync({type:"blob"}).then(function(e){TC.Util.downloadBlob(t.fileName+".zip",e);r&&r.removeWait(n)},function(e){r&&r.removeWait(n);throw e})})});return}if(o===TC.Consts.format.GPKG){const a=function(e){var t="";switch(typeof e){case"string":t=geopackage.DataTypes.GPKG_DT_TEXT_NAME;break;case"number":t=e%1==0?geopackage.DataTypes.GPKG_DT_INTEGER_NAME:geopackage.DataTypes.GPKG_DT_FLOAT_NAME;break;case"boolean":t=geopackage.DataTypes.GPKG_DT_BOOLEAN_NAME;break;default:t=geopackage.DataTypes.GPKG_DT_TEXT_NAME}return geopackage.DataTypes.fromName(t)},o=this.crs;TC.loadJS(!window.geopackage,[TC.apiLocation+"lib/geopackage/geopackage.min.js"],function(){TC.loadJS(!window.require||!require("wkx"),[TC.apiLocation+"lib/wkx/wkx"],async function(){geopackage.create().then(async function(s){var i=[],l=o.substr(o.indexOf(":")+1);if(!s.getSpatialReferenceSystemDao().queryForId(l)){var c=s.getSpatialReferenceSystemDao(),u=c.createObject(),f=await TC.getProjectionData({crs:o});u.srs_name=o;u.srs_id=f.results[0].code;u.organization=o.substr(0,o.indexOf(":"));u.organization_coordsys_id=f.results[0].code;u.definition=f.results[0].proj4.trim();u.definition_12_063=f.results[0].wkt.trim();u.description=f.results[0].name;c.create(u)}const y=t.fileName.substring(t.fileName.lastIndexOf("_",t.fileName.lastIndexOf("_")-1)+1);var p=e.reduce(function(e,t){var r=t.id.substr(0,t.id.lastIndexOf("."));(e[r]=e[r]||[]).push(t);return e},{});for(var C in p){var d=p[C].reduce(function(e,t){(e[t.CLASSNAME]=e[t.CLASSNAME]||[]).push(t);return e},{});for(var T in d)i.push(new Promise(async function(t){const r=d[T];var n=geopackage.FeatureColumn,o=geopackage.GeometryColumns,i=0;const c=r[0].CLASSNAME.substr(r[0].CLASSNAME.lastIndexOf(".")+1).replace("Polyline","LineString").replace("Marker","Point"),u=C+(Object.keys(d).length>1?"_"+c:"")+(y?"_"+y:"");var f=[];e[0].data.hasOwnProperty("id")||e[0].data.hasOwnProperty("ID")||f.push(n.createPrimaryKeyColumnWithIndexAndName(i++,"id"));f.push(n.createGeometryColumn(i++,"geometry",c.toUpperCase(),!0,null));for(var p=[1/0,1/0,-1/0,-1/0],h=0;h<r.length;h++){var m=r[h].getBounds();if(m){p[0]=Math.min(p[0],m[0]);p[1]=Math.min(p[1],m[1]);p[2]=Math.max(p[2],m[2]);p[3]=Math.max(p[3],m[3])}}for(var g in r[0].data||r[0].attributes){var v=r[0].attributes&&r[0].attributes[g]?r[0].attributes[g].name:g,L=r[0].data[v];f.push(n.createColumnWithIndex(i++,v,a(L)))}var w=new o;w.table_name=u;w.column_name="geometry";w.geometry_type_name=c.toUpperCase();w.z=r[0].getGeometryStride();w.m=2;w.srs_id=l;i=0;const E=new geopackage.BoundingBox(p[0],p[2],p[1],p[3]);geopackage.createFeatureTableWithDataColumnsAndBoundingBox(s,u,w,f,null,E,l).then(function(){const e=s.getFeatureDao(u);var n=require("wkx");for(let t=0;t<r.length;t++){const s=r[t],c=e.newRow(),u=new geopackage.GeometryData;u.setSrsId(l);const f=n.Geometry.parse("SRID="+l+";"+(new ol.format.WKT).writeFeature(s.wrap.feature));u.setGeometry(f);c.setGeometry(u);s.data.hasOwnProperty("id")||s.data.hasOwnProperty("ID")||c.setValueWithColumnName("id",t);for(var a in s.data||s.attributes){var o=r[0].attributes&&r[0].attributes[a]?r[0].attributes[g].name:a,i=s.data[o];c.setValueWithColumnName(o,i)}e.create(c)}t()})}))}Promise.all(i).then(function(e){s.export(function(e,a){TC.Util.downloadFile(t.fileName+".gpkg","application/geopackage+sqlite3",a);r&&r.removeWait(n)})})})})});return}const f=this.wrap.exportFeatures(e,t),y=TC.Consts.mimeType[t.format];if(o===TC.Consts.format.KMZ)TC.loadJS(!window.JSZip,TC.apiLocation+"lib/jszip/jszip",async function(){const e=new JSZip;let a=TC.Util.replaceSpecialCharacters(t.fileName||TC.getUID());e.file(a+".kml",f);e.generateAsync({type:"blob",mimeType:y}).then(function(e){filename=a+".kmz";TC.Util.downloadBlob(filename,e);r&&r.removeWait(n)})});else{TC.Util.downloadFile((t.fileName||TC.getUID())+"."+o.toLowerCase(),y,f);r&&r.removeWait(n)}};d.exportControlStates=function(){return this.controls.map(function(e){return e.exportState()}).filter(function(e){if(e)for(var t in e)if(e.hasOwnProperty(t))return!0;return!1})};d.importControlStates=function(e){const t=this;e.forEach(function(e){const r=t.getControlById(e.id);r&&t.loaded(function(){r.importState(e)})})};var m={},g=function(){const e=this;var t=e;do{t=t.parentElement}while(t&&!t.matches(".tc-toast-container"));const r=e.innerHTML;e.classList.add(TC.Consts.classes.HIDDEN);void 0!==m[r]&&(m[r]=void 0);setTimeout(function(){e.parentElement&&e.parentElement.removeChild(e);t&&!t.querySelector(".tc-toast")&&t.parentElement&&t.parentElement.removeChild(t)},1e3)};d.toastHide=function(e){var t=m[e];if(t){clearTimeout(t.timeout);t.toast&&t.toast.parentElement&&t.toast.parentElement.removeChild(t.toast);t.toast=null}};d.toast=function(e,t){const r=this;var n=t||{},a=n.duration||TC.Cfg.toastDuration,o=m[e];if(o){clearTimeout(o.timeout);o.toast&&o.toast.parentElement&&o.toast.parentElement.removeChild(o.toast);o.toast=null}var s=r.div.querySelector(".tc-toast-container");if(!s){(s=document.createElement("div")).classList.add("tc-toast-container");(n.container?n.container:r.div).appendChild(s)}const i=document.createElement("div"),l=document.createElement("span");i.classList.add("tc-toast");i.appendChild(l);const c=document.createElement("p");c.innerHTML=e;i.appendChild(c);i.addEventListener(TC.Consts.event.CLICK,g,{passive:!0});s.appendChild(i);o=m[e]={toast:i};var u="";switch(n.type){case TC.Consts.msgType.INFO:u=TC.Consts.classes.INFO;break;case TC.Consts.msgType.WARNING:u=TC.Consts.classes.WARNING;break;case TC.Consts.msgType.ERROR:u=TC.Consts.classes.ERROR}u.length&&o.toast.classList.add(u);o.timeout=setTimeout(function(){g.call(o.toast)},a)};var v=!1,L=function(e){if(/iPad/i.test(navigator.userAgent)){var t=window.innerHeight;e.getBoundingClientRect.height===t+(matchMedia("only screen and (orientation : landscape)").matches?20:0)&&(v=!0)}var r=function(){e.classList.toggle(TC.Consts.classes.IPAD_IOS7_FIX,matchMedia("only screen and (orientation : landscape)").matches)};if(v){r();window.addEventListener("resize",r)}else window.removeEventListener("resize",r)},w=function(e){return"string"==typeof e||e.type!==TC.Consts.layerType.VECTOR&&e.type!==TC.Consts.layerType.KML&&e.type!==TC.Consts.layerType.WFS};d.exportImage=function(){var e=null,t="El mapa actual no es compatible con la exportaci\xf3n de im\xe1genes",r=this.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0];if(r&&this.options.crossOrigin)try{e=r.toDataURL()}catch(e){TC.error(t+": "+e.message)}else TC.error(t);return e};d.getElevationTool=function(){const e=this;return e.elevation||e.options.elevation?e.elevation?Promise.resolve(e.elevation):new Promise(function(t,r){TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){if(e.options.elevation){const t="boolean"==typeof e.options.elevation?{}:e.options.elevation;t.services&&e.options.googleMapsKey&&(t.services=t.services.map(function(t){const r="string"==typeof t,n=r?t:t.name;return"elevationServiceGoogle"===n?TC.Util.extend({name:n,googleMapsKey:e.options.googleMapsKey},r?{}:t):t}));e.elevation=new TC.tool.Elevation(t)}else e.elevation=null;t(e.elevation)})}):Promise.resolve(null)};const E=function(e,t,r){return new Promise(async function(n,a){try{var o=await e.describeFeatureType(t)}catch(e){a(e);return}var s={};if(1===t.length){var i={};i[t[0]]=o;o=i}for(var l in o){let e;var c=[];for(var u in o[l])!TC.Util.isGeometry(o[l][u].type)||o[l][u].nillable||o[l][u].minOccurs||c.push(u);if(c.length<=1){var f=(e,t)=>{if(e instanceof TC.filter.LogicalNary)e.conditions.forEach(e=>{f(e,t)});else if(e instanceof TC.filter.Spatial){e.geometryName=t;return e}};e=Object.assign(new r.constructor,f(r,0===c.length?null:c[0]))}else if(c.length>1){f=((e,t)=>{if(e instanceof TC.filter.LogicalNary)e.conditions.forEach(e=>{f(e,t)});else if(e instanceof TC.filter.Spatial)return TC.filter.or.apply(null,t.reduce((t,r)=>{t.push(new(TC.filter[e.getTagName()])(r,e.geometry,e.srsName));return t},[]))});e=Object.assign(new r.constructor,f(r,c))}s[l]=e}n(s)})};d.extractFeatures=function(e){const t=this,r=[],n=(e=e||{}).filter,a=e.outputFormat,o=e.download,s=e.layers||t.layers,i={},l=function(e){const t=e.mapLayers[0];return e.title||e.mapLayers.reduce(function(e,t){return e||t.title},"")||t.tree&&t.tree.title||t.capabilities.Service.Title},c=function(){return!o||a!==TC.Consts.mimeType.JSON&&a!==TC.Consts.mimeType.KML?t.getCRS():TC.Consts.SRSDOWNLOAD_GEOJSON_KML},u=function(e,t){return new Promise(function(r){o?e.mapLayer.toolProxification.cacheHost.getAction(e.url).then(function(n){r({url:n.action(e.url),data:t})}):function(e,t){return new Promise(function(r){e.mapLayer.toolProxification.fetch(e.url,{data:t,contentType:"application/xml",type:"POST"}).then(function(e){if(e instanceof XMLDocument){const t=e.querySelector("ExceptionReport Exception");if(t){r({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.getAttribute("exceptionCode"),errorThrown:t.querySelector("ExceptionText").textContent}}]});return}}r({response:e})}).catch(function(e){r({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:e.name,errorThrown:e.message}}]})})})}(e,t).then(function(e){if(e.errors&&e.errors.length>0){e.errors[0].params.serviceTitle=service.mapLayers.reduce(function(e,t){return e||t.title},"")||l(service);r(e)}else r(e)})})};s.forEach(function(e){if(!e.getVisibility()||t.workLayers.indexOf(e)<0||e.type!==TC.Consts.layerType.WMS)return;var s=e.getDisgregatedLayerNames()||e.availableNames;const f=e.url.toLowerCase();var y=i[f];y||(y=i[f]={url:f,layers:[],mapLayers:[e],layerNames:[]});for(var p=0;p<s.length;p++){var C=s[p];if(e.wrap.getInfo(C).queryable){y.layerNames.push(C);var d=e.getPath(C);y.layers.push({name:C,title:d[d.length-1],path:d.slice(1),features:[]})}}if(0!=y.layerNames.length&&void 0===y.request){y.request=y.request||e.getWFSCapabilities();r.push(new Promise(function(e,t){y.request.then(function(t){var r=null,s=[];for(var f in i)i[f].request&&i[f].request==y.request&&(r=i[f]);var p=null,C=r.layerNames;if(C instanceof Array&&C.length)if(void 0!==t.Operations.GetFeature){for(var d=[],T=0;T<C.length;T++){for(var h=C[T];"_"===h[h.length-1];)h=h.substring(0,h.lastIndexOf("_"));if(t.FeatureTypes.hasOwnProperty(h.substring(C[T].indexOf(":")+1)))d.indexOf(h)<0&&d.push(h);else{var m=r.mapLayers[0].getPath(h.substring(C[T].indexOf(":")+1));s.push({key:TC.Consts.WFSErrors.LAYERS_NOT_AVAILABLE,params:{serviceTitle:l(r),layerName:m[m.length-1]}})}}if(0!=d.length){t.Operations.GetFeature.CountDefault&&(p=t.Operations.GetFeature.CountDefault.DefaultValue);if("1.0.0"===t.version&&!t.Operations.GetFeature.Operations.hasOwnProperty("Query")||("2.0.0"===t.version||"1.1.0"===t.version)&&t.Operations.QueryExpressions.indexOf("wfs:Query")<0){s.push({key:TC.Consts.WFSErrors.QUERY_NOT_AVAILABLE,params:{serviceTitle:l(r)}});e({errors:s})}else{f=t.Operations.GetFeature.DCPType?t.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource:t.Operations.GetFeature.DCP.HTTP.Post.href;Promise.all([E(r.mapLayers[0],d,n)]).then(function(n){var i,y,C,d=n[0];p?(i=p,y={url:f,mapLayer:r.mapLayers[0]},C=TC.Util.WFSQueryBuilder(d,null,t,a,!0,c()),new Promise(function(e){y.mapLayer.toolProxification.fetchXML(y.url,{data:C,contentType:"application/xml",type:"POST"}).then(function(t){if(t instanceof XMLDocument){const r=t.querySelector("ExceptionReport Exception");if(r){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:r.getAttribute("exceptionCode"),errorThrown:r.querySelector("ExceptionText").textContent}}]});return}}var r=parseInt(t.querySelector("FeatureCollection").getAttribute("numberMatched")||t.querySelector("FeatureCollection").getAttribute("numberOfFeatures"),10);isNaN(r)||r>parseInt(i,10)?e({errors:[{key:TC.Consts.WFSErrors.MAX_NUM_FEATURES}]}):e(0!==r?r:{errors:[{key:TC.Consts.WFSErrors.NO_FEATURES}]})}).catch(function(t){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.name,errorThrown:t.message}}]})})})).then(function(n){if(n.errors&&n.errors.length>0){switch(n.errors[0].key){case TC.Consts.WFSErrors.INDETERMINATE:n.errors[0].params.serviceTitle=r.mapLayers.reduce(function(e,t){return e||t.title},"")||l(r);break;case TC.Consts.WFSErrors.MAX_NUM_FEATURES:n.errors[0].params={limit:p,serviceTitle:l(r)};break;case TC.Consts.WFSErrors.NO_FEATURES:n.errors[0].params={serviceTitle:l(r)}}e(n)}else u({url:f,mapLayer:r.mapLayers[0]},TC.Util.WFSQueryBuilder(d,null,t,o?a:TC.Consts.mimeType.JSON,!1,c())).then(function(t){e(Object.assign({service:r,errors:s},t))})}):u({url:f,mapLayer:r.mapLayers[0]},TC.Util.WFSQueryBuilder(d,null,t,o?a:TC.Consts.mimeType.JSON,!1,c())).then(function(t){e(Object.assign({service:r,errors:s},t))})}).catch(function(t){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.name,errorThrown:t.message,serviceTitle:l(r)}}]})})}}else{s.push({key:TC.Consts.WFSErrors.NO_VALID_LAYERS,params:{serviceTitle:l(r)}});e({errors:s})}}else{s.push({key:TC.Consts.WFSErrors.GETFEATURE_NOT_AVAILABLE,params:{serviceTitle:l(r)}});e({errors:s})}},function(t){var r=null;for(var n in i)i[n].request&&i[n].request===y.request&&(r=i[n]);e({errors:[{key:TC.Consts.WFSErrors.GETCAPABILITIES,params:{err:t.name,serviceTitle:l(r)}}]})})}))}});return r};d.updateSize=function(){this.wrap.updateSize()};d.linkTo=function(e){this.wrap.linkTo(e)}}();
//# sourceMappingURL=maps/Map.min.js.map