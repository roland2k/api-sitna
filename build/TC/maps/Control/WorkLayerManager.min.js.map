{"version":3,"sources":["control/WorkLayerManager.js"],"names":["TC","control","TOC","syncLoadJS","apiLocation","WorkLayerManager","options","self","this","apply","arguments","layers","layerTools","addLayerTool","renderFn","container","layerId","className","CLASS","button","querySelector","layer","map","getLayer","isRaster","info","getInfo","hasOwnProperty","text","getLocaleString","document","createElement","innerHTML","setAttribute","classList","add","dataset","appendChild","actionFn","li","parentElement","tagName","querySelectorAll","forEach","img","styleLegendImage","toggle","Consts","classes","HIDDEN","checked","contains","CHECKED","Vector","getDownloadDialog","then","title","fileName","test","substr","lastIndexOf","elevation","open","features","inherit","ctlProto","prototype","CLICKEVENT","DRAG","DRAGEND","event","TOOLSOPEN","template","1","depth0","helpers","partials","data","stack1","lookupProperty","parent","propertyName","Object","call","invokePartial","name","decorators","compiler","main","alias1","nullContext","alias2","escapeExpression","hash","loc","start","line","column","end","fn","program","inverse","noop","usePartial","useData","lambda","3","4","6","8","10","12","14","16","18","19","20","22","23","alias3","indent","findLayerElement","ctl","getLayerUIElements","filter","id","getElligibleLayersNumber","length","shouldBeDelAllVisible","some","unremovable","moveLayer","listItem","oldIndex","newIndex","callback","layerItems","targetItem","sourceLayer","targetLayer","newIdx","indexOf","insertLayer","render","_set1stRenderPromise","renderData","Util","extend","getLayerTree","addUIEventListeners","loadJS","window","Sortable","workLayers","stealth","updateLayerTree","ul","div","_sortable","create","handle","animation","onSort","e","item","addEventListener","EventTarget","listenerBySelector","elm","target","swap","oldIdx","sortableItems","toArray","buffer","sort","listItems","elmIdx","key","focus","stopPropagation","blur","Promise","reject","Error","register","resolve","loaded","updateScale","on","LAYEROPACITY","value","Math","round","opacity","FEATURESIMPORT","pattern","format","GPX","toLowerCase","one","LAYERADD","layout","accordion","COLLAPSED","controls","containerControl","trigger","remove","onExternalServiceAdded","checkbox","matches","setVisibility","inputRangeListener","range","setOpacity","removeLayer","confirm","updateLayerVisibility","visible","getVisibility","isBase","MapContents","alreadyExists","i","len","push","layerTitle","wrap","getServiceTitle","layerData","hideTitle","hide","renderOptions","customLegend","hasExtent","getExtent","layerNames","path","getPath","shift","names","legend","metadata","method","getLegendGraphicImage","src","catch","err","error","getLegendImgByPost","getRenderedHtml","out","DOMParser","parseFromString","body","firstChild","layerNode","isGroup","layerNodes","getAllLayerNodes","node","getName","getLayerNodes","typeElm","zoomBtn","CLICK","zoomToLayer","animate","passive","normalizeLayerNode","tip","mapDiv","typeElmRect","getBoundingClientRect","style","top","offsetTop","right","offsetWidth","left","offsetLeft","removeChild","lis","layerList","l","layerIdx","tool","addLayerToolUI","inserted","ii","referenceLi","insertAdjacentElement","domReadyPromise","elligibleLayersNum","numElm","emptyElm","contentElm","textContent","VISIBLE","isVisible","isVisibleByScale","updateLayerOrder","idx","splice","numberElm","nChildren","Array","from","isFunction","updateFn","updateEvents","join"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGC,QAAQC,KACZF,GAAGG,WAAWH,GAAGI,YAAc,kBAGnCJ,GAAGC,QAAQI,iBAAmB,SAAUC,GACpC,IAAIC,EAAOC,KACXR,GAAGC,QAAQC,IAAIO,MAAMF,EAAMG,WAC3BH,EAAKI,OAAS,GACdJ,EAAKK,WAAa,GAElBL,EAAKM,aAAa,CACdC,SAAU,SAAUC,EAAWC,GAC3B,MAAMC,EAAYV,EAAKW,MAAQ,YAE/B,IAAIC,EAASJ,EAAUK,cAAc,UAAYH,GACjD,IAAKE,EAAQ,CACT,MAAME,EAAQd,EAAKe,IAAIC,SAASP,GAChC,GAAIK,EAAMG,WAAY,CAClB,MAAMC,EAAOJ,EAAMK,UACnB,GAAID,EAAKE,eAAe,aAAeF,EAAKE,eAAe,WAAaF,EAAKE,eAAe,YAAa,CACrG,MAAMC,EAAOrB,EAAKsB,gBAAgB,sBAClCV,EAASW,SAASC,cAAc,WACzBC,UAAYJ,EACnBT,EAAOc,aAAa,QAASL,GAC7BT,EAAOe,UAAUC,IAAIlB,GACrBE,EAAOiB,QAAQpB,QAAUA,EACzBD,EAAUsB,YAAYlB,KAIlC,OAAOA,GAEXmB,SAAU,WAEN,IAAIC,EADW/B,KAEf,GACI+B,EAAKA,EAAGC,oBAELD,GAAqB,OAAfA,EAAGE,SAChB,MAAMhB,EAAOc,EAAGnB,cAAc,IAAMb,EAAKW,MAAQ,SAC3CG,EAAQd,EAAKe,IAAIC,SAPRf,KAOwB4B,QAAQpB,SAE/CS,EAAKiB,iBAAiB,IAAMnC,EAAKW,MAAQ,eAAeyB,QAAQ,SAAUC,GACtErC,EAAKsC,iBAAiBD,EAAKvB,KAE/BI,EAAKS,UAAUY,OAAO9C,GAAG+C,OAAOC,QAAQC,QAExC,GAAIV,EAAGnB,cAAc,0BAA0B8B,QAAS,CACjCX,EAAGnB,cAAc,IAAMb,EAAKW,MAAQ,OAC5CgB,UAAUY,OAAO9C,GAAG+C,OAAOC,QAAQC,QAASxB,EAAKS,UAAUiB,SAASnD,GAAG+C,OAAOC,QAAQC,SAhBtFzC,KAmBR0B,UAAUY,OAAO9C,GAAG+C,OAAOC,QAAQI,YAIlD7C,EAAKM,aAAa,CACdC,SAAU,SAAUC,EAAWC,GAC3B,MAAMC,EAAYV,EAAKW,MAAQ,UAE/B,IAAIC,EAASJ,EAAUK,cAAc,UAAYH,GACjD,IAAKE,EAAQ,CACT,MAAME,EAAQd,EAAKe,IAAIC,SAASP,GAChC,GAAIhB,GAAGqB,MAAMgC,QAAUhC,aAAiBrB,GAAGqB,MAAMgC,OAAQ,CACrD,MAAMzB,EAAOrB,EAAKsB,gBAAgB,qBAClCV,EAASW,SAASC,cAAc,WACzBC,UAAYJ,EACnBT,EAAOc,aAAa,QAASL,GAC7BT,EAAOe,UAAUC,IAAIlB,GACrBE,EAAOiB,QAAQpB,QAAUA,EACzBD,EAAUsB,YAAYlB,IAG9B,OAAOA,GAEXmB,SAAU,WAEN,IAAIC,EADW/B,KAEf,GACI+B,EAAKA,EAAGC,oBAELD,GAAqB,OAAfA,EAAGE,SAChB,MAAMpB,EAAQd,EAAKe,IAAIC,SANRf,KAMwB4B,QAAQpB,SAC/CT,EAAK+C,oBAAoBC,KAAK,SAAUtD,GACpC,MAAMuD,EAAQnC,EAAMmC,OAAS,GACvBlD,EAAU,CACZkD,SAAUA,OAAWjD,EAAKsB,gBAAgB,sBAC1C4B,SAAU,gBAAgBC,KAAKF,GAASA,EAAMG,OAAO,EAAGH,EAAMI,YAAY,MAAQJ,EAClFK,UAAWtD,EAAKe,IAAIuC,WAAatD,EAAKe,IAAIuC,UAAUvD,SAExDL,EAAQ6D,KAAKzC,EAAM0C,SAAUzD,SAM7CN,GAAGgE,QAAQhE,GAAGC,QAAQI,iBAAkBL,GAAGC,QAAQC,MAEnD,WACI,IAAI+D,EAAWjE,GAAGC,QAAQI,iBAAiB6D,UAE3CD,EAAS/C,MAAQ,aACjB+C,EAASE,WAAa,QAEtBnE,GAAG+C,OAAOC,QAAQoB,KAAOpE,GAAG+C,OAAOC,QAAQoB,MAAQ,UACnDpE,GAAG+C,OAAOC,QAAQqB,QAAUrE,GAAG+C,OAAOC,QAAQqB,SAAW,aAEzDrE,GAAG+C,OAAOuB,MAAMC,UAAYvE,GAAG+C,OAAOuB,MAAMC,WAAa,eAEzDN,EAASO,SAAW,GACpBP,EAASO,SAASP,EAAS/C,OAAS,CAACuD,EAAI,SAAS1D,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAA8M,OAArMH,EAAS/D,EAAUqE,cAAcL,EAAeH,EAAS,kBAAkBF,EAAO,CAACW,KAAO,iBAAiBR,KAAOA,EAAKF,QAAUA,EAAQC,SAAWA,EAASU,WAAavE,EAAUuE,cAAwBR,EAAS,IAAMS,SAAW,CAAC,EAAE,YAAYC,KAAO,SAASzE,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAiB,MAAVf,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKC,EAAO5E,EAAU6E,iBAAkBb,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,OAAYU,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,eAAe,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,yFAAmGN,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,yBAAyB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,qDAA6DN,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,SAAS,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,oEAA0W,OAA9RnB,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,cAAgBA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAkBnB,EAAS,IAAS,mBAAoByB,YAAa,EAAKC,SAAU,GAChmEvC,EAASO,SAASP,EAAS/C,MAAQ,QAAU,CAACuD,EAAI,SAAS1D,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIE,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAOlE,EAAU6E,iBAAiB7E,EAAU0F,OAAkB,MAAV/B,EAAiBK,EAAeL,EAAO,SAAWA,EAASA,KAAWgC,EAAI,SAAS3F,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAqU,OAA5TH,EAASC,EAAeJ,EAAQ,UAAUQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKb,GAAQE,EAAeF,EAAK,SAAU,CAACQ,KAAO,SAASQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS/D,EAAU6E,iBAAiB7E,EAAU0F,OAAO/B,EAAQA,KAAWiC,EAAI,SAAS5F,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,MAAO,YAAa+B,EAAI,SAAS7F,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIY,EAAiB,MAAVf,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKC,EAAO5E,EAAU6E,iBAAkBb,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,8CAAsDU,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,oBAAoB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,KAAWN,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,oBAAoB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,aAAcY,EAAI,SAAS9F,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,MAAO,YAAaiC,GAAK,SAAS/F,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIE,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,UAAgBlE,EAAU6E,iBAAiBb,EAAeJ,EAAQ,QAAQQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAI,qBAAqB,CAACL,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,KAAOc,GAAK,SAAShG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,MAAO,qBAAwBmC,GAAK,SAASjG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,wEAA+ElE,EAAU6E,iBAAiBb,EAAeJ,EAAQ,QAAQQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAI,WAAW,CAACL,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,uCAAkJ,OAArGnB,EAAS/D,EAAU0F,OAAkB,MAAV/B,EAAiBK,EAAeL,EAAO,YAAcA,EAASA,IAAmBI,EAAS,IAAS,0CAA2CmC,GAAK,SAASlG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,yEAA0L,OAAzGH,EAAS/D,EAAU0F,OAAkB,MAAV/B,EAAiBK,EAAeL,EAAO,gBAAkBA,EAASA,IAAmBI,EAAS,IAAS,6BAA8BoC,GAAK,SAASnG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAoV,OAA3UH,EAASC,EAAeJ,EAAQ,MAAMQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAe,MAAVhB,EAAiBK,EAAeL,EAAO,UAAYA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,IAAMqC,GAAK,SAASpG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAO1E,EAAU6E,iBAAkBD,EAAiB,MAAVjB,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKX,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,mEAA2EQ,EAAO1E,EAAU0F,OAAkB,MAAV/B,EAAiBK,EAAeL,EAAO,cAAgBA,EAASA,IAAc,iCAAuCe,EAAOV,EAAeJ,EAAQ,QAAQQ,KAAKQ,EAAO,UAAU,CAACN,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,aAAiT,OAA9RnB,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKQ,EAAkB,MAAVjB,EAAiBK,EAAeL,EAAO,UAAYA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,IAAS,8BAA+BsC,GAAK,SAASrG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIY,EAAO1E,EAAU0F,OAAQd,EAAO5E,EAAU6E,iBAAkBb,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,+BAAoCU,EAAOF,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,SAAWA,EAASA,IAAc,sBAA4BiB,EAAOF,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,OAASA,EAASA,IAAc,kBAAoB2C,GAAK,SAAStG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAiB,MAAVf,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKX,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,wEAA+ElE,EAAU6E,iBAAiBb,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,WAAW,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,qCAA2U,OAAhSnB,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,YAAcA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,IAAS,mDAAoDwC,GAAK,SAASvG,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAO1E,EAAU0F,OAAQd,EAAO5E,EAAU6E,iBAAkBb,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,qCAAkI,OAAtFH,EAASW,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,OAASA,EAASA,IAAmBI,EAAS,IAAS,WAAkBa,EAAOF,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,UAAYA,EAASA,IAAc,YAAmBiB,EAAOF,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,qBAAuBA,EAASA,IAAc,qBAA6BiB,EAAOF,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,qBAAuBA,EAASA,IAAc,iBAAkBa,SAAW,CAAC,EAAE,YAAYC,KAAO,SAASzE,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAiB,MAAVf,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKC,EAAO5E,EAAU6E,iBAAkB2B,EAAOxG,EAAU0F,OAAQ1B,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,iFAAkX,OAArRH,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,QAAUA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAkBnB,EAAS,IAAS,yFAA6Y,OAAzSA,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,QAAUA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGA,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS,MAAuT,OAA1SA,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,QAAUA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGA,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS,8GAAkZ,OAA1RA,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,aAAeA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS,mDAAwW,OAA7SA,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,eAAiBA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGA,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS,IAASa,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,qBAAqB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,+EAAuFN,EAAO4B,EAAkB,MAAV7C,EAAiBK,EAAeL,EAAO,MAAQA,EAASA,IAAc,MAA4S,OAA/RI,EAASC,EAAeJ,EAAQ,UAAUQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,QAAUA,EAAQ,CAACW,KAAO,SAASQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBnB,EAAS,IAAS,WAAiBa,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,wBAAwB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,2DAAkEN,EAAO4B,EAAkB,MAAV7C,EAAiBK,EAAeL,EAAO,MAAQA,EAASA,IAAc,YAAmBiB,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,wBAAwB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,KAAWN,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,wBAAwB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,kDAA0DN,EAAO4B,EAAkB,MAAV7C,EAAiBK,EAAeL,EAAO,WAAaA,EAASA,IAAc,YAAmBiB,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,0BAA0B,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,6EAAkX,OAA5RnB,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,YAAcA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,KAA2T,OAAhTA,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,gBAAkBA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGA,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,KAAuS,OAA5RA,EAASC,EAAeJ,EAAQ,MAAMQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,YAAcA,EAAQ,CAACW,KAAO,KAAKQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,GAAIvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBnB,EAAS,IAAS,2DAAmEa,EAAOZ,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,gBAAgB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,qBAAuBO,SAAU,GAC11bvC,EAASO,SAASP,EAAS/C,MAAQ,aAAe,CAACqE,SAAW,CAAC,EAAE,YAAYC,KAAO,SAASzE,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIE,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAOlE,EAAU6E,iBAAiBb,EAAeJ,EAAQ,QAAQQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAI,cAAc,CAACL,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAUO,SAAU,GACtnBvC,EAASO,SAASP,EAAS/C,MAAQ,aAAe,CAACuD,EAAI,SAAS1D,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAkP,OAAzOH,EAAS/D,EAAUqE,cAAcL,EAAeH,EAAS,4BAA4BF,EAAO,CAACW,KAAO,2BAA2BR,KAAOA,EAAK2C,OAAS,OAAO7C,QAAUA,EAAQC,SAAWA,EAASU,WAAavE,EAAUuE,cAAwBR,EAAS,IAAMS,SAAW,CAAC,EAAE,YAAYC,KAAO,SAASzE,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQW,EAAiB,MAAVf,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAKX,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,QAAalE,EAAU6E,iBAAiBb,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAO,yBAAyB,CAACJ,KAAO,OAAOQ,KAAO,GAAGhB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,uBAAsT,OAAzRnB,EAASC,EAAeJ,EAAQ,QAAQQ,KAAKM,EAAkB,MAAVf,EAAiBK,EAAeL,EAAO,SAAWA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAkBnB,EAAS,IAAS,SAAUyB,YAAa,EAAKC,SAAU,GACtkDvC,EAASO,SAASP,EAAS/C,MAAQ,kBAAoB,CAACuD,EAAI,SAAS1D,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAsP,OAA7OH,EAAS/D,EAAUqE,cAAcL,EAAeH,EAAS,4BAA4BF,EAAO,CAACW,KAAO,2BAA2BR,KAAOA,EAAK2C,OAAS,WAAW7C,QAAUA,EAAQC,SAAWA,EAASU,WAAavE,EAAUuE,cAAwBR,EAAS,IAAMS,SAAW,CAAC,EAAE,YAAYC,KAAO,SAASzE,EAAU2D,EAAOC,EAAQC,EAASC,GAAW,IAAIC,EAAQC,EAAiBhE,EAAUgE,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOhB,UAAUvC,eAAewD,KAAKH,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,qDAA4DlE,EAAU6E,iBAAiB7E,EAAU0F,OAAkB,MAAV/B,EAAiBK,EAAeL,EAAO,SAAWA,EAASA,IAAc,2BAA2W,OAA1UI,EAASC,EAAeJ,EAAQ,QAAQQ,KAAe,MAAVT,EAAiBA,EAAU3D,EAAU2E,aAAe,GAAe,MAAVhB,EAAiBK,EAAeL,EAAO,SAAWA,EAAQ,CAACW,KAAO,OAAOQ,KAAO,GAAGM,GAAKpF,EAAUqF,QAAQ,EAAGvB,EAAM,GAAGwB,QAAUtF,EAAUuF,KAAKzB,KAAOA,EAAKiB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAkBnB,EAAS,IAAS,sBAAuByB,YAAa,EAAKC,SAAU,GAEviD,MAAMiB,EAAmB,SAAUC,EAAKrG,GACpC,OAAOqG,EAAIC,qBAAqBC,OAAO,SAAUrF,GAC7C,OAAOA,EAAGH,QAAQpB,UAAYK,EAAMwG,KACrC,IAGP,IAAIC,EAA2B,SAAUJ,GACrC,OAAOA,EAAI/G,OAAOoH,QAGtB,MAAMC,EAAwB,SAAUN,GACpC,OAAQA,EAAI/G,OAAOsH,KAAK,SAAU5G,GAAS,OAAOA,EAAM6G,eAGtDC,EAAY,SAAUT,EAAKU,EAAUC,EAAUC,EAAUC,GAC3D,MAAMC,EAAad,EAAIC,qBACvB,IAAIc,EACJ,GAAIH,EAAWD,EACXI,EAAaD,EAAWF,EAAW,OAElC,CAAA,KAAIA,EAAWD,GAIhB,OAHAI,EAAaD,EAAWF,EAAW,GAKvC,MAAMI,EAAchB,EAAIpG,IAAIC,SAAS6G,EAAShG,QAAQpB,SAChD2H,EAAcjB,EAAIpG,IAAIC,SAASkH,EAAWrG,QAAQpB,SAClD4H,EAASlB,EAAIpG,IAAIX,OAAOkI,QAAQF,GAClCC,GAAU,GAAKA,EAASlB,EAAIpG,IAAIX,OAAOoH,QACvCL,EAAIpG,IAAIwH,YAAYJ,EAAaE,EAAQL,IAIjDtE,EAAS8E,OAAS,SAAUR,EAAUjI,GAClC,MAAMC,EAAOC,KACb,OAAOD,EAAKyI,qBAAqBzI,EAAKe,IAAMf,EAAK0I,WAAW3I,EAAUN,GAAGkJ,KAAKC,OAAO5I,EAAKe,IAAI8H,eAAgB9I,GAAWC,EAAKe,IAAI8H,eAAgB,WAC9I7I,EAAK8I,sBACLrJ,GAAGsJ,QACEC,OAAOC,SACR,CAACxJ,GAAGI,YAAc,gCAClB,WACIG,EAAKe,IAAImI,WACJ7B,OAAO,SAAUvG,GACd,OAAQA,EAAMqI,UAEjB/G,QAAQ,SAAUtB,GACfd,EAAKoJ,gBAAgBtI,KAI7B,MAAMuI,EAAKrJ,EAAKsJ,IAAIzI,cAAc,MAClCb,EAAKuJ,UAAYN,SAASO,OAAOH,EAAI,CACjCI,OAAQ,IAAMzJ,EAAKW,MAAQ,MAC3B+I,UAAW,IACXC,OAAQ,SAAUC,GACdhC,EAAU5H,EAAM4J,EAAEC,KAAMD,EAAE9B,SAAU8B,EAAE7B,aAI9CsB,EAAGS,iBAAiB,UAAWrK,GAAGsK,YAAYC,mBAAmB,KAAM,SAAUJ,GAG7E,IADA,IAAIK,EAAML,EAAEM,OACW,OAAhBD,EAAI/H,SAEP,KADA+H,EAAMA,EAAIhI,eAEN,OAGR,MAAMkI,EAAO,SAAUC,EAAQ/B,GAC3B,MAAMgC,EAAgBrK,EAAKuJ,UAAUe,UAC/BC,EAASF,EAAcD,GAC7BC,EAAcD,GAAUC,EAAchC,GACtCgC,EAAchC,GAAUkC,EACxBvK,EAAKuJ,UAAUiB,KAAKH,GACpBzC,EAAU5H,EAAMiK,EAAKG,EAAQ/B,IAE3BoC,EAAYzK,EAAKoH,qBACjBsD,EAASD,EAAUnC,QAAQ2B,GACjC,QAAQ,GACJ,IAAK,MAAM9G,KAAKyG,EAAEe,KACd,GAAID,EAAS,EAAG,CACZP,EAAKO,EAAQA,EAAS,GACtBT,EAAIW,QACJhB,EAAEiB,kBAEN,MACJ,IAAK,QAAQ1H,KAAKyG,EAAEe,KAChB,GAAID,EAASD,EAAUjD,OAAS,EAAG,CAC/B2C,EAAKO,EAAQA,EAAS,GACtBT,EAAIW,QACJhB,EAAEiB,kBAEN,MACJ,IAAK,SAAS1H,KAAKyG,EAAEe,KACjBV,EAAIa,OACJlB,EAAEiB,sBAOU,mBAAb7C,GACPA,QAIX+C,QAAQC,OAAOC,MAAM,wCAG9BvH,EAASwH,SAAW,SAAUnK,GAC1B,MAAMf,EAAOC,KAEb,OAAO,IAAI8K,QAAQ,SAAUI,EAASH,GAClCvL,GAAGC,QAAQC,IAAIgE,UAAUuH,SAAStG,KAAK5E,EAAMe,GAAKiC,KAAK,WAEnDjC,EAAIqK,OAAO,WACPpL,EAAKqL,gBAGTtK,EACKuK,GAAG7L,GAAG+C,OAAOuB,MAAMwH,aAAc,SAAU3B,GACxC,MAAM5H,EAAKkF,EAAiBlH,EAAM4J,EAAE9I,OAChCkB,IACAA,EAAGnB,cAAc,qBAAqB2K,MAAQC,KAAKC,MAAkB,IAAZ9B,EAAE+B,YAGlEL,GAAG7L,GAAG+C,OAAOuB,MAAM6H,eAAgB,SAAUhC,GAC1C,IAAI1G,EAAW0G,EAAE1G,SACjB,GAAI0G,EAAEpG,UAAYoG,EAAEpG,SAASgE,OAAS,EAAG,CAErC,IAAIqE,EAAU,IAAMpM,GAAG+C,OAAOsJ,OAAOC,IAAIC,cACzC,GAAIpC,EAAE1G,SAAS8I,cAAc1D,QAAQuD,KAAajC,EAAE1G,SAASsE,OAASqE,EAAQrE,OAC1E,OAGJzG,EAAIkL,IAAIxM,GAAG+C,OAAOuB,MAAMmI,SAAU,SAAUtC,GACxC,GAAIA,GAAKA,EAAE9I,OAAS8I,EAAE9I,MAAMmC,OAASC,EAAU,CAEvClD,EAAKe,KAAOf,EAAKe,IAAIoL,QAAUnM,EAAKe,IAAIoL,OAAOC,WAC3CpM,EAAKsJ,IAAI3H,UAAUiB,SAASnD,GAAG+C,OAAOC,QAAQ4J,YAC9CrM,EAAKe,IAAIuL,SACJjF,OAAO,SAAUF,GAEd,OAAOA,IAAQnH,IAASmH,EAAIoF,mBAE/BnK,QAAQ,SAAU+E,GACfA,EAAImC,IAAI3H,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQ4J,aAMxDrM,EAAKe,IAAIyL,QAAQ/M,GAAG+C,OAAOuB,MAAMC,WAEjChE,EAAKsJ,IAAI3H,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQ4J,iBAKhElB,EAAQnL,QAKpB0D,EAASgJ,uBAAyB,SAAU9C,KAI5ClG,EAASoF,oBAAsB,WAC3B,MAAM9I,EAAOC,KAEbD,EAAKsJ,IAAIQ,iBAAiB9J,EAAK4D,WAAYnE,GAAGsK,YAAYC,mBAAmB,uBAAwB,SAAUJ,GAE3G,MAAM+C,EAAW/C,EAAEM,OACnB,IAAIlI,EAAK2K,EACT,GACI3K,EAAKA,EAAGC,oBAELD,IAAOA,EAAG4K,QAAQ,MAAQ5M,EAAKW,MAAQ,SAEhCX,EAAKe,IAAIC,SAASgB,EAAGH,QAAQpB,SACrCoM,cAAcF,EAAShK,SAC7BiH,EAAEiB,qBAGN,MAAMiC,EAAqB,SAAUlD,GACjC,MAAMmD,EAAQnD,EAAEM,OAChB,IAAIlI,EAAK+K,EACT,GACI/K,EAAKA,EAAGC,oBAELD,GAAqB,OAAfA,EAAGE,SAEFlC,EAAKe,IAAIC,SAASgB,EAAGH,QAAQpB,SACrCuM,WAAWD,EAAMvB,MAAQ,MAEnCxL,EAAKsJ,IAAIQ,iBAAiB,SAAUrK,GAAGsK,YAAYC,mBAAmB,oBAAqB8C,IAC3F9M,EAAKsJ,IAAIQ,iBAAiB,QAASrK,GAAGsK,YAAYC,mBAAmB,oBAAqB8C,IAE1F9M,EAAKsJ,IAAIQ,iBAAiB9J,EAAK4D,WAAYnE,GAAGsK,YAAYC,uBAAuBhK,EAAKW,+BAAgC,SAAUiJ,GAC5H,IAAI5H,EAAK4H,EAAEM,OACX,GACIlI,EAAKA,EAAGC,oBAELD,GAAqB,OAAfA,EAAGE,SAChB,MAAMpB,EAAQd,EAAKe,IAAIC,SAASgB,EAAGH,QAAQpB,SAC3CT,EAAKe,IAAIkM,YAAYnM,MAGzBd,EAAKsJ,IAAIQ,iBAAiB9J,EAAK4D,WAAYnE,GAAGsK,YAAYC,mBAAmB,IAAMhK,EAAKW,MAAQ,WAAY,SAAUiJ,GAClHnK,GAAGyN,QAAQlN,EAAKsB,gBAAgB,wBAAyB,WACrDtB,EAAKoH,qBACArG,IAAI,SAAUiB,GACX,OAAOhC,EAAKe,IAAIC,SAASgB,EAAGH,QAAQpB,WAEvC2B,QAAQ,SAAUtB,GACfd,EAAKe,IAAIkM,YAAYnM,WAOzC4C,EAASyJ,sBAAwB,SAAUrM,GACvC,MACMkB,EAAKkF,EADEjH,KACqBa,GAClC,GAAIkB,EAAI,CACJ,MAAMoL,EAAUtM,EAAMuM,gBACtBrL,EAAGnB,cAAc,0BAA0B8B,QAAUyK,IAI7D1J,EAAS0F,gBAAkB,SAAUtI,GACjC,IAAId,EAAOC,KAgBX,IAAKa,EAAMwM,SAAWxM,EAAMf,QAAQoJ,QAAS,CACzC1J,GAAGC,QAAQ6N,YAAY5J,UAAUyF,gBAAgBxE,KAAK5E,EAAMc,GAG5D,IADA,IAAI0M,GAAgB,EACXC,EAAI,EAAGC,EAAM1N,EAAKI,OAAOoH,OAAQiG,EAAIC,EAAKD,IAC/C,GAAI3M,IAAUd,EAAKI,OAAOqN,GAAI,CAC1BD,GAAgB,EAChB,MAIR,IAAKA,EAAe,CAChBxN,EAAKI,OAAOuN,KAAK7M,GAEjB,IACI8M,EAAa9M,EAAMmC,OAASnC,EAAM+M,KAAKC,kBACvCC,EAAY,CACZ9K,MAAOnC,EAAMf,QAAQiO,UAAY,GAAKJ,EACtCK,QAAMnN,EAAMoN,gBAAiBpN,EAAMoN,cAAcD,MACjDtC,QAAS7K,EAAMoN,eAAiBpN,EAAMoN,cAAcvC,QAAyC,IAA9B7K,EAAMoN,cAAcvC,QAAiB,IACpGwC,aAAcrN,EAAMqN,aACpBxG,YAAa7G,EAAM6G,YACnBL,GAAIxG,EAAMwG,IAEVrG,EAAWH,EAAMG,WACrB,GAAIA,EAAU,CACV8M,EAAUK,YAActN,EAAMuN,YAC9BN,EAAUO,WAAaxN,EAAMwN,WAC7B,IAAIC,EAAOzN,EAAM0N,UACjBD,EAAKE,QACLV,EAAUQ,KAAOA,EACjB,IAAIzJ,EAAOhE,EAAM4N,MAAM,GACnBxN,EAAOJ,EAAMK,QAAQ2D,GACzBiJ,EAAUY,OAASzN,EAAKyN,OACxBZ,EAAoB,SAAI7M,EAAe,SACvC6M,EAAUa,SAAW1N,EAAK0N,cAG1Bb,EAAUK,WAAY,GApDT,SAAUtN,GAC/B,OAAO,IAAIiK,QAAQ,SAAUI,EAASH,GAC9BlK,GAASA,EAAMf,QAAQ8O,QAAmC,SAAzB/N,EAAMf,QAAQ8O,OAC/C/N,EAAMgO,wBACD9L,KAAK,SAAU+L,GACZ5D,EAAQ4D,KAEXC,MAAM,SAAUC,GAAOxP,GAAGyP,MAAMD,KAErC9D,OA+CJgE,CAAmBrO,GAAOkC,KAAK,SAAU+L,GACjCA,IACAJ,OAAOI,IAAMA,GAGjB/O,EAAKoP,gBAAgBpP,EAAKW,MAAQ,OAAQoN,GAAW/K,KAAK,SAAUqM,GAChE,MACMrN,GADS,IAAIsN,WACDC,gBAAgBF,EAAK,aAAaG,KAAKC,WACzD,IAAIC,EACAC,GAAU,EACd,GAAI1O,KACA0O,EAAU7O,EAAM4N,MAAMlH,OAAS,GAG3B,IADA,IAAIoI,EAAa9O,EAAM+M,KAAKgC,mBACnBpC,EAAI,EAAGA,EAAImC,EAAWpI,OAAQiG,IAAK,CACxC,IAAIqC,EAAOF,EAAWnC,GACtB,GAAI3M,EAAM+M,KAAKkC,QAAQD,KAAUhL,EAAM,CACnC4K,EAAYI,EACRhP,EAAM+M,KAAKmC,cAAcF,GAAMtI,OAAS,IACxCmI,GAAU,GAEd,OAMhB,MAAMM,EAAUjO,EAAGnB,cAAc,IAAMb,EAAKW,MAAQ,SAC9CD,EAAYiP,EAAU3P,EAAKW,MAAQ,YAAcX,EAAKW,MAAQ,YACpEsP,EAAQtO,UAAUC,IAAIlB,GAEtB,MAAMwP,EAAUlO,EAAGnB,kBAAkBb,EAAKW,kBACtCuP,GACAA,EAAQpG,iBAAiBrK,GAAG+C,OAAOuB,MAAMoM,MAAO,SAAUvG,GACtD5J,EAAKe,IAAIqP,YAAYpO,EAAGH,QAAQpB,QAAS,CAAE4P,SAAS,KACrD,CAAEC,SAAS,IAGlB,GAAIZ,EAAW,CACX5O,EAAM+M,KAAK0C,mBAAmBb,GAE9B1P,EAAKoP,gBAAgB1O,EAAWgP,GAAW1M,KAAK,SAAUqM,GACtD,IAAImB,EAEJP,EAAQnG,iBAAiB,YAAa,SAAUF,GAC5C,MAAM6G,EAASzQ,EAAKe,IAAIuI,IAClBoH,EAAcT,EAAQU,yBAC5BH,EAAMjP,SAASC,cAAc,QACzBG,UAAUC,IAAI5B,EAAKW,MAAQ,QAC/B6P,EAAI/O,UAAY4N,EAChBmB,EAAII,MAAMC,IAAOH,EAAYG,IAAMJ,EAAOK,UAAa,KACvDN,EAAII,MAAMG,MAAQN,EAAOO,aAAeN,EAAYO,KAAOR,EAAOS,YAAc,KAChFT,EAAO3O,YAAY0O,KAEvBP,EAAQnG,iBAAiB,WAAY,SAAUF,GAC3C4G,EAAIvO,cAAckP,YAAYX,OAI1C,MAAMnH,EAAKrJ,EAAKsJ,IAAIzI,cAAc,MAClCmB,EAAGH,QAAQpB,QAAUK,EAAMwG,GAE3B,MAAM8J,EAAMpR,EAAKoH,qBACXiK,EAAYrR,EAAKe,IAAImI,WACtB7B,OAAO,SAAUiK,GACd,OAAQA,EAAEnI,UAEZoI,EAAWF,EAAU/I,QAAQxH,GAEnCd,EAAKK,WAAW+B,QAAQoP,GAAQxR,EAAKyR,eAAezP,EAAIwP,IAGxD,IADA,IAAIE,GAAW,EACCC,GAAPlE,EAAI,EAAQ2D,EAAI5J,QAAQiG,EAAIkE,EAAIlE,IAAK,CAC1C,MAAMmE,EAAcR,EAAI3D,GAExB,GAD0B4D,EAAU/I,QAAQtI,EAAKe,IAAIC,SAAS4Q,EAAY/P,QAAQpB,UAC1D8Q,EAAU,CAC9BK,EAAYC,sBAAsB,cAAe7P,GACjD0P,GAAW,EACX,OAGHA,GACDrI,EAAGvH,YAAYE,QA9GvB8P,EAkHI9R,EAAKqL,kBAIb,IAAI0G,EAAqBxK,EAAyBvH,GAClD,MAAMgS,EAAShS,EAAKsJ,IAAIzI,cAAc,IAAMb,EAAKW,MAAQ,MACnDsR,EAAWjS,EAAKsJ,IAAIzI,cAAc,IAAMb,EAAKW,MAAQ,UACrDuR,EAAalS,EAAKsJ,IAAIzI,cAAc,IAAMb,EAAKW,MAAQ,YAC7DqR,EAAOG,YAAcJ,EACrB,GAAIA,EAAqB,EAAG,CACxBC,EAAOrQ,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQ2P,SACvCH,EAAStQ,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQC,QACzCwP,EAAWvQ,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQC,YAE7C,CACDsP,EAAOrQ,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQ2P,SAC1CH,EAAStQ,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQC,QAC5CwP,EAAWvQ,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQC,QAG1B1C,EAAKsJ,IAAIzI,cAAc,IAAMb,EAAKW,MAAQ,YAClDgB,UAAUY,OAAO9C,GAAG+C,OAAOC,QAAQC,QAAS+E,EAAsBzH,OAK3F0D,EAAS2H,YAAc,WACnB,IAAIrL,EAAOC,KACXD,EAAKoH,qBAAqBhF,QAAQ,SAAUJ,GACxC,IAAIlB,EAAQd,EAAKe,IAAIC,SAASgB,EAAGH,QAAQpB,SACzC,GAAIK,GAASA,EAAM4N,MAAO,CAEtB,IADA,IAAI2D,GAAY,EACP5E,EAAI,EAAGA,EAAI3M,EAAM4N,MAAMlH,OAAQiG,IACpC,GAAI3M,EAAMwR,iBAAiBxR,EAAM4N,MAAMjB,IAAK,CACxC4E,GAAY,EACZ,MAGRrQ,EAAGL,UAAUY,OAAOvC,EAAKW,MAAQ,mBAAoB0R,OAKjE3O,EAAS6O,iBAAmB,SAAUzR,EAAOsJ,EAAQ/B,GAEjD,MAAMrI,EAAOC,KACbD,EAAKe,IAAImI,WACJ7B,OAAO,SAAUvG,GACd,OAAQA,EAAMqI,UAEjB/G,QAAQ,SAAUtB,GACf,MAAMkB,EAAKkF,EAAiBlH,EAAMc,GAC9BkB,GACAA,EAAGC,cAAcwN,WAAWoC,sBAAsB,cAAe7P,MAKjF0B,EAASuJ,YAAc,SAAUnM,GAC7B,IACI0R,EADOvS,KACIG,OAAOkI,QAAQxH,GAC1B0R,GAAO,GAFAvS,KAGFG,OAAOqS,OAAOD,EAAK,GAHjBvS,KAKNmH,qBAAqBhF,QAAQ,SAAUJ,GACpCA,EAAGH,QAAQpB,UAAYK,EAAMwG,IAC7BtF,EAAGC,cAAckP,YAAYnP,KAGrC,MAAMkQ,EAVKjS,KAUaqJ,IAAIzI,cAAc,IAV/BZ,KAU0CU,MAAQ,YACvDsR,EAXKhS,KAWWqJ,IAAIzI,cAAc,IAX7BZ,KAWwCU,MAAQ,UACrD+R,EAZKzS,KAYYqJ,IAAIzI,cAAc,IAZ9BZ,KAYyCU,MAAQ,MAC5D,IAAIgS,EAAYpL,EAbLtH,MAcXyS,EAAUP,YAAcQ,EACxB,GAAIA,EAAY,EAAG,CACfT,EAAWvQ,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQC,QAC9CuP,EAAStQ,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQC,QACzCgQ,EAAU/Q,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQ2P,aAEzC,CACG3K,EArBGxH,OAAAA,KAsBEqJ,IAAIzI,cAAc,IAtBpBZ,KAsB+BU,MAAQ,YAAYgB,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQC,QAE1FwP,EAAWvQ,UAAUC,IAAInC,GAAG+C,OAAOC,QAAQC,QAC3CuP,EAAStQ,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQC,QAC5CgQ,EAAU/Q,UAAU8K,OAAOhN,GAAG+C,OAAOC,QAAQ2P,WAIrD1O,EAAS0D,mBAAqB,WAE1B,OAAOwL,MAAMC,KADA5S,KACUqJ,IAAInH,4BADdlC,KAC+CU,eAGhE+C,EAAS+N,eAAiB,SAAUxH,EAAKuH,GACrC,MAAMxR,EAAOC,KACb,GAAIR,GAAGkJ,KAAKmK,WAAWtB,EAAKjR,UAAW,CACnC,MAAMK,EAAS4Q,EAAKjR,SAAS0J,EAAIpJ,kBAAkBb,EAAKW,eAAgBsJ,EAAIpI,QAAQpB,SACpF,GAAIG,EAAQ,CACJnB,GAAGkJ,KAAKmK,WAAWtB,EAAKzP,WACxBnB,EAAOkJ,iBAAiBrK,GAAG+C,OAAOuB,MAAMoM,MAAO,SAAUvG,GACrD4H,EAAKzP,SAAS6C,KAAKhE,IACpB,CAAE0P,SAAS,IAEd7Q,GAAGkJ,KAAKmK,WAAWtB,EAAKuB,WAAavB,EAAKwB,cAC1CjS,IAAIuK,GAAGkG,EAAKwB,aAAaC,KAAK,KAAM,SAAUrJ,GACrCA,EAAE9I,OAAS8I,EAAE9I,MAAMwG,KAAO1G,EAAOiB,QAAQpB,SAC1C+Q,EAAKuB,SAASnO,KAAKhE,EAAQgJ,QAQnDlG,EAASpD,aAAe,SAAUP,GAC9B,MAAMC,EAAOC,KACbD,EAAKK,WAAWsN,KAAK5N,GACrBC,EAAKoH,qBAAqBhF,QAAQ,SAAU6H,GACxCjK,EAAKyR,eAAexH,EAAKlK,MApgBrC","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.TOC) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/TOC');\r\n}\r\n\r\nTC.control.WorkLayerManager = function (options) {\r\n    var self = this;\r\n    TC.control.TOC.apply(self, arguments);\r\n    self.layers = [];\r\n    self.layerTools = [];\r\n\r\n    self.addLayerTool({\r\n        renderFn: function (container, layerId) {\r\n            const className = self.CLASS + '-btn-info';\r\n\r\n            let button = container.querySelector('button.' + className);\r\n            if (!button) {\r\n                const layer = self.map.getLayer(layerId);\r\n                if (layer.isRaster()) {\r\n                    const info = layer.getInfo();\r\n                    if (info.hasOwnProperty('abstract') || info.hasOwnProperty('legend') || info.hasOwnProperty('metadata')) {\r\n                        const text = self.getLocaleString('infoFromThisLayer');\r\n                        button = document.createElement('button');\r\n                        button.innerHTML = text;\r\n                        button.setAttribute('title', text);\r\n                        button.classList.add(className);\r\n                        button.dataset.layerId = layerId;\r\n                        container.appendChild(button);\r\n                    }\r\n                }\r\n            }\r\n            return button;\r\n        },\r\n        actionFn: function () {\r\n            const button = this;\r\n            var li = button;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const info = li.querySelector('.' + self.CLASS + '-info');\r\n            const layer = self.map.getLayer(button.dataset.layerId);\r\n            // Cargamos la imagen de la leyenda\r\n            info.querySelectorAll('.' + self.CLASS + '-legend img').forEach(function (img) {\r\n                self.styleLegendImage(img, layer);\r\n            });\r\n            info.classList.toggle(TC.Consts.classes.HIDDEN);\r\n\r\n            if (li.querySelector('input[type=\"checkbox\"]').checked) {\r\n                const dragHandle = li.querySelector('.' + self.CLASS + '-dd');\r\n                dragHandle.classList.toggle(TC.Consts.classes.HIDDEN, !info.classList.contains(TC.Consts.classes.HIDDEN));\r\n            }\r\n\r\n            button.classList.toggle(TC.Consts.classes.CHECKED);\r\n        }\r\n    });\r\n\r\n    self.addLayerTool({\r\n        renderFn: function (container, layerId) {\r\n            const className = self.CLASS + '-btn-dl';\r\n\r\n            let button = container.querySelector('button.' + className);\r\n            if (!button) {\r\n                const layer = self.map.getLayer(layerId);\r\n                if (TC.layer.Vector && layer instanceof TC.layer.Vector) {\r\n                    const text = self.getLocaleString('downloadFeatures');\r\n                    button = document.createElement('button');\r\n                    button.innerHTML = text;\r\n                    button.setAttribute('title', text);\r\n                    button.classList.add(className);\r\n                    button.dataset.layerId = layerId;\r\n                    container.appendChild(button);\r\n                }\r\n            }\r\n            return button;\r\n        },\r\n        actionFn: function () {\r\n            const button = this;\r\n            var li = button;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = self.map.getLayer(button.dataset.layerId);\r\n            self.getDownloadDialog().then(function (control) {\r\n                const title = layer.title || '';\r\n                const options = {\r\n                    title: `${title} - ${self.getLocaleString('downloadFeatures')}`,\r\n                    fileName: /\\.[a-z0-9]+$/i.test(title) ? title.substr(0, title.lastIndexOf('.')) : title,\r\n                    elevation: self.map.elevation && self.map.elevation.options\r\n                };\r\n                control.open(layer.features, options);\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\nTC.inherit(TC.control.WorkLayerManager, TC.control.TOC);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.WorkLayerManager.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-wlm';\r\n    ctlProto.CLICKEVENT = 'click';\r\n\r\n    TC.Consts.classes.DRAG = TC.Consts.classes.DRAG || 'tc-drag';\r\n    TC.Consts.classes.DRAGEND = TC.Consts.classes.DRAGEND || 'tc-dragend';\r\n\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-wlm.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-elm'] = TC.apiLocation + \"TC/templates/tc-ctl-wlm-elm.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-type-sgl'] = TC.apiLocation + \"TC/templates/tc-ctl-wlm-type-sgl.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-type-grp'] = TC.apiLocation + \"TC/templates/tc-ctl-wlm-type-grp.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-type-grp-node'] = TC.apiLocation + \"TC/templates/tc-ctl-wlm-type-grp-node.hbs\";\r\n\r\n    const findLayerElement = function (ctl, layer) {\r\n        return ctl.getLayerUIElements().filter(function (li) {\r\n            return li.dataset.layerId === layer.id;\r\n        })[0];\r\n    };\r\n\r\n    var getElligibleLayersNumber = function (ctl) {\r\n        return ctl.layers.length;\r\n    };\r\n\r\n    const shouldBeDelAllVisible = function (ctl) {\r\n        return !ctl.layers.some(function (layer) { return layer.unremovable });\r\n    };\r\n\r\n    const moveLayer = function (ctl, listItem, oldIndex, newIndex, callback) {\r\n        const layerItems = ctl.getLayerUIElements();\r\n        var targetItem;\r\n        if (newIndex > oldIndex) {\r\n            targetItem = layerItems[newIndex - 1];\r\n        }\r\n        else if (newIndex < oldIndex) {\r\n            targetItem = layerItems[newIndex + 1];\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        const sourceLayer = ctl.map.getLayer(listItem.dataset.layerId);\r\n        const targetLayer = ctl.map.getLayer(targetItem.dataset.layerId);\r\n        const newIdx = ctl.map.layers.indexOf(targetLayer);\r\n        if (newIdx >= 1 && newIdx < ctl.map.layers.length) {\r\n            ctl.map.insertLayer(sourceLayer, newIdx, callback);\r\n        }\r\n    };\r\n\r\n    ctlProto.render = function (callback, options) {\r\n        const self = this;\r\n        return self._set1stRenderPromise(self.map ? self.renderData(options ? TC.Util.extend(self.map.getLayerTree(), options) : self.map.getLayerTree(), function () {\r\n            self.addUIEventListeners();\r\n            TC.loadJS(\r\n                !window.Sortable,\r\n                [TC.apiLocation + 'lib/sortable/Sortable.min.js'],\r\n                function () {\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return !layer.stealth;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            self.updateLayerTree(layer);\r\n                        });\r\n\r\n\r\n                    const ul = self.div.querySelector('ul');\r\n                    self._sortable = Sortable.create(ul, {\r\n                        handle: '.' + self.CLASS + '-dd',\r\n                        animation: 150,\r\n                        onSort: function (e) {\r\n                            moveLayer(self, e.item, e.oldIndex, e.newIndex);\r\n                        }\r\n                    });\r\n\r\n                    ul.addEventListener('keydown', TC.EventTarget.listenerBySelector('li', function (e) {\r\n                        // Para mover capas con el teclado.\r\n                        var elm = e.target;\r\n                        while (elm.tagName !== 'LI') {\r\n                            elm = elm.parentElement;\r\n                            if (!elm) {\r\n                                return;\r\n                            }\r\n                        }\r\n                        const swap = function (oldIdx, newIdx) {\r\n                            const sortableItems = self._sortable.toArray();\r\n                            const buffer = sortableItems[oldIdx];\r\n                            sortableItems[oldIdx] = sortableItems[newIdx];\r\n                            sortableItems[newIdx] = buffer;\r\n                            self._sortable.sort(sortableItems);\r\n                            moveLayer(self, elm, oldIdx, newIdx);\r\n                        };\r\n                        const listItems = self.getLayerUIElements();\r\n                        const elmIdx = listItems.indexOf(elm);\r\n                        switch (true) {\r\n                            case /Up$/.test(e.key):\r\n                                if (elmIdx > 0) {\r\n                                    swap(elmIdx, elmIdx - 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Down$/.test(e.key):\r\n                                if (elmIdx < listItems.length - 1) {\r\n                                    swap(elmIdx, elmIdx + 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Enter$/.test(e.key):\r\n                                elm.blur();\r\n                                e.stopPropagation();\r\n                                break;\r\n                            default:\r\n                                break;\r\n                        }\r\n                    }));\r\n\r\n                    if (typeof callback === 'function') {\r\n                        callback();\r\n                    }\r\n                }\r\n            );\r\n        }) : Promise.reject(Error('Cannot render: control has no map')));\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.TOC.prototype.register.call(self, map).then(function () {\r\n\r\n                map.loaded(function () {                   \r\n                    self.updateScale();\r\n                });\r\n\r\n                map\r\n                    .on(TC.Consts.event.LAYEROPACITY, function (e) {\r\n                        const li = findLayerElement(self, e.layer);\r\n                        if (li) {\r\n                            li.querySelector('input[type=range]').value = Math.round(e.opacity * 100);\r\n                        }\r\n                    })\r\n                    .on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n                        var fileName = e.fileName;\r\n                        if (e.features && e.features.length > 0) { // GLS: Escuchamos al evento FEATURESIMPORT para poder desplegar el control de capas cargadas\r\n                            // Ignoramos los GPX (se supone que los gestionará Geolocation)\r\n                            var pattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n                            if (e.fileName.toLowerCase().indexOf(pattern) === e.fileName.length - pattern.length) {\r\n                                return;\r\n                            }\r\n\r\n                            map.one(TC.Consts.event.LAYERADD, function (e) {\r\n                                if (e && e.layer && e.layer.title == fileName) {\r\n                                    // Desplegamos el control capas cargadas\r\n                                    if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                                        if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                            self.map.controls\r\n                                                .filter(function (ctl) {\r\n                                                    // Todos los otros controles que no cuelgan de otro control\r\n                                                    return ctl !== self && !ctl.containerControl;\r\n                                                })\r\n                                                .forEach(function (ctl) {\r\n                                                    ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                                });\r\n                                        }\r\n                                    }\r\n\r\n                                    // abrimos el panel de herramientas\r\n                                    self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n\r\n                                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                                }\r\n                            });\r\n                        }\r\n                    });\r\n                resolve(self);\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e) {\r\n        // Este control no tiene que aceptar servicios externos directamente\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) {\r\n            // al estar en ipad el evento pasa a ser touchstart en la constante: TC.Consts.event.CLICK, los checkbox no funcionan bien con este evento\r\n            const checkbox = e.target;\r\n            var li = checkbox;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && !li.matches('li.' + self.CLASS + '-elm'));\r\n\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            layer.setVisibility(checkbox.checked);\r\n            e.stopPropagation();\r\n        }));\r\n\r\n        const inputRangeListener = function (e) {\r\n            const range = e.target;\r\n            var li = range;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            layer.setOpacity(range.value / 100);\r\n        };\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n        self.div.addEventListener('input', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector(`.${self.CLASS}-btn-del:not(.disabled)`, function (e) {\r\n            var li = e.target;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            self.map.removeLayer(layer);\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-del-all', function (e) {\r\n            TC.confirm(self.getLocaleString('layersRemove.confirm'), function () {\r\n                self.getLayerUIElements()\r\n                    .map(function (li) {\r\n                        return self.map.getLayer(li.dataset.layerId);\r\n                    })\r\n                    .forEach(function (layer) {\r\n                        self.map.removeLayer(layer);\r\n                    });\r\n            });\r\n        }));\r\n\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        const self = this;\r\n        const li = findLayerElement(self, layer);\r\n        if (li) {\r\n            const visible = layer.getVisibility();\r\n            li.querySelector('input[type=\"checkbox\"]').checked = visible;\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;        \r\n\r\n        var getLegendImgByPost = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                if (layer && layer.options.method && layer.options.method === \"POST\") {\r\n                    layer.getLegendGraphicImage()\r\n                        .then(function (src) {\r\n                            resolve(src);\r\n                        })\r\n                        .catch(function (err) { TC.error(err); });\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        };\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            var alreadyExists = false;\r\n            for (var i = 0, len = self.layers.length; i < len; i++) {\r\n                if (layer === self.layers[i]) {\r\n                    alreadyExists = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!alreadyExists) {\r\n                self.layers.push(layer);\r\n\r\n                var domReadyPromise;\r\n                var layerTitle = layer.title || layer.wrap.getServiceTitle();\r\n                var layerData = {\r\n                    title: layer.options.hideTitle ? '' : layerTitle,\r\n                    hide: layer.renderOptions && layer.renderOptions.hide ? true : false,\r\n                    opacity: layer.renderOptions && layer.renderOptions.opacity ? (layer.renderOptions.opacity * 100) : 100,\r\n                    customLegend: layer.customLegend,\r\n                    unremovable: layer.unremovable,\r\n                    id: layer.id\r\n                };\r\n                var isRaster = layer.isRaster();\r\n                if (isRaster) {\r\n                    layerData.hasExtent = !!layer.getExtent();\r\n                    layerData.layerNames = layer.layerNames;\r\n                    var path = layer.getPath();\r\n                    path.shift();\r\n                    layerData.path = path;\r\n                    var name = layer.names[0];\r\n                    var info = layer.getInfo(name);\r\n                    layerData.legend = info.legend;\r\n                    layerData['abstract'] = info['abstract'];\r\n                    layerData.metadata = info.metadata;\r\n                }\r\n                else {\r\n                    layerData.hasExtent = true;\r\n                }\r\n\r\n\r\n                getLegendImgByPost(layer).then(function (src) {\r\n                    if (src) {\r\n                        legend.src = src; // ya se ha validado en getLegendImgByPost\r\n                    }\r\n                             \r\n                    self.getRenderedHtml(self.CLASS + '-elm', layerData).then(function (out) {\r\n                        const parser = new DOMParser();\r\n                        const li = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                        var layerNode;\r\n                        var isGroup = false;\r\n                        if (isRaster) {\r\n                            isGroup = layer.names.length > 1;\r\n                            if (!isGroup) {\r\n                                var layerNodes = layer.wrap.getAllLayerNodes();\r\n                                for (var i = 0; i < layerNodes.length; i++) {\r\n                                    var node = layerNodes[i];\r\n                                    if (layer.wrap.getName(node) === name) {\r\n                                        layerNode = node;\r\n                                        if (layer.wrap.getLayerNodes(node).length > 0) {\r\n                                            isGroup = true;\r\n                                        }\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        const typeElm = li.querySelector('.' + self.CLASS + '-type');\r\n                        const className = isGroup ? self.CLASS + '-type-grp' : self.CLASS + '-type-sgl';\r\n                        typeElm.classList.add(className);\r\n\r\n                        const zoomBtn = li.querySelector(`.${self.CLASS}-btn-zoom`);\r\n                        if (zoomBtn) {\r\n                            zoomBtn.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                                self.map.zoomToLayer(li.dataset.layerId, { animate: true });\r\n                            }, { passive: true });\r\n                        }\r\n\r\n                        if (layerNode) {\r\n                            layer.wrap.normalizeLayerNode(layerNode);\r\n\r\n                            self.getRenderedHtml(className, layerNode).then(function (out) {\r\n                                var tip;\r\n\r\n                                typeElm.addEventListener('mouseover', function (e) {\r\n                                    const mapDiv = self.map.div;\r\n                                    const typeElmRect = typeElm.getBoundingClientRect();\r\n                                    tip = document.createElement('div');\r\n                                    tip.classList.add(self.CLASS + '-tip');\r\n                                    tip.innerHTML = out;\r\n                                    tip.style.top = (typeElmRect.top - mapDiv.offsetTop) + 'px';\r\n                                    tip.style.right = mapDiv.offsetWidth - (typeElmRect.left - mapDiv.offsetLeft) + 'px';\r\n                                    mapDiv.appendChild(tip);\r\n                                });\r\n                                typeElm.addEventListener('mouseout', function (e) {\r\n                                    tip.parentElement.removeChild(tip);\r\n                                });\r\n                            });\r\n                        }\r\n                        const ul = self.div.querySelector('ul');\r\n                        li.dataset.layerId = layer.id;\r\n\r\n                        const lis = self.getLayerUIElements();\r\n                        const layerList = self.map.workLayers\r\n                            .filter(function (l) {\r\n                                return !l.stealth;\r\n                            });\r\n                        const layerIdx = layerList.indexOf(layer);\r\n\r\n                        self.layerTools.forEach(tool => self.addLayerToolUI(li, tool));\r\n\r\n                        var inserted = false;\r\n                        for (var i = 0, ii = lis.length; i < ii; i++) {\r\n                            const referenceLi = lis[i];\r\n                            const referenceLayerIdx = layerList.indexOf(self.map.getLayer(referenceLi.dataset.layerId));\r\n                            if (referenceLayerIdx < layerIdx) {\r\n                                referenceLi.insertAdjacentElement('beforebegin', li);\r\n                                inserted = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (!inserted) {\r\n                            ul.appendChild(li);\r\n                        }\r\n\r\n                        if (domReadyPromise) domReadyPromise(li);\r\n                        self.updateScale();\r\n                    });\r\n                });\r\n\r\n                var elligibleLayersNum = getElligibleLayersNumber(self);\r\n                const numElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n                const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n                const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n                numElm.textContent = elligibleLayersNum;\r\n                if (elligibleLayersNum > 0) {\r\n                    numElm.classList.add(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else {\r\n                    numElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n\r\n                const deleteAllElm = self.div.querySelector('.' + self.CLASS + '-del-all');\r\n                deleteAllElm.classList.toggle(TC.Consts.classes.HIDDEN, !shouldBeDelAllVisible(self));\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer && layer.names) {\r\n                var isVisible = false;\r\n                for (var i = 0; i < layer.names.length; i++) {\r\n                    if (layer.isVisibleByScale(layer.names[i])) {\r\n                        isVisible = true;\r\n                        break;\r\n                    }\r\n                }\r\n                li.classList.toggle(self.CLASS + '-elm-notvisible', !isVisible);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        //TC.control.MapContents.prototype.updateLayerOrder.call(this, layer, oldIdx, newIdx);\r\n        const self = this;\r\n        self.map.workLayers\r\n            .filter(function (layer) {\r\n                return !layer.stealth;\r\n            })\r\n            .forEach(function (layer) {\r\n                const li = findLayerElement(self, layer);\r\n                if (li) {\r\n                    li.parentElement.firstChild.insertAdjacentElement('beforebegin', li);\r\n                }\r\n            });\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        var self = this;\r\n        var idx = self.layers.indexOf(layer);\r\n        if (idx >= 0) {\r\n            self.layers.splice(idx, 1);\r\n        }\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if (li.dataset.layerId === layer.id) {\r\n                li.parentElement.removeChild(li);\r\n            }\r\n        });\r\n        const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n        const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n        const numberElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n        var nChildren = getElligibleLayersNumber(self);\r\n        numberElm.textContent = nChildren;\r\n        if (nChildren > 0) {\r\n            contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.add(TC.Consts.classes.VISIBLE);\r\n        }\r\n        else {\r\n            if (shouldBeDelAllVisible(self)) {\r\n                self.div.querySelector('.' + self.CLASS + '-del-all').classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n            contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        return Array.from(self.div.querySelectorAll(`ul > li.${self.CLASS}-elm`));\r\n    };\r\n\r\n    ctlProto.addLayerToolUI = function (elm, tool) {\r\n        const self = this;\r\n        if (TC.Util.isFunction(tool.renderFn)) {\r\n            const button = tool.renderFn(elm.querySelector(`.${self.CLASS}-tools`), elm.dataset.layerId);\r\n            if (button) {\r\n                if (TC.Util.isFunction(tool.actionFn)) {\r\n                    button.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                        tool.actionFn.call(button);\r\n                    }, { passive: true });\r\n                }\r\n                if (TC.Util.isFunction(tool.updateFn) && tool.updateEvents) {\r\n                    map.on(tool.updateEvents.join(' '), function (e) {\r\n                        if (!e.layer || e.layer.id === button.dataset.layerId) {\r\n                            tool.updateFn.call(button, e);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.addLayerTool = function (options) {\r\n        const self = this;\r\n        self.layerTools.push(options);\r\n        self.getLayerUIElements().forEach(function (elm) {\r\n            self.addLayerToolUI(elm, options);\r\n        });\r\n    };\r\n})();"]}