{"version":3,"sources":["control/BasemapSelector.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","BasemapSelector","self","this","apply","arguments","layerInfos","_cssClasses","LOAD_CRS_BUTTON","CLASS","CRS_DIALOG","CRS_LIST","VIEW_BTN","CURRENT_CRS_NAME","CURRENT_CRS_CODE","TREE","DETAILS","GRID","_dialogDiv","Util","getDiv","options","dialogDiv","window","$","_$dialogDiv","document","body","appendChild","addEventListener","Consts","event","CLICK","EventTarget","listenerBySelector","e","target","classList","contains","loadFallbackProjections","closeModal","btn","crs","dataset","crsCode","dialog","querySelector","add","classes","HIDDEN","layer","getLayer","layerId","loadProjDef","callback","map","setProjection","baseLayer","fallbackLayer","getFallbackLayer","fallbackLayerId","setBaseLayer","passive","inherit","ctlProto","prototype","template","1","container","depth0","helpers","partials","data","blockParams","depths","stack1","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","invokePartial","name","hash","controlId","indent","decorators","3","alias1","nullContext","alias2","escapeExpression","loc","start","line","column","end","lambda","compiler","main","fn","program","inverse","noop","usePartial","useData","useDepths","alias3","2","4","6","8","9","10","12","getClosestParent","elm","selector","matches","parentElement","changeInputRadioBaseMap","flagToCallback","radio","dialogMore","radios","div","querySelectorAll","i","len","length","bmsLayer","id","getBaseLayer","mustReproject","on3DView","_currentSelection","checked","stopPropagation","_capabilitiesPromise","then","isCompatible","getCRS","dialogOptions","showProjectionChangeDialog","type","layerType","WMS","WMTS","getProjection","register","Promise","resolve","reject","ctl","toggleView","blur","remove","COLLAPSED","on","VIEWCHANGE","_getMoreBaseLayers","BASELAYERCHANGE","PROJECTIONCHANGE","update","value","showMoreLayersDialog","render","result","extend","getRenderedHtml","html","innerHTML","toggleMoreLayersDialogView","close","async","_moreBaseLayersPromise","Array","from","forEach","li","idx","arr","curBaseLayer","fbLayer","otherLayerIsFallback","filter","some","getCapabilitiesPromise","DISABLED","setAttribute","getLocaleString","removeAttribute","updateScale","updateLayerTree","isBase","stealth","firstOption","displayLayer","layerTrees","getTree","getInfo","names","info","out","newLi","DOMParser","parseFromString","firstChild","uid","layerUid","ul","currentLi","setLayerIds","baseLayers","indexOf","inserted","curLi","insertAdjacentElement","ii","moreLabel","catch","err","error","updateLayerOrder","oldIdx","newIdx","removeLayer","lis","removeChild","onErrorLayer","toast","mapName","title","msgType","ERROR","filterFn","baseLayersWithFallback","_moreBaseLayers","modalBody","LOADING","blCRSList","getCompatibleCRS","loadProjections","crsList","layers","workLayers","concat","includeFallbacks","orderBy","projList","hasFallbackCRS","fragment","createDocumentFragment","projObj","createElement","button","CRSCodesEqual","code","WARNING","showModal","toggle","THREED","closeCallback","bind","isGrid","processLayer","bl","renderBody","moreBaseLayers","slice","tree","layerIdx","insertAdjacentHTML","toggleUI","setTimeout","getTo3DVIew","all","partialCallback","matrixSet","wrap","getCompatibleMatrixSets","noDyn","Cfg","availableBaseLayers","l","Raster","VECTOR","Vector","addLayer","splice","isFunction","res","rej","fail","finally"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGC,QAAQC,aACZF,GAAGG,WAAWH,GAAGI,YAAc,2BAGnC,WAEIJ,GAAGC,QAAQI,gBAAkB,WACzB,IAAIC,EAAOC,KAGXP,GAAGC,QAAQC,YAAYM,MAAMF,EAAMG,WAEnCH,EAAKI,WAAa,GAElBJ,EAAKK,YAAc,CACfC,gBAAiBN,EAAKO,MAAQ,gBAC9BC,WAAYR,EAAKO,MAAQ,cACzBE,SAAUT,EAAKO,MAAQ,YACvBG,SAAUV,EAAKO,MAAQ,YACvBI,iBAAkBX,EAAKO,MAAQ,gBAC/BK,iBAAkBZ,EAAKO,MAAQ,gBAC/BM,KAAMb,EAAKO,MAAQ,QACnBO,QAAS,aACTC,KAAM,WAGVf,EAAKgB,WAAatB,GAAGuB,KAAKC,OAAOlB,EAAKmB,QAAQC,WAC1CC,OAAOC,IACPtB,EAAKuB,YAAcD,EAAEtB,EAAKgB,aAEzBhB,EAAKmB,QAAQC,WACdI,SAASC,KAAKC,YAAY1B,EAAKgB,YAGnChB,EAAKgB,WAAWW,iBAAiBjC,GAAGkC,OAAOC,MAAMC,MAAOpC,GAAGqC,YAAYC,mBAAmB,8BAA+B,SAAUC,GAE/H,GAAIA,EAAEC,OAAOC,UAAUC,SAASpC,EAAKK,YAAYC,iBAAkB,CAC/DN,EAAKqC,0BACL,OAGJ3C,GAAGuB,KAAKqB,aACR,MAAMC,EAAMN,EAAEC,OACRM,EAAMD,EAAIE,QAAQC,QAGlBC,EAAS3C,EAAKgB,WAAW4B,cAAc,IAAM5C,EAAKO,MAAQ,eAChEoC,EAAOR,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQC,QAEvC,MAAMC,EAAQhD,EAAKiD,SAASN,EAAOF,QAAQS,SAC3C,GAAIF,EACA,GAAIR,EACA9C,GAAGyD,YAAY,CACXX,IAAKA,EACLY,SAAU,WACNpD,EAAKqD,IAAIC,cAAc,CACnBd,IAAKA,EACLe,UAAWP,WAKtB,CACD,MAAMQ,EAAgBxD,EAAKyD,iBAAiBlB,EAAIE,QAAQiB,iBACpDF,GACAxD,EAAKqD,IAAIM,aAAaH,MAIlC,CAAEI,SAAS,KAGnBlE,GAAGmE,QAAQnE,GAAGC,QAAQI,gBAAiBL,GAAGC,QAAQC,aAElD,IAAIkE,EAAWpE,GAAGC,QAAQI,gBAAgBgE,UAE1CD,EAASvD,MAAQ,aAEjBuD,EAASE,SAAW,GACpBF,EAASE,SAASF,EAASvD,OAAS,CAAC0D,EAAI,SAASC,EAAUC,EAAOC,EAAQC,EAASC,EAAKC,EAAYC,GAAa,IAAIC,EAAQC,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAAiU,OAAxTH,EAASP,EAAUc,cAAcN,EAAeL,EAAS,mBAAmBF,EAAO,CAACc,KAAO,kBAAkBC,KAAO,CAACC,UAA0B,MAAbX,EAAO,GAAaE,EAAeF,EAAO,GAAG,aAAeA,EAAO,IAAKF,KAAOA,EAAKc,OAAS,WAAWhB,QAAUA,EAAQC,SAAWA,EAASgB,WAAanB,EAAUmB,cAAwBZ,EAAS,IAAMa,EAAI,SAASpB,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIiB,EAAiB,MAAVpB,EAAiBA,EAAUD,EAAUsB,aAAe,GAAKC,EAAOvB,EAAUwB,iBAAkBhB,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,kFAA4Fa,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,qBAAqB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,+BAAwCL,EAAOvB,EAAU8B,OAAkB,MAAV7B,EAAiBO,EAAeP,EAAO,aAAeA,EAASA,IAAc,6GAAuHsB,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,qBAAqB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,oCAAqCG,SAAW,CAAC,EAAE,YAAYC,KAAO,SAAShC,EAAUC,EAAOC,EAAQC,EAASC,EAAKC,EAAYC,GAAa,IAAIC,EAAQc,EAAiB,MAAVpB,EAAiBA,EAAUD,EAAUsB,aAAe,GAAKC,EAAOvB,EAAUwB,iBAAkBhB,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,OAAYa,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,iBAAiB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,sEAA8EL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,kBAAkB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,uGAAqa,OAAnTrB,EAASC,EAAeN,EAAQ,QAAQW,KAAKQ,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,cAAgBA,EAAQ,CAACc,KAAO,OAAOC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,EAAGC,EAAaC,GAAQ6B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAkBrB,EAAS,KAA2T,OAAhTA,EAASC,EAAeN,EAAQ,MAAMW,KAAKQ,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,cAAgBA,EAAQ,CAACc,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,EAAGC,EAAaC,GAAQ6B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBrB,EAAS,IAAS,uBAAwB8B,YAAa,EAAKC,SAAU,EAAKC,WAAY,GACthH3C,EAASE,SAASF,EAASvD,MAAQ,SAAW,CAAC0D,EAAI,SAASC,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQc,EAAOrB,EAAU8B,OAAQP,EAAOvB,EAAUwB,iBAAkBgB,EAAiB,MAAVvC,EAAiBA,EAAUD,EAAUsB,aAAe,GAAKd,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,gDAAwDa,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,QAAUA,EAASN,IAAc,oBAA2BsB,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,MAAQA,EAASN,IAAc,qBAA4BsB,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,OAASA,EAASN,IAAc,YAA2W,OAAxVM,EAASC,EAAeN,EAAQ,MAAMW,KAAK2B,EAAiF,OAAxEjC,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,UAAYA,EAAQ,CAACQ,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBrB,EAAS,KAAsW,OAA3VA,EAASC,EAAeN,EAAQ,MAAMW,KAAK2B,EAAiF,OAAxEjC,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,aAAeA,EAAQ,CAACQ,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,KAAKC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBrB,EAAS,IAAS,kCAA0CgB,EAAOF,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,aAAeA,EAASA,IAAc,eAAsBsB,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,QAAUA,EAASN,IAAc,KAA0W,OAA9VM,EAASC,EAAeN,EAAQ,MAAMW,KAAK2B,EAAiF,OAAxEjC,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,iBAAmBA,EAAQ,CAACQ,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAmBrB,EAAS,IAAS,cAAmBgB,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,SAAWA,EAASN,IAAc,+DAAsEsB,EAAOF,EAAiF,OAAxEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,SAAWA,EAASN,IAAc,aAAwS,OAArRM,EAASC,EAAeN,EAAQ,MAAMW,KAAK2B,EAAkB,MAAVvC,EAAiBO,EAAeP,EAAO,QAAUA,EAAQ,CAACc,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBrB,EAAS,IAAS,uBAAwBkC,EAAI,SAASzC,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQC,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,iCAAuCV,EAAUwB,iBAAiBxB,EAAU8B,OAAiJ,OAAxIvB,EAAmF,OAAxEA,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,UAAYA,GAAmBC,EAAeD,EAAO,OAASA,EAASN,IAAc,MAAQyC,EAAI,SAAS1C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQC,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,iCAAuCV,EAAUwB,iBAAiBxB,EAAU8B,OAAiF,OAAxEvB,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,SAAWA,GAAmBO,EAAeD,EAAO,aAAeA,EAASN,IAAc,MAAQ0C,EAAI,SAAS3C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,MAAO,wBAA2BwC,EAAI,SAAS5C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQC,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,cAAmBV,EAAUwB,iBAAiBxB,EAAU8B,OAAgF,OAAvEvB,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,QAAUA,GAAmBO,EAAeD,EAAO,YAAcA,EAASN,IAAc,YAA0Z,OAAxYM,EAASC,EAAeN,EAAQ,MAAMW,KAAe,MAAVZ,EAAiBA,EAAUD,EAAUsB,aAAe,GAA6E,OAAvEf,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,QAAUA,GAAmBO,EAAeD,EAAO,YAAcA,EAAQ,CAACQ,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBrB,EAAS,KAAMsC,EAAI,SAAS7C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQc,EAAiB,MAAVpB,EAAiBA,EAAUD,EAAUsB,aAAe,GAAKd,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,gEAAuEV,EAAUwB,iBAAiBhB,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,WAAW,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,iCAAqY,OAA9VrB,EAASC,EAAeN,EAAQ,QAAQW,KAAKQ,EAAgF,OAAvEd,EAAoB,MAAVN,EAAiBO,EAAeP,EAAO,QAAUA,GAAmBO,EAAeD,EAAO,YAAcA,EAAQ,CAACQ,KAAO,OAAOC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,GAAI9B,EAAM,GAAG+B,QAAUnC,EAAUoC,KAAKhC,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAkBrB,EAAS,IAAS,uCAAwCuC,GAAK,SAAS9C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQc,EAAOrB,EAAU8B,OAAQP,EAAOvB,EAAUwB,iBAAkBhB,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,iCAA8H,OAAtFH,EAASc,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,OAASA,EAASA,IAAmBM,EAAS,IAAS,WAAkBgB,EAAOF,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,UAAYA,EAASA,IAAc,YAAmBsB,EAAOF,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,qBAAuBA,EAASA,IAAc,qBAA6BsB,EAAOF,EAAkB,MAAVpB,EAAiBO,EAAeP,EAAO,qBAAuBA,EAASA,IAAc,iBAAkB8C,GAAK,SAAS/C,EAAUC,EAAOC,EAAQC,EAASC,GAAW,MAAO,2EAAgF2B,SAAW,CAAC,EAAE,YAAYC,KAAO,SAAShC,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIG,EAAQC,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,OAA+V,OAAtVH,EAASC,EAAeN,EAAQ,MAAMW,KAAe,MAAVZ,EAAiBA,EAAUD,EAAUsB,aAAe,GAAe,MAAVrB,EAAiBO,EAAeP,EAAO,SAAWA,EAAQ,CAACc,KAAO,KAAKC,KAAO,GAAGiB,GAAKjC,EAAUkC,QAAQ,EAAG9B,EAAM,GAAG+B,QAAUnC,EAAUkC,QAAQ,GAAI9B,EAAM,GAAGA,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,GAAGC,IAAM,CAACF,KAAO,GAAGC,OAAS,OAAiBrB,EAAS,IAAM+B,SAAU,GACviQ1C,EAASE,SAASF,EAASvD,MAAQ,WAAa,CAAC0F,SAAW,CAAC,EAAE,YAAYC,KAAO,SAAShC,EAAUC,EAAOC,EAAQC,EAASC,GAAW,IAAIiB,EAAiB,MAAVpB,EAAiBA,EAAUD,EAAUsB,aAAe,GAAKC,EAAOvB,EAAUwB,iBAAkBhB,EAAiBR,EAAUQ,gBAAkB,SAASC,EAAQC,GAAuB,GAAIC,OAAOd,UAAUe,eAAeC,KAAKJ,EAAQC,GAA0B,OAAOD,EAAOC,IAAuD,MAAO,0NAAuOa,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,iBAAiB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,QAAa,0FAAkGL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,kBAAkB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,EAAEC,OAAS,IAAIC,IAAM,CAACF,KAAO,EAAEC,OAAS,SAAc,2PAA2QL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,QAAQ,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,gRAA6RL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,yBAAyB,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,sIAA+IL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,sCAAsC,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,0MAAuNL,EAAOf,EAAeN,EAAQ,QAAQW,KAAKQ,EAAO,QAAQ,CAACN,KAAO,OAAOC,KAAO,GAAGZ,KAAOA,EAAKqB,IAAM,CAACC,MAAQ,CAACC,KAAO,GAAGC,OAAS,IAAIC,IAAM,CAACF,KAAO,GAAGC,OAAS,QAAa,+DAAgEU,SAAU,GAEz0F,MAAMU,EAAmB,SAAUC,EAAKC,GACpC,KAAOD,IAAQA,EAAIE,QAAQD,IACvBD,EAAMA,EAAIG,cAEd,OAAOH,GAGLI,EAA0B,SAAUtF,EAAGmB,GACzC,MAAMpD,EAAOC,KACb,IAAIuH,GAAiB,EAEjBC,EAAQxF,EAAEC,OAEVc,EAAQhD,EAAKiD,SAASiE,EAAiBO,EAAO,MAAMhF,QAAQS,SAEhE,GAAIlD,EAAKmB,QAAQuG,YAAcR,EAAiBO,EAAO,IAAMzH,EAAKO,MAAQ,gBAAiB,CACvF,MAAMoH,EAAS3H,EAAK4H,IAAIC,iBAAiB,qBACzC,IAAK,IAAIC,EAAI,EAAGC,EAAMJ,EAAOK,OAAQF,EAAIC,EAAKD,IAAK,CAC/C,MAAMG,EAAWjI,EAAKiD,SAASiE,EAAiBS,EAAOG,GAAI,MAAMrF,QAAQS,SACzE,GAAI+E,EACA,QAAQ,GACJ,KAAKA,EAASC,KAAOlF,EAAMkF,GACvBlF,EAAQiF,IAO5B,GAAIjF,GAAShD,EAAKqD,IAAI8E,eAClB,GAAInF,EAAMoF,cAEN,GAAIpI,EAAKqD,IAAIgF,SAAU,CACnB,IAAKrF,EAAMS,mBAAoB,CAC3BzD,EAAKsI,kBAAkBC,SAAU,EACjCtG,EAAEuG,kBACF,OACG,GAAIxF,EAAMS,mBAAoB,CACjC,MAAMD,EAAgBR,EAAMS,mBACxBD,GACAA,EAAciF,qBAAqBC,KAAK,WAChClF,EAAcmF,aAAa3I,EAAKqD,IAAIuF,WACpC5I,EAAKqD,IAAIM,aAAaX,KAKlCwE,GAAiB,OAElB,CAECxH,EAAKsI,oBACLtI,EAAKsI,kBAAkBC,SAAU,GAIrC,MAAMM,EAAgB,CAClB7F,MAAOA,GAELQ,EAAgBR,EAAMS,mBACxBD,EACAA,EAAciF,qBAAqBC,KAAK,WAChClF,EAAcmF,aAAa3I,EAAKqD,IAAIuF,YACpCC,EAAcrF,cAAgBA,GAElCxD,EAAK8I,2BAA2BD,KAIpC7I,EAAK8I,2BAA2BD,GAGpCrB,GAAiB,MAIpB,EAEGxE,EAAM+F,OAASrJ,GAAGkC,OAAOoH,UAAUC,KAAOjG,EAAM+F,OAASrJ,GAAGkC,OAAOoH,UAAUE,MAAQlG,EAAMmG,kBAAoBnJ,EAAKqD,IAAIb,MACxHQ,EAAMM,cAAc,CAAEd,IAAKxC,EAAKqD,IAAIb,MAGxCxC,EAAKqD,IAAIM,aAAaX,GAI1B/C,KAAKqI,oBACLrI,KAAKqI,kBAAkBC,SAAU,GAIjCnF,GACAA,EAASoE,IAIjB1D,EAASsF,SAAW,SAAU/F,GAC1B,MAAMrD,EAAOC,KAEb,OAAO,IAAIoJ,QAAQ,SAAUC,EAASC,GAClC7J,GAAGC,QAAQC,YAAYmE,UAAUqF,SAASrE,KAAK/E,EAAMqD,GAAKqF,KAAK,SAAUc,GACrExJ,EAAK4H,IAAIhF,kBAAkB5C,EAAKK,YAAYK,YAAYiB,iBAAiBjC,GAAGkC,OAAOC,MAAMC,MAAO,SAAUG,GACtGjC,EAAKyJ,aACLxH,EAAEC,OAAOwH,OACT1J,EAAK4H,IAAIzF,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQ8G,WAC5C3H,EAAEuG,mBACH,CAAE5E,SAAS,IAEV5D,EAAKmB,QAAQuG,YACbrE,EAAIwG,GAAGnK,GAAGkC,OAAOC,MAAMiI,WAAY,WAC/B9J,EAAK+J,uBAIb1G,EAAIwG,GAAGnK,GAAGkC,OAAOC,MAAMmI,gBAAkB,IAAMtK,GAAGkC,OAAOC,MAAMoI,iBAAmB,IAAMvK,GAAGkC,OAAOC,MAAMiI,WAAY,SAAU7H,GAC1HjC,EAAKkK,OAAOlK,EAAK4H,IAAK3F,EAAEe,SAI5BhD,EAAK4H,IAAIjG,iBAAiB,SAAUjC,GAAGqC,YAAYC,mBAAmB,oBAAqB,SAAUC,GAE1E,eAAnBA,EAAEC,OAAOiI,MACTnK,EAAKoK,uBAEL7C,EAAwBxC,KAAK/E,EAAMiC,GAGvCA,EAAEuG,qBAGNc,EAAQE,QAKpB1F,EAASuG,OAAS,SAAUjH,GACxB,MAAMpD,EAAOC,KACPqK,EAAS5K,GAAGC,QAAQC,YAAYmE,UAAUsG,OAAOtF,KAAK/E,EAAMoD,EAAU1D,GAAGuB,KAAKsJ,OAAO,GAAIvK,EAAKmB,QAAS,CAAEgE,UAAWnF,EAAKkI,MAE/HlI,EAAKwK,gBAAgBxK,EAAKO,MAAQ,UAAW,KAAM,SAAUkK,GACzDzK,EAAKgB,WAAW0J,UAAYD,EAE5B,GAAIzK,EAAKmB,QAAQuG,WAAY,CACzB,MAAM/E,EAAS3C,EAAKgB,WAAW4B,cAAc,IAAM5C,EAAKO,MAAQ,gBAEhEoC,EAAOC,kBAAkB5C,EAAKK,YAAYK,YAAYiB,iBAAiBjC,GAAGkC,OAAOC,MAAMC,MAAO,SAAUG,GACpGjC,EAAK2K,6BACL1I,EAAEC,OAAOwH,OACTzH,EAAEuG,mBACH,CAAE5E,SAAS,IAEdjB,EAAOhB,iBAAiB,SAAUjC,GAAGqC,YAAYC,mBAAmB,oBAAqB,SAAUC,GAC/FsF,EAAwBxC,KAAK/E,EAAMiC,EAAG,SAAU2I,GACxCA,GACAlL,GAAGuB,KAAKqB,eAIhBL,EAAEuG,wBAKd,OAAO8B,GAGXxG,EAASoG,OAASW,eAAgBjD,EAAKrE,GACnC,MAAMvD,EAAOC,KAEb2H,EAAMA,GAAO5H,EAAK4H,UAEX5H,EAAK8K,wBAA0B9K,EAAK+J,sBAC3CgB,MAAMC,KAAKpD,EAAIC,uBAAuB7H,EAAKO,oBAAoB0K,QAAQ,SAAUC,EAAIC,EAAKC,GACtF,MAAMpI,EAAQhD,EAAKiD,SAASiI,EAAGzI,QAAQS,SACvC,GAAIF,EAAO,CACP,MAAMqI,EAAe9H,GAAavD,EAAKqD,IAAIE,UACrCkE,EAAQyD,EAAGtI,cAAc,qBACzB0I,EAAUtI,EAAMS,kBAAoBT,EAAMS,mBAChD,IAAI8E,EAAU8C,IAAiBA,IAAiBrI,GAASqI,EAAanD,KAAOlF,EAAMkF,IACnF,IAAKK,EAAS,CACV,MAAMgD,EAAuBD,GAAWF,EACnCI,OAAOrE,GAAOA,IAAQ+D,GACtBO,KAAKtE,GAAOA,EAAI1E,QAAQS,UAAYoI,EAAQpD,IACjDK,GAAWgD,GAAwBF,IAAiBA,IAAiBC,GAAYA,GAAWD,EAAanD,KAAOoD,EAAQpD,IAG5H,GAAIlI,EAAKqD,IAAIgF,UAAYrF,EAAMoF,eAAiBkD,EAC5CA,EAAQI,yBAAyBhD,KAAK,WAClC,IAAIN,GAAiBpF,EAAMS,mBAAmBkF,aAAa3I,EAAKqD,IAAIuF,UAEpEnB,EAAMc,QAAUA,EAChB,GAAIH,EAAe,CACfX,EAAMtF,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQ6I,UACtCT,EAAGU,aAAa,QAAS5L,EAAKqD,IAAIgF,SAAWrI,EAAK6L,gBAAgB,oBAAsB7L,EAAK6L,gBAAgB,2BAE5G,CACDpE,EAAMtF,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQ6I,UACzCT,EAAGY,gBAAgB,gBAGxB,CACHrE,EAAMc,QAAUA,EAChB,GAAIvF,EAAMoF,cAAe,CACrBX,EAAMtF,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQ6I,UACtCT,EAAGU,aAAa,QAAS5L,EAAKqD,IAAIgF,SAAWrI,EAAK6L,gBAAgB,oBAAsB7L,EAAK6L,gBAAgB,2BAE5G,CACDpE,EAAMtF,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQ6I,UACzCT,EAAGY,gBAAgB,UAIvBvD,IACAvI,EAAKsI,kBAAoBb,MAKrCzH,EAAK+L,eAGTjI,EAASkI,gBAAkB,SAAUhJ,GACjC,MAAMhD,EAAOC,KAEb,GAAI+C,EAAMiJ,UAAYjJ,EAAM7B,QAAQ+K,SAAYlJ,EAAMmJ,cAAgBnJ,EAAMmJ,YAAYhL,QAAQ+K,SAAW,CACvGxM,GAAGC,QAAQC,YAAYmE,UAAUiI,gBAAgBjH,KAAK/E,EAAMgD,GAE5D,MAAMoJ,EAAepJ,EAAMmJ,aAAenJ,EAEtCoJ,IAAiBpJ,IACjBhD,EAAKqM,WAAWD,EAAalE,IAAMkE,EAAaE,WAGhDF,EAAaG,UACbvM,EAAKI,WAAWgM,EAAalE,IAAMkE,EAAaG,QAAQH,EAAaI,MAAM,KAG/ExM,EAAKwK,gBAAgBxK,EAAKO,MAAQ,QAAS,CAAEyC,MAAOhD,EAAKqM,WAAWD,EAAalE,IAAKuE,KAAMzM,EAAKI,WAAWgM,EAAalE,IAAK/C,UAAWnF,EAAKkI,KAAMQ,KAAK,SAAUgE,GAC/J,MACMC,GADS,IAAIC,WACEC,gBAAgBH,EAAK,aAAajL,KAAKqL,WAC5D,IAAIC,EAAMJ,EAAMlK,QAAQuK,SACxB,MAAMC,EAAKjN,EAAK4H,IAAIhF,cAAc,IAAM5C,EAAKO,MAAQ,WAC/C2M,EAAYD,EAAGrK,cAAc,sBAAwBmK,EAAM,MACjE,GAAIG,EACAA,EAAUxC,UAAYiC,EAAMjC,cAE3B,CACDiC,EAAMlK,QAAQS,QAAUkJ,EAAalE,GAGrC,MAAMiF,EAAcnN,EAAKqD,IAAI+J,WACxB/J,IAAIE,GAAaA,EAAU4I,aAAe5I,GAC1CiI,OAAOjI,GAAaA,IAAcA,EAAU2I,SAC5C7I,IAAIE,GAAaA,EAAU2E,IAC1BiD,EAAMgC,EAAYE,QAAQjB,EAAalE,IAC7C,IAAIoF,GAAW,EACf,IAAK,IAAIxF,EAAIqD,EAAM,EAAGrD,GAAK,EAAGA,IAAK,CAC/B,MAAMyF,EAAQN,EAAGrK,mCAAmCuK,EAAYrF,QAChE,GAAIyF,EAAO,CACPA,EAAMC,sBAAsB,WAAYb,GACxCW,GAAW,EACX,OAGR,IAAKA,EAAU,CACX,IAAK,IAAIxF,EAAIqD,EAAM,EAAGsC,EAAKN,EAAYnF,OAAQF,EAAI2F,EAAI3F,IAAK,CACxD,MAAMyF,EAAQN,EAAGrK,mCAAmCuK,EAAYrF,QAChE,GAAIyF,EAAO,CACPA,EAAMC,sBAAsB,cAAeb,GAC3CW,GAAW,EACX,OAGR,IAAKA,EAAU,CACX,MAAMI,EAAYT,EAAGrK,kBAAkB5C,EAAKO,mBACxCmN,EACAA,EAAUpG,cAAckG,sBAAsB,cAAeb,GAG7DM,EAAGvL,YAAYiL,IAI3B3M,EAAKkK,YAEVyD,MAAM,SAAUC,GACflO,GAAGmO,MAAMD,OAKrB9J,EAASgK,iBAAmB,SAAU9K,EAAO+K,EAAQC,KAIrDlK,EAASmK,YAAc,SAAUjL,GAC7B,MAAMhD,EAAOC,KACb,GAAI+C,EAAMiJ,OAAQ,CACd,MAAMiC,EAAMlO,EAAK4H,IAAIhF,cAAc,IAAM5C,EAAKO,MAAQ,WAAWsH,iBAAiB,MAClF,IAAK,IAAIC,EAAI,EAAGC,EAAMmG,EAAIlG,OAAQF,EAAIC,EAAKD,IAAK,CAC5C,MAAMoD,EAAKgD,EAAIpG,GACf,GAAIoD,EAAGzI,QAAQS,UAAYF,EAAMkF,GAAI,CACjCgD,EAAG5D,cAAc6G,YAAYjD,GAC7B,UAMhBpH,EAASsK,aAAe,SAAUpL,GAC9B,MAAMhD,EAAOC,KAET+C,EAAMiJ,SAAWjJ,EAAM7B,QAAQ+K,SAC/BlM,EAAKqD,IAAIgL,MAAMrO,EAAK6L,gBAAgB,wBAAyB,CAAEyC,QAAStL,EAAMuL,QAAU,CAAExF,KAAMrJ,GAAGkC,OAAO4M,QAAQC,SAI1H3K,EAASL,iBAAmB,SAAUyE,GAClC,MAAMlI,EAAOC,KACPyO,EAAW,SAAU1L,GACvB,OAAOA,EAAMQ,eAAiBR,EAAMQ,cAAc0E,KAAOA,GAE7D,IAAIyG,EAAyB3O,EAAKqD,IAAI+J,WAAW5B,OAAOkD,GACpDpE,EAASqE,EAAuB3G,OAAS2G,EAAuB,GAAGnL,cAAgB,MAClF8G,GAAUtK,EAAK4O,kBAEhBtE,GADAqE,EAAyB3O,EAAK4O,gBAAgBpD,OAAOkD,IACrB1G,OAAS2G,EAAuB,GAAGnL,cAAgB,MAEvF,OAAO8G,GAGXxG,EAASzB,wBAA0B,WAC/B,MAAMrC,EAAOC,KACDD,EAAKgB,WACZ4B,cAAc,IAAM5C,EAAKK,YAAYG,YACrCqH,iBAAiB,MAAQ7H,EAAKK,YAAYI,SAAW,OACtDwK,QAAQ,SAAUC,GAClBA,EAAG/I,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQC,QAClCmI,EAAGtI,cAAc,UAAY5C,EAAKK,YAAYC,kBAC9C4K,EAAG/I,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQC,WAK/Ce,EAASgF,2BAA6B,SAAU3H,GAC5C,MAAMnB,EAAOC,KAEP+C,GADN7B,EAAUA,GAAW,IACC6B,MAChBL,EAAS3C,EAAKgB,WAAW4B,cAAc,IAAM5C,EAAKO,MAAQ,eAC1DsO,EAAYlM,EAAOC,cAAc,kBACvCiM,EAAU1M,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQgM,SAC1C,MAAMC,EAAY/L,EAAMgM,mBAExBrM,EAAOR,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQC,QAE1CJ,EAAOF,QAAQS,QAAUF,EAAMkF,GAC/B,MAAM+E,EAAKtK,EAAOC,cAAc,MAAQ5C,EAAKO,MAAQ,aACrD0M,EAAGvC,UAAY,GACf1K,EAAKqD,IAAI4L,gBAAgB,CACrBC,QAASlP,EAAKqD,IAAI2L,iBAAiB,CAC/BG,OAAQnP,EAAKqD,IAAI+L,WAAWC,OAAOrM,GACnCsM,kBAAkB,IAEtBC,QAAS,SACV7G,KAAK,SAAU8G,GACd,IAAIC,GAAiB,EACrB,MAAMC,EAAWlO,SAASmO,yBAC1BH,EACKvE,QAAQ,SAAU2E,GACf,MAAM1E,EAAK1J,SAASqO,cAAc,MAC5BC,EAAStO,SAASqO,cAAc,UAEtC,GAEc,IAFVd,EAAUvD,OAAO,SAAUhJ,GAC3B,OAAO9C,GAAGuB,KAAK8O,cAAcvN,EAAKoN,EAAQI,QAC3ChI,OAAc,CAEbyH,GAAiB,EAEjBK,EAAOpF,UAAYkF,EAAQ3K,KAAO,KAAO2K,EAAQI,KAAO,IACpD7O,EAAQ6B,MAAMQ,gBACdsM,EAAOrN,QAAQiB,gBAAkBvC,EAAQ6B,MAAMQ,cAAc0E,IAEjE4H,EAAOrN,QAAQC,QAAUkN,EAAQI,KACjCF,EAAO3N,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQmN,SACvC/E,EAAG/I,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQC,YAChC,CACH+M,EAAOpF,UAAY1K,EAAK6L,gBAAgB,iBAAkB,CAAErJ,IAAKoN,EAAQ3K,KAAO,KAAO2K,EAAQI,KAAO,MACtGF,EAAOrN,QAAQC,QAAUkN,EAAQI,KAGrC9E,EAAGxJ,YAAYoO,GACfJ,EAAShO,YAAYwJ,KAG7B,GAAI/J,EAAQqC,cAAe,CACvB,MAAM0H,EAAK1J,SAASqO,cAAc,MAC5BC,EAAStO,SAASqO,cAAc,UACtCC,EAAOpF,UAAY1K,EAAK6L,gBAAgB,qBACxCiE,EAAOrN,QAAQiB,gBAAkBvC,EAAQqC,cAAc0E,GACvDgD,EAAGxJ,YAAYoO,GACfJ,EAAShO,YAAYwJ,GAGzB,GAAIuE,EAAgB,CAChB,MAAMvE,EAAK1J,SAASqO,cAAc,MAC5BC,EAAStO,SAASqO,cAAc,UACtCC,EAAO3N,UAAUU,IAAI7C,EAAKK,YAAYC,iBACtCwP,EAAOpF,UAAY1K,EAAK6L,gBAAgB,2BACxCX,EAAGxJ,YAAYoO,GACfJ,EAAShO,YAAYwJ,GAEzB+B,EAAGvL,YAAYgO,GAEfb,EAAU1M,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQgM,WAEjDnM,EAAOC,cAAc,IAAM5C,EAAKO,MAAQ,SAASmK,UAAY1H,EAAMuL,OAASvL,EAAMiC,KAClFvF,GAAGuB,KAAKiP,UAAUvN,IAGtBmB,EAASsG,qBAAuB,WAC5B,MAAMpK,EAAOC,KAEP0C,EAAS3C,EAAKgB,WAAW4B,cAAc,IAAM5C,EAAKO,MAAQ,gBAEhEoC,EAAOR,UAAUgO,OAAOzQ,GAAGkC,OAAOkB,QAAQsN,SAAUpQ,EAAKqD,IAAIgF,UAE7D,MAAMwG,EAAYlM,EAAOC,cAAc,kBACvCiM,EAAUnE,UAAY,GACtBmE,EAAU1M,UAAUU,IAAInD,GAAGkC,OAAOkB,QAAQgM,SAC1CnM,EAAOR,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQC,QAE1CrD,GAAGuB,KAAKiP,UAAUvN,EAAQ,CACtB0N,cAAe,WAEXpQ,KAAKqI,kBAAkBC,SAAU,EACjCtI,KAAKiK,UACPoG,KAAKtQ,KAGX,MACMuQ,EADavQ,EAAK4H,IAAIhF,kBAAkB5C,EAAKK,YAAYQ,QACrCsB,UAAUC,SAASpC,EAAKK,YAAYU,MACxD+O,EAASnN,EAAOC,kBAAkB5C,EAAKK,YAAYK,YACzDoP,EAAO3N,UAAUgO,OAAOnQ,EAAKK,YAAYS,QAASyP,GAClDT,EAAO3N,UAAUgO,OAAOnQ,EAAKK,YAAYU,MAAOwP,GAChDT,EAAOlE,aAAa,QAAS5L,EAAK6L,gBAAgB0E,EAAS,kBAAoB,iBAE/E,MAAMC,EAAeC,IACjB,GAAIA,EAAI,CACJ,MAAMhE,EAAOgE,EAAGlE,QAAUkE,EAAGlE,QAAQkE,EAAGjE,MAAM,IAAM,KACpD,MAAO,CAAExJ,MAAOyN,EAAIhE,KAAMA,EAAMtH,UAAWnF,EAAKkI,IAEpD,MAAO,IAELwI,EAAa,WACf,MAAMH,EAAS5N,EAAOC,kBAAkB5C,EAAKK,YAAYK,YAAYyB,UAAUC,SAASpC,EAAKK,YAAYS,SACnG6P,EAAiB3Q,EAAK4O,gBAAgBgC,QAC5C,IAAK,IAAI9I,EAAI,EAAG2F,EAAKkD,EAAe3I,OAAQF,EAAI2F,EAAI3F,IAC3C6I,EAAe7I,KAChB6I,EAAe7I,IAAK,GAG5B9H,EAAKwK,gBAAgBxK,EAAKO,MAAO,CAC7B6M,WAAYuD,EAAetN,IAAImN,GAC/BrL,UAAWnF,EAAKkI,IACjB,SAAUuC,GACToE,EAAUnE,UAAYD,EACtB,MAAMoG,EAAOhC,EAAUjM,kBAAkB5C,EAAKK,YAAYQ,QAC1DgQ,EAAK1O,UAAUgO,OAAOnQ,EAAKK,YAAYS,SAAUyP,GACjDM,EAAK1O,UAAUgO,OAAOnQ,EAAKK,YAAYU,KAAMwP,GAC7C1B,EAAU1M,UAAUwH,OAAOjK,GAAGkC,OAAOkB,QAAQgM,SAE7C9O,EAAKkK,OAAO2E,MAGpB7O,EAAK+J,mBAAmB,SAAU+G,GAC9B,GAAIjC,EAAU1M,UAAUC,SAAS1C,GAAGkC,OAAOkB,QAAQgM,SAC/C4B,QAEC,CACD,MAAMxF,EAAK2D,EAAUjM,oBAAoB5C,EAAKO,wBAAwBuQ,EAAW,MAC3EL,EAAKzQ,EAAK4O,gBAAgBkC,GAC5BL,GACAzQ,EAAKwK,gBAAgBxK,EAAKO,MAAQ,QAASiQ,EAAaC,GAAK,SAAUhG,GACnES,EAAG6F,mBAAmB,cAAetG,GACrCS,EAAGvB,SACH3J,EAAKkK,OAAO2E,QAIzBnG,KAAK,WACJgI,OAIR,MAAMM,EAAW,SAAUxH,EAAKtF,GAC5B,MAAM2M,EAAO3M,EAAUtB,kBAAkB4G,EAAInJ,YAAYQ,QACzD,GAAIgQ,EAAM,CACN,MAAMtO,EAAM2B,EAAUtB,kBAAkB4G,EAAInJ,YAAYK,YAClD6P,EAAShO,EAAIJ,UAAUgO,OAAO3G,EAAInJ,YAAYS,SACpDyB,EAAIqJ,aAAa,QAASpC,EAAIqC,gBAAgBtJ,EAAIJ,UAAUgO,OAAO3G,EAAInJ,YAAYU,MAAQ,eAAiB,oBAC5G8P,EAAK1O,UAAUwH,OAAOH,EAAInJ,YAAYS,QAAS0I,EAAInJ,YAAYU,MAC/DkQ,WAAW,IAAMJ,EAAK1O,UAAUU,IAAI0N,EAAS/G,EAAInJ,YAAYU,KAAOyI,EAAInJ,YAAYS,SAAU,MAItGgD,EAAS2F,WAAa,WAElBuH,EADa/Q,KAAAA,KACO2H,MAGxB9D,EAAS6G,2BAA6B,WAClC,MAAM3K,EAAOC,KACTD,EAAKgB,YACLgQ,EAAShR,EAAMA,EAAKgB,aAI5B8C,EAASb,SAAW,SAAUiF,GAE1B,OADajI,KACDoD,MADCpD,KACYoD,IAAIJ,SAASiF,IADzBjI,KACsC2O,iBADtC3O,KAC8D2O,gBAAgBpD,OAAO,SAAUxI,GACxG,OAAOA,EAAMkF,KAAOA,IACrB,KAGP,MAAMgJ,EAAc,SAAU3N,GAC1B,OAAO,IAAI8F,QAAQ,SAAUC,EAASC,GAClCF,QAAQ8H,IAAI,CACR5N,EAAUmI,yBACVnI,EAAUE,mBAAqBF,EAAUE,mBAAmBiI,yBAA2BrC,QAAQC,YAChGZ,KAAK,WACJY,SAKZxF,EAASiG,mBAAqB,SAAUqH,GACpC,MAAMpR,EAAOC,KAEb,GAAKD,EAAK4O,iBAAoB5O,EAAK8K,wBA2E5B,GAAI9K,EAAK4O,gBAEZ,OAAO,IAAIvF,QAAQ,SAAUC,EAASC,GAClCF,QAAQ8H,IAAInR,EAAK4O,gBAAgBpD,OAAO,SAAUjI,GAC9C,OAAOA,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUC,KAAO1F,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUE,OAC7F7F,IAAI,SAAUE,GACb,OAAOvD,EAAKqD,IAAIgF,SAAW6I,EAAY3N,GAAaA,EAAUmI,4BAC9DhD,KAAK,WAEL1I,EAAK4O,gBAAkB5O,EAAK4O,gBAAgBvL,IAAI,SAAUE,GAEtD,GAAIA,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUE,KAAM,CAC7C,IAAImI,EAAY9N,EAAU+N,KAAKC,wBAAwBvR,EAAKqD,IAAIuF,UAAU,GAC1ErF,EAAU6E,eAAiBiJ,OACpB9N,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUC,MAC9C1F,EAAU6E,eAAiB7E,EAAUoF,aAAa3I,EAAKqD,IAAIuF,WAE/D,GAAI5I,EAAKqD,IAAIgF,UAAY9E,EAAU6E,eAAiB7E,EAAUE,kBAAoBF,EAAUE,mBAAoB,CAC5GF,EAAU6E,eAAiB7E,EAAUE,mBAAmBkF,aAAa3I,EAAKqD,IAAIuF,UAE9E,OAAOrF,EAGX,OAAOA,IAGX+F,EAAQtJ,EAAK4O,0BAnGrB5O,EAAK8K,uBAAyB,IAAIzB,QAAQ,SAAUC,EAASC,GAGzD,IAAIiI,EAAQ9R,GAAG+R,IAAIC,oBAAoBlG,OAAO,SAAUmG,GACpD,OAIqB,GAJdjS,GAAG+R,IAAIC,oBAAoBlG,OAAO,SAAUmG,GAC/C,OAAOA,EAAEnO,gBACVH,IAAI,SAAUsO,GACb,OAAOA,EAAEnO,gBACV6J,QAAQsE,EAAEzJ,MACd7E,IAAI,SAAUE,GACb,OAAIA,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUC,KAAO1F,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUE,KAC9E,IAAIxJ,GAAGsD,MAAM4O,OAAOrO,GACpBA,EAAUwF,MAAQrJ,GAAGkC,OAAOoH,UAAU6I,OACtC,IAAInS,GAAGsD,MAAM8O,OAAOvO,QADxB,IAKXvD,EAAK4O,gBAAkB,IAAI7D,MAAMyG,EAAMxJ,QAEvC,MAOM+J,EAAW,SAAUjK,GACvB,MAAMvE,EAAYtD,KAElBsD,EAAUF,IAAMrD,EAAKqD,IACrBE,EAAU0I,OAAS1I,EAAUpC,QAAQ8K,QAAS,EAE9C,GAAI1I,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUE,KAAM,CAC7C,IAAImI,EAAY9N,EAAU+N,KAAKC,wBAAwBvR,EAAKqD,IAAIuF,UAAU,GAC1ErF,EAAU6E,eAAiBiJ,OACpB9N,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUC,MAC9C1F,EAAU6E,eAAiB7E,EAAUoF,aAAa3I,EAAKqD,IAAIuF,WAG3D5I,EAAKqD,IAAIgF,UAAY9E,EAAU6E,eAAiB7E,EAAUE,kBAAoBF,EAAUE,qBACxFF,EAAU6E,eAAiB7E,EAAUE,mBAAmBkF,aAAa3I,EAAKqD,IAAIuF,WAGlF5I,EAAK4O,gBAAgBoD,OAAOlK,EAAG,EAAGvE,GAC9B7D,GAAGuB,KAAKgR,WAAWb,IACnBA,EAAgBtJ,IAIxBuB,QAAQ8H,IAAIK,EAAMnO,IAAI,SAAUE,EAAWuE,GACvC,OAAO,IAAIuB,QAAQ,SAAU6I,EAAKC,GAC9B,GAAI5O,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUC,KAAO1F,EAAUwF,OAASrJ,GAAGkC,OAAOoH,UAAUE,KAAM,EAC7ElJ,EAAKqD,IAAIgF,SAAW6I,EAAY3N,GAAaA,EAAUmI,0BAC7DhD,KACJ,WACIqJ,EAAShN,KAAKxB,EAAWuE,GACzBoK,KAEJ,SAAUE,GACNpS,EAAK4O,gBAAgBoD,OAAOlK,EAAG,EAAG,MAC9BpI,GAAGuB,KAAKgR,WAAWb,IACnBA,EAAgBtJ,GAEpBoK,UAEL,CACHH,EAAShN,KAAKxB,EAAWuE,GACzBoK,UAGRG,QAnDmB,WACnBrS,EAAK4O,gBAAkB5O,EAAK4O,gBAAgBpD,OAAO,SAAUjI,GACzD,OAAqB,OAAdA,IAGX+F,EAAQtJ,EAAK4O,qBAgFzB,OAAO5O,EAAK8K,wBAntBpB","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\n(function () {\r\n\r\n    TC.control.BasemapSelector = function () {\r\n        var self = this;\r\n        //options = options || {};\r\n\r\n        TC.control.MapContents.apply(self, arguments);\r\n\r\n        self.layerInfos = {};\r\n\r\n        self._cssClasses = {\r\n            LOAD_CRS_BUTTON: self.CLASS + '-crs-btn-load',\r\n            CRS_DIALOG: self.CLASS + '-crs-dialog',\r\n            CRS_LIST: self.CLASS + '-crs-list',\r\n            VIEW_BTN: self.CLASS + '-btn-view',\r\n            CURRENT_CRS_NAME: self.CLASS + '-cur-crs-name',\r\n            CURRENT_CRS_CODE: self.CLASS + '-cur-crs-code',\r\n            TREE: self.CLASS + '-tree',\r\n            DETAILS: 'tc-details',\r\n            GRID: 'tc-grid'\r\n        };\r\n\r\n        self._dialogDiv = TC.Util.getDiv(self.options.dialogDiv);\r\n        if (window.$) {\r\n            self._$dialogDiv = $(self._dialogDiv);\r\n        }\r\n        if (!self.options.dialogDiv) {\r\n            document.body.appendChild(self._dialogDiv);\r\n        }\r\n\r\n        self._dialogDiv.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('button:not(.tc-modal-close)', function (e) {\r\n\r\n            if (e.target.classList.contains(self._cssClasses.LOAD_CRS_BUTTON)) {\r\n                self.loadFallbackProjections();\r\n                return;\r\n            }\r\n\r\n            TC.Util.closeModal();\r\n            const btn = e.target;\r\n            const crs = btn.dataset.crsCode;\r\n\r\n            // dependerá del que esté activo\r\n            const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-crs-dialog');\r\n            dialog.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n            const layer = self.getLayer(dialog.dataset.layerId);\r\n            if (layer) {\r\n                if (crs) {\r\n                    TC.loadProjDef({\r\n                        crs: crs,\r\n                        callback: function () {\r\n                            self.map.setProjection({\r\n                                crs: crs,\r\n                                baseLayer: layer\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n                else {\r\n                    const fallbackLayer = self.getFallbackLayer(btn.dataset.fallbackLayerId);\r\n                    if (fallbackLayer) {\r\n                        self.map.setBaseLayer(fallbackLayer);\r\n                    }\r\n                }\r\n            }\r\n        }), { passive: true });\r\n    };\r\n\r\n    TC.inherit(TC.control.BasemapSelector, TC.control.MapContents);\r\n\r\n    var ctlProto = TC.control.BasemapSelector.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-bms';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-bms.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/tc-ctl-bms-node.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/tc-ctl-bms-dialog.hbs\";\r\n\r\n    const getClosestParent = function (elm, selector) {\r\n        while (elm && !elm.matches(selector)) {\r\n            elm = elm.parentElement;\r\n        }\r\n        return elm;\r\n    };\r\n\r\n    const changeInputRadioBaseMap = function (e, callback) {\r\n        const self = this;\r\n        var flagToCallback = true;\r\n\r\n        var radio = e.target;\r\n\r\n        var layer = self.getLayer(getClosestParent(radio, 'li').dataset.layerId);\r\n\r\n        if (self.options.dialogMore && getClosestParent(radio, '.' + self.CLASS + '-more-dialog')) {\r\n            const radios = self.div.querySelectorAll('input[type=radio]');\r\n            for (var i = 0, len = radios.length; i < len; i++) {\r\n                const bmsLayer = self.getLayer(getClosestParent(radios[i], 'li').dataset.layerId);\r\n                if (bmsLayer) {\r\n                    switch (true) {\r\n                        case bmsLayer.id === layer.id:\r\n                            layer = bmsLayer;\r\n                            break;\r\n                    }\r\n                }\r\n            };\r\n        }\r\n\r\n        if (layer != self.map.getBaseLayer()) {\r\n            if (layer.mustReproject) {\r\n\r\n                if (self.map.on3DView) {\r\n                    if (!layer.getFallbackLayer()) {\r\n                        self._currentSelection.checked = true;\r\n                        e.stopPropagation();\r\n                        return;\r\n                    } else if (layer.getFallbackLayer()) {\r\n                        const fallbackLayer = layer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            fallbackLayer._capabilitiesPromise.then(function () {\r\n                                if (fallbackLayer.isCompatible(self.map.getCRS())) {\r\n                                    self.map.setBaseLayer(layer);\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        flagToCallback = true;\r\n                    }\r\n                } else {\r\n                    // provisonal\r\n                    if (self._currentSelection) {\r\n                        self._currentSelection.checked = true;\r\n                    }\r\n\r\n                    // Buscamos alternativa\r\n                    const dialogOptions = {\r\n                        layer: layer\r\n                    };\r\n                    const fallbackLayer = layer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (fallbackLayer.isCompatible(self.map.getCRS())) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n                            self.showProjectionChangeDialog(dialogOptions);\r\n                        });\r\n                    }\r\n                    else {\r\n                        self.showProjectionChangeDialog(dialogOptions);\r\n                    }\r\n                    //layer.getCompatibleCRS({ normalized: true });\r\n                    flagToCallback = false;\r\n                }\r\n\r\n            }\r\n            else {\r\n\r\n                if (layer.type === TC.Consts.layerType.WMS || layer.type === TC.Consts.layerType.WMTS && layer.getProjection() !== self.map.crs) {\r\n                    layer.setProjection({ crs: self.map.crs });\r\n                }\r\n\r\n                self.map.setBaseLayer(layer);\r\n            }\r\n        }\r\n\r\n        if (this._currentSelection) {\r\n            this._currentSelection.checked = true;\r\n        }\r\n\r\n\r\n        if (callback) {\r\n            callback(flagToCallback);\r\n        }\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.MapContents.prototype.register.call(self, map).then(function (ctl) {\r\n                self.div.querySelector(`.${self._cssClasses.VIEW_BTN}`).addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    self.toggleView();\r\n                    e.target.blur();\r\n                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                    e.stopPropagation();\r\n                }, { passive: true });\r\n\r\n                if (self.options.dialogMore) {\r\n                    map.on(TC.Consts.event.VIEWCHANGE, function () {\r\n                        self._getMoreBaseLayers();\r\n                    });\r\n                }\r\n\r\n                map.on(TC.Consts.event.BASELAYERCHANGE + ' ' + TC.Consts.event.PROJECTIONCHANGE + ' ' + TC.Consts.event.VIEWCHANGE, function (e) {\r\n                    self.update(self.div, e.layer);\r\n                });\r\n\r\n\r\n                self.div.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=radio]', function (e) {\r\n\r\n                    if (e.target.value === \"moreLayers\") {\r\n                        self.showMoreLayersDialog();\r\n                    } else {\r\n                        changeInputRadioBaseMap.call(self, e);\r\n                    }\r\n\r\n                    e.stopPropagation();\r\n                }));\r\n\r\n                resolve(ctl);\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        const result = TC.control.MapContents.prototype.render.call(self, callback, TC.Util.extend({}, self.options, { controlId: self.id }));\r\n\r\n        self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n\r\n            if (self.options.dialogMore) {\r\n                const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-more-dialog');\r\n\r\n                dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`).addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    self.toggleMoreLayersDialogView();\r\n                    e.target.blur();\r\n                    e.stopPropagation();\r\n                }, { passive: true });\r\n\r\n                dialog.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=radio]', function (e) {\r\n                    changeInputRadioBaseMap.call(self, e, function (close) {\r\n                        if (close) {\r\n                            TC.Util.closeModal();\r\n                        }\r\n                    });\r\n\r\n                    e.stopPropagation();\r\n                }));\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.update = async function (div, baseLayer) {\r\n        const self = this;\r\n\r\n        div = div || self.div;\r\n\r\n        await (self._moreBaseLayersPromise || self._getMoreBaseLayers());\r\n        Array.from(div.querySelectorAll(`ul.${self.CLASS}-branch li`)).forEach(function (li, idx, arr) {\r\n            const layer = self.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                const curBaseLayer = baseLayer || self.map.baseLayer;\r\n                const radio = li.querySelector('input[type=radio]');\r\n                const fbLayer = layer.getFallbackLayer && layer.getFallbackLayer();\r\n                let checked = curBaseLayer && (curBaseLayer === layer || curBaseLayer.id === layer.id);\r\n                if (!checked) {\r\n                    const otherLayerIsFallback = fbLayer && arr\r\n                        .filter(elm => elm !== li)\r\n                        .some(elm => elm.dataset.layerId === fbLayer.id);\r\n                    checked = !otherLayerIsFallback && curBaseLayer && (curBaseLayer === fbLayer || (fbLayer && curBaseLayer.id === fbLayer.id));\r\n                }\r\n\r\n                if (self.map.on3DView && layer.mustReproject && fbLayer) {\r\n                    fbLayer.getCapabilitiesPromise().then(function () {\r\n                        var mustReproject = !layer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n\r\n                        radio.checked = checked;\r\n                        if (mustReproject) {\r\n                            radio.classList.add(TC.Consts.classes.DISABLED);\r\n                            li.setAttribute('title', self.map.on3DView ? self.getLocaleString('notAvailableTo3D') : self.getLocaleString('reprojectionNeeded'));\r\n                        }\r\n                        else {\r\n                            radio.classList.remove(TC.Consts.classes.DISABLED);\r\n                            li.removeAttribute('title');\r\n                        }\r\n                    });\r\n                } else {\r\n                    radio.checked = checked;\r\n                    if (layer.mustReproject) {\r\n                        radio.classList.add(TC.Consts.classes.DISABLED);\r\n                        li.setAttribute('title', self.map.on3DView ? self.getLocaleString('notAvailableTo3D') : self.getLocaleString('reprojectionNeeded'));\r\n                    }\r\n                    else {\r\n                        radio.classList.remove(TC.Consts.classes.DISABLED);\r\n                        li.removeAttribute('title');\r\n                    }\r\n                }\r\n\r\n                if (checked) {\r\n                    self._currentSelection = radio;\r\n                }\r\n            }\r\n        });\r\n\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        const self = this;        \r\n        // Actuamos cuando la capa es base y es visible en tablas de contenidos o es hija de una visible\r\n        if (layer.isBase && (!layer.options.stealth || (layer.firstOption && !layer.firstOption.options.stealth))) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            const displayLayer = layer.firstOption || layer;\r\n\r\n            if (displayLayer !== layer) {\r\n                self.layerTrees[displayLayer.id] = displayLayer.getTree();\r\n            }\r\n\r\n            if (displayLayer.getInfo) {\r\n                self.layerInfos[displayLayer.id] = displayLayer.getInfo(displayLayer.names[0]);\r\n            }\r\n\r\n            self.getRenderedHtml(self.CLASS + '-node', { layer: self.layerTrees[displayLayer.id], info: self.layerInfos[displayLayer.id], controlId: self.id }).then(function (out) {\r\n                const parser = new DOMParser();\r\n                const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                var uid = newLi.dataset.layerUid;\r\n                const ul = self.div.querySelector('.' + self.CLASS + '-branch');\r\n                const currentLi = ul.querySelector('li[data-layer-uid=\"' + uid + '\"]');\r\n                if (currentLi) {\r\n                    currentLi.innerHTML = newLi.innerHTML;\r\n                }\r\n                else {\r\n                    newLi.dataset.layerId = displayLayer.id;\r\n\r\n                    // Insertamos elemento en el lugar correcto, según indica la colección baseLayers\r\n                    const setLayerIds = self.map.baseLayers\r\n                        .map(baseLayer => baseLayer.firstOption || baseLayer)\r\n                        .filter(baseLayer => baseLayer && !baseLayer.stealth) // Buscamos capas que deban mostrarse\r\n                        .map(baseLayer => baseLayer.id);\r\n                    const idx = setLayerIds.indexOf(displayLayer.id);\r\n                    let inserted = false;\r\n                    for (let i = idx - 1; i >= 0; i--) {\r\n                        const curLi = ul.querySelector(`li[data-layer-id=\"${setLayerIds[i]}\"]`);\r\n                        if (curLi) {\r\n                            curLi.insertAdjacentElement('afterend', newLi);\r\n                            inserted = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (!inserted) {\r\n                        for (let i = idx + 1, ii = setLayerIds.length; i < ii; i++) {\r\n                            const curLi = ul.querySelector(`li[data-layer-id=\"${setLayerIds[i]}\"]`);\r\n                            if (curLi) {\r\n                                curLi.insertAdjacentElement('beforebegin', newLi);\r\n                                inserted = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (!inserted) {\r\n                            const moreLabel = ul.querySelector(`.${self.CLASS}-more-node`);\r\n                            if (moreLabel) {\r\n                                moreLabel.parentElement.insertAdjacentElement('beforebegin', newLi);\r\n                            }\r\n                            else {\r\n                                ul.appendChild(newLi);\r\n                            }\r\n                        }\r\n                    }\r\n                    self.update();\r\n                }\r\n            }).catch(function (err) {\r\n                TC.error(err);\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        // no hace nada\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        const self = this;\r\n        if (layer.isBase) {\r\n            const lis = self.div.querySelector('.' + self.CLASS + '-branch').querySelectorAll('li');\r\n            for (var i = 0, len = lis.length; i < len; i++) {\r\n                const li = lis[i];\r\n                if (li.dataset.layerId === layer.id) {\r\n                    li.parentElement.removeChild(li);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.onErrorLayer = function (layer) {\r\n        const self = this;\r\n\r\n        if (layer.isBase && !layer.options.stealth) {\r\n            self.map.toast(self.getLocaleString('baseLayerNotAvailable', { mapName: layer.title }), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n    };\r\n\r\n    ctlProto.getFallbackLayer = function (id) {\r\n        const self = this;\r\n        const filterFn = function (layer) {\r\n            return layer.fallbackLayer && layer.fallbackLayer.id === id;\r\n        };\r\n        let baseLayersWithFallback = self.map.baseLayers.filter(filterFn);\r\n        let result = baseLayersWithFallback.length ? baseLayersWithFallback[0].fallbackLayer : null;\r\n        if (!result && self._moreBaseLayers) {\r\n            baseLayersWithFallback = self._moreBaseLayers.filter(filterFn);\r\n            result = baseLayersWithFallback.length ? baseLayersWithFallback[0].fallbackLayer : null;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.loadFallbackProjections = function () {\r\n        const self = this;\r\n        const lis = self._dialogDiv\r\n            .querySelector('.' + self._cssClasses.CRS_DIALOG)\r\n            .querySelectorAll('ul.' + self._cssClasses.CRS_LIST + ' li');\r\n        lis.forEach(function (li) {\r\n            li.classList.remove(TC.Consts.classes.HIDDEN);\r\n            if (li.querySelector('button.' + self._cssClasses.LOAD_CRS_BUTTON)) {\r\n                li.classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.showProjectionChangeDialog = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const layer = options.layer;\r\n        const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-crs-dialog');\r\n        const modalBody = dialog.querySelector('.tc-modal-body');\r\n        modalBody.classList.add(TC.Consts.classes.LOADING);\r\n        const blCRSList = layer.getCompatibleCRS();\r\n\r\n        dialog.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        dialog.dataset.layerId = layer.id;\r\n        const ul = dialog.querySelector('ul.' + self.CLASS + '-crs-list');\r\n        ul.innerHTML = '';\r\n        self.map.loadProjections({\r\n            crsList: self.map.getCompatibleCRS({\r\n                layers: self.map.workLayers.concat(layer),\r\n                includeFallbacks: true\r\n            }),\r\n            orderBy: 'name'\r\n        }).then(function (projList) {\r\n            var hasFallbackCRS = false;\r\n            const fragment = document.createDocumentFragment();\r\n            projList\r\n                .forEach(function (projObj) {\r\n                    const li = document.createElement('li');\r\n                    const button = document.createElement('button');\r\n\r\n                    if (blCRSList.filter(function (crs) {\r\n                        return TC.Util.CRSCodesEqual(crs, projObj.code)\r\n                    }).length === 0) {\r\n                        // Es un CRS del fallback\r\n                        hasFallbackCRS = true;\r\n\r\n                        button.innerHTML = projObj.name + ' (' + projObj.code + ')';\r\n                        if (options.layer.fallbackLayer) {\r\n                            button.dataset.fallbackLayerId = options.layer.fallbackLayer.id;\r\n                        }\r\n                        button.dataset.crsCode = projObj.code;\r\n                        button.classList.add(TC.Consts.classes.WARNING);\r\n                        li.classList.add(TC.Consts.classes.HIDDEN);\r\n                    } else {\r\n                        button.innerHTML = self.getLocaleString('changeMapToCrs', { crs: projObj.name + ' (' + projObj.code + ')' });\r\n                        button.dataset.crsCode = projObj.code;\r\n                    }\r\n\r\n                    li.appendChild(button);\r\n                    fragment.appendChild(li);\r\n                });\r\n\r\n            if (options.fallbackLayer) {\r\n                const li = document.createElement('li');\r\n                const button = document.createElement('button');\r\n                button.innerHTML = self.getLocaleString('reprojectOnTheFly');\r\n                button.dataset.fallbackLayerId = options.fallbackLayer.id;\r\n                li.appendChild(button);\r\n                fragment.appendChild(li);\r\n            }\r\n\r\n            if (hasFallbackCRS) {\r\n                const li = document.createElement('li');\r\n                const button = document.createElement('button');\r\n                button.classList.add(self._cssClasses.LOAD_CRS_BUTTON);\r\n                button.innerHTML = self.getLocaleString('showOnTheFlyProjections');\r\n                li.appendChild(button);\r\n                fragment.appendChild(li);\r\n            }\r\n            ul.appendChild(fragment);\r\n\r\n            modalBody.classList.remove(TC.Consts.classes.LOADING);\r\n        });\r\n        dialog.querySelector('.' + self.CLASS + '-name').innerHTML = layer.title || layer.name;\r\n        TC.Util.showModal(dialog);\r\n    };\r\n\r\n    ctlProto.showMoreLayersDialog = function () {\r\n        const self = this;\r\n\r\n        const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-more-dialog');\r\n\r\n        dialog.classList.toggle(TC.Consts.classes.THREED, !!self.map.on3DView);\r\n\r\n        const modalBody = dialog.querySelector('.tc-modal-body');\r\n        modalBody.innerHTML = '';\r\n        modalBody.classList.add(TC.Consts.classes.LOADING);\r\n        dialog.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        TC.Util.showModal(dialog, {\r\n            closeCallback: function () {\r\n                // no hay selección, vuelvo a seleccionar el mapa de fondo actual del mapa.\r\n                this._currentSelection.checked = true;\r\n                this.update();\r\n            }.bind(self)\r\n        });\r\n\r\n        const parentTree = self.div.querySelector(`.${self._cssClasses.TREE}`);\r\n        const isGrid = parentTree.classList.contains(self._cssClasses.GRID);\r\n        const button = dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`);\r\n        button.classList.toggle(self._cssClasses.DETAILS, isGrid);\r\n        button.classList.toggle(self._cssClasses.GRID, !isGrid);\r\n        button.setAttribute('title', self.getLocaleString(isGrid ? 'showDetailsView' : 'showGridView'));\r\n\r\n        const processLayer = bl => {\r\n            if (bl) {\r\n                const info = bl.getInfo ? bl.getInfo(bl.names[0]) : null;\r\n                return { layer: bl, info: info, controlId: self.id };\r\n            }\r\n            return {};\r\n        };\r\n        const renderBody = function () {\r\n            const isGrid = dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`).classList.contains(self._cssClasses.DETAILS);\r\n            const moreBaseLayers = self._moreBaseLayers.slice();\r\n            for (var i = 0, ii = moreBaseLayers.length; i < ii; i++) {\r\n                if (!moreBaseLayers[i]) {\r\n                    moreBaseLayers[i] = false;\r\n                }\r\n            }\r\n            self.getRenderedHtml(self.CLASS, {\r\n                baseLayers: moreBaseLayers.map(processLayer),\r\n                controlId: self.id\r\n            }, function (html) {\r\n                modalBody.innerHTML = html;\r\n                const tree = modalBody.querySelector(`.${self._cssClasses.TREE}`);\r\n                tree.classList.toggle(self._cssClasses.DETAILS, !isGrid);\r\n                tree.classList.toggle(self._cssClasses.GRID, isGrid);\r\n                modalBody.classList.remove(TC.Consts.classes.LOADING);\r\n\r\n                self.update(modalBody);\r\n            });\r\n        };\r\n        self._getMoreBaseLayers(function (layerIdx) {\r\n            if (modalBody.classList.contains(TC.Consts.classes.LOADING)) {\r\n                renderBody();\r\n            }\r\n            else {\r\n                const li = modalBody.querySelector(`li.${self.CLASS}-node:nth-child(${layerIdx + 1})`);\r\n                const bl = self._moreBaseLayers[layerIdx];\r\n                if (bl) {\r\n                    self.getRenderedHtml(self.CLASS + '-node', processLayer(bl), function (html) {\r\n                        li.insertAdjacentHTML('beforebegin', html);\r\n                        li.remove();\r\n                        self.update(modalBody);\r\n                    });\r\n                }\r\n            }\r\n        }).then(function () {\r\n            renderBody();\r\n        });\r\n    };\r\n\r\n    const toggleUI = function (ctl, container) {\r\n        const tree = container.querySelector(`.${ctl._cssClasses.TREE}`);\r\n        if (tree) {\r\n            const btn = container.querySelector(`.${ctl._cssClasses.VIEW_BTN}`);\r\n            const isGrid = btn.classList.toggle(ctl._cssClasses.DETAILS);\r\n            btn.setAttribute('title', ctl.getLocaleString(btn.classList.toggle(ctl._cssClasses.GRID) ? 'showGridView' : 'showDetailsView'));\r\n            tree.classList.remove(ctl._cssClasses.DETAILS, ctl._cssClasses.GRID);\r\n            setTimeout(() => tree.classList.add(isGrid ? ctl._cssClasses.GRID : ctl._cssClasses.DETAILS), 20);\r\n        }\r\n    };\r\n\r\n    ctlProto.toggleView = function () {\r\n        const self = this;\r\n        toggleUI(self, self.div);\r\n    };\r\n\r\n    ctlProto.toggleMoreLayersDialogView = function () {\r\n        const self = this;\r\n        if (self._dialogDiv) {\r\n            toggleUI(self, self._dialogDiv);\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayer = function (id) {\r\n        const self = this;\r\n        return self.map && (self.map.getLayer(id) || (self._moreBaseLayers && self._moreBaseLayers.filter(function (layer) {\r\n            return layer.id === id;\r\n        })[0]));\r\n    };\r\n\r\n    const getTo3DVIew = function (baseLayer) {\r\n        return new Promise(function (resolve, reject) {\r\n            Promise.all([\r\n                baseLayer.getCapabilitiesPromise(),\r\n                baseLayer.getFallbackLayer() ? baseLayer.getFallbackLayer().getCapabilitiesPromise() : Promise.resolve()\r\n            ]).then(function () {\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto._getMoreBaseLayers = function (partialCallback) {\r\n        const self = this;\r\n\r\n        if (!self._moreBaseLayers && !self._moreBaseLayersPromise) {\r\n\r\n            self._moreBaseLayersPromise = new Promise(function (resolve, reject) {\r\n\r\n                // GLS: Carlos no quiere que se muestren los respectivos dinámicos así que los filtro.\r\n                var noDyn = TC.Cfg.availableBaseLayers.filter(function (l) {\r\n                    return TC.Cfg.availableBaseLayers.filter(function (l) {\r\n                        return l.fallbackLayer\r\n                    }).map(function (l) {\r\n                        return l.fallbackLayer\r\n                    }).indexOf(l.id) == -1\r\n                }).map(function (baseLayer) {\r\n                    if (baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                        return new TC.layer.Raster(baseLayer);\r\n                    } else if (baseLayer.type == TC.Consts.layerType.VECTOR) {\r\n                        return new TC.layer.Vector(baseLayer);\r\n                    }\r\n                });\r\n\r\n                self._moreBaseLayers = new Array(noDyn.length);\r\n\r\n                const resolvePromise = function () {\r\n                    self._moreBaseLayers = self._moreBaseLayers.filter(function (baseLayer) {\r\n                        return baseLayer !== null;\r\n                    });\r\n\r\n                    resolve(self._moreBaseLayers);\r\n                };\r\n                const addLayer = function (i) {\r\n                    const baseLayer = this;\r\n\r\n                    baseLayer.map = self.map;\r\n                    baseLayer.isBase = baseLayer.options.isBase = true;\r\n\r\n                    if (baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                        var matrixSet = baseLayer.wrap.getCompatibleMatrixSets(self.map.getCRS())[0];\r\n                        baseLayer.mustReproject = !matrixSet;\r\n                    } else if (baseLayer.type === TC.Consts.layerType.WMS) {\r\n                        baseLayer.mustReproject = !baseLayer.isCompatible(self.map.getCRS());\r\n                    }\r\n\r\n                    if (self.map.on3DView && baseLayer.mustReproject && baseLayer.getFallbackLayer && baseLayer.getFallbackLayer()) {\r\n                        baseLayer.mustReproject = !baseLayer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n                    }\r\n\r\n                    self._moreBaseLayers.splice(i, 1, baseLayer);\r\n                    if (TC.Util.isFunction(partialCallback)) {\r\n                        partialCallback(i);\r\n                    }\r\n                };\r\n\r\n                Promise.all(noDyn.map(function (baseLayer, i) {\r\n                    return new Promise(function (res, rej) {\r\n                        if (baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                            var promise = self.map.on3DView ? getTo3DVIew(baseLayer) : baseLayer.getCapabilitiesPromise();\r\n                            promise.then(\r\n                                function () {\r\n                                    addLayer.call(baseLayer, i);\r\n                                    res();\r\n                                },\r\n                                function (fail) {\r\n                                    self._moreBaseLayers.splice(i, 1, null);\r\n                                    if (TC.Util.isFunction(partialCallback)) {\r\n                                        partialCallback(i);\r\n                                    }\r\n                                    res();\r\n                                });\r\n                        } else {\r\n                            addLayer.call(baseLayer, i);\r\n                            res();\r\n                        }\r\n                    });\r\n                })).finally(resolvePromise);\r\n            });\r\n\r\n        } else if (self._moreBaseLayers) {\r\n\r\n            return new Promise(function (resolve, reject) {\r\n                Promise.all(self._moreBaseLayers.filter(function (baseLayer) {\r\n                    return baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS;\r\n                }).map(function (baseLayer) {\r\n                    return self.map.on3DView ? getTo3DVIew(baseLayer) : baseLayer.getCapabilitiesPromise();\r\n                })).then(function () {\r\n\r\n                    self._moreBaseLayers = self._moreBaseLayers.map(function (baseLayer) {\r\n\r\n                        if (baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                            var matrixSet = baseLayer.wrap.getCompatibleMatrixSets(self.map.getCRS())[0];\r\n                            baseLayer.mustReproject = !matrixSet;\r\n                        } else if (baseLayer.type === TC.Consts.layerType.WMS) {\r\n                            baseLayer.mustReproject = !baseLayer.isCompatible(self.map.getCRS());\r\n                        }\r\n                        if (self.map.on3DView && baseLayer.mustReproject && baseLayer.getFallbackLayer && baseLayer.getFallbackLayer()) {\r\n                            baseLayer.mustReproject = !baseLayer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n\r\n                            return baseLayer;\r\n                        }\r\n\r\n                        return baseLayer;\r\n                    });\r\n\r\n                    resolve(self._moreBaseLayers);\r\n                });\r\n            });\r\n        }\r\n\r\n        return self._moreBaseLayersPromise;\r\n    };\r\n})();\r\n"]}