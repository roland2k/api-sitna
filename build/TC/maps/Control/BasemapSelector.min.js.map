{"version":3,"sources":["control/BasemapSelector.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","BasemapSelector","self","this","apply","arguments","layerInfos","_cssClasses","LOAD_CRS_BUTTON","CLASS","CRS_DIALOG","CRS_LIST","VIEW_BTN","CURRENT_CRS_NAME","CURRENT_CRS_CODE","TREE","DETAILS","GRID","_dialogDiv","Util","getDiv","options","dialogDiv","window","$","_$dialogDiv","document","body","appendChild","addEventListener","Consts","event","CLICK","EventTarget","listenerBySelector","e","target","classList","contains","loadFallbackProjections","closeModal","btn","crs","dataset","crsCode","dialog","querySelector","add","classes","HIDDEN","layer","getLayer","layerId","loadProjDef","callback","map","setProjection","baseLayer","fallbackLayer","getFallbackLayer","fallbackLayerId","setBaseLayer","passive","inherit","ctlProto","prototype","template","1","container","depth0","helpers","partials","data","blockParams","depths","stack1","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","invokePartial","name","hash","controlId","indent","decorators","3","alias1","nullContext","alias2","escapeExpression","loc","start","line","column","end","lambda","compiler","main","fn","program","inverse","noop","usePartial","useData","useDepths","alias3","2","4","6","8","9","10","12","getClosestParent","elm","selector","matches","parentElement","changeInputRadioBaseMap","flagToCallback","radio","dialogMore","radios","div","querySelectorAll","i","len","length","bmsLayer","id","getBaseLayer","mustReproject","on3DView","_currentSelection","checked","stopPropagation","_capabilitiesPromise","then","isCompatible","getCRS","dialogOptions","showProjectionChangeDialog","type","layerType","WMS","WMTS","getProjection","register","Promise","resolve","reject","ctl","toggleView","blur","remove","COLLAPSED","on","VIEWCHANGE","_getMoreBaseLayers","BASELAYERCHANGE","PROJECTIONCHANGE","update","value","showMoreLayersDialog","render","result","extend","getRenderedHtml","html","innerHTML","toggleMoreLayersDialogView","close","forEach","li","curBaseLayer","getCapabilitiesPromise","DISABLED","setAttribute","getLocaleString","removeAttribute","updateScale","updateLayerTree","isBase","stealth","getInfo","info","names","layerTrees","out","newLi","DOMParser","parseFromString","firstChild","uid","layerUid","ul","currentLi","setLayerIds","baseLayers","filter","idx","indexOf","inserted","curLi","insertAdjacentElement","ii","moreLabel","catch","err","error","updateLayerOrder","oldIdx","newIdx","removeLayer","lis","removeChild","onErrorLayer","toast","mapName","title","msgType","ERROR","filterFn","_moreBaseLayers","modalBody","LOADING","blCRSList","getCompatibleCRS","loadProjections","crsList","layers","workLayers","concat","includeFallbacks","orderBy","projList","hasFallbackCRS","fragment","createDocumentFragment","projObj","createElement","button","CRSCodesEqual","code","WARNING","showModal","toggle","THREED","closeCallback","bind","isGrid","processLayer","bl","renderBody","moreBaseLayers","slice","tree","layerIdx","insertAdjacentHTML","toggleUI","setTimeout","getTo3DVIew","all","partialCallback","_moreBaseLayersPromise","matrixSet","wrap","getCompatibleMatrixSets","noDyn","Cfg","availableBaseLayers","l","Raster","VECTOR","Vector","Array","addLayer","splice","isFunction","res","rej","fail","finally"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\n(function () {\r\n\r\n    TC.control.BasemapSelector = function () {\r\n        var self = this;\r\n        //options = options || {};\r\n\r\n        TC.control.MapContents.apply(self, arguments);\r\n\r\n        self.layerInfos = {};\r\n\r\n        self._cssClasses = {\r\n            LOAD_CRS_BUTTON: self.CLASS + '-crs-btn-load',\r\n            CRS_DIALOG: self.CLASS + '-crs-dialog',\r\n            CRS_LIST: self.CLASS + '-crs-list',\r\n            VIEW_BTN: self.CLASS + '-btn-view',\r\n            CURRENT_CRS_NAME: self.CLASS + '-cur-crs-name',\r\n            CURRENT_CRS_CODE: self.CLASS + '-cur-crs-code',\r\n            TREE: self.CLASS + '-tree',\r\n            DETAILS: 'tc-details',\r\n            GRID: 'tc-grid'\r\n        };\r\n\r\n        self._dialogDiv = TC.Util.getDiv(self.options.dialogDiv);\r\n        if (window.$) {\r\n            self._$dialogDiv = $(self._dialogDiv);\r\n        }\r\n        if (!self.options.dialogDiv) {\r\n            document.body.appendChild(self._dialogDiv);\r\n        }\r\n\r\n        self._dialogDiv.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('button:not(.tc-modal-close)', function (e) {\r\n\r\n            if (e.target.classList.contains(self._cssClasses.LOAD_CRS_BUTTON)) {\r\n                self.loadFallbackProjections();\r\n                return;\r\n            }\r\n\r\n            TC.Util.closeModal();\r\n            const btn = e.target;\r\n            const crs = btn.dataset.crsCode;\r\n\r\n            // dependerá del que esté activo\r\n            const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-crs-dialog');\r\n            dialog.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n            const layer = self.getLayer(dialog.dataset.layerId);\r\n            if (layer) {\r\n                if (crs) {\r\n                    TC.loadProjDef({\r\n                        crs: crs,\r\n                        callback: function () {\r\n                            self.map.setProjection({\r\n                                crs: crs,\r\n                                baseLayer: layer\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n                else {\r\n                    const fallbackLayer = self.getFallbackLayer(btn.dataset.fallbackLayerId);\r\n                    if (fallbackLayer) {\r\n                        self.map.setBaseLayer(fallbackLayer);\r\n                    }\r\n                }\r\n            }\r\n        }), { passive: true });\r\n    };\r\n\r\n    TC.inherit(TC.control.BasemapSelector, TC.control.MapContents);\r\n\r\n    var ctlProto = TC.control.BasemapSelector.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-bms';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-bms.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/tc-ctl-bms-node.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/tc-ctl-bms-dialog.hbs\";\r\n\r\n    const getClosestParent = function (elm, selector) {\r\n        while (elm && !elm.matches(selector)) {\r\n            elm = elm.parentElement;\r\n        }\r\n        return elm;\r\n    };\r\n\r\n    const changeInputRadioBaseMap = function (e, callback) {\r\n        const self = this;\r\n        var flagToCallback = true;\r\n\r\n        var radio = e.target;\r\n\r\n        var layer = self.getLayer(getClosestParent(radio, 'li').dataset.layerId);\r\n\r\n        if (self.options.dialogMore && getClosestParent(radio, '.' + self.CLASS + '-more-dialog')) {\r\n            const radios = self.div.querySelectorAll('input[type=radio]');\r\n            for (var i = 0, len = radios.length; i < len; i++) {\r\n                const bmsLayer = self.getLayer(getClosestParent(radios[i], 'li').dataset.layerId);\r\n                if (bmsLayer) {\r\n                    switch (true) {\r\n                        case bmsLayer.id === layer.id:\r\n                            layer = bmsLayer;\r\n                            break;\r\n                    }\r\n                }\r\n            };\r\n        }\r\n\r\n        if (layer != self.map.getBaseLayer()) {\r\n            if (layer.mustReproject) {\r\n\r\n                if (self.map.on3DView) {\r\n                    if (!layer.getFallbackLayer()) {\r\n                        self._currentSelection.checked = true;\r\n                        e.stopPropagation();\r\n                        return;\r\n                    } else if (layer.getFallbackLayer()) {\r\n                        const fallbackLayer = layer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            fallbackLayer._capabilitiesPromise.then(function () {\r\n                                if (fallbackLayer.isCompatible(self.map.getCRS())) {\r\n                                    self.map.setBaseLayer(layer);\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        flagToCallback = true;\r\n                    }\r\n                } else {\r\n                    // provisonal\r\n                    if (self._currentSelection) {\r\n                        self._currentSelection.checked = true;\r\n                    }\r\n\r\n                    // Buscamos alternativa\r\n                    const dialogOptions = {\r\n                        layer: layer\r\n                    };\r\n                    const fallbackLayer = layer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (fallbackLayer.isCompatible(self.map.getCRS())) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n                            self.showProjectionChangeDialog(dialogOptions);\r\n                        });\r\n                    }\r\n                    else {\r\n                        self.showProjectionChangeDialog(dialogOptions);\r\n                    }\r\n                    //layer.getCompatibleCRS({ normalized: true });\r\n                    flagToCallback = false;\r\n                }\r\n\r\n            }\r\n            else {\r\n\r\n                if (layer.type === TC.Consts.layerType.WMS || layer.type === TC.Consts.layerType.WMTS && layer.getProjection() !== self.map.crs) {\r\n                    layer.setProjection({ crs: self.map.crs });\r\n                }\r\n\r\n                self.map.setBaseLayer(layer);\r\n            }\r\n        }\r\n\r\n        if (this._currentSelection) {\r\n            this._currentSelection.checked = true;\r\n        }\r\n\r\n\r\n        if (callback) {\r\n            callback(flagToCallback);\r\n        }\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.MapContents.prototype.register.call(self, map).then(function (ctl) {\r\n                self.div.querySelector(`.${self._cssClasses.VIEW_BTN}`).addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    self.toggleView();\r\n                    e.target.blur();\r\n                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                    e.stopPropagation();\r\n                }, { passive: true });\r\n\r\n                if (self.options.dialogMore) {\r\n                    map.on(TC.Consts.event.VIEWCHANGE, function () {\r\n                        self._getMoreBaseLayers();\r\n                    });\r\n                }\r\n\r\n                map.on(TC.Consts.event.BASELAYERCHANGE + ' ' + TC.Consts.event.PROJECTIONCHANGE + ' ' + TC.Consts.event.VIEWCHANGE, function (e) {\r\n                    self.update(self.div, e.layer);\r\n                });\r\n\r\n\r\n                self.div.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=radio]', function (e) {\r\n\r\n                    if (e.target.value === \"moreLayers\") {\r\n                        self.showMoreLayersDialog();\r\n                    } else {\r\n                        changeInputRadioBaseMap.call(self, e);\r\n                    }\r\n\r\n                    e.stopPropagation();\r\n                }));\r\n\r\n                resolve(ctl);\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        const result = TC.control.MapContents.prototype.render.call(self, callback, TC.Util.extend({}, self.options, { controlId: self.id }));\r\n\r\n        self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n\r\n            if (self.options.dialogMore) {\r\n                const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-more-dialog');\r\n\r\n                dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`).addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    self.toggleMoreLayersDialogView();\r\n                    e.target.blur();\r\n                    e.stopPropagation();\r\n                }, { passive: true });\r\n\r\n                dialog.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=radio]', function (e) {\r\n                    changeInputRadioBaseMap.call(self, e, function (close) {\r\n                        if (close) {\r\n                            TC.Util.closeModal();\r\n                        }\r\n                    });\r\n\r\n                    e.stopPropagation();\r\n                }));\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.update = function (div, baseLayer) {\r\n        const self = this;\r\n\r\n        div = div || self.div;\r\n\r\n        div.querySelectorAll(`ul.${self.CLASS}-branch li`).forEach(function (li) {\r\n            const layer = self.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                const curBaseLayer = baseLayer || self.map.baseLayer;\r\n                const radio = li.querySelector('input[type=radio]');\r\n                const checked = curBaseLayer && (curBaseLayer === layer || curBaseLayer.id === layer.id ||\r\n                    (layer.getFallbackLayer && (curBaseLayer === layer.getFallbackLayer() || (layer.getFallbackLayer() && curBaseLayer.id === layer.getFallbackLayer().id))));\r\n\r\n                if (self.map.on3DView && layer.mustReproject && layer.fallbackLayer && layer.getFallbackLayer) {\r\n                    layer.getFallbackLayer().getCapabilitiesPromise().then(function () {\r\n                        var mustReproject = !layer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n\r\n                        radio.checked = checked;\r\n                        if (mustReproject) {\r\n                            radio.classList.add(TC.Consts.classes.DISABLED);\r\n                            li.setAttribute('title', self.map.on3DView ? self.getLocaleString('notAvailableTo3D') : self.getLocaleString('reprojectionNeeded'));\r\n                        }\r\n                        else {\r\n                            radio.classList.remove(TC.Consts.classes.DISABLED);\r\n                            li.removeAttribute('title');\r\n                        }\r\n                    });\r\n                } else {\r\n                    radio.checked = checked;\r\n                    if (layer.mustReproject) {\r\n                        radio.classList.add(TC.Consts.classes.DISABLED);\r\n                        li.setAttribute('title', self.map.on3DView ? self.getLocaleString('notAvailableTo3D') : self.getLocaleString('reprojectionNeeded'));\r\n                    }\r\n                    else {\r\n                        radio.classList.remove(TC.Consts.classes.DISABLED);\r\n                        li.removeAttribute('title');\r\n                    }\r\n                }\r\n\r\n                if (checked) {\r\n                    self._currentSelection = radio;\r\n                }\r\n            }\r\n        });\r\n\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        const self = this;        \r\n        if (layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            if (layer.getInfo) {\r\n                info = layer.getInfo(layer.names[0]);\r\n                self.layerInfos[layer.id] = info;\r\n            }\r\n\r\n\r\n            self.getRenderedHtml(self.CLASS + '-node', { layer: self.layerTrees[layer.id], info: self.layerInfos[layer.id], controlId: self.id }).then(function (out) {\r\n                const parser = new DOMParser();\r\n                const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                var uid = newLi.dataset.layerUid;\r\n                const ul = self.div.querySelector('.' + self.CLASS + '-branch');\r\n                const currentLi = ul.querySelector('li[data-layer-uid=\"' + uid + '\"]');\r\n                if (currentLi) {\r\n                    currentLi.innerHTML = newLi.innerHTML;\r\n                }\r\n                else {\r\n                    newLi.dataset.layerId = layer.id;\r\n\r\n                    // Insertamos elemento en el lugar correcto, según indica la colección baseLayers\r\n                    const setLayerIds = self.map.baseLayers\r\n                        .filter(baseLayer => baseLayer && !baseLayer.stealth) // Buscamos capas que deban mostrarse\r\n                        .map(baseLayer => baseLayer.id);\r\n                    const idx = setLayerIds.indexOf(layer.id);\r\n                    let inserted = false;\r\n                    for (let i = idx - 1; i >= 0; i--) {\r\n                        const curLi = ul.querySelector(`li[data-layer-id=\"${setLayerIds[i]}\"]`);\r\n                        if (curLi) {\r\n                            curLi.insertAdjacentElement('afterend', newLi);\r\n                            inserted = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (!inserted) {\r\n                        for (let i = idx + 1, ii = setLayerIds.length; i < ii; i++) {\r\n                            const curLi = ul.querySelector(`li[data-layer-id=\"${setLayerIds[i]}\"]`);\r\n                            if (curLi) {\r\n                                curLi.insertAdjacentElement('beforebegin', newLi);\r\n                                inserted = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (!inserted) {\r\n                            const moreLabel = ul.querySelector(`.${self.CLASS}-more-node`);\r\n                            if (moreLabel) {\r\n                                moreLabel.parentElement.insertAdjacentElement('beforebegin', newLi);\r\n                            }\r\n                            else {\r\n                                ul.appendChild(newLi);\r\n                            }\r\n                        }\r\n                    }\r\n                    self.update();\r\n                }\r\n            }).catch(function (err) {\r\n                TC.error(err);\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        // no hace nada\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        const self = this;\r\n        if (layer.isBase) {\r\n            const lis = self.div.querySelector('.' + self.CLASS + '-branch').querySelectorAll('li');\r\n            for (var i = 0, len = lis.length; i < len; i++) {\r\n                const li = lis[i];\r\n                if (li.dataset.layerId === layer.id) {\r\n                    li.parentElement.removeChild(li);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.onErrorLayer = function (layer) {\r\n        const self = this;\r\n\r\n        if (layer.isBase && !layer.options.stealth) {\r\n            self.map.toast(self.getLocaleString('baseLayerNotAvailable', { mapName: layer.title }), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n    };\r\n\r\n    ctlProto.getFallbackLayer = function (id) {\r\n        const self = this;\r\n        const filterFn = function (layer) {\r\n            return layer.fallbackLayer && layer.fallbackLayer.id === id;\r\n        };\r\n        var result = self.map.baseLayers.filter(filterFn)[0].fallbackLayer;\r\n        if (!result && self._moreBaseLayers) {\r\n            result = self._moreBaseLayers.filter(filterFn)[0].fallbackLayer;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.loadFallbackProjections = function () {\r\n        const self = this;\r\n        const lis = self._dialogDiv\r\n            .querySelector('.' + self._cssClasses.CRS_DIALOG)\r\n            .querySelectorAll('ul.' + self._cssClasses.CRS_LIST + ' li');\r\n        lis.forEach(function (li) {\r\n            li.classList.remove(TC.Consts.classes.HIDDEN);\r\n            if (li.querySelector('button.' + self._cssClasses.LOAD_CRS_BUTTON)) {\r\n                li.classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.showProjectionChangeDialog = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const layer = options.layer;\r\n        const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-crs-dialog');\r\n        const modalBody = dialog.querySelector('.tc-modal-body');\r\n        modalBody.classList.add(TC.Consts.classes.LOADING);\r\n        const blCRSList = layer.getCompatibleCRS();\r\n\r\n        dialog.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        dialog.dataset.layerId = layer.id;\r\n        const ul = dialog.querySelector('ul.' + self.CLASS + '-crs-list');\r\n        ul.innerHTML = '';\r\n        self.map.loadProjections({\r\n            crsList: self.map.getCompatibleCRS({\r\n                layers: self.map.workLayers.concat(layer),\r\n                includeFallbacks: true\r\n            }),\r\n            orderBy: 'name'\r\n        }).then(function (projList) {\r\n            var hasFallbackCRS = false;\r\n            const fragment = document.createDocumentFragment();\r\n            projList\r\n                .forEach(function (projObj) {\r\n                    const li = document.createElement('li');\r\n                    const button = document.createElement('button');\r\n\r\n                    if (blCRSList.filter(function (crs) {\r\n                        return TC.Util.CRSCodesEqual(crs, projObj.code)\r\n                    }).length === 0) {\r\n                        // Es un CRS del fallback\r\n                        hasFallbackCRS = true;\r\n\r\n                        button.innerHTML = projObj.name + ' (' + projObj.code + ')';\r\n                        if (options.layer.fallbackLayer) {\r\n                            button.dataset.fallbackLayerId = options.layer.fallbackLayer.id;\r\n                        }\r\n                        button.dataset.crsCode = projObj.code;\r\n                        button.classList.add(TC.Consts.classes.WARNING);\r\n                        li.classList.add(TC.Consts.classes.HIDDEN);\r\n                    } else {\r\n                        button.innerHTML = self.getLocaleString('changeMapToCrs', { crs: projObj.name + ' (' + projObj.code + ')' });\r\n                        button.dataset.crsCode = projObj.code;\r\n                    }\r\n\r\n                    li.appendChild(button);\r\n                    fragment.appendChild(li);\r\n                });\r\n\r\n            if (options.fallbackLayer) {\r\n                const li = document.createElement('li');\r\n                const button = document.createElement('button');\r\n                button.innerHTML = self.getLocaleString('reprojectOnTheFly');\r\n                button.dataset.fallbackLayerId = options.fallbackLayer.id;\r\n                li.appendChild(button);\r\n                fragment.appendChild(li);\r\n            }\r\n\r\n            if (hasFallbackCRS) {\r\n                const li = document.createElement('li');\r\n                const button = document.createElement('button');\r\n                button.classList.add(self._cssClasses.LOAD_CRS_BUTTON);\r\n                button.innerHTML = self.getLocaleString('showOnTheFlyProjections');\r\n                li.appendChild(button);\r\n                fragment.appendChild(li);\r\n            }\r\n            ul.appendChild(fragment);\r\n\r\n            modalBody.classList.remove(TC.Consts.classes.LOADING);\r\n        });\r\n        dialog.querySelector('.' + self.CLASS + '-name').innerHTML = layer.title || layer.name;\r\n        TC.Util.showModal(dialog);\r\n    };\r\n\r\n    ctlProto.showMoreLayersDialog = function () {\r\n        const self = this;\r\n\r\n        const dialog = self._dialogDiv.querySelector('.' + self.CLASS + '-more-dialog');\r\n\r\n        dialog.classList.toggle(TC.Consts.classes.THREED, !!self.map.on3DView);\r\n\r\n        const modalBody = dialog.querySelector('.tc-modal-body');\r\n        modalBody.innerHTML = '';\r\n        modalBody.classList.add(TC.Consts.classes.LOADING);\r\n        dialog.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        TC.Util.showModal(dialog, {\r\n            closeCallback: function () {\r\n                // no hay selección, vuelvo a seleccionar el mapa de fondo actual del mapa.\r\n                this._currentSelection.checked = true;\r\n                this.update();\r\n            }.bind(self)\r\n        });\r\n\r\n        const parentTree = self.div.querySelector(`.${self._cssClasses.TREE}`);\r\n        const isGrid = parentTree.classList.contains(self._cssClasses.GRID);\r\n        const button = dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`);\r\n        button.classList.toggle(self._cssClasses.DETAILS, isGrid);\r\n        button.classList.toggle(self._cssClasses.GRID, !isGrid);\r\n        button.setAttribute('title', self.getLocaleString(isGrid ? 'showDetailsView' : 'showGridView'));\r\n\r\n        const processLayer = bl => {\r\n            if (bl) {\r\n                const info = bl.getInfo ? bl.getInfo(bl.names[0]) : null;\r\n                return { layer: bl, info: info, controlId: self.id };\r\n            }\r\n            return {};\r\n        };\r\n        const renderBody = function () {\r\n            const isGrid = dialog.querySelector(`.${self._cssClasses.VIEW_BTN}`).classList.contains(self._cssClasses.DETAILS);\r\n            const moreBaseLayers = self._moreBaseLayers.slice();\r\n            for (var i = 0, ii = moreBaseLayers.length; i < ii; i++) {\r\n                if (!moreBaseLayers[i]) {\r\n                    moreBaseLayers[i] = false;\r\n                }\r\n            }\r\n            self.getRenderedHtml(self.CLASS, {\r\n                baseLayers: moreBaseLayers.map(processLayer),\r\n                controlId: self.id\r\n            }, function (html) {\r\n                modalBody.innerHTML = html;\r\n                const tree = modalBody.querySelector(`.${self._cssClasses.TREE}`);\r\n                tree.classList.toggle(self._cssClasses.DETAILS, !isGrid);\r\n                tree.classList.toggle(self._cssClasses.GRID, isGrid);\r\n                modalBody.classList.remove(TC.Consts.classes.LOADING);\r\n\r\n                self.update(modalBody);\r\n            });\r\n        };\r\n        self._getMoreBaseLayers(function (layerIdx) {\r\n            if (modalBody.classList.contains(TC.Consts.classes.LOADING)) {\r\n                renderBody();\r\n            }\r\n            else {\r\n                const li = modalBody.querySelector(`li.${self.CLASS}-node:nth-child(${layerIdx + 1})`);\r\n                const bl = self._moreBaseLayers[layerIdx];\r\n                if (bl) {\r\n                    self.getRenderedHtml(self.CLASS + '-node', processLayer(bl), function (html) {\r\n                        li.insertAdjacentHTML('beforebegin', html);\r\n                        li.remove();\r\n                        self.update(modalBody);\r\n                    });\r\n                }\r\n            }\r\n        }).then(function () {\r\n            renderBody();\r\n        });\r\n    };\r\n\r\n    const toggleUI = function (ctl, container) {\r\n        const tree = container.querySelector(`.${ctl._cssClasses.TREE}`);\r\n        if (tree) {\r\n            const btn = container.querySelector(`.${ctl._cssClasses.VIEW_BTN}`);\r\n            const isGrid = btn.classList.toggle(ctl._cssClasses.DETAILS);\r\n            btn.setAttribute('title', ctl.getLocaleString(btn.classList.toggle(ctl._cssClasses.GRID) ? 'showGridView' : 'showDetailsView'));\r\n            tree.classList.remove(ctl._cssClasses.DETAILS, ctl._cssClasses.GRID);\r\n            setTimeout(() => tree.classList.add(isGrid ? ctl._cssClasses.GRID : ctl._cssClasses.DETAILS), 20);\r\n        }\r\n    };\r\n\r\n    ctlProto.toggleView = function () {\r\n        const self = this;\r\n        toggleUI(self, self.div);\r\n    };\r\n\r\n    ctlProto.toggleMoreLayersDialogView = function () {\r\n        const self = this;\r\n        if (self._dialogDiv) {\r\n            toggleUI(self, self._dialogDiv);\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayer = function (id) {\r\n        const self = this;\r\n        return self.map && (self.map.getLayer(id) || (self._moreBaseLayers && self._moreBaseLayers.filter(function (layer) {\r\n            return layer.id === id;\r\n        })[0]));\r\n    };\r\n\r\n    const getTo3DVIew = function (baseLayer) {\r\n        return new Promise(function (resolve, reject) {\r\n            Promise.all([\r\n                baseLayer.getCapabilitiesPromise(),\r\n                baseLayer.getFallbackLayer() ? baseLayer.getFallbackLayer().getCapabilitiesPromise() : Promise.resolve()\r\n            ]).then(function () {\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto._getMoreBaseLayers = function (partialCallback) {\r\n        const self = this;\r\n\r\n        if (!self._moreBaseLayers && !self._moreBaseLayersPromise) {\r\n\r\n            self._moreBaseLayersPromise = new Promise(function (resolve, reject) {\r\n\r\n                // GLS: Carlos no quiere que se muestren los respectivos dinámicos así que los filtro.\r\n                var noDyn = TC.Cfg.availableBaseLayers.filter(function (l) {\r\n                    return TC.Cfg.availableBaseLayers.filter(function (l) {\r\n                        return l.fallbackLayer\r\n                    }).map(function (l) {\r\n                        return l.fallbackLayer\r\n                    }).indexOf(l.id) == -1\r\n                }).map(function (baseLayer) {\r\n                    if (baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                        return new TC.layer.Raster(baseLayer);\r\n                    } else if (baseLayer.type == TC.Consts.layerType.VECTOR) {\r\n                        return new TC.layer.Vector(baseLayer);\r\n                    }\r\n                });\r\n\r\n                self._moreBaseLayers = new Array(noDyn.length);\r\n\r\n                const resolvePromise = function () {\r\n                    self._moreBaseLayers = self._moreBaseLayers.filter(function (baseLayer) {\r\n                        return baseLayer !== null;\r\n                    });\r\n\r\n                    resolve(self._moreBaseLayers);\r\n                };\r\n                const addLayer = function (i) {\r\n                    const baseLayer = this;\r\n\r\n                    baseLayer.map = self.map;\r\n                    baseLayer.isBase = baseLayer.options.isBase = true;\r\n\r\n                    if (baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                        var matrixSet = baseLayer.wrap.getCompatibleMatrixSets(self.map.getCRS())[0];\r\n                        baseLayer.mustReproject = !matrixSet;\r\n                    } else if (baseLayer.type === TC.Consts.layerType.WMS) {\r\n                        baseLayer.mustReproject = !baseLayer.isCompatible(self.map.getCRS());\r\n                    }\r\n\r\n                    if (self.map.on3DView && baseLayer.mustReproject && baseLayer.getFallbackLayer && baseLayer.getFallbackLayer()) {\r\n                        baseLayer.mustReproject = !baseLayer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n                    }\r\n\r\n                    self._moreBaseLayers.splice(i, 1, baseLayer);\r\n                    if (TC.Util.isFunction(partialCallback)) {\r\n                        partialCallback(i);\r\n                    }\r\n                };\r\n\r\n                Promise.all(noDyn.map(function (baseLayer, i) {\r\n                    return new Promise(function (res, rej) {\r\n                        if (baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                            var promise = self.map.on3DView ? getTo3DVIew(baseLayer) : baseLayer.getCapabilitiesPromise();\r\n                            promise.then(\r\n                                function () {\r\n                                    addLayer.call(baseLayer, i);\r\n                                    res();\r\n                                },\r\n                                function (fail) {\r\n                                    self._moreBaseLayers.splice(i, 1, null);\r\n                                    if (TC.Util.isFunction(partialCallback)) {\r\n                                        partialCallback(i);\r\n                                    }\r\n                                    res();\r\n                                });\r\n                        } else {\r\n                            addLayer.call(baseLayer, i);\r\n                            res();\r\n                        }\r\n                    });\r\n                })).finally(resolvePromise);\r\n            });\r\n\r\n        } else if (self._moreBaseLayers) {\r\n\r\n            return new Promise(function (resolve, reject) {\r\n                Promise.all(self._moreBaseLayers.filter(function (baseLayer) {\r\n                    return baseLayer.type === TC.Consts.layerType.WMS || baseLayer.type === TC.Consts.layerType.WMTS;\r\n                }).map(function (baseLayer) {\r\n                    return self.map.on3DView ? getTo3DVIew(baseLayer) : baseLayer.getCapabilitiesPromise();\r\n                })).then(function () {\r\n\r\n                    self._moreBaseLayers = self._moreBaseLayers.map(function (baseLayer) {\r\n\r\n                        if (baseLayer.type === TC.Consts.layerType.WMTS) {\r\n                            var matrixSet = baseLayer.wrap.getCompatibleMatrixSets(self.map.getCRS())[0];\r\n                            baseLayer.mustReproject = !matrixSet;\r\n                        } else if (baseLayer.type === TC.Consts.layerType.WMS) {\r\n                            baseLayer.mustReproject = !baseLayer.isCompatible(self.map.getCRS());\r\n                        }\r\n                        if (self.map.on3DView && baseLayer.mustReproject && baseLayer.getFallbackLayer && baseLayer.getFallbackLayer()) {\r\n                            baseLayer.mustReproject = !baseLayer.getFallbackLayer().isCompatible(self.map.getCRS());\r\n\r\n                            return baseLayer;\r\n                        }\r\n\r\n                        return baseLayer;\r\n                    });\r\n\r\n                    resolve(self._moreBaseLayers);\r\n                });\r\n            });\r\n        }\r\n\r\n        return self._moreBaseLayersPromise;\r\n    };\r\n})();\r\n"]}