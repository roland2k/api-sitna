{"version":3,"sources":["control/MapInfo.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","MapInfo","apply","this","arguments","inherit","ctlProto","prototype","CLASS","register","map","result","call","QR_MAX_URL_LENGTH","SHORTEN_URL_LENGTH","exportsState","includeControls","undefined","options","exportControlStates","self","importControlStates","stateArray","exportState","state","featureToShare","sharedFeaturesLayer","layerState","id","clone","showsPopup","layer","features","crs","importState","length","addLayer","getUID","owner","type","Consts","layerType","VECTOR","title","getLocaleString","stealth","then","zoomToFeatures","manageMaxLengthExceed","generateLink","async","currentUrl","window","location","href","hashPosition","indexOf","substring","extraParams","params","Util","getQueryStringParams","extend","qsPosition","concat","getParamString","getParameterByName","replace","controlStates","push","extraStates","ctl","hashState","getMapState","cacheResult","url","browser","URL_MAX_LENGTH","qr","shortenedLink","wait","Promise","resolve","reject","onError","toast","msgType","ERROR","getLoadingIndicator","removeWait","start","end","generateLinkWithoutParams","addWait","tool","Proxification","data","FormData","append","proxify","allowedMixedContent","fetch","catch","error","shortenUrl","response","responseText","makeQRCode","codeContainer","width","height","loadJS","QRCode","text","MutationObserver","mutationsList","observer","srcMutation","filter","mutation","attributeName","disconnect","target","src","observe","attributes","childList","subtree","drawScaleBarIntoCanvas","canvas","sb","getControlsByClass","ScaleBar","ctx","document","createElement","getContext","save","node","getElementsByClassName","item","boundingCR","getBoundingClientRect","textContent","beginPath","strokeStyle","getComputedStyle","borderColor","setSize","left","top","moveTo","lineTo","stroke","textPosition","x","y","fill","fillnode","fillBoundingCR","globalAlpha","fillStyle","backgroundColor","fillRect","drawFill","textColor","color","font","fontSize","fontFamily","textAlign","textBaseline","fillText","registerListeners","registeredListeners","handlerTimeout","handler","e","clearTimeout","setTimeout","_controlStatesCache","on","event","LAYERADD","LAYERREMOVE","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.MapInfo = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.MapInfo, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.MapInfo.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-mi';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.QR_MAX_URL_LENGTH = 150;\r\n        self.SHORTEN_URL_LENGTH = 16000;\r\n\r\n        self.exportsState = false;\r\n\r\n        self.includeControls = self.options.includeControls === undefined || self.options.includeControls;        \r\n\r\n        return result;\r\n    }\r\n\r\n    ctlProto.exportControlStates = function () {\r\n        const self = this;\r\n        if (self.map) {\r\n            return self.map.exportControlStates();\r\n        }\r\n        return [];\r\n    };\r\n\r\n    ctlProto.importControlStates = function (stateArray) {\r\n        const self = this;\r\n        if (self.map) {\r\n            self.map.importControlStates(stateArray);\r\n        }\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.featureToShare || self.sharedFeaturesLayer) {\r\n                var layerState;\r\n                state.id = self.id;\r\n                if (self.featureToShare) {\r\n                    const featureToShare = self.featureToShare.clone();\r\n                    featureToShare.showsPopup = true;\r\n                    layerState = self.featureToShare.layer.exportState({\r\n                        features: [featureToShare]\r\n                    });\r\n                }\r\n                else {\r\n                    layerState = self.sharedFeaturesLayer.exportState();\r\n                }\r\n                state.features = layerState.features;\r\n                if (layerState.crs) {\r\n                    state.crs = layerState.crs;\r\n                }\r\n            }\r\n            return state;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map && state.features.length) {\r\n            self.map.addLayer({\r\n                id: self.getUID(),\r\n                owner: self,\r\n                type: TC.Consts.layerType.VECTOR,\r\n                title: self.getLocaleString('foi'),\r\n                stealth: true\r\n            }).then(function (layer) {\r\n                self.sharedFeaturesLayer = layer;\r\n                layer.importState({ features: state.features, crs: state.crs }).then(function () {\r\n                    self.map.zoomToFeatures(layer.features);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function () {\r\n        throw \"Falta implementación del método manageMaxLengthExceed\";\r\n    };\r\n\r\n    ctlProto.generateLink = async function () {\r\n        var self = this;\r\n        \r\n        var currentUrl = window.location.href;\r\n        var hashPosition = currentUrl.indexOf('#');\r\n        if (hashPosition > 0) {\r\n            currentUrl = currentUrl.substring(0, hashPosition);\r\n        }\r\n\r\n        if (self.extraParams) {\r\n            // Hacemos merge de parámetros de URL\r\n            var params = TC.Util.getQueryStringParams(currentUrl);\r\n            TC.Util.extend(params, self.extraParams);\r\n            var qsPosition = currentUrl.indexOf('?');\r\n            if (qsPosition >= 0) {\r\n                currentUrl = currentUrl.substring(0, qsPosition);\r\n            }\r\n            currentUrl = currentUrl.concat('?', TC.Util.getParamString(params));\r\n        }\r\n\r\n        // eliminamos el parámetro del idioma, si no lo arrastramos al compartir\r\n        if (TC.Util.getParameterByName('lang').length > 0) {\r\n            if (currentUrl.indexOf('&') > -1) { // tenemos más parámetros en la url\r\n                currentUrl = currentUrl.replace(\"lang\" + \"=\" + TC.Util.getParameterByName('lang') + '&', '');\r\n            } else {\r\n                currentUrl = currentUrl.replace('?' + \"lang\" + \"=\" + TC.Util.getParameterByName('lang'), '');\r\n            }\r\n        }\r\n\r\n        const controlStates = self.includeControls ? self.exportControlStates() : [];\r\n        if (!self.includeControls && self.exportsState && (self.featureToShare || self.sharedFeaturesLayer)) {\r\n            controlStates.push(self.exportState());\r\n        }\r\n        const extraStates = controlStates.length ? { ctl: controlStates } : undefined;\r\n\r\n        var hashState = await self.map.getMapState({ extraStates: extraStates, cacheResult: self.includeControls });\r\n\r\n        var url = currentUrl.concat(\"#\", hashState);\r\n        self.manageMaxLengthExceed({ browser: url.length > TC.Consts.URL_MAX_LENGTH, qr: url.length > self.SHORTEN_URL_LENGTH });\r\n        return url;\r\n    };\r\n\r\n    ctlProto.shortenedLink = function () {\r\n        const self = this;\r\n        var wait;\r\n\r\n        const generateLinkWithoutParams = async function () {\r\n            var url = await self.generateLink();\r\n            var start = url.indexOf('?');\r\n            var end = url.indexOf('#');\r\n\r\n            //Borramos los parámetros de la URL y dejamos sólo el hash\r\n            if (start > 0) {\r\n                if (start < end) {\r\n                    url = url.replace(url.substring(start, end), '');\r\n                } else {\r\n                    url = url.replace(url.substring(start, url.length - 1), '');\r\n                }\r\n            }\r\n\r\n            return url;\r\n        };\r\n        const shortenUrl = function (url) {\r\n            var shortenServiceUrl = \"https://tinyurl.com/api-create.php\";\r\n\r\n            if (!TC.tool || !TC.tool.Proxification) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/tool/Proxification');\r\n            }\r\n\r\n            var data = new FormData();\r\n            data.append(\"url\", url);\r\n\r\n            var toolProxification = new TC.tool.Proxification(TC.proxify, { allowedMixedContent: false });\r\n            return toolProxification.fetch(shortenServiceUrl, {\r\n                type: 'POST',\r\n                data: data\r\n            }).then(function (data) {\r\n                return data;\r\n            }).catch(function (error) {\r\n                return null;\r\n            });\r\n        };\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            const onError = function () {\r\n                self.map.toast(self.getLocaleString(\"urlTooLongForShortener\"), { type: TC.Consts.msgType.ERROR });\r\n                self.map.getLoadingIndicator().removeWait(wait);\r\n                resolve(\"\");\r\n            };\r\n\r\n            generateLinkWithoutParams().then(url => {\r\n                if (url.length > self.QR_MAX_URL_LENGTH && url.length < self.SHORTEN_URL_LENGTH) {\r\n\r\n                    wait = self.map.getLoadingIndicator().addWait();\r\n\r\n                    shortenUrl(url).then(function (response) {\r\n                        if (response && response.responseText) {\r\n                            self.map.getLoadingIndicator().removeWait(wait);\r\n                            resolve(response.responseText.replace('http://', 'https://'));\r\n                        } else {\r\n                            onError();\r\n                        }\r\n                    }, onError);\r\n                } else {\r\n                    if (url.length >= self.SHORTEN_URL_LENGTH) {\r\n                        onError();\r\n                    }\r\n\r\n                    resolve(\"\");\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.makeQRCode = function (codeContainer, width, height) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            TC.loadJS(\r\n                typeof QRCode === 'undefined',\r\n                [TC.apiLocation + 'lib/qrcode/qrcode.min.js'],\r\n                function () {\r\n                    self.shortenedLink().then(function (url) {\r\n                        url = url || \"\";\r\n                        if (url.length > 0) {\r\n                            var options = {\r\n                                text: url\r\n                            };\r\n\r\n                            if (width && height) {\r\n                                options.width = width;\r\n                                options.height = height;\r\n                            }\r\n\r\n                            var config = { attributes: true, childList: true, subtree: true };\r\n                            var observer = new MutationObserver(function (mutationsList, observer) {\r\n                                var srcMutation = mutationsList.filter(function (mutation) {\r\n                                    return mutation.type === \"attributes\"\r\n                                }).filter(function (mutation) {\r\n                                    return mutation.attributeName.indexOf('src') > -1;\r\n                                });\r\n\r\n                                if (srcMutation.length > 0) {\r\n                                    observer.disconnect();\r\n                                    resolve(srcMutation[0].target.src);\r\n                                }\r\n                            });\r\n                            observer.observe(codeContainer, config);\r\n                            new QRCode(codeContainer, options);\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    });\r\n                });\r\n        });\r\n    };\r\n\r\n    ctlProto.drawScaleBarIntoCanvas = function (options) {\r\n        const self = this;\r\n        var canvas;\r\n        var sb = self.map.getControlsByClass(TC.control.ScaleBar);\r\n        if (sb.length == 0) {\r\n            return null;\r\n        }\r\n\r\n        options = options || {};\r\n\r\n        const drawFill = function (ctx, width, height) {\r\n            var elem = document.getElementsByClassName(sb[0].CLASS);\r\n            var fillnode = elem.item(0);\r\n            var fillBoundingCR = TC.Util.extend({}, fillnode.getBoundingClientRect());\r\n\r\n            fillBoundingCR.left = (options.left || 15) - 2;\r\n\r\n            fillBoundingCR.top = options.top || 15;\r\n            fillBoundingCR.top--;\r\n\r\n            ctx.globalAlpha = 0.5;\r\n            ctx.fillStyle = window.getComputedStyle(fillnode).backgroundColor;\r\n            width += 4;\r\n            height += 4;\r\n            ctx.fillRect(fillBoundingCR.left, fillBoundingCR.top, width, height);\r\n        };\r\n\r\n        if (!options.canvas) {\r\n            canvas = document.createElement('CANVAS');\r\n        } else {\r\n            canvas = options.canvas;\r\n        }\r\n\r\n        var ctx = canvas.getContext(\"2d\");\r\n        ctx.save();\r\n\r\n        var elem = document.getElementsByClassName(\"ol-scale-line-inner\");\r\n        var node = elem.item(0);\r\n        var boundingCR = TC.Util.extend({}, node.getBoundingClientRect());\r\n\r\n        var text = node.textContent;\r\n\r\n        ctx.beginPath();\r\n        ctx.strokeStyle = window.getComputedStyle(node).borderColor;\r\n\r\n        var width, height;\r\n\r\n        if (boundingCR.width > boundingCR.height) {\r\n\r\n            width = boundingCR.width;\r\n            height = boundingCR.height;\r\n        }\r\n        else {\r\n\r\n            width = boundingCR.height;\r\n            height = boundingCR.width;\r\n        }\r\n\r\n        if (options.setSize) {\r\n            canvas.width = width;\r\n            canvas.height = height;\r\n        }\r\n\r\n        boundingCR.left = options.left != undefined ? options.left : 15;\r\n        boundingCR.top = options.top != undefined ? options.top : 15;\r\n\r\n        ctx.moveTo(boundingCR.left, boundingCR.top);\r\n        ctx.lineTo(boundingCR.left, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top);\r\n\r\n        ctx.stroke();\r\n\r\n        var textPosition = {\r\n            x: boundingCR.left + width / 2,\r\n            y: boundingCR.top + height / 2\r\n        };\r\n\r\n        if (options.fill) {\r\n            drawFill(ctx, width, height);\r\n        }\r\n\r\n        ctx.globalAlpha = 1.0;\r\n        ctx.fillStyle = options.textColor != undefined ? options.textColor : window.getComputedStyle(node).color;\r\n\r\n        ctx.font = options.font != undefined ? options.font : window.getComputedStyle(node).fontSize + \" \" + window.getComputedStyle(node).fontFamily;\r\n        ctx.textAlign = \"center\";\r\n        ctx.textBaseline = \"middle\";\r\n        ctx.fillText(text, textPosition.x, textPosition.y);\r\n\r\n        return canvas;\r\n    };\r\n\r\n    ctlProto.registerListeners = function () {\r\n        const self = this;\r\n\r\n        if (!self.registeredListeners) {\r\n            let handlerTimeout;\r\n            const handler = function (e) {\r\n                clearTimeout(handlerTimeout);\r\n                // generateLink puede ser tardar mucho, así que no lo llamamos innecesariamente cuando se están cargando varias features\r\n                handlerTimeout = setTimeout(function () {\r\n                    delete self.map._controlStatesCache;\r\n                    self.generateLink();\r\n                }, 100);\r\n            };\r\n            self.map.on(TC.Consts.event.LAYERADD, handler)\r\n                .on(TC.Consts.event.LAYERREMOVE, handler)\r\n                .on(TC.Consts.event.FEATUREADD, handler)\r\n                .on(TC.Consts.event.FEATUREREMOVE + ' ' + TC.Consts.event.FEATURESCLEAR, handler);\r\n\r\n            self.registeredListeners = true;\r\n        }\r\n    };\r\n\r\n})();"]}