{"version":3,"sources":["control/MapInfo.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","MapInfo","apply","this","arguments","inherit","ctlProto","prototype","CLASS","register","map","result","call","QR_MAX_URL_LENGTH","SHORTEN_URL_LENGTH","exportsState","includeControls","undefined","options","exportControlStates","self","importControlStates","stateArray","exportState","state","featureToShare","sharedFeaturesLayer","layerState","id","clone","showsPopup","layer","features","crs","importState","length","addLayer","getUID","owner","type","Consts","layerType","VECTOR","title","getLocaleString","stealth","then","zoomToFeatures","manageMaxLengthExceed","generateLink","async","currentUrl","window","location","href","hashPosition","indexOf","substring","extraParams","params","Util","getQueryStringParams","extend","qsPosition","concat","getParamString","start","replace","controlStates","caller","toShare","push","extraStates","ctl","hashState","getMapState","cacheResult","url","browser","URL_MAX_LENGTH","qr","shortenedLink","wait","Promise","resolve","reject","onError","toast","msgType","ERROR","getLoadingIndicator","removeWait","addWait","tool","Proxification","data","FormData","append","proxify","allowedMixedContent","fetch","catch","error","shortenUrl","response","responseText","makeQRCode","codeContainer","width","height","loadJS","QRCode","text","MutationObserver","mutationsList","observer","srcMutation","filter","mutation","attributeName","disconnect","target","src","observe","attributes","childList","subtree","drawScaleBarIntoCanvas","canvas","sb","getControlsByClass","ScaleBar","ctx","document","createElement","getContext","save","node","getElementsByClassName","item","boundingCR","getBoundingClientRect","textContent","beginPath","strokeStyle","getComputedStyle","borderColor","setSize","left","top","moveTo","lineTo","stroke","textPosition","x","y","fill","fillnode","fillBoundingCR","globalAlpha","fillStyle","backgroundColor","fillRect","drawFill","textColor","color","font","fontSize","fontFamily","textAlign","textBaseline","fillText","registerListeners","registeredListeners","handlerTimeout","handler","e","clearTimeout","setTimeout","_controlStatesCache","renderPromise","on","event","LAYERADD","LAYERREMOVE","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGE,SACJF,GAAGG,WAAWH,GAAGI,YAAc,cAGnCJ,GAAGC,QAAQI,QAAU,WAGjBL,GAAGE,QAAQI,MAFAC,KAEYC,YAG3BR,GAAGS,QAAQT,GAAGC,QAAQI,QAASL,GAAGE,UAElC,WACI,IAAIQ,EAAWV,GAAGC,QAAQI,QAAQM,UAElCD,EAASE,MAAQ,YAEjBF,EAASG,SAAW,SAAUC,GAC1B,MAEMC,EAASf,GAAGE,QAAQS,UAAUE,SAASG,KAFhCT,KAE2CO,GAF3CP,KAIRU,kBAAoB,IAJZV,KAKRW,mBAAqB,KALbX,KAORY,cAAe,EAPPZ,KASRa,qBAAmDC,IAT3Cd,KASee,QAAQF,iBATvBb,KAS6De,QAAQF,gBAElF,OAAOL,GAGXL,EAASa,oBAAsB,WAC3B,MAAMC,EAAOjB,KACb,OAAIiB,EAAKV,IACEU,EAAKV,IAAIS,sBAEb,IAGXb,EAASe,oBAAsB,SAAUC,GACrC,MAAMF,EAAOjB,KACTiB,EAAKV,KACLU,EAAKV,IAAIW,oBAAoBC,IAIrChB,EAASiB,YAAc,WACnB,MAAMH,EAAOjB,KACb,GAAIiB,EAAKL,aAAc,CACnB,MAAMS,EAAQ,GACd,GAAIJ,EAAKK,gBAAkBL,EAAKM,oBAAqB,CACjD,IAAIC,EACJH,EAAMI,GAAKR,EAAKQ,GAChB,GAAIR,EAAKK,eAAgB,CACrB,MAAMA,EAAiBL,EAAKK,eAAeI,QAC3CJ,EAAeK,YAAa,EAC5BH,EAAaP,EAAKK,eAAeM,MAAMR,YAAY,CAC/CS,SAAU,CAACP,UAGfE,EAAaP,EAAKM,oBAAoBH,cAE1CC,EAAMQ,SAAWL,EAAWK,SACxBL,EAAWM,MACXT,EAAMS,IAAMN,EAAWM,KAG/B,OAAOT,EAEX,OAAO,MAGXlB,EAAS4B,YAAc,SAAUV,GAC7B,MAAMJ,EAAOjB,KACTiB,EAAKV,KAAOc,EAAMQ,SAASG,QAC3Bf,EAAKV,IAAI0B,SAAS,CACdR,GAAIR,EAAKiB,SACTC,MAAOlB,EACPmB,KAAM3C,GAAG4C,OAAOC,UAAUC,OAC1BC,MAAOvB,EAAKwB,gBAAgB,OAC5BC,SAAS,IACVC,KAAK,SAAUf,GACdX,EAAKM,oBAAsBK,EAC3BA,EAAMG,YAAY,CAAEF,SAAUR,EAAMQ,SAAUC,IAAKT,EAAMS,MAAOa,KAAK,WACjE1B,EAAKV,IAAIqC,eAAehB,EAAMC,eAM9C1B,EAAS0C,sBAAwB,WAC7B,KAAM,+DAGV1C,EAAS2C,aAAeC,iBACpB,IAEIC,EAAaC,OAAOC,SAASC,KAC7BC,EAAeJ,EAAWK,QAAQ,KAClCD,EAAe,IACfJ,EAAaA,EAAWM,UAAU,EAAGF,IAGzC,GARWpD,KAQFuD,YAAa,CAElB,IAAIC,EAAS/D,GAAGgE,KAAKC,qBAAqBV,GAC1CvD,GAAGgE,KAAKE,OAAOH,EAXRxD,KAWqBuD,aAC5B,IAAIK,EAAaZ,EAAWK,QAAQ,KAChCO,GAAc,IACdZ,EAAaA,EAAWM,UAAU,EAAGM,IAEzCZ,EAAaA,EAAWa,OAAO,IAAKpE,GAAGgE,KAAKK,eAAeN,QAE1D,CAED,IAAIO,EAAQf,EAAWK,QAAQ,KAG3BU,EAAQ,IACRf,EAAaA,EAAWgB,QAAQhB,EAAWM,UAAUS,GAAQ,KAIrE,MAAME,EA5BKjE,KA4BgBa,gBA5BhBb,KA4BuCgB,sBAAwB,IA5B/DhB,KA6BDa,iBA7BCb,KA6BuBY,eA7BvBZ,KA6B6CsB,gBA7B7CtB,KA6BoEuB,qBA7BpEvB,KA6BiGkE,QA7BjGlE,KA6BgHkE,OAAOC,WA7BvHnE,KA8BEkE,QA9BFlE,KA8BiBkE,OAAOC,QAC3BF,EAAcG,KA/BXpE,KA+BqBkE,OAAO9C,eAE/B6C,EAAcG,KAjCXpE,KAiCqBoB,gBAGhC,MAAMiD,EAAcJ,EAAcjC,OAAS,CAAEsC,IAAKL,QAAkBnD,EAEpE,IAAIyD,QAtCOvE,KAsCgBO,IAAIiE,YAAY,CAAEH,YAAaA,EAAaI,YAtC5DzE,KAsC8Ea,kBAErF6D,EAAM1B,EAAWa,OAAO,IAAKU,GAxCtBvE,KAyCN6C,sBAAsB,CAAE8B,QAASD,EAAI1C,OAASvC,GAAG4C,OAAOuC,eAAgBC,GAAIH,EAAI1C,OAzC1EhC,KAyCwFW,qBACnG,OAAO+D,GAGXvE,EAAS2E,cAAgB,WACrB,MAAM7D,EAAOjB,KACb,IAAI+E,EAuCJ,OAAO,IAAIC,QAAQ,SAAUC,EAASC,GAClC,MAAMC,EAAU,WACZlE,EAAKV,IAAI6E,MAAMnE,EAAKwB,gBAAgB,0BAA2B,CAAEL,KAAM3C,GAAG4C,OAAOgD,QAAQC,QACzFrE,EAAKV,IAAIgF,sBAAsBC,WAAWT,GAC1CE,EAAQ,KAEZhE,EAAK6B,eAAeH,KAAK+B,IACrB,GAAIA,EAAI1C,OAASf,EAAKP,mBAAqBgE,EAAI1C,OAASf,EAAKN,mBAAoB,CAE7EoE,EAAO9D,EAAKV,IAAIgF,sBAAsBE,WA9B/B,SAAUf,GAGpBjF,GAAGiG,MAASjG,GAAGiG,KAAKC,eACrBlG,GAAGG,WAAWH,GAAGI,YAAc,yBAGnC,IAAI+F,EAAO,IAAIC,SACfD,EAAKE,OAAO,MAAOpB,GAGnB,OADwB,IAAIjF,GAAGiG,KAAKC,cAAclG,GAAGsG,QAAS,CAAEC,qBAAqB,IAC5DC,MAVD,qCAU0B,CAC9C7D,KAAM,OACNwD,KAAMA,IACPjD,KAAK,SAAUiD,GACd,OAAOA,IACRM,MAAM,SAAUC,GACf,OAAO,QAeHC,CAAW1B,GAAK/B,KAAK,SAAU0D,GAC3B,GAAIA,GAAYA,EAASC,aAAc,CACnCrF,EAAKV,IAAIgF,sBAAsBC,WAAWT,GAC1CE,EAAQoB,EAASC,aAAatC,QAAQ,UAAW,kBAEjDmB,KAELA,OACA,CACCT,EAAI1C,QAAUf,EAAKN,oBACnBwE,IAGJF,EAAQ,UAMxB9E,EAASoG,WAAa,SAAUC,EAAeC,EAAOC,GAClD,MAAMzF,EAAOjB,KACb,OAAO,IAAIgF,QAAQ,SAAUC,EAASC,GAClCzF,GAAGkH,OACmB,oBAAXC,OACP,CAACnH,GAAGI,YAAc,4BAClB,WACIoB,EAAK6D,gBAAgBnC,KAAK,SAAU+B,GAEhC,IADAA,EAAMA,GAAO,IACL1C,OAAS,EAAG,CAChB,IAAIjB,EAAU,CACV8F,KAAMnC,GAGV,GAAI+B,GAASC,EAAQ,CACjB3F,EAAQ0F,MAAQA,EAChB1F,EAAQ2F,OAASA,EAIN,IAAII,iBAAiB,SAAUC,EAAeC,GACzD,IAAIC,EAAcF,EAAcG,OAAO,SAAUC,GAC7C,MAAyB,eAAlBA,EAAS/E,OACjB8E,OAAO,SAAUC,GAChB,OAAOA,EAASC,cAAc/D,QAAQ,QAAU,IAGpD,GAAI4D,EAAYjF,OAAS,EAAG,CACxBgF,EAASK,aACTpC,EAAQgC,EAAY,GAAGK,OAAOC,QAG7BC,QAAQhB,EAbJ,CAAEiB,YAAY,EAAMC,WAAW,EAAMC,SAAS,IAc3D,IAAIf,OAAOJ,EAAezF,QAE1BkE,WAOxB9E,EAASyH,uBAAyB,SAAU7G,GAExC,IAAI8G,EACAC,EAFS9H,KAECO,IAAIwH,mBAAmBtI,GAAGC,QAAQsI,UAChD,GAAiB,GAAbF,EAAG9F,OACH,OAAO,KA4BX,IAAIiG,GAHAJ,GAtBJ9G,EAAUA,GAAW,IAmBR8G,OAGA9G,EAAQ8G,OAFRK,SAASC,cAAc,WAKnBC,WAAW,MAC5BH,EAAII,OAEJ,IASI5B,EAAOC,EARP4B,EADOJ,SAASK,uBAAuB,uBAC3BC,KAAK,GACjBC,EAAahJ,GAAGgE,KAAKE,OAAO,GAAI2E,EAAKI,yBAErC7B,EAAOyB,EAAKK,YAEhBV,EAAIW,YACJX,EAAIY,YAAc5F,OAAO6F,iBAAiBR,GAAMS,YAIhD,GAAIN,EAAWhC,MAAQgC,EAAW/B,OAAQ,CAEtCD,EAAQgC,EAAWhC,MACnBC,EAAS+B,EAAW/B,WAEnB,CAEDD,EAAQgC,EAAW/B,OACnBA,EAAS+B,EAAWhC,MAGxB,GAAI1F,EAAQiI,QAAS,CACjBnB,EAAOpB,MAAQA,EACfoB,EAAOnB,OAASA,EAGpB+B,EAAWQ,KAAuBnI,MAAhBC,EAAQkI,KAAoBlI,EAAQkI,KAAO,GAC7DR,EAAWS,IAAqBpI,MAAfC,EAAQmI,IAAmBnI,EAAQmI,IAAM,GAE1DjB,EAAIkB,OAAOV,EAAWQ,KAAMR,EAAWS,KACvCjB,EAAImB,OAAOX,EAAWQ,KAAMR,EAAWS,IAAMxC,GAC7CuB,EAAImB,OAAOX,EAAWQ,KAAOxC,EAAOgC,EAAWS,IAAMxC,GACrDuB,EAAImB,OAAOX,EAAWQ,KAAOxC,EAAOgC,EAAWS,KAE/CjB,EAAIoB,SAEJ,IAAIC,EAAe,CACfC,EAAGd,EAAWQ,KAAOxC,EAAQ,EAC7B+C,EAAGf,EAAWS,IAAMxC,EAAS,GAG7B3F,EAAQ0I,MApEK,SAAUxB,EAAKxB,EAAOC,GACnC,IACIgD,EADOxB,SAASK,uBAAuBT,EAAG,GAAGzH,OAC7BmI,KAAK,GACrBmB,EAAiBlK,GAAGgE,KAAKE,OAAO,GAAI+F,EAAShB,yBAEjDiB,EAAeV,MAAQlI,EAAQkI,MAAQ,IAAM,EAE7CU,EAAeT,IAAMnI,EAAQmI,KAAO,GACpCS,EAAeT,MAEfjB,EAAI2B,YAAc,GAClB3B,EAAI4B,UAAY5G,OAAO6F,iBAAiBY,GAAUI,gBAClDrD,GAAS,EACTC,GAAU,EACVuB,EAAI8B,SAASJ,EAAeV,KAAMU,EAAeT,IAAKzC,EAAOC,GAuD7DsD,CAAS/B,EAAKxB,EAAOC,GAGzBuB,EAAI2B,YAAc,EAClB3B,EAAI4B,UAAiC/I,MAArBC,EAAQkJ,UAAyBlJ,EAAQkJ,UAAYhH,OAAO6F,iBAAiBR,GAAM4B,MAEnGjC,EAAIkC,KAAuBrJ,MAAhBC,EAAQoJ,KAAoBpJ,EAAQoJ,KAAOlH,OAAO6F,iBAAiBR,GAAM8B,SAAW,IAAMnH,OAAO6F,iBAAiBR,GAAM+B,WACnIpC,EAAIqC,UAAY,SAChBrC,EAAIsC,aAAe,SACnBtC,EAAIuC,SAAS3D,EAAMyC,EAAaC,EAAGD,EAAaE,GAEhD,OAAO3B,GAGX1H,EAASsK,kBAAoB,WACzB,MAAMxJ,EAAOjB,KACb,IAAKiB,EAAKyJ,oBAAqB,CAC3B,IAAIC,EACJ,MAAMC,EAAU,SAAUC,GACtBC,aAAaH,GAEbA,EAAiBI,WAAW,kBACjB9J,EAAKV,IAAIyK,oBAChB/J,EAAKgK,gBAAgBtI,KAAK,WACtB1B,EAAK6B,kBAEV,MAEP7B,EAAKV,IAAI2K,GAAGzL,GAAG4C,OAAO8I,MAAMC,SAAUR,GACjCM,GAAGzL,GAAG4C,OAAO8I,MAAME,YAAaT,GAChCM,GAAGzL,GAAG4C,OAAO8I,MAAMG,WAAYV,GAC/BM,GAAGzL,GAAG4C,OAAO8I,MAAMI,cAAgB,IAAM9L,GAAG4C,OAAO8I,MAAMK,cAAeZ,GAE7E3J,EAAKyJ,qBAAsB,IAlWvC","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.MapInfo = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.MapInfo, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.MapInfo.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-mi';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.QR_MAX_URL_LENGTH = 150;\r\n        self.SHORTEN_URL_LENGTH = 16000;\r\n\r\n        self.exportsState = false;\r\n\r\n        self.includeControls = self.options.includeControls === undefined || self.options.includeControls;\r\n\r\n        return result;\r\n    }\r\n\r\n    ctlProto.exportControlStates = function () {\r\n        const self = this;\r\n        if (self.map) {\r\n            return self.map.exportControlStates();\r\n        }\r\n        return [];\r\n    };\r\n\r\n    ctlProto.importControlStates = function (stateArray) {\r\n        const self = this;\r\n        if (self.map) {\r\n            self.map.importControlStates(stateArray);\r\n        }\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.featureToShare || self.sharedFeaturesLayer) {\r\n                var layerState;\r\n                state.id = self.id;\r\n                if (self.featureToShare) {\r\n                    const featureToShare = self.featureToShare.clone();\r\n                    featureToShare.showsPopup = true;\r\n                    layerState = self.featureToShare.layer.exportState({\r\n                        features: [featureToShare]\r\n                    });\r\n                } else {\r\n                    layerState = self.sharedFeaturesLayer.exportState();\r\n                }\r\n                state.features = layerState.features;\r\n                if (layerState.crs) {\r\n                    state.crs = layerState.crs;\r\n                }\r\n            }\r\n            return state;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map && state.features.length) {\r\n            self.map.addLayer({\r\n                id: self.getUID(),\r\n                owner: self,\r\n                type: TC.Consts.layerType.VECTOR,\r\n                title: self.getLocaleString('foi'),\r\n                stealth: true\r\n            }).then(function (layer) {\r\n                self.sharedFeaturesLayer = layer;\r\n                layer.importState({ features: state.features, crs: state.crs }).then(function () {\r\n                    self.map.zoomToFeatures(layer.features);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function () {\r\n        throw \"Falta implementación del método manageMaxLengthExceed\";\r\n    };\r\n\r\n    ctlProto.generateLink = async function () {\r\n        var self = this;\r\n\r\n        var currentUrl = window.location.href;\r\n        var hashPosition = currentUrl.indexOf('#');\r\n        if (hashPosition > 0) {\r\n            currentUrl = currentUrl.substring(0, hashPosition);\r\n        }\r\n\r\n        if (self.extraParams) {\r\n            // Hacemos merge de parámetros de URL\r\n            var params = TC.Util.getQueryStringParams(currentUrl);\r\n            TC.Util.extend(params, self.extraParams);\r\n            var qsPosition = currentUrl.indexOf('?');\r\n            if (qsPosition >= 0) {\r\n                currentUrl = currentUrl.substring(0, qsPosition);\r\n            }\r\n            currentUrl = currentUrl.concat('?', TC.Util.getParamString(params));\r\n        }\r\n        else {\r\n            //eliminamos todos los paramaertos por querystring\r\n            var start = currentUrl.indexOf('?');\r\n\r\n            //Borramos los parámetros de la URL y dejamos sólo el hash\r\n            if (start > 0) {\r\n                currentUrl = currentUrl.replace(currentUrl.substring(start), '');\r\n            }\r\n        }       \r\n\r\n        const controlStates = self.includeControls ? self.exportControlStates() : [];\r\n        if (!self.includeControls && self.exportsState && (self.featureToShare || self.sharedFeaturesLayer || (self.caller && self.caller.toShare))) {\r\n            if (self.caller && self.caller.toShare) {\r\n                controlStates.push(self.caller.exportState());\r\n            } else {\r\n                controlStates.push(self.exportState());\r\n            }\r\n        }\r\n        const extraStates = controlStates.length ? { ctl: controlStates } : undefined;\r\n\r\n        var hashState = await self.map.getMapState({ extraStates: extraStates, cacheResult: self.includeControls });\r\n\r\n        var url = currentUrl.concat(\"#\", hashState);\r\n        self.manageMaxLengthExceed({ browser: url.length > TC.Consts.URL_MAX_LENGTH, qr: url.length > self.SHORTEN_URL_LENGTH });\r\n        return url;\r\n    };\r\n\r\n    ctlProto.shortenedLink = function () {\r\n        const self = this;\r\n        var wait;\r\n\r\n        //const generateLinkWithoutParams = async function () {\r\n        //    var url = await self.generateLink();\r\n        //    var start = url.indexOf('?');\r\n        //    var end = url.indexOf('#');\r\n\r\n        //    //Borramos los parámetros de la URL y dejamos sólo el hash\r\n        //    if (start > 0) {\r\n        //        if (start < end) {\r\n        //            url = url.replace(url.substring(start, end), '');\r\n        //        } else {\r\n        //            url = url.replace(url.substring(start, url.length - 1), '');\r\n        //        }\r\n        //    }\r\n\r\n        //    return url;\r\n        //};\r\n        const shortenUrl = function (url) {\r\n            var shortenServiceUrl = \"https://tinyurl.com/api-create.php\";\r\n\r\n            if (!TC.tool || !TC.tool.Proxification) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/tool/Proxification');\r\n            }\r\n\r\n            var data = new FormData();\r\n            data.append(\"url\", url);\r\n\r\n            var toolProxification = new TC.tool.Proxification(TC.proxify, { allowedMixedContent: false });\r\n            return toolProxification.fetch(shortenServiceUrl, {\r\n                type: 'POST',\r\n                data: data\r\n            }).then(function (data) {\r\n                return data;\r\n            }).catch(function (error) {\r\n                return null;\r\n            });\r\n        };\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            const onError = function () {\r\n                self.map.toast(self.getLocaleString(\"urlTooLongForShortener\"), { type: TC.Consts.msgType.ERROR });\r\n                self.map.getLoadingIndicator().removeWait(wait);\r\n                resolve(\"\");\r\n            };\r\n            self.generateLink().then(url => {\r\n                if (url.length > self.QR_MAX_URL_LENGTH && url.length < self.SHORTEN_URL_LENGTH) {\r\n\r\n                    wait = self.map.getLoadingIndicator().addWait();\r\n\r\n                    shortenUrl(url).then(function (response) {\r\n                        if (response && response.responseText) {\r\n                            self.map.getLoadingIndicator().removeWait(wait);\r\n                            resolve(response.responseText.replace('http://', 'https://'));\r\n                        } else {\r\n                            onError();\r\n                        }\r\n                    }, onError);\r\n                } else {\r\n                    if (url.length >= self.SHORTEN_URL_LENGTH) {\r\n                        onError();\r\n                    }\r\n\r\n                    resolve(\"\");\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.makeQRCode = function (codeContainer, width, height) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            TC.loadJS(\r\n                typeof QRCode === 'undefined',\r\n                [TC.apiLocation + 'lib/qrcode/qrcode.min.js'],\r\n                function () {\r\n                    self.shortenedLink().then(function (url) {\r\n                        url = url || \"\";\r\n                        if (url.length > 0) {\r\n                            var options = {\r\n                                text: url\r\n                            };\r\n\r\n                            if (width && height) {\r\n                                options.width = width;\r\n                                options.height = height;\r\n                            }\r\n\r\n                            var config = { attributes: true, childList: true, subtree: true };\r\n                            var observer = new MutationObserver(function (mutationsList, observer) {\r\n                                var srcMutation = mutationsList.filter(function (mutation) {\r\n                                    return mutation.type === \"attributes\"\r\n                                }).filter(function (mutation) {\r\n                                    return mutation.attributeName.indexOf('src') > -1;\r\n                                });\r\n\r\n                                if (srcMutation.length > 0) {\r\n                                    observer.disconnect();\r\n                                    resolve(srcMutation[0].target.src);\r\n                                }\r\n                            });\r\n                            observer.observe(codeContainer, config);\r\n                            new QRCode(codeContainer, options);\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    });\r\n                });\r\n        });\r\n    };\r\n\r\n    ctlProto.drawScaleBarIntoCanvas = function (options) {\r\n        const self = this;\r\n        var canvas;\r\n        var sb = self.map.getControlsByClass(TC.control.ScaleBar);\r\n        if (sb.length == 0) {\r\n            return null;\r\n        }\r\n\r\n        options = options || {};\r\n\r\n        const drawFill = function (ctx, width, height) {\r\n            var elem = document.getElementsByClassName(sb[0].CLASS);\r\n            var fillnode = elem.item(0);\r\n            var fillBoundingCR = TC.Util.extend({}, fillnode.getBoundingClientRect());\r\n\r\n            fillBoundingCR.left = (options.left || 15) - 2;\r\n\r\n            fillBoundingCR.top = options.top || 15;\r\n            fillBoundingCR.top--;\r\n\r\n            ctx.globalAlpha = 0.5;\r\n            ctx.fillStyle = window.getComputedStyle(fillnode).backgroundColor;\r\n            width += 4;\r\n            height += 4;\r\n            ctx.fillRect(fillBoundingCR.left, fillBoundingCR.top, width, height);\r\n        };\r\n\r\n        if (!options.canvas) {\r\n            canvas = document.createElement('CANVAS');\r\n        } else {\r\n            canvas = options.canvas;\r\n        }\r\n\r\n        var ctx = canvas.getContext(\"2d\");\r\n        ctx.save();\r\n\r\n        var elem = document.getElementsByClassName(\"ol-scale-line-inner\");\r\n        var node = elem.item(0);\r\n        var boundingCR = TC.Util.extend({}, node.getBoundingClientRect());\r\n\r\n        var text = node.textContent;\r\n\r\n        ctx.beginPath();\r\n        ctx.strokeStyle = window.getComputedStyle(node).borderColor;\r\n\r\n        var width, height;\r\n\r\n        if (boundingCR.width > boundingCR.height) {\r\n\r\n            width = boundingCR.width;\r\n            height = boundingCR.height;\r\n        }\r\n        else {\r\n\r\n            width = boundingCR.height;\r\n            height = boundingCR.width;\r\n        }\r\n\r\n        if (options.setSize) {\r\n            canvas.width = width;\r\n            canvas.height = height;\r\n        }\r\n\r\n        boundingCR.left = options.left != undefined ? options.left : 15;\r\n        boundingCR.top = options.top != undefined ? options.top : 15;\r\n\r\n        ctx.moveTo(boundingCR.left, boundingCR.top);\r\n        ctx.lineTo(boundingCR.left, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top);\r\n\r\n        ctx.stroke();\r\n\r\n        var textPosition = {\r\n            x: boundingCR.left + width / 2,\r\n            y: boundingCR.top + height / 2\r\n        };\r\n\r\n        if (options.fill) {\r\n            drawFill(ctx, width, height);\r\n        }\r\n\r\n        ctx.globalAlpha = 1.0;\r\n        ctx.fillStyle = options.textColor != undefined ? options.textColor : window.getComputedStyle(node).color;\r\n\r\n        ctx.font = options.font != undefined ? options.font : window.getComputedStyle(node).fontSize + \" \" + window.getComputedStyle(node).fontFamily;\r\n        ctx.textAlign = \"center\";\r\n        ctx.textBaseline = \"middle\";\r\n        ctx.fillText(text, textPosition.x, textPosition.y);\r\n\r\n        return canvas;\r\n    };\r\n\r\n    ctlProto.registerListeners = function () {\r\n        const self = this;\r\n        if (!self.registeredListeners) {\r\n            let handlerTimeout;\r\n            const handler = function (e) {\r\n                clearTimeout(handlerTimeout);\r\n                // generateLink puede ser tardar mucho, así que no lo llamamos innecesariamente cuando se están cargando varias features\r\n                handlerTimeout = setTimeout(function () {\r\n                    delete self.map._controlStatesCache;\r\n                    self.renderPromise().then(function () {\r\n                        self.generateLink();\r\n                    });\r\n                }, 100);\r\n            };\r\n            self.map.on(TC.Consts.event.LAYERADD, handler)\r\n                .on(TC.Consts.event.LAYERREMOVE, handler)\r\n                .on(TC.Consts.event.FEATUREADD, handler)\r\n                .on(TC.Consts.event.FEATUREREMOVE + ' ' + TC.Consts.event.FEATURESCLEAR, handler);\r\n\r\n            self.registeredListeners = true;\r\n        }\r\n    };\r\n\r\n})();"]}