{"version":3,"sources":["control/LayerCatalog.js"],"names":["TC","control","ProjectionSelector","syncLoadJS","apiLocation","LayerCatalog","this","layers","searchInit","apply","arguments","_selectors","LAYER_ROOT","CLASS","Consts","classes","SELECTABLE","INCOMPATIBLE","ACTIVE","inherit","ctlProto","prototype","template","1","container","depth0","helpers","partials","data","stack1","alias1","nullContext","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","name","hash","fn","program","inverse","noop","loc","start","line","column","end","2","escapeExpression","4","5","invokePartial","indent","decorators","7","8","9","lambda","alias2","11","compiler","main","usePartial","useData","6","alias3","3","13","14","16","18","blockParams","depths","10","12","useDepths","showProjectionChangeDialog","ctl","layer","closeCallback","getLayerNodes","forEach","node","classList","remove","LOADING","querySelector","dataset","tooltip","getLocaleString","register","map","self","result","load","resolve","reject","Array","isArray","options","i","length","type","layerType","WMS","id","getUID","Util","isPlainObject","Raster","push","render","_readyPromise","Promise","waitLoad","e","baseLayer","off","event","LAYERUPDATE","loaded","state","Layer","IDLE","on","clickToAddText","BEFORELAYERADD","BEFOREUPDATEPARAMS","add","LAYERADD","UPDATEPARAMS","isBase","then","getLayerRootNode","updateControl","layerAlreadyAdded","len","lyr","url","layersToSetChecked","addLayer","layerNames","title","wrap","getServiceTitle","hideTitle","hideTree","LAYERERROR","reason","some","f","alert","LAYERREMOVE","CHECKED","list","querySelectorAll","li","getLayer","layerId","names","layerName","findResultNodes","layerRemoved","wlCtrl","getControlsByClass","WorkLayerManager","_markWorkLayersAsAdded","_refreshResultList","EXTERNALSERVICEADDED","div","COLLAPSED","PROJECTIONCHANGE","update","onCollapseButtonClick","target","blur","stopPropagation","parentElement","tagName","contains","toggle","document","evt","createEvent","initEvent","textInput","dispatchEvent","fireEvent","addLogicToNode","btn","addEventListener","span","parentNode","preventDefault","undefined","toString","_roots","root","redrawTime","test","navigator","userAgent","detectFirefox","getTree","element","setTimeout","offsetHeight","offsetWidth","addLayerToMap","onSpanClick","a","info","getInfo","CLICK","showLayerInfo","hideLayerInfo","passive","removeChild","compatibleLayers","indexOf","setAttribute","j","workLayers","wl","innerText","index","array","splice","getRenderedHtml","html","_dialogDiv","innerHTML","renderBranch","callback","promiseRenderResolve","sourceLayers","unshift","getCapabilitiesPromise","expandNode","level","expandedNodeLevel","expanded","children","makeNodeVisible","childrenVisible","isVisible","getLayerTree","createElement","branch","newChild","content","firstChild","oldChild","replaceChild","insertAdjacentElement","childElementCount","isFunction","l","bind","catch","error","errorMessage","serviceName","liError","toast","msgType","ERROR","_set1stRenderPromise","renderData","layerTrees","enableSearch","value","layerCheckedList","_search","retryTimeout","loadJS","UI","autocomplete","link","minLength","source","text","item","trim","clearTimeout","results","ii","sourceLayer","_founds","searchSubLayers","service","founds","servicesFound","servicesLooked","interval","lastPattern","goToResult","unescape","substring","buildHTML","k","alreadyAdded","Name","isCollapsed","ret","out","searchPane","treePane","infoPane","searchPaneMustShow","HIDDEN","focus","EventTarget","listenerBySelector","filter","serviceId","searchListElementSelector","matches","liParent","ctlLayer","isCompatible","crs","$events","TILELOADERROR","code","removeLayer","toLowerCase","rootNode","liLayer","toggleInfo","infoObj","err","fncRecursiva_","Title","abstract","Abstract","metadata","MetadataURL","reduce","vi","va","format","Format","formatDescription","locale","getSimpleMimeType","OnlineResource","res","as","jj","n","t","capabilities","Capability","getCompatibleLayers","removeAttribute","fromLayerCatalog","getMap","reqGetMapOnCapabilities","replace","regex","PROTOCOL","configLayer","layerOptions","extend","newLayer","getAvailableCRS","getCompatibleCRS","concat","includeFallbacks","setProjection","loadProjDef","_layerToAdd","closeModal"],"mappings":"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","sourcesContent":["\r\n/**\r\n  * Opciones de control de catálogo de capas disponibles. \r\n  * \r\n  * Con este control se dispone de las siguientes funcionalidades:\r\n  *\r\n  *    - Consultar las capas disponibles en uno o varios WMS.\r\n  *    - Buscar capas mediante texto libre. Se busca el texto en los títulos y los resúmenes descriptivos de cada capa, que se publican en el [documento de capacidades](https://github.com/7o9/implementer-friendly-standards/blob/master/introduction.rst#getcapabilities) del servicio.\r\n  *    - Añadir capas al mapa como capas de trabajo.\r\n  * @typedef LayerCatalogOptions\r\n  * @extends ControlOptions\r\n  * @see MapControlOptions\r\n  * @property {HTMLElement|string} [div] - Elemento del DOM en el que crear el control o valor de atributo id de dicho elemento.\r\n  * @property {boolean} [enableSearch] - Propiedad que establece si se puede buscar capas por texto. La búsqueda del texto se realiza en los títulos \r\n  * y los resúmenes descriptivos de cada capa, que se publican en el [documento de capacidades](https://github.com/7o9/implementer-friendly-standards/blob/master/introduction.rst#getcapabilities) del servicio.\r\n  * @property {LayerOptions[]} layers - Lista de objetos de definición de las con capas de servicios WMS que queremos añadir al catálogo.\r\n  * \r\n  * En estos objetos, si se asigna un valor a la propiedad `layerNames`, solo las capas especificadas y sus hijas estarán disponibles para ser añadidas al mapa. \r\n  * Sin embargo, si esta propiedad se deja sin asignar, todas las capas publicadas en el servicio WMS estarán disponibles para ser añadidas.\r\n  * @example <caption>[Ver en vivo](../examples/cfg.MapControlOptions.layerCatalog_workLayerManager.html)</caption> {@lang html}\r\n  * <div id=\"mapa\"></div>\r\n  * <script>\r\n  *     // Establecemos un layout simplificado apto para hacer demostraciones de controles.\r\n  *     SITNA.Cfg.layout = \"layout/ctl-container\";\r\n  *     // Añadimos el control de capas cargadas en la primera posición.\r\n  *     SITNA.Cfg.controls.workLayerManager = {\r\n  *         div: \"slot1\"\r\n  *     };\r\n  *     // Establecemos un proxy porque se hacen peticiones a otro dominio.\r\n  *     SITNA.Cfg.proxy = \"proxy/proxy.ashx?\";\r\n  *     // Añadimos en la segunda posición el catálogo de capas con dos servicios.\r\n  *     SITNA.Cfg.controls.layerCatalog = {\r\n  *         div: \"slot2\",\r\n  *         enableSearch: true,\r\n  *         layers: [\r\n  *             {\r\n  *                 id: \"idena\",\r\n  *                 title: \"IDENA\",\r\n  *                 hideTitle: true,\r\n  *                 type: SITNA.Consts.layerType.WMS,\r\n  *                 url: \"//idena.navarra.es/ogc/wms\",\r\n  *                 hideTree: false\r\n  *             },\r\n  *             {\r\n  *                 id: \"sismica\",\r\n  *                 title: \"Información sísmica y volcánica\",\r\n  *                 type: SITNA.Consts.layerType.WMS,\r\n  *                 url: \"//www.ign.es/wms-inspire/geofisica\",\r\n  *                 layerNames: [\"Ultimos10dias\", \"Ultimos30dias\", \"Ultimos365dias\"],\r\n  *                 hideTree: false\r\n  *             }\r\n  *         ]\r\n  *     };\r\n  *     var map = new SITNA.Map(\"mapa\");\r\n  * </script>\r\n  */\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.control.ProjectionSelector) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/ProjectionSelector');\r\n}\r\n\r\n(function () {\r\n\r\n    TC.control.LayerCatalog = function () {\r\n        var self = this;\r\n\r\n        self.layers = [];\r\n        self.searchInit = false;\r\n\r\n        TC.control.ProjectionSelector.apply(self, arguments);\r\n\r\n        self._selectors = {\r\n            LAYER_ROOT: 'div.' + self.CLASS + '-tree > ul.' + self.CLASS + '-branch > li.' + self.CLASS + '-node'\r\n        };\r\n\r\n        if (!TC.Consts.classes.SELECTABLE) {\r\n            TC.Consts.classes.SELECTABLE = 'tc-selectable';\r\n        }\r\n        if (!TC.Consts.classes.INCOMPATIBLE) {\r\n            TC.Consts.classes.INCOMPATIBLE = 'tc-incompatible';\r\n        }\r\n        if (!TC.Consts.classes.ACTIVE) {\r\n            TC.Consts.classes.ACTIVE = 'tc-active';\r\n        }\r\n    };\r\n\r\n    TC.inherit(TC.control.LayerCatalog, TC.control.ProjectionSelector);\r\n\r\n    var ctlProto = TC.control.LayerCatalog.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-lcat';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-lcat.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-branch'] = TC.apiLocation + \"TC/templates/tc-ctl-lcat-branch.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/tc-ctl-lcat-node.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-info'] = TC.apiLocation + \"TC/templates/tc-ctl-lcat-info.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-results'] = TC.apiLocation + \"TC/templates/tc-ctl-lcat-results.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/tc-ctl-lcat-dialog.hbs\";\r\n\r\n    const showProjectionChangeDialog = function (ctl, layer) {\r\n        ctl.showProjectionChangeDialog({\r\n            layer: layer,\r\n            closeCallback: function () {\r\n                ctl.getLayerNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.LOADING);\r\n                    node.querySelector('span').dataset.tooltip = ctl.getLocaleString('clickToAddToMap');\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    var SEARCH_MIN_LENGTH = 3;\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.control.ProjectionSelector.prototype.register.call(self, map);\r\n\r\n        const load = function (resolve, reject) {\r\n            if (Array.isArray(self.options.layers)) {\r\n                for (var i = 0; i < self.options.layers.length; i++) {\r\n                    var layer = self.options.layers[i];\r\n                    if (!layer.type || layer.type === TC.Consts.layerType.WMS) {\r\n                        if (!layer.id) {\r\n                            layer.id = TC.getUID();\r\n                        }                        \r\n                        if (TC.Util.isPlainObject(layer)) {\r\n                            layer = new TC.layer.Raster(layer);\r\n                        }                        \r\n                        self.layers.push(layer);\r\n                    }\r\n                }\r\n                self.render(function () {\r\n                    resolve();\r\n                });\r\n            }\r\n            else {\r\n                resolve();\r\n            }\r\n        };\r\n\r\n        self._readyPromise = new Promise(function (resolve, reject) {\r\n            const waitLoad = function (e) {\r\n                if (e.layer === map.baseLayer) {\r\n                    load(resolve, reject);\r\n                    map.off(TC.Consts.event.LAYERUPDATE, waitLoad);\r\n                }\r\n            };\r\n\r\n            map.loaded(function () {\r\n                if (!map.baseLayer.state || map.baseLayer.state === TC.Layer.state.IDLE) {\r\n                    load(resolve, reject);\r\n                }\r\n                else {\r\n                    map.on(TC.Consts.event.LAYERUPDATE, waitLoad);\r\n                }\r\n            });\r\n        });\r\n\r\n        const findResultNodes = function (layer) {\r\n            const result = [];\r\n            if (!layer.isBase) {\r\n                var url = layer.options.url;\r\n                if (self.list) {\r\n                    self.list.querySelectorAll('li').forEach(function (li) {\r\n                        const lyr = self.getLayer(li.dataset.layerId);\r\n                        if (lyr && lyr.type === layer.type && lyr.options.url === url) {\r\n                            for (var i = 0; i < layer.names.length; i++) {\r\n                                if (li.dataset.layerName === layer.names[i]) {\r\n                                    result.push(li);\r\n                                    break;\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n            return result;\r\n        };\r\n\r\n        /*\r\n         * Marca todas las capas del TOC como añadidas excepto la que se está borrando que se recibe como parámetro.\r\n         */\r\n        const _markWorkLayersAsAdded = function (layerRemoved) {\r\n            var wlCtrl = self.map.getControlsByClass(TC.control.WorkLayerManager)[0];\r\n            if (wlCtrl) {\r\n                var layers = wlCtrl.layers;\r\n\r\n                for (var i = 0; i < layers.length; i++) {\r\n                    var layer = layers[i];\r\n\r\n                    if (layer !== layerRemoved) {\r\n                        self.getLayerNodes(layer).forEach(function (node) {\r\n                            node.classList.add(TC.Consts.classes.CHECKED);\r\n                            node.querySelector('span').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        var clickToAddText = self.getLocaleString('clickToAddToMap');\r\n\r\n        map\r\n            .on(TC.Consts.event.BEFORELAYERADD + ' ' + TC.Consts.event.BEFOREUPDATEPARAMS, function (e) {\r\n                self.getLayerNodes(e.layer).forEach(function (node) {\r\n                    node.classList.add(TC.Consts.classes.LOADING);\r\n                    delete node.querySelector('span').dataset.tooltip;\r\n                });\r\n            })\r\n            .on(TC.Consts.event.LAYERADD + ' ' + TC.Consts.event.UPDATEPARAMS, function (e) {\r\n                const layer = e.layer;\r\n                if (!layer.isBase && layer.type === TC.Consts.layerType.WMS) {\r\n                    self.loaded().then(function () { // Esperamos a que cargue primero las capas de la configuración\r\n\r\n                        if (self.getLayerRootNode(layer)) {\r\n                            updateControl.call(self, layer);\r\n                        }\r\n                        else {\r\n                            // la capa no está renderizada, pero podría estar en proceso, comprobamos que no está en la lista de capas del control\r\n                            var layerAlreadyAdded = false;\r\n                            for (var i = 0, len = self.layers.length; i < len; i++) {\r\n                                var lyr = self.layers[i];\r\n                                if (lyr.type === layer.type && lyr.options.url === layer.options.url) {\r\n                                    layerAlreadyAdded = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n\r\n                            // 12/03/2019 GLS la capa forma parte de los servicios configurados pero el nodo aún no se ha cargado, la guardamos\r\n                            if (layerAlreadyAdded) {\r\n                                if (!self.layersToSetChecked) {\r\n                                    self.layersToSetChecked = [];\r\n                                }\r\n\r\n                                self.layersToSetChecked.push(layer);\r\n                            } else {\r\n                                self.addLayer(new TC.layer.Raster({\r\n                                    url: layer.options.url,\r\n                                    type: layer.type,\r\n                                    layerNames: [],\r\n                                    title: layer.title || layer.wrap.getServiceTitle(),\r\n                                    hideTitle: true,\r\n                                    hideTree: false\r\n                                })).then(function () {\r\n                                    updateControl.call(self, layer);\r\n                                });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            })\r\n            .on(TC.Consts.event.LAYERERROR, function (e) {\r\n                const reason = e.reason;\r\n                if (self.layers.some((f) => { return f == e.layer })) {\r\n                    if (reason) {\r\n                        TC.alert(self.getLocaleString(reason, { url: e.layer.url }));\r\n                    }\r\n                    self.getLayerNodes(e.layer).forEach(function (node) {\r\n                        node.classList.remove(TC.Consts.classes.LOADING);\r\n                    });\r\n                }                \r\n            })\r\n            .on(TC.Consts.event.LAYERREMOVE, function (e) {\r\n                const layer = e.layer;\r\n                self.getLayerNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.CHECKED);\r\n                    node.querySelector('span').dataset.tooltip = clickToAddText;\r\n                });\r\n                findResultNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.CHECKED);\r\n                    node.querySelector('h5').dataset.tooltip = clickToAddText;\r\n                });\r\n\r\n                //Marcamos como añadidas aquellas capas que estén en el control de capas cargadas. Esto previene que si borramos una capa padre, todas\r\n                //sus hijas aparezcan como no añadidas, a pesar que que alguna de ellas haya sido añadida previamente de manera individual\r\n                _markWorkLayersAsAdded(layer);\r\n\r\n                //refresh del searchList            \r\n                _refreshResultList.call(self);\r\n            })\r\n            .on(TC.Consts.event.EXTERNALSERVICEADDED, function (e) {\r\n                if (e && e.layer) {\r\n                    self.addLayer(e.layer);\r\n                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                }\r\n            })\r\n            .on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.update();\r\n            });\r\n\r\n        return result;\r\n    };\r\n\r\n    const onCollapseButtonClick = function (e) {\r\n        e.target.blur();\r\n        e.stopPropagation();\r\n        const li = e.target.parentElement;\r\n        if (li.tagName === 'LI' && !li.classList.contains(self.CLASS + '-leaf')) {\r\n            li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n            const ul = li.querySelector('ul');\r\n            ul.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n        }\r\n    };\r\n\r\n    const onSpanClick = function (e, ctl) {\r\n        const li = e.target.parentNode;\r\n        if (!li.classList.contains(TC.Consts.classes.LOADING) && !li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n            e.preventDefault;\r\n\r\n            var layerName = li.dataset.layerName;\r\n            layerName = (layerName !== undefined) ? layerName.toString() : '';\r\n            var layer;\r\n            for (var i = 0, len = ctl._roots.length; i < len; i++) {\r\n                const root = ctl._roots[i];\r\n                if (root.contains(li)) {\r\n                    layer = ctl.getLayer(root.dataset.layerId);\r\n                    break;\r\n                }\r\n            }\r\n            if (!layer) {\r\n                layer = ctl.getLayer(li.dataset.layerId);\r\n            }\r\n            if (layer && layerName) {\r\n                var redrawTime = 1;\r\n\r\n                if (/iPad/i.test(navigator.userAgent))\r\n                    redrawTime = 10;\r\n                else if (TC.Util.detectFirefox())\r\n                    redrawTime = 250;\r\n\r\n                if (!layer.title) {\r\n                    layer.title = layer.getTree().title;\r\n                }\r\n\r\n                li.classList.add(TC.Consts.classes.LOADING);\r\n                li.querySelector('span').dataset.tooltip = '';\r\n\r\n                const reDraw = function (element) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        setTimeout(function () {\r\n                            element.offsetHeight = element.offsetHeight;\r\n                            element.offsetWidth = element.offsetWidth;\r\n\r\n                            resolve();\r\n                        }, redrawTime);\r\n                    });\r\n                };\r\n\r\n                reDraw(li).then(function () {\r\n                    ctl.addLayerToMap(layer, layerName);\r\n                });\r\n                e.stopPropagation();\r\n            }\r\n        }\r\n    };\r\n\r\n    const createSearchAutocomplete = function () {\r\n        const self = this;\r\n\r\n        self.textInput = self.div.querySelector(\".\" + self.CLASS + \"-input\");\r\n        self.list = self.div.querySelector(\".\" + self.CLASS + \"-search ul\");\r\n        // Clear results list when x button is pressed in the search input\r\n        self.textInput.addEventListener('mouseup', function (e) {\r\n            var oldValue = self.textInput.value;\r\n\r\n            if (oldValue === '') {\r\n                return;\r\n            }\r\n\r\n            // When this event is fired after clicking on the clear button\r\n            // the value is not cleared yet. We have to wait for it.\r\n            setTimeout(function () {\r\n                var newValue = self.textInput.value;\r\n\r\n                if (newValue === '') {\r\n                    self.list.innerHTML = '';\r\n                }\r\n            }, 1);\r\n        });\r\n\r\n        var layerCheckedList = [];\r\n        //Definir el autocomplete del buscador de capas por texto\r\n        TC._search = TC._search || {};\r\n        TC._search.retryTimeout = null;\r\n\r\n                    TC.loadJS(\r\n                        !TC.UI || !TC.UI.autocomplete,\r\n                        [TC.apiLocation + 'TC/ui/autocomplete.js'],\r\n                        function () {\r\n                            TC.UI.autocomplete.call(self.textInput, {\r\n                                link: '#',\r\n                                target: self.list,\r\n                                minLength: 0,\r\n                                source: function (text, callback) {\r\n                                    //lista de capas marcadas\r\n                                    layerCheckedList = [];\r\n                                    self._roots.forEach(function (root) {\r\n                                        root.querySelectorAll(\"li.\" + TC.Consts.classes.CHECKED).forEach(function (item) {\r\n                                            layerCheckedList.push(item.dataset.layerName);\r\n                                        });\r\n                                    });\r\n\r\n                        //con texto vacío, limpiar  y ocultar la lista de resultados\r\n                        text = text.trim();\r\n                        if (text.length < SEARCH_MIN_LENGTH) {\r\n                            self.list.innerHTML = '';\r\n                        }\r\n                        else if (text.length >= SEARCH_MIN_LENGTH) {\r\n                            if (TC._search.retryTimeout)\r\n                                clearTimeout(TC._search.retryTimeout);\r\n                            TC._search.retryTimeout = setTimeout(function () {\r\n                                var results = [];\r\n                                for (var i = 0, ii = self.sourceLayers.length; i < ii; i++) {\r\n                                    const sourceLayer = self.sourceLayers[i];\r\n                                    var _founds = sourceLayer.searchSubLayers(text);\r\n                                    if (_founds.length) {\r\n                                        results.push({\r\n                                            service: {\r\n                                                id: sourceLayer.id,\r\n                                                title: sourceLayer.title || sourceLayer.id\r\n                                            },\r\n                                            founds: _founds\r\n                                        });\r\n                                    }\r\n                                }\r\n                                callback({ servicesFound: results, servicesLooked: self.sourceLayers.length });\r\n                            }, TC._search.interval);\r\n                        }\r\n                    },\r\n                    callback: function (e) {\r\n                        self.textInput.value = e.target.text || e.target.innerText;\r\n                        TC._search.lastPattern = self.textInput.value;\r\n                        self.goToResult(unescape(e.target.hash).substring(1));\r\n                        TC.UI.autocomplete.call(self.textInput, 'clear');\r\n                    },\r\n                    buildHTML: function (data) {\r\n                        var container = this.target;\r\n                        //si hay resultados, mostramos la lista\r\n                        if (data.results && data.results.servicesFound.length > 0) {\r\n                            var workLayers = self.map.getLayerTree().workLayers;\r\n                            for (var k = 0; k < data.results.servicesFound.length; k++) {\r\n                                var founds = data.results.servicesFound[k].founds;\r\n                                for (var j = 0; j < founds.length; j++) {\r\n                                    delete founds[j].alreadyAdded;\r\n                                    for (var i = 0; i < workLayers.length; i++) {\r\n                                        //if (workLayers[i].title == data.results[j].Title ) {\r\n                                        if (layerCheckedList.indexOf(founds[j].Name) >= 0) {\r\n                                            founds[j].alreadyAdded = true;\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                    //Si la capa no tiene Name, no se puede añadir al TOC\r\n                                    if (!founds[j].Name) {\r\n                                        founds.splice(j, 1);\r\n                                        j--;\r\n                                    }\r\n                                }\r\n                                if (!data.results.servicesFound[k].founds.length) {\r\n                                    data.results.servicesFound.splice(k, 1);\r\n                                    continue;\r\n                                }\r\n                                //si estaba collapsado mantenemos el estado\r\n                                if (self.div.querySelectorAll(\".tc-ctl-lcat-search-group\")[k]) {\r\n                                    data.results.servicesFound[k].service.isCollapsed = self.div.querySelectorAll(\".tc-ctl-lcat-search-group\")[k].classList.contains(TC.Consts.classes.COLLAPSED);\r\n                                }\r\n                            }\r\n                        }\r\n                        var ret = ''\r\n                        self.getRenderedHtml(self.CLASS + '-results', data.results).then(function (out) {\r\n                            container.innerHTML = ret = out;\r\n                        });\r\n                        return ret;\r\n                    }\r\n                });\r\n            });\r\n\r\n\r\n        if (!self.searchInit) {\r\n            //botón de la lupa para alternar entre búsqueda y árbol\r\n            self.div.querySelector('h2 button').addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                e.target.blur();\r\n                self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                e.stopPropagation();\r\n\r\n                const searchPane = self.div.querySelector('.' + self.CLASS + '-search');\r\n                const treePane = self.div.querySelector('.' + self.CLASS + '-tree');\r\n                const infoPane = self.div.querySelector('.' + self.CLASS + '-info');\r\n\r\n                const searchPaneMustShow = searchPane.classList.contains(TC.Consts.classes.HIDDEN);\r\n                searchPane.classList.toggle(TC.Consts.classes.HIDDEN, !searchPaneMustShow);\r\n                treePane.classList.toggle(TC.Consts.classes.HIDDEN, searchPaneMustShow);\r\n                e.target.classList.toggle(self.CLASS + '-btn-tree', searchPaneMustShow);\r\n                e.target.classList.toggle(self.CLASS + '-btn-search', !searchPaneMustShow);\r\n                if (searchPaneMustShow) {\r\n                    self.textInput.focus();\r\n                    e.target.setAttribute('title', self.getLocaleString('viewAvailableLayersTree'));\r\n\r\n                    //Si no hay resultados resaltados en el buscador, ocultamos el panel de info\r\n                    const selectedCount = self.div.querySelectorAll('.tc-ctl-lcat-search li button.tc-checked').length;\r\n                    if (selectedCount === 0) {\r\n                        infoPane.classList.add(TC.Consts.classes.HIDDEN);\r\n                    }\r\n                }\r\n                else {\r\n                    e.target.setAttribute('title', self.getLocaleString('searchLayersByText'));\r\n\r\n                    //Si hay resaltados en el árbol, mostramos el panel de info\r\n                    const selectedCount = self.div.querySelectorAll('.tc-ctl-lcat-tree li button.tc-checked').length;\r\n                    if (selectedCount > 0) {\r\n                        infoPane.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    }\r\n                }\r\n            }, { passive: true });\r\n\r\n\r\n            //evento de expandir nodo de info\r\n            //self._$div.off(\"click\", \".tc-ctl-lcat-search button\");                        \r\n            self.div.addEventListener(\"click\", TC.EventTarget.listenerBySelector(\".\" + self.CLASS + \"-search button.\" + self.CLASS + \"-search-btn-info\", function (evt) {\r\n                evt.stopPropagation();\r\n                const target = evt.target;\r\n                if (!target.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    const li = target.parentElement;\r\n                    var parent = li;\r\n                    do {\r\n                        parent = parent.parentElement;\r\n                    }\r\n                    while (parent && parent.tagName !== 'LI');\r\n                    self.showLayerInfo(self.layers.length > 1 ? self.layers.filter(l => l.id === parent.dataset.serviceId)[0] : self.layers[0], li.dataset.layerName);\r\n                    target.classList.add(TC.Consts.classes.CHECKED);\r\n\r\n                } else {\r\n                    target.classList.remove(TC.Consts.classes.CHECKED);\r\n                    self.hideLayerInfo();\r\n                }\r\n            }));\r\n\r\n                        //click en un resultado - añadir capa\r\n            const searchListElementSelector = '.' + self.CLASS + '-search li';\r\n            self.div.addEventListener('click', TC.EventTarget.listenerBySelector(searchListElementSelector, function (evt) {\r\n                evt.stopPropagation();\r\n                var li = evt.target;\r\n                while (li && !li.matches(searchListElementSelector)) {\r\n                    li = li.parentElement;\r\n                }\r\n                if (li.classList.contains(self.CLASS + '-no-results')) {\r\n                    return; //si clicko en el li de \"no hay resultados\" rompo el ciclo de ejecución\r\n                }\r\n                if (li.classList.contains(self.CLASS + '-search-group')) {\r\n                    li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                    return;\r\n                }\r\n                var layerName = li.dataset.layerName;\r\n                if (!layerName) {\r\n                    return;\r\n                }\r\n                layerName = layerName.toString();\r\n\r\n                if (layerName.trim().length === 0) {\r\n                    return;\r\n                }\r\n\r\n                //si la capa ya ha sido anteriormente, no la añadimos y mostramos un mensaje\r\n                if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    return;\r\n                } else {\r\n                    var liParent = li;\r\n                    do {\r\n                        liParent = liParent.parentElement;\r\n                    }\r\n                    while (liParent && !liParent.matches('li.' + self.CLASS + '-search-group'));\r\n\r\n                    const ctlLayer = !liParent ? self.layers[0] : self.layers.filter(l => l.id === liParent.dataset.serviceId)[0];\r\n                    const url = ctlLayer.options.url;\r\n                    const title = ctlLayer.title;\r\n\r\n                    const layer = new TC.layer.Raster({\r\n                        id: self.getUID(),\r\n                        url: url,\r\n                        title: title,\r\n                        hideTitle: ctlLayer.hideTitle || ctlLayer.options.hideTitle,\r\n                        hideTree: false,\r\n                        layerNames: [layerName]\r\n                    });\r\n                    if (layer.isCompatible(self.map.crs)) {\r\n                        self.map.addLayer(layer, function (layer) {\r\n                            li.dataset.layerId = layer.id;\r\n                            layer.wrap.$events.on(TC.Consts.event.TILELOADERROR, function (event) {\r\n                                var layer = this.parent;\r\n                                if (event.error.code === 401 || event.error.code === 403)\r\n                                    layer.map.toast(event.error.text, { type: TC.Consts.msgType.ERROR });\r\n                                layer.map.removeLayer(layer);\r\n                            });\r\n                        });\r\n                        //marcamos el resultado como añadido\r\n                        li.classList.add(TC.Consts.classes.CHECKED);\r\n                        li.querySelector('h5').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                    }\r\n                    else {\r\n                        showProjectionChangeDialog(self, layer);\r\n                    }\r\n                }\r\n            }));\r\n\r\n            self.searchInit = true;\r\n        }\r\n    };\r\n\r\n    const getLayerTree = function (layer) {\r\n        var result = layer.getTree();\r\n        const makeNodeVisible = function makeNodeVisible(node) {\r\n            var childrenVisible = false;\r\n            for (var i = 0; i < node.children.length; i++) {\r\n                if (makeNodeVisible(node.children[i])) {\r\n                    childrenVisible = true;\r\n                }\r\n            }\r\n            if (node.hasOwnProperty('isVisible')) {\r\n                node.isVisible = (!layer.names || !layer.names.length) || childrenVisible || node.isVisible;\r\n            }\r\n            return node.isVisible;\r\n        };\r\n        const expandNode = function (node, level) {\r\n            if (layer.options.expandedNodeLevel > level) {\r\n                node.expanded = true;\r\n                for (var i = 0; i < node.children.length; i++) {\r\n                    expandNode(node.children[i], level + 1);\r\n                }\r\n            }\r\n        }\r\n        makeNodeVisible(result);\r\n        expandNode(result, 0);\r\n        return result;\r\n    };\r\n\r\n    const _refreshResultList = function () {\r\n        const self = this;\r\n\r\n        if (\"createEvent\" in document) {\r\n            var evt = document.createEvent(\"HTMLEvents\");\r\n            evt.initEvent(\"keyup\", false, true);\r\n            if (self.textInput) {\r\n                self.textInput.dispatchEvent(evt);\r\n            }\r\n        }\r\n        else {\r\n            if (self.textInput) {\r\n                self.textInput.fireEvent(\"keyup\");\r\n            }\r\n        }\r\n    };\r\n\r\n    const updateControl = function (layer) {\r\n        const self = this;\r\n\r\n        self.getLayerNodes(layer).forEach(function (node) {\r\n            node.classList.remove(TC.Consts.classes.LOADING);\r\n            node.classList.add(TC.Consts.classes.CHECKED);\r\n            node.querySelector('span').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n        });\r\n        _refreshResultList.call(self);\r\n    };\r\n\r\n    const setCheckedLayersOnNode = function () {\r\n        const self = this;\r\n\r\n        if (self.layersToSetChecked && self.layersToSetChecked.length > 0) {\r\n            self.layersToSetChecked.forEach(function (layer, index, array) {\r\n                if (self.getLayerRootNode(layer)) {\r\n                    updateControl.call(self, layer);\r\n\r\n                    array.splice(index, 1);\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    const addLogicToNode = function (node, layer) {\r\n        const self = this;\r\n\r\n        node.querySelectorAll('li > button.' + self.CLASS + '-collapse-btn').forEach(function (btn) {\r\n            btn.addEventListener('click', onCollapseButtonClick);\r\n        });\r\n\r\n        node.querySelectorAll('span').forEach(function (span) {\r\n            span.addEventListener('click', function (e) {\r\n                onSpanClick(e, self);\r\n            });\r\n        });\r\n\r\n        self._roots = self.div.querySelectorAll(self._selectors.LAYER_ROOT);                \r\n        \r\n        node.dataset.layerId = layer.id;\r\n\r\n        node.querySelectorAll('.' + self.CLASS + '-btn-info').forEach(function (a) {\r\n            const span = a.parentElement.querySelector('span');\r\n            const name = a.parentElement.dataset.layerName;\r\n            if (name) {\r\n                span.classList.add(TC.Consts.classes.SELECTABLE);\r\n                var info = layer.getInfo(name);\r\n                if (!info.hasOwnProperty('abstract') && !info.hasOwnProperty('legend') && !info.hasOwnProperty('metadata')) {\r\n                    a.parentElement.removeChild(a);\r\n                }\r\n                else {                    \r\n                    a.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                        e.stopPropagation();\r\n                        const elm = this;\r\n                        if (elm.classList.toggle(TC.Consts.classes.CHECKED)) {\r\n                            self.showLayerInfo(layer, name);\r\n                        } else {\r\n                            self.hideLayerInfo();\r\n                        }\r\n                    }, { passive: true });\r\n                }\r\n                if (layer.compatibleLayers && layer.compatibleLayers.indexOf(name) < 0) {\r\n                    span.classList.add(TC.Consts.classes.INCOMPATIBLE);\r\n                    span.setAttribute('title', self.getLocaleString('reprojectionNeeded'));\r\n                    //console.log(\"capa \" + name + \" incompatible\");\r\n                }\r\n                if (self.map) {\r\n                    for (var j = 0, len = self.map.workLayers.length; j < len; j++) {\r\n                        var wl = self.map.workLayers[j];\r\n                        if (wl.type === TC.Consts.layerType.WMS && wl.url === layer.url && wl.names.length === 1 && wl.names[0] === name) {\r\n                            span.parentElement.classList.add(TC.Consts.classes.CHECKED);\r\n                            span.dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                a.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    e.stopPropagation();\r\n                    const elm = this;\r\n                    if (elm.classList.toggle(TC.Consts.classes.CHECKED)) {\r\n                        self.showLayerInfo(layer, name, span.innerText);\r\n                    } else {\r\n                        self.hideLayerInfo();\r\n                    }\r\n                }, { passive: true });\r\n            }\r\n        });        \r\n\r\n        setCheckedLayersOnNode.call(self);\r\n\r\n        self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        });\r\n    };\r\n\r\n    ctlProto.renderBranch = function (layer, callback, promiseRenderResolve) {\r\n        const self = this;\r\n\r\n        self.sourceLayers.unshift(layer);\r\n        layer.getCapabilitiesPromise()\r\n            .then(function (result) {\r\n\r\n                self.getRenderedHtml(self.CLASS + '-branch', getLayerTree(this), function (html) {\r\n                    var template = document.createElement('template');\r\n                    template.innerHTML = html;\r\n\r\n                    const branch = self.div.querySelector('.' + self.CLASS + '-branch');\r\n                    var newChild = template.content ? template.content.firstChild : template.firstChild;\r\n                    var oldChild = branch.querySelector('li.' + self.CLASS + '-loading-node[data-layer-id=\"' + this.id + '\"]');\r\n\r\n                    if (oldChild) {\r\n                        branch.replaceChild(newChild, oldChild);\r\n                    } else {\r\n                        branch.insertAdjacentElement('afterbegin', newChild);\r\n                    }\r\n\r\n                    addLogicToNode.call(self, newChild, this);\r\n\r\n                    if (branch.childElementCount === 1) {\r\n                        promiseRenderResolve();\r\n                    }\r\n\r\n                    if (TC.Util.isFunction(callback)) {\r\n                        // pasamos el callback el item \r\n                        callback(self.sourceLayers[self.sourceLayers.map(function (l) { return l && l.id }).indexOf(this.id)]);\r\n                    }\r\n\r\n                }.bind(this));\r\n\r\n            }.bind(layer))\r\n            .catch(function (error) {\r\n                var index = self.layers.map(function (l) { return l.id }).indexOf(this.id);\r\n                self.layers.splice(index, 1);\r\n\r\n                var errorMessage = self.getLocaleString(\"lyrCtlg.errorLoadingNode\", { serviceName: this.title });\r\n                var liError = self.div.querySelector('.' + self.CLASS + '-branch').querySelector('li.' + self.CLASS + '-loading-node[data-layer-id=\"' + this.id + '\"]');\r\n                liError.classList.add('error');\r\n                liError.setAttribute('title', errorMessage);\r\n\r\n                self.map.toast(errorMessage, { type: TC.Consts.msgType.ERROR });\r\n\r\n            }.bind(layer));\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n\r\n        self.sourceLayers = [];\r\n\r\n        return self._set1stRenderPromise(new Promise(function (resolve, reject) {\r\n            if (self.layers.length === 0) {\r\n                self.renderData({ layerTrees: [], enableSearch: false }, function () {\r\n\r\n                    if (TC.Util.isFunction(callback)) {\r\n                        callback();\r\n                    }\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                self.renderData({ layers: self.layers, enableSearch: true }, function () {\r\n\r\n                    createSearchAutocomplete.call(self);\r\n\r\n                    self.layers.forEach(function (layer) {\r\n                        self.renderBranch(layer, callback, resolve);\r\n                    });\r\n                });\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.getLayerRootNode = function (layer) {\r\n        const self = this;\r\n        var result = null;\r\n        if (!layer.isBase) {\r\n            var url = layer.options.url;\r\n            if (self._roots) {\r\n                self._roots.forEach(function (li) {\r\n                    const lyr = self.getLayer(li.dataset.layerId);\r\n                    if (lyr && lyr.type === layer.type && lyr.options.url.toLowerCase() === url.toLowerCase()) {\r\n                        result = li;\r\n                    }\r\n                });\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getLayerNodes = function (layer) {\r\n        const self = this;\r\n        const result = [];\r\n        const rootNode = self.getLayerRootNode(layer);\r\n        if (rootNode) {\r\n            for (var i = 0; i < layer.names.length; i++) {\r\n                const liLayer = rootNode.querySelector('li[data-layer-name=\"' + layer.names[i] + '\"]');\r\n                if (!liLayer) {\r\n                    continue;\r\n                }\r\n                result.push(liLayer);\r\n                liLayer.querySelectorAll('li').forEach(function (li) {\r\n                    result.push(li);\r\n                });\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.showLayerInfo = function (layer, name, title) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var info = self.div.querySelector('.' + self.CLASS + '-info');\r\n\r\n        const toggleInfo = function (layerName, infoObj) {\r\n            var result = false;\r\n            //if (lName !== undefined && lName.toString() === layerName) {\r\n            //    info.dataset.layerName = '';\r\n            //    $info.removeClass(TC.Consts.classes.HIDDEN);\r\n            //}\r\n            //else {\r\n            if (infoObj) {\r\n                result = true;\r\n                info.dataset.layerName = layerName;\r\n                info.classList.remove(TC.Consts.classes.HIDDEN);\r\n                self.getRenderedHtml(self.CLASS + '-info', infoObj)\r\n                    .then(function (out) {\r\n                        info.innerHTML = out;\r\n                        info.querySelector('.' + self.CLASS + '-info-close').addEventListener(TC.Consts.event.CLICK, function () {\r\n                            self.hideLayerInfo();\r\n                        }, { passive: true })\r\n                    })\r\n                    .catch(function (err) {\r\n                        TC.error(err);\r\n                    });\r\n            }\r\n            //}\r\n            return result;\r\n        };\r\n\r\n        self.div.querySelectorAll('.' + self.CLASS + '-btn-info, .' + self.CLASS + '-search-btn-info').forEach(function (btn) {\r\n            btn.classList.remove(TC.Consts.classes.CHECKED);\r\n        });        \r\n\r\n        var fncRecursiva_ = function (layer, title) {\r\n            if (layer.Title === title) {\r\n                return {\r\n                    title:title,\r\n                    abstract: layer.Abstract, metadata: (!layer.MetadataURL ? null : layer.MetadataURL.reduce(function (vi, va) {\r\n                        vi.push({\r\n                            format: va.Format,\r\n                            formatDescription: TC.Util.getLocaleString(self.map.options.locale, TC.Util.getSimpleMimeType(va.Format)) ||\r\n                            TC.Util.getLocaleString(self.map.options.locale, 'viewMetadata'),\r\n                            type: va.type,\r\n                            url: va.OnlineResource\r\n                        });\r\n                        return vi;\r\n                    }, []))\r\n                }\r\n            }\r\n            else if (layer.Layer)\r\n                for (var i = 0; i < layer.Layer.length; i++) {\r\n                    const res = fncRecursiva_(layer.Layer[i], title);\r\n                    if (res) return res;\r\n                }\r\n        };\r\n\r\n        const formatDescriptions = {};\r\n        for (var i = 0, ii = self._roots.length; i < ii; i++) {\r\n            const root = self._roots[i];\r\n            if (root.dataset.layerId === layer.id) {\r\n                const as = root.querySelectorAll('.' + self.CLASS + '-btn-info');\r\n                for (var j = 0, jj = as.length; j < jj; j++) {\r\n                    const a = as[j];\r\n                    var n = a.parentElement.dataset.layerName;\r\n                    if (name && n === name) {\r\n                        const info = layer.getInfo(name);\r\n                        const infoBtn = self.div.querySelector('li [data-layer-name=\"' + n + '\"] > button.' + self.CLASS + '-btn-info');\r\n                        infoBtn.classList.toggle(TC.Consts.classes.CHECKED, toggleInfo(n, info));\r\n                        result = info;\r\n                        break;\r\n                    }\r\n                    const t = a.parentElement.querySelector('span').innerText;\r\n                    if (!name && title && t === title){\r\n                        //buscar en el capapabilities por nombre de capa;\r\n                        const info = fncRecursiva_(layer.capabilities.Capability.Layer, title);\r\n                        //const infoBtn = self.div.querySelector('li [data-layer-name=\"' + n + '\"] > button.' + self.CLASS + '-btn-info');\r\n                        a.classList.toggle(TC.Consts.classes.CHECKED, toggleInfo(t, info));\r\n                        result = info;\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        const self = this;\r\n        self.sourceLayers.forEach(function (layer) {\r\n            layer.getCapabilitiesPromise().then(function () {\r\n                layer.compatibleLayers = layer.wrap.getCompatibleLayers(self.map.crs);\r\n\r\n                const rootNode = self.getLayerRootNode(layer);\r\n                if (rootNode) {\r\n                    rootNode\r\n                        .querySelectorAll('li[data-layer-name]')\r\n                        .forEach(function (li) {\r\n                            const name = li.dataset.layerName;\r\n                            const span = li.querySelector('span.' + TC.Consts.classes.SELECTABLE);\r\n                            if (layer.compatibleLayers.indexOf(name) < 0) {\r\n                                span.classList.add(TC.Consts.classes.INCOMPATIBLE);\r\n                                span.setAttribute('title', self.getLocaleString('reprojectionNeeded'));\r\n                            }\r\n                            else {\r\n                                span.classList.remove(TC.Consts.classes.INCOMPATIBLE)\r\n                                span.removeAttribute('title');\r\n                            }\r\n                        });\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.hideLayerInfo = function () {\r\n        var self = this;\r\n        self.div.querySelectorAll('.' + self.CLASS + '-btn-info, .' + self.CLASS + '-search-btn-info').forEach(function (btn) {\r\n            btn.classList.remove(TC.Consts.classes.CHECKED);\r\n        });\r\n        self.div.querySelector('.' + self.CLASS + '-info').classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    ctlProto.addLayer = function (layer) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var fromLayerCatalog = [];\r\n\r\n            if (self.options.layers && self.options.layers.length) {\r\n                fromLayerCatalog = self.options.layers.filter(function (l) {\r\n                    var getMap = TC.Util.reqGetMapOnCapabilities(l.url);\r\n                    return getMap && getMap.replace(TC.Util.regex.PROTOCOL) == layer.url.replace(TC.Util.regex.PROTOCOL);\r\n                });\r\n            }\r\n\r\n            if (fromLayerCatalog.length == 0)\r\n                fromLayerCatalog = self.layers.filter(function (l) {\r\n                    return l.url.replace(TC.Util.regex.PROTOCOL) == layer.url.replace(TC.Util.regex.PROTOCOL);\r\n                });\r\n\r\n            if (fromLayerCatalog.length == 0) {\r\n                self.layers.unshift(layer);\r\n                layer.getCapabilitiesPromise().then(function () {\r\n                    layer.compatibleLayers = layer.wrap.getCompatibleLayers(self.map.crs);\r\n                    layer.title = layer.title || layer.wrap.getServiceTitle();\r\n                    self.renderBranch(layer, function () {\r\n                        resolve(); //ver linea 55 y por ahí\r\n                    });\r\n                });\r\n            } else { resolve(); }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayer = function (id) {\r\n        const self = this;\r\n        for (var i = 0, len = self.layers.length; i < len; i++) {\r\n            const layer = self.layers[i];\r\n            if (layer.id === id) {\r\n                // 10/04/2019 GLS: validamos si es una capa que viene de configuración o es un WMS externo o por estado \r\n                // para decidir si mostramos el título del servicio o no\r\n                var configLayer = self.options.layers.filter(l => l.id === id);\r\n\r\n                if (configLayer.length > 0) {\r\n                    layer.hideTitle = layer.options.hideTitle = configLayer[0].hideTitle;\r\n                } else {\r\n                    layer.hideTitle = layer.options.hideTitle = false;\r\n                }                \r\n                \r\n                return layer;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.addLayerToMap = function (layer, layerName) {\r\n        const self = this;\r\n        const layerOptions = TC.Util.extend({}, layer.options);\r\n        layerOptions.id = self.getUID();\r\n        layerOptions.layerNames = [layerName];\r\n        layerOptions.title = layer.title;\r\n        layerOptions.hideTree = true;\r\n        const newLayer = new TC.layer.Raster(layerOptions);\r\n        if (newLayer.isCompatible(self.map.crs)) {\r\n            self.map.addLayer(layerOptions);\r\n        }\r\n        else {\r\n            showProjectionChangeDialog(self, newLayer);\r\n        }\r\n    };\r\n\r\n    ctlProto.loaded = function () {\r\n        return this._readyPromise;\r\n    };\r\n\r\n    ctlProto.getAvailableCRS = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        return self.map.getCompatibleCRS({\r\n            layers: self.map.workLayers.concat(self.map.baseLayer, options.layer),\r\n            includeFallbacks: true\r\n        });\r\n    };\r\n\r\n    ctlProto.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        TC.loadProjDef({\r\n            crs: options.crs,\r\n            callback: function () {\r\n                self.map.setProjection(options).then(function () {\r\n                    if (self._layerToAdd) {\r\n                        self.map.addLayer(self._layerToAdd);\r\n                    }\r\n                    TC.Util.closeModal();\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.showProjectionChangeDialog = function (options) {\r\n        const self = this;\r\n        self._layerToAdd = options.layer;\r\n        TC.control.ProjectionSelector.prototype.showProjectionChangeDialog.call(self, options);\r\n    };\r\n\r\n})();"]}