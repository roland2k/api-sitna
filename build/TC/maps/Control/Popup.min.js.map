{"version":3,"sources":["control/Popup.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","Consts","event","POPUP","POPUPHIDE","classes","DRAG","DRAGGED","DRAGGABLE","Popup","apply","this","arguments","currentFeature","wrap","inherit","ctlProto","prototype","CLASS","template","1","container","depth0","helpers","partials","data","3","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","escapeExpression","nullContext","name","hash","loc","start","line","column","end","5","compiler","main","stack1","alias1","fn","program","inverse","noop","useData","render","callback","self","_set1stRenderPromise","Promise","resolve","reject","renderData","closeButton","options","undefined","shareButton","share","then","popupDiv","div","querySelector","contentDiv","menuDiv","addUIEventListeners","map","addPopup","Util","isFunction","catch","err","Error","register","result","all","renderPromise","on","VIEWCHANGE","view","PRINTING","isVisible","hide","LAYERVISIBILITY","e","layer","getVisibility","LAYERREMOVE","FEATURESCLEAR","UPDATE","_visibilityState","visibility","NOT_VISIBLE","FEATUREREMOVE","feature","closeBtn","addEventListener","CLICK","passive","shareBtn","caller","showShareDialog","fitToView","delayed","setTimeout","hidePopup","getContainerElement","innerHTML","setDragged","trigger","getMenuElement","dragged","classList","toggle","setDragging","dragging","add","remove","contains","VISIBLE"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.Consts.event.POPUP = TC.Consts.event.POPUP || 'popup.tc';\r\nTC.Consts.event.POPUPHIDE = TC.Consts.event.POPUPHIDE || 'popuphide.tc';\r\nTC.Consts.classes.DRAG = TC.Consts.classes.DRAG || 'tc-drag';\r\nTC.Consts.classes.DRAGGED = TC.Consts.classes.DRAGGED || 'tc-dragged';\r\nTC.Consts.classes.DRAGGABLE = TC.Consts.classes.DRAGGABLE || 'tc-draggable';\r\n\r\nTC.control.Popup = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n    self.currentFeature = null;\r\n    //self.wrap = { popup: null };    \r\n    self.wrap = new TC.wrap.control.Popup(self);\r\n};\r\n\r\nTC.inherit(TC.control.Popup, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Popup.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-popup';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-popup.hbs\";\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self._set1stRenderPromise(new Promise(function (resolve, reject) {\r\n            TC.Control.prototype.renderData.call(self, {\r\n                closeButton: self.options.closeButton || self.options.closeButton === undefined,\r\n                shareButton: self.options.share\r\n            })\r\n                .then(function addPopup() {\r\n                    self.popupDiv = self.div.querySelector(`.${ctlProto.CLASS}`);\r\n                    self.contentDiv = self.popupDiv.querySelector(`.${ctlProto.CLASS}-content`);\r\n                    self.menuDiv = self.popupDiv.querySelector(`.${ctlProto.CLASS}-menu`);\r\n                    self.addUIEventListeners();\r\n\r\n                    self.map.wrap.addPopup(self).then(function endRender() {\r\n                        if (TC.Util.isFunction(callback)) {\r\n                            callback();\r\n                        }\r\n                        resolve();\r\n                    });\r\n                })\r\n                .catch(err => reject(err instanceof Error ? err : Error(err)));\r\n        }));\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n        return new Promise(function (resolve, reject) {\r\n            Promise.all([result, self.renderPromise()]).then(function () {\r\n                map.on(TC.Consts.event.VIEWCHANGE, function () {\r\n                    if (map.view === TC.Consts.view.PRINTING) {\r\n                        if (self.isVisible()) {\r\n                            self.hide();\r\n                        }\r\n                    }\r\n                });\r\n\r\n                map.on(TC.Consts.event.LAYERVISIBILITY, function (e) {\r\n                    if (self.currentFeature && self.currentFeature.layer === e.layer && !e.layer.getVisibility()) {\r\n                        if (self.isVisible()) {\r\n                            self.hide();\r\n                        }\r\n                    }\r\n                });\r\n\r\n                map.on(TC.Consts.event.LAYERREMOVE + ' ' + TC.Consts.event.FEATURESCLEAR, function (e) {\r\n                    if (self.currentFeature && self.currentFeature.layer === e.layer) {\r\n                        if (self.isVisible()) {\r\n                            self.hide();\r\n                        }\r\n                    }\r\n                });\r\n\r\n                map.on(TC.Consts.event.UPDATE, function () {\r\n                    if (!self.currentFeature || self.currentFeature._visibilityState === TC.Consts.visibility.NOT_VISIBLE) {\r\n                        if (self.isVisible()) {\r\n                            self.hide();\r\n                        }\r\n                    }\r\n                });\r\n\r\n                map.on(TC.Consts.event.FEATUREREMOVE, function (e) {\r\n                    if (self.currentFeature === e.feature) {\r\n                        if (self.isVisible()) {\r\n                            self.hide();\r\n                        }\r\n                    }\r\n                });\r\n\r\n                /*\r\n                    GLS: Controlamos el ancla del popup cuando hay zoom in/out de pantalla o navegador, debería hacerlo OL pero no lo gestiona.\r\n                    No funciona, sólo salta la primera vez, paso a sobrescribir el método de OL\r\n                 */\r\n                //var config = { attributes: true, attributeFilter: ['style', 'class'], childList: false, subtree: false };\r\n                //var observer = new MutationObserver(function (mutationsList, observer) {\r\n                //    //var positionMutation = mutationsList.filter(function (mutation) {\r\n                //    //    return mutation.type === \"attributes\"\r\n                //    //}).filter(function (mutation) {\r\n                //    //    return ['top', 'right', 'bottom', 'left', 'style'].indexOf(mutation.attributeName) > -1;\r\n                //    //});\r\n\r\n                //    if (mutationsList.length > 0) {\r\n                //        // me desconecto para no entrar en un bucle infinito\r\n                //        //observer.disconnect();\r\n\r\n                //        var top = mutationsList[0].target[mutationsList[0].attributeName].top;\r\n                //        var right = mutationsList[0].target[mutationsList[0].attributeName].right;\r\n                //        var bottom = mutationsList[0].target[mutationsList[0].attributeName].bottom;\r\n                //        var left = mutationsList[0].target[mutationsList[0].attributeName].left;\r\n\r\n                //        [{ top: top }, { right: right }, { bottom: bottom }, { left: left }].forEach(function (elm) {\r\n                //            var key = Object.keys(elm)[0];\r\n                //            if (elm[key].length > 0) {\r\n                //                document.querySelector('.ol-overlay-container').style[key] = parseFloat(elm[key].replace('px', '')) / window.devicePixelRatio + 'px';\r\n                //            }\r\n                //        });\r\n\r\n                //        // volvemos a observar\r\n                //        //observer.observe(document.querySelector('.ol-overlay-container'), config);\r\n                //    }\r\n                //});\r\n                //observer.observe(document.querySelector('.ol-overlay-container'), config);\r\n\r\n                resolve(self);\r\n            }).catch(function (err) {\r\n                reject(err instanceof Error ? err : Error(err));\r\n            });\r\n        })\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n        const closeBtn = self.menuDiv.querySelector(`.${self.CLASS}-close`)\r\n        if (closeBtn) {\r\n            closeBtn.addEventListener(TC.Consts.event.CLICK, function () {\r\n                self.hide();\r\n            }, { passive: true });\r\n        }\r\n        const shareBtn = self.menuDiv.querySelector(`.${self.CLASS}-share`)\r\n        if (shareBtn) {\r\n            shareBtn.addEventListener(TC.Consts.event.CLICK, function () {\r\n                if (self.caller) {\r\n                    self.caller.showShareDialog();\r\n                }\r\n            }, { passive: true });\r\n        }\r\n    };\r\n\r\n    ctlProto.fitToView = function (delayed) {\r\n        var self = this;\r\n        if (delayed) {\r\n            setTimeout(function () {\r\n                self.wrap.fitToView();\r\n            }, 1000);\r\n        }\r\n        else {\r\n            self.wrap.fitToView();\r\n        }\r\n    };\r\n\r\n    ctlProto.hide = function () {\r\n        var self = this;\r\n        if (self.map) {\r\n            const data = {\r\n                control: self,\r\n                feature: self.currentFeature\r\n            };\r\n            self.map.wrap.hidePopup(self);\r\n            self.getContainerElement().innerHTML = '';\r\n            self.setDragged(false);\r\n            self.map.trigger(TC.Consts.event.POPUPHIDE, data);\r\n        }\r\n    };\r\n\r\n    ctlProto.getContainerElement = function () {\r\n        return this.contentDiv || null;\r\n    };\r\n\r\n    ctlProto.getMenuElement = function () {\r\n        return this.menuDiv || null;\r\n    };\r\n\r\n    ctlProto.setDragged = function (dragged) {\r\n        const self = this;\r\n        self.dragged = dragged;\r\n        if (self.popupDiv) {\r\n            self.popupDiv.classList.toggle(TC.Consts.classes.DRAGGED, !!dragged);\r\n        }\r\n        self.wrap.setDragged(dragged);\r\n    };\r\n\r\n    ctlProto.setDragging = function (dragging) {\r\n        const self = this;\r\n        if (dragging) {\r\n            self.setDragged(true);\r\n            self.popupDiv.classList.add(TC.Consts.classes.DRAG);\r\n        }\r\n        else {\r\n            self.popupDiv.classList.remove(TC.Consts.classes.DRAG);\r\n        }\r\n    };\r\n\r\n    ctlProto.isVisible = function () {\r\n        const self = this;\r\n\r\n        return self.popupDiv && self.popupDiv.classList.contains(TC.Consts.classes.VISIBLE);\r\n    };\r\n\r\n})();"]}