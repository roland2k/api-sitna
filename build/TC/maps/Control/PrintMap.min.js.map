{"version":3,"sources":["control/PrintMap.js"],"names":["TC","control","MapInfo","syncLoadJS","apiLocation","PrintMap","Control","apply","this","arguments","inherit","ctlProto","prototype","CLASS","ORIENTATION","PAGE_SIZE","a4_portrait","logoWidth","logoHeight","layoutPDF","pageSize","width","height","pageMargins","content","columns","image","margin","text","alignment","table","widths","body","layout","paddingLeft","i","node","paddingRight","paddingTop","paddingBottom","reset","a4_landscape","a3_portrait","a3_landscape","getLayout","orientation","format","getLogoColumn","getScaleBarColumn","options","sideLength","template","compiler","main","container","depth0","helpers","partials","data","alias1","nullContext","alias2","escapeExpression","alias3","lambda","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","name","hash","loc","start","line","column","end","useData","hasLegend","map","workLayers","some","layer","type","Consts","layerType","WMS","getVisibility","register","self","result","mustBeExportable","manageLegendOnZoom","toString","toUpperCase","div","addEventListener","EventTarget","listenerBySelector","setView","view","PRINTING","codeContainer","document","querySelector","cb","id","disabled","checked","createElement","classList","add","appendChild","innerHTML","makeQRCode","printBtnSelector","on","event","STARTLOADING","printBtn","STOPLOADING","remove","ZOOM","updateCanvas","printFormat","bounding","getBoundingClientRect","Number","isInteger","style","Math","round","toast","getLocaleString","msgType","INFO","duration","wrap","updateSize","resetPrinting","off","toastHide","currentFormat","removeProperty","DEFAULT","_viewDiv","classes","HIDDEN","Util","getDiv","getRenderedHtml","html","insertAdjacentHTML","createPdf","bind","value","evt","generateLink","registeredListeners","registerListeners","render","callback","renderData","controlId","loadingCtrl","getControlsByClass","LoadingIndicator","hasWait","addWait","loadJS","window","pdfMake","url","PDFMAKE","olViewport","querySelectorAll","len","length","elm","parentElement","contains","canvas","printLayout","createPDF","filename","location","host","title","trim","getFormattedDate","Date","download","replace","error","ERROR","message","stack","msgErrorMode","EMAIL","removeWait","imageErrorHandling","imageUrl","getLegend","layers","filter","legendByGroup","_process","parentLayer","treeLevel","isVisibleByScale","src","srcBase64","params","base64LegendSrc","legend","push","level","_traverse","o","func","Array","isArray","children","header","forEach","hideTree","tree","getTree","Promise","resolve","reject","all","imagePromises","j","k","l","tool","Proxification","proxify","allowedMixedContent","fetchImage","exportable","then","img","complete","imageDetail","imgTagToDataUrl","base64","_getLegendImages","group","index","groupIndex","item","reduce","prev","current","vector","sort","a","b","groupWithHeight","rows","colSpan","fontSize","headerRows","concat","toLowerCase","headerItem","itemIndex","position","indexOf","imageWidth","imageHeight","splice","dontBreakRows","keepWithHeaderRows","getGroupTable","basics","onLogoError","logoColumn","logo","imgToDataUrl","dataUrl","calculateAspectRatioFit","titleColumn","getTitleColumn","onError","scaleBarColumn","scaleCtrl","ScaleBar","elem","getElementsByClassName","styling","getComputedStyle","leftBorder","parseInt","getPropertyValue","rightBorder","border","getText","qrTarget","qrCodeBase64","addToCanvas","x","y","mapCanvas","fn","basicsDone","mapPlace","getMap","toDataURL","names","pageBreak","pageOrientation","manageMaxLengthExceed","maxLengthExceed","alertElm","checkboxQR","qr","toggle","async","checkbox","label","LOADING"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapInfo) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapInfo');\r\n}\r\n\r\nTC.control.PrintMap = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.PrintMap, TC.control.MapInfo);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.PrintMap.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-prnmap';\r\n\r\n    const ORIENTATION = {\r\n        PORTRAIT: 'portrait',\r\n        LANDSCAPE: 'landscape'\r\n    };\r\n    const PAGE_SIZE = {\r\n        A4: 'A4',\r\n        A3: 'A3'\r\n    };\r\n\r\n    /*\r\n        GLS:\r\n        La librería makePDF se basa en la librería PDFKit explicación sobre la unidad de medida que usa:\r\n        PDF points (72 per inch)\r\n        https://stackoverflow.com/questions/51540144/pdfkit-node-js-measurement-unit\r\n        https://www.ninjaunits.com/converters/pixels/points-pixels/\r\n        https://www.ninjaunits.com/converters/pixels/pixels-points/\r\n\r\n        La clave es mantener las dimensiones del mapa en px enteros (canvas sólo admite px enteros), ajustando el layout que está en puntos y que sí admite decimales\r\n    */\r\n\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-prnmap-portrait-a4 indicando el valor en px la sección del mapa   */\r\n    var a4_portrait = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 595,\r\n                height: 842\r\n            },\r\n            pageMargins: [29.5, 14, 29.5, 22.5],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0]\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 534,\r\n                                height: 775.5\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0]\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 534,\r\n                                height: 775.5\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-prnmap-landscape-a4 indicando el valor en px la sección del mapa   */\r\n    var a4_landscape = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 842,\r\n                height: 595\r\n            },\r\n            pageMargins: [30, 14, 30, 22],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 528\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 528\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-prnmap-portrait-a3 indicando el valor en px la sección del mapa   */\r\n    var a3_portrait = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 841.89,\r\n                height: 1190.55\r\n            },\r\n            pageMargins: [29.954, 14, 29.954, 21.55],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            margin: [0, 10, 0, 0],\r\n                            alignment: 'center'\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 1125\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            margin: [0, 10, 0, 0],\r\n                            alignment: 'center'\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 1125\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-prnmap-landscape-a3 indicando el valor en px la sección del mapa   */\r\n    var a3_landscape = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 1190.55,\r\n                height: 841.89\r\n            },\r\n            pageMargins: [28.775, 14, 28.775, 14.89],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 1131,\r\n                                height: 783\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 1131,\r\n                                height: 783\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n\r\n    const getLayout = function (orientation, format) {\r\n        switch (orientation) {\r\n            case ORIENTATION.PORTRAIT: {\r\n                switch (format) {\r\n                    case PAGE_SIZE.A4: {\r\n                        return a4_portrait;\r\n                    }\r\n                    case PAGE_SIZE.A3: {\r\n                        return a3_portrait;\r\n                    }\r\n                    default:\r\n                }\r\n                break;\r\n            }\r\n            case ORIENTATION.LANDSCAPE: {\r\n                switch (format) {\r\n                    case PAGE_SIZE.A4: {\r\n                        return a4_landscape;\r\n                    }\r\n                    case PAGE_SIZE.A3: {\r\n                        return a3_landscape;\r\n                    }\r\n                    default:\r\n                }\r\n                break;\r\n            }\r\n            default:\r\n                return a4_portrait;\r\n        }\r\n    };\r\n\r\n    const getLogoColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[0];\r\n    };\r\n    const getTitleColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[1];\r\n    };\r\n    const getScaleBarColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[2];\r\n    };\r\n    const getMap = function (layout) {\r\n        return layout.layoutPDF.content[1].table.body[0][0];\r\n    };\r\n\r\n    const options = {\r\n        qrCode: {\r\n            sideLength: 85\r\n        }\r\n    };\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-prnmap.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-view'] = TC.apiLocation + \"TC/templates/tc-ctl-prnmap-view.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-tools'] = TC.apiLocation + \"TC/templates/tc-ctl-prnmap-tools.hbs\";\r\n\r\n    const hasLegend = function () {\r\n        const self = this;\r\n\r\n        return self.map.workLayers.some(function (layer) {\r\n            return layer.type === TC.Consts.layerType.WMS && layer.getVisibility();\r\n        });\r\n    };\r\n\r\n    const hasLegendToPrint = function () {\r\n        const self = this;\r\n\r\n        return self.map.workLayers.some(function (layer) {\r\n            if (layer.type === TC.Consts.layerType.WMS && layer.getVisibility()) {\r\n                for (var i = 0; i < layer.names.length; i++) {\r\n                    if (layer.isVisibleByScale(layer.names[i])) {\r\n                        return true;\r\n                    }\r\n                }\r\n\r\n                return false;\r\n            }\r\n\r\n            return false;\r\n        });\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.MapInfo.prototype.register.call(self, map);\r\n\r\n        // GLS: Añado el flag al mapa para tenerlo en cuenta cuando se establece la función de carga de imágenes\r\n        self.map.mustBeExportable = true;\r\n\r\n        const manageLegendOnZoom = function () {\r\n            var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n            layout.reset();\r\n        };\r\n\r\n        const print = function () {\r\n\r\n            self.map.setView(TC.Consts.view.PRINTING);\r\n\r\n            var codeContainer = document.querySelector('.' + self.CLASS + '-qrcode');\r\n            const cb = document.querySelector(`#${self.CLASS}-image-qr-${self.id}`);\r\n            if (!cb.disabled && cb.checked) {\r\n                if (!codeContainer) {\r\n                    codeContainer = document.createElement('div');\r\n                    codeContainer.classList.add(self.CLASS + '-qrcode');\r\n                    self.map.div.appendChild(codeContainer);\r\n                }\r\n\r\n                codeContainer.innerHTML = '';\r\n                self.makeQRCode(codeContainer, options.qrCode.sideLength, options.qrCode.sideLength);\r\n            } else {\r\n                if (codeContainer) {\r\n                    codeContainer.innerHTML = '';\r\n                }\r\n            }\r\n\r\n            const printBtnSelector = '.' + self.CLASS + '-btn';\r\n            self.map.on(TC.Consts.event.STARTLOADING, function () {\r\n                const printBtn = self.div.querySelector(printBtnSelector);\r\n                printBtn.classList.add('disabled');\r\n                printBtn.disabled = true;\r\n            });\r\n\r\n            self.map.on(TC.Consts.event.STOPLOADING, function () {\r\n                const printBtn = self.div.querySelector(printBtnSelector);\r\n                printBtn.classList.remove('disabled');\r\n                printBtn.disabled = false;\r\n            });\r\n\r\n            if (hasLegend.call(self)) {\r\n                // GLS: controlamos si una capa deja de verse por la escala para resetear la leyenda                \r\n                self.map.on(TC.Consts.event.ZOOM, manageLegendOnZoom);\r\n            }\r\n\r\n            const updateCanvas = function (printFormat) {\r\n                if (printFormat) {\r\n                    self.map.div.classList.add(printFormat);\r\n                    /**\r\n                     * Validamos que el resultado en pixels sean valores enteros, si no lo son, redondeamos y establecemos evitando estiramiento del canvas /\r\n                     */\r\n                    var bounding = self.map.div.getBoundingClientRect();\r\n                    if (!Number.isInteger(bounding.width)) {\r\n                        self.map.div.style.width = Math.round(bounding.width) + 'px';\r\n                    }\r\n                    if (!Number.isInteger(bounding.height)) {\r\n                        self.map.div.style.height = Math.round(bounding.height) + 'px';\r\n                    }\r\n\r\n                    self.map.toast(self.getLocaleString('print.advice.title') + ': ' + self.getLocaleString('print.advice.desc'), { type: TC.Consts.msgType.INFO, duration: 7000 });\r\n                }\r\n\r\n                self.map.wrap.map.updateSize();\r\n            };\r\n\r\n            const resetPrinting = function () {\r\n\r\n                var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n                layout.reset();\r\n\r\n                if (hasLegend.call(self)) {\r\n                    self.map.off(TC.Consts.event.ZOOM, manageLegendOnZoom);\r\n                }\r\n\r\n                self.map.toastHide(self.getLocaleString('print.advice.title') + ': ' + self.getLocaleString('print.advice.desc'));\r\n\r\n                self.map.div.classList.remove(self.currentFormat, self.CLASS + '-printing');\r\n\r\n                self.map.div.style.removeProperty('width');\r\n                self.map.div.style.removeProperty('height');\r\n\r\n                updateCanvas();\r\n\r\n                self.map.setView(TC.Consts.view.DEFAULT);\r\n\r\n                self._viewDiv.classList.add(TC.Consts.classes.HIDDEN);\r\n            };\r\n\r\n            if (!self._viewDiv) {\r\n                self._viewDiv = TC.Util.getDiv();\r\n                document.body.appendChild(self._viewDiv);\r\n\r\n                self.getRenderedHtml(self.CLASS + '-view', null, function (html) {\r\n                    self._viewDiv.innerHTML = html;\r\n                });\r\n\r\n                self.getRenderedHtml(self.CLASS + '-tools', null, function (html) {\r\n                    self.map.div.insertAdjacentHTML('beforeend', html);\r\n\r\n                    self.map.div.querySelector('.' + self.CLASS + '-btn-close').addEventListener('click', resetPrinting);\r\n\r\n                    self.map.div.querySelector('.' + self.CLASS + '-btn-pdf').addEventListener('click', self.createPdf.bind(self));\r\n                });\r\n            }\r\n\r\n            self.orientation = self.div.querySelector(\"#print-design\").value;\r\n            self.format = self.div.querySelector(\"#print-size\").value;\r\n\r\n            self.currentFormat = self.CLASS + '-' + self.orientation + '-' + self.format;\r\n\r\n            self._viewDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n            self.map.div.classList.add(self.CLASS + \"-printing\");\r\n            updateCanvas(self.currentFormat);\r\n        };\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn', print));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector(`#${self.CLASS}-image-qr-${self.id}`, function (evt) {\r\n            self.generateLink();\r\n        }));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('h2', function (evt) {\r\n            if (!self.registeredListeners) {\r\n                self.generateLink();\r\n            }\r\n            self.registerListeners();\r\n        }));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return TC.Control.prototype.renderData.call(self, { controlId: self.id }, callback);\r\n    };\r\n\r\n    ctlProto.createPdf = function () {\r\n        var self = this;\r\n\r\n        var loadingCtrl = self.map.getControlsByClass(TC.control.LoadingIndicator)[0];\r\n        var hasWait = loadingCtrl.addWait();\r\n\r\n        TC.loadJS(!window.pdfMake, [TC.Consts.url.PDFMAKE], function () {\r\n            const olViewport = self.map.div.querySelectorAll('.ol-viewport');\r\n            for (var i = 0, len = olViewport.length; i < len; i++) {\r\n                const elm = olViewport[i];\r\n                if (!elm.parentElement.classList.contains('ol-overviewmap-map')) {\r\n                    self.canvas = elm.querySelector('canvas');\r\n                    break;\r\n                }\r\n            }\r\n\r\n            var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n            var printLayout = layout.layoutPDF;\r\n\r\n            const createPDF = function (printLayout) {\r\n                var filename = window.location.host + '_';\r\n                var title = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n\r\n                if (title) {\r\n                    filename += title;\r\n                } else {\r\n                    var currentDate = TC.Util.getFormattedDate(new Date().toString(), true);\r\n                    filename += currentDate;\r\n                }\r\n\r\n                try {\r\n                    pdfMake.createPdf(printLayout).download(filename.replace(/[\\\\\\/:*?\"<>\\|]/g, \"\") + '.pdf');\r\n                } catch (error) {\r\n                    self.map.toast(self.getLocaleString('print.error'), { type: TC.Consts.msgType.ERROR });\r\n                    TC.error(error.message + '  ' + error.stack, TC.Consts.msgErrorMode.EMAIL);\r\n                }\r\n\r\n                loadingCtrl.removeWait(hasWait);\r\n            };\r\n\r\n            const imageErrorHandling = function (imageUrl) {\r\n                TC.error(self.getLocaleString('print.error'));\r\n                TC.error('No se ha podido generar el base64 correspondiente a la imagen: ' + imageUrl, TC.Consts.msgErrorMode.EMAIL, 'Error en la impresión'); //Correo de error\r\n            };\r\n\r\n            const getLogo = function () {\r\n\r\n                const onLogoError = function () {\r\n                    var logoColumn = getLogoColumn(layout);\r\n                    delete logoColumn.image;\r\n                    logoColumn.text = \"\";\r\n                    return logoColumn;\r\n                };\r\n\r\n                if (self.options.logo) {\r\n                    return TC.Util.imgToDataUrl(self.options.logo).then(function (result) {\r\n                        const canvas = result.canvas;\r\n                        const dataUrl = result.dataUrl;\r\n                        var size = TC.Util.calculateAspectRatioFit(canvas.width, canvas.height, layout.logoWidth, layout.logoHeight);\r\n\r\n                        var logoColumn = getLogoColumn(layout);\r\n                        //URI: si no se define la anchura en el layout calcula la anchura en función de proporción entre ancho y alto de la imagen y el alto de su posición en el PDF\r\n                        if (!logoColumn.width)\r\n                            logoColumn.width = (canvas.width / canvas.height) * logoColumn.height;\r\n                        logoColumn.image = dataUrl;\r\n                        return logoColumn;\r\n\r\n                    }, function () {\r\n                        imageErrorHandling(self.options.logo);\r\n\r\n                        return onLogoError();\r\n                    });\r\n                } else {\r\n                    return onLogoError();\r\n                }\r\n            };\r\n            const getScaleBar = function () {\r\n                const onError = function () {\r\n                    var scaleBarColumn = getScaleBarColumn(layout);\r\n                    delete scaleBarColumn.image;\r\n                    scaleBarColumn.text = \"\";\r\n                    scaleBarColumn.width = \"auto\";\r\n                    return scaleBarColumn;\r\n                };\r\n\r\n                var scaleCtrl = self.map.getControlsByClass(TC.control.ScaleBar)[0];\r\n                if (scaleCtrl) {\r\n                    var elem = document.getElementsByClassName(\"ol-scale-line-inner\"); // no cogemos el DIV del control ya que contiene los bordes y suman al ancho total\r\n                    var bounding = elem[0].getBoundingClientRect();\r\n                    if (bounding) {\r\n                        var styling = getComputedStyle(elem[0], null);\r\n                        var leftBorder = parseInt(styling.getPropertyValue('border-left-width').replace('px', '')) || 0;\r\n                        var rightBorder = parseInt(styling.getPropertyValue('border-right-width').replace('px', '')) || 0;\r\n\r\n                        var scaleBarColumn = getScaleBarColumn(layout);\r\n\r\n                        scaleBarColumn.table = {\r\n                            widths: [((bounding.width > bounding.height ? bounding.width : bounding.height) - leftBorder - rightBorder) * 0.75], // lo pasamos a pt\r\n                            body: [\r\n                                [{ border: [true, false, true, true], text: scaleCtrl.getText(), fontSize: 10, alignment: 'center' }]\r\n                            ]\r\n                        };\r\n\r\n                        scaleBarColumn.layout = {\r\n                            paddingLeft: function (i, node) { return 0; },\r\n                            paddingRight: function (i, node) { return 0; },\r\n                            paddingTop: function (i, node) { return 0; },\r\n                            paddingBottom: function (i, node) { return 0; }\r\n                        };\r\n\r\n                        return scaleBarColumn;\r\n                    } else {\r\n                        return onError();\r\n                    }\r\n                } else {\r\n                    return onError();\r\n                }\r\n            };\r\n            const getLegend = function () {\r\n                var content = [];\r\n                var layers = self.map.workLayers.filter(function (layer) {\r\n                    return layer.type === TC.Consts.layerType.WMS && layer.getVisibility();\r\n                });\r\n                var legendByGroup = [];\r\n                var indentationIncrement = 7;\r\n\r\n                var _process = function (value, parentLayer, treeLevel) {\r\n                    if (parentLayer.isVisibleByScale(value.name)) { //Si la capa es visible, la mostramos en la leyenda\r\n                        var src,\r\n                            srcBase64;\r\n\r\n                        //Para las capas cargadas por POST (por ejemplo la búsquedas de Comercio Pamplona)\r\n                        if (parentLayer.options && parentLayer.options.params && parentLayer.options.params.base64LegendSrc) {\r\n                            srcBase64 = parentLayer.options.params.base64LegendSrc;\r\n                        }\r\n                        else if (value.legend) {\r\n                            src = value.legend.src;\r\n                        }\r\n\r\n                        result.push({ src: src, title: value.title, level: treeLevel, srcBase64: srcBase64 });\r\n                    }\r\n                };\r\n                var _traverse = function (o, func, parentLayer, treeLevel) {\r\n                    if (Array.isArray(o)) {\r\n                        for (var i = 0; i < o.length; i++) {\r\n                            _traverse(o[i], func, parentLayer, treeLevel);\r\n                        }\r\n                    } else {\r\n                        if (o && o.hasOwnProperty('children') && o.children.length > 0) {\r\n                            if (o.title && o.name) {\r\n                                result.push({ header: o.title, level: treeLevel });\r\n                            }\r\n                            _traverse(o.children, func, parentLayer, ++treeLevel);\r\n                        }\r\n                    }\r\n\r\n                    if (o && o.hasOwnProperty('children') && o.children.length == 0) {\r\n                        func.apply(this, [o, parentLayer, treeLevel]);\r\n                        treeLevel--;\r\n                    }\r\n                };\r\n                var _getLegendImages = function () {\r\n                    var imagePromises = [];\r\n\r\n                    for (var i = 0; i < legendByGroup.length; i++) {\r\n                        var layers = legendByGroup[i].layers;\r\n\r\n                        for (var j = 0; j < layers.length; j++) {\r\n                            (function (k, l) {\r\n                                var layer = legendByGroup[k].layers[l];\r\n                                var src = layer.src || layer.srcBase64;\r\n\r\n                                if (src) {\r\n\r\n                                    if (!TC.tool || !TC.tool.Proxification) {\r\n                                        TC.syncLoadJS(TC.apiLocation + 'TC/tool/Proxification');\r\n                                    }\r\n\r\n                                    imagePromises.push(new Promise(function (resolve, reject) {\r\n                                        var toolProxification = new TC.tool.Proxification(TC.proxify, { allowedMixedContent: true });\r\n                                        toolProxification.fetchImage(src, { exportable: true }).then(function (img) {\r\n                                            if (img.complete) {\r\n                                                var imageDetail = TC.Util.imgTagToDataUrl(img, 'image/png');\r\n                                                layer.image = { base64: imageDetail.base64, canvas: imageDetail.canvas };\r\n                                            } else {\r\n                                                imageErrorHandling(src);\r\n                                            }\r\n\r\n                                            resolve();\r\n\r\n                                        }, function (error) {\r\n                                            imageErrorHandling(src);\r\n                                            reject(error);\r\n                                        });\r\n                                    }));\r\n                                }\r\n                            })(i, j);\r\n                        }\r\n                    }\r\n\r\n                    return imagePromises;\r\n                };\r\n\r\n                layers.forEach(function (layer) {\r\n                    result = [];\r\n\r\n                    var hideTree = layer.options.hideTree;\r\n\r\n                    layer.tree = null;\r\n                    layer.options.hideTree = true;\r\n\r\n                    _traverse(layer.getTree(), _process, layer, 0);\r\n\r\n                    layer.options.hideTree = hideTree;\r\n\r\n                    if (result.length > 0) {\r\n                        legendByGroup.push({ title: layer.title, layers: result });\r\n                    }\r\n                });\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    Promise.all(_getLegendImages()).then(function () {\r\n\r\n                        const getGroupTable = function (group, index) {                            \r\n                            var rows = [[{ text: group.title, colSpan: 2, alignment: 'left', fontSize: 11, margin: [0, index > 0 ? 10 : 0, 0, 5] }, {}]];\r\n                            var indentation = 10;\r\n\r\n                            rows = rows.concat(group.layers.filter(function (item) {\r\n                                return item.hasOwnProperty('header') && item.header.trim().toLowerCase() !== group.title.trim().toLowerCase();\r\n                            }).map(function (item) {\r\n                                return [{ text: item.header.trim(), colSpan: 2, alignment: 'left', margin: [indentation * item.level, 0, 0, 3] }, {}];\r\n                            }));\r\n\r\n                            const headerRows = rows.length;\r\n                            var headerItem = null;\r\n                            var itemIndex = null;\r\n\r\n                            const getLayerTable = function (item, index) {\r\n                                if (item.header) {\r\n                                    headerItem = item;\r\n\r\n                                    if (itemIndex) {\r\n                                        itemIndex = null;\r\n                                    }\r\n                                } else {\r\n                                    if (!itemIndex) {\r\n                                        itemIndex = 1;\r\n                                    }\r\n\r\n                                    var position;\r\n                                    if (headerItem) {\r\n                                        var headerIndex = rows.map(function (item) { return item[0].text }).indexOf(headerItem.header);\r\n                                        position = headerIndex + itemIndex++;\r\n                                    }\r\n\r\n                                    if (item.image) {\r\n                                        var imageWidth = item.image.canvas.width / 2;\r\n                                        var imageHeight = (imageWidth * item.image.canvas.height / item.image.canvas.width);\r\n\r\n                                        var data = [{\r\n                                            text: item.title,\r\n                                            fontSize: 9,\r\n                                            width: 'auto',\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }, {\r\n                                            image: item.image.base64,\r\n                                            width: imageWidth,\r\n                                            height: imageHeight,\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }];\r\n\r\n                                        if (position) {\r\n                                            rows.splice(position, 0, data);\r\n                                        } else {\r\n                                            rows.push(data);\r\n                                        }\r\n\r\n                                    } else {\r\n                                        var data = [{\r\n                                            text: item.title,\r\n                                            fontSize: 9,\r\n                                            colSpan: 2,\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }, {}];\r\n\r\n                                        if (position) {\r\n                                            rows.splice(position, 0, data);\r\n                                        } else {\r\n                                            rows.push(data);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            };\r\n\r\n                            group.layers.forEach(getLayerTable);\r\n\r\n                            content.push({\r\n                                layout: 'noBorders',\r\n                                table: {\r\n                                    dontBreakRows: true,\r\n                                    keepWithHeaderRows: 1,\r\n                                    headerRows: headerRows,\r\n                                    body: rows\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        legendByGroup.map(function (group, index) {\r\n                            return {\r\n                                groupIndex: index,\r\n                                height: group.layers.filter(function (item) {\r\n                                    return item.image && item.image.canvas;\r\n                                }).reduce(function (prev, current, index, vector) {\r\n                                    return prev + vector[index].image.canvas.height;\r\n                                }, 0)\r\n                            }\r\n                        }).sort(function (a, b) {\r\n                            if (a.height > b.height) {\r\n                                return 1;\r\n                            }\r\n                            if (a.height < b.height) {\r\n                                return -1;\r\n                            }\r\n                            return 0;\r\n                        }).forEach(function (groupWithHeight, index) {\r\n                            getGroupTable(legendByGroup[groupWithHeight.groupIndex], index)\r\n                        });\r\n\r\n                        resolve(content);\r\n\r\n                    }, function () {\r\n                        reject([]);\r\n                    });\r\n                });\r\n            };\r\n            const drawQR = function () {\r\n                // GLS: añadimos el QR\r\n                //QR\r\n                const cb = document.querySelector(`#${self.CLASS}-image-qr-${self.id}`);\r\n                if (!cb.disabled && cb.checked) {\r\n                    const qrTarget = document.querySelector('.' + self.CLASS + '-qrcode');\r\n                    qrTarget.innerHTML = '';\r\n                    return self.makeQRCode(qrTarget, options.qrCode.sideLength, options.qrCode.sideLength).then(function (qrCodeBase64) {\r\n                        if (qrCodeBase64) {\r\n                            return TC.Util.addToCanvas(self.canvas, qrCodeBase64, { x: self.canvas.width - options.qrCode.sideLength, y: self.canvas.height - options.qrCode.sideLength }, {width: options.qrCode.sideLength, height: options.qrCode.sideLength }).then(function (mapCanvas) {\r\n                                return mapCanvas;\r\n                            });\r\n                        } else {                            \r\n                            return self.canvas;\r\n                        }\r\n                    });\r\n                } else {\r\n                    return self.canvas;\r\n                }\r\n            };\r\n\r\n            const basics = [getLogo, function () {\r\n                var titleColumn = getTitleColumn(layout);\r\n                titleColumn.text = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n                return titleColumn;\r\n            }, getScaleBar, drawQR];\r\n\r\n            Promise.all(basics.map(function (fn) {\r\n                return fn();\r\n            })).then(function (basicsDone) {\r\n\r\n                if (basicsDone[2].table) { // GLS: ajustamos el ancho del título para arrinconar la escala\r\n                    layout.layoutPDF.content[0].columns[1].width = layout.layoutPDF.pageSize.width - (layout.layoutPDF.pageMargins[0] + layout.layoutPDF.pageMargins[2]) - layout.layoutPDF.content[0].columns[0].width - (layout.layoutPDF.content[0].columns[2].table.widths[0] + 2);\r\n                }\r\n\r\n                var mapPlace = getMap(layout);\r\n                var canvas = basicsDone[3] || self.canvas;\r\n\r\n                mapPlace.image = canvas.toDataURL();\r\n\r\n                if (hasLegendToPrint.call(self) && // GLS: validamos que haya capas visibles por escala \r\n                    printLayout.content.length == 2) { // GLS: es la primera descarga o hemos resetado la leyenda por algún zoom por lo que no tenemos la leyenda en el layout\r\n\r\n                    const title = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n                    printLayout.content.push({\r\n                        pageBreak: 'before',\r\n                        pageOrientation: (self.options.legend && self.options.legend.orientation) || ORIENTATION.PORTRAIT,\r\n                        text: title.length > 0 ? title : '',\r\n                        fontSize: 14,\r\n                        margin: [0, 20, 0, 10]\r\n                    });\r\n\r\n                    getLegend().then(function (content) {\r\n                        printLayout.content = printLayout.content.concat(content);\r\n                        createPDF(printLayout);\r\n                    });\r\n                } else {\r\n                    createPDF(printLayout);\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function (maxLengthExceed) {\r\n        const self = this;\r\n        const alertElm = self.div.querySelector('.' + self.CLASS + '-alert');\r\n        const checkboxQR = document.querySelector(`#${self.CLASS}-image-qr-${self.id}`);\r\n\r\n        checkboxQR.disabled = maxLengthExceed.qr;\r\n\r\n        if (checkboxQR.checked) {\r\n            alertElm.classList.toggle(TC.Consts.classes.HIDDEN, !maxLengthExceed.qr);\r\n        } else {\r\n            alertElm.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    ctlProto.generateLink = async function () {\r\n        const self = this;\r\n        const checkbox = self.div.querySelector(`.${self.CLASS}-div input[id|=\"${self.CLASS}-image-qr-${self.id}\"]`);\r\n        const label = self.div.querySelector(`label[for=\"${checkbox.id}\"]`);\r\n        checkbox.disabled = true;\r\n        label.classList.add(TC.Consts.classes.LOADING);\r\n        const result = await TC.control.MapInfo.prototype.generateLink.call(self);\r\n        label.classList.remove(TC.Consts.classes.LOADING);\r\n        return result;\r\n    };\r\n\r\n})();"]}