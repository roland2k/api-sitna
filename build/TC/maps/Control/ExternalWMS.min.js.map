{"version":3,"sources":["control/ExternalWMS.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","ExternalWMS","options","this","count","_addedUrls","apply","arguments","allowReprojection","hasOwnProperty","inherit","ctlProto","prototype","CLASS","markServicesAsSelected","length","selectedOption","disabled","classList","add","register","map","self","result","call","div","addEventListener","EventTarget","listenerBySelector","evt","target","value","url","indexOf","location","protocol","querySelector","addWMS","trim","test","some","addedUrl","replace","alert","getLocaleString","loadingCtrl","getControlsByClass","show","params","Util","getQueryStringParams","unwantedParams","urlWithoutParams","i","removeURLParameter","match","substr","_removeParamsFromUrl","Object","keys","item","toLowerCase","addButton","obj","id","type","hideTree","queryParams","suggestions","_current","items","filter","layerNames","layer","Raster","getCapabilitiesPromise","then","cap","root","Capability","Layer","CRS","crs","hide","trigger","Consts","event","EXTERNALSERVICEADDED","selectedOptions","querySelectorAll","forEach","option","push","error","renderPromise","e","key","on","LAYERADD","isBase","pending_markServicesAsSelected","template","1","container","depth0","helpers","partials","data","lookupProperty","parent","propertyName","escapeExpression","nullContext","name","hash","loc","start","line","column","end","3","stack1","alias1","fn","program","inverse","noop","4","lambda","6","alias2","8","compiler","main","useData","render","callback","_set1stRenderPromise","renderData","elemUrl","addProtocol"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.ExternalWMS = function (options) {\r\n    const self = this;\r\n    self.count = 0;\r\n    self._addedUrls = [];\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self.allowReprojection = self.options.hasOwnProperty('allowReprojection') ? self.options.allowReprojection : true;\r\n};\r\n\r\nTC.inherit(TC.control.ExternalWMS, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.ExternalWMS.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-xwms';\r\n\r\n    /*\r\n     * Marca como seleccionadas aquellas opciones del desplegable correspondientes a servicios WMS ya aÃ±adidos al TOC.\r\n     */\r\n    ctlProto.markServicesAsSelected = function (options) {\r\n        if (options.length > 0) {\r\n            const selectedOption = options[0];\r\n            selectedOption.disabled = true;\r\n            selectedOption.classList.add('tc-ctl-xwms-option-selected');\r\n        }\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector('select', function (evt) {\r\n            if (evt.target.value !== '') {\r\n                var url = evt.target.value;\r\n                if (url.indexOf('//') === 0) {\r\n                    url = location.protocol + url;\r\n                }\r\n                self.div.querySelector('input').value = url;\r\n                evt.target.value = '';\r\n            }\r\n        }));\r\n\r\n        /*\r\n         * Borra parÃ¡metros no necesarios de la URL del servicio WMS.\r\n         */\r\n        var _removeParamsFromUrl = function (url, unwantedParams) {\r\n            for (var i = 0; i < unwantedParams.length; i++) {\r\n                url = TC.Util.removeURLParameter(url, unwantedParams[i]);\r\n            }\r\n            if (url.match(/\\?$/)) {\r\n                url = url.substr(0, url.length - 1);\r\n            }\r\n            return url;\r\n        }\r\n\r\n        const addWMS = function () {\r\n            var url = self.div.querySelector('input').value.trim();\r\n\r\n            if (!url) {\r\n                TC.alert(self.getLocaleString('typeAnAddress'));\r\n            }\r\n            else if (!/^((https?|ftp):)?(\\/\\/)?(((([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:)*@)?(((\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5]))|((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?)(:\\d*)?)(\\/((([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)+(\\/(([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)*)*)?)?(\\?((([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)|[\\uE000-\\uF8FF]|\\/|\\?)*)?(\\#((([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)|\\/|\\?)*)?$/i.test(url)) {\r\n                TC.alert(self.getLocaleString('typeAValidAddress'));\r\n            }\r\n            else {\r\n                if (self._addedUrls.some(function (addedUrl) {\r\n                    return addedUrl.replace(/https?:\\/\\/|\\/\\//, '') === url.replace(/https?:\\/\\/|\\/\\//, '')\r\n                })) {\r\n                    TC.alert(self.getLocaleString('serviceAlreadyAdded'));\r\n                }\r\n                else {\r\n                    var loadingCtrl = self.map.getControlsByClass(\"TC.control.LoadingIndicator\")[0];\r\n                    loadingCtrl.show();\r\n                    var params = TC.Util.getQueryStringParams(url);\r\n\r\n                    if (!/https?:\\/\\/|\\/\\//i.test(url)) {\r\n                        url = \"//\" + url;\r\n                    }\r\n\r\n                    //Extraemos sÃ³lo los parÃ¡metros adicionales\r\n                    var unwantedParams = [\"version\", \"service\", \"request\"];\r\n                    var urlWithoutParams = _removeParamsFromUrl(url, Object.keys(params));\r\n\r\n                    for (var item in params) {\r\n                        if (unwantedParams.indexOf(item.toLowerCase()) >= 0) {\r\n                            delete params[item];\r\n                        }\r\n                    }\r\n\r\n                    const addButton = self.div.querySelector('button');\r\n                    addButton.disabled = true;\r\n\r\n                    var obj = {\r\n                        id: 'xwms' + (++self.count),\r\n                        //\"title\": \"Servicio externo\",\r\n                        type: 'WMS',\r\n                        url: urlWithoutParams,\r\n                        hideTree: false,\r\n                        queryParams: params\r\n                    };\r\n                    //URI: recorremos las opciones buscando el servicio que se va a agregar a ver si tiene parametro layerNames\r\n                    for (var i = 0; i < self.options.suggestions.length; i++) {\r\n                        var _current = self.options.suggestions[i].items.filter(function (item, i) {\r\n                            return item.url === url;\r\n                        });\r\n                        if (_current.length > 0 && _current[0].layerNames) {\r\n                            obj[\"layerNames\"] = _current[0].layerNames;\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    var layer = new TC.layer.Raster(obj);\r\n                    layer.getCapabilitiesPromise().then(function (cap) {\r\n                        if (typeof (cap.Capability) === 'undefined') {\r\n                            TC.alert(self.getLocaleString('noLayersFoundInService'));\r\n                            loadingCtrl.hide();\r\n                            addButton.disabled = false;\r\n                            return;\r\n                        } else {\r\n                            var root = cap.Capability.Layer;\r\n                            if (root.CRS && root.CRS.indexOf(self.map.crs) == -1 && !self.allowReprojection) {\r\n                                //no soportado. avisar y fallar\r\n                                TC.alert(self.getLocaleString('serviceSrsNotCompatible'));\r\n                                loadingCtrl.hide();\r\n                                addButton.disabled = false;\r\n                                return;\r\n                            }\r\n\r\n                            self.map.trigger(TC.Consts.event.EXTERNALSERVICEADDED, { layer: layer });\r\n                            self.div.querySelector('input').value = '';\r\n\r\n                            const selectedOptions = [];\r\n                            self.div.querySelectorAll('select option').forEach(function (option) {\r\n                                if (option.value.replace(/https?:\\/\\/|\\/\\//, '') === url.replace(/https?:\\/\\/|\\/\\//, '')) {\r\n                                    selectedOptions.push(option);\r\n                                }\r\n                            });\r\n                            self.markServicesAsSelected(selectedOptions);\r\n                            self._addedUrls.push(url);\r\n                            loadingCtrl.hide();\r\n                            addButton.disabled = false;\r\n                        }\r\n                    },\r\n                        function (error) {\r\n                            TC.alert(self.getLocaleString('serviceCouldNotBeLoaded') + \":\\n\" + error);\r\n                            loadingCtrl.hide();\r\n                            addButton.disabled = false;\r\n                        });\r\n                }\r\n            }\r\n        };\r\n\r\n        self.renderPromise().then(() => {\r\n            self.div.querySelector('input').addEventListener('keyup', (e) => {\r\n                if (e.key && e.key.toLowerCase() === \"enter\" && self.div.querySelector('input').value.trim().length > 0) {\r\n                    addWMS();\r\n                }\r\n            });\r\n        });       \r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('button[name=\"agregar\"]', addWMS));\r\n\r\n        map.on(TC.Consts.event.LAYERADD, function (e) {\r\n            const layer = e.layer;\r\n            if (layer && !layer.isBase) {\r\n                var url = layer.url;\r\n\r\n                if (url) {\r\n                    self.pending_markServicesAsSelected = self.pending_markServicesAsSelected || [];\r\n                    if (self.div.querySelectorAll('select option').length === 0 && url && self.pending_markServicesAsSelected.indexOf(url) === -1) {\r\n                        self.pending_markServicesAsSelected.push(url);\r\n                    }\r\n\r\n                    const selectedOptions = [];\r\n                    self.div.querySelectorAll('select option').forEach(function (option) {\r\n                        if (option.value.replace(/https?:\\/\\/|\\/\\//, '') === url.replace(/https?:\\/\\/|\\/\\//, '')) {\r\n                            selectedOptions.push(option);\r\n                        }\r\n                    });\r\n                    self.markServicesAsSelected(selectedOptions);\r\n                    self._addedUrls.push(url);\r\n                }\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-xwms.hbs\";\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self._set1stRenderPromise(self.renderData(self.options, function () {\r\n            self.pending_markServicesAsSelected = self.pending_markServicesAsSelected || [];\r\n\r\n            self.pending_markServicesAsSelected.forEach(function (elemUrl) {\r\n                const selectedOptions = [];\r\n                self.div.querySelectorAll('select option').forEach(function (option) {\r\n                    if (TC.Util.addProtocol(option.value) === TC.Util.addProtocol(elemUrl)) {\r\n                        selectedOptions.push(option);\r\n                    }\r\n                });\r\n\r\n                self.markServicesAsSelected(selectedOptions);\r\n                self._addedUrls.push(elemUrl);\r\n            });\r\n\r\n            self.pending_markServicesAsSelected = [];\r\n        }));\r\n    };\r\n\r\n\r\n})();"]}