{"version":3,"sources":["view/ThreeD.js"],"names":["TC","view","control","MapContents","syncLoadJS","apiLocation","viewProto","VIEWNAME","CLASS","Consts","BLANK_BASE","DEFAULT_TILE_SIZE","classes","MAP3D","LOADING","CAMERACTRARROWDISABLED","FOCUS","HIGHLIGHTED","DISABLED","OUTFOCUS","allowedControls","template","viewer","mapView","terrainProvider","getLocaleString","key","texts","locale","this","map","options","Cfg","Util","getRenderedHtml","templateId","data","callback","Control","prototype","call","isDebug","url","CESIUM","THREED","THREED_HIDDEN","event","TERRAINLOADED","TERRAINRECEIVING","TERRAIN404","compiler","main","container","depth0","helpers","partials","lookupProperty","parent","propertyName","Object","hasOwnProperty","escapeExpression","nullContext","name","hash","loc","start","line","column","end","useData","alias1","alias2","MapView","self","Promise","resolve","getViewHTML","then","html","viewHTML","bind","metersPerUnit","getMetersPerUnit","maxResolution","_oldMapSetCenter","setCenter","coords","on3DView","view3D","flyToMapCoordinates","getCenter","getExtent","getResolution","getRotation","getMaxResolution","getResolutions","extent","baselayerExtent","getPixelFromCoordinate","center","setExtent","setResolution","resolution","setRotation","rotation","isCompatible","layer","crs","type","layerType","WMTS","wrap","getCompatibleMatrixSets","length","distanceSquared","p1","p2","dx","dy","getFarMapCoords","obj","nearMapCoords","nextPixel","bottomPixel","clone","y","Math","round","nextCoords","pickMapCoords","coordsArray","sort","a","b","cameraPosition","origin","nearPoint","angle","atan","PI","cos","sin","apply","pixel","pickPoint","pickOnTerrainOrEllipsoid","scene","Cesium","Cartographic","fromCartesian","view2DCRS","reproject","toDegrees","longitude","latitude","calcResolutionForDistance","distance","canvas","fovy","camera","frustum","visibleMeters","tan","relativeCircumference","abs","visibleMapUnits","clientHeight","resolutions","Array","i","ii","pow","rotateAroundAxis","axis","transform","opt_options","clamp","defaultValue","duration","easing","lastProgress","oldTransform","Matrix4","reject","requestAnimationFrame","animation","timestamp","progress","stepAngle","lookAtTransform","rotate","ray","getPickRay","target","globe","pick","pickEllipsoid","pickCenterPoint","Cartesian2","clientWidth","pickBottomPoint","bottom","setHeadingUsingBottomCenter","heading","bottomCenter","angleToZenith","computeAngleToZenith","right","quaternion","Quaternion","fromAxisAngle","Matrix3","fromQuaternion","vector","Cartesian3","subtract","position","zenith","multiplyByVector","add","fromTranslation","signedAngleBetween","first","second","normal","c","normalize","cross","cosine","dot","sine","magnitude","sign","atan2","pivot","fy","fovy2","direction","matrix","Ray","bottomFovRay","negate","Ellipsoid","WGS84","geocentricSurfaceNormal","left","CameraControls","cssRotate","element","coord","getBBox","value","x","width","height","document","getElementsByClassName","className","baseVal","setAttribute","outControlsEvents","detectMouse","outControls","e","isFocusingCameraCtrls","inControlsEvents","inControls","lastFocused","performance","now","div","classList","contains","remove","tiltIndicatorOuterCircle","tiltIndicatorOuterShellCircle","rotateIndicatorOuterCircle","rotateIndicatorOuterShellCircle","moveStart","moving","moveEnd","postRender","isLoadingTiles","customCollisionDetection","getCamera","positionCartographic","tiltIndicator","pitch","rotateIndicator","disableRotate","disableTilt","_coordsXY","_ovMap","getControlsByClass","renderPromise","bottomLeft","bottomRight","fovCoords","elm","filter","farCoordsLeft","farCoordsRight","draw3DCamera","fov","selectors","tilt","indicator","leftArrow","rightArrow","downArrow","upArrow","MIN_TILT","toRadians","MAX_TILT","render","addEventListener","forEach","rAFInOutControls","setOpacity","unbind","HIDDEN","removeEventListener","window","cancelAnimationFrame","undefined","getCameraState","cp","chpr","roll","bcpd","createElement","innerHTML","appendChild","tiltSelector","tiltIndicatorInner","querySelector","replace","CLICK","resetTilt","tiltIndicatorCircle","stopPropagation","preventDefault","vectorScratch","currentTarget","rectangle","getBoundingClientRect","top","clickLocation","clientX","clientY","draggingTilt","cancelBubble","returnValue","tiltUp","disabled","upEvent","tiltUpMouseUpFunction","tiltUpInterval","setInterval","isTiltUpDisabled","clearInterval","tiltDown","tiltDownMouseUpFunction","tiltDownInterval","isTiltDownDisabled","rotateSelector","rotateIndicatorInner","resetRotation","rotateIndicatorCircle","draggingRotate","rotateLeft","rotateLeftMouseUpFunction","rotateLeftInterval","rotateRight","rotateRightMouseUpFunction","rotateRightInterval","theta","toggle","isDisable","trackedEntity","rotateUp","lookUp","lookDown","PI_OVER_TWO","_angle","tiltElement","cursorVector","oldTransformScratch","newTransformScratch","tiltMouseMoveFunction","tiltMouseUpFunction","isTilting","tiltFrame","Transforms","northUpEastToFixedFrame","tiltIsLook","positionWC","startCursorAngle","initialCameraAngle","tiltRectangle","console","log","toString","angleDifference","newCameraAngle","zeroToTwoPi","currentCameraAngle","rotateElement","rotateMouseMoveFunction","rotateMouseUpFunction","rotateRectangle","rotateInitialCursorAngle","rotateInitialCameraAngle","rotateFrame","isRotating","viewCenter","eastNorthUpToFixedFrame","rotateIsLook","rotateInitialCameraDistance","currentRotation","fromDegrees","mag","scratchAdjustHeightTransform","scratchAdjustHeightCartographic","screenSpaceCameraController","minimumCollisionTerrainHeight","enableCollisionDetection","minimumZoomDistance","ellipsoid","mapProjection","equals","IDENTITY","_setTransform","cartographic","cartesianToCartographic","heightUpdated","getHeight","cartographicToCartesian","multiplyByScalar","max","up","limitCameraToInitExtent","pos","initExtent","west","east","south","north","maxHeight","maximumZoomDistance","padding","min","setView","destination","orientation","TwoDLinkedFeatureInfo","savedMode","pending","marker","ctlResultsPanel","ctlFeatureInfo","map2DgetResolutionFN","getResultsPanelCtl","resultsPanelOptions","content","titles","addControlPromise","controlContainer","POSITION","RIGHT","addControl","caller","resultsPanel","removeMarker","removeFeature","FeatureInfo","displayMode","setDisplayMode","infoContainer","RESULTS_PANEL","on","RESULTSPANELCLOSE","getDisplayControl","querying","clear","closeResults","reset","send","pickedPosition","close","waiting","getLoadingIndicator","addWait","FeatureInfoCommons","markerStyle","billboard","image","getBackgroundUrlFromCss","eyeOffset","verticalOrigin","VerticalOrigin","BOTTOM","heightReference","HeightReference","CLAMP_TO_GROUND","addNativeFeature","requestRender","setMarker","reprojected","pickedLocation","pixelTolerance","pickedTile","tilesRendered","_surface","_tilesToRender","textureIndex","tile","Rectangle","imageryTiles","imagery","terrainImagery","readyImagery","nativeRectangle","tilingScheme","tileXYToNativeRectangle","level","readyImageryToGetNativeRectangle","imageryLayer","isBaseLayer","west_south","east_north","xResolution","imageryProvider","tileWidth","yResolution","tileHeight","one","NOFEATUREINFO","FEATUREINFO","FEATURECLICK","savedIsActive","isActive","beforeRequest","xy","get2DMarker","filterFeature","isPending","RasterConverter","crsPattern","layerCrs","CustomResource","paths","CRS","TILEMATRIXSET","TILEMATRIXSETLABELS","getOfPath","p","_obj","push","wmtsLayer","tileMatrixSetLabels","capsURL","isOnCapabilities","caps","capabilities","tileMatrixSet","CRSCodesEqual","id","Identifier","labels","getTileMatrixSetLabelByLayerOnCapabilities","urlPattern","layerNames","style","format","tileMatrixSetID","tileMatrixLabels","GeographicTilingScheme","WebMapTileServiceImageryProvider","xhrBlobSupported","xhr","XMLHttpRequest","open","responseType","fetchImage","resource","allowCrossOrigin","request","requestFunction","crossOrigin","isDataUri","isBlobUri","isCrossOriginUrl","deferred","when","defer","getWebGLUrl","Image","onload","onerror","TrustedServers","src","createImage","promise","RequestScheduler","defined","otherwise","customFetchImage","preferBlob","deprecationWarning","state","RequestState","ISSUED","ACTIVE","RuntimeError","UNISSUED","checkAndResetRequest","hasHeaders","blobPromise","fetchBlob","generatedBlobResource","generatedBlob","blob","blobUrl","URL","createObjectURL","Resource","revokeObjectURL","error","convert","map3DCRS","constructor","create","result","cloned","_url","_queryParameters","_templateValues","headers","proxy","retryCallback","retryAttempts","_retryCount","defineCustomResource","WMS","layers","parameters","version","transparent","exBoundingBox","bbox","Capability","Layer","names","slice","_getEXBBox","nodes","n","compareNames","getName","EX_GeographicBoundingBox","exBBox","pop","bindEXBBox","geoBBox","WebMapServiceImageryProvider","FeatureConverter","toCesiumColor","hexStringColor","alpha","color","Color","fromCssColorString","withAlpha","setStyleProperties","styles","properties","feature","attr","prop","val","getFeatureStyle","Defaults","STYLETYPE","extend","getStyle","createLine","entity","Entity","polyline","positions","material","clampToGround","polygonConverter","polygon","opt","opacity","outlineColor","outlineOpacity","ColorGeometryInstanceAttribute","fromColor","MultiPolygon","CLASSNAME","geometryType","polygonHierarchy","getting","geomPolys","geomOutlines","getOutlineGeom","outlineCoords","res","rej","j","hierarchy","PolygonHierarchy","holes","GeometryInstance","geometry","PolygonGeometry","attributes","all","GroundPrimitive","releaseGeometryInstances","geometryInstances","Polygon","isArray","lineConverter","MultiPolyline","geomInstances","minx","miny","maxx","maxy","point","z","fromCartesianArray","neededCameraPosition","getRectangleCameraCoordinates","BoundingSphere","fromPoints","pixelSize","getPixelDimensions","drawingBufferWidth","drawingBufferHeight","getPixelSize","Polyline","pointConverter","label","fontSize","fontColor","outlineLabelColor","outlineLabelWidth","anchor","outlineWidth","radius","Marker","pixelOffset","text","font","horizontalOrigin","HorizontalOrigin","LEFT","fillColor","showBackground","Point","pinBuilder","PinBuilder","test","CENTER","BASELINE","BLACK","WHITE","LabelStyle","FILL_AND_OUTLINE","fromText","toDataURL","stringifyScratch","drawPin","context2D","size","rgbaColor","darken","toCssColorString","save","scale","strokeStyle","miterLimit","restore","fillStyle","lineWidth","lineJoin","beginPath","moveTo","lineTo","closePath","fill","stroke","translate","arc","createPin","_cache","JSON","stringify","item","getContext","strokeColor","scn","sourceCrs","targetCrs","converter","points","ringsOrPolylines","polygons","byPromise","cartesians","toCartesian","arr","forPoints","forRingsOrPolylines","Circle","circle","CircleGeometry","forPolygons","boundigSphere","provider","currentMapCfg","baseMap","baseMaps","baseVector","init","events","$events","divThreedMap","divMap","terrain","Error","terrainFallback","coverageName","noDataValue","trim","layerName","controls","PROJECTIONCHANGE","parser","DOMParser","overlay","parseFromString","body","firstChild","viewName","substr","toLowerCase","views","newCrs","toast","msgType","INFO","ctrlsToMng","ctls","len","ctl","toUpperCase","ctlsOnMap","CONTROLADD","ctrlClass","instance","Function","warn","concat","applyEnd","removeWait","loadViewer","isBaseRaster","baseLayer","Raster","fallbackLayer","getFallbackLayer","_capabilitiesPromise","baseLayers","results","mustReproject","setCameraFromMapView","setBaseLayer","workLayers","elem","reverse","addLayer","readyPromise","cameraControls","animateRendering","flyTo","fromRadians","complete","pickBP","readyPickBP","_pickBP","matrixPickBP","animationCallback","Camera","DEFAULT_VIEW_RECTANGLE","initialRectangle","computeViewRectangle","DEFAULT_VIEW_FACTOR","checkPickBPProcess","startTime","Date","getTime","checkPickBottomPoint","homeButton","querySelectorAll","NavBarHome","click","trigger","VIEWCHANGE","addHeight","finalCartographic","markers","entities","values","Property","getValueOrUndefined","JulianDate","billboardCollection","get","catch","unapply","TERRAINPROVIDERREMOVE","fallbackProvider","setViewFromCameraView","destroy","rasterConverter","featureConverter","addFeature","csFeature","addedFeature","groundPrimitives","primitives","BillboardCollection","billboardAtCollection","getById","linkFeature","idLayer","vector2DFeatures","listenTo","BEFOREBASELAYERCHANGE","BASELAYERCHANGE","LAYERADD","LAYERREMOVE","LAYERVISIBILITY","LAYEROPACITY","LAYERORDER","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR","ZOOMTO","geolocation_newPosition","trackingEntity","geolocation2D","linked2DControls","geolocation","track","layerTracking","features","positionCallback","CallbackProperty","time","newCartographicPositions","coordinate","updatedPositions","cartographicArrayToCartesianArray","entityTracking","PolylineDashMaterialProperty","fromAlpha","renderTrack","checked","gapColor","TRANSPARENT","geolocation_videoControls","Const","Event","IMPORTEDTRACK","indexOf","parentElement","Classes","SELECTEDTRACK","clock","shouldAnimate","currentTime","fromDate","trackDataSource","removeById","chartProgressClear","custom","selectedTrack","getSelectedTrack","Selector","STOP","multiplier","simulate_speed","alterAllowedControls","ctrlsToMngCLASS","ctrl","mapCtrl","DEFAULT","enable","disable","onLeftClickOnCanvas","movement","getFeatureInfo","getInfoOnPickedPosition","pickedFeature","founded","layerId","feature2D","workLayer","showsPopup","onDrawTable","onTableClose","off","DRAWTABLE","onMouseMoveOnCanvas","endPosition","cursor","featureInfo","eventHandlers","handlerOfFeatures","ScreenSpaceEventHandler","setInputAction","ScreenSpaceEventType","LEFT_CLICK","MOUSE_MOVE","Geolocation","commands","PAUSE","BACKWARD","FORWARD","DRAW","geolocation_videoControls_","lstEventListener","some","cls","setTracking","_setTracking","simulateTrack","_wrap_simulateTrack","showElevationMarker","_wrap_showElevationMarker","hideElevationMarker","_wrap_hideElevationMarker","_simulateTrack","elevationTrack","_elevationTrack","command","tracking","POSITIONCHANGE","li","resized","hasElevation","simulationOnPreUpdate","drawTrack","layerTrack","coordinates","layout","pointStyle","lineStyle","walkingSpeed","sampleTerrainMostDetailed","stopTime","totalDistance","ol","geom","GeometryLayout","XYZM","XYM","done","previuos_next","EllipsoidGeodesic","surfaceDistance","toISOString","czml","availability","epoch","cartographicRadians","updatedPosition","reduce","prev","curr","rgba","strokeWidth","coordinates2D","getGeometry","DataSourceCollection","dataSourceDisplay","DataSourceDisplay","dataSourceCollection","preRender","update","CzmlDataSource","load","czmlDataSource","stop","clockStep","ClockStep","TICK_DEPENDENT","clockRange","ClockRange","CLAMPED","trackEntity","tagLI","TimeIntervalCollection","TimeInterval","get2DHeightAtProgress","distanceCurrent","doneDistance","previous","current","heightIndex","XYZ","previousPosition","preUpdate","getAttribute","greaterThanOrEquals","isAvailable","currentPosition","chartSetProgress","d","_getTime","toDate","elevationChartData","getVisibility","getOpacity","elevationMarkerPosition","index","elevationMarker","initialExtent","zoomin","zoomout","override2DZoom","activate","zoom","amount","zoomToCartesian","sourceCRS","coordsXY","coordsXY2","flyToRectangle","button","NavBar","customRender","vector2DLayers","surface","ready","loadJS","resourceBoundaries","fetchJson","bounds","ApproximateTerrainHeights","initialize","boundaries","arguments","MergeTerrainProvider","fallback","CesiumTerrainProvider","attributions","getAttribution","TERRAINPROVIDERADD","Globe","baseColor","enableLighting","tileCacheSize","maximumScreenSpaceError","Viewer","terrainExaggeration","timeline","fullscreenButton","baseLayerPicker","navigationInstructionsInitiallyVisible","navigationHelpButton","geocoder","infoBox","sceneModePicker","selectionIndicator","skyBox","skyAtmosphere","requestRenderMode","maximumRenderTimeChange","Infinity","backgroundColor","imageryLayers","removeAll","errorEvent","statusCode","renderError","code","ERROR","tileLoadingHandler","EventHelper","tileLoadProgressEvent","allReady","removeChild","_event2DHandler","removeLayer","setRenderOptionsLayer","visibility","join","oldIndex","newIndex","lower","raise","splice","threedFeature","featureId","ZOOM","_canvasClientHeight","_canvasClientWidth","lastZoom","Vector","vectorLayer","get3DLayer","title","raiseToTop","isBase","relatedWMTS","getLayer","VECTOR","convertedLayer","enablePickFeatures","newImageryLayer","addImageryProvider","lowerToBottom","show","setRenderOptionsFeature","lonlat","cancelFlight","epsilon","EPSILON3","marginX","marginY","destinationCartesian","finalDestinationCartographic","pickRay","intersection","distanceMeasure","_zoomTo","setTimeout","toMove","toGo","intersectionToGo","easingFunction","EasingFunction","LINEAR_NONE","csfeature","newGeometry","geo","Billboard","cesiumFeature","latlon","carto","setCamera","moveBackward","tool","Elevation","elevationTool","getElevation","target_","targetCartographic","centerMapCRS","lookAt","handlerOfMovementConversion","cesiumWidget","lat","lon","ele","movement3DtoPosition2D","eventTC","MOUSEMOVE","detectMobile","getHeightFromMDT","geoCoords","cartesian","defaultBaseLayer","triggerEvent","showReprojectDialog","haveToChange","dialogOptions","BasemapSelector","Coordinates","closeCallback","showProjectionChangeDialog","getCRS","confirm","isGeo","factory"],"mappings":"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","sourcesContent":["var TC = TC || {};\r\nTC.view = TC.view || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n(function (namespace, signature, factory) {\r\n    namespace[signature] = factory();\r\n})(TC.view, \"ThreeD\", function () {\r\n\r\n    var viewProto = {\r\n        VIEWNAME: \"ThreeD\",\r\n        CLASS: 'tc-view-3d',\r\n        Consts: {\r\n            BLANK_BASE: 'blank',\r\n            DEFAULT_TILE_SIZE: 256\r\n        },\r\n        classes: {\r\n            MAP3D: 'tc-map-3d',\r\n            LOADING: 'tc-loading',\r\n            CAMERACTRARROWDISABLED: 'disabled-arrow',\r\n            FOCUS: 'focus',\r\n            HIGHLIGHTED: 'highlighted',\r\n            DISABLED: 'disabled',\r\n            OUTFOCUS: 'outfocus'\r\n        },\r\n        allowedControls: [],\r\n        template: {},\r\n\r\n        viewer: null,\r\n        mapView: null,\r\n        terrainProvider: null,\r\n\r\n        getLocaleString: function (key, texts) {\r\n            var self = this;\r\n            var locale = self.map ? self.map.options.locale : TC.Cfg.locale;\r\n            return TC.Util.getLocaleString(locale, key, texts);\r\n        },\r\n\r\n        getRenderedHtml: function (templateId, data, callback) {\r\n            return TC.Control.prototype.getRenderedHtml.call(this, templateId, data, callback);\r\n        }\r\n    };\r\n\r\n    if (TC.isDebug) {\r\n        TC.Consts.url.CESIUM = TC.apiLocation + 'lib/cesium/debug/Cesium.js';\r\n    }\r\n\r\n    TC.Consts.classes.THREED = TC.Consts.classes.THREED || \"tc-3d\";\r\n    TC.Consts.classes.THREED_HIDDEN = TC.Consts.classes.THREED_HIDDEN || \"tc-3d-hidden\";\r\n    TC.Consts.event.TERRAINLOADED = TC.Consts.event.TERRAINLOADED || \"terrainloaded.tc.threed\";\r\n    TC.Consts.event.TERRAINRECEIVING = TC.Consts.event.TERRAINRECEIVING || \"terrainreceiving.tc.threed\";\r\n    TC.Consts.event.TERRAIN404 = TC.Consts.event.TERRAIN404 || \"terrain404.tc.threed\";\r\n\r\n    viewProto.template[viewProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-3d.hbs\";\r\n    viewProto.template[viewProto.CLASS + '-overlay'] = TC.apiLocation + \"TC/templates/tc-view-3d-overlay.hbs\";\r\n    viewProto.template[viewProto.CLASS + '-cm-ctls'] = TC.apiLocation + \"TC/templates/tc-view-3d-cm-ctls.hbs\";\r\n\r\n    const MapView = function (map, parent) {\r\n        var self = this;\r\n        self.map = map;\r\n        self.parent = parent;\r\n\r\n        Promise.resolve(self.map.getViewHTML()).then(function (html) {\r\n            self.viewHTML = html;\r\n        }.bind(self));\r\n\r\n        self.metersPerUnit = map.getMetersPerUnit();\r\n\r\n        self.maxResolution = null;\r\n\r\n        //flacunza: modificamos TC.Map.setCenter para que se haga desde la vista 3D cuando está activa\r\n        //así evitamos parpadeos en el mapa de situación\r\n        self._oldMapSetCenter = map.setCenter;\r\n        map.setCenter = function (coords, options) {\r\n            if (map.on3DView) {\r\n                map.view3D.flyToMapCoordinates.call(parent, coords);\r\n            }\r\n            else {\r\n                self._oldMapSetCenter.call(map, coords, options);\r\n            }\r\n        };\r\n    };\r\n    MapView.prototype.getCenter = function () {\r\n        return this.map.getCenter();\r\n    };\r\n    MapView.prototype.getExtent = function () {\r\n        return this.map.getExtent();\r\n    };\r\n    MapView.prototype.getResolution = function () {\r\n        return this.map.getResolution();\r\n    };\r\n    MapView.prototype.getRotation = function () {\r\n        return this.map.getRotation();\r\n    };\r\n    MapView.prototype.getMaxResolution = function () {\r\n        if (this.maxResolution)\r\n            return this.maxResolution;\r\n\r\n        if (this.map.getResolutions() !== null)\r\n            this.maxResolution = this.map.getResolutions()[0];\r\n        else {\r\n            var extent = this.map.options.baselayerExtent;\r\n            this.maxResolution = (extent[2] - extent[0]) / this.parent.Consts.DEFAULT_TILE_SIZE;\r\n        }\r\n\r\n        return this.maxResolution;\r\n    };\r\n    MapView.prototype.getPixelFromCoordinate = function (coords) {\r\n        return this.map.getPixelFromCoordinate(coords);\r\n    };\r\n    MapView.prototype.setCenter = function (center) {\r\n        this._oldMapSetCenter.call(this.map, center);\r\n    };\r\n    MapView.prototype.setExtent = function (extent) {\r\n        this.map.setExtent(extent);\r\n    };\r\n    MapView.prototype.setResolution = function (resolution) {\r\n        this.map.setResolution(resolution);\r\n    };\r\n    MapView.prototype.setRotation = function (rotation) {\r\n        this.map.setRotation(rotation);\r\n    };\r\n\r\n\r\n    //  Funciones compatibilidad CRS\r\n    var isCompatible = function (layer, crs) {\r\n        return layer.type === TC.Consts.layerType.WMTS ?\r\n            layer.wrap.getCompatibleMatrixSets(crs).length > 0 :\r\n            layer.isCompatible(crs);\r\n    };\r\n\r\n    // Funciones para cálculo de FOV\r\n    var getFarCoords = function (origin, nearPoint) {\r\n        var radius = 1000000; // 1000 km\r\n        var dx = nearPoint[0] - origin[0];\r\n        var dy = nearPoint[1] - origin[1];\r\n        var angle = Math.atan(dy / dx);\r\n        // Math.atan solo da resultados entre -90º y 90º, si estamos mirando al hemisferio oeste hay que sumar 180º al ángulo\r\n        if (dx < 0) {\r\n            angle = angle + Math.PI;\r\n        }\r\n        return [origin[0] + radius * Math.cos(angle), origin[1] + radius * Math.sin(angle)];\r\n    };\r\n\r\n    var distanceSquared = function (p1, p2) {\r\n        var dx = p2[0] - p1[0];\r\n        var dy = p2[1] - p1[1];\r\n        return dx * dx + dy * dy;\r\n    };\r\n\r\n    var getFarMapCoords = function (obj) {\r\n        // Calculamos puntos lejanos cuando no los tenemos (cuando estamos mirando al horizonte).\r\n        // Cogemos un punto proyectado desde la esquina inferior del canvas, \r\n        // cogemos un segundo punto en el lateral del canvas inmediatamente por encima \r\n        // y prologamos la línea que pasa por ambos puntos proyectados.\r\n        var self = this;\r\n        obj = obj || {};\r\n        if (obj.nearMapCoords) {\r\n            var nextPixel = obj.bottomPixel.clone();\r\n            nextPixel.y = Math.round(nextPixel.y * 9 / 10);\r\n            var nextCoords = pickMapCoords.call(self, nextPixel);\r\n            if (nextCoords) {\r\n                // Ordenamos la dupla por distancia, porque si estamos mirando desde dentro de un monte \r\n                // el punto que se supone que es el más lejano en realidad está más cerca.\r\n                var coordsArray = [obj.nearMapCoords, nextCoords].sort(function (a, b) {\r\n                    return distanceSquared(obj.cameraPosition, a) - distanceSquared(obj.cameraPosition, b);\r\n                });\r\n                return getFarCoords.apply(this, coordsArray);\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    var pickMapCoords = function (pixel) {\r\n        var self = this;\r\n        var pickPoint = pickOnTerrainOrEllipsoid(self.viewer.scene, pixel);\r\n        if (pickPoint) {\r\n            pickPoint = Cesium.Cartographic.fromCartesian(pickPoint);\r\n            if (self.view3D.crs !== self.view3D.view2DCRS) {\r\n                return TC.Util.reproject([Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)], self.view3D.crs, self.view3D.view2DCRS);\r\n            } else {\r\n                return [Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Funciones utilidades cámara\r\n    var calcDistanceForResolution = function (resolution, latitude) {\r\n        var self = this;\r\n\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n        var visibleMapUnits = resolution * self.mapView.viewHTML.getBoundingClientRect().height;\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMeters = visibleMapUnits * self.mapView.metersPerUnit * relativeCircumference;\r\n\r\n        return (visibleMeters / 2) / Math.tan(fovy / 2);\r\n    };\r\n\r\n    var calcResolutionForDistance = function (distance, latitude) {\r\n        var self = this;\r\n\r\n        var canvas = self.viewer.scene.canvas;\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n\r\n        var visibleMeters = 2 * distance * Math.tan(fovy / 2);\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMapUnits = visibleMeters / self.mapView.metersPerUnit / relativeCircumference;\r\n        var resolution = visibleMapUnits / canvas.clientHeight;\r\n\r\n        // validamos que la resolución calculada esté disponible en el array de resoluciones disponibles\r\n        // si no contamos con un array de resoluciones lo calculamos\r\n        var resolutions = self.map.getResolutions();\r\n        if (resolutions === null) {\r\n            resolutions = new Array(22);\r\n            for (var i = 0, ii = resolutions.length; i < ii; ++i) {\r\n                resolutions[i] = self.mapView.getMaxResolution() / Math.pow(2, i);\r\n            }\r\n        }\r\n\r\n        // obtenemos la resolución más próxima a la calculada\r\n        for (var i = 0; i < resolutions.length; i++) {\r\n            if (resolutions[i] < Math.abs(resolution)) {\r\n                resolution = resolutions[i - 1];\r\n                break;\r\n            } else if (resolutions[i] === Math.abs(resolution)) {\r\n                resolution = resolutions[i];\r\n                break;\r\n            } else if (i === resolutions.length - 1) {\r\n                resolution = resolutions[i];\r\n            }\r\n        }\r\n\r\n        return resolution;\r\n    };\r\n\r\n    var rotateAroundAxis = function (camera, angle, axis, transform, opt_options) {\r\n        var clamp = Cesium.Math.clamp;\r\n        var defaultValue = Cesium.defaultValue;\r\n\r\n        var options = opt_options || {};\r\n        var duration = defaultValue(options.duration, 500); // ms\r\n\r\n        var linear = function (a) {\r\n            return a\r\n        };\r\n        var easing = defaultValue(options.easing, linear);\r\n        var callback = options.callback;\r\n\r\n        var start;\r\n        var lastProgress = 0;\r\n        var oldTransform = new Cesium.Matrix4();\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            function animation(timestamp) {\r\n                if (!start)\r\n                    start = timestamp;\r\n\r\n                var progress = easing(clamp((timestamp - start) / duration, 0, 1));\r\n\r\n                camera.transform.clone(oldTransform);\r\n                var stepAngle = (progress - lastProgress) * angle;\r\n                lastProgress = progress;\r\n\r\n                camera.lookAtTransform(transform);\r\n                camera.rotate(axis, stepAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n                if (progress < 1) {\r\n                    requestAnimationFrame(animation);\r\n                } else {\r\n                    if (callback) {\r\n                        callback();\r\n                    }\r\n                    resolve();\r\n                }\r\n\r\n            }\r\n\r\n            requestAnimationFrame(animation);\r\n        });\r\n    };\r\n\r\n    var pickOnTerrainOrEllipsoid = function (scene, pixel) {\r\n        var self = this;\r\n\r\n        var ray = scene.camera.getPickRay(pixel);\r\n        var target = scene.globe.pick(ray, scene);\r\n        return target || scene.camera.pickEllipsoid(pixel);\r\n    };\r\n\r\n    var pickCenterPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var center = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2,\r\n            canvas.clientHeight / 2);\r\n        return pickOnTerrainOrEllipsoid(scene, center);\r\n    };\r\n\r\n    var pickBottomPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var bottom = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2, canvas.clientHeight);\r\n        return pickOnTerrainOrEllipsoid(scene, bottom);\r\n    };\r\n\r\n    var bottomFovRay = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var fovy2 = camera.frustum.fovy / 2;\r\n        var direction = camera.direction;\r\n        var rotation = Cesium.Quaternion.fromAxisAngle(camera.right, fovy2);\r\n        var matrix = Cesium.Matrix3.fromQuaternion(rotation);\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(matrix, direction, vector);\r\n        return new Cesium.Ray(camera.position, vector);\r\n    };\r\n\r\n    var setHeadingUsingBottomCenter = function (scene, heading, bottomCenter, opt_options) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        // Compute the camera position to zenith quaternion\r\n        var angleToZenith = computeAngleToZenith(scene, bottomCenter);\r\n        var axis = camera.right;\r\n        var quaternion = Cesium.Quaternion.fromAxisAngle(axis, angleToZenith);\r\n        var rotation = Cesium.Matrix3.fromQuaternion(quaternion);\r\n\r\n        // Get the zenith point from the rotation of the position vector\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.subtract(camera.position, bottomCenter, vector);\r\n        var zenith = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(rotation, vector, zenith);\r\n        Cesium.Cartesian3.add(zenith, bottomCenter, zenith);\r\n\r\n        // Actually rotate around the zenith normal\r\n        var transform = Cesium.Matrix4.fromTranslation(zenith);\r\n        rotateAroundAxis(camera, heading, zenith, transform, opt_options);\r\n    };\r\n\r\n    var signedAngleBetween = function (first, second, normal) {\r\n        var self = this;\r\n\r\n        // We are using the dot for the angle.\r\n        // Then the cross and the dot for the sign.\r\n        var a = new Cesium.Cartesian3();\r\n        var b = new Cesium.Cartesian3();\r\n        var c = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.normalize(first, a);\r\n        Cesium.Cartesian3.normalize(second, b);\r\n        Cesium.Cartesian3.cross(a, b, c);\r\n\r\n        var cosine = Cesium.Cartesian3.dot(a, b);\r\n        var sine = Cesium.Cartesian3.magnitude(c);\r\n\r\n        // Sign of the vector product and the orientation normal\r\n        var sign = Cesium.Cartesian3.dot(normal, c);\r\n        var angle = Math.atan2(sine, cosine);\r\n        return sign >= 0 ? angle : -angle;\r\n    };\r\n\r\n    var computeAngleToZenith = function (scene, pivot) {\r\n        var self = this;\r\n\r\n        // This angle is the sum of the angles 'fy' and 'a', which are defined\r\n        // using the pivot point and its surface normal.\r\n        //        Zenith |    camera\r\n        //           \\   |   /\r\n        //            \\fy|  /\r\n        //             \\ |a/\r\n        //              \\|/pivot\r\n        var camera = scene.camera;\r\n        var fy = camera.frustum.fovy / 2;\r\n        var ray = bottomFovRay(scene);\r\n        var direction = Cesium.Cartesian3.clone(ray.direction);\r\n        Cesium.Cartesian3.negate(direction, direction);\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(pivot, normal);\r\n\r\n        var left = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.negate(camera.right, left);\r\n\r\n        var a = signedAngleBetween(normal, direction, left);\r\n        return a + fy;\r\n    };\r\n\r\n    var computeSignedTiltAngleOnGlobe = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var ray = new Cesium.Ray(camera.position, camera.direction);\r\n        var target = scene.globe.pick(ray, scene);\r\n\r\n        if (!target) {\r\n            // no tiles in the area were loaded?\r\n            var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n            var obj = Cesium.IntersectionTests.rayEllipsoid(ray, ellipsoid);\r\n            if (obj) {\r\n                target = Cesium.Ray.getPoint(ray, obj.start);\r\n            }\r\n        }\r\n\r\n        if (!target) {\r\n            return undefined;\r\n        }\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(target, normal);\r\n\r\n        var angleBetween = signedAngleBetween;\r\n        var angle = angleBetween(camera.direction, normal, camera.right) - Math.PI;\r\n        return Cesium.Math.convertLongitudeRange(angle);\r\n    };\r\n\r\n    // Funciones CZML    \r\n    var toCZML = function (coordinates, layout, name, pointStyle, lineStyle, walkingSpeed) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            var positions = coordinates.map(function (coordinate) {\r\n                var reprojected = coordinate;\r\n                if (self.view3D.view2DCRS !== self.view3D.crs) {\r\n                    reprojected = TC.Util.reproject(coordinate, self.view3D.view2DCRS, self.view3D.crs);\r\n                }\r\n                return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n            });\r\n\r\n            Cesium.when(self.viewer.terrainProvider.sampleTerrainMostDetailed(positions), function (updatedPositions) {\r\n                var startTime, stopTime, totalDistance = 0;\r\n\r\n                if (layout === ol.geom.GeometryLayout.XYZM) {\r\n                    startTime = coordinates[0][3];\r\n                    stopTime = coordinates[coordinates.length - 1][3];\r\n                } else if (layout === ol.geom.GeometryLayout.XYM) {\r\n                    startTime = coordinates[0][2];\r\n                    stopTime = coordinates[coordinates.length - 1][2];\r\n                } else {\r\n\r\n                    coordinates[0][3] = updatedPositions[0].time = Date.now();\r\n\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var done;\r\n                        var previuos_next = [];\r\n\r\n                        updatedPositions[i].time = 0;\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        done = new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n\r\n                        totalDistance += done;\r\n\r\n                        coordinates[i][3] = updatedPositions[i].time = updatedPositions[i - 1].time + (3600000 * done / walkingSpeed);\r\n                    }\r\n\r\n                    startTime = updatedPositions[0].time;\r\n                    stopTime = updatedPositions[updatedPositions.length - 1].time;\r\n                }\r\n\r\n                if (totalDistance === 0) {\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var previuos_next = [];\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        totalDistance += new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n                    }\r\n                }\r\n\r\n                startTime = new Date(startTime).toISOString();\r\n                stopTime = new Date(stopTime).toISOString();\r\n\r\n                var czml = [{\r\n                    \"id\": \"document\",\r\n                    \"name\": \"CZML Model\",\r\n                    \"version\": \"1.0\"\r\n                }, {\r\n                    \"id\": \"path\",\r\n                    \"name\": name,\r\n                    \"availability\": startTime + \"/\" + stopTime,\r\n                    \"position\": {\r\n                        \"epoch\": startTime,\r\n                        \"cartographicRadians\": updatedPositions.map(function (updatedPosition, i) {\r\n                            return layout === ol.geom.GeometryLayout.XYZM ? [new Date(coordinates[i][3]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                layout === ol.geom.GeometryLayout.XYM ? [new Date(coordinates[i][2]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                    [new Date(updatedPosition.time).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height];\r\n                        }).reduce(function (prev, curr) {\r\n                            return prev.concat(curr);\r\n                        })\r\n                    },\r\n                    \"point\": {\r\n                        \"heightReference\": \"CLAMP_TO_GROUND\",\r\n                        \"pixelSize\": pointStyle.radius,\r\n                        \"color\": {\r\n                            \"rgba\": pointStyle.fillColor\r\n                        },\r\n                        \"outlineColor\": {\r\n                            \"rgba\": pointStyle.strokeColor\r\n                        },\r\n                        \"outlineWidth\": pointStyle.strokeWidth\r\n                    }\r\n                }];\r\n\r\n                resolve({ czml: czml, totalDistance: totalDistance, coordinates2D: coordinates });\r\n            });\r\n        });\r\n    };\r\n\r\n    const CameraControls = function (parent) {\r\n        var self = this;\r\n\r\n        self.parent = parent;\r\n\r\n        var outHandler = function (e) {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = false;\r\n        };\r\n        var inHandler = function () {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = true;\r\n            self.lastFocused = performance.now();\r\n\r\n            if (self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                self.div.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n            }\r\n        };\r\n\r\n        var moveStartHandler = function () {\r\n            var self = this;\r\n            self.moving = true;\r\n        };\r\n        var moveEndHandler = function () {\r\n            var self = this;\r\n            self.moving = false;\r\n        };\r\n        var postRenderHandler = function () {\r\n            var self = this;\r\n            var view = self.parent;\r\n\r\n            if (self.parent.view3D.isLoadingTiles.call(self.parent))\r\n                self.customCollisionDetection();\r\n\r\n            var camera = self.getCamera();\r\n            var position = camera.positionCartographic;\r\n\r\n            if (self.moving) {\r\n\r\n                cssRotate(self.tiltIndicator, camera.pitch);\r\n                cssRotate(self.rotateIndicator, -camera.heading);\r\n\r\n                self.disableRotate();\r\n                self.disableTilt(5);\r\n\r\n                if (view.view3D.crs !== view.view3D.view2DCRS) {\r\n                    self._coordsXY = TC.Util.reproject([Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)], view.view3D.crs, view.view3D.view2DCRS);\r\n                } else {\r\n                    self._coordsXY = [Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)];\r\n                }\r\n\r\n                view.mapView.setCenter(self._coordsXY);\r\n                view.mapView.setResolution(calcResolutionForDistance.call(view, position.height, position.latitude));\r\n\r\n                //view.mapView.setRotation(-camera.heading);\r\n            }\r\n\r\n            // flacunza: calculamos el polígono de FOV para dibujar en el mapa de situación\r\n            // Lo calculamos aunque no nos estemos moviendo porque el terreno puede estar cargándose\r\n            if (self._coordsXY) {\r\n                view._ovMap = view._ovMap || view.map.getControlsByClass('TC.control.OverviewMap')[0];\r\n                if (view._ovMap) {\r\n                    view._ovMap.renderPromise().then(function () {\r\n                        var scene = view.viewer.scene;\r\n                        var canvas = scene.canvas;\r\n                        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n                        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n                        var fovCoords = [\r\n                            bottomLeft,\r\n                            bottomRight,\r\n                            new Cesium.Cartesian2(canvas.clientWidth - 1, 0),\r\n                            new Cesium.Cartesian2(0, 0)\r\n                        ].map(function (elm) {\r\n                            return pickMapCoords.call(view, elm);\r\n                        }).filter(function (elm) {\r\n                            return elm !== null;\r\n                        });\r\n                        if (fovCoords.length && fovCoords.length < 4) { // Vemos horizonte\r\n                            // flacunza: Si vemos horizonte no tenemos puntos de terreno para las esquinas superiores, \r\n                            // por eso intentamos calcular unos puntos \"en el infinito\".\r\n                            var farCoordsLeft = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[0],\r\n                                bottomPixel: bottomLeft,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            var farCoordsRight = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[1],\r\n                                bottomPixel: bottomRight,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            if (farCoordsLeft && farCoordsRight) {\r\n                                fovCoords[2] = farCoordsRight;\r\n                                fovCoords[3] = farCoordsLeft;\r\n                            }\r\n\r\n                        }\r\n                        view._ovMap.wrap.draw3DCamera({ position: self._coordsXY, heading: camera.heading, fov: fovCoords });\r\n                    });\r\n                }\r\n            }\r\n\r\n        };\r\n        var cssRotate = function (element, angle) {\r\n            var coord = element.getBBox();\r\n            value = 'rotate(' + Cesium.Math.toDegrees(angle) + ' ' + (coord.x + (coord.width / 2)) + ' ' + (coord.y + (coord.height / 2)) + ')';\r\n            document.getElementsByClassName(element.className.baseVal)[0].setAttribute('transform', value);\r\n        };\r\n\r\n        self.outControlsEvents = TC.Util.detectMouse() ? ['mouseleave'] : ['touchleave', 'touchend'];\r\n        self.outControls = outHandler.bind(self);\r\n\r\n        self.inControlsEvents = TC.Util.detectMouse() ? ['mouseenter'] : ['touchmove', 'touchstart'];\r\n        self.inControls = inHandler.bind(self);\r\n\r\n        self.moveStart = moveStartHandler.bind(self);\r\n        self.moveEnd = moveEndHandler.bind(self);\r\n        self.postRender = postRenderHandler.bind(self);\r\n\r\n        self.selectors = {\r\n            tilt: '-cm-tilt',\r\n            rotate: '-cm-rotate',\r\n            indicator: '-indicator',\r\n            leftArrow: '-left',\r\n            rightArrow: '-right',\r\n            downArrow: '-down',\r\n            upArrow: '-up'\r\n        };\r\n\r\n        self.MIN_TILT = Cesium.Math.toRadians(-89);\r\n        self.MAX_TILT = Cesium.Math.toRadians(-1);\r\n\r\n        self.render();\r\n    };\r\n    CameraControls.prototype.bind = function () {\r\n        var self = this;\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.addEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.addEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.addEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.inControls);\r\n        });\r\n\r\n        function setOpacity() {\r\n            if (!self.lastFocused)\r\n                self.lastFocused = performance.now();\r\n\r\n            var progress = performance.now() - self.lastFocused;\r\n            if (progress > 5000 && self.isFocusingCameraCtrls !== true) {\r\n                if (!self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                    self.div.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                }\r\n            }\r\n\r\n            self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n        }\r\n        self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n    };\r\n    CameraControls.prototype.unbind = function () {\r\n        var self = this;\r\n\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.removeEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.removeEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.removeEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.inControls);\r\n        });\r\n        window.cancelAnimationFrame(self.rAFInOutControls);\r\n        self.lastFocused = undefined;\r\n        self.rAFInOutControls = undefined;\r\n    };\r\n    CameraControls.prototype.getCamera = function () {\r\n        var self = this;\r\n\r\n        return self.parent.viewer.scene.camera;\r\n    };\r\n    CameraControls.prototype.getCameraState = function () {\r\n        var self = this;\r\n\r\n        if (self.parent.viewer) {\r\n            var camera = self.parent.viewer.scene.camera;\r\n            var cameraPosition = camera.positionCartographic;\r\n\r\n            var bottomCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottomCenter) {\r\n                var distance = Cesium.Cartesian3.distance(camera.position, bottomCenter);\r\n\r\n                return {\r\n                    cp: [cameraPosition.longitude, cameraPosition.latitude, cameraPosition.height],\r\n                    chpr: [camera.heading, camera.pitch, camera.roll],\r\n                    bcpd: distance\r\n                };\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.render = function () {\r\n        var self = this;\r\n\r\n        if (self.div) {\r\n            self.div.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.bind();\r\n        }\r\n        else {\r\n            self.parent.getRenderedHtml(self.parent.CLASS + '-cm-ctls', {}, function (html) {\r\n                // contenedor controles\r\n                self.div = document.createElement('div');\r\n                self.div.classList.add(self.parent.CLASS + '-cm-ctls');\r\n                self.div.innerHTML = html;\r\n                self.parent.map.div.appendChild(self.div);\r\n\r\n\r\n                // tilt\r\n                var tiltSelector = '.' + self.parent.CLASS + self.selectors.tilt;\r\n\r\n                self.tiltIndicatorInner = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.tiltIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetTilt.bind(self));\r\n\r\n                self.tiltIndicator = self.div.querySelector(tiltSelector + '-indicator');\r\n\r\n                self.tiltIndicatorOuterCircle = self.div.querySelector(tiltSelector + '-outer-circle');\r\n                self.tiltIndicatorOuterShellCircle = self.div.querySelector(tiltSelector + '-outer-shell-circle');\r\n\r\n                self.tiltIndicatorCircle = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.tiltIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingTilt.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.tiltUp = self.div.querySelector(tiltSelector + self.selectors.upArrow);\r\n                self.tiltUp.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                    self.tiltUpMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, +5);\r\n\r\n                    self.tiltUpInterval = setInterval(function () {\r\n                        if (!self.isTiltUpDisabled) self.tilt.call(self, +5);\r\n                        else self.tiltUpMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltUpMouseUpFunction = function () {\r\n                        clearInterval(self.tiltUpInterval);\r\n                        self.tiltUpInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                        self.tiltUpMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // right\r\n                self.tiltDown = self.div.querySelector(tiltSelector + self.selectors.downArrow);\r\n                self.tiltDown.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                    self.tiltDownMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, -5);\r\n\r\n                    self.tiltDownInterval = setInterval(function () {\r\n                        if (!self.isTiltDownDisabled) self.tilt.call(self, -5);\r\n                        else self.tiltDownMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltDownMouseUpFunction = function () {\r\n                        clearInterval(self.tiltDownInterval);\r\n                        self.tiltDownInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                        self.tiltDownMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // rotation\r\n                var rotateSelector = '.' + self.parent.CLASS + self.selectors.rotate;\r\n\r\n                self.rotateIndicatorInner = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.rotateIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetRotation.bind(self));\r\n\r\n                self.rotateIndicator = self.div.querySelector(rotateSelector + '-indicator');\r\n\r\n                self.rotateIndicatorOuterCircle = self.div.querySelector(rotateSelector + '-outer-circle');\r\n                self.rotateIndicatorOuterShellCircle = self.div.querySelector(rotateSelector + '-outer-shell-circle');\r\n\r\n                self.rotateIndicatorCircle = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.rotateIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingRotate.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.rotateLeft = self.div.querySelector(rotateSelector + self.selectors.leftArrow);\r\n                self.rotateLeft.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                    self.rotateLeftMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, -15);\r\n\r\n                    self.rotateLeftInterval = setInterval(function () {\r\n                        self.rotate.call(self, -15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateLeftMouseUpFunction = function () {\r\n                        clearInterval(self.rotateLeftInterval);\r\n                        self.rotateLeftInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                        self.rotateLeftMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.rotateRight = self.div.querySelector(rotateSelector + self.selectors.rightArrow);\r\n                self.rotateRight.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                    self.rotateRightMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, +15);\r\n\r\n                    self.rotateRightInterval = setInterval(function () {\r\n                        self.rotate.call(self, +15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateRightMouseUpFunction = function () {\r\n                        clearInterval(self.rotateRightInterval);\r\n                        self.rotateRightInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                        self.rotateRightMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.bind();\r\n\r\n            }.bind(this));\r\n        }\r\n    };\r\n    CameraControls.prototype.disableTilt = function (angle) {\r\n        var self = this;\r\n\r\n        var theta = Cesium.Math.toRadians(angle);\r\n        var tilt = self.getCamera().pitch;\r\n\r\n        self.isTiltDownDisabled = (tilt + -theta) < self.MIN_TILT;\r\n        self.isTiltUpDisabled = (tilt + theta) > self.MAX_TILT;\r\n\r\n        // left\r\n        self.tiltUp.disabled = self.isTiltUpDisabled;\r\n        self.tiltUp.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltUpDisabled);\r\n\r\n\r\n        // right\r\n        self.tiltDown.disabled = self.isTiltDownDisabled;\r\n        self.tiltDown.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltDownDisabled);\r\n    };\r\n    CameraControls.prototype.disableRotate = function () {\r\n        var self = this;\r\n\r\n        var isDisable = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var canvas = scene.canvas;\r\n        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n        var fovCoords = [bottomLeft, bottomRight, new Cesium.Cartesian2(canvas.clientWidth - 1, 0), new Cesium.Cartesian2(0, 0)]\r\n            .map(function (elm) {\r\n                return pickMapCoords.call(this, elm);\r\n            }.bind(self.parent))\r\n            .filter(function (elm) {\r\n                return elm !== null;\r\n            });\r\n\r\n        if (fovCoords.length && fovCoords.length >= 2) {\r\n            isDisable = false;\r\n        }\r\n\r\n        // reset\r\n        self.rotateIndicatorInner.disabled = isDisable;\r\n\r\n        // left\r\n        self.rotateLeft.disabled = isDisable;\r\n        self.rotateLeft.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        // right\r\n        self.rotateRight.disabled = isDisable;\r\n        self.rotateRight.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        return isDisable;\r\n    };\r\n    CameraControls.prototype.tilt = function (angle) {\r\n        var self = this;\r\n\r\n        self.disableTilt(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateUp(Cesium.Math.toRadians(angle));\r\n        } else {\r\n            if (pickCenterPoint(self.parent.viewer.scene) == undefined) {\r\n                if (angle > 0) self.getCamera().lookUp();\r\n                else self.getCamera().lookDown();\r\n            }\r\n\r\n            if ((angle >= Cesium.Math.PI_OVER_TWO && self.isTiltUpDisabled) ||\r\n                (angle <= -Cesium.Math.PI_OVER_TWO && self.isTiltDownDisabled)) {\r\n                return;\r\n            }\r\n\r\n            var _angle = Cesium.Math.toRadians(angle);\r\n            var pivot = pickCenterPoint(self.parent.viewer.scene);\r\n            if (pivot) {\r\n                var transform = Cesium.Matrix4.fromTranslation(pivot);\r\n                self.parent.view3D.rotateAroundAxis(self.getCamera(), -_angle, self.getCamera().right, transform, { duration: 100 });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.rotate = function (angle) {\r\n        var self = this;\r\n\r\n        angle = Cesium.Math.toRadians(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateRight(-angle);\r\n        } else {\r\n            var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottom) {\r\n                setHeadingUsingBottomCenter(self.parent.viewer.scene, angle, bottom, {\r\n                    duration: 100\r\n                });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.draggingTilt = function (tiltElement, cursorVector) {\r\n        var self = this;\r\n\r\n        self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n        self.tiltMouseMoveFunction = undefined;\r\n        self.tiltMouseUpFunction = undefined;\r\n\r\n        self.isTilting = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var pivot = pickCenterPoint(scene);\r\n        if (!pivot) {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = true;\r\n        } else {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(pivot, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = false;\r\n        }\r\n\r\n        self.startCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n        camera.lookAtTransform(self.tiltFrame);\r\n\r\n        self.initialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n\r\n        camera.lookAtTransform(oldTransform);\r\n\r\n        self.tiltMouseMoveFunction = function (e) {\r\n            var self = this;\r\n\r\n            scene = self.parent.viewer.scene;\r\n            camera = scene.camera;\r\n\r\n            var tiltRectangle = tiltElement.getBoundingClientRect();\r\n            center = new Cesium.Cartesian2((tiltRectangle.right - tiltRectangle.left) / 2.0, (tiltRectangle.bottom - tiltRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - tiltRectangle.left, e.clientY - tiltRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n            console.log('Entra: ' + vector.toString());\r\n\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n            var angleDifference = angle - self.startCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.initialCameraAngle - angleDifference);\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.tiltFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                var theta = newCameraAngle - currentCameraAngle;\r\n\r\n                var tilt = camera.pitch;\r\n                tilt += theta;\r\n\r\n                if (tilt < self.MIN_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MIN_TILT);\r\n                } else if (tilt > self.MAX_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MAX_TILT);\r\n                } else {\r\n                    camera.rotate(camera.right, -theta);\r\n                }\r\n\r\n                self.disableTilt(5);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n            } catch (e) {\r\n                self.tiltMouseUpFunction();\r\n            }\r\n\r\n\r\n        }.bind(self);\r\n\r\n        self.tiltMouseUpFunction = function (e) {\r\n            self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            self.isTilting = false;\r\n            document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n            self.tiltMouseMoveFunction = undefined;\r\n            self.tiltMouseUpFunction = undefined;\r\n        };\r\n\r\n        document.addEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.draggingRotate = function (rotateElement, cursorVector) {\r\n        var self = this;\r\n\r\n        document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n        self.rotateMouseMoveFunction = undefined;\r\n        self.rotateMouseUpFunction = undefined;\r\n\r\n        self.rotateMouseMoveFunction = function (e) {\r\n            var rotateRectangle = rotateElement.getBoundingClientRect();\r\n            var center = new Cesium.Cartesian2((rotateRectangle.right - rotateRectangle.left) / 2.0, (rotateRectangle.bottom - rotateRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - rotateRectangle.left, e.clientY - rotateRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n\r\n            var angleDifference = angle - self.rotateInitialCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.rotateInitialCameraAngle - angleDifference);\r\n\r\n            camera = self.parent.viewer.scene.camera;\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.rotateFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                camera.rotateRight(newCameraAngle - currentCameraAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n            } catch (e) {\r\n                self.rotateMouseUpFunction();\r\n            }\r\n        };\r\n\r\n        self.rotateMouseUpFunction = function (e) {\r\n            self.isRotating = false;\r\n\r\n            self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n            self.rotateMouseMoveFunction = undefined;\r\n            self.rotateMouseUpFunction = undefined;\r\n        };\r\n\r\n        if (self.disableRotate()) {\r\n            self.rotateMouseUpFunction();\r\n            return;\r\n        }\r\n\r\n        self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        self.isRotating = true;\r\n        self.rotateInitialCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var viewCenter = pickCenterPoint(self.parent.viewer.scene);\r\n        if (viewCenter == null || viewCenter == undefined) {\r\n            viewCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (viewCenter == null || viewCenter == undefined) {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = true;\r\n            } else {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = false;\r\n            }\r\n        } else {\r\n            self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.rotateIsLook = false;\r\n        }\r\n\r\n        try {\r\n            var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n            camera.lookAtTransform(self.rotateFrame);\r\n            self.rotateInitialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n            self.rotateInitialCameraDistance = Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(camera.position.x, camera.position.y, 0.0));\r\n            camera.lookAtTransform(oldTransform);\r\n        } catch (e) {\r\n            self.rotateMouseUpFunction();\r\n        }\r\n\r\n        document.addEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.resetTilt = function () {\r\n        var self = this;\r\n        // lo dejamos como al principio a 50 grados\r\n        var angle = -self.getCamera().pitch - Cesium.Math.toRadians(50);\r\n        self.tilt(Cesium.Math.toDegrees(angle));\r\n    };\r\n    CameraControls.prototype.resetRotation = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var currentRotation;\r\n            currentRotation = -self.getCamera().heading;\r\n\r\n            while (currentRotation < -Math.PI) {\r\n                currentRotation += 2 * Math.PI;\r\n            }\r\n            while (currentRotation > Math.PI) {\r\n                currentRotation -= 2 * Math.PI;\r\n            }\r\n\r\n            if (!options)\r\n                resolve();\r\n            else {\r\n                options.callback = function () {\r\n                    resolve();\r\n                };\r\n            }\r\n\r\n            if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n                var camera = self.getCamera();\r\n                camera.rotate(Cesium.Cartesian3.fromDegrees(0, 90), currentRotation);\r\n            } else {\r\n                var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n                if (bottom) {\r\n                    setHeadingUsingBottomCenter(self.parent.viewer.scene, currentRotation, bottom, options);\r\n                }\r\n            }\r\n        });\r\n    };\r\n    CameraControls.prototype.customCollisionDetection = function () {\r\n        var self = this;\r\n\r\n        var scratchAdjustHeightTransform = new Cesium.Matrix4();\r\n        var scratchAdjustHeightCartographic = new Cesium.Cartographic();\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = self.parent.viewer.scene.camera;\r\n\r\n        var screenSpaceCameraController = scene.screenSpaceCameraController;\r\n        var enableCollisionDetection = screenSpaceCameraController.enableCollisionDetection;\r\n        var minimumCollisionTerrainHeight = screenSpaceCameraController.minimumCollisionTerrainHeight;\r\n        var minimumZoomDistance = screenSpaceCameraController.minimumZoomDistance;\r\n        var globe = scene.globe;\r\n\r\n        var ellipsoid = globe.ellipsoid;\r\n        var projection = scene.mapProjection;\r\n\r\n        var transform;\r\n        var mag;\r\n        if (!Cesium.Matrix4.equals(camera.transform, Cesium.Matrix4.IDENTITY)) {\r\n            transform = Cesium.Matrix4.clone(camera.transform, scratchAdjustHeightTransform);\r\n            mag = Cesium.Cartesian3.magnitude(camera.position);\r\n            camera._setTransform(Cesium.Matrix4.IDENTITY);\r\n        }\r\n\r\n        var cartographic = scratchAdjustHeightCartographic;\r\n        ellipsoid.cartesianToCartographic(camera.position, cartographic);\r\n\r\n        var heightUpdated = false;\r\n        if (cartographic.height < minimumCollisionTerrainHeight) {\r\n            var height = globe.getHeight(cartographic);\r\n            if (height !== undefined && height !== null) {\r\n                height += minimumZoomDistance;\r\n                if (cartographic.height < height) {\r\n                    cartographic.height = height;\r\n                    ellipsoid.cartographicToCartesian(cartographic, camera.position);\r\n                    heightUpdated = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (transform !== undefined && transform !== null) {\r\n            camera._setTransform(transform);\r\n            if (heightUpdated) {\r\n                Cesium.Cartesian3.normalize(camera.position, camera.position);\r\n                Cesium.Cartesian3.negate(camera.position, camera.direction);\r\n                Cesium.Cartesian3.multiplyByScalar(camera.position, Math.max(mag, minimumZoomDistance), camera.position);\r\n                Cesium.Cartesian3.normalize(camera.direction, camera.direction);\r\n                Cesium.Cartesian3.cross(camera.direction, camera.up, camera.right);\r\n                Cesium.Cartesian3.cross(camera.right, camera.direction, camera.up);\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.limitCameraToInitExtent = function () {\r\n        var self = this;\r\n\r\n        var pos = self.viewer.camera.positionCartographic.clone();\r\n\r\n        if (!(pos.longitude >= self.initExtent.west &&\r\n            pos.longitude <= self.initExtent.east &&\r\n            pos.latitude >= self.initExtent.south &&\r\n            pos.latitude <= self.initExtent.north)) {\r\n            // add a padding based on the camera height\r\n            var maxHeight = self.viewer.scene.screenSpaceCameraController.maximumZoomDistance;\r\n            var padding = pos.height * 0.05 / maxHeight;\r\n            pos.longitude = Math.max(self.initExtent.west - padding, pos.longitude);\r\n            pos.latitude = Math.max(self.initExtent.south - padding, pos.latitude);\r\n            pos.longitude = Math.min(self.initExtent.east + padding, pos.longitude);\r\n            pos.latitude = Math.min(self.initExtent.north + padding, pos.latitude);\r\n            self.viewer.camera.setView({\r\n                destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(pos),\r\n                orientation: {\r\n                    heading: self.viewer.camera.heading,\r\n                    pitch: self.viewer.camera.pitch\r\n                }\r\n            });\r\n        }\r\n\r\n        // Set the minimumZoomDistance according to the camera height\r\n        self.viewer.scene.screenSpaceCameraController.minimumZoomDistance = pos.height > 1800 ? 400 : 200;\r\n    };\r\n\r\n    var TwoDLinkedFeatureInfo = function (map) {\r\n        var pending = false;\r\n        var marker = null;\r\n        var ctlResultsPanel = null;\r\n        var ctlFeatureInfo = null;\r\n\r\n        var savedMode;\r\n        var map2DgetResolutionFN = map.map.getResolution;\r\n\r\n        var getResultsPanelCtl = function (ctlFeatureInfo) {\r\n\r\n            if (ctlResultsPanel) {\r\n                return Promise.resolve();\r\n            } else {\r\n\r\n                const resultsPanelOptions = {\r\n                    \"content\": \"table\",\r\n                    \"titles\": {\r\n                        \"main\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\"),\r\n                        \"max\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\")\r\n                    }\r\n                };\r\n\r\n                var addControlPromise;\r\n                var controlContainer = map.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                if (controlContainer) {\r\n                    resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                    addControlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    map.map.div.appendChild(resultsPanelOptions.div);\r\n                    addControlPromise = map.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                return addControlPromise.then(function (control) {\r\n                    control.caller = ctlFeatureInfo;\r\n                    ctlResultsPanel = control;\r\n                    ctlFeatureInfo.resultsPanel = ctlResultsPanel;\r\n                });\r\n            }\r\n        };\r\n        var setMarker = function (pickedPosition) {\r\n            if (!marker) {\r\n                var markerStyle = TC.control.FeatureInfoCommons.prototype.markerStyle;\r\n\r\n                var billboard = {\r\n                    position: pickedPosition,\r\n                    billboard: { /* revisar: no está bien la URL de la imagen - también revisar el GFI que salta en móvil sólo con navegar */\r\n                        image: TC.Util.getBackgroundUrlFromCss(map.CLASS + '-marker'),\r\n                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                    }\r\n                };\r\n\r\n                marker = map.view3D.addNativeFeature.call(map, billboard);\r\n\r\n            } else {\r\n                marker.position = pickedPosition;\r\n            }\r\n\r\n            map.viewer.scene.requestRender();\r\n        };\r\n        var removeMarker = function () {\r\n            map.view3D.removeFeature.call(map, marker);\r\n            marker = null;\r\n        };\r\n\r\n        ctlFeatureInfo = map.map.getControlsByClass(TC.control.FeatureInfo)[0];\r\n        if (ctlFeatureInfo) {\r\n\r\n            savedMode = ctlFeatureInfo.displayMode;\r\n\r\n            getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                ctlFeatureInfo.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);\r\n\r\n                map.map.on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                    if (e.control === ctlFeatureInfo.getDisplayControl()) {\r\n                        if (!ctlFeatureInfo.querying) {\r\n                            removeMarker();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        this.clear = function () {\r\n            ctlFeatureInfo.closeResults();\r\n            removeMarker();\r\n        };\r\n        this.reset = function () {\r\n            this.clear();\r\n            ctlFeatureInfo.setDisplayMode(savedMode);\r\n            map.map.getResolution = map2DgetResolutionFN;\r\n        };\r\n        this.send = function (pickedPosition) {\r\n            return new Promise(function (resolve, reject) {\r\n                pending = true;\r\n\r\n                if (ctlFeatureInfo.displayMode !== TC.Consts.infoContainer.RESULTS_PANEL) {\r\n                    ctlFeatureInfo.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);\r\n                }\r\n\r\n                if (ctlFeatureInfo.resultsPanel) {\r\n                    ctlFeatureInfo.resultsPanel.close();\r\n                }\r\n\r\n                if (!map.waiting)\r\n                    map.waiting = map.map.getLoadingIndicator().addWait();\r\n\r\n                setMarker(pickedPosition);\r\n\r\n                getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                    var pickedLocation = Cesium.Ellipsoid.WGS84.cartesianToCartographic(pickedPosition);\r\n\r\n                    var reprojected;\r\n                    if (map.view3D.crs !== map.view3D.view2DCRS) {\r\n                        reprojected = TC.Util.reproject([Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)], map.view3D.crs, map.view3D.view2DCRS);\r\n                    } else {\r\n                        reprojected = [Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)];\r\n                    }\r\n\r\n\r\n                    var radius = (map.map.options.pixelTolerance || TC.Cfg.pixelTolerance);\r\n                    var mapWidth = 2 * radius + 1;\r\n\r\n                    var tilesRendered = map.viewer.scene.globe._surface._tilesToRender;\r\n                    var pickedTile;\r\n\r\n                    for (var textureIndex = 0; !pickedTile && textureIndex < tilesRendered.length; ++textureIndex) {\r\n                        var tile = tilesRendered[textureIndex];\r\n                        if (Cesium.Rectangle.contains(tile.rectangle, pickedLocation)) {\r\n                            pickedTile = tile;\r\n                        }\r\n                    }\r\n\r\n                    if (!pickedTile) {\r\n                        resolve();\r\n                        return;\r\n                    }\r\n\r\n                    var imageryTiles = pickedTile.data.imagery;\r\n                    for (var i = imageryTiles.length - 1; i >= 0; --i) {\r\n                        var terrainImagery = imageryTiles[i];\r\n                        var imagery = terrainImagery.readyImagery;\r\n                        if (!imagery) {\r\n                            resolve();\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    var nativeRectangle = pickedTile.tilingScheme.tileXYToNativeRectangle(pickedTile.x, pickedTile.y, pickedTile.level);\r\n\r\n                    var readyImageryToGetNativeRectangle = (imageryTiles.filter(function (imagery) {\r\n                        return imagery.readyImagery.imageryLayer.isBaseLayer();\r\n                    })[0] || {}).readyImagery;\r\n\r\n                    map.map.getResolution = function () {\r\n\r\n                        var west_south = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.west, nativeRectangle.south], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.west, nativeRectangle.south];\r\n                        var east_north = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.east, nativeRectangle.north], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.east, nativeRectangle.north];\r\n\r\n                        var xResolution = (east_north[0] - west_south[0]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileWidth || 256);\r\n                        var yResolution = (east_north[1] - west_south[1]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileHeight || 256);\r\n\r\n                        return Math.max(xResolution, yResolution);\r\n\r\n                    }.bind(map, readyImageryToGetNativeRectangle, nativeRectangle);\r\n\r\n                    map.map.one(TC.Consts.event.NOFEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    }.bind(ctlFeatureInfo));\r\n\r\n                    map.map.one(TC.Consts.event.FEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    map.map.on(TC.Consts.event.FEATURECLICK, function (e) {\r\n                        removeMarker();\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    savedIsActive = ctlFeatureInfo.isActive;\r\n                    ctlFeatureInfo.isActive = true;\r\n                    ctlFeatureInfo.beforeRequest({\r\n                        xy: [0, 0]\r\n                    }); // Es irrelevante dónde va a poner el marcador, no se va a ver                \r\n\r\n                    ctlFeatureInfo.callback(reprojected);\r\n                });\r\n            });\r\n        };\r\n        this.get2DMarker = function () {\r\n            return ctlFeatureInfo.filterFeature;\r\n        };\r\n        this.isPending = function () {\r\n            return pending;\r\n        };\r\n    };\r\n\r\n    var RasterConverter = function (crsPattern) {\r\n        this.layerCrs = null;\r\n\r\n        var crsPattern = crsPattern;\r\n\r\n        var paths = {\r\n            CRS: [\"Capability\", \"Layer\", \"CRS\"],\r\n            TILEMATRIXSET: [\"Contents\", \"TileMatrixSet\", \"Identifier\"],\r\n            TILEMATRIXSETLABELS: [\"Contents\", \"TileMatrixSet\"]\r\n        };\r\n        var getOfPath = function (obj, p, i) {\r\n            if (i < p.length - 1) {\r\n                if (obj.hasOwnProperty(p[i]))\r\n                    return getOfPath(obj[p[i]], p, ++i);\r\n                else return null;\r\n            } else {\r\n                if (obj instanceof Array) {\r\n                    var _obj = [];\r\n                    for (var a = 0; a < obj.length; a++) {\r\n                        if (obj[a].hasOwnProperty(p[i]))\r\n                            _obj.push(obj[a][p[i]]);\r\n                    }\r\n\r\n                    return _obj;\r\n                } else return obj[p[i]];\r\n            }\r\n        };\r\n        var getTileMatrixSetLabelByLayerOnCapabilities = function (layer, crs) {\r\n            if ((capsURL = TC.Util.isOnCapabilities(layer.url))) {\r\n                if ((caps = TC.capabilities[capsURL])) {\r\n                    var tileMatrixSet = getOfPath(caps, paths.TILEMATRIXSETLABELS, 0);\r\n                    for (var a = 0; a < tileMatrixSet.length; a++) {\r\n                        if (TC.Util.CRSCodesEqual(crs, tileMatrixSet[a][\"SupportedCRS\"])) {\r\n                            return { id: tileMatrixSet[a].Identifier, labels: getOfPath(tileMatrixSet[a], [\"TileMatrix\", \"Identifier\"], 0) };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return null;\r\n        };\r\n\r\n        var wmtsLayer = function (layer) {\r\n            const self = this;\r\n            return new Promise(function (resolve, reject) {\r\n                var tileMatrixSetLabels = getTileMatrixSetLabelByLayerOnCapabilities(layer, self.layerCrs);\r\n\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.options.urlPattern\r\n                    }, layer),\r\n                    layer: layer.layerNames,\r\n                    style: 'default',\r\n                    format: layer.format || layer.options.format,\r\n                    tileMatrixSetID: tileMatrixSetLabels.id,\r\n                    tileMatrixLabels: tileMatrixSetLabels.labels,\r\n                    tilingScheme: new Cesium.GeographicTilingScheme()\r\n                };\r\n\r\n                resolve(new Cesium.WebMapTileServiceImageryProvider(options));\r\n            });\r\n        }\r\n\r\n        var wmsLayer = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.url\r\n                    }, layer),\r\n                    layers: layer.layerNames,\r\n                    parameters: {\r\n                        version: \"1.3.0\",\r\n                        transparent: true,\r\n                        format: layer.format || layer.options.format\r\n                    }\r\n                };\r\n\r\n                var bindEXBBox = function () {\r\n                    var bbox = [];\r\n                    if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                        if (layer.names.length > 0) {\r\n                            var names = layer.names.slice(0);\r\n                            var _getEXBBox = function _getEXBBox(nodes, name) {\r\n                                if (nodes) {\r\n                                    for (var i = 0; i < nodes.length; i++) {\r\n                                        var n = nodes[i];\r\n                                        if (layer.compareNames(layer.wrap.getName(n), name)) {\r\n                                            return n.EX_GeographicBoundingBox;\r\n                                        }\r\n                                    }\r\n\r\n                                    return _getEXBBox(n.Layer, name);\r\n                                }\r\n                            };\r\n                            while (names.length > 0) {\r\n                                var exBBox = _getEXBBox([layer.capabilities.Capability.Layer], names.pop());\r\n                                if (exBBox !== null) {\r\n                                    bbox.push(exBBox);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    return bbox;\r\n                };\r\n                var exBoundingBox = bindEXBBox();\r\n\r\n                if (exBoundingBox) {\r\n                    layer.geoBBox = exBoundingBox;\r\n                }\r\n\r\n                resolve(new Cesium.WebMapServiceImageryProvider(options));\r\n            });\r\n        };\r\n\r\n        var CustomResource;\r\n        var defineCustomResource = function () {\r\n            /* tengo que sobrescribir porque no valida nada... \r\n            Desde la version 1.42 han cambiado la definición de un proxy en las capas raster: si configuras con proxy, pide directamente desde el proxy y si da error no gestiona nada, \r\n            y si no configuras proxy, pide directamente sin tampoco gestionar los errores. Además la creación de una capa raster es síncrona, por lo que no encaja con el algoritmo de proxificación */\r\n            CustomResource = function (options, layer) {\r\n                Cesium.Resource.call(this, options);\r\n\r\n                this.layer = layer;\r\n            };\r\n            CustomResource.prototype.constructor = CustomResource;\r\n            CustomResource.prototype = Object.create(Cesium.Resource.prototype, {});\r\n            CustomResource.prototype.clone = function (result) {\r\n\r\n                var cloned = Cesium.Resource.prototype.clone.call(this, result);\r\n\r\n                if (!Cesium.defined(result)) {\r\n                    result = new CustomResource({\r\n                        url: this._url\r\n                    }, this.layer);\r\n                }\r\n\r\n                result._url = cloned._url;\r\n                result._queryParameters = cloned._queryParameters;\r\n                result._templateValues = cloned._templateValues;\r\n                result.headers = cloned.headers;\r\n                result.proxy = cloned.proxy;\r\n                result.retryCallback = cloned.retryCallback;\r\n                result.retryAttempts = cloned.retryAttempts;\r\n                result._retryCount = 0;\r\n\r\n                result.request = cloned.request;\r\n\r\n\r\n\r\n                return result;\r\n            };\r\n            CustomResource.prototype.fetchImage = customFetchImage;\r\n        };\r\n\r\n        /* inicio cesium Resource override */\r\n        var xhrBlobSupported = (function () {\r\n            try {\r\n                var xhr = new XMLHttpRequest();\r\n                xhr.open('GET', '#', true);\r\n                xhr.responseType = 'blob';\r\n                return xhr.responseType === 'blob';\r\n            } catch (e) {\r\n                return false;\r\n            }\r\n        })();\r\n\r\n        function checkAndResetRequest(request) {\r\n            if (request.state === Cesium.RequestState.ISSUED || request.state === Cesium.RequestState.ACTIVE) {\r\n                throw new Cesium.RuntimeError('The Resource is already being fetched.');\r\n            }\r\n\r\n            request.state = Cesium.RequestState.UNISSUED;\r\n            request.deferred = undefined;\r\n        }\r\n\r\n        function createImage(layer, url, crossOrigin, deferred) {\r\n            var getImage = function (url) {\r\n                var image = new Image();\r\n\r\n                image.onload = function (layer) {\r\n                    deferred.resolve(image);\r\n                }.bind(image, layer);\r\n\r\n                image.onerror = function (layer, e) {\r\n                    deferred.reject(e);\r\n                }.bind(image, layer);\r\n\r\n                if (crossOrigin) {\r\n                    if (Cesium.TrustedServers.contains(url)) {\r\n                        image.crossOrigin = 'use-credentials';\r\n                    } else {\r\n                        image.crossOrigin = '';\r\n                    }\r\n                }\r\n\r\n                image.src = url;\r\n            };\r\n\r\n            layer.getWebGLUrl.call(layer, url).then(getImage, function (e) {\r\n                deferred.reject(e);\r\n            });\r\n        };\r\n\r\n        function fetchImage(resource, allowCrossOrigin) {\r\n            var request = resource.request;\r\n            request.url = resource.url;\r\n            request.requestFunction = function () {\r\n                var url = resource.url;\r\n                var crossOrigin = false;\r\n\r\n                // data URIs can't have allowCrossOrigin set.\r\n                if (!resource.isDataUri && !resource.isBlobUri) {\r\n                    crossOrigin = resource.isCrossOriginUrl;\r\n                }\r\n\r\n                var deferred = Cesium.when.defer();\r\n\r\n                createImage(resource.layer, url, crossOrigin && allowCrossOrigin, deferred);\r\n\r\n                return deferred.promise;\r\n            };\r\n\r\n            var promise = Cesium.RequestScheduler.request(request);\r\n            if (!Cesium.defined(promise)) {\r\n                return;\r\n            }\r\n\r\n            return promise.otherwise(function (e) {\r\n                return Cesium.when.reject(e);\r\n            });\r\n        }\r\n\r\n        var customFetchImage = function (preferBlob, allowCrossOrigin) {\r\n            if (Cesium.defined(allowCrossOrigin)) {\r\n                Cesium.deprecationWarning('Resource.fetchImage.allowCrossOrigin', 'The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.');\r\n            }\r\n\r\n            preferBlob = Cesium.defaultValue(preferBlob, false);\r\n            allowCrossOrigin = Cesium.defaultValue(allowCrossOrigin, true);\r\n\r\n            checkAndResetRequest(this.request);\r\n\r\n            // We try to load the image normally if\r\n            // 1. Blobs aren't supported\r\n            // 2. It's a data URI\r\n            // 3. It's a blob URI\r\n            // 4. It doesn't have request headers and we preferBlob is false\r\n            if (!xhrBlobSupported || this.isDataUri || this.isBlobUri || (!this.hasHeaders && !preferBlob)) {\r\n                return fetchImage(this, allowCrossOrigin);\r\n            }\r\n\r\n            var blobPromise = this.fetchBlob();\r\n            if (!Cesium.defined(blobPromise)) {\r\n                return;\r\n            }\r\n\r\n            var generatedBlobResource;\r\n            var generatedBlob;\r\n            return blobPromise\r\n                .then(function (blob) {\r\n                    if (!Cesium.defined(blob)) {\r\n                        return;\r\n                    }\r\n                    generatedBlob = blob;\r\n                    var blobUrl = window.URL.createObjectURL(blob);\r\n                    generatedBlobResource = new Cesium.Resource({\r\n                        url: blobUrl\r\n                    });\r\n\r\n                    return fetchImage(generatedBlobResource);\r\n                })\r\n                .then(function (image) {\r\n                    if (!Cesium.defined(image)) {\r\n                        return;\r\n                    }\r\n                    window.URL.revokeObjectURL(generatedBlobResource.url);\r\n\r\n                    // This is because the blob object is needed for DiscardMissingTileImagePolicy\r\n                    // See https://github.com/AnalyticalGraphicsInc/cesium/issues/1353\r\n                    image.blob = generatedBlob;\r\n                    return image;\r\n                })\r\n                .otherwise(function (error) {\r\n                    if (Cesium.defined(generatedBlobResource)) {\r\n                        window.URL.revokeObjectURL(generatedBlobResource.url);\r\n                    }\r\n\r\n                    return Cesium.when.reject(error);\r\n                });\r\n        };\r\n        /* fin cesium Resource override */\r\n\r\n        this.convert = function (layer, map3DCRS) {\r\n            var csmLayer;\r\n\r\n            this.layerCrs = map3DCRS;\r\n\r\n            if (!CustomResource) { defineCustomResource(); }\r\n\r\n            switch (true) {\r\n                case TC.Consts.layerType.WMTS == layer.type:\r\n                    return wmtsLayer.call(this, layer);\r\n                case TC.Consts.layerType.WMS == layer.type:\r\n                    return wmsLayer.call(this, layer);\r\n                    break;\r\n            }\r\n        };\r\n    };\r\n    var FeatureConverter = function () {\r\n        var scene = null;\r\n        var toCesiumColor = function (hexStringColor, alpha) {\r\n            if (hexStringColor instanceof Array) {\r\n                hexStringColor = \"rgba(\" + hexStringColor[0] + \", \" + hexStringColor[1] + \", \" + hexStringColor[2] + \", \" + hexStringColor[3] + \")\";\r\n            }\r\n            var color = Cesium.Color.fromCssColorString(hexStringColor);\r\n            if (alpha !== undefined) {\r\n                return color.withAlpha(alpha);\r\n            }\r\n\r\n            return color;\r\n        }\r\n        var setStyleProperties = function (styles, properties, feature) {\r\n            for (var key in properties) { // recorremos el diccionario de propiedades que admitimos como estilo\r\n                var attr = styles[properties[key].prop];\r\n                if (attr !== undefined) {\r\n                    if (typeof (attr) === \"function\") { // si la propiedad del estilo es una función (como en el control de búsquedas) invocamos para obtener el valor\r\n                        var val = attr(feature);\r\n                        if (val) {\r\n                            properties[key].val = val;\r\n                        }\r\n                    } else {\r\n                        properties[key].val = attr; // obtenenemos el valor\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        var getPixelSize = function (coords) {\r\n            var rectangle;\r\n\r\n            if (coords.length == 1) {\r\n                var point = coords[0];\r\n                var delta = 1000;\r\n                var minx, miny, maxx, maxy;\r\n                minx = new Cesium.Cartesian3(point.x - delta, point.y, point.z);\r\n                miny = new Cesium.Cartesian3(point.x, point.y - delta, point.z);\r\n                maxx = new Cesium.Cartesian3(point.x + delta, point.y, point.z);\r\n                maxy = new Cesium.Cartesian3(point.x, point.y + delta, point.z);\r\n\r\n                rectangle = Cesium.Rectangle.fromCartesianArray([minx, miny, maxx, maxy], Cesium.Ellipsoid.WGS84);\r\n            } else {\r\n                rectangle = Cesium.Rectangle.fromCartesianArray(coords, Cesium.Ellipsoid.WGS84);\r\n            }\r\n\r\n            var neededCameraPosition = scene.camera.getRectangleCameraCoordinates(rectangle);\r\n            var distance = Cesium.Cartesian3.distance(neededCameraPosition, Cesium.BoundingSphere.fromPoints(coords).center);\r\n            var pixelSize = scene.camera.frustum.getPixelDimensions(scene.drawingBufferWidth, scene.drawingBufferHeight, distance, new Cesium.Cartesian2());\r\n            pixelSize = Math.max(pixelSize.x, pixelSize.y);\r\n            return Math.round(pixelSize) == 0 ? 1 : pixelSize;\r\n        };\r\n\r\n        var getFeatureStyle = function (feature) {\r\n            var self = this;\r\n            var styles;\r\n\r\n            if (!feature.layer || (feature.layer && !feature.layer.hasOwnProperty('styles'))) {\r\n                styles = TC.Defaults.styles;\r\n            } else {\r\n                styles = feature.layer.styles;\r\n            }\r\n\r\n            styles = styles[feature.STYLETYPE] == undefined ?\r\n                styles[(feature.STYLETYPE === \"polyline\" ? \"line\" : feature.STYLETYPE)] :\r\n                styles[(feature.STYLETYPE === \"multipolygon\" ? \"polygon\" : feature.STYLETYPE)];\r\n\r\n            styles = TC.Util.extend({}, styles, feature.options, feature.getStyle());\r\n\r\n            return styles;\r\n        }\r\n\r\n        function createLine(id, coords, options, callback) {\r\n            var entity = new Cesium.Entity({\r\n                name: id,\r\n                polyline: {\r\n                    positions: coords,\r\n                    width: options.width,\r\n                    material: options.material,\r\n                    clampToGround: true\r\n                }\r\n            });\r\n\r\n            callback(entity);\r\n        };\r\n\r\n        var circleConverter = function (feature) {\r\n            var self = this;\r\n            var circle = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            circle.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'fillColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            circle.geometryType = function (coords, options) {\r\n\r\n                return new Cesium.GroundPrimitive({\r\n                    releaseGeometryInstances: false,\r\n                    geometryInstances: new Cesium.GeometryInstance({\r\n                        id: feature.id,\r\n                        geometry: new Cesium.CircleGeometry({\r\n                            center: coords[0],\r\n                            radius: feature.geometry[1]\r\n                        }),\r\n                        attributes: {\r\n                            color: options.color\r\n                        }\r\n                    })\r\n                });\r\n\r\n                // Para obtener el contorno de círculo \r\n                //var radius = feature.geometry[1];\r\n                //var outlineEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius,\r\n                //    semiMajorAxis: radius,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var outerPositions = Cesium.Cartesian3.unpackArray(outlineEllipse.outerPositions);\r\n\r\n                //var outlineSize = getPixelSize(outerPositions);\r\n                //var metersPerPixel = scene.camera.getPixelSize(Cesium.BoundingSphere.fromPoints(outerPositions), scene.drawingBufferWidth, scene.drawingBufferHeight);\r\n                //var outlineInMeters = metersPerPixel * outlineSize;\r\n\r\n                //var outlineHoleEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius - outlineInMeters,\r\n                //    semiMajorAxis: radius - outlineInMeters,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var innerPositions = Cesium.Cartesian3.unpackArray(outlineHoleEllipse.outerPositions);\r\n\r\n                //var outlineCircleGeom = new Cesium.GroundPrimitive({\r\n                //    geometryInstances: new Cesium.GeometryInstance({\r\n                //        id: feature.id + 'outline',\r\n                //        geometry: new Cesium.PolygonGeometry({\r\n                //            polygonHierarchy: new Cesium.PolygonHierarchy(outerPositions, [new Cesium.PolygonHierarchy(innerPositions)])\r\n                //        }),\r\n                //        attributes: {\r\n                //            color: options.outlineColor\r\n                //        }\r\n                //    })\r\n                //});\r\n            };\r\n\r\n            return circle;\r\n        };\r\n        var polygonConverter = function (feature) {\r\n            var self = this;\r\n            var polygon = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            polygon.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = color;\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var getting = [];\r\n\r\n                        var geomPolys = [];\r\n                        var geomOutlines = [];\r\n\r\n                        var getPolyGeom = function (polygonHierarchy) {\r\n                            return new Cesium.GeometryInstance({\r\n                                id: feature.id,\r\n                                geometry: new Cesium.PolygonGeometry({\r\n                                    polygonHierarchy: polygonHierarchy\r\n                                }),\r\n                                attributes: {\r\n                                    color: options.color\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        var getOutlineGeom = function (outlineCoords) {\r\n                            return new Promise(function (res, rej) {\r\n                                createLine(feature.id, outlineCoords, { material: options.outlineColor, width: options.width }, function (entity) {\r\n                                    geomOutlines.push(entity);\r\n                                    res();\r\n                                });\r\n                            });\r\n                        };\r\n\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            for (var j = 0; j < coords[i].length; j++) {\r\n                                var hierarchy;\r\n                                if (j == 0) {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][0]));\r\n                                    hierarchy = new Cesium.PolygonHierarchy(coords[i][0]);\r\n                                } else {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][j]));\r\n                                    hierarchy.holes.push(new Cesium.PolygonHierarchy(coords[i][j]));\r\n                                }\r\n                            }\r\n\r\n                            geomPolys.push(getPolyGeom(hierarchy));\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(\r\n                                [new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: geomPolys\r\n                                }), geomOutlines]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if (Array.isArray(coords) && coords.length === 1 && Array.isArray(coords[0])) {\r\n                            coords = coords[0];\r\n                        }\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.outlineColor, width: options.width\r\n                        }, function (entity) {\r\n\r\n                            resolve([\r\n                                new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: new Cesium.GeometryInstance({\r\n                                        id: feature.id,\r\n                                        geometry: new Cesium.PolygonGeometry({\r\n                                            polygonHierarchy: new Cesium.PolygonHierarchy(coords)\r\n                                        }),\r\n                                        attributes: {\r\n                                            color: options.color\r\n                                        }\r\n                                    })\r\n                                }), entity]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return polygon;\r\n        };\r\n        var lineConverter = function (feature) {\r\n            var self = this;\r\n            var line = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            line.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = color;\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var geomInstances = [];\r\n\r\n                        var getting = [];\r\n\r\n                        if (coords.length == 1) {\r\n                            coords = coords[0];\r\n\r\n                            getting.push(new Promise(function (res, rej) {\r\n                                createLine(feature.id, coords, {\r\n                                    material: options.color, width: options.width\r\n                                }, function (entity) {\r\n                                    geomInstances.push(entity);\r\n                                    res();\r\n                                });\r\n                            }));\r\n\r\n\r\n                        } else {\r\n                            coords = coords.sort(function (a, b) {\r\n                                if (a.length > b.length) {\r\n                                    return -1;\r\n                                }\r\n                                if (a.length < b.length) {\r\n                                    return 1;\r\n                                }\r\n                                return 0;\r\n                            });\r\n                            var pixelSize = getPixelSize(coords[0]);\r\n                            for (var i = 0; i < coords.length; i++) {\r\n\r\n                                getting.push(new Promise(function (res, rej) {\r\n                                    createLine(feature.id, coords[i], {\r\n                                        material: options.color, width: options.width\r\n                                    }, function (entity) {\r\n                                        geomInstances.push(entity);\r\n                                        res();\r\n                                    });\r\n                                }));\r\n                            }\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(geomInstances);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.color, width: options.width\r\n                        }, function (entity) {\r\n                            resolve(entity);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return line;\r\n        };\r\n        var pointConverter = function (feature) {\r\n            var self = this;\r\n            var point = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            point.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    rotation: { prop: 'angle' },\r\n                    label: { prop: 'label' },\r\n                    fontSize: { prop: 'fontSize' },\r\n                    fontColor: { prop: 'fontColor' },\r\n                    outlineLabelColor: { prop: 'labelOutlineColor' },\r\n                    outlineLabelWidth: { prop: 'labelOutlineWidth' },\r\n                    anchor: { prop: 'anchor' },\r\n                    height: { prop: 'height' },\r\n                    width: { prop: 'width' },\r\n                    url: { prop: 'url' },\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    outlineWidth: { prop: 'strokeWidth' },\r\n                    radius: { prop: 'radius' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.anchor.hasOwnProperty('val')) {\r\n                    if (!(properties.url.hasOwnProperty('val')) && feature.options.url) {\r\n                        opt.url = feature.options.url;\r\n                    } else {\r\n                        opt.url = properties.url.val;\r\n                    }\r\n\r\n                    opt.anchor = properties.anchor.val;\r\n                }\r\n\r\n                if (properties.height.hasOwnProperty('val')) {\r\n                    opt.height = properties.height.val;\r\n                }\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                if (properties.rotation.hasOwnProperty('val')) {\r\n                    opt.rotation = properties.rotation.val;\r\n                }\r\n\r\n                if (properties.label.hasOwnProperty('val')) {\r\n                    opt.label = properties.label.val;\r\n                }\r\n\r\n                if (properties.fontSize.hasOwnProperty('val')) {\r\n                    opt.fontSize = properties.fontSize.val;\r\n                }\r\n\r\n                if (properties.fontColor.hasOwnProperty('val')) {\r\n                    opt.fontColor = toCesiumColor(properties.fontColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelColor.hasOwnProperty('val')) {\r\n                    opt.outlineLabelColor = toCesiumColor(properties.outlineLabelColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelWidth.hasOwnProperty('val')) {\r\n                    opt.outlineLabelWidth = properties.outlineLabelWidth.val;\r\n                }\r\n\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        opt.color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        opt.color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineWidth.hasOwnProperty('val')) {\r\n                    opt.outlineWidth = properties.outlineWidth.val;\r\n                }\r\n\r\n                if (properties.radius.hasOwnProperty('val')) {\r\n                    opt.radius = properties.radius.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\") {\r\n                point.geometryType = function (coords, options) {\r\n                    var billboard = {\r\n                        name: feature.id,\r\n                        position: coords[0],\r\n                        billboard: {\r\n                            image: options.url,\r\n                            width: options.width,\r\n                            height: options.height,\r\n                            eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                        }\r\n                    };\r\n\r\n                    if (options.anchor && options.anchor.length > 0) {\r\n                        billboard.billboard.pixelOffset = new Cesium.Cartesian2(options.anchor[0], options.anchor[1]);\r\n                    }\r\n\r\n                    if (!options.label) {\r\n                        return new Cesium.Entity(billboard);\r\n                    } else {\r\n                        billboard.label = {\r\n                            text: options.label,\r\n                            font: '14pt sans-serif',\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            fillColor: options.fontColor,\r\n                            showBackground: true,\r\n                            eyeOffset: new Cesium.Cartesian3(3000, 0, -100)\r\n                        };\r\n\r\n                        return new Cesium.Entity(billboard);\r\n                    }\r\n                };\r\n            }\r\n            else if (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\") {\r\n                var pinBuilder = new Cesium.PinBuilder();\r\n\r\n                point.geometryType = function (coords, options) {\r\n                    var text = options.label;\r\n\r\n                    switch (true) {\r\n                        case (text && /^([A-Z])\\w+$/gi.test(text)):\r\n                        case (text && !/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                label: {\r\n                                    text: options.label,\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BASELINE,\r\n                                    font: '16' + 'px san-serif Helvetica',\r\n                                    fillColor: Cesium.Color.BLACK,\r\n                                    outlineColor: Cesium.Color.WHITE,\r\n                                    outlineWidth: 5,\r\n                                    style: Cesium.LabelStyle.FILL_AND_OUTLINE\r\n                                }\r\n                            });\r\n\r\n                            break;\r\n                        case (/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromText(text, options.fontColor, 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                            break;\r\n                        case options.radius && options.radius > 0:\r\n                            var stringifyScratch = new Array(2);\r\n\r\n                            const drawPin = function (context2D, color, size) {\r\n\r\n                                color = color.darken(0.15, new Cesium.Color());\r\n                                var rgbaColor = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \",0)\");\r\n\r\n                                context2D.save();\r\n                                context2D.scale(size / 24, size / 24);\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.miterLimit = 4;\r\n                                context2D.font = \"normal normal 400 normal 15px / 21.4286px ''\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.fillStyle = \"#b3b3b3\";\r\n                                context2D.fillStyle = \"rgba(179, 179, 179, 1)\";\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(11.578125, 11.71875);\r\n                                context2D.lineTo(12.421875, 11.71875);\r\n                                context2D.lineTo(12.421875, 24);\r\n                                context2D.lineTo(11.578125, 24);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.fillStyle = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \", 1)\");\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(17, 7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 0, 1.5707963267948966, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 1.5707963267948966, 3.141592653589793, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 3.141592653589793, 4.71238898038469, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, -1.5707963267948966, 0, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                            };\r\n\r\n                            const createPin = function (color, size) {\r\n                                if (!pinBuilder._cache) {\r\n                                    pinBuilder._cache = {};\r\n                                }\r\n\r\n                                stringifyScratch[0] = color;\r\n                                stringifyScratch[1] = size;\r\n                                var id = JSON.stringify(stringifyScratch);\r\n\r\n                                var item = pinBuilder._cache[id];\r\n                                if (item) {\r\n                                    return item;\r\n                                }\r\n\r\n                                var canvas = document.createElement('canvas');\r\n                                canvas.width = size;\r\n                                canvas.height = size;\r\n\r\n                                var context2D = canvas.getContext('2d');\r\n                                drawPin(context2D, color, size);\r\n\r\n                                pinBuilder._cache[id] = canvas;\r\n                                return canvas;\r\n                            }\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: createPin(Cesium.Color.fromCssColorString(feature.options.strokeColor ? feature.options.strokeColor : TC.Cfg.styles.point.strokeColor), 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                        default:\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromColor(Cesium.Color.fromCssColorString(feature.options.fillColor ? feature.options.fillColor : TC.Cfg.styles.point.fillColor), 32).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                    }\r\n                };\r\n            }\r\n\r\n            return point;\r\n        };\r\n\r\n        this.convert = function (scn, feature, sourceCrs, targetCrs) {\r\n            scene = scn;\r\n\r\n            var byPromise = false;\r\n            var cartesians = [];\r\n            var toCartesian = function (coord, arr) {\r\n                if (!Array.isArray(coord)) {\r\n                    return;\r\n                }\r\n\r\n                if (sourceCrs !== targetCrs) {\r\n                    coord = TC.Util.reproject(coord, sourceCrs, targetCrs);\r\n                }\r\n\r\n                arr.push(coord.length > 2 ?\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1], coord[2]) :\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1]));\r\n            };\r\n\r\n            var obj;\r\n            var geometry = feature.geometry;\r\n            var converter;\r\n\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons;\r\n\r\n            var forPoints = function (points, arr) {\r\n                if (Array.isArray(points)) {\r\n                    for (var i = 0; i < points.length; i++) {\r\n                        toCartesian(points[i], arr);\r\n                    }\r\n                }\r\n            };\r\n            var forRingsOrPolylines = function (ringsOrPolylines, arr) {\r\n                if (Array.isArray(ringsOrPolylines)) {\r\n                    for (var i = 0; i < ringsOrPolylines.length; i++) {\r\n                        arr.push([]);\r\n                        forPoints(ringsOrPolylines[i], arr[arr.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n            var forPolygons = function (polygons) {\r\n                if (Array.isArray(polygons)) {\r\n                    for (var i = 0; i < polygons.length; i++) {\r\n                        cartesians.push([]);\r\n                        forRingsOrPolylines(polygons[i], cartesians[cartesians.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n\r\n            switch (true) {\r\n                case (TC.feature.Circle && feature.CLASSNAME == \"TC.feature.Circle\"):\r\n                    forPoints(geometry, cartesians);\r\n                    converter = circleConverter.call(self, feature);\r\n                    break;\r\n                case (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\"):\r\n                    polygons = geometry;\r\n                    if (Array.isArray(polygons)) {\r\n                        forPolygons(polygons);\r\n\r\n                        converter = polygonConverter.call(self, feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case ((TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") || (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\")):\r\n                    ringsOrPolylines = geometry;\r\n                    if (Array.isArray(ringsOrPolylines)) {\r\n                        forRingsOrPolylines(ringsOrPolylines, cartesians);\r\n\r\n                        if (feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                            converter = polygonConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                        else if (feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                            converter = lineConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                    }\r\n                    break;\r\n                case (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\"):\r\n                    points = geometry;\r\n                    if (Array.isArray(points)) {\r\n                        forPoints(points, cartesians);\r\n\r\n                        converter = lineConverter(feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n                case (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n            }\r\n\r\n            if (cartesians.length == 0) {\r\n                return null;\r\n            }\r\n\r\n            obj = {\r\n                id: feature.id,\r\n                attributes: feature.data,\r\n                boundigSphere: Cesium.BoundingSphere.fromPoints(cartesians)\r\n            };\r\n\r\n            if (!byPromise) { // si estamos pintando líneas, obtenemos posiciones con altura\r\n                obj.geometry = converter.geometryType(cartesians, converter.options());\r\n            } else {\r\n                obj.geometry = function (provider) {\r\n                    converter.provider = provider;\r\n                    return converter.geometryType(cartesians, converter.options());\r\n                }\r\n            }\r\n\r\n            return obj;\r\n        };\r\n    };\r\n\r\n    const currentMapCfg = {\r\n        baseMap: '',\r\n        baseMaps: [],\r\n        baseVector: ''\r\n    };\r\n    const setMustReprojectOfBaseLayers = function (map) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var isBaseRaster = map.baseLayer instanceof TC.layer.Raster;\r\n\r\n            if (isBaseRaster) {\r\n                if (!isCompatible(map.baseLayer, self.view3D.crs)) {\r\n                    var fallbackLayer = map.baseLayer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (!fallbackLayer.isCompatible(self.view3D.crs)) {\r\n                                map.toast(self.getLocaleString('threed.baseLayerNoCompatible', { name: map.baseLayer.layerNames }));\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                currentMapCfg.baseVector = map.baseLayer;\r\n            }\r\n\r\n            if (currentMapCfg.baseMaps.length === 0) {\r\n\r\n                Promise.all(map.baseLayers.map(function (baseLayer) {\r\n                    if (!isCompatible(baseLayer, self.view3D.crs)) {\r\n                        var fallbackLayer = baseLayer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            return fallbackLayer._capabilitiesPromise.then(function () {\r\n                                return !fallbackLayer.isCompatible(self.view3D.crs);\r\n                            });\r\n                        } else {\r\n                            return Promise.resolve(true);\r\n                        }\r\n                    } else {\r\n                        return Promise.resolve(false);\r\n                    }\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        for (var i = 0; i < map.baseLayers.length; i++) {\r\n                            map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n\r\n                        //map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n                    }\r\n\r\n                    resolve();\r\n                });\r\n            }\r\n\r\n            currentMapCfg.baseMap = isBaseRaster ? map.baseLayer : self.Consts.BLANK_BASE;\r\n        });\r\n    };\r\n\r\n    viewProto.init = function (options) {\r\n        const self = this;\r\n\r\n        self.events = self.map.$events;\r\n\r\n        self.selectors = {\r\n            divThreedMap: options.divMap\r\n        };\r\n\r\n        if (options.terrain) {\r\n            self.terrain = options.terrain;\r\n        } else {\r\n            throw Error(\"Falta configuración del terreno\");\r\n        }\r\n\r\n        if (options.terrainFallback && options.terrainFallback.url && options.terrainFallback.coverageName && options.terrainFallback.noDataValue) {\r\n            self.terrainFallback = {\r\n                url: options.terrainFallback.url.trim(),\r\n                layerName: options.terrainFallback.coverageName,\r\n                format: options.terrainFallback.format,\r\n                noDataValue: options.terrainFallback.noDataValue\r\n            };\r\n        } else if (options.terrainFallback && (!options.terrainFallback.url || !options.terrainFallback.coverageName || !options.terrainFallback.noDataValue)) {\r\n            throw Error(\"Faltan datos sobre el terreno de respaldo\");\r\n        }\r\n\r\n        if (options.controls) {\r\n            self.allowedControls = options.controls;\r\n        }\r\n\r\n        self.mapView = new MapView(self.map, self);\r\n\r\n        self.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            self.mapView.metersPerUnit = self.map.getMetersPerUnit();\r\n        });\r\n\r\n        self.map.view3D = self.view3D;\r\n\r\n        /* provisional: no dispongo de getRenderedHtml porque ya no es un control */\r\n        self.getRenderedHtml(self.CLASS + '-overlay', {}, function (html) {\r\n            const parser = new DOMParser();\r\n            self.overlay = parser.parseFromString(html, 'text/html').body.firstChild;\r\n        });\r\n    };\r\n\r\n    viewProto.apply = function (options) {\r\n        const self = this;\r\n\r\n        options = options || {};\r\n\r\n        if (options.map) {\r\n            self.map = options.map;\r\n\r\n            if (!self.map.view3D) {\r\n                var viewName = self.VIEWNAME = self.VIEWNAME.substr(0, 1).toLowerCase() + self.VIEWNAME.substr(1);\r\n                if (self.map.options.views && self.map.options.views.hasOwnProperty(viewName)) {\r\n                    self.init(self.map.options.views[viewName]);\r\n                } else {\r\n                    throw Error('Falta configuración de la vista');\r\n                }\r\n            }\r\n\r\n            self.view3D.view2DCRS = options.map.crs;\r\n\r\n            options.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.view3D.view2DCRS = e.newCrs;\r\n            });\r\n        } else {\r\n            throw Error('Falta referencia al mapa 2D');\r\n        }\r\n\r\n        if (options.state) {\r\n            self.map.toast(TC.Util.getLocaleString(self.map.options.locale, 'threed.apply3DState'), { type: TC.Consts.msgType.INFO });\r\n        }\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        if (!self.ctrlsToMng) {\r\n            var ctls = [];\r\n            for (var i = 0, len = self.allowedControls.length; i < len; i++) {\r\n                var ctl = self.allowedControls[i];\r\n                ctl = ctl.substr(0, 1).toUpperCase() + ctl.substr(1);\r\n                var ctlsOnMap = self.map.getControlsByClass('TC.control.' + ctl);\r\n                if (ctlsOnMap.length === 0) { // si un control soportado aún no está en el mapa, nos suscribimos al addcontrol para controlarlo\r\n                    self.map.on(TC.Consts.event.CONTROLADD, function (ctrlClass, e) {\r\n                        try {\r\n                            var instance = new Function(\"return new \" + ctrlClass + \"()\")();\r\n                            if (instance.CLASS === e.control.CLASS) {\r\n                                self.ctrlsToMng.push(e.control);\r\n                            }\r\n                        } catch (error) { console.warn(\"Error al obtener la clase CSS de un control soportado\"); }\r\n                    }.bind(self, 'TC.control.' + ctl));\r\n                }\r\n                ctls = ctls.concat(ctlsOnMap);\r\n            }\r\n\r\n            self.ctrlsToMng = ctls;\r\n        }\r\n\r\n        self.map.on3DView = true;\r\n\r\n        self.map.div.classList.add(TC.Consts.classes.THREED);\r\n\r\n        self.divThreedMap = document.querySelector('#' + self.selectors.divThreedMap);\r\n        self.divThreedMap.classList.add(self.classes.MAP3D, self.classes.LOADING);\r\n\r\n        self.view3D.container = self.divThreedMap;\r\n\r\n        const applyEnd = function () {\r\n            console.log('Llega a applyEnd');\r\n\r\n            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n\r\n            delete self.waiting;\r\n\r\n            if (options.callback) {\r\n                options.callback();\r\n            }\r\n        };\r\n\r\n        try {\r\n            self.view3D.loadViewer.call(self)\r\n                .then(function () {\r\n\r\n                    self.divThreedMap.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                    self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeIn');\r\n                    self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeIn');\r\n                    self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeOut');\r\n\r\n                    if (!options.state) {\r\n                        self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                    }\r\n\r\n                    // mapas de fondo y capas\r\n                    setMustReprojectOfBaseLayers.call(self, self.map)\r\n                        .then(function () {\r\n\r\n                            // extent\r\n                            self.view3D.setCameraFromMapView.call(self);\r\n\r\n                            // mapa de fondo\r\n                            self.view3D.setBaseLayer.call(self, self.map.baseLayer);\r\n\r\n                            // capas de trabajo\r\n                            self.map.workLayers.filter(function (elem) {\r\n                                return elem.type === TC.Consts.layerType.WMTS || elem.type === TC.Consts.layerType.WMS;\r\n                            }).reverse().forEach(function (layer) {\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            });\r\n\r\n                            self.viewer.readyPromise.then(function () {\r\n\r\n                                if (!self.view3D.cameraControls) self.view3D.cameraControls = new CameraControls(self);\r\n                                else self.view3D.cameraControls.render.call(self.view3D.cameraControls);\r\n\r\n                                if (!options.animateRendering && !options.state) {\r\n                                    options.animateRendering = true;\r\n                                }\r\n\r\n                                if (options.state) {\r\n\r\n                                    self.divThreedMap.classList.remove(self.classes.LOADING);\r\n\r\n                                    var camera = self.view3D.cameraControls.getCamera();\r\n                                    camera.flyTo({\r\n                                        destination: Cesium.Cartesian3.fromRadians(options.state.cp[0], options.state.cp[1], options.state.cp[2]),\r\n                                        orientation: {\r\n                                            heading: options.state.chpr[0],\r\n                                            pitch: options.state.chpr[1],\r\n                                            roll: options.state.chpr[2]\r\n                                        },\r\n                                        complete: applyEnd\r\n                                    });\r\n\r\n                                } else if (options.animateRendering) {\r\n                                    let angle = Cesium.Math.toRadians(50);\r\n                                    let pickBP = pickBottomPoint(self.viewer.scene);\r\n\r\n                                    const readyPickBP = function (_pickBP) {\r\n                                        let matrixPickBP = Cesium.Matrix4.fromTranslation(_pickBP);\r\n\r\n                                        self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle,\r\n                                            self.viewer.scene.camera.right, matrixPickBP, {\r\n                                                duration: 2000,\r\n                                                callback: animationCallback\r\n                                            });\r\n                                    };\r\n\r\n                                    const animationCallback = function () {\r\n                                        Cesium.Camera.DEFAULT_VIEW_RECTANGLE = self.view3D.initialRectangle = self.viewer.camera.computeViewRectangle();\r\n                                        Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;\r\n\r\n                                        applyEnd();\r\n                                    };\r\n\r\n                                    if (pickBP) {\r\n                                        readyPickBP(pickBP);\r\n                                    } else { /* revisado: si llegamos aquí, es que el terreno está listo pero del canvas al terreno da null, esperamos un poco más */\r\n                                        // parece que es cosa de tiempos. Añado un setInterval\r\n\r\n                                        let checkPickBPProcess;\r\n                                        let startTime = new Date().getTime();\r\n\r\n                                        const checkPickBottomPoint = function () {\r\n                                            let _pickBP = pickBottomPoint(self.viewer.scene);\r\n                                            if (_pickBP) {\r\n                                                clearInterval(checkPickBPProcess);\r\n                                                readyPickBP(_pickBP);\r\n                                            } else {\r\n                                                if (new Date().getTime() - startTime > 15000) {\r\n                                                    clearInterval(checkPickBPProcess);\r\n                                                    // aunque sea nos centramos en el extent inicial\r\n                                                    let homeButton = document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn');\r\n                                                    if (homeButton && homeButton.length > 0) {\r\n                                                        homeButton[0].click();\r\n                                                    }\r\n                                                    animationCallback();\r\n                                                    return;\r\n                                                }\r\n                                            }\r\n                                        };\r\n\r\n                                        checkPickBPProcess = setInterval(checkPickBottomPoint, 50);                                        \r\n                                    }\r\n\r\n                                } else {\r\n                                    applyEnd();\r\n                                }\r\n\r\n                                self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n\r\n                                self.events.on(TC.Consts.event.TERRAINLOADED, function () {\r\n\r\n                                    const addHeight = function (position) {\r\n                                        var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n                                        var height = self.viewer.scene.globe.getHeight(cartographic) || 0;\r\n                                        var finalCartographic = {\r\n                                            longitude: cartographic.longitude,\r\n                                            latitude: cartographic.latitude,\r\n                                            height: cartographic.height + height\r\n                                        };\r\n\r\n                                        return Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalCartographic);\r\n                                    };\r\n\r\n                                    var markers = self.viewer.entities.values.filter(function (entity) {\r\n                                        return entity.billboard;\r\n                                    });\r\n\r\n                                    if (markers.length > 0) {\r\n                                        markers.forEach(function (marker) {\r\n                                            marker.position = addHeight(Cesium.Property.getValueOrUndefined(marker.position, Cesium.JulianDate.now));\r\n                                        });\r\n                                    }\r\n\r\n                                    if (self.viewer.billboardCollection) {\r\n\r\n                                        for (var i = 0; i < self.viewer.billboardCollection.length; i++) {\r\n                                            self.viewer.billboardCollection.get(i).position = addHeight(self.viewer.billboardCollection.get(i).position);\r\n                                        }\r\n\r\n                                        self.viewer.scene.requestRender();\r\n                                    }\r\n\r\n                                });\r\n                            }.bind(self))\r\n                                .catch(() => { console.log('3051'); applyEnd(); });\r\n                        })\r\n                        .catch(() => { console.log('3053'); applyEnd(); });\r\n                })\r\n                .catch(() => { console.log('3055'); applyEnd(); });\r\n        } catch (error) {\r\n            applyEnd();\r\n\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    viewProto.unapply = function (options) {\r\n        const self = this;\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        self.map.on3DView = false;\r\n\r\n        //self.map.view3D = null;\r\n\r\n        self.view3D.cameraControls.resetRotation({ duration: 1000 }).then(function () {\r\n\r\n            var animationCallback = function () {\r\n\r\n                self.map.div.classList.remove(TC.Consts.classes.THREED);\r\n\r\n                /* atribuciones del terreno */\r\n                self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: self.viewer.scene.terrainProvider });\r\n\r\n                if (self.viewer.scene.terrainProvider.fallbackProvider) {\r\n                    self.viewer.scene.terrainProvider.fallbackProvider.forEach(function (provider) {\r\n                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: provider });\r\n                    });\r\n                }\r\n\r\n                self.view3D.setViewFromCameraView.call(self).then(function () {\r\n                    self.divThreedMap.classList.remove(self.classes.MAP3D, self.CLASS + '-divMap-fadeIn');\r\n                    self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeIn');\r\n\r\n                    self.view3D.destroy.call(self);\r\n\r\n                    self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                    delete self.waiting;\r\n\r\n                    if (options.callback) {\r\n                        options.callback();\r\n                    }\r\n                });\r\n\r\n                self.mapView.setRotation(0);\r\n                self._ovMap.wrap.draw3DCamera(null);\r\n            };\r\n\r\n            var bottom = pickBottomPoint(self.viewer.scene);\r\n            var transform = Cesium.Matrix4.fromTranslation(bottom);\r\n            var angle = computeAngleToZenith(self.viewer.scene, bottom);\r\n\r\n            self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, transform, {\r\n                duration: 1500,\r\n                callback: animationCallback\r\n            });\r\n        });\r\n    };\r\n\r\n    viewProto.view3D = (function () {\r\n        const rasterConverter = new RasterConverter(/(EPSG\\:?4326)/i);\r\n        const featureConverter = new FeatureConverter();\r\n\r\n        const overrideDesktopZoom = function () {\r\n            var self = this;\r\n\r\n            if (!TC.Util.detectMobile()) {\r\n                self.viewer.scene.screenSpaceCameraController.enableZoom = false;\r\n\r\n                var element = self.viewer.scene.canvas;\r\n                // detect available wheel event\r\n                var wheelEvent;\r\n                if ('onwheel' in element) {\r\n                    // spec event type\r\n                    wheelEvent = 'wheel';\r\n                } else if (document.onmousewheel !== undefined) {\r\n                    // legacy event type\r\n                    wheelEvent = 'mousewheel';\r\n                } else {\r\n                    // older Firefox\r\n                    wheelEvent = 'DOMMouseScroll';\r\n                }\r\n                element.addEventListener(wheelEvent, function (event) {\r\n                    var delta;\r\n                    // standard wheel event uses deltaY.  sign is opposite wheelDelta.\r\n                    // deltaMode indicates what unit it is in.\r\n                    if (event.deltaY) {\r\n                        var deltaMode = event.deltaMode;\r\n                        if (deltaMode === event.DOM_DELTA_PIXEL) {\r\n                            delta = - event.deltaY;\r\n                        } else if (deltaMode === event.DOM_DELTA_LINE) {\r\n                            delta = - event.deltaY * 40;\r\n                        } else {\r\n                            // DOM_DELTA_PAGE\r\n                            delta = - event.deltaY * 120;\r\n                        }\r\n                    } else if (event.detail > 0) {\r\n                        // old Firefox versions use event.detail to count the number of clicks. The sign\r\n                        // of the integer is the direction the wheel is scrolled.\r\n                        delta = event.detail * -120;\r\n                    } else {\r\n                        delta = event.wheelDelta;\r\n                    }\r\n\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, delta);\r\n\r\n                }, false);\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfMouse = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    self.view3D._lastMousePosition = event;\r\n                }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (wheelZoomAmount) {\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, wheelZoomAmount);\r\n                }, Cesium.ScreenSpaceEventType.WHEEL);\r\n                var pinchCenterPosition = new Cesium.Cartesian2();\r\n                var pinchAmount = 0;\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    Cesium.Cartesian2.lerp(event.position1, event.position2, 0.5, pinchCenterPosition);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_START);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    var diff = event.distance.endPosition.y - event.distance.startPosition.y;\r\n                    var rangeWindowRatio = diff / self.viewer.scene.canvas.clientHeight;\r\n                    rangeWindowRatio = Math.min(rangeWindowRatio, self.viewer.scene.screenSpaceCameraController.maximumMovementRatio);\r\n                    pinchAmount = rangeWindowRatio;\r\n                }, Cesium.ScreenSpaceEventType.PINCH_MOVE);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    self.view3D.zoomToCartesian.call(self, { endPosition: pinchCenterPosition }, pinchAmount);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_END);\r\n            }\r\n        };\r\n\r\n        const addFeature = function (csFeature) {\r\n            var addedFeature = csFeature;\r\n            switch (true) {\r\n                case csFeature instanceof Cesium.GroundPrimitive: {\r\n                    this.viewer.scene.groundPrimitives.add(csFeature);\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object && csFeature.hasOwnProperty('billboard'): {\r\n                    if (!this.viewer.billboardCollection) {\r\n                        this.viewer.billboardCollection = this.viewer.scene.primitives.add(new Cesium.BillboardCollection({\r\n                            scene: this.viewer.scene\r\n                        }));\r\n                    }\r\n\r\n                    var billboardAtCollection = this.viewer.billboardCollection.add({\r\n                        position: csFeature.position,\r\n                        image: csFeature.billboard.image,\r\n                        verticalOrigin: csFeature.billboard.verticalOrigin,\r\n                        heightReference: csFeature.billboard.heightReference\r\n                    });\r\n\r\n                    addedFeature = billboardAtCollection;\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object: {\r\n                    addedFeature = this.viewer.entities.getById(csFeature.id);\r\n                    if (!addedFeature) {\r\n                        addedFeature = this.viewer.entities.add(csFeature);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n\r\n            this.viewer.scene.requestRender();\r\n\r\n            return addedFeature;\r\n        };\r\n        const linkFeature = function (map, idLayer, feature, id) {\r\n            if (!map.vector2DFeatures.hasOwnProperty(idLayer)) {\r\n                map.vector2DFeatures[idLayer] = {};\r\n                map.vector2DFeatures[idLayer][id] = [feature];\r\n            } else {\r\n                if (!map.vector2DFeatures[idLayer].hasOwnProperty(id)) {\r\n                    map.vector2DFeatures[idLayer][id] = [feature];\r\n                } else {\r\n                    map.vector2DFeatures[idLayer][id].push(feature);\r\n                }\r\n            }\r\n        };\r\n\r\n        const listenTo = [\r\n            TC.Consts.event.BEFOREBASELAYERCHANGE, TC.Consts.event.BASELAYERCHANGE,\r\n            TC.Consts.event.LAYERADD, TC.Consts.event.LAYERREMOVE, TC.Consts.event.LAYERVISIBILITY, TC.Consts.event.LAYEROPACITY, TC.Consts.event.LAYERORDER,\r\n            TC.Consts.event.FEATUREADD, TC.Consts.event.FEATUREREMOVE, TC.Consts.event.FEATURESCLEAR\r\n            /*, TC.Consts.event.ZOOM no encuentro en qué casos debemos escuchar el evento ZOOM de 2D, solo trae problemas */, TC.Consts.event.ZOOMTO];\r\n\r\n        const event2DHandler = function (e) {\r\n            var self = this;\r\n\r\n            switch (true) {\r\n                case e.type == TC.Consts.event.BEFOREBASELAYERCHANGE:\r\n                    if (!self.waiting)\r\n                        self.waiting = self.map.getLoadingIndicator().addWait();\r\n                    break;\r\n                case e.type == TC.Consts.event.BASELAYERCHANGE: {\r\n                    self.view3D.setBaseLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERADD: {\r\n                    self.view3D.addLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERREMOVE: {\r\n                    self.view3D.removeLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERVISIBILITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { visibility: e.layer.getVisibility() });\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYEROPACITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { opacity: e.layer.getOpacity() });\r\n                    self.viewer.scene.requestRender();\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERORDER: {\r\n                    for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                        if (self.view3D.workLayers[i].imageryProvider && self.view3D.workLayers[i].imageryProvider.layers.join(',') === e.layer.names.join(',')) {\r\n\r\n                            if (e.oldIndex > e.newIndex) {\r\n                                var positions = e.oldIndex - e.newIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.lower(self.view3D.workLayers[i]);\r\n                                }\r\n\r\n                            } else {\r\n                                var positions = e.newIndex - e.oldIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.raise(self.view3D.workLayers[i]);\r\n                                }\r\n                            }\r\n\r\n                            self.view3D.workLayers.splice(e.newIndex, 0, self.view3D.workLayers.splice(e.oldIndex, 1)[0]);\r\n                            break;\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREADD: {\r\n                    self.view3D.addFeature.call(self.view3D, e.feature);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREREMOVE: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        const remove = function (feature) {\r\n                            if (self.view3D.vector2DFeatures[e.layer.id].hasOwnProperty(feature.id)) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n\r\n                                delete self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                            }\r\n                        };\r\n\r\n                        if (e.feature instanceof Array) {\r\n                            e.feature.forEach(remove);\r\n                        } else {\r\n                            remove(e.feature);\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATURESCLEAR: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        for (var featureId in self.view3D.vector2DFeatures[e.layer.id]) {\r\n                            var threedFeature = self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n\r\n                            for (var i = 0; i < threedFeature.length; i++) {\r\n                                self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOM: {\r\n                    if (self.view3D.cameraControls && !self.view3D.cameraControls.moving) {\r\n\r\n                        var width = self.view3D.viewer.scene.canvas.clientWidth;\r\n                        var height = self.view3D.viewer.scene.canvas.clientHeight;\r\n\r\n\r\n                        /* Si hemos llegado aquí y hay un cambio en el tamaño del canvas, \r\n                           viene el evento del resize canvas del mapa de 2D así que paso y no hago nada */\r\n                        if (!self.view3D._canvasClientHeight ||\r\n                            !self.view3D._canvasClientWidth ||\r\n\r\n                            width !== self.view3D._canvasClientWidth ||\r\n                            height !== self.view3D._canvasClientHeight) {\r\n\r\n                            if (!self.view3D._canvasClientWidth) {\r\n                                self.view3D._canvasClientWidth = self.view3D.viewer.scene.canvas.clientWidth;\r\n                            }\r\n\r\n                            if (!self.view3D._canvasClientHeight) {\r\n                                self.view3D._canvasClientHeight = self.view3D.viewer.scene.canvas.clientHeight;\r\n                            }\r\n\r\n                            self.view3D._canvasClientWidth = width;\r\n                            self.view3D._canvasClientHeight = height;\r\n\r\n                            return;\r\n                        }\r\n\r\n                        self.view3D.flyToMapCoordinates.call(self, self.mapView.getCenter());\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOMTO: {\r\n\r\n                    if (self.lastZoom && performance.now() - self.lastZoom < 50) {\r\n                        return;\r\n                    }\r\n                    self.lastZoom = performance.now();\r\n\r\n                    var coordsXY = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(0, 2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(0, 2);\r\n                    var coordsXY2 = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(2);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle);\r\n                    break;\r\n                }\r\n            }\r\n        };\r\n\r\n        /* geolocation */\r\n        const geolocation_newPosition = function () {\r\n            var self = this;\r\n\r\n            if (!self.map.on3DView) {\r\n                return;\r\n            }\r\n\r\n            if (!self.view3D.trackingEntity) {\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n                var track = geolocation2D.layerTracking.features.filter(function (feature) {\r\n                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                });\r\n\r\n                if (track && track.length > 0) {\r\n\r\n                    var positions = [];\r\n                    const positionCallback = new Cesium.CallbackProperty(function (time, result) {\r\n                        if (track[0].geometry.length > positions.length) {\r\n                            var newCartographicPositions = track[0].geometry.slice(positions.length).map(function (coordinate) {\r\n                                var reprojected = coordinate;\r\n\r\n                                if (this.view3D.view2DCRS !== this.view3D.crs) {\r\n                                    reprojected = TC.Util.reproject(coordinate, this.view3D.view2DCRS, this.view3D.crs);\r\n                                }\r\n\r\n                                return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1], coordinate[2]);\r\n                            }.bind(this));\r\n\r\n                            var updatedPositions = [];\r\n                            if (newCartographicPositions instanceof Array) {\r\n                                updatedPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(newCartographicPositions);\r\n                            } else {\r\n                                updatedPositions = [Cesium.Ellipsoid.WGS84.cartographicToCartesian(newCartographicPositions)];\r\n                            }\r\n\r\n                            positions = positions.concat(updatedPositions);\r\n                            return positions;\r\n                        }\r\n\r\n                        return positions;\r\n\r\n                    }.bind(this), false);\r\n\r\n                    var entityTracking = new Cesium.Entity({\r\n                        id: \"trackingEntity\",\r\n                        polyline: {\r\n                            positions: positionCallback,\r\n                            clampToGround: true,\r\n                            width: 3,\r\n                            material: new Cesium.PolylineDashMaterialProperty({\r\n                                color: new Cesium.CallbackProperty(function (time, result) {\r\n                                    self.viewer.scene.requestRender();\r\n                                    return Cesium.Color.fromAlpha(new Cesium.Color(0, 255, 209), geolocation2D.track.renderTrack.checked ? 1 : 0);\r\n                                }.bind(this), false),\r\n                                gapColor: Cesium.Color.TRANSPARENT\r\n                            })\r\n                        }\r\n                    });\r\n\r\n                    self.view3D.trackingEntity = self.viewer.entities.add(entityTracking);\r\n                    self.viewer.scene.requestRender();\r\n                }\r\n            }\r\n        };\r\n        const geolocation_videoControls = function (event) {\r\n            var self = this;\r\n\r\n            var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n            switch (true) {\r\n                case geolocation2D.Const.Event.IMPORTEDTRACK.indexOf(event.type) > -1:\r\n                case event.target.className.indexOf('draw') > -1 && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK):\r\n                case !(event.target.parentElement && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK)):\r\n                case event.target.className.indexOf('stop') > -1:\r\n\r\n                    if (self.map.on3DView) {\r\n                        self.viewer.clock.shouldAnimate = false;\r\n                        self.viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date());\r\n                    }\r\n\r\n                    if (self.view3D.trackDataSource) {\r\n                        if (self.view3D.trackDataSource.length > 0) {\r\n                            var entity = self.view3D.trackDataSource.get(0).entities.values[0];\r\n                            self.viewer.entities.removeById(entity.id);\r\n                        }\r\n\r\n                        self.view3D.trackDataSource.destroy();\r\n                        delete self.view3D.trackDataSource;\r\n                    }\r\n\r\n                    geolocation2D.chartProgressClear();\r\n\r\n                    if (event.custom) {\r\n                        const selectedTrack = geolocation2D.getSelectedTrack();\r\n                        if (selectedTrack) {\r\n                            selectedTrack.querySelector(geolocation2D.Const.Selector.STOP).click();\r\n                        }\r\n                    }\r\n                    break;\r\n                case event.target.className.indexOf('play') > -1:\r\n                    self.viewer.clock.shouldAnimate = false;\r\n                    break;\r\n                case event.target.className.indexOf('pause') > -1:\r\n                    self.viewer.clock.shouldAnimate = true;\r\n                    break;\r\n                case event.target.className.indexOf('back') > -1:\r\n                case event.target.className.indexOf('for') > -1:\r\n                    self.viewer.clock.multiplier = geolocation2D.simulate_speed;\r\n                    break;\r\n            }\r\n        };\r\n        /* fin geolocation */\r\n\r\n        const alterAllowedControls = function (view) {\r\n            var self = this;\r\n\r\n            const ctrlsToMngCLASS = self.ctrlsToMng.map(function (ctrl) { return ctrl.CLASS });\r\n\r\n            self.map.controls.forEach(function (mapCtrl) {\r\n                if (ctrlsToMngCLASS.indexOf(mapCtrl.CLASS) < 0) {\r\n                    switch (true) {\r\n                        case (TC.Consts.view.DEFAULT == view):\r\n                            mapCtrl.enable();\r\n                            break;\r\n                        case (TC.Consts.view.THREED == view):\r\n                            mapCtrl.disable();\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n            switch (true) {\r\n                case (TC.Consts.view.DEFAULT == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.remove(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.remove(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n                case (TC.Consts.view.THREED == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.add(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.add(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            const onLeftClickOnCanvas = (movement) => {\r\n\r\n                // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                if (self.viewer.trackedEntity) {\r\n                    return;\r\n                }\r\n\r\n                const getFeatureInfo = function () {\r\n                    var ray = self.viewer.camera.getPickRay(movement.position);\r\n                    var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                    if (position) {\r\n                        self.view3D.getInfoOnPickedPosition.call(self, position);\r\n                    }\r\n                };\r\n\r\n                var pickedFeature = self.viewer.scene.pick(movement.position);\r\n                if (pickedFeature && pickedFeature.id) {\r\n                    var id = pickedFeature.id instanceof Cesium.Entity ? pickedFeature.id.name : pickedFeature.id;\r\n\r\n                    var founded = false;\r\n                    for (var layerId in self.view3D.vector2DFeatures) {\r\n                        if (self.view3D.vector2DFeatures[layerId].hasOwnProperty(id)) {\r\n                            var feature2D = self.map.workLayers.filter(function (workLayer) {\r\n                                return workLayer.id === layerId;\r\n                            })[0].features.filter(function (feature) {\r\n                                return id.indexOf(feature.id) > -1 && feature.showsPopup;\r\n                            });\r\n\r\n                            if (feature2D && feature2D.length > 0) {\r\n                                founded = true;\r\n\r\n                                if (feature2D.CLASSNAME !== \"TC.feature.Point\" && feature2D.CLASSNAME !== \"TC.feature.Marker\") {\r\n\r\n                                    var ray = self.viewer.camera.getPickRay(movement.position);\r\n                                    var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n\r\n                                    var marker = self.map.view3D.addNativeFeature.call(self.map, {\r\n                                        position: position,\r\n                                        billboard: {\r\n                                            image: TC.Util.getBackgroundUrlFromCss(self.CLASS + '-marker'),\r\n                                            eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                        }\r\n                                    });\r\n\r\n                                    const onDrawTable = function (e) {\r\n                                        if (e.control) {\r\n                                            const control = e.control;\r\n                                            const onTableClose = function (e) {\r\n                                                if (e.control === control) {\r\n                                                    self.map.off(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                    self.map.view3D.removeFeature.call(self, marker);\r\n                                                }\r\n                                            };\r\n                                            self.map.on(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                            self.map.off(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                        }\r\n                                    }\r\n                                    self.map.on(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                }\r\n\r\n                                self.map.trigger(TC.Consts.event.FEATURECLICK, { feature: feature2D[0] });\r\n\r\n                                break;\r\n                            }\r\n\r\n                        }\r\n                    }\r\n\r\n                    if (!founded) {\r\n                        getFeatureInfo();\r\n                    }\r\n                } else {\r\n                    getFeatureInfo();\r\n                }\r\n            };\r\n            const onMouseMoveOnCanvas = (movement) => {\r\n                // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                if (self.viewer.trackedEntity) {\r\n                    return;\r\n                }\r\n                var pickedFeature = self.viewer.scene.pick(movement.endPosition);\r\n                if (pickedFeature && pickedFeature.id) {\r\n                    self.viewer.canvas.style.cursor = 'pointer';\r\n                } else {\r\n                    self.viewer.canvas.style.cursor = 'default';\r\n                }\r\n            };\r\n\r\n            if (TC.Consts.view.THREED === view) {\r\n\r\n                if (!self.view3D.linked2DControls.featureInfo) {\r\n                    self.view3D.linked2DControls.featureInfo = new TwoDLinkedFeatureInfo(self);\r\n                }\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfFeatures = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfFeatures.setInputAction(onLeftClickOnCanvas, Cesium.ScreenSpaceEventType.LEFT_CLICK);\r\n                self.eventHandlers.handlerOfFeatures.setInputAction(onMouseMoveOnCanvas, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n\r\n            } else if (TC.Consts.view.DEFAULT === view) {\r\n                if (self.eventHandlers.handlerOfFeatures) {\r\n                    self.eventHandlers.handlerOfFeatures.destroy();\r\n                }\r\n            }\r\n\r\n            if (!self.view3D.linked2DControls.geolocation && self.allowedControls.indexOf(\"geolocation\") > -1) {\r\n                self.view3D.linked2DControls.geolocation = self.ctrlsToMng.filter(function (ctrl) {\r\n                    return ctrl instanceof TC.control.Geolocation;\r\n                })[0];\r\n            }\r\n\r\n            if (self.view3D.linked2DControls.geolocation) {\r\n\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n\r\n                if (TC.Consts.view.THREED === view) {\r\n\r\n                    var commands = [geolocation2D.Const.Selector.STOP,\r\n                    geolocation2D.Const.Selector.PAUSE,\r\n                    geolocation2D.Const.Selector.BACKWARD,\r\n                    geolocation2D.Const.Selector.FORWARD,\r\n                    geolocation2D.Const.Selector.DRAW];\r\n                    var geolocation_videoControls_ = geolocation_videoControls.bind(self);\r\n\r\n                    var lstEventListener = function (e) {\r\n                        var classes = commands;\r\n                        if (commands.some(function (cls) {\r\n                            return e.target.classList.contains(cls.replace('.', ''))\r\n                        })) {\r\n                            geolocation_videoControls_(e);\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D.reset = function () {\r\n\r\n                        TC.wrap.control.Geolocation.prototype.setTracking = geolocation2D._setTracking;\r\n                        TC.wrap.control.Geolocation.prototype.simulateTrack = geolocation2D._wrap_simulateTrack;\r\n                        TC.wrap.control.Geolocation.prototype.showElevationMarker = geolocation2D._wrap_showElevationMarker;\r\n                        TC.wrap.control.Geolocation.prototype.hideElevationMarker = geolocation2D._wrap_hideElevationMarker;\r\n\r\n                        geolocation2D.simulateTrack = geolocation2D._simulateTrack;\r\n                        geolocation2D.elevationTrack = geolocation2D._elevationTrack;\r\n\r\n                        commands.forEach(function (command) {\r\n                            document.removeEventListener('click', lstEventListener);\r\n                        });\r\n\r\n                        geolocation2D.off(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    };\r\n\r\n                    document.addEventListener('click', lstEventListener);\r\n\r\n                    geolocation2D.on(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n\r\n                    var _newPosition = false;\r\n                    geolocation2D._setTracking = TC.wrap.control.Geolocation.prototype.setTracking;\r\n                    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n\r\n                        geolocation2D._setTracking.call(geolocation2D.wrap, tracking);\r\n\r\n                        if (tracking) {\r\n                            geolocation2D.on(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                        } else {\r\n                            _newPosition = false;\r\n                            geolocation2D.off(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                            if (self.view3D.trackingEntity) {\r\n                                self.viewer.entities.removeById(self.view3D.trackingEntity.id);\r\n                                delete self.view3D.trackingEntity;\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D._elevationTrack = geolocation2D.elevationTrack;\r\n                    geolocation2D.elevationTrack = function (li, resized) {\r\n\r\n                        if (resized) {\r\n                            geolocation_videoControls.call(self, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        return geolocation2D._elevationTrack.call(geolocation2D, li, resized);\r\n                    };\r\n\r\n                    // Si en el paso de 2D a 3D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = geolocation2D.getSelectedTrack();\r\n                    if (selectedTrack && geolocation2D.hasElevation) {\r\n                        geolocation2D.elevationTrack.call(self, selectedTrack, true);\r\n                    }\r\n\r\n                    var simulationOnPreUpdate; // listener de la simulación.\r\n                    geolocation2D._simulateTrack = geolocation2D.simulateTrack;\r\n                    geolocation2D.simulateTrack = function (li) {\r\n                        var self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        self.map.toast(self.getLocaleString('threed.interactionSimulation'), { type: TC.Consts.msgType.INFO });\r\n\r\n                        // tenemos una simulación activa\r\n                        if (this.viewer.clock.shouldAnimate && this.view3D.trackDataSource) {\r\n                            simulationOnPreUpdate();\r\n                            geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        self.simulate_speed = 1;\r\n                        self.drawTrack(li, false).then(function () {\r\n                            self.wrap.simulateTrack();\r\n\r\n                            if (self.layerTrack && self.layerTrack.features) {\r\n                                var track = self.layerTrack.features.filter(function (feature) {\r\n                                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                                })[0];\r\n\r\n                                if (track) {\r\n                                    toCZML.call(this, track.geometry, track.wrap.feature.getGeometry().layout, \"track\", self.markerStyle, self.lineStyle, self.walkingSpeed).then(function (result) {\r\n                                        var czml = result.czml, totalDistance = result.totalDistance, coordinates2D = result.coordinates2D;\r\n\r\n                                        this.view3D.trackDataSource = new Cesium.DataSourceCollection();\r\n                                        var dataSourceDisplay = new Cesium.DataSourceDisplay({\r\n                                            scene: this.viewer.scene,\r\n                                            dataSourceCollection: this.view3D.trackDataSource\r\n                                        });\r\n\r\n                                        this.viewer.scene.preRender.addEventListener(function (scene, time) {\r\n                                            dataSourceDisplay.update(time);\r\n                                        });\r\n\r\n                                        this.view3D.trackDataSource.add(Cesium.CzmlDataSource.load(czml)).then(function (layout, coordinates2D, czmlDataSource) {\r\n\r\n                                            this.viewer.clock.shouldAnimate = false;\r\n\r\n                                            var start, stop;\r\n                                            start = czmlDataSource.clock.startTime;\r\n                                            stop = czmlDataSource.clock.stopTime;\r\n\r\n                                            this.viewer.clock.startTime = start.clone();\r\n                                            this.viewer.clock.stopTime = stop.clone();\r\n                                            this.viewer.clock.currentTime = start.clone();\r\n                                            this.viewer.clock.clockStep = Cesium.ClockStep.TICK_DEPENDENT\r\n                                            this.viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;\r\n                                            this.viewer.clock.multiplier = 1;\r\n\r\n                                            var trackEntity = czmlDataSource.entities.values[0];\r\n\r\n                                            trackEntity.layout = layout;\r\n\r\n                                            trackEntity.tagLI = li; // tengo que guardar la relación con el HTML porque puede eliminar la selección del track mientras estamos creando la simulación del mismo, y no tengo forma de validarlo\r\n\r\n                                            trackEntity.availability = new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({\r\n                                                start: start,\r\n                                                stop: stop\r\n                                            })]);\r\n\r\n                                            if (this.viewer.trackedEntity) {\r\n                                                this.viewer.entities.removeById(this.viewer.trackedEntity.id);\r\n                                                this.viewer.trackedEntity = null;\r\n                                            }\r\n\r\n                                            this.viewer.entities.add(trackEntity);\r\n\r\n                                            this.viewer.flyTo(trackEntity).then(function () {\r\n\r\n                                                this.viewer.trackedEntity = trackEntity;\r\n\r\n                                                function get2DHeightAtProgress(coordinates2D, distanceCurrent) {\r\n                                                    var coordinate;\r\n\r\n                                                    var doneDistance = 0;\r\n\r\n                                                    var reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[0], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[0];\r\n                                                    var previous = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                    for (var i = 1; i < coordinates2D.length; i++) {\r\n                                                        reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[i], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[i];\r\n                                                        var current = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                        doneDistance += new Cesium.EllipsoidGeodesic(previous, current).surfaceDistance;\r\n                                                        previous = current;\r\n\r\n                                                        if (doneDistance > distanceCurrent) {\r\n                                                            coordinate = coordinates2D[i - 1];\r\n                                                            break;\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    if (coordinate) {\r\n                                                        var heightIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 2 :\r\n                                                            trackEntity.layout === ol.geom.GeometryLayout.XYZ ? 2 : -1;\r\n                                                        if (heightIndex > -1) {\r\n                                                            return coordinate[heightIndex];\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    return 0;\r\n                                                };\r\n\r\n                                                var previousPosition, distanceCurrent = 0;\r\n                                                simulationOnPreUpdate = this.viewer.scene.preUpdate.addEventListener(function (scene, currentTime) {\r\n\r\n                                                    // mientras estamos preparando la simulación ha eliminado la selección de dicho track \r\n                                                    const selectedTrack = this.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                                                    if (!selectedTrack || selectedTrack.getAttribute('data-id') !== trackEntity.tagLI.getAttribute('data-id') ||\r\n                                                        // o hemos llegado al final\r\n                                                        Cesium.JulianDate.greaterThanOrEquals(currentTime, trackEntity.availability.stop)) {\r\n\r\n                                                        simulationOnPreUpdate();\r\n                                                        geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n\r\n                                                    } else if (this.viewer.clock.shouldAnimate && trackEntity.isAvailable(currentTime)) {\r\n\r\n                                                        // gestionamos las posiciones anterior y actual\r\n                                                        if (!previousPosition) {\r\n                                                            previousPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, trackEntity.availability.start));\r\n                                                        }\r\n                                                        currentPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, currentTime));\r\n\r\n                                                        // progreso en el perfil (si lo hay)\r\n                                                        if (this.view3D.linked2DControls.geolocation.hasElevation) {\r\n                                                            var timeIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 3 :\r\n                                                                trackEntity.layout === ol.geom.GeometryLayout.XYM ? 2 : 3;\r\n\r\n                                                            this.view3D.linked2DControls.geolocation.chartSetProgress({\r\n                                                                p: [previousPosition.longitude, previousPosition.latitude, previousPosition.height],\r\n                                                                d: distanceCurrent\r\n                                                            },\r\n                                                                [currentPosition.longitude, currentPosition.latitude, get2DHeightAtProgress.call(this, coordinates2D, distanceCurrent)],\r\n                                                                totalDistance, (trackEntity.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                                    trackEntity.layout === ol.geom.GeometryLayout.XYM ?\r\n                                                                    this.view3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(trackEntity.availability.start), Cesium.JulianDate.toDate(currentTime)) : false));\r\n                                                        }\r\n\r\n                                                        // gestionamos las posiciones anterior y actual y la distancia\r\n                                                        distanceCurrent += new Cesium.EllipsoidGeodesic(previousPosition, currentPosition).surfaceDistance;\r\n                                                        previousPosition = currentPosition;\r\n\r\n                                                        this.viewer.scene.requestRender();\r\n                                                    }\r\n                                                }.bind(this));\r\n\r\n                                                this.viewer.clock.shouldAnimate = true;\r\n\r\n                                            }.bind(this));\r\n\r\n                                            //self.view3D.customRender.restart();\r\n                                            this.viewer.scene.requestRender();\r\n\r\n                                        }.bind(this, track.wrap.feature.getGeometry().layout, coordinates2D));\r\n                                    }.bind(this));\r\n                                }\r\n                            }\r\n                        }.bind(this));\r\n\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_simulateTrack = TC.wrap.control.Geolocation.prototype.simulateTrack;\r\n                    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n                        var self = this;\r\n\r\n                        //if (self.parent.hasElevation) {\r\n                        //    self.parent.chartProgressInit();\r\n                        //}\r\n                    };\r\n\r\n                    geolocation2D._wrap_showElevationMarker = TC.wrap.control.Geolocation.prototype.showElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.showElevationMarker = function (data) {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n                        const coords = self.elevationChartData.coords;\r\n\r\n                        // GLS: si la capa del track está visible mostramos marcamos punto del gráfico en el mapa\r\n                        if (self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0) {\r\n\r\n                            var camera = this.viewer.camera;\r\n                            var elevationMarkerPosition = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coords[data[0].index], this.view3D.view2DCRS, this.view3D.crs) : coords[data[0].index];\r\n\r\n                            if (!self.elevationMarker) {\r\n\r\n                                var billboard = new Cesium.Entity({\r\n                                    position: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]),\r\n                                    name: 'elevationMarker',\r\n                                    billboard: {\r\n                                        image: \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==\",\r\n                                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                    }\r\n                                });\r\n\r\n                                self.elevationMarker = this.view3D.addNativeFeature.call(this, billboard);\r\n                            } else {\r\n                                self.elevationMarker.position = Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1], camera.positionCartographic.height);\r\n                                this.viewer.scene.requestRender();\r\n                            }\r\n\r\n                            // No ubicar la camara en el marker\r\n                            //var rectangle = camera.computeViewRectangle();\r\n                            //if (elevationMarkerPosition[0] >= rectangle.west && elevationMarkerPosition[0] <= rectangle.east && elevationMarkerPosition[1] >= rectangle.south && elevationMarkerPosition[1] <= rectangle.north) { }\r\n                            //else {\r\n                            //    var distance = Cesium.Cartesian3.distance(camera.position, Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]));\r\n                            //    camera.setView({\r\n                            //        destination: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1])\r\n                            //    });\r\n\r\n                            //    camera.moveBackward(distance);\r\n                            //}\r\n                        }\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_hideElevationMarker = TC.wrap.control.Geolocation.prototype.hideElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.hideElevationMarker = function () {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        this.view3D.removeFeature.call(this, self.elevationMarker);\r\n                        self.elevationMarker = null;\r\n                    }.bind(self);\r\n\r\n\r\n\r\n                } else {\r\n                    // Si en el paso de 3D a 2D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = self.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                    if (selectedTrack && self.view3D.linked2DControls.geolocation.hasElevation) {\r\n\r\n                        geolocation2D._elevationTrack.call(self.view3D.linked2DControls.geolocation, selectedTrack, true);\r\n                    }\r\n                }\r\n            }\r\n\r\n        };\r\n\r\n        const draw2DDrawedFeatures = function () {\r\n            var self = this;\r\n\r\n            self.map.workLayers.filter(function (layer) {\r\n                return layer instanceof TC.layer.Vector;\r\n            }).forEach(function (vectorLayer) {\r\n                vectorLayer.features.forEach(function (feature) {\r\n                    self.view3D.addFeature.call(self.view3D, feature);\r\n                });\r\n            });\r\n        };\r\n\r\n        var initialExtent, zoomin, zoomout;\r\n        const override2DZoom = function (activate) {\r\n            var self = this;\r\n\r\n            var amount = 200.0;\r\n\r\n            var zoom = function (amount) {\r\n                var self = this;\r\n\r\n                var center = new Cesium.Cartesian2(\r\n                    self.viewer.scene.canvas.clientWidth / 2,\r\n                    self.viewer.scene.canvas.clientHeight / 2);\r\n\r\n                /*\r\n                var x = center.x;\r\n                var y = center.y;\r\n                var event = new window.WheelEvent (\"wheel\", {deltaY: -100,\r\n                    deltaMode: 0,\r\n                    DOM_DELTA_PIXEL: 0,\r\n                    DOM_DELTA_LINE: 1,\r\n                    detail: 0,\r\n                    wheelDelta: 120,\r\n                    layerX: x, layerY: y,\r\n                    clientX: x, clientY: y,\r\n                    offsetX: x, offsetY: y,\r\n                    pageX: x, pageY: y,\r\n                    screenX: x, screenY: y\r\n                });\r\n                self.viewer.scene.canvas.dispatchEvent(event);*/\r\n\r\n                self.view3D.zoomToCartesian.call(self, { endPosition: center }, amount);\r\n            };\r\n\r\n            if (activate) {\r\n                initialExtent = function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var sourceCRS = self.view3D.view2DCRS;\r\n                    if (self.map.options.crs !== self.view3D.view2DCRS) {\r\n                        sourceCRS = self.map.options.crs;\r\n                    }\r\n\r\n                    var coordsXY = TC.Util.reproject(self.map.options.initialExtent.slice(0, 2), sourceCRS, self.view3D.crs);\r\n                    var coordsXY2 = TC.Util.reproject(self.map.options.initialExtent.slice(2), sourceCRS, self.view3D.crs);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle, { duration: 0.1 });\r\n\r\n                    return false;\r\n\r\n                }.bind(self);\r\n\r\n                zoomin = function (e) {\r\n                    zoom.call(self, amount);\r\n                }.bind(self);\r\n\r\n                zoomout = function (e) {\r\n                    zoom.call(self, -amount);\r\n                }.bind(self);\r\n\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.addEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.addEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.addEventListener('click', zoomout);\r\n                });\r\n            }\r\n            else {\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.removeEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomout);\r\n                });\r\n            }\r\n        };\r\n\r\n        const fromTCtoCesiumEvent = function (eventTC) {\r\n            if (TC.Consts.event.MOUSEMOVE === eventTC) {\r\n                return TC.Util.detectMobile() ? Cesium.ScreenSpaceEventType.LEFT_CLICK : Cesium.ScreenSpaceEventType.MOUSE_MOVE;\r\n            } else if (TC.Consts.event.CLICK === eventTC) {\r\n                return Cesium.ScreenSpaceEventType.LEFT_CLICK;\r\n            }\r\n\r\n            return eventTC;\r\n        };\r\n\r\n        return {\r\n\r\n            container: null,\r\n\r\n            crs: 'EPSG:4326',\r\n            crsPattern: /(EPSG\\:?4326)/i,\r\n\r\n            view2DCRS: null,\r\n\r\n            customRender: null,\r\n\r\n            baseLayer: null,\r\n\r\n            workLayers: [],\r\n            vector2DLayers: [],\r\n            vector2DFeatures: {\r\n            },\r\n\r\n            linked2DControls: {\r\n            },\r\n\r\n            isLoadingTiles: function () {\r\n                var self = this;\r\n\r\n                var surface = self.viewer.scene.globe['_surface'];\r\n                return !surface['_tileProvider'].ready ||\r\n                    surface['_tileLoadQueueHigh'].length > 0 ||\r\n                    surface['_tileLoadQueueMedium'].length > 0 ||\r\n                    surface['_tileLoadQueueLow'].length > 0 ||\r\n                    surface['_debug']['tilesWaitingForChildren'] > 0;\r\n            },\r\n\r\n            loadViewer: function () {\r\n                const self = this;\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.viewer) {\r\n\r\n                        TC.loadJS(!window.Cesium, TC.Consts.url.CESIUM, function () {\r\n\r\n                            var resourceBoundaries = Cesium.Resource.fetchJson({ url: TC.apiLocation + \"/dataSource/contornoNavarra.json\" }).then(function (bounds) {\r\n                                if (bounds && bounds.features && bounds.features.length > 0) {\r\n                                    return bounds.features[0].geometry.coordinates[0];\r\n                                } else {\r\n                                    return [];\r\n                                }\r\n                            });\r\n\r\n                            Cesium.when.all([Cesium.ApproximateTerrainHeights.initialize(), resourceBoundaries], function () {\r\n\r\n                                var boundaries = Array.prototype.slice.call(arguments[0])[1];\r\n\r\n                                var terrainFallback;\r\n                                if (self.terrainFallback) {\r\n                                    terrainFallback = {\r\n                                        url: self.terrainFallback.url.trim(),\r\n                                        layerName: self.terrainFallback.layerName,\r\n                                        format: self.terrainFallback.format,\r\n                                        noDataValue: self.terrainFallback.noDataValue\r\n                                    };\r\n                                }\r\n\r\n                                var terrainProvider;\r\n                                if (terrainFallback) {\r\n                                    terrainProvider = new Cesium.MergeTerrainProvider(self.terrain, self, {\r\n                                        boundaries: boundaries,\r\n                                        fallback: [terrainFallback]\r\n                                    });\r\n                                } else {\r\n                                    terrainProvider = new Cesium.CesiumTerrainProvider({\r\n                                        url: self.terrain.url.trim()\r\n                                    });\r\n\r\n                                    terrainProvider.sampleTerrainMostDetailed = function (positions) {\r\n                                        return Cesium.sampleTerrainMostDetailed(terrainProvider, positions);\r\n                                    };\r\n\r\n                                    terrainProvider.attributions = {\r\n                                    };\r\n\r\n                                    if (self.terrain.attributions) {\r\n\r\n                                        terrainProvider.getAttribution = function () {\r\n                                            return terrainProvider.attributions;\r\n                                        };\r\n\r\n                                        terrainProvider.attributions = self.terrain.attributions;\r\n                                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERADD, { terrainProvider: terrainProvider });\r\n                                    }\r\n                                }\r\n\r\n                                var globe = new Cesium.Globe();\r\n                                globe.baseColor = Cesium.Color.WHITE;\r\n                                globe.enableLighting = false;\r\n\r\n                                /* carga más rápido pero consume RAM a cascoporro */\r\n                                globe.tileCacheSize = 1000;\r\n\r\n                                /* por defecto 2, a mayor número mayor rendimiento y peor calidad visual */\r\n                                globe.maximumScreenSpaceError = 5;\r\n\r\n                                self.viewer = self.view3D.viewer = new Cesium.Viewer(self.selectors.divThreedMap, {\r\n                                    terrainProvider: terrainProvider,\r\n                                    terrainExaggeration: 1.0,\r\n\r\n                                    animation: false,\r\n                                    timeline: false,\r\n                                    fullscreenButton: false,\r\n                                    baseLayerPicker: false,\r\n                                    imageryProvider: false,\r\n                                    navigationInstructionsInitiallyVisible: false,\r\n                                    navigationHelpButton: false,\r\n                                    geocoder: false,\r\n                                    homeButton: false,\r\n                                    infoBox: false,\r\n                                    sceneModePicker: false,\r\n                                    selectionIndicator: false,\r\n                                    globe: globe,\r\n\r\n                                    skyBox: false,\r\n                                    skyAtmosphere: false,\r\n\r\n                                    requestRenderMode: true,\r\n                                    maximumRenderTimeChange: Infinity\r\n                                });\r\n\r\n                                // personalización de la escena\r\n                                self.viewer.scene.backgroundColor = Cesium.Color.WHITE;\r\n                                self.viewer.scene.screenSpaceCameraController.enableCollisionDetection = true;\r\n                                self.viewer.scene.screenSpaceCameraController.maximumZoomDistance = 1000000;\r\n\r\n                                //// con false las líneas se manetienen sobre el terreno\r\n                                //self.viewer.scene.globe.depthTestAgainstTerrain = false;\r\n\r\n                                // borramos cualquier capa que haya\r\n                                self.viewer.scene.imageryLayers.removeAll();\r\n\r\n                                // registramos listeners para capturar errores del terreno y del render\r\n                                self.viewer.terrainProvider.errorEvent.addEventListener(function (e) {\r\n                                    var self = this;\r\n                                    if (e.error) {\r\n                                        switch (e.error.statusCode) {\r\n                                            case 403:\r\n                                            case 404:\r\n                                                console.log('es un 404 de terreno');\r\n                                                break;\r\n                                        }\r\n                                    }\r\n                                }, self);\r\n                                self.viewer.scene.renderError.addEventListener(function (target, error) {\r\n                                    var self = this;\r\n\r\n                                    if (error && error.code === 18) { // GLS: 18 - SECURITY_ERR                              \r\n\r\n                                    } else {\r\n                                        self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                                        self.map.toast(self.getLocaleString(\"fi.error\"), { type: TC.Consts.msgType.ERROR });\r\n\r\n                                        self.unapply();\r\n                                    }\r\n                                }, self);\r\n\r\n                                self.viewer.readyPromise = new Promise(function (resolve, reject) {\r\n\r\n                                    // controlamos la carga de tiles para mostrar loading cuando pida tiles\r\n                                    self.view3D.tileLoadingHandler = new Cesium.EventHelper();\r\n                                    self.view3D.tileLoadingHandler.add(self.viewer.scene.globe.tileLoadProgressEvent, function (data) {\r\n                                        if (!self.waiting)\r\n                                            self.waiting = self.map.getLoadingIndicator().addWait();\r\n\r\n                                        if ((self.viewer.scene.terrainProvider.allReady ||\r\n                                            (!self.viewer.scene.terrainProvider.allReady && self.viewer.scene.terrainProvider.ready))\r\n                                            && data === 0) {\r\n                                            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                                            delete self.waiting;\r\n\r\n                                            resolve();\r\n\r\n                                            self.events.trigger(TC.Consts.event.TERRAINLOADED, {});\r\n                                        } else {\r\n                                            self.events.trigger(TC.Consts.event.TERRAINRECEIVING, {});\r\n                                        }\r\n                                    }.bind(self));\r\n                                });\r\n\r\n                                // deshabilitamos el zoom por defecto y manejamos nosotros zoom con rueda\r\n                                //overrideDesktopZoom.call(self);\r\n                                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                                override2DZoom.call(self, true);\r\n\r\n                                // eliminamos los creditos de cesium (no encuentro la manera de que no los ponga)\r\n                                document.querySelectorAll('.cesium-viewer-bottom').forEach(function (elm) {\r\n                                    elm.parentElement.removeChild(elm);\r\n                                });\r\n\r\n                                // enlazamos con los eventos del mapa 2D\r\n                                self.view3D._event2DHandler = event2DHandler.bind(self);\r\n                                self.map.on(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                                // modificamos los controles disponibles\r\n                                alterAllowedControls.call(self, TC.Consts.view.THREED);\r\n\r\n                                self.viewer.readyPromise.then(function () {\r\n                                    // pintamos las features que están en el mapa 2D\r\n                                    draw2DDrawedFeatures.call(self);\r\n                                });\r\n\r\n                                resolve(self.viewer);\r\n\r\n                            });\r\n\r\n                        });\r\n\r\n                    } else {\r\n                        resolve(self.viewer);\r\n                    }\r\n                });\r\n            },\r\n\r\n            setBaseLayer: function (layer) {\r\n                var self = this;\r\n\r\n                var get3DLayer = function (layer) {\r\n                    if (!isCompatible(layer, self.view3D.crs)) {\r\n                        if (layer.getFallbackLayer() !== null && isCompatible(layer.getFallbackLayer(), self.view3D.crs)) {\r\n                            layer = layer.getFallbackLayer();\r\n                        } else {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.title }));\r\n                            layer = null;\r\n                        }\r\n                    }\r\n\r\n                    return layer;\r\n                };\r\n\r\n                if (!self.view3D.baseLayer) {\r\n\r\n                    if (layer.type === TC.Consts.layerType.WMTS || layer.type === TC.Consts.layerType.WMS) {\r\n\r\n                        if (layer.options.relatedWMTS) {\r\n                            self.map.baseLayer = layer = self.map.getLayer(layer.options.relatedWMTS);\r\n                            self.map.trigger(TC.Consts.event.BASELAYERCHANGE, { layer: self.map.baseLayer });\r\n                        } else {\r\n\r\n                            layer = get3DLayer(layer);\r\n\r\n                            if (layer) {\r\n                                if (!layer.isBase) {\r\n                                    layer.isBase = true;\r\n                                }\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n                    }\r\n                } else {\r\n\r\n                    if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                        self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                        self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                    }\r\n\r\n                    if (layer instanceof TC.layer.Vector) {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    }\r\n                    else {\r\n                        layer = get3DLayer(layer);\r\n\r\n                        if (layer) {\r\n                            layer.map = self.map;\r\n                            layer.isBase = true;\r\n\r\n                            self.view3D.addLayer.call(self, layer);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                currentMapCfg.baseMap = self.map.baseLayer;\r\n            },\r\n\r\n            addLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        self.view3D.vector2DLayers.push(layer);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        if (!layer.isBase && !layer.isCompatible(self.view3D.crs)) {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.layerNames }));\r\n                        } else {\r\n                            //var convertedLayer = rasterConverter.convert(layer, self.view3D.crs);\r\n                            rasterConverter.convert(layer, self.view3D.crs).then(function (convertedLayer) {\r\n                                if (convertedLayer) {\r\n\r\n                                    if (convertedLayer[\"enablePickFeatures\"] !== undefined) {\r\n                                        convertedLayer.enablePickFeatures = false;\r\n                                        convertedLayer[\"tcLayer\"] = layer;\r\n                                    }\r\n\r\n                                    if (layer.isBase && self.view3D.baseLayer) {\r\n                                        if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                                            self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                                            self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                                        }\r\n                                    }\r\n\r\n                                    var newImageryLayer = self.viewer.scene.imageryLayers.addImageryProvider(convertedLayer);\r\n\r\n                                    if (layer.isBase) { // si la capa es el mapa de fondo lo envío al fondo de las capas en 3D\r\n                                        self.view3D.baseLayer = newImageryLayer;\r\n                                        self.viewer.scene.imageryLayers.lowerToBottom(newImageryLayer);\r\n                                    } else {\r\n                                        newImageryLayer.show = layer.getVisibility();\r\n                                        newImageryLayer.alpha = layer.getOpacity();\r\n\r\n                                        self.view3D.workLayers.push(newImageryLayer);\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                        break;\r\n                    }\r\n                }\r\n            },\r\n            removeLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n\r\n                        if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(layer.id)) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[layer.id][featureId];\r\n\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[layer.id];\r\n                        }\r\n\r\n                        // GLS revisar, debería estar en workLayers¿? \r\n                        // self.view3D.workLayers.splice(i, 1);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n                                self.viewer.scene.imageryLayers.raiseToTop(self.view3D.workLayers[i]);\r\n                                self.viewer.scene.imageryLayers.remove(self.view3D.workLayers[i], true);\r\n\r\n                                self.view3D.workLayers.splice(i, 1);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsLayer: function (layer, options) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        if (self.view3D.vector2DFeatures[layer.id]) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var features = self.view3D.vector2DFeatures[layer.id][featureId];\r\n                                for (var i = 0; i < features.length; i++) {\r\n                                    self.view3D.setRenderOptionsFeature(features[i], { show: layer.getVisibility() });\r\n                                }\r\n                            }\r\n\r\n                            self.viewer.scene.requestRender();\r\n                        }\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n\r\n                                if (options.hasOwnProperty('visibility')) {\r\n                                    self.view3D.workLayers[i].show = options.visibility;\r\n                                }\r\n\r\n                                if (options.hasOwnProperty('opacity')) {\r\n                                    self.view3D.workLayers[i].alpha = options.opacity;\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n\r\n            flyToMapCoordinates: function (coords) {\r\n                var self = this;\r\n\r\n                var lonlat = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(coords, self.view3D.view2DCRS, self.view3D.crs) : coords;\r\n                var destination = Cesium.Cartesian3.fromDegrees(lonlat[0], lonlat[1], self.viewer.camera.positionCartographic.height);\r\n\r\n                var camera = self.viewer.camera;\r\n                camera.flyTo({\r\n                    destination: destination,\r\n                    orientation: {\r\n                        heading: camera.heading,\r\n                        pitch: camera.pitch\r\n                    }\r\n                });\r\n            }.bind(viewProto),\r\n            flyToRectangle: function (rectangle, options) {\r\n                const self = this;\r\n                // lo primero de todo cancelar movimientos anteriores\r\n                self.viewer.scene.camera.cancelFlight();\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    options = options || {\r\n                    };\r\n\r\n                    var epsilon = Cesium.Math.EPSILON3;\r\n                    if (rectangle.east === rectangle.west) {\r\n                        rectangle.east += epsilon;\r\n                        rectangle.west -= epsilon;\r\n                    }\r\n\r\n                    if (rectangle.north === rectangle.south) {\r\n                        rectangle.north += epsilon;\r\n                        rectangle.south -= epsilon;\r\n                    }\r\n\r\n                    var enlargeFactor = 0.2;\r\n                    var marginX = rectangle.width * enlargeFactor / 2;\r\n                    var marginY = rectangle.height * enlargeFactor / 2;\r\n                    rectangle.east -= marginX;\r\n                    rectangle.west += marginY;\r\n                    rectangle.north += marginY;\r\n                    rectangle.south -= marginY;\r\n\r\n                    var scene = self.viewer.scene;\r\n                    var camera = scene.camera;\r\n\r\n                    var destinationCartesian = camera.getRectangleCameraCoordinates(rectangle);\r\n                    var destination = Cesium.Ellipsoid.WGS84.cartesianToCartographic(destinationCartesian);\r\n\r\n                    Cesium.when(scene.globe.terrainProvider.sampleTerrainMostDetailed([Cesium.Rectangle.center(rectangle)]), function (updatedPositions) {\r\n\r\n                        var finalDestinationCartographic = {\r\n                            longitude: destination.longitude,\r\n                            latitude: destination.latitude,\r\n                            height: destination.height + updatedPositions[0].height || 0\r\n                        };\r\n\r\n                        camera.flyTo({\r\n                            duration: options.duration || 1,\r\n                            destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalDestinationCartographic),\r\n                            complete: function () {\r\n                                var angle = Cesium.Math.toRadians(50);\r\n                                var pickBP = pickBottomPoint(this.viewer.scene);\r\n                                pickBP = Cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                this.view3D.rotateAroundAxis(this.viewer.scene.camera, -angle, this.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 250,\r\n                                    callback: function () {\r\n                                        resolve();\r\n                                    }\r\n                                });\r\n                            }.bind(self)\r\n                        });\r\n                    });\r\n                });\r\n            }.bind(viewProto),\r\n\r\n            zoomToCartesian: function (position, amount) {\r\n                var self = this;\r\n                var scene = self.viewer.scene;\r\n\r\n                if (!position || !position.endPosition) {\r\n                    var canvas = scene.canvas;\r\n                    var center = new Cesium.Cartesian2(\r\n                        canvas.clientWidth / 2,\r\n                        canvas.clientHeight / 2);\r\n                    position = {\r\n                        endPosition: center\r\n                    };\r\n                }\r\n\r\n                var pickRay = scene.camera.getPickRay(position.endPosition);\r\n                var intersection = scene.globe.pick(pickRay, scene);\r\n                if (intersection) {\r\n\r\n                    var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                    if (distanceMeasure < 1) {\r\n                        return;\r\n                    }\r\n                    else {\r\n                        if (!self.view3D._zoomTo) {\r\n                            self.view3D._zoomTo = {\r\n                                amount: 0\r\n                            };\r\n                        }\r\n                        self.view3D._zoomTo.direction = amount > 0 ? 1 : 0;\r\n                        self.view3D._zoomTo.amount += (distanceMeasure * 5 / 100);\r\n                        self.view3D._zoomTo.endPosition = position.endPosition;\r\n                    }\r\n                }\r\n\r\n                var setNewPosition = function (data) {\r\n                    var self = this;\r\n                    var scene = self.viewer.scene;\r\n\r\n                    var pickRay = scene.camera.getPickRay(position.endPosition || data.endPosition);\r\n                    var intersection = scene.globe.pick(pickRay, scene);\r\n                    if (intersection) {\r\n\r\n                        var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                        if (distanceMeasure < 1) {\r\n                            return;\r\n                        }\r\n                        else {\r\n\r\n                            var cameraPosition = scene.camera.position;\r\n                            var cameraDirection = scene.camera.direction;\r\n\r\n                            var toMove = toGo = new Cesium.Cartesian3();\r\n                            Cesium.Cartesian3.multiplyByScalar(pickRay.direction, data.direction == 1 ? data.amount : -data.amount, toMove);\r\n                            Cesium.Cartesian3.add(cameraPosition, toMove, toGo);\r\n\r\n                            var ray = new Cesium.Ray(toGo, pickRay.direction);\r\n                            var intersectionToGo = scene.globe.pick(ray, scene);\r\n                            if (intersectionToGo) {\r\n\r\n                                var reset = function () {\r\n                                    this.view3D._zoomTo = {\r\n                                        direction: 1,\r\n                                        amount: 0,\r\n                                        endPosition: {}\r\n                                    };\r\n\r\n                                    return;\r\n                                };\r\n\r\n                                if (Cesium.Cartesian3.distance(toGo, intersectionToGo) < 1 ||\r\n                                    Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height) < scene.screenSpaceCameraController.minimumZoomDistance) {\r\n                                    reset.call(self);\r\n                                }\r\n                                else {\r\n                                    self.viewer.camera.flyTo({\r\n                                        destination: toGo,\r\n                                        orientation: {\r\n                                            heading: scene.camera.heading,\r\n                                            pitch: scene.camera.pitch,\r\n                                            roll: scene.camera.roll\r\n                                        },\r\n                                        duration: 1,\r\n                                        easingFunction: Cesium.EasingFunction.LINEAR_NONE,\r\n                                        complete: function (distance) {\r\n                                            this.view3D._zoomTo = {\r\n                                                direction: 1,\r\n                                                amount: 0,\r\n                                                endPosition: {}\r\n                                            };\r\n                                        }.bind(self, Cesium.Cartesian3.distance(toGo, intersectionToGo))\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                setTimeout(function () { // GLS: No hemos encontrado otra forma para acumular pasos de la rueda\r\n                    setNewPosition.call(self, self.view3D._zoomTo);\r\n                }.bind(self), 50);\r\n            },\r\n\r\n            rotateAroundAxis: function (camera, angle, axis, transform, opt_options) {\r\n                return rotateAroundAxis(camera, angle, axis, transform, opt_options);\r\n            },\r\n\r\n            addFeature: function (feature, options) {\r\n                var self = this;\r\n\r\n                var add = function () {\r\n                    var csfeature = featureConverter.convert(self.viewer.scene, feature, self.view2DCRS, self.crs);\r\n                    if (csfeature) {\r\n                        if (typeof csfeature.geometry === 'function') {\r\n                            // estoy aquí // tengo que validar qué proveedor escoger, afecta, hay mucha diferencia de alturas, podría ir por capa?? búsquedas fijo por el de por defecto y track validar??\r\n                            csfeature.geometry(self.viewer.terrainProvider).then(function (newGeometry) {\r\n                                // es igual a cuando no es una función... a ver cómo lo gestiono\r\n                                if (newGeometry instanceof Array) {\r\n                                    newGeometry.forEach(function (geom) {\r\n                                        if (geom instanceof Array) {\r\n                                            geom.forEach(function (geo) {\r\n                                                geo = addFeature.call(self, geo);\r\n                                                linkFeature(self, feature.layer.id, geo, feature.id);\r\n                                            });\r\n                                        } else {\r\n                                            geom = addFeature.call(self, geom);\r\n                                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    var geom = addFeature.call(self, newGeometry);\r\n                                    linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                }\r\n                            });\r\n                        }\r\n                        else if (csfeature.geometry instanceof Array) {\r\n                            csfeature.geometry.forEach(function (geom) {\r\n                                geom = addFeature.call(self, geom);\r\n                                linkFeature(self, feature.layer.id, geom, feature.id);\r\n                            });\r\n                        }\r\n                        else {\r\n                            var geom = addFeature.call(self, csfeature.geometry);\r\n                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // GLS: para no pintar la cruz-marker del FeatureInfo\r\n                if ((self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.get2DMarker() === feature) ||\r\n                    (self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.isPending())) {\r\n                    // GLS: llega antes aquí que al callback de la instrucción que crea la feature, por eso necesito el timeout\r\n                    setTimeout(function () {\r\n                        if (self.linked2DControls.featureInfo.get2DMarker() === feature) {\r\n                            return;\r\n                        } else {\r\n                            add();\r\n                        }\r\n                    }, 5);\r\n                } else if (self.linked2DControls.geolocation && self.linked2DControls.geolocation.layerTracking === feature.layer && feature instanceof TC.feature.Polyline) {\r\n                    return;\r\n                } else {\r\n                    add();\r\n                }\r\n            },\r\n            removeFeature: function (feature) {\r\n                var self = this;\r\n                if (self.viewer) {\r\n                    if (feature) {\r\n                        switch (true) {\r\n                            case feature instanceof Cesium.GroundPrimitive:\r\n                                self.viewer.scene.groundPrimitives.remove(feature);\r\n                                break;\r\n                            case feature instanceof Cesium.Billboard:\r\n                                self.viewer.billboardCollection.remove(feature);\r\n                                break;\r\n                            case feature instanceof Object:\r\n                                self.viewer.entities.removeById(feature.id);\r\n                                break;\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsFeature: function (feature, options) {\r\n                if (feature) {\r\n                    feature.show = options.show;\r\n                }\r\n            },\r\n\r\n            addNativeFeature: function (cesiumFeature) {\r\n                return addFeature.call(this.view3D, cesiumFeature);\r\n            },\r\n\r\n            setCameraFromMapView: function () {\r\n                var self = this;\r\n\r\n                self.viewer.scene.globe.terrainProvider.readyPromise.then(function () {\r\n                    var center = self.mapView.getCenter();\r\n\r\n                    if (!center) {\r\n                        return;\r\n                    }\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var distance = calcDistanceForResolution.call(self, self.mapView.getResolution() || 0, Cesium.Math.toRadians(latlon[0]));\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var carto = new Cesium.Cartographic(Cesium.Math.toRadians(latlon[0]), Cesium.Math.toRadians(latlon[1]));\r\n                    if (self.viewer.scene.globe) {\r\n                        carto.height = self.viewer.scene.globe.getHeight(carto) || 0;\r\n                    }\r\n\r\n                    var setCamera = function () {\r\n                        if (self.map.on3DView) {\r\n                            var destination = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                            var orientation = {\r\n                                pitch: Cesium.Math.toRadians(-90),\r\n                                heading: -self.mapView.getRotation(),\r\n                                roll: 0.0\r\n                            };\r\n\r\n                            self.viewer.camera.setView({\r\n                                destination: destination,\r\n                                orientation: orientation\r\n                            });\r\n\r\n                            self.viewer.camera.moveBackward(distance);\r\n                        }\r\n                    };\r\n\r\n                    if (carto.height === 0) {\r\n                        TC.loadJS(!TC.tool || !TC.tool.Elevation, TC.apiLocation + 'TC/tool/Elevation', function () {\r\n                            self.view3D.elevationTool = new TC.tool.Elevation();\r\n                            self.view3D.elevationTool.getElevation({\r\n                                crs: self.view3D.crs,\r\n                                coordinates: [latlon]\r\n                            }).then(function (result) {\r\n                                if (result && result.length > 0) {\r\n                                    carto.height = result[0][2] ? result[0][2] : 0;\r\n                                    setCamera();\r\n                                }\r\n                            }).catch((e) => console.log(e));\r\n                        });\r\n                    } else {\r\n                        setCamera();\r\n                    }\r\n                });\r\n            },\r\n            setViewFromCameraView: function () {\r\n                const self = this;\r\n\r\n\r\n                var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n                var scene = self.viewer.scene;\r\n                var target = target_ = pickCenterPoint(scene);\r\n\r\n                if (!target_) {\r\n                    var globe = self.viewer.scene.globe;\r\n                    var carto = self.viewer.camera.positionCartographic.clone();\r\n                    var height = globe.getHeight(carto);\r\n                    carto.height = height || 0;\r\n                    target_ = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                }\r\n\r\n\r\n                var distance = Cesium.Cartesian3.distance(target_, self.viewer.camera.position);\r\n                var targetCartographic = ellipsoid.cartesianToCartographic(target_);\r\n\r\n                var centerMapCRS = self.view3D.crs !== self.view3D.view2DCRS ? TC.Util.reproject(\r\n                    [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)],\r\n                    self.view3D.crs, self.view3D.view2DCRS) : [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)];\r\n\r\n                self.mapView.setCenter(centerMapCRS);\r\n\r\n                self.mapView.setResolution(calcResolutionForDistance.call(self, distance, targetCartographic ? targetCartographic.latitude : 0));\r\n\r\n                // GLS: No tenemos la rotación del mapa activada por problemas con el iPad\r\n                //if (target) {\r\n                //    var pos = self.viewer.camera.position;\r\n\r\n                //    var targetNormal = new Cesium.Cartesian3();\r\n                //    ellipsoid.geocentricSurfaceNormal(target, targetNormal);\r\n\r\n                //    var targetToCamera = new Cesium.Cartesian3();\r\n                //    Cesium.Cartesian3.subtract(pos, target, targetToCamera);\r\n                //    Cesium.Cartesian3.normalize(targetToCamera, targetToCamera);\r\n\r\n                //    // HEADING\r\n                //    var up = self.viewer.camera.up;\r\n                //    var right = self.viewer.camera.right;\r\n                //    var normal = new Cesium.Cartesian3(-target.y, target.x, 0);\r\n                //    var heading = Cesium.Cartesian3.angleBetween(right, normal);\r\n                //    var cross = Cesium.Cartesian3.cross(target, up, new Cesium.Cartesian3());\r\n                //    var orientation = cross.z;\r\n\r\n                //    self.mapView.setRotation((orientation < 0 ? heading : -heading));\r\n                //    self.setViewFromCameraViewInProgress.resolve();\r\n                //}\r\n\r\n                return Promise.resolve();\r\n            },\r\n\r\n            lookAt: function (coords) {\r\n                const self = this;\r\n\r\n                if (self.crs !== self.view2DCRS) {\r\n                    coords = TC.Util.reproject(coords, self.view2DCRS, self.crs);\r\n                }\r\n\r\n                var camera = self.viewer.camera;\r\n                var positionCartographic = camera.positionCartographic;\r\n                var height = positionCartographic.height;\r\n                var cartographic = new Cesium.Cartographic(Cesium.Math.toRadians(coords[0]), Cesium.Math.toRadians(coords[1]), height)\r\n\r\n                camera.flyTo({\r\n                    destination: Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height),\r\n                    duration: 1.0\r\n                });\r\n            },\r\n\r\n            getInfoOnPickedPosition: function (pickedPosition) {\r\n                var self = this;\r\n\r\n                if (!pickedPosition) {\r\n                    return;\r\n                } else {\r\n\r\n                    self.map.one(TC.Consts.event.DRAWTABLE, function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n\r\n                    self.view3D.linked2DControls.featureInfo.send.call(self, pickedPosition).then(function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n                }\r\n            },\r\n\r\n            on: function (event, callback) {\r\n                const self = this;\r\n\r\n                const movement3DtoPosition2D = function (movement) {\r\n                    if (self.viewer && self.viewer.cesiumWidget) {\r\n                        var ray = self.viewer.camera.getPickRay(movement.endPosition || movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            var positionCartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n\r\n                            var lat, lon, ele;\r\n                            lat = Cesium.Math.toDegrees(positionCartographic.latitude);\r\n                            lon = Cesium.Math.toDegrees(positionCartographic.longitude);\r\n                            ele = Math.round(positionCartographic.height);\r\n\r\n                            return { lon: lon, lat: lat, ele: ele };\r\n                        }\r\n                    }\r\n\r\n                    return null;\r\n                };\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfMovementConversion = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfMovementConversion.setInputAction(function (event) {\r\n                    if (event.endPosition || event.position) {\r\n                        // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                        if (self.viewer.trackedEntity) {\r\n                            return;\r\n                        }\r\n\r\n                        callback(movement3DtoPosition2D(event));\r\n                    } else {\r\n                        callback(event);\r\n                    }\r\n\r\n                }, fromTCtoCesiumEvent(event));\r\n            },\r\n\r\n            getHeightFromMDT: function (geoCoords) {\r\n                const self = this;\r\n\r\n                var cartesian = new Cesium.Cartographic(Cesium.Math.toRadians(geoCoords[0]), Cesium.Math.toRadians(geoCoords[1]));\r\n                return self.viewer.scene.globe.getHeight(cartesian) || 0;\r\n            },\r\n\r\n            destroy: function () {\r\n                var self = this;\r\n\r\n                self.map.on3DView = false;\r\n                //self.map.view3D = null;\r\n\r\n                self.view3D.vector2DLayers = [];\r\n                self.view3D.vector2DFeatures = {\r\n                };\r\n\r\n                // eliminamos el enlace con los eventos del mapa 2D\r\n                self.map.off(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                // modificamos los controles disponibles\r\n                alterAllowedControls.call(self, TC.Consts.view.DEFAULT);\r\n\r\n                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                override2DZoom.call(self, false);\r\n\r\n                //addNoCompatibleBaseLayers.call(self);\r\n\r\n                Promise.all(self.map.baseLayers.map(function (baseLayer) {\r\n                    return Promise.resolve(!isCompatible(baseLayer, self.view3D.view2DCRS));\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        var defaultBaseLayer;\r\n                        for (var i = 0; i < self.map.baseLayers.length; i++) {\r\n                            if (!defaultBaseLayer && !results[i]) {\r\n                                defaultBaseLayer = self.map.baseLayers[i];\r\n                            }\r\n                            self.map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n                        var triggerEvent = true;\r\n                        const showReprojectDialog = function (haveToChange, baseLayer, fallbackLayer) {\r\n                            const dialogOptions = {\r\n                                layer: baseLayer\r\n                            };\r\n\r\n                            if (fallbackLayer) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n\r\n                            var control = self.map.getControlsByClass(haveToChange ? TC.control.BasemapSelector : TC.control.Coordinates);\r\n                            if (control.length > 0) {\r\n                                // gestionamos que el control de coordenadas no se renderice en el cambio de vista porque borra el modal de cambio de CRS\r\n                                if (control[0] instanceof TC.control.Coordinates) {\r\n                                    triggerEvent = false;\r\n                                }\r\n                                dialogOptions.closeCallback = function () {\r\n                                    self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                                };\r\n                                control[0].showProjectionChangeDialog(dialogOptions);\r\n                            }\r\n                        };\r\n\r\n                        var baseLayer = currentMapCfg.baseMap == self.Consts.BLANK_BASE ? currentMapCfg.baseVector : currentMapCfg.baseMap;\r\n                        if (!baseLayer.isCompatible(self.map.getCRS())) {\r\n\r\n                            if (!baseLayer.fallbackLayer) {\r\n                                showReprojectDialog(true, baseLayer);\r\n                            } else {\r\n                                baseLayer.getFallbackLayer();\r\n                                if (baseLayer.getFallbackLayer().isCompatible(self.map.getCRS())) {\r\n\r\n                                    // antes de establecer como fondo la capa de respaldo, preguntar al usuario si prefiere cambiar de CRS o si quiere seguir reproyectando al vuelo.\r\n                                    TC.confirm(self.getLocaleString('threed.changeBaselayer'),\r\n                                        function () {\r\n                                            showReprojectDialog(false, baseLayer, baseLayer.fallbackLayer);\r\n                                        }, function () {\r\n                                            self.map.setBaseLayer(baseLayer.fallbackLayer);\r\n                                        });\r\n                                } else {\r\n                                    showReprojectDialog(true, baseLayer);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            self.map.setBaseLayer(baseLayer);\r\n                        }\r\n                    }\r\n\r\n                    currentMapCfg.baseMap = '';\r\n\r\n                    self.view3D.baseLayer = null;\r\n\r\n                    self.view3D.workLayers = [];\r\n\r\n                    self.view3D.cameraControls.unbind();\r\n\r\n                    if (self.view3D.linked2DControls.featureInfo) {\r\n                        self.view3D.linked2DControls.featureInfo.reset();\r\n                    }\r\n\r\n                    if (self.view3D.linked2DControls.geolocation) {\r\n                        self.view3D.linked2DControls.geolocation.isGeo = false;\r\n                        self.view3D.linked2DControls.geolocation.reset();\r\n                    }\r\n\r\n                    self.view3D.tileLoadingHandler.removeAll();\r\n                    delete self.view3D.tileLoadingHandler;\r\n\r\n                    self.viewer.destroy();\r\n                    self.viewer = null;\r\n\r\n                    if (triggerEvent) { // si lanzamos sin más, el control de coordenadas se renderizada en el cambio de vista y borra el modal de cambio de CRS\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    })();\r\n\r\n    return {\r\n        init: viewProto.init.bind(viewProto),\r\n        apply: viewProto.apply.bind(viewProto),\r\n        unapply: viewProto.unapply.bind(viewProto),\r\n        VIEWNAME: viewProto.VIEWNAME\r\n    };\r\n});"]}