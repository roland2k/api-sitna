{"version":3,"sources":["view/ThreeD.js"],"names":["TC","view","Consts","CESIUMNS","control","MapContents","syncLoadJS","apiLocation","viewProto","VIEWNAME","CLASS","BLANK_BASE","DEFAULT_TILE_SIZE","classes","MAP3D","LOADING","CAMERACTRARROWDISABLED","FOCUS","HIGHLIGHTED","DISABLED","OUTFOCUS","allowedControls","template","viewer","mapView","terrainProvider","getLocaleString","key","texts","locale","this","map","options","Cfg","Util","getRenderedHtml","templateId","data","callback","Control","prototype","call","THREED","THREED_HIDDEN","event","TERRAINLOADED","TERRAINRECEIVING","TERRAIN404","compiler","main","container","depth0","helpers","partials","lookupProperty","parent","propertyName","Object","hasOwnProperty","escapeExpression","nullContext","name","hash","loc","start","line","column","end","useData","alias1","alias2","MapView","self","Promise","resolve","getViewHTML","then","html","viewHTML","bind","metersPerUnit","getMetersPerUnit","maxResolution","_oldMapSetCenter","setCenter","coords","on3DView","view3D","flyToMapCoordinates","getCenter","getExtent","getResolution","getRotation","getMaxResolution","getResolutions","extent","baselayerExtent","getPixelFromCoordinate","center","setExtent","setResolution","resolution","setRotation","rotation","isCompatible","layer","crs","type","layerType","WMTS","wrap","getCompatibleMatrixSets","length","distanceSquared","p1","p2","dx","dy","getFarMapCoords","obj","nearMapCoords","nextPixel","bottomPixel","clone","y","Math","round","nextCoords","pickMapCoords","coordsArray","sort","a","b","cameraPosition","origin","nearPoint","angle","atan","PI","cos","sin","apply","pixel","pickPoint","pickOnTerrainOrEllipsoid","scene","cesium","Cartographic","fromCartesian","view2DCRS","reproject","toDegrees","longitude","latitude","calcResolutionForDistance","distance","canvas","fovy","camera","frustum","visibleMeters","tan","relativeCircumference","abs","visibleMapUnits","clientHeight","resolutions","Array","i","ii","pow","rotateAroundAxis","axis","transform","opt_options","clamp","defaultValue","duration","easing","lastProgress","oldTransform","Matrix4","reject","requestAnimationFrame","animation","timestamp","progress","stepAngle","lookAtTransform","rotate","ray","getPickRay","target","globe","pick","pickEllipsoid","pickCenterPoint","Cartesian2","clientWidth","pickBottomPoint","bottom","setHeadingUsingBottomCenter","heading","bottomCenter","angleToZenith","computeAngleToZenith","right","quaternion","Quaternion","fromAxisAngle","Matrix3","fromQuaternion","vector","Cartesian3","subtract","position","zenith","multiplyByVector","add","fromTranslation","signedAngleBetween","first","second","normal","c","normalize","cross","cosine","dot","sine","magnitude","sign","atan2","pivot","fy","fovy2","direction","matrix","Ray","bottomFovRay","negate","Ellipsoid","WGS84","geocentricSurfaceNormal","left","CameraControls","cssRotate","element","coord","getBBox","value","x","width","height","document","getElementsByClassName","className","baseVal","setAttribute","outControlsEvents","detectMouse","outControls","e","isFocusingCameraCtrls","inControlsEvents","inControls","lastFocused","performance","now","div","classList","contains","remove","tiltIndicatorOuterCircle","tiltIndicatorOuterShellCircle","rotateIndicatorOuterCircle","rotateIndicatorOuterShellCircle","moveStart","moving","moveEnd","postRender","isLoadingTiles","customCollisionDetection","getCamera","positionCartographic","tiltIndicator","pitch","rotateIndicator","disableRotate","disableTilt","_coordsXY","_ovMap","getControlsByClass","renderPromise","bottomLeft","bottomRight","fovCoords","elm","filter","farCoordsLeft","farCoordsRight","draw3DCamera","fov","selectors","tilt","indicator","leftArrow","rightArrow","downArrow","upArrow","MIN_TILT","toRadians","MAX_TILT","render","addEventListener","forEach","rAFInOutControls","setOpacity","unbind","HIDDEN","removeEventListener","window","cancelAnimationFrame","undefined","getCameraState","cp","chpr","roll","bcpd","createElement","innerHTML","appendChild","tiltSelector","tiltIndicatorInner","querySelector","replace","CLICK","resetTilt","tiltIndicatorCircle","stopPropagation","preventDefault","vectorScratch","currentTarget","rectangle","getBoundingClientRect","top","clickLocation","clientX","clientY","draggingTilt","cancelBubble","returnValue","tiltUp","disabled","upEvent","tiltUpMouseUpFunction","tiltUpInterval","setInterval","isTiltUpDisabled","clearInterval","tiltDown","tiltDownMouseUpFunction","tiltDownInterval","isTiltDownDisabled","rotateSelector","rotateIndicatorInner","resetRotation","rotateIndicatorCircle","draggingRotate","rotateLeft","rotateLeftMouseUpFunction","rotateLeftInterval","rotateRight","rotateRightMouseUpFunction","rotateRightInterval","theta","toggle","isDisable","trackedEntity","rotateUp","lookUp","lookDown","PI_OVER_TWO","_angle","tiltElement","cursorVector","oldTransformScratch","newTransformScratch","tiltMouseMoveFunction","tiltMouseUpFunction","isTilting","tiltFrame","Transforms","northUpEastToFixedFrame","tiltIsLook","positionWC","startCursorAngle","initialCameraAngle","tiltRectangle","console","log","toString","angleDifference","newCameraAngle","zeroToTwoPi","currentCameraAngle","rotateElement","rotateMouseMoveFunction","rotateMouseUpFunction","rotateRectangle","rotateInitialCursorAngle","rotateInitialCameraAngle","rotateFrame","isRotating","viewCenter","eastNorthUpToFixedFrame","rotateIsLook","rotateInitialCameraDistance","currentRotation","linked2DControls","geolocation","videoControls","custom","mag","scratchAdjustHeightTransform","scratchAdjustHeightCartographic","screenSpaceCameraController","minimumCollisionTerrainHeight","enableCollisionDetection","minimumZoomDistance","ellipsoid","mapProjection","equals","IDENTITY","_setTransform","cartographic","cartesianToCartographic","heightUpdated","getHeight","cartographicToCartesian","multiplyByScalar","max","up","limitCameraToInitExtent","pos","initExtent","west","east","south","north","maxHeight","maximumZoomDistance","padding","min","setView","destination","orientation","TwoDLinkedFeatureInfo","savedMode","pending","marker","ctlResultsPanel","ctlFeatureInfo","map2DgetResolutionFN","getResultsPanelCtl","resultsPanelOptions","content","titles","addControlPromise","controlContainer","POSITION","RIGHT","addControl","caller","resultsPanel","removeMarker","removeFeature","FeatureInfo","displayMode","setDisplayMode","infoContainer","RESULTS_PANEL","on","RESULTSPANELCLOSE","getDisplayControl","querying","clear","closeResults","reset","send","pickedPosition","close","waiting","getLoadingIndicator","addWait","billboard","image","getBackgroundUrlFromCss","eyeOffset","verticalOrigin","VerticalOrigin","BOTTOM","heightReference","HeightReference","CLAMP_TO_GROUND","addNativeFeature","requestRender","setMarker","reprojected","pickedLocation","pixelTolerance","pickedTile","tilesRendered","_surface","_tilesToRender","textureIndex","tile","Rectangle","imageryTiles","imagery","terrainImagery","readyImagery","nativeRectangle","tilingScheme","tileXYToNativeRectangle","level","readyImageryToGetNativeRectangle","imageryLayer","isBaseLayer","west_south","east_north","xResolution","imageryProvider","tileWidth","yResolution","tileHeight","one","NOFEATUREINFO","FEATUREINFO","FEATURECLICK","savedIsActive","isActive","beforeRequest","xy","get2DMarker","filterFeature","isPending","RasterConverter","crsPattern","layerCrs","CustomResource","paths","CRS","TILEMATRIXSET","TILEMATRIXSETLABELS","getOfPath","p","_obj","push","wmtsLayer","resource","resourceURL","tileMatrixSetLabels","capsURL","isOnCapabilities","url","caps","capabilities","tileMatrixSet","CRSCodesEqual","id","Identifier","labels","getTileMatrixSetLabelByLayerOnCapabilities","WMTSEncoding","KVP","encoding","Resource","request","Request","RequestType","IMAGERY","RESTFUL","getWMTSLayer","ResourceURL","tcLayer","layerNames","style","format","GeographicTilingScheme","tileMatrixSetID","tileMatrixLabels","maximumLevel","parseInt","WebMapTileServiceImageryProvider","xhrBlobSupported","xhr","XMLHttpRequest","open","responseType","fetchImage","allowCrossOrigin","requestFunction","crossOrigin","isDataUri","isBlobUri","isCrossOriginUrl","deferred","when","defer","getWebGLUrl","Image","onload","onerror","TrustedServers","src","createImage","promise","RequestScheduler","defined","otherwise","customFetchImage","preferBlob","deprecationWarning","state","RequestState","ISSUED","ACTIVE","RuntimeError","UNISSUED","checkAndResetRequest","hasHeaders","blobPromise","fetchBlob","generatedBlobResource","generatedBlob","blob","blobUrl","URL","createObjectURL","revokeObjectURL","error","convert","map3DCRS","constructor","create","result","cloned","_url","_queryParameters","_templateValues","headers","proxy","retryCallback","retryAttempts","_retryCount","defineCustomResource","WMS","layers","parameters","version","transparent","exBoundingBox","bbox","Capability","Layer","names","slice","_getEXBBox","nodes","n","compareNames","getName","EX_GeographicBoundingBox","exBBox","pop","bindEXBBox","geoBBox","WebMapServiceImageryProvider","FeatureConverter","toCesiumColor","hexStringColor","alpha","color","Color","fromCssColorString","withAlpha","setStyleProperties","styles","properties","feature","attr","prop","val","getFeatureStyle","Defaults","STYLETYPE","extend","getStyle","createLine","entity","Entity","polyline","positions","material","clampToGround","polygonConverter","polygon","opt","opacity","outlineColor","outlineOpacity","ColorGeometryInstanceAttribute","fromColor","MultiPolygon","CLASSNAME","geometryType","polygonHierarchy","getting","geomPolys","geomOutlines","getOutlineGeom","outlineCoords","res","rej","j","hierarchy","PolygonHierarchy","holes","GeometryInstance","geometry","PolygonGeometry","attributes","all","GroundPrimitive","releaseGeometryInstances","geometryInstances","catch","Polygon","isArray","lineConverter","MultiPolyline","geomInstances","minx","miny","maxx","maxy","point","z","fromCartesianArray","neededCameraPosition","getRectangleCameraCoordinates","BoundingSphere","fromPoints","pixelSize","getPixelDimensions","drawingBufferWidth","drawingBufferHeight","pixelRatio","getPixelSize","Polyline","pointConverter","label","fontSize","fontColor","outlineLabelColor","outlineLabelWidth","anchor","outlineWidth","radius","Marker","pixelOffset","text","font","horizontalOrigin","HorizontalOrigin","LEFT","fillColor","showBackground","Point","pinBuilder","PinBuilder","test","CENTER","BASELINE","BLACK","WHITE","LabelStyle","FILL_AND_OUTLINE","fromText","toDataURL","stringifyScratch","drawPin","context2D","size","rgbaColor","darken","toCssColorString","save","scale","strokeStyle","miterLimit","restore","fillStyle","lineWidth","lineJoin","beginPath","moveTo","lineTo","closePath","fill","stroke","translate","arc","createPin","_cache","JSON","stringify","item","getContext","strokeColor","scn","sourceCrs","targetCrs","converter","points","ringsOrPolylines","polygons","byPromise","cartesians","toCartesian","arr","fromDegrees","forPoints","forRingsOrPolylines","Circle","circle","CircleGeometry","forPolygons","boundigSphere","provider","currentMapCfg","baseMap","baseMaps","baseVector","init","events","$events","divThreedMap","terrain","noDataValue","attributions","site","terrainFallback","coverageName","trim","layerName","controls","PROJECTIONCHANGE","parser","DOMParser","overlay","parseFromString","body","firstChild","Error","viewName","substr","toLowerCase","views","newCrs","toast","msgType","INFO","ctrlsToMng","ctls","len","ctl","toUpperCase","ctlsOnMap","CONTROLADD","ctrlClass","instance","Function","warn","concat","applyEnd","removeWait","loadViewer","isBaseRaster","baseLayer","Raster","fallbackLayer","getFallbackLayer","_capabilitiesPromise","baseLayers","results","mustReproject","setCameraFromMapView","setBaseLayer","workLayers","elem","reverse","addLayer","readyPromise","cameraControls","animateRendering","flyTo","fromRadians","complete","pickBP","readyPickBP","_pickBP","matrixPickBP","animationCallback","Camera","DEFAULT_VIEW_RECTANGLE","initialRectangle","computeViewRectangle","DEFAULT_VIEW_FACTOR","checkPickBPProcess","startTime","Date","getTime","checkPickBottomPoint","homeButton","querySelectorAll","NavBarHome","click","trigger","VIEWCHANGE","addHeight","finalCartographic","markers","entities","values","Property","getValueOrUndefined","JulianDate","billboardCollection","get","unapply","simulateTrackEnd","TERRAINPROVIDERREMOVE","fallbackProvider","setViewFromCameraView","destroy","rasterConverter","featureConverter","addFeature","csFeature","addedFeature","groundPrimitives","primitives","BillboardCollection","billboardAtCollection","getById","linkFeature","idLayer","vector2DFeatures","listenTo","BEFOREBASELAYERCHANGE","BASELAYERCHANGE","LAYERADD","LAYERREMOVE","LAYERVISIBILITY","LAYEROPACITY","LAYERORDER","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR","ZOOMTO","geolocation_newPosition","trackingEntity","geolocation2D","track","layerTracking","features","positionCallback","CallbackProperty","time","newCartographicPositions","coordinate","updatedPositions","cartographicArrayToCartesianArray","entityTracking","PolylineDashMaterialProperty","fromAlpha","renderTrack","checked","gapColor","TRANSPARENT","geolocation_videoControls","Const","Event","IMPORTEDTRACK","indexOf","parentElement","Classes","SELECTEDTRACK","clock","shouldAnimate","currentTime","fromDate","trackDataSource","removeById","chartProgressClear","selectedTrack","getSelectedTrack","Selector","STOP","multiplier","simulate_speed","alterAllowedControls","ctrlsToMngCLASS","ctrl","mapCtrl","DEFAULT","enable","disable","onLeftClickOnCanvas","movement","getFeatureInfo","getInfoOnPickedPosition","pickedFeature","founded","layerId","feature2D","workLayer","showsPopup","onDrawTable","onTableClose","off","DRAWTABLE","onMouseMoveOnCanvas","endPosition","cursor","featureInfo","keys","eventHandlers","handlerOfFeatures","ScreenSpaceEventHandler","setInputAction","ScreenSpaceEventType","LEFT_CLICK","MOUSE_MOVE","Geolocation","commands","PAUSE","BACKWARD","FORWARD","DRAW","geolocation_videoControls_","lstEventListener","some","cls","setTracking","_setTracking","simulateTrack","_wrap_simulateTrack","_simulateTrack","elevationTrack","_elevationTrack","command","tracking","POSITIONCHANGE","li","resized","hasElevation","simulationOnPreUpdate","drawTrack","layerTrack","coordinates","layout","pointStyle","lineStyle","walkingSpeed","sampleTerrainMostDetailed","stopTime","totalDistance","ol","geom","GeometryLayout","XYZM","XYM","done","previuos_next","EllipsoidGeodesic","surfaceDistance","toISOString","czml","availability","epoch","cartographicRadians","updatedPosition","reduce","prev","curr","rgba","strokeWidth","coordinates2D","getGeometry","markerStyle","DataSourceCollection","dataSourceDisplay","DataSourceDisplay","dataSourceCollection","preRender","update","CzmlDataSource","load","czmlDataSource","stop","clockStep","ClockStep","TICK_DEPENDENT","clockRange","ClockRange","CLAMPED","trackEntity","tagLI","TimeIntervalCollection","TimeInterval","get2DHeightAtProgress","distanceCurrent","doneDistance","previous","current","heightIndex","XYZ","previousPosition","preUpdate","getAttribute","greaterThanOrEquals","isAvailable","currentPosition","chartSetProgress","d","_getTime","toDate","initialExtent","zoomin","zoomout","override2DZoom","activate","zoom","amount","zoomToCartesian","sourceCRS","coordsXY","coordsXY2","flyToRectangle","button","NavBar","customRender","vector2DLayers","surface","ready","loadJSInOrder","CESIUM","CESIUM_CONNECTOR","resourceBoundaries","fetchJson","bounds","ApproximateTerrainHeights","initialize","boundaries","arguments","MergeTerrainProvider","fallback","CesiumTerrainProvider","getAttribution","TERRAINPROVIDERADD","Globe","baseColor","enableLighting","tileCacheSize","maximumScreenSpaceError","Viewer","terrainExaggeration","timeline","fullscreenButton","baseLayerPicker","navigationInstructionsInitiallyVisible","navigationHelpButton","geocoder","infoBox","sceneModePicker","selectionIndicator","requestRenderMode","maximumRenderTimeChange","Infinity","backgroundColor","imageryLayers","removeAll","errorEvent","statusCode","renderError","code","ERROR","tileLoadingHandler","EventHelper","tileLoadProgressEvent","allReady","removeChild","_event2DHandler","removeLayer","setRenderOptionsLayer","visibility","getVisibility","getOpacity","join","oldIndex","newIndex","lower","raise","splice","threedFeature","featureId","ZOOM","_canvasClientHeight","_canvasClientWidth","lastZoom","Vector","vectorLayer","get3DLayer","title","raiseToTop","isBase","relatedWMTS","getLayer","VECTOR","convertedLayer","enablePickFeatures","newImageryLayer","addImageryProvider","lowerToBottom","show","setRenderOptionsFeature","imageryLayerNames","lonlat","cancelFlight","epsilon","EPSILON3","marginX","marginY","destinationCartesian","finalDestinationCartographic","pickRay","intersection","distanceMeasure","_zoomTo","setTimeout","toMove","toGo","intersectionToGo","easingFunction","EasingFunction","LINEAR_NONE","csfeature","newGeometry","geo","Billboard","cesiumFeature","latlon","carto","setCamera","moveBackward","loadJS","tool","Elevation","elevationTool","getElevation","target_","targetCartographic","centerMapCRS","lookAt","handlerOfMovementConversion","cesiumWidget","lat","lon","ele","movement3DtoPosition2D","eventTC","MOUSEMOVE","detectMobile","getHeightFromMDT","geoCoords","cartesian","addElevationMarker","context","view3DElevationMarkerPromise","RED","view3DElevationMarker","setElevationMarker","hideElevationMarker","defaultBaseLayer","triggerEvent","showReprojectDialog","haveToChange","dialogOptions","BasemapSelector","Coordinates","closeCallback","showProjectionChangeDialog","getCRS","confirm","isGeo","factory"],"mappings":"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","sourcesContent":["/**\r\n  * Opciones básicas de vista.  \r\n  * @typedef ViewOptions  \r\n  * @see MapViewOptions\r\n  * @see 2-configuration\r\n  * @property {HTMLElement|string} [div] - Elemento del DOM en el que crear la vista o valor de atributo id de dicho elemento.   \r\n  */\r\n\r\n\r\nvar TC = TC || {};\r\nTC.view = TC.view || {};\r\n\r\nTC.Consts = TC.Consts || {};\r\nTC.Consts.CESIUMNS = 'cesium';\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n(function (namespace, signature, factory) {\r\n    namespace[signature] = factory();\r\n})(TC.view, \"ThreeD\", function () {\r\n\r\n    var viewProto = {\r\n        VIEWNAME: \"ThreeD\",\r\n        CLASS: 'tc-view-3d',\r\n        Consts: {\r\n            BLANK_BASE: 'blank',\r\n            DEFAULT_TILE_SIZE: 256\r\n        },\r\n        classes: {\r\n            MAP3D: 'tc-map-3d',\r\n            LOADING: 'tc-loading',\r\n            CAMERACTRARROWDISABLED: 'disabled-arrow',\r\n            FOCUS: 'focus',\r\n            HIGHLIGHTED: 'highlighted',\r\n            DISABLED: 'disabled',\r\n            OUTFOCUS: 'outfocus'\r\n        },\r\n        allowedControls: [],\r\n        template: {},\r\n\r\n        viewer: null,\r\n        mapView: null,\r\n        terrainProvider: null,\r\n\r\n        getLocaleString: function (key, texts) {\r\n            var self = this;\r\n            var locale = self.map ? self.map.options.locale : TC.Cfg.locale;\r\n            return TC.Util.getLocaleString(locale, key, texts);\r\n        },\r\n\r\n        getRenderedHtml: function (templateId, data, callback) {\r\n            return TC.Control.prototype.getRenderedHtml.call(this, templateId, data, callback);\r\n        }\r\n    };\r\n\r\n    TC.Consts.classes.THREED = TC.Consts.classes.THREED || \"tc-3d\";\r\n    TC.Consts.classes.THREED_HIDDEN = TC.Consts.classes.THREED_HIDDEN || \"tc-3d-hidden\";\r\n    TC.Consts.event.TERRAINLOADED = TC.Consts.event.TERRAINLOADED || \"terrainloaded.tc.threed\";\r\n    TC.Consts.event.TERRAINRECEIVING = TC.Consts.event.TERRAINRECEIVING || \"terrainreceiving.tc.threed\";\r\n    TC.Consts.event.TERRAIN404 = TC.Consts.event.TERRAIN404 || \"terrain404.tc.threed\";\r\n\r\n    viewProto.template[viewProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-3d.hbs\";\r\n    viewProto.template[viewProto.CLASS + '-overlay'] = TC.apiLocation + \"TC/templates/tc-view-3d-overlay.hbs\";\r\n    viewProto.template[viewProto.CLASS + '-cm-ctls'] = TC.apiLocation + \"TC/templates/tc-view-3d-cm-ctls.hbs\";\r\n\r\n    const MapView = function (map, parent) {\r\n        var self = this;\r\n        self.map = map;\r\n        self.parent = parent;\r\n\r\n        Promise.resolve(self.map.getViewHTML()).then(function (html) {\r\n            self.viewHTML = html;\r\n        }.bind(self));\r\n\r\n        self.metersPerUnit = map.getMetersPerUnit();\r\n\r\n        self.maxResolution = null;\r\n\r\n        //flacunza: modificamos TC.Map.setCenter para que se haga desde la vista 3D cuando está activa\r\n        //así evitamos parpadeos en el mapa de situación\r\n        self._oldMapSetCenter = map.setCenter;\r\n        map.setCenter = function (coords, options) {\r\n            if (map.on3DView) {\r\n                map.view3D.flyToMapCoordinates.call(parent, coords);\r\n            }\r\n            else {\r\n                self._oldMapSetCenter.call(map, coords, options);\r\n            }\r\n        };\r\n    };\r\n    MapView.prototype.getCenter = function () {\r\n        return this.map.getCenter();\r\n    };\r\n    MapView.prototype.getExtent = function () {\r\n        return this.map.getExtent();\r\n    };\r\n    MapView.prototype.getResolution = function () {\r\n        return this.map.getResolution();\r\n    };\r\n    MapView.prototype.getRotation = function () {\r\n        return this.map.getRotation();\r\n    };\r\n    MapView.prototype.getMaxResolution = function () {\r\n        if (this.maxResolution)\r\n            return this.maxResolution;\r\n\r\n        if (this.map.getResolutions() !== null)\r\n            this.maxResolution = this.map.getResolutions()[0];\r\n        else {\r\n            var extent = this.map.options.baselayerExtent;\r\n            this.maxResolution = (extent[2] - extent[0]) / this.parent.Consts.DEFAULT_TILE_SIZE;\r\n        }\r\n\r\n        return this.maxResolution;\r\n    };\r\n    MapView.prototype.getPixelFromCoordinate = function (coords) {\r\n        return this.map.getPixelFromCoordinate(coords);\r\n    };\r\n    MapView.prototype.setCenter = function (center) {\r\n        this._oldMapSetCenter.call(this.map, center);\r\n    };\r\n    MapView.prototype.setExtent = function (extent) {\r\n        this.map.setExtent(extent);\r\n    };\r\n    MapView.prototype.setResolution = function (resolution) {\r\n        this.map.setResolution(resolution);\r\n    };\r\n    MapView.prototype.setRotation = function (rotation) {\r\n        this.map.setRotation(rotation);\r\n    };\r\n\r\n\r\n    //  Funciones compatibilidad CRS\r\n    const isCompatible = function (layer, crs) {\r\n        return layer.type === TC.Consts.layerType.WMTS ?\r\n            layer.wrap.getCompatibleMatrixSets(crs).length > 0 :\r\n            layer.isCompatible(crs);\r\n    };\r\n\r\n    // Funciones para cálculo de FOV\r\n    const getFarCoords = function (origin, nearPoint) {\r\n        var radius = 1000000; // 1000 km\r\n        var dx = nearPoint[0] - origin[0];\r\n        var dy = nearPoint[1] - origin[1];\r\n        var angle = Math.atan(dy / dx);\r\n        // Math.atan solo da resultados entre -90º y 90º, si estamos mirando al hemisferio oeste hay que sumar 180º al ángulo\r\n        if (dx < 0) {\r\n            angle = angle + Math.PI;\r\n        }\r\n        return [origin[0] + radius * Math.cos(angle), origin[1] + radius * Math.sin(angle)];\r\n    };\r\n\r\n    const distanceSquared = function (p1, p2) {\r\n        var dx = p2[0] - p1[0];\r\n        var dy = p2[1] - p1[1];\r\n        return dx * dx + dy * dy;\r\n    };\r\n\r\n    const getFarMapCoords = function (obj) {\r\n        // Calculamos puntos lejanos cuando no los tenemos (cuando estamos mirando al horizonte).\r\n        // Cogemos un punto proyectado desde la esquina inferior del canvas, \r\n        // cogemos un segundo punto en el lateral del canvas inmediatamente por encima \r\n        // y prologamos la línea que pasa por ambos puntos proyectados.\r\n        var self = this;\r\n        obj = obj || {};\r\n        if (obj.nearMapCoords) {\r\n            var nextPixel = obj.bottomPixel.clone();\r\n            nextPixel.y = Math.round(nextPixel.y * 9 / 10);\r\n            var nextCoords = pickMapCoords.call(self, nextPixel);\r\n            if (nextCoords) {\r\n                // Ordenamos la dupla por distancia, porque si estamos mirando desde dentro de un monte \r\n                // el punto que se supone que es el más lejano en realidad está más cerca.\r\n                var coordsArray = [obj.nearMapCoords, nextCoords].sort(function (a, b) {\r\n                    return distanceSquared(obj.cameraPosition, a) - distanceSquared(obj.cameraPosition, b);\r\n                });\r\n                return getFarCoords.apply(this, coordsArray);\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const pickMapCoords = function (pixel) {\r\n        var self = this;\r\n        var pickPoint = pickOnTerrainOrEllipsoid(self.viewer.scene, pixel);\r\n        if (pickPoint) {\r\n            pickPoint = cesium.Cartographic.fromCartesian(pickPoint);\r\n            if (self.view3D.crs !== self.view3D.view2DCRS) {\r\n                return TC.Util.reproject([cesium.Math.toDegrees(pickPoint.longitude), cesium.Math.toDegrees(pickPoint.latitude)], self.view3D.crs, self.view3D.view2DCRS);\r\n            } else {\r\n                return [cesium.Math.toDegrees(pickPoint.longitude), cesium.Math.toDegrees(pickPoint.latitude)];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Funciones utilidades cámara\r\n    const calcDistanceForResolution = function (resolution, latitude) {\r\n        var self = this;\r\n\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n        var visibleMapUnits = resolution * self.mapView.viewHTML.getBoundingClientRect().height;\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMeters = visibleMapUnits * self.mapView.metersPerUnit * relativeCircumference;\r\n\r\n        return (visibleMeters / 2) / Math.tan(fovy / 2);\r\n    };\r\n\r\n    const calcResolutionForDistance = function (distance, latitude) {\r\n        var self = this;\r\n\r\n        var canvas = self.viewer.scene.canvas;\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n\r\n        var visibleMeters = 2 * distance * Math.tan(fovy / 2);\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMapUnits = visibleMeters / self.mapView.metersPerUnit / relativeCircumference;\r\n        var resolution = visibleMapUnits / canvas.clientHeight;\r\n\r\n        // validamos que la resolución calculada esté disponible en el array de resoluciones disponibles\r\n        // si no contamos con un array de resoluciones lo calculamos\r\n        var resolutions = self.map.getResolutions();\r\n        if (resolutions === null) {\r\n            resolutions = new Array(22);\r\n            for (var i = 0, ii = resolutions.length; i < ii; ++i) {\r\n                resolutions[i] = self.mapView.getMaxResolution() / Math.pow(2, i);\r\n            }\r\n        }\r\n\r\n        // obtenemos la resolución más próxima a la calculada\r\n        for (var i = 0; i < resolutions.length; i++) {\r\n            if (resolutions[i] < Math.abs(resolution)) {\r\n                resolution = resolutions[i - 1];\r\n                break;\r\n            } else if (resolutions[i] === Math.abs(resolution)) {\r\n                resolution = resolutions[i];\r\n                break;\r\n            } else if (i === resolutions.length - 1) {\r\n                resolution = resolutions[i];\r\n            }\r\n        }\r\n\r\n        return resolution;\r\n    };\r\n\r\n    const rotateAroundAxis = function (camera, angle, axis, transform, opt_options) {\r\n        var clamp = cesium.Math.clamp;\r\n        var defaultValue = cesium.defaultValue;\r\n\r\n        var options = opt_options || {};\r\n        var duration = defaultValue(options.duration, 500); // ms\r\n\r\n        var linear = function (a) {\r\n            return a\r\n        };\r\n        var easing = defaultValue(options.easing, linear);\r\n        var callback = options.callback;\r\n\r\n        var start;\r\n        var lastProgress = 0;\r\n        var oldTransform = new cesium.Matrix4();\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            function animation(timestamp) {\r\n                if (!start)\r\n                    start = timestamp;\r\n\r\n                var progress = easing(clamp((timestamp - start) / duration, 0, 1));\r\n\r\n                camera.transform.clone(oldTransform);\r\n                var stepAngle = (progress - lastProgress) * angle;\r\n                lastProgress = progress;\r\n\r\n                camera.lookAtTransform(transform);\r\n                camera.rotate(axis, stepAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n                if (progress < 1) {\r\n                    requestAnimationFrame(animation);\r\n                } else {\r\n                    if (callback) {\r\n                        callback();\r\n                    }\r\n                    resolve();\r\n                }\r\n\r\n            }\r\n\r\n            requestAnimationFrame(animation);\r\n        });\r\n    };\r\n\r\n    const pickOnTerrainOrEllipsoid = function (scene, pixel) {\r\n        var self = this;\r\n\r\n        var ray = scene.camera.getPickRay(pixel);\r\n        var target = scene.globe.pick(ray, scene);\r\n        return target || scene.camera.pickEllipsoid(pixel);\r\n    };\r\n\r\n    const pickCenterPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var center = new cesium.Cartesian2(\r\n            canvas.clientWidth / 2,\r\n            canvas.clientHeight / 2);\r\n        return pickOnTerrainOrEllipsoid(scene, center);\r\n    };\r\n\r\n    const pickBottomPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var bottom = new cesium.Cartesian2(\r\n            canvas.clientWidth / 2, canvas.clientHeight);\r\n        return pickOnTerrainOrEllipsoid(scene, bottom);\r\n    };\r\n\r\n    const bottomFovRay = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var fovy2 = camera.frustum.fovy / 2;\r\n        var direction = camera.direction;\r\n        var rotation = cesium.Quaternion.fromAxisAngle(camera.right, fovy2);\r\n        var matrix = cesium.Matrix3.fromQuaternion(rotation);\r\n        var vector = new cesium.Cartesian3();\r\n        cesium.Matrix3.multiplyByVector(matrix, direction, vector);\r\n        return new cesium.Ray(camera.position, vector);\r\n    };\r\n\r\n    const setHeadingUsingBottomCenter = function (scene, heading, bottomCenter, opt_options) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        // Compute the camera position to zenith quaternion\r\n        var angleToZenith = computeAngleToZenith(scene, bottomCenter);\r\n        var axis = camera.right;\r\n        var quaternion = cesium.Quaternion.fromAxisAngle(axis, angleToZenith);\r\n        var rotation = cesium.Matrix3.fromQuaternion(quaternion);\r\n\r\n        // Get the zenith point from the rotation of the position vector\r\n        var vector = new cesium.Cartesian3();\r\n        cesium.Cartesian3.subtract(camera.position, bottomCenter, vector);\r\n        var zenith = new cesium.Cartesian3();\r\n        cesium.Matrix3.multiplyByVector(rotation, vector, zenith);\r\n        cesium.Cartesian3.add(zenith, bottomCenter, zenith);\r\n\r\n        // Actually rotate around the zenith normal\r\n        var transform = cesium.Matrix4.fromTranslation(zenith);\r\n        rotateAroundAxis(camera, heading, zenith, transform, opt_options);\r\n    };\r\n\r\n    const signedAngleBetween = function (first, second, normal) {\r\n        var self = this;\r\n\r\n        // We are using the dot for the angle.\r\n        // Then the cross and the dot for the sign.\r\n        var a = new cesium.Cartesian3();\r\n        var b = new cesium.Cartesian3();\r\n        var c = new cesium.Cartesian3();\r\n        cesium.Cartesian3.normalize(first, a);\r\n        cesium.Cartesian3.normalize(second, b);\r\n        cesium.Cartesian3.cross(a, b, c);\r\n\r\n        var cosine = cesium.Cartesian3.dot(a, b);\r\n        var sine = cesium.Cartesian3.magnitude(c);\r\n\r\n        // Sign of the vector product and the orientation normal\r\n        var sign = cesium.Cartesian3.dot(normal, c);\r\n        var angle = Math.atan2(sine, cosine);\r\n        return sign >= 0 ? angle : -angle;\r\n    };\r\n\r\n    const computeAngleToZenith = function (scene, pivot) {\r\n        var self = this;\r\n\r\n        // This angle is the sum of the angles 'fy' and 'a', which are defined\r\n        // using the pivot point and its surface normal.\r\n        //        Zenith |    camera\r\n        //           \\   |   /\r\n        //            \\fy|  /\r\n        //             \\ |a/\r\n        //              \\|/pivot\r\n        var camera = scene.camera;\r\n        var fy = camera.frustum.fovy / 2;\r\n        var ray = bottomFovRay(scene);\r\n        var direction = cesium.Cartesian3.clone(ray.direction);\r\n        cesium.Cartesian3.negate(direction, direction);\r\n\r\n        var normal = new cesium.Cartesian3();\r\n        cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(pivot, normal);\r\n\r\n        var left = new cesium.Cartesian3();\r\n        cesium.Cartesian3.negate(camera.right, left);\r\n\r\n        var a = signedAngleBetween(normal, direction, left);\r\n        return a + fy;\r\n    };\r\n\r\n    const computeSignedTiltAngleOnGlobe = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var ray = new cesium.Ray(camera.position, camera.direction);\r\n        var target = scene.globe.pick(ray, scene);\r\n\r\n        if (!target) {\r\n            // no tiles in the area were loaded?\r\n            var ellipsoid = cesium.Ellipsoid.WGS84;\r\n            var obj = cesium.IntersectionTests.rayEllipsoid(ray, ellipsoid);\r\n            if (obj) {\r\n                target = cesium.Ray.getPoint(ray, obj.start);\r\n            }\r\n        }\r\n\r\n        if (!target) {\r\n            return undefined;\r\n        }\r\n\r\n        var normal = new cesium.Cartesian3();\r\n        cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(target, normal);\r\n\r\n        var angleBetween = signedAngleBetween;\r\n        var angle = angleBetween(camera.direction, normal, camera.right) - Math.PI;\r\n        return cesium.Math.convertLongitudeRange(angle);\r\n    };\r\n\r\n    // Funciones CZML    \r\n    const toCZML = function (coordinates, layout, name, pointStyle, lineStyle, walkingSpeed) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            var positions = coordinates.map(function (coordinate) {\r\n                var reprojected = coordinate;\r\n                if (self.view3D.view2DCRS !== self.view3D.crs) {\r\n                    reprojected = TC.Util.reproject(coordinate, self.view3D.view2DCRS, self.view3D.crs);\r\n                }\r\n                return cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n            });\r\n\r\n            cesium.when(self.viewer.terrainProvider.sampleTerrainMostDetailed(positions), function (updatedPositions) {\r\n                var startTime, stopTime, totalDistance = 0;\r\n\r\n                if (layout === ol.geom.GeometryLayout.XYZM) {\r\n                    startTime = coordinates[0][3];\r\n                    stopTime = coordinates[coordinates.length - 1][3];\r\n                } else if (layout === ol.geom.GeometryLayout.XYM) {\r\n                    startTime = coordinates[0][2];\r\n                    stopTime = coordinates[coordinates.length - 1][2];\r\n                } else {\r\n\r\n                    coordinates[0][3] = updatedPositions[0].time = Date.now();\r\n\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var done;\r\n                        var previuos_next = [];\r\n\r\n                        updatedPositions[i].time = 0;\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        done = new cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n\r\n                        totalDistance += done;\r\n\r\n                        coordinates[i][3] = updatedPositions[i].time = updatedPositions[i - 1].time + (3600000 * done / walkingSpeed);\r\n                    }\r\n\r\n                    startTime = updatedPositions[0].time;\r\n                    stopTime = updatedPositions[updatedPositions.length - 1].time;\r\n                }\r\n\r\n                if (totalDistance === 0) {\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var previuos_next = [];\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        totalDistance += new cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n                    }\r\n                }\r\n\r\n                startTime = new Date(startTime).toISOString();\r\n                stopTime = new Date(stopTime).toISOString();\r\n\r\n                var czml = [{\r\n                    \"id\": \"document\",\r\n                    \"name\": \"CZML Model\",\r\n                    \"version\": \"1.0\"\r\n                }, {\r\n                    \"id\": \"path\",\r\n                    \"name\": name,\r\n                    \"availability\": startTime + \"/\" + stopTime,\r\n                    \"position\": {\r\n                        \"epoch\": startTime,\r\n                        \"cartographicRadians\": updatedPositions.map(function (updatedPosition, i) {\r\n                            return layout === ol.geom.GeometryLayout.XYZM ? [new Date(coordinates[i][3]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                layout === ol.geom.GeometryLayout.XYM ? [new Date(coordinates[i][2]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                    [new Date(updatedPosition.time).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height];\r\n                        }).reduce(function (prev, curr) {\r\n                            return prev.concat(curr);\r\n                        })\r\n                    },\r\n                    \"point\": {\r\n                        \"heightReference\": \"CLAMP_TO_GROUND\",\r\n                        \"pixelSize\": pointStyle.radius,\r\n                        \"color\": {\r\n                            \"rgba\": pointStyle.fillColor\r\n                        },\r\n                        \"outlineColor\": {\r\n                            \"rgba\": pointStyle.strokeColor\r\n                        },\r\n                        \"outlineWidth\": pointStyle.strokeWidth\r\n                    }\r\n                }];\r\n\r\n                resolve({ czml: czml, totalDistance: totalDistance, coordinates2D: coordinates });\r\n            });\r\n        });\r\n    };\r\n\r\n    const CameraControls = function (parent) {\r\n        var self = this;\r\n\r\n        self.parent = parent;\r\n\r\n        var outHandler = function (e) {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = false;\r\n        };\r\n        var inHandler = function () {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = true;\r\n            self.lastFocused = performance.now();\r\n\r\n            if (self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                self.div.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n            }\r\n        };\r\n\r\n        var moveStartHandler = function () {\r\n            var self = this;\r\n            self.moving = true;\r\n        };\r\n        var moveEndHandler = function () {\r\n            var self = this;\r\n            self.moving = false;\r\n        };\r\n        var postRenderHandler = function () {\r\n            var self = this;\r\n            var view = self.parent;\r\n\r\n            if (self.parent.view3D.isLoadingTiles.call(self.parent))\r\n                self.customCollisionDetection();\r\n\r\n            var camera = self.getCamera();\r\n            var position = camera.positionCartographic;\r\n\r\n            if (self.moving) {\r\n\r\n                cssRotate(self.tiltIndicator, camera.pitch);\r\n                cssRotate(self.rotateIndicator, -camera.heading);\r\n\r\n                self.disableRotate();\r\n                self.disableTilt(5);\r\n\r\n                if (view.view3D.crs !== view.view3D.view2DCRS) {\r\n                    self._coordsXY = TC.Util.reproject([cesium.Math.toDegrees(position.longitude), cesium.Math.toDegrees(position.latitude)], view.view3D.crs, view.view3D.view2DCRS);\r\n                } else {\r\n                    self._coordsXY = [cesium.Math.toDegrees(position.longitude), cesium.Math.toDegrees(position.latitude)];\r\n                }\r\n\r\n                view.mapView.setCenter(self._coordsXY);\r\n                view.mapView.setResolution(calcResolutionForDistance.call(view, position.height, position.latitude));\r\n\r\n                //view.mapView.setRotation(-camera.heading);\r\n            }\r\n\r\n            // flacunza: calculamos el polígono de FOV para dibujar en el mapa de situación\r\n            // Lo calculamos aunque no nos estemos moviendo porque el terreno puede estar cargándose\r\n            if (self._coordsXY) {\r\n                view._ovMap = view._ovMap || view.map.getControlsByClass('TC.control.OverviewMap')[0];\r\n                if (view._ovMap) {\r\n                    view._ovMap.renderPromise().then(function () {\r\n                        var scene = view.viewer.scene;\r\n                        var canvas = scene.canvas;\r\n                        var bottomLeft = new cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n                        var bottomRight = new cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n                        var fovCoords = [\r\n                            bottomLeft,\r\n                            bottomRight,\r\n                            new cesium.Cartesian2(canvas.clientWidth - 1, 0),\r\n                            new cesium.Cartesian2(0, 0)\r\n                        ].map(function (elm) {\r\n                            return pickMapCoords.call(view, elm);\r\n                        }).filter(function (elm) {\r\n                            return elm !== null;\r\n                        });\r\n                        if (fovCoords.length && fovCoords.length < 4) { // Vemos horizonte\r\n                            // flacunza: Si vemos horizonte no tenemos puntos de terreno para las esquinas superiores, \r\n                            // por eso intentamos calcular unos puntos \"en el infinito\".\r\n                            var farCoordsLeft = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[0],\r\n                                bottomPixel: bottomLeft,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            var farCoordsRight = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[1],\r\n                                bottomPixel: bottomRight,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            if (farCoordsLeft && farCoordsRight) {\r\n                                fovCoords[2] = farCoordsRight;\r\n                                fovCoords[3] = farCoordsLeft;\r\n                            }\r\n\r\n                        }\r\n                        view._ovMap.wrap.draw3DCamera({ position: self._coordsXY, heading: camera.heading, fov: fovCoords });\r\n                    });\r\n                }\r\n            }\r\n\r\n        };\r\n        var cssRotate = function (element, angle) {\r\n            var coord = element.getBBox();\r\n            value = 'rotate(' + cesium.Math.toDegrees(angle) + ' ' + (coord.x + (coord.width / 2)) + ' ' + (coord.y + (coord.height / 2)) + ')';\r\n            document.getElementsByClassName(element.className.baseVal)[0].setAttribute('transform', value);\r\n        };\r\n\r\n        self.outControlsEvents = TC.Util.detectMouse() ? ['mouseleave'] : ['touchleave', 'touchend'];\r\n        self.outControls = outHandler.bind(self);\r\n\r\n        self.inControlsEvents = TC.Util.detectMouse() ? ['mouseenter'] : ['touchmove', 'touchstart'];\r\n        self.inControls = inHandler.bind(self);\r\n\r\n        self.moveStart = moveStartHandler.bind(self);\r\n        self.moveEnd = moveEndHandler.bind(self);\r\n        self.postRender = postRenderHandler.bind(self);\r\n\r\n        self.selectors = {\r\n            tilt: '-cm-tilt',\r\n            rotate: '-cm-rotate',\r\n            indicator: '-indicator',\r\n            leftArrow: '-left',\r\n            rightArrow: '-right',\r\n            downArrow: '-down',\r\n            upArrow: '-up'\r\n        };\r\n\r\n        self.MIN_TILT = cesium.Math.toRadians(-89);\r\n        self.MAX_TILT = cesium.Math.toRadians(-1);\r\n\r\n        self.render();\r\n    };\r\n    CameraControls.prototype.bind = function () {\r\n        var self = this;\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.addEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.addEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.addEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.inControls);\r\n        });\r\n\r\n        function setOpacity() {\r\n            if (!self.lastFocused)\r\n                self.lastFocused = performance.now();\r\n\r\n            var progress = performance.now() - self.lastFocused;\r\n            if (progress > 5000 && self.isFocusingCameraCtrls !== true) {\r\n                if (!self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                    self.div.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                }\r\n            }\r\n\r\n            self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n        }\r\n        self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n    };\r\n    CameraControls.prototype.unbind = function () {\r\n        var self = this;\r\n\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.removeEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.removeEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.removeEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.inControls);\r\n        });\r\n        window.cancelAnimationFrame(self.rAFInOutControls);\r\n        self.lastFocused = undefined;\r\n        self.rAFInOutControls = undefined;\r\n    };\r\n    CameraControls.prototype.getCamera = function () {\r\n        var self = this;\r\n\r\n        return self.parent.viewer.scene.camera;\r\n    };\r\n    CameraControls.prototype.getCameraState = function () {\r\n        var self = this;\r\n\r\n        if (self.parent.viewer) {\r\n            var camera = self.parent.viewer.scene.camera;\r\n            var cameraPosition = camera.positionCartographic;\r\n\r\n            var bottomCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottomCenter) {\r\n                var distance = cesium.Cartesian3.distance(camera.position, bottomCenter);\r\n\r\n                return {\r\n                    cp: [cameraPosition.longitude, cameraPosition.latitude, cameraPosition.height],\r\n                    chpr: [camera.heading, camera.pitch, camera.roll],\r\n                    bcpd: distance\r\n                };\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.render = function () {\r\n        var self = this;\r\n\r\n        if (self.div) {\r\n            self.div.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.bind();\r\n        }\r\n        else {\r\n            self.parent.getRenderedHtml(self.parent.CLASS + '-cm-ctls', {}, function (html) {\r\n                // contenedor controles\r\n                self.div = document.createElement('div');\r\n                self.div.classList.add(self.parent.CLASS + '-cm-ctls');\r\n                self.div.innerHTML = html;\r\n                self.parent.map.div.appendChild(self.div);\r\n\r\n\r\n                // tilt\r\n                var tiltSelector = '.' + self.parent.CLASS + self.selectors.tilt;\r\n\r\n                self.tiltIndicatorInner = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.tiltIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetTilt.bind(self));\r\n\r\n                self.tiltIndicator = self.div.querySelector(tiltSelector + '-indicator');\r\n\r\n                self.tiltIndicatorOuterCircle = self.div.querySelector(tiltSelector + '-outer-circle');\r\n                self.tiltIndicatorOuterShellCircle = self.div.querySelector(tiltSelector + '-outer-shell-circle');\r\n\r\n                self.tiltIndicatorCircle = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.tiltIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingTilt.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.tiltUp = self.div.querySelector(tiltSelector + self.selectors.upArrow);\r\n                self.tiltUp.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                    self.tiltUpMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, +5);\r\n\r\n                    self.tiltUpInterval = setInterval(function () {\r\n                        if (!self.isTiltUpDisabled) self.tilt.call(self, +5);\r\n                        else self.tiltUpMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltUpMouseUpFunction = function () {\r\n                        clearInterval(self.tiltUpInterval);\r\n                        self.tiltUpInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                        self.tiltUpMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // right\r\n                self.tiltDown = self.div.querySelector(tiltSelector + self.selectors.downArrow);\r\n                self.tiltDown.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                    self.tiltDownMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, -5);\r\n\r\n                    self.tiltDownInterval = setInterval(function () {\r\n                        if (!self.isTiltDownDisabled) self.tilt.call(self, -5);\r\n                        else self.tiltDownMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltDownMouseUpFunction = function () {\r\n                        clearInterval(self.tiltDownInterval);\r\n                        self.tiltDownInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                        self.tiltDownMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // rotation\r\n                var rotateSelector = '.' + self.parent.CLASS + self.selectors.rotate;\r\n\r\n                self.rotateIndicatorInner = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.rotateIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetRotation.bind(self));\r\n\r\n                self.rotateIndicator = self.div.querySelector(rotateSelector + '-indicator');\r\n\r\n                self.rotateIndicatorOuterCircle = self.div.querySelector(rotateSelector + '-outer-circle');\r\n                self.rotateIndicatorOuterShellCircle = self.div.querySelector(rotateSelector + '-outer-shell-circle');\r\n\r\n                self.rotateIndicatorCircle = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.rotateIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingRotate.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.rotateLeft = self.div.querySelector(rotateSelector + self.selectors.leftArrow);\r\n                self.rotateLeft.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                    self.rotateLeftMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, -15);\r\n\r\n                    self.rotateLeftInterval = setInterval(function () {\r\n                        self.rotate.call(self, -15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateLeftMouseUpFunction = function () {\r\n                        clearInterval(self.rotateLeftInterval);\r\n                        self.rotateLeftInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                        self.rotateLeftMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.rotateRight = self.div.querySelector(rotateSelector + self.selectors.rightArrow);\r\n                self.rotateRight.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                    self.rotateRightMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, +15);\r\n\r\n                    self.rotateRightInterval = setInterval(function () {\r\n                        self.rotate.call(self, +15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateRightMouseUpFunction = function () {\r\n                        clearInterval(self.rotateRightInterval);\r\n                        self.rotateRightInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                        self.rotateRightMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.bind();\r\n\r\n            }.bind(this));\r\n        }\r\n    };\r\n    CameraControls.prototype.disableTilt = function (angle) {\r\n        var self = this;\r\n\r\n        var theta = cesium.Math.toRadians(angle);\r\n        var tilt = self.getCamera().pitch;\r\n\r\n        self.isTiltDownDisabled = (tilt + -theta) < self.MIN_TILT;\r\n        self.isTiltUpDisabled = (tilt + theta) > self.MAX_TILT;\r\n\r\n        // left\r\n        self.tiltUp.disabled = self.isTiltUpDisabled;\r\n        self.tiltUp.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltUpDisabled);\r\n\r\n\r\n        // right\r\n        self.tiltDown.disabled = self.isTiltDownDisabled;\r\n        self.tiltDown.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltDownDisabled);\r\n    };\r\n    CameraControls.prototype.disableRotate = function () {\r\n        var self = this;\r\n\r\n        var isDisable = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var canvas = scene.canvas;\r\n        var bottomLeft = new cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n        var bottomRight = new cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n        var fovCoords = [bottomLeft, bottomRight, new cesium.Cartesian2(canvas.clientWidth - 1, 0), new cesium.Cartesian2(0, 0)]\r\n            .map(function (elm) {\r\n                return pickMapCoords.call(this, elm);\r\n            }.bind(self.parent))\r\n            .filter(function (elm) {\r\n                return elm !== null;\r\n            });\r\n\r\n        if (fovCoords.length && fovCoords.length >= 2) {\r\n            isDisable = false;\r\n        }\r\n\r\n        // reset\r\n        self.rotateIndicatorInner.disabled = isDisable;\r\n\r\n        // left\r\n        self.rotateLeft.disabled = isDisable;\r\n        self.rotateLeft.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        // right\r\n        self.rotateRight.disabled = isDisable;\r\n        self.rotateRight.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        return isDisable;\r\n    };\r\n    CameraControls.prototype.tilt = function (angle) {\r\n        var self = this;\r\n\r\n        self.disableTilt(angle);\r\n\r\n        if (self.parent.viewer && self.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateUp(cesium.Math.toRadians(angle));\r\n        } else {\r\n            if (pickCenterPoint(self.parent.viewer.scene) == undefined) {\r\n                if (angle > 0) self.getCamera().lookUp();\r\n                else self.getCamera().lookDown();\r\n            }\r\n\r\n            if ((angle >= cesium.Math.PI_OVER_TWO && self.isTiltUpDisabled) ||\r\n                (angle <= -cesium.Math.PI_OVER_TWO && self.isTiltDownDisabled)) {\r\n                return;\r\n            }\r\n\r\n            var _angle = cesium.Math.toRadians(angle);\r\n            var pivot = pickCenterPoint(self.parent.viewer.scene);\r\n            if (pivot) {\r\n                var transform = cesium.Matrix4.fromTranslation(pivot);\r\n                self.parent.view3D.rotateAroundAxis(self.getCamera(), -_angle, self.getCamera().right, transform, { duration: 100 });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.rotate = function (angle) {\r\n        var self = this;\r\n\r\n        angle = cesium.Math.toRadians(angle);\r\n\r\n        if (self.parent.viewer && self.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateRight(-angle);\r\n        } else {\r\n            var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottom) {\r\n                setHeadingUsingBottomCenter(self.parent.viewer.scene, angle, bottom, {\r\n                    duration: 100\r\n                });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.draggingTilt = function (tiltElement, cursorVector) {\r\n        var self = this;\r\n\r\n        self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new cesium.Matrix4();\r\n        var newTransformScratch = new cesium.Matrix4();\r\n        var vectorScratch = new cesium.Cartesian2();\r\n\r\n        document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n        self.tiltMouseMoveFunction = undefined;\r\n        self.tiltMouseUpFunction = undefined;\r\n\r\n        self.isTilting = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var pivot = pickCenterPoint(scene);\r\n        if (!pivot) {\r\n            self.tiltFrame = cesium.Transforms.northUpEastToFixedFrame(camera.positionWC, cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = true;\r\n        } else {\r\n            self.tiltFrame = cesium.Transforms.northUpEastToFixedFrame(pivot, cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = false;\r\n        }\r\n\r\n        self.startCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var oldTransform = cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n        camera.lookAtTransform(self.tiltFrame);\r\n\r\n        self.initialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n\r\n        camera.lookAtTransform(oldTransform);\r\n\r\n        self.tiltMouseMoveFunction = function (e) {\r\n            var self = this;\r\n\r\n            scene = self.parent.viewer.scene;\r\n            camera = scene.camera;\r\n\r\n            var tiltRectangle = tiltElement.getBoundingClientRect();\r\n            center = new cesium.Cartesian2((tiltRectangle.right - tiltRectangle.left) / 2.0, (tiltRectangle.bottom - tiltRectangle.top) / 2.0);\r\n            var clickLocation = new cesium.Cartesian2(e.clientX - tiltRectangle.left, e.clientY - tiltRectangle.top);\r\n            var vector = cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n            console.log('Entra: ' + vector.toString());\r\n\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n            var angleDifference = angle - self.startCursorAngle;\r\n            var newCameraAngle = cesium.Math.zeroToTwoPi(self.initialCameraAngle - angleDifference);\r\n\r\n            try {\r\n                oldTransform = cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.tiltFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                var theta = newCameraAngle - currentCameraAngle;\r\n\r\n                var tilt = camera.pitch;\r\n                tilt += theta;\r\n\r\n                if (tilt < self.MIN_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MIN_TILT);\r\n                } else if (tilt > self.MAX_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MAX_TILT);\r\n                } else {\r\n                    camera.rotate(camera.right, -theta);\r\n                }\r\n\r\n                self.disableTilt(5);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n            } catch (e) {\r\n                self.tiltMouseUpFunction();\r\n            }\r\n\r\n\r\n        }.bind(self);\r\n\r\n        self.tiltMouseUpFunction = function (e) {\r\n            self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            self.isTilting = false;\r\n            document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n            self.tiltMouseMoveFunction = undefined;\r\n            self.tiltMouseUpFunction = undefined;\r\n        };\r\n\r\n        document.addEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.draggingRotate = function (rotateElement, cursorVector) {\r\n        var self = this;\r\n\r\n        document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n        self.rotateMouseMoveFunction = undefined;\r\n        self.rotateMouseUpFunction = undefined;\r\n\r\n        self.rotateMouseMoveFunction = function (e) {\r\n            var rotateRectangle = rotateElement.getBoundingClientRect();\r\n            var center = new cesium.Cartesian2((rotateRectangle.right - rotateRectangle.left) / 2.0, (rotateRectangle.bottom - rotateRectangle.top) / 2.0);\r\n            var clickLocation = new cesium.Cartesian2(e.clientX - rotateRectangle.left, e.clientY - rotateRectangle.top);\r\n            var vector = cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n\r\n            var angleDifference = angle - self.rotateInitialCursorAngle;\r\n            var newCameraAngle = cesium.Math.zeroToTwoPi(self.rotateInitialCameraAngle - angleDifference);\r\n\r\n            camera = self.parent.viewer.scene.camera;\r\n\r\n            try {\r\n                oldTransform = cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.rotateFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                camera.rotateRight(newCameraAngle - currentCameraAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n            } catch (e) {\r\n                self.rotateMouseUpFunction();\r\n            }\r\n        };\r\n\r\n        self.rotateMouseUpFunction = function (e) {\r\n            self.isRotating = false;\r\n\r\n            self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n            self.rotateMouseMoveFunction = undefined;\r\n            self.rotateMouseUpFunction = undefined;\r\n        };\r\n\r\n        if (self.disableRotate()) {\r\n            self.rotateMouseUpFunction();\r\n            return;\r\n        }\r\n\r\n        self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new cesium.Matrix4();\r\n        var newTransformScratch = new cesium.Matrix4();\r\n        var vectorScratch = new cesium.Cartesian2();\r\n\r\n        self.isRotating = true;\r\n        self.rotateInitialCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var viewCenter = pickCenterPoint(self.parent.viewer.scene);\r\n        if (viewCenter == null || viewCenter == undefined) {\r\n            viewCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (viewCenter == null || viewCenter == undefined) {\r\n                self.rotateFrame = cesium.Transforms.eastNorthUpToFixedFrame(camera.positionWC, cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = true;\r\n            } else {\r\n                self.rotateFrame = cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = false;\r\n            }\r\n        } else {\r\n            self.rotateFrame = cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.rotateIsLook = false;\r\n        }\r\n\r\n        try {\r\n            var oldTransform = cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n            camera.lookAtTransform(self.rotateFrame);\r\n            self.rotateInitialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n            self.rotateInitialCameraDistance = cesium.Cartesian3.magnitude(new cesium.Cartesian3(camera.position.x, camera.position.y, 0.0));\r\n            camera.lookAtTransform(oldTransform);\r\n        } catch (e) {\r\n            self.rotateMouseUpFunction();\r\n        }\r\n\r\n        document.addEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.resetTilt = function () {\r\n        var self = this;\r\n        // lo dejamos como al principio a 50 grados\r\n        var angle = -self.getCamera().pitch - cesium.Math.toRadians(50);\r\n        self.tilt(cesium.Math.toDegrees(angle));\r\n    };\r\n    CameraControls.prototype.resetRotation = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var currentRotation;\r\n            currentRotation = -self.getCamera().heading;\r\n\r\n            while (currentRotation < -Math.PI) {\r\n                currentRotation += 2 * Math.PI;\r\n            }\r\n            while (currentRotation > Math.PI) {\r\n                currentRotation -= 2 * Math.PI;\r\n            }\r\n\r\n            if (!options)\r\n                resolve();\r\n            else {\r\n                options.callback = function () {\r\n                    resolve();\r\n                };\r\n            }\r\n\r\n            if (self.parent.viewer && self.parent.viewer.trackedEntity) {\r\n                self.parent.view3D.linked2DControls.geolocation.videoControls.call(self, { target: { className: 'stop' }, custom: true });                \r\n            }\r\n            var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottom) {\r\n                setHeadingUsingBottomCenter(self.parent.viewer.scene, currentRotation, bottom, options);\r\n            }\r\n        });\r\n    };\r\n    CameraControls.prototype.customCollisionDetection = function () {\r\n        var self = this;\r\n\r\n        var scratchAdjustHeightTransform = new cesium.Matrix4();\r\n        var scratchAdjustHeightCartographic = new cesium.Cartographic();\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = self.parent.viewer.scene.camera;\r\n\r\n        var screenSpaceCameraController = scene.screenSpaceCameraController;\r\n        var enableCollisionDetection = screenSpaceCameraController.enableCollisionDetection;\r\n        var minimumCollisionTerrainHeight = screenSpaceCameraController.minimumCollisionTerrainHeight;\r\n        var minimumZoomDistance = screenSpaceCameraController.minimumZoomDistance;\r\n        var globe = scene.globe;\r\n\r\n        var ellipsoid = globe.ellipsoid;\r\n        var projection = scene.mapProjection;\r\n\r\n        var transform;\r\n        var mag;\r\n        if (!cesium.Matrix4.equals(camera.transform, cesium.Matrix4.IDENTITY)) {\r\n            transform = cesium.Matrix4.clone(camera.transform, scratchAdjustHeightTransform);\r\n            mag = cesium.Cartesian3.magnitude(camera.position);\r\n            camera._setTransform(cesium.Matrix4.IDENTITY);\r\n        }\r\n\r\n        var cartographic = scratchAdjustHeightCartographic;\r\n        ellipsoid.cartesianToCartographic(camera.position, cartographic);\r\n\r\n        var heightUpdated = false;\r\n        if (cartographic.height < minimumCollisionTerrainHeight) {\r\n            var height = globe.getHeight(cartographic);\r\n            if (height !== undefined && height !== null) {\r\n                height += minimumZoomDistance;\r\n                if (cartographic.height < height) {\r\n                    cartographic.height = height;\r\n                    ellipsoid.cartographicToCartesian(cartographic, camera.position);\r\n                    heightUpdated = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (transform !== undefined && transform !== null) {\r\n            camera._setTransform(transform);\r\n            if (heightUpdated) {\r\n                cesium.Cartesian3.normalize(camera.position, camera.position);\r\n                cesium.Cartesian3.negate(camera.position, camera.direction);\r\n                cesium.Cartesian3.multiplyByScalar(camera.position, Math.max(mag, minimumZoomDistance), camera.position);\r\n                cesium.Cartesian3.normalize(camera.direction, camera.direction);\r\n                cesium.Cartesian3.cross(camera.direction, camera.up, camera.right);\r\n                cesium.Cartesian3.cross(camera.right, camera.direction, camera.up);\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.limitCameraToInitExtent = function () {\r\n        var self = this;\r\n\r\n        var pos = self.viewer.camera.positionCartographic.clone();\r\n\r\n        if (!(pos.longitude >= self.initExtent.west &&\r\n            pos.longitude <= self.initExtent.east &&\r\n            pos.latitude >= self.initExtent.south &&\r\n            pos.latitude <= self.initExtent.north)) {\r\n            // add a padding based on the camera height\r\n            var maxHeight = self.viewer.scene.screenSpaceCameraController.maximumZoomDistance;\r\n            var padding = pos.height * 0.05 / maxHeight;\r\n            pos.longitude = Math.max(self.initExtent.west - padding, pos.longitude);\r\n            pos.latitude = Math.max(self.initExtent.south - padding, pos.latitude);\r\n            pos.longitude = Math.min(self.initExtent.east + padding, pos.longitude);\r\n            pos.latitude = Math.min(self.initExtent.north + padding, pos.latitude);\r\n            self.viewer.camera.setView({\r\n                destination: cesium.Ellipsoid.WGS84.cartographicToCartesian(pos),\r\n                orientation: {\r\n                    heading: self.viewer.camera.heading,\r\n                    pitch: self.viewer.camera.pitch\r\n                }\r\n            });\r\n        }\r\n\r\n        // Set the minimumZoomDistance according to the camera height\r\n        self.viewer.scene.screenSpaceCameraController.minimumZoomDistance = pos.height > 1800 ? 400 : 200;\r\n    };\r\n\r\n    const TwoDLinkedFeatureInfo = function (map) {\r\n        var pending = false;\r\n        var marker = null;\r\n        var ctlResultsPanel = null;\r\n        var ctlFeatureInfo = null;\r\n\r\n        var savedMode;\r\n        var map2DgetResolutionFN = map.map.getResolution;\r\n\r\n        var getResultsPanelCtl = function (ctlFeatureInfo) {\r\n\r\n            if (ctlResultsPanel) {\r\n                return Promise.resolve();\r\n            } else {\r\n\r\n                const resultsPanelOptions = {\r\n                    \"content\": \"table\",\r\n                    \"titles\": {\r\n                        \"main\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\"),\r\n                        \"max\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\")\r\n                    }\r\n                };\r\n\r\n                var addControlPromise;\r\n                var controlContainer = map.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                if (controlContainer) {\r\n                    resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                    addControlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    map.map.div.appendChild(resultsPanelOptions.div);\r\n                    addControlPromise = map.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                return addControlPromise.then(function (control) {\r\n                    control.caller = ctlFeatureInfo;\r\n                    ctlResultsPanel = control;\r\n                    ctlFeatureInfo.resultsPanel = ctlResultsPanel;\r\n                });\r\n            }\r\n        };\r\n        var setMarker = function (pickedPosition) {\r\n            if (!marker) {\r\n                var billboard = {\r\n                    position: pickedPosition,\r\n                    billboard: { /* revisar: no está bien la URL de la imagen - también revisar el GFI que salta en móvil sólo con navegar */\r\n                        image: TC.Util.getBackgroundUrlFromCss(map.CLASS + '-marker'),\r\n                        eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                        verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                        heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                    }\r\n                };\r\n\r\n                marker = map.view3D.addNativeFeature.call(map, billboard);\r\n\r\n            } else {\r\n                marker.position = pickedPosition;\r\n            }\r\n\r\n            map.viewer.scene.requestRender();\r\n        };\r\n        var removeMarker = function () {\r\n            map.view3D.removeFeature.call(map, marker);\r\n            marker = null;\r\n        };\r\n\r\n        ctlFeatureInfo = map.map.getControlsByClass(TC.control.FeatureInfo)[0];\r\n        if (ctlFeatureInfo) {\r\n\r\n            savedMode = ctlFeatureInfo.displayMode;\r\n\r\n            getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                ctlFeatureInfo.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);\r\n\r\n                map.map.on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                    if (e.control === ctlFeatureInfo.getDisplayControl()) {\r\n                        if (!ctlFeatureInfo.querying) {\r\n                            removeMarker();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        this.clear = function () {\r\n            ctlFeatureInfo.closeResults();\r\n            removeMarker();\r\n        };\r\n        this.reset = function () {\r\n            this.clear();\r\n            ctlFeatureInfo.setDisplayMode(savedMode);\r\n            map.map.getResolution = map2DgetResolutionFN;\r\n        };\r\n        this.send = function (pickedPosition) {\r\n            return new Promise(function (resolve, reject) {\r\n                pending = true;\r\n\r\n                if (ctlFeatureInfo.displayMode !== TC.Consts.infoContainer.RESULTS_PANEL) {\r\n                    ctlFeatureInfo.setDisplayMode(TC.Consts.infoContainer.RESULTS_PANEL);\r\n                }\r\n\r\n                if (ctlFeatureInfo.resultsPanel) {\r\n                    ctlFeatureInfo.resultsPanel.close();\r\n                }\r\n\r\n                if (!map.waiting)\r\n                    map.waiting = map.map.getLoadingIndicator().addWait();\r\n\r\n                setMarker(pickedPosition);\r\n\r\n                getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                    var pickedLocation = cesium.Ellipsoid.WGS84.cartesianToCartographic(pickedPosition);\r\n\r\n                    var reprojected;\r\n                    if (map.view3D.crs !== map.view3D.view2DCRS) {\r\n                        reprojected = TC.Util.reproject([cesium.Math.toDegrees(pickedLocation.longitude), cesium.Math.toDegrees(pickedLocation.latitude)], map.view3D.crs, map.view3D.view2DCRS);\r\n                    } else {\r\n                        reprojected = [cesium.Math.toDegrees(pickedLocation.longitude), cesium.Math.toDegrees(pickedLocation.latitude)];\r\n                    }\r\n\r\n\r\n                    var radius = (map.map.options.pixelTolerance || TC.Cfg.pixelTolerance);\r\n                    var mapWidth = 2 * radius + 1;\r\n\r\n                    var tilesRendered = map.viewer.scene.globe._surface._tilesToRender;\r\n                    var pickedTile;\r\n\r\n                    for (var textureIndex = 0; !pickedTile && textureIndex < tilesRendered.length; ++textureIndex) {\r\n                        var tile = tilesRendered[textureIndex];\r\n                        if (cesium.Rectangle.contains(tile.rectangle, pickedLocation)) {\r\n                            pickedTile = tile;\r\n                        }\r\n                    }\r\n\r\n                    if (!pickedTile) {\r\n                        resolve();\r\n                        return;\r\n                    }\r\n\r\n                    var imageryTiles = pickedTile.data.imagery;\r\n                    for (var i = imageryTiles.length - 1; i >= 0; --i) {\r\n                        var terrainImagery = imageryTiles[i];\r\n                        var imagery = terrainImagery.readyImagery;\r\n                        if (!imagery) {\r\n                            resolve();\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    var nativeRectangle = pickedTile.tilingScheme.tileXYToNativeRectangle(pickedTile.x, pickedTile.y, pickedTile.level);\r\n\r\n                    var readyImageryToGetNativeRectangle = (imageryTiles.filter(function (imagery) {\r\n                        return imagery.readyImagery.imageryLayer.isBaseLayer();\r\n                    })[0] || {}).readyImagery;\r\n\r\n                    map.map.getResolution = function () {\r\n\r\n                        var west_south = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.west, nativeRectangle.south], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.west, nativeRectangle.south];\r\n                        var east_north = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.east, nativeRectangle.north], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.east, nativeRectangle.north];\r\n\r\n                        var xResolution = (east_north[0] - west_south[0]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileWidth || 256);\r\n                        var yResolution = (east_north[1] - west_south[1]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileHeight || 256);\r\n\r\n                        return Math.max(xResolution, yResolution);\r\n\r\n                    }.bind(map, readyImageryToGetNativeRectangle, nativeRectangle);\r\n\r\n                    map.map.one(TC.Consts.event.NOFEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    }.bind(ctlFeatureInfo));\r\n\r\n                    map.map.one(TC.Consts.event.FEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    map.map.on(TC.Consts.event.FEATURECLICK, function (e) {\r\n                        removeMarker();\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    savedIsActive = ctlFeatureInfo.isActive;\r\n                    ctlFeatureInfo.isActive = true;\r\n                    ctlFeatureInfo.beforeRequest({\r\n                        xy: [0, 0]\r\n                    }); // Es irrelevante dónde va a poner el marcador, no se va a ver                \r\n\r\n                    ctlFeatureInfo.callback(reprojected);\r\n                });\r\n            });\r\n        };\r\n        this.get2DMarker = function () {\r\n            return ctlFeatureInfo.filterFeature;\r\n        };\r\n        this.isPending = function () {\r\n            return pending;\r\n        };\r\n    };\r\n\r\n    const RasterConverter = function (crsPattern) {\r\n        this.layerCrs = null;\r\n\r\n        var crsPattern = crsPattern;\r\n\r\n        var paths = {\r\n            CRS: [\"Capability\", \"Layer\", \"CRS\"],\r\n            TILEMATRIXSET: [\"Contents\", \"TileMatrixSet\", \"Identifier\"],\r\n            TILEMATRIXSETLABELS: [\"Contents\", \"TileMatrixSet\"]\r\n        };\r\n        var getOfPath = function (obj, p, i) {\r\n            if (i < p.length - 1) {\r\n                if (obj.hasOwnProperty(p[i]))\r\n                    return getOfPath(obj[p[i]], p, ++i);\r\n                else return null;\r\n            } else {\r\n                if (obj instanceof Array) {\r\n                    var _obj = [];\r\n                    for (var a = 0; a < obj.length; a++) {\r\n                        if (obj[a].hasOwnProperty(p[i]))\r\n                            _obj.push(obj[a][p[i]]);\r\n                    }\r\n\r\n                    return _obj;\r\n                } else return obj[p[i]];\r\n            }\r\n        };\r\n\r\n        var getTileMatrixSetLabelByLayerOnCapabilities = function (layer, crs) {\r\n            if ((capsURL = TC.Util.isOnCapabilities(layer.url))) {\r\n                if ((caps = TC.capabilities[capsURL])) {\r\n                    var tileMatrixSet = getOfPath(caps, paths.TILEMATRIXSETLABELS, 0);\r\n                    for (var a = 0; a < tileMatrixSet.length; a++) {\r\n                        if (TC.Util.CRSCodesEqual(crs, tileMatrixSet[a][\"SupportedCRS\"])) {\r\n                            return { id: tileMatrixSet[a].Identifier, labels: getOfPath(tileMatrixSet[a], [\"TileMatrix\", \"Identifier\"], 0) };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return null;\r\n        };\r\n\r\n        var wmtsLayer = function (layer) {\r\n            const self = this;\r\n            return new Promise(function (resolve, reject) {\r\n                let tileMatrixSetLabels = getTileMatrixSetLabelByLayerOnCapabilities(layer, self.layerCrs);\r\n                let resource;\r\n                let resourceURL;\r\n                if (TC.Consts.WMTSEncoding.KVP === layer.encoding) {\r\n                    resource = new cesium.Resource({\r\n                        url: layer.url,\r\n                        request: new cesium.Request({\r\n                            type: cesium.RequestType.IMAGERY\r\n                        })\r\n                    });\r\n                } else if (TC.Consts.WMTSEncoding.RESTFUL === layer.encoding) {\r\n                    const wmtsLayer = layer.wrap.getWMTSLayer({ crs: self.layerCrs });\r\n                    if (wmtsLayer && wmtsLayer.ResourceURL && wmtsLayer.ResourceURL.length > 0) {\r\n                        resourceURL = wmtsLayer.ResourceURL[0];\r\n                        resource = new cesium.Resource({\r\n                            url: resourceURL.template,\r\n                            request: new cesium.Request({\r\n                                type: cesium.RequestType.IMAGERY\r\n                            })\r\n                        });\r\n                    }\r\n                }\r\n                if (resource && tileMatrixSetLabels) {\r\n                    resource.tcLayer = layer;\r\n                    let options = {\r\n                        url: resource,\r\n                        layer: layer.layerNames,\r\n                        style: 'default',\r\n                        format: resourceURL && resourceURL.format || layer.format || layer.options.format,\r\n                        tilingScheme: new cesium.GeographicTilingScheme()\r\n                    };\r\n\r\n                    if (TC.Consts.WMTSEncoding.RESTFUL === layer.encoding) {\r\n                        options.tileMatrixSetID = tileMatrixSetLabels.id;\r\n                    } else if (TC.Consts.WMTSEncoding.KVP === layer.encoding && tileMatrixSetLabels) {\r\n                        options.tileMatrixSetID = tileMatrixSetLabels.id;\r\n                        options.tileMatrixLabels = tileMatrixSetLabels.labels;\r\n                    }\r\n\r\n                    if (tileMatrixSetLabels && tileMatrixSetLabels.labels) {\r\n                        options.maximumLevel = parseInt(tileMatrixSetLabels.labels[tileMatrixSetLabels.labels.length - 1]);\r\n                    }\r\n\r\n                    // cuando un WMTS no tenga el matrixset de 0 a 21 requeriremos de la siguiente instrucción\r\n                    // Cesium requiere que los niveles vayan de 0 a 21 aunque físicamente no sea así\r\n                    //if (tileMatrixSetLabels && tileMatrixSetLabels.labels[0] !== 0) {\r\n                    //    options.tileMatrixLabels = [...Array(21/*tileMatrixSetLabels.labels.length*/).keys()];\r\n                    //}\r\n\r\n                    resolve(new cesium.WebMapTileServiceImageryProvider(options));\r\n\r\n                } else {\r\n                    reject('Faltan datos para instanciar la capa');\r\n                }\r\n            });\r\n        }\r\n\r\n        var wmsLayer = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                let resource = new cesium.Resource({\r\n                    url: layer.url,\r\n                    request: new cesium.Request({\r\n                        type: cesium.RequestType.IMAGERY\r\n                    })\r\n                });\r\n                resource.tcLayer = layer;\r\n                let options = {\r\n                    url: resource,\r\n                    layers: layer.layerNames,\r\n                    parameters: {\r\n                        version: \"1.3.0\",\r\n                        transparent: true,\r\n                        format: layer.format || layer.options.format\r\n                    }\r\n                };\r\n\r\n                var bindEXBBox = function () {\r\n                    var bbox = [];\r\n                    if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                        if (layer.names.length > 0) {\r\n                            var names = layer.names.slice(0);\r\n                            var _getEXBBox = function _getEXBBox(nodes, name) {\r\n                                if (nodes) {\r\n                                    for (var i = 0; i < nodes.length; i++) {\r\n                                        var n = nodes[i];\r\n                                        if (layer.compareNames(layer.wrap.getName(n), name)) {\r\n                                            return n.EX_GeographicBoundingBox;\r\n                                        }\r\n                                    }\r\n\r\n                                    return _getEXBBox(n.Layer, name);\r\n                                }\r\n                            };\r\n                            while (names.length > 0) {\r\n                                var exBBox = _getEXBBox([layer.capabilities.Capability.Layer], names.pop());\r\n                                if (exBBox !== null) {\r\n                                    bbox.push(exBBox);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    return bbox;\r\n                };\r\n                var exBoundingBox = bindEXBBox();\r\n\r\n                if (exBoundingBox) {\r\n                    layer.geoBBox = exBoundingBox;\r\n                }\r\n\r\n                resolve(new cesium.WebMapServiceImageryProvider(options));\r\n            });\r\n        };\r\n\r\n        var CustomResource;\r\n        var defineCustomResource = function () {\r\n            /* tengo que sobrescribir porque no valida nada... \r\n            Desde la version 1.42 han cambiado la definición de un proxy en las capas raster: si configuras con proxy, pide directamente desde el proxy y si da error no gestiona nada, \r\n            y si no configuras proxy, pide directamente sin tampoco gestionar los errores. Además la creación de una capa raster es síncrona, por lo que no encaja con el algoritmo de proxificación */\r\n            CustomResource = function (options, layer) {\r\n                cesium.Resource.call(this, options);\r\n\r\n                this.layer = layer;\r\n            };\r\n            CustomResource.prototype.constructor = CustomResource;\r\n            CustomResource.prototype = Object.create(cesium.Resource.prototype, {});\r\n            CustomResource.prototype.clone = function (result) {\r\n\r\n                var cloned = cesium.Resource.prototype.clone.call(this, result);\r\n\r\n                if (!cesium.defined(result)) {\r\n                    result = new CustomResource({\r\n                        url: this._url\r\n                    }, this.layer);\r\n                }\r\n\r\n                result._url = cloned._url;\r\n                result._queryParameters = cloned._queryParameters;\r\n                result._templateValues = cloned._templateValues;\r\n                result.headers = cloned.headers;\r\n                result.proxy = cloned.proxy;\r\n                result.retryCallback = cloned.retryCallback;\r\n                result.retryAttempts = cloned.retryAttempts;\r\n                result._retryCount = 0;\r\n\r\n                result.request = cloned.request;\r\n\r\n\r\n\r\n                return result;\r\n            };\r\n            CustomResource.prototype.fetchImage = customFetchImage;\r\n        };\r\n\r\n        /* inicio cesium Resource override */\r\n        var xhrBlobSupported = (function () {\r\n            try {\r\n                var xhr = new XMLHttpRequest();\r\n                xhr.open('GET', '#', true);\r\n                xhr.responseType = 'blob';\r\n                return xhr.responseType === 'blob';\r\n            } catch (e) {\r\n                return false;\r\n            }\r\n        })();\r\n\r\n        function checkAndResetRequest(request) {\r\n            if (request.state === cesium.RequestState.ISSUED || request.state === cesium.RequestState.ACTIVE) {\r\n                throw new cesium.RuntimeError('The Resource is already being fetched.');\r\n            }\r\n\r\n            request.state = cesium.RequestState.UNISSUED;\r\n            request.deferred = undefined;\r\n        }\r\n\r\n        function createImage(layer, url, crossOrigin, deferred) {\r\n            var getImage = function (url) {\r\n                var image = new Image();\r\n\r\n                image.onload = function (layer) {\r\n                    deferred.resolve(image);\r\n                }.bind(image, layer);\r\n\r\n                image.onerror = function (layer, e) {\r\n                    deferred.reject(e);\r\n                }.bind(image, layer);\r\n\r\n                if (crossOrigin) {\r\n                    if (cesium.TrustedServers.contains(url)) {\r\n                        image.crossOrigin = 'use-credentials';\r\n                    } else {\r\n                        image.crossOrigin = '';\r\n                    }\r\n                }\r\n\r\n                image.src = url;\r\n            };\r\n\r\n            layer.getWebGLUrl.call(layer, url).then(getImage, function (e) {\r\n                deferred.reject(e);\r\n            });\r\n        };\r\n\r\n        function fetchImage(resource, allowCrossOrigin) {\r\n            var request = resource.request;\r\n            request.url = resource.url;\r\n            request.requestFunction = function () {\r\n                var url = resource.url;\r\n                var crossOrigin = false;\r\n\r\n                // data URIs can't have allowCrossOrigin set.\r\n                if (!resource.isDataUri && !resource.isBlobUri) {\r\n                    crossOrigin = resource.isCrossOriginUrl;\r\n                }\r\n\r\n                var deferred = cesium.when.defer();\r\n\r\n                createImage(resource.layer, url, crossOrigin && allowCrossOrigin, deferred);\r\n\r\n                return deferred.promise;\r\n            };\r\n\r\n            var promise = cesium.RequestScheduler.request(request);\r\n            if (!cesium.defined(promise)) {\r\n                return;\r\n            }\r\n\r\n            return promise.otherwise(function (e) {\r\n                return cesium.when.reject(e);\r\n            });\r\n        }\r\n\r\n        var customFetchImage = function (preferBlob, allowCrossOrigin) {\r\n            if (cesium.defined(allowCrossOrigin)) {\r\n                cesium.deprecationWarning('Resource.fetchImage.allowCrossOrigin', 'The allowCrossOrigin parameter has been deprecated and will be removed in cesium 1.44. It no longer needs to be specified.');\r\n            }\r\n\r\n            preferBlob = cesium.defaultValue(preferBlob, false);\r\n            allowCrossOrigin = cesium.defaultValue(allowCrossOrigin, true);\r\n\r\n            checkAndResetRequest(this.request);\r\n\r\n            // We try to load the image normally if\r\n            // 1. Blobs aren't supported\r\n            // 2. It's a data URI\r\n            // 3. It's a blob URI\r\n            // 4. It doesn't have request headers and we preferBlob is false\r\n            if (!xhrBlobSupported || this.isDataUri || this.isBlobUri || (!this.hasHeaders && !preferBlob)) {\r\n                return fetchImage(this, allowCrossOrigin);\r\n            }\r\n\r\n            var blobPromise = this.fetchBlob();\r\n            if (!cesium.defined(blobPromise)) {\r\n                return;\r\n            }\r\n\r\n            var generatedBlobResource;\r\n            var generatedBlob;\r\n            return blobPromise\r\n                .then(function (blob) {\r\n                    if (!cesium.defined(blob)) {\r\n                        return;\r\n                    }\r\n                    generatedBlob = blob;\r\n                    var blobUrl = window.URL.createObjectURL(blob);\r\n                    generatedBlobResource = new cesium.Resource({\r\n                        url: blobUrl\r\n                    });\r\n\r\n                    return fetchImage(generatedBlobResource);\r\n                })\r\n                .then(function (image) {\r\n                    if (!cesium.defined(image)) {\r\n                        return;\r\n                    }\r\n                    window.URL.revokeObjectURL(generatedBlobResource.url);\r\n\r\n                    // This is because the blob object is needed for DiscardMissingTileImagePolicy\r\n                    // See https://github.com/AnalyticalGraphicsInc/cesium/issues/1353\r\n                    image.blob = generatedBlob;\r\n                    return image;\r\n                })\r\n                .otherwise(function (error) {\r\n                    if (cesium.defined(generatedBlobResource)) {\r\n                        window.URL.revokeObjectURL(generatedBlobResource.url);\r\n                    }\r\n\r\n                    return cesium.when.reject(error);\r\n                });\r\n        };\r\n        /* fin cesium Resource override */\r\n\r\n        this.convert = function (layer, map3DCRS) {\r\n            var csmLayer;\r\n\r\n            this.layerCrs = map3DCRS;\r\n\r\n            if (!CustomResource) { defineCustomResource(); }\r\n\r\n            switch (true) {\r\n                case TC.Consts.layerType.WMTS == layer.type:\r\n                    return wmtsLayer.call(this, layer);\r\n                case TC.Consts.layerType.WMS == layer.type:\r\n                    return wmsLayer.call(this, layer);\r\n                    break;\r\n            }\r\n        };\r\n    };\r\n    const FeatureConverter = function () {\r\n        var scene = null;\r\n        var toCesiumColor = function (hexStringColor, alpha) {\r\n            if (hexStringColor instanceof Array) {\r\n                hexStringColor = \"rgba(\" + hexStringColor[0] + \", \" + hexStringColor[1] + \", \" + hexStringColor[2] + \", \" + hexStringColor[3] + \")\";\r\n            }\r\n            var color = cesium.Color.fromCssColorString(hexStringColor);\r\n            if (alpha !== undefined) {\r\n                return color.withAlpha(alpha);\r\n            }\r\n\r\n            return color;\r\n        }\r\n        var setStyleProperties = function (styles, properties, feature) {\r\n            for (var key in properties) { // recorremos el diccionario de propiedades que admitimos como estilo\r\n                var attr = styles[properties[key].prop];\r\n                if (attr !== undefined) {\r\n                    if (typeof (attr) === \"function\") { // si la propiedad del estilo es una función (como en el control de búsquedas) invocamos para obtener el valor\r\n                        var val = attr(feature);\r\n                        if (val) {\r\n                            properties[key].val = val;\r\n                        }\r\n                    } else {\r\n                        properties[key].val = attr; // obtenenemos el valor\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        var getPixelSize = function (coords) {\r\n            var rectangle;\r\n\r\n            if (coords.length == 1) {\r\n                var point = coords[0];\r\n                var delta = 1000;\r\n                var minx, miny, maxx, maxy;\r\n                minx = new cesium.Cartesian3(point.x - delta, point.y, point.z);\r\n                miny = new cesium.Cartesian3(point.x, point.y - delta, point.z);\r\n                maxx = new cesium.Cartesian3(point.x + delta, point.y, point.z);\r\n                maxy = new cesium.Cartesian3(point.x, point.y + delta, point.z);\r\n\r\n                rectangle = cesium.Rectangle.fromCartesianArray([minx, miny, maxx, maxy], cesium.Ellipsoid.WGS84);\r\n            } else {\r\n                rectangle = cesium.Rectangle.fromCartesianArray(coords, cesium.Ellipsoid.WGS84);\r\n            }\r\n\r\n            var neededCameraPosition = scene.camera.getRectangleCameraCoordinates(rectangle);\r\n            var distance = cesium.Cartesian3.distance(neededCameraPosition, cesium.BoundingSphere.fromPoints(coords).center);\r\n            var pixelSize = scene.camera.frustum.getPixelDimensions(scene.drawingBufferWidth, scene.drawingBufferHeight, distance, scene.pixelRatio, new cesium.Cartesian2());\r\n            pixelSize = Math.max(pixelSize.x, pixelSize.y);\r\n            return Math.round(pixelSize) == 0 ? 1 : pixelSize;\r\n        };\r\n\r\n        var getFeatureStyle = function (feature) {\r\n            var self = this;\r\n            var styles;\r\n\r\n            if (!feature.layer || (feature.layer && !feature.layer.hasOwnProperty('styles'))) {\r\n                styles = TC.Defaults.styles;\r\n            } else {\r\n                styles = feature.layer.styles;\r\n            }\r\n\r\n            styles = styles[feature.STYLETYPE] == undefined ?\r\n                styles[(feature.STYLETYPE === \"polyline\" ? \"line\" : feature.STYLETYPE)] :\r\n                styles[(feature.STYLETYPE === \"multipolygon\" ? \"polygon\" : feature.STYLETYPE)];\r\n\r\n            styles = TC.Util.extend({}, styles, feature.options, feature.getStyle());\r\n\r\n            return styles;\r\n        }\r\n\r\n        function createLine(id, coords, options, callback) {\r\n            var entity = new cesium.Entity({\r\n                name: id,\r\n                polyline: {\r\n                    positions: coords,\r\n                    width: options.width,\r\n                    material: options.material,\r\n                    clampToGround: true\r\n                }\r\n            });\r\n\r\n            callback(entity);\r\n        };\r\n\r\n        var circleConverter = function (feature) {\r\n            var self = this;\r\n            var circle = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            circle.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'fillColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            circle.geometryType = function (coords, options) {\r\n\r\n                return new cesium.GroundPrimitive({\r\n                    releaseGeometryInstances: false,\r\n                    geometryInstances: new cesium.GeometryInstance({\r\n                        id: feature.id,\r\n                        geometry: new cesium.CircleGeometry({\r\n                            center: coords[0],\r\n                            radius: feature.geometry[1]\r\n                        }),\r\n                        attributes: {\r\n                            color: options.color\r\n                        }\r\n                    })\r\n                });\r\n\r\n                // Para obtener el contorno de círculo \r\n                //var radius = feature.geometry[1];\r\n                //var outlineEllipse = cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius,\r\n                //    semiMajorAxis: radius,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var outerPositions = cesium.Cartesian3.unpackArray(outlineEllipse.outerPositions);\r\n\r\n                //var outlineSize = getPixelSize(outerPositions);\r\n                //var metersPerPixel = scene.camera.getPixelSize(cesium.BoundingSphere.fromPoints(outerPositions), scene.drawingBufferWidth, scene.drawingBufferHeight);\r\n                //var outlineInMeters = metersPerPixel * outlineSize;\r\n\r\n                //var outlineHoleEllipse = cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius - outlineInMeters,\r\n                //    semiMajorAxis: radius - outlineInMeters,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var innerPositions = cesium.Cartesian3.unpackArray(outlineHoleEllipse.outerPositions);\r\n\r\n                //var outlineCircleGeom = new cesium.GroundPrimitive({\r\n                //    geometryInstances: new cesium.GeometryInstance({\r\n                //        id: feature.id + 'outline',\r\n                //        geometry: new cesium.PolygonGeometry({\r\n                //            polygonHierarchy: new cesium.PolygonHierarchy(outerPositions, [new cesium.PolygonHierarchy(innerPositions)])\r\n                //        }),\r\n                //        attributes: {\r\n                //            color: options.outlineColor\r\n                //        }\r\n                //    })\r\n                //});\r\n            };\r\n\r\n            return circle;\r\n        };\r\n        var polygonConverter = function (feature) {\r\n            var self = this;\r\n            var polygon = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            polygon.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = color;\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var getting = [];\r\n\r\n                        var geomPolys = [];\r\n                        var geomOutlines = [];\r\n\r\n                        var getPolyGeom = function (polygonHierarchy) {\r\n                            return new cesium.GeometryInstance({\r\n                                id: feature.id,\r\n                                geometry: new cesium.PolygonGeometry({\r\n                                    polygonHierarchy: polygonHierarchy\r\n                                }),\r\n                                attributes: {\r\n                                    color: options.color\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        var getOutlineGeom = function (outlineCoords) {\r\n                            return new Promise(function (res, rej) {\r\n                                createLine(feature.id, outlineCoords, { material: options.outlineColor, width: options.width }, function (entity) {\r\n                                    geomOutlines.push(entity);\r\n                                    res();\r\n                                });\r\n                            });\r\n                        };\r\n\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            for (var j = 0; j < coords[i].length; j++) {\r\n                                var hierarchy;\r\n                                if (j == 0) {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][0]));\r\n                                    hierarchy = new cesium.PolygonHierarchy(coords[i][0]);\r\n                                } else {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][j]));\r\n                                    hierarchy.holes.push(new cesium.PolygonHierarchy(coords[i][j]));\r\n                                }\r\n                            }\r\n\r\n                            geomPolys.push(getPolyGeom(hierarchy));\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(\r\n                                [new cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: geomPolys\r\n                                }), geomOutlines]);\r\n                        }).catch(reject);\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if (Array.isArray(coords) && coords.length === 1 && Array.isArray(coords[0])) {\r\n                            coords = coords[0];\r\n                        }\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.outlineColor, width: options.width\r\n                        }, function (entity) {\r\n\r\n                            resolve([\r\n                                new cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: new cesium.GeometryInstance({\r\n                                        id: feature.id,\r\n                                        geometry: new cesium.PolygonGeometry({\r\n                                            polygonHierarchy: new cesium.PolygonHierarchy(coords)\r\n                                        }),\r\n                                        attributes: {\r\n                                            color: options.color\r\n                                        }\r\n                                    })\r\n                                }), entity]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return polygon;\r\n        };\r\n        var lineConverter = function (feature) {\r\n            var self = this;\r\n            var line = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            line.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = color;\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var geomInstances = [];\r\n\r\n                        var getting = [];\r\n\r\n                        if (coords.length == 1) {\r\n                            coords = coords[0];\r\n\r\n                            getting.push(new Promise(function (res, rej) {\r\n                                createLine(feature.id, coords, {\r\n                                    material: options.color, width: options.width\r\n                                }, function (entity) {\r\n                                    geomInstances.push(entity);\r\n                                    res();\r\n                                });\r\n                            }));\r\n\r\n\r\n                        } else {\r\n                            coords = coords.sort(function (a, b) {\r\n                                if (a.length > b.length) {\r\n                                    return -1;\r\n                                }\r\n                                if (a.length < b.length) {\r\n                                    return 1;\r\n                                }\r\n                                return 0;\r\n                            });\r\n                            var pixelSize = getPixelSize(coords[0]);\r\n                            for (var i = 0; i < coords.length; i++) {\r\n\r\n                                getting.push(new Promise(function (res, rej) {\r\n                                    createLine(feature.id, coords[i], {\r\n                                        material: options.color, width: options.width\r\n                                    }, function (entity) {\r\n                                        geomInstances.push(entity);\r\n                                        res();\r\n                                    });\r\n                                }));\r\n                            }\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(geomInstances);\r\n                        }).catch(reject);\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.color, width: options.width\r\n                        }, function (entity) {\r\n                            resolve(entity);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return line;\r\n        };\r\n        var pointConverter = function (feature) {\r\n            var self = this;\r\n            var point = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            point.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    rotation: { prop: 'angle' },\r\n                    label: { prop: 'label' },\r\n                    fontSize: { prop: 'fontSize' },\r\n                    fontColor: { prop: 'fontColor' },\r\n                    outlineLabelColor: { prop: 'labelOutlineColor' },\r\n                    outlineLabelWidth: { prop: 'labelOutlineWidth' },\r\n                    anchor: { prop: 'anchor' },\r\n                    height: { prop: 'height' },\r\n                    width: { prop: 'width' },\r\n                    url: { prop: 'url' },\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    outlineWidth: { prop: 'strokeWidth' },\r\n                    radius: { prop: 'radius' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.anchor.hasOwnProperty('val')) {\r\n                    if (!(properties.url.hasOwnProperty('val')) && feature.options.url) {\r\n                        opt.url = feature.options.url;\r\n                    } else {\r\n                        opt.url = properties.url.val;\r\n                    }\r\n\r\n                    opt.anchor = properties.anchor.val;\r\n                }\r\n\r\n                if (properties.height.hasOwnProperty('val')) {\r\n                    opt.height = properties.height.val;\r\n                }\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                if (properties.rotation.hasOwnProperty('val')) {\r\n                    opt.rotation = properties.rotation.val;\r\n                }\r\n\r\n                if (properties.label.hasOwnProperty('val')) {\r\n                    opt.label = properties.label.val;\r\n                }\r\n\r\n                if (properties.fontSize.hasOwnProperty('val')) {\r\n                    opt.fontSize = properties.fontSize.val;\r\n                }\r\n\r\n                if (properties.fontColor.hasOwnProperty('val')) {\r\n                    opt.fontColor = toCesiumColor(properties.fontColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelColor.hasOwnProperty('val')) {\r\n                    opt.outlineLabelColor = toCesiumColor(properties.outlineLabelColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelWidth.hasOwnProperty('val')) {\r\n                    opt.outlineLabelWidth = properties.outlineLabelWidth.val;\r\n                }\r\n\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        opt.color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        opt.color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineWidth.hasOwnProperty('val')) {\r\n                    opt.outlineWidth = properties.outlineWidth.val;\r\n                }\r\n\r\n                if (properties.radius.hasOwnProperty('val')) {\r\n                    opt.radius = properties.radius.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\") {\r\n                point.geometryType = function (coords, options) {\r\n                    var billboard = {\r\n                        name: feature.id,\r\n                        position: coords[0],\r\n                        billboard: {\r\n                            image: options.url,\r\n                            width: options.width,\r\n                            height: options.height,\r\n                            eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                            verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                            heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                        }\r\n                    };\r\n\r\n                    if (options.anchor && options.anchor.length > 0) {\r\n                        billboard.billboard.pixelOffset = new cesium.Cartesian2(options.anchor[0], options.anchor[1]);\r\n                    }\r\n\r\n                    if (!options.label) {\r\n                        return new cesium.Entity(billboard);\r\n                    } else {\r\n                        billboard.label = {\r\n                            text: options.label,\r\n                            font: '14pt sans-serif',\r\n                            heightReference: cesium.HeightReference.CLAMP_TO_GROUND,\r\n                            horizontalOrigin: cesium.HorizontalOrigin.LEFT,\r\n                            verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                            fillColor: options.fontColor,\r\n                            showBackground: true,\r\n                            eyeOffset: new cesium.Cartesian3(3000, 0, -100)\r\n                        };\r\n\r\n                        return new cesium.Entity(billboard);\r\n                    }\r\n                };\r\n            }\r\n            else if (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\") {\r\n                var pinBuilder = new cesium.PinBuilder();\r\n\r\n                point.geometryType = function (coords, options) {\r\n                    var text = options.label;\r\n\r\n                    switch (true) {\r\n                        case (text && /^([A-Z])\\w+$/gi.test(text)):\r\n                        case (text && !/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n\r\n                            return new cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                label: {\r\n                                    text: options.label,\r\n                                    eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                                    heightReference: cesium.HeightReference.CLAMP_TO_GROUND,\r\n                                    horizontalOrigin: cesium.HorizontalOrigin.CENTER,\r\n                                    verticalOrigin: cesium.VerticalOrigin.BASELINE,\r\n                                    font: '16' + 'px san-serif Helvetica',\r\n                                    fillColor: cesium.Color.BLACK,\r\n                                    outlineColor: cesium.Color.WHITE,\r\n                                    outlineWidth: 5,\r\n                                    style: cesium.LabelStyle.FILL_AND_OUTLINE\r\n                                }\r\n                            });\r\n\r\n                            break;\r\n                        case (/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n                            return new cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromText(text, options.fontColor, 48).toDataURL(),\r\n                                    eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                                    heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                            break;\r\n                        case options.radius && options.radius > 0:\r\n                            var stringifyScratch = new Array(2);\r\n\r\n                            const drawPin = function (context2D, color, size) {\r\n\r\n                                color = color.darken(0.15, new cesium.Color());\r\n                                var rgbaColor = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \",0)\");\r\n\r\n                                context2D.save();\r\n                                context2D.scale(size / 24, size / 24);\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.miterLimit = 4;\r\n                                context2D.font = \"normal normal 400 normal 15px / 21.4286px ''\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.fillStyle = \"#b3b3b3\";\r\n                                context2D.fillStyle = \"rgba(179, 179, 179, 1)\";\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(11.578125, 11.71875);\r\n                                context2D.lineTo(12.421875, 11.71875);\r\n                                context2D.lineTo(12.421875, 24);\r\n                                context2D.lineTo(11.578125, 24);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.fillStyle = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \", 1)\");\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(17, 7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 0, 1.5707963267948966, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 1.5707963267948966, 3.141592653589793, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 3.141592653589793, 4.71238898038469, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, -1.5707963267948966, 0, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                            };\r\n\r\n                            const createPin = function (color, size) {\r\n                                if (!pinBuilder._cache) {\r\n                                    pinBuilder._cache = {};\r\n                                }\r\n\r\n                                stringifyScratch[0] = color;\r\n                                stringifyScratch[1] = size;\r\n                                var id = JSON.stringify(stringifyScratch);\r\n\r\n                                var item = pinBuilder._cache[id];\r\n                                if (item) {\r\n                                    return item;\r\n                                }\r\n\r\n                                var canvas = document.createElement('canvas');\r\n                                canvas.width = size;\r\n                                canvas.height = size;\r\n\r\n                                var context2D = canvas.getContext('2d');\r\n                                drawPin(context2D, color, size);\r\n\r\n                                pinBuilder._cache[id] = canvas;\r\n                                return canvas;\r\n                            }\r\n\r\n                            return new cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: createPin(cesium.Color.fromCssColorString(feature.options.strokeColor ? feature.options.strokeColor : TC.Cfg.styles.point.strokeColor), 48).toDataURL(),\r\n                                    eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                        default:\r\n                            return new cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromColor(cesium.Color.fromCssColorString(feature.options.fillColor ? feature.options.fillColor : TC.Cfg.styles.point.fillColor), 32).toDataURL(),\r\n                                    eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                    }\r\n                };\r\n            }\r\n\r\n            return point;\r\n        };\r\n\r\n        this.convert = function (scn, feature, sourceCrs, targetCrs) {\r\n            scene = scn;\r\n\r\n            var byPromise = false;\r\n            var cartesians = [];\r\n            var toCartesian = function (coord, arr) {\r\n                if (!Array.isArray(coord)) {\r\n                    return;\r\n                }\r\n\r\n                if (sourceCrs !== targetCrs) {\r\n                    coord = TC.Util.reproject(coord, sourceCrs, targetCrs);\r\n                }\r\n\r\n                arr.push(coord.length > 2 ?\r\n                    cesium.Cartesian3.fromDegrees(coord[0], coord[1], coord[2]) :\r\n                    cesium.Cartesian3.fromDegrees(coord[0], coord[1]));\r\n            };\r\n\r\n            var obj;\r\n            var geometry = feature.geometry;\r\n            var converter;\r\n\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons;\r\n\r\n            var forPoints = function (points, arr) {\r\n                if (Array.isArray(points)) {\r\n                    for (var i = 0; i < points.length; i++) {\r\n                        toCartesian(points[i], arr);\r\n                    }\r\n                }\r\n            };\r\n            var forRingsOrPolylines = function (ringsOrPolylines, arr) {\r\n                if (Array.isArray(ringsOrPolylines)) {\r\n                    for (var i = 0; i < ringsOrPolylines.length; i++) {\r\n                        arr.push([]);\r\n                        forPoints(ringsOrPolylines[i], arr[arr.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n            var forPolygons = function (polygons) {\r\n                if (Array.isArray(polygons)) {\r\n                    for (var i = 0; i < polygons.length; i++) {\r\n                        cartesians.push([]);\r\n                        forRingsOrPolylines(polygons[i], cartesians[cartesians.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n\r\n            switch (true) {\r\n                case (TC.feature.Circle && feature.CLASSNAME == \"TC.feature.Circle\"):\r\n                    forPoints(geometry, cartesians);\r\n                    converter = circleConverter.call(self, feature);\r\n                    break;\r\n                case (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\"):\r\n                    polygons = geometry;\r\n                    if (Array.isArray(polygons)) {\r\n                        forPolygons(polygons);\r\n\r\n                        converter = polygonConverter.call(self, feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case ((TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") || (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\")):\r\n                    ringsOrPolylines = geometry;\r\n                    if (Array.isArray(ringsOrPolylines)) {\r\n                        forRingsOrPolylines(ringsOrPolylines, cartesians);\r\n\r\n                        if (feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                            converter = polygonConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                        else if (feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                            converter = lineConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                    }\r\n                    break;\r\n                case (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\"):\r\n                    points = geometry;\r\n                    if (Array.isArray(points)) {\r\n                        forPoints(points, cartesians);\r\n\r\n                        converter = lineConverter(feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n                case (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n            }\r\n\r\n            if (cartesians.length == 0) {\r\n                return null;\r\n            }\r\n\r\n            obj = {\r\n                id: feature.id,\r\n                attributes: feature.data,\r\n                boundigSphere: cesium.BoundingSphere.fromPoints(cartesians)\r\n            };\r\n\r\n            if (!byPromise) { // si estamos pintando líneas, obtenemos posiciones con altura\r\n                obj.geometry = converter.geometryType(cartesians, converter.options());\r\n            } else {\r\n                obj.geometry = function (provider) {\r\n                    converter.provider = provider;\r\n                    return converter.geometryType(cartesians, converter.options());\r\n                }\r\n            }\r\n\r\n            return obj;\r\n        };\r\n    };\r\n\r\n    const currentMapCfg = {\r\n        baseMap: '',\r\n        baseMaps: [],\r\n        baseVector: ''\r\n    };\r\n    const setMustReprojectOfBaseLayers = function (map) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var isBaseRaster = map.baseLayer instanceof TC.layer.Raster;\r\n\r\n            if (isBaseRaster) {\r\n                if (!isCompatible(map.baseLayer, self.view3D.crs)) {\r\n                    var fallbackLayer = map.baseLayer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (!fallbackLayer.isCompatible(self.view3D.crs)) {\r\n                                map.toast(self.getLocaleString('threed.baseLayerNoCompatible', { name: map.baseLayer.layerNames }));\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                currentMapCfg.baseVector = map.baseLayer;\r\n            }\r\n\r\n            if (currentMapCfg.baseMaps.length === 0) {\r\n\r\n                Promise.all(map.baseLayers.map(function (baseLayer) {\r\n                    if (!isCompatible(baseLayer, self.view3D.crs)) {\r\n                        var fallbackLayer = baseLayer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            return fallbackLayer._capabilitiesPromise.then(function () {\r\n                                return !fallbackLayer.isCompatible(self.view3D.crs);\r\n                            });\r\n                        } else {\r\n                            return Promise.resolve(true);\r\n                        }\r\n                    } else {\r\n                        return Promise.resolve(false);\r\n                    }\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        for (var i = 0; i < map.baseLayers.length; i++) {\r\n                            if (map.baseLayers[i]) {\r\n                                map.baseLayers[i].mustReproject = results[i];\r\n                            }\r\n                        }\r\n\r\n                        //map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n                    }\r\n\r\n                    resolve();\r\n                }).catch(reject);\r\n            }\r\n\r\n            currentMapCfg.baseMap = isBaseRaster ? map.baseLayer : self.Consts.BLANK_BASE;\r\n        });\r\n    };\r\n\r\n    viewProto.init = function (options) {\r\n        const self = this;\r\n\r\n        self.events = self.map.$events;\r\n\r\n        self.selectors = {\r\n            divThreedMap: options.div\r\n        };\r\n\r\n        if (options.terrain) {\r\n            self.terrain = options.terrain;\r\n        } else {\r\n            self.terrain = {\r\n                url: \"//idena.navarra.es/cesiumTerrain/2017/epsg4326/5m/\",\r\n                noDataValue: 0,\r\n                attributions: {\r\n                    name: \"Álvaro Huarte\",\r\n                    site: \"https://github.com/ahuarte47\"\r\n                }\r\n            };\r\n        }\r\n\r\n        if (options.terrainFallback && options.terrainFallback.url && options.terrainFallback.coverageName && options.terrainFallback.noDataValue) {\r\n            self.terrainFallback = {\r\n                url: options.terrainFallback.url.trim(),\r\n                layerName: options.terrainFallback.coverageName,\r\n                format: options.terrainFallback.format,\r\n                noDataValue: options.terrainFallback.noDataValue\r\n            };\r\n        } else if (options.terrainFallback && (!options.terrainFallback.url || !options.terrainFallback.coverageName || !options.terrainFallback.noDataValue)) {\r\n            self.terrainFallback = {\r\n                url: \"https://image.discomap.eea.europa.eu/arcgis/services/Elevation/EUElev_DEM_V11/MapServer/WCSServer\",\r\n                coverageName: \"1\",\r\n                format: \"GeoTIFF\",\r\n                noDataValue: -32767\r\n            };\r\n        }\r\n\r\n        if (options.controls) {\r\n            self.allowedControls = options.controls;\r\n        }\r\n\r\n        self.mapView = new MapView(self.map, self);\r\n\r\n        self.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            self.mapView.metersPerUnit = self.map.getMetersPerUnit();\r\n        });\r\n\r\n        self.map.view3D = self.view3D;\r\n\r\n        /* provisional: no dispongo de getRenderedHtml porque ya no es un control */\r\n        self.getRenderedHtml(self.CLASS + '-overlay', {}, function (html) {\r\n            const parser = new DOMParser();\r\n            self.overlay = parser.parseFromString(html, 'text/html').body.firstChild;\r\n        });\r\n    };\r\n\r\n    viewProto.apply = function (options) {\r\n        const self = this;\r\n\r\n        options = options || {};\r\n\r\n        if (options.map) {\r\n            self.map = options.map;\r\n\r\n            if (!self.map.view3D) {\r\n                var viewName = self.VIEWNAME = self.VIEWNAME.substr(0, 1).toLowerCase() + self.VIEWNAME.substr(1);\r\n                if (self.map.options.views && self.map.options.views.hasOwnProperty(viewName)) {\r\n                    self.init(self.map.options.views[viewName]);\r\n                } else {\r\n                    throw Error('Falta configuración de la vista');\r\n                }\r\n            }\r\n\r\n            self.view3D.view2DCRS = options.map.crs;\r\n\r\n            options.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.view3D.view2DCRS = e.newCrs;\r\n            });\r\n        } else {\r\n            throw Error('Falta referencia al mapa 2D');\r\n        }\r\n\r\n        if (options.state) {\r\n            self.map.toast(TC.Util.getLocaleString(self.map.options.locale, 'threed.apply3DState'), { type: TC.Consts.msgType.INFO });\r\n        }\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        if (!self.ctrlsToMng) {\r\n            var ctls = [];\r\n            for (var i = 0, len = self.allowedControls.length; i < len; i++) {\r\n                var ctl = self.allowedControls[i];\r\n                ctl = ctl.substr(0, 1).toUpperCase() + ctl.substr(1);\r\n                var ctlsOnMap = self.map.getControlsByClass('TC.control.' + ctl);\r\n                if (ctlsOnMap.length === 0) {\r\n                    ctl = ctl.toUpperCase();\r\n                    ctlsOnMap = self.map.getControlsByClass('TC.control.' + ctl);\r\n                }\r\n                if (ctlsOnMap.length === 0) { // si un control soportado aún no está en el mapa, nos suscribimos al addcontrol para controlarlo\r\n                    self.map.on(TC.Consts.event.CONTROLADD, function (ctrlClass, e) {\r\n                        try {\r\n                            var instance = new Function(\"return new \" + ctrlClass + \"()\")();\r\n                            if (instance.CLASS === e.control.CLASS) {\r\n                                self.ctrlsToMng.push(e.control);\r\n                            }\r\n                        } catch (error) { console.warn(\"Error al obtener la clase CSS de un control soportado\"); }\r\n                    }.bind(self, 'TC.control.' + ctl));\r\n                }\r\n                ctls = ctls.concat(ctlsOnMap);\r\n            }\r\n\r\n            self.ctrlsToMng = ctls;\r\n        }\r\n\r\n        self.map.on3DView = true;\r\n\r\n        self.map.div.classList.add(TC.Consts.classes.THREED);\r\n\r\n        self.divThreedMap = document.querySelector('#' + self.selectors.divThreedMap);\r\n        self.divThreedMap.classList.add(self.classes.MAP3D, self.classes.LOADING);\r\n\r\n        self.view3D.container = self.divThreedMap;\r\n\r\n        const applyEnd = function () {\r\n            console.log('Llega a applyEnd');\r\n\r\n            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n\r\n            delete self.waiting;\r\n\r\n            if (options.callback) {\r\n                options.callback();\r\n            }\r\n        };\r\n\r\n        try {\r\n            self.view3D.loadViewer.call(self)\r\n                .then(function () {\r\n\r\n                    self.divThreedMap.classList.remove(self.CLASS + '-div-fadeOut');\r\n                    self.divThreedMap.classList.add(self.CLASS + '-div-fadeIn');\r\n                    self.mapView.viewHTML.classList.remove(self.CLASS + '-div-fadeIn');\r\n                    self.mapView.viewHTML.classList.add(self.CLASS + '-div-fadeOut');\r\n\r\n                    if (!options.state) {\r\n                        self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                    }\r\n\r\n                    // mapas de fondo y capas\r\n                    setMustReprojectOfBaseLayers.call(self, self.map)\r\n                        .then(function () {\r\n                            // extent\r\n                            self.view3D.setCameraFromMapView.call(self);\r\n\r\n                            // mapa de fondo\r\n                            self.view3D.setBaseLayer.call(self, self.map.baseLayer);\r\n\r\n                            // capas de trabajo\r\n                            self.map.workLayers.filter(function (elem) {\r\n                                return elem.type === TC.Consts.layerType.WMTS || elem.type === TC.Consts.layerType.WMS;\r\n                            }).reverse().forEach(function (layer) {\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            });\r\n\r\n                            self.viewer.readyPromise.then(function () {\r\n\r\n                                if (!self.view3D.cameraControls) self.view3D.cameraControls = new CameraControls(self);\r\n                                else self.view3D.cameraControls.render.call(self.view3D.cameraControls);\r\n\r\n                                if (!options.animateRendering && !options.state) {\r\n                                    options.animateRendering = true;\r\n                                }\r\n\r\n                                if (options.state) {\r\n\r\n                                    self.divThreedMap.classList.remove(self.classes.LOADING);\r\n\r\n                                    var camera = self.view3D.cameraControls.getCamera();\r\n                                    camera.flyTo({\r\n                                        destination: cesium.Cartesian3.fromRadians(options.state.cp[0], options.state.cp[1], options.state.cp[2]),\r\n                                        orientation: {\r\n                                            heading: options.state.chpr[0],\r\n                                            pitch: options.state.chpr[1],\r\n                                            roll: options.state.chpr[2]\r\n                                        },\r\n                                        complete: applyEnd\r\n                                    });\r\n\r\n                                } else if (options.animateRendering) {\r\n                                    let angle = cesium.Math.toRadians(50);\r\n                                    let pickBP = pickBottomPoint(self.viewer.scene);\r\n\r\n                                    const readyPickBP = function (_pickBP) {\r\n                                        let matrixPickBP = cesium.Matrix4.fromTranslation(_pickBP);\r\n\r\n                                        self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle,\r\n                                            self.viewer.scene.camera.right, matrixPickBP, {\r\n                                                duration: 2000,\r\n                                                callback: animationCallback\r\n                                            });\r\n                                    };\r\n\r\n                                    const animationCallback = function () {\r\n                                        cesium.Camera.DEFAULT_VIEW_RECTANGLE = self.view3D.initialRectangle = self.viewer.camera.computeViewRectangle();\r\n                                        cesium.Camera.DEFAULT_VIEW_FACTOR = 0;\r\n\r\n                                        applyEnd();\r\n                                    };\r\n\r\n                                    if (pickBP) {\r\n                                        readyPickBP(pickBP);\r\n                                    } else { /* revisado: si llegamos aquí, es que el terreno está listo pero del canvas al terreno da null, esperamos un poco más */\r\n                                        // parece que es cosa de tiempos. Añado un setInterval\r\n\r\n                                        let checkPickBPProcess;\r\n                                        let startTime = new Date().getTime();\r\n\r\n                                        const checkPickBottomPoint = function () {\r\n                                            let _pickBP = pickBottomPoint(self.viewer.scene);\r\n                                            if (_pickBP) {\r\n                                                clearInterval(checkPickBPProcess);\r\n                                                readyPickBP(_pickBP);\r\n                                            } else {\r\n                                                if (new Date().getTime() - startTime > 15000) {\r\n                                                    clearInterval(checkPickBPProcess);\r\n                                                    // aunque sea nos centramos en el extent inicial\r\n                                                    let homeButton = document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn');\r\n                                                    if (homeButton && homeButton.length > 0) {\r\n                                                        homeButton[0].click();\r\n                                                    }\r\n                                                    animationCallback();\r\n                                                    return;\r\n                                                }\r\n                                            }\r\n                                        };\r\n\r\n                                        checkPickBPProcess = setInterval(checkPickBottomPoint, 50);\r\n                                    }\r\n\r\n                                } else {\r\n                                    applyEnd();\r\n                                }\r\n\r\n                                self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n\r\n                                self.events.on(TC.Consts.event.TERRAINLOADED, function () {\r\n\r\n                                    const addHeight = function (position) {\r\n                                        var cartographic = cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n                                        var height = self.viewer.scene.globe.getHeight(cartographic) || 0;\r\n                                        var finalCartographic = {\r\n                                            longitude: cartographic.longitude,\r\n                                            latitude: cartographic.latitude,\r\n                                            height: cartographic.height + height\r\n                                        };\r\n\r\n                                        return cesium.Ellipsoid.WGS84.cartographicToCartesian(finalCartographic);\r\n                                    };\r\n\r\n                                    var markers = self.viewer.entities.values.filter(function (entity) {\r\n                                        return entity.billboard;\r\n                                    });\r\n\r\n                                    if (markers.length > 0) {\r\n                                        markers.forEach(function (marker) {\r\n                                            marker.position = addHeight(cesium.Property.getValueOrUndefined(marker.position, cesium.JulianDate.now));\r\n                                        });\r\n                                    }\r\n\r\n                                    if (self.viewer.billboardCollection) {\r\n\r\n                                        for (var i = 0; i < self.viewer.billboardCollection.length; i++) {\r\n                                            self.viewer.billboardCollection.get(i).position = addHeight(self.viewer.billboardCollection.get(i).position);\r\n                                        }\r\n\r\n                                        self.viewer.scene.requestRender();\r\n                                    }\r\n\r\n                                });\r\n                            }.bind(self))\r\n                                .catch(() => { console.log('3051'); applyEnd(); });\r\n                        })\r\n                        .catch(() => { console.log('3053'); applyEnd(); });\r\n                })\r\n                .catch(() => { console.log('3055'); applyEnd(); });\r\n        } catch (error) {\r\n            applyEnd();\r\n\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    viewProto.unapply = function (options) {\r\n        const self = this;\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        self.map.on3DView = false;\r\n\r\n        //self.map.view3D = null;\r\n        if (self.viewer && self.viewer.trackedEntity) {\r\n            self.view3D.linked2DControls.geolocation.wrap.simulateTrackEnd();\r\n        }\r\n\r\n        self.view3D.cameraControls.resetRotation({ duration: 1000 })\r\n            .then(function () {\r\n\r\n                var animationCallback = function () {\r\n\r\n                    self.map.div.classList.remove(TC.Consts.classes.THREED);\r\n\r\n                    /* atribuciones del terreno */\r\n                    self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: self.viewer.scene.terrainProvider });\r\n\r\n                    if (self.viewer.scene.terrainProvider.fallbackProvider) {\r\n                        self.viewer.scene.terrainProvider.fallbackProvider.forEach(function (provider) {\r\n                            self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: provider });\r\n                        });\r\n                    }\r\n\r\n                    self.view3D.setViewFromCameraView.call(self).then(function () {\r\n                        self.divThreedMap.classList.remove(self.classes.MAP3D, self.CLASS + '-div-fadeIn');\r\n                        self.divThreedMap.classList.add(self.CLASS + '-div-fadeOut');\r\n                        self.mapView.viewHTML.classList.remove(self.CLASS + '-div-fadeOut');\r\n                        self.mapView.viewHTML.classList.add(self.CLASS + '-div-fadeIn');\r\n\r\n                        self.view3D.destroy.call(self);\r\n\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n\r\n                        if (options.callback) {\r\n                            options.callback();\r\n                        }\r\n                    });\r\n\r\n                    self.mapView.setRotation(0);\r\n                    if (self._ovMap) {\r\n                        self._ovMap.wrap.draw3DCamera(null);\r\n                    }\r\n                };\r\n\r\n                var bottom = pickBottomPoint(self.viewer.scene);\r\n                var transform = cesium.Matrix4.fromTranslation(bottom);\r\n                var angle = computeAngleToZenith(self.viewer.scene, bottom);\r\n\r\n                self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, transform, {\r\n                    duration: 1500,\r\n                    callback: animationCallback\r\n                });\r\n            })\r\n            .catch(function (e) {\r\n                throw (e);\r\n            });\r\n    };\r\n\r\n    viewProto.view3D = (function () {\r\n        const rasterConverter = new RasterConverter(/(EPSG\\:?4326)/i);\r\n        const featureConverter = new FeatureConverter();\r\n\r\n        const overrideDesktopZoom = function () {\r\n            var self = this;\r\n\r\n            if (!TC.Util.detectMobile()) {\r\n                self.viewer.scene.screenSpaceCameraController.enableZoom = false;\r\n\r\n                var element = self.viewer.scene.canvas;\r\n                // detect available wheel event\r\n                var wheelEvent;\r\n                if ('onwheel' in element) {\r\n                    // spec event type\r\n                    wheelEvent = 'wheel';\r\n                } else if (document.onmousewheel !== undefined) {\r\n                    // legacy event type\r\n                    wheelEvent = 'mousewheel';\r\n                } else {\r\n                    // older Firefox\r\n                    wheelEvent = 'DOMMouseScroll';\r\n                }\r\n                element.addEventListener(wheelEvent, function (event) {\r\n                    var delta;\r\n                    // standard wheel event uses deltaY.  sign is opposite wheelDelta.\r\n                    // deltaMode indicates what unit it is in.\r\n                    if (event.deltaY) {\r\n                        var deltaMode = event.deltaMode;\r\n                        if (deltaMode === event.DOM_DELTA_PIXEL) {\r\n                            delta = - event.deltaY;\r\n                        } else if (deltaMode === event.DOM_DELTA_LINE) {\r\n                            delta = - event.deltaY * 40;\r\n                        } else {\r\n                            // DOM_DELTA_PAGE\r\n                            delta = - event.deltaY * 120;\r\n                        }\r\n                    } else if (event.detail > 0) {\r\n                        // old Firefox versions use event.detail to count the number of clicks. The sign\r\n                        // of the integer is the direction the wheel is scrolled.\r\n                        delta = event.detail * -120;\r\n                    } else {\r\n                        delta = event.wheelDelta;\r\n                    }\r\n\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, delta);\r\n\r\n                }, false);\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfMouse = new cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    self.view3D._lastMousePosition = event;\r\n                }, cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (wheelZoomAmount) {\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, wheelZoomAmount);\r\n                }, cesium.ScreenSpaceEventType.WHEEL);\r\n                var pinchCenterPosition = new cesium.Cartesian2();\r\n                var pinchAmount = 0;\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    cesium.Cartesian2.lerp(event.position1, event.position2, 0.5, pinchCenterPosition);\r\n                }, cesium.ScreenSpaceEventType.PINCH_START);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    var diff = event.distance.endPosition.y - event.distance.startPosition.y;\r\n                    var rangeWindowRatio = diff / self.viewer.scene.canvas.clientHeight;\r\n                    rangeWindowRatio = Math.min(rangeWindowRatio, self.viewer.scene.screenSpaceCameraController.maximumMovementRatio);\r\n                    pinchAmount = rangeWindowRatio;\r\n                }, cesium.ScreenSpaceEventType.PINCH_MOVE);\r\n                self.eventHandlers.handlerOfMouse.setInputAction(function (event) {\r\n                    self.view3D.zoomToCartesian.call(self, { endPosition: pinchCenterPosition }, pinchAmount);\r\n                }, cesium.ScreenSpaceEventType.PINCH_END);\r\n            }\r\n        };\r\n\r\n        const addFeature = function (csFeature) {\r\n            var addedFeature = csFeature;\r\n            switch (true) {\r\n                case csFeature instanceof cesium.GroundPrimitive: {\r\n                    this.viewer.scene.groundPrimitives.add(csFeature);\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object && csFeature.hasOwnProperty('billboard'): {\r\n                    if (!this.viewer.billboardCollection) {\r\n                        this.viewer.billboardCollection = this.viewer.scene.primitives.add(new cesium.BillboardCollection({\r\n                            scene: this.viewer.scene\r\n                        }));\r\n                    }\r\n\r\n                    var billboardAtCollection = this.viewer.billboardCollection.add({\r\n                        position: csFeature.position,\r\n                        image: csFeature.billboard.image,\r\n                        verticalOrigin: csFeature.billboard.verticalOrigin,\r\n                        heightReference: csFeature.billboard.heightReference\r\n                    });\r\n\r\n                    addedFeature = billboardAtCollection;\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object: {\r\n                    addedFeature = this.viewer.entities.getById(csFeature.id);\r\n                    if (!addedFeature) {\r\n                        addedFeature = this.viewer.entities.add(csFeature);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n\r\n            this.viewer.scene.requestRender();\r\n\r\n            return addedFeature;\r\n        };\r\n        const linkFeature = function (map, idLayer, feature, id) {\r\n            if (!map.vector2DFeatures.hasOwnProperty(idLayer)) {\r\n                map.vector2DFeatures[idLayer] = {};\r\n                map.vector2DFeatures[idLayer][id] = [feature];\r\n            } else {\r\n                if (!map.vector2DFeatures[idLayer].hasOwnProperty(id)) {\r\n                    map.vector2DFeatures[idLayer][id] = [feature];\r\n                } else {\r\n                    map.vector2DFeatures[idLayer][id].push(feature);\r\n                }\r\n            }\r\n        };\r\n\r\n        const listenTo = [\r\n            TC.Consts.event.BEFOREBASELAYERCHANGE, TC.Consts.event.BASELAYERCHANGE,\r\n            TC.Consts.event.LAYERADD, TC.Consts.event.LAYERREMOVE, TC.Consts.event.LAYERVISIBILITY, TC.Consts.event.LAYEROPACITY, TC.Consts.event.LAYERORDER,\r\n            TC.Consts.event.FEATUREADD, TC.Consts.event.FEATUREREMOVE, TC.Consts.event.FEATURESCLEAR\r\n            /*, TC.Consts.event.ZOOM no encuentro en qué casos debemos escuchar el evento ZOOM de 2D, solo trae problemas */, TC.Consts.event.ZOOMTO];\r\n\r\n        const event2DHandler = function (e) {\r\n            var self = this;\r\n\r\n            switch (true) {\r\n                case e.type == TC.Consts.event.BEFOREBASELAYERCHANGE:\r\n                    if (!self.waiting)\r\n                        self.waiting = self.map.getLoadingIndicator().addWait();\r\n                    break;\r\n                case e.type == TC.Consts.event.BASELAYERCHANGE: {\r\n                    self.view3D.setBaseLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERADD: {\r\n                    self.view3D.addLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERREMOVE: {\r\n                    self.view3D.removeLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERVISIBILITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { visibility: e.layer.getVisibility() });\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYEROPACITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { opacity: e.layer.getOpacity() });\r\n                    self.viewer.scene.requestRender();\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERORDER: {\r\n                    for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                        if (self.view3D.workLayers[i].imageryProvider && self.view3D.workLayers[i].imageryProvider.layers.join(',') === e.layer.names.join(',')) {\r\n\r\n                            if (e.oldIndex > e.newIndex) {\r\n                                var positions = e.oldIndex - e.newIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.lower(self.view3D.workLayers[i]);\r\n                                }\r\n\r\n                            } else {\r\n                                var positions = e.newIndex - e.oldIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.raise(self.view3D.workLayers[i]);\r\n                                }\r\n                            }\r\n\r\n                            self.view3D.workLayers.splice(e.newIndex, 0, self.view3D.workLayers.splice(e.oldIndex, 1)[0]);\r\n                            break;\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREADD: {\r\n                    self.view3D.addFeature.call(self.view3D, e.feature);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREREMOVE: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        const remove = function (feature) {\r\n                            if (self.view3D.vector2DFeatures[e.layer.id].hasOwnProperty(feature.id)) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n\r\n                                delete self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                            }\r\n                        };\r\n\r\n                        if (e.feature instanceof Array) {\r\n                            e.feature.forEach(remove);\r\n                        } else {\r\n                            remove(e.feature);\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATURESCLEAR: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        for (var featureId in self.view3D.vector2DFeatures[e.layer.id]) {\r\n                            var threedFeature = self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n\r\n                            for (var i = 0; i < threedFeature.length; i++) {\r\n                                self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOM: {\r\n                    if (self.view3D.cameraControls && !self.view3D.cameraControls.moving) {\r\n\r\n                        var width = self.view3D.viewer.scene.canvas.clientWidth;\r\n                        var height = self.view3D.viewer.scene.canvas.clientHeight;\r\n\r\n\r\n                        /* Si hemos llegado aquí y hay un cambio en el tamaño del canvas, \r\n                           viene el evento del resize canvas del mapa de 2D así que paso y no hago nada */\r\n                        if (!self.view3D._canvasClientHeight ||\r\n                            !self.view3D._canvasClientWidth ||\r\n\r\n                            width !== self.view3D._canvasClientWidth ||\r\n                            height !== self.view3D._canvasClientHeight) {\r\n\r\n                            if (!self.view3D._canvasClientWidth) {\r\n                                self.view3D._canvasClientWidth = self.view3D.viewer.scene.canvas.clientWidth;\r\n                            }\r\n\r\n                            if (!self.view3D._canvasClientHeight) {\r\n                                self.view3D._canvasClientHeight = self.view3D.viewer.scene.canvas.clientHeight;\r\n                            }\r\n\r\n                            self.view3D._canvasClientWidth = width;\r\n                            self.view3D._canvasClientHeight = height;\r\n\r\n                            return;\r\n                        }\r\n\r\n                        self.view3D.flyToMapCoordinates.call(self, self.mapView.getCenter());\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOMTO: {\r\n\r\n                    if (self.lastZoom && performance.now() - self.lastZoom < 50) {\r\n                        return;\r\n                    }\r\n                    self.lastZoom = performance.now();\r\n\r\n                    let rectangle = cesium.Rectangle.fromDegrees(...e.extent);\r\n                    self.view3D.flyToRectangle.call(self, rectangle);\r\n                    break;\r\n                }\r\n            }\r\n        };\r\n\r\n        /* geolocation */\r\n        const geolocation_newPosition = function () {\r\n            var self = this;\r\n\r\n            if (!self.map.on3DView) {\r\n                return;\r\n            }\r\n\r\n            if (!self.view3D.trackingEntity) {\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n                var track = geolocation2D.layerTracking.features.filter(function (feature) {\r\n                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                });\r\n\r\n                if (track && track.length > 0) {\r\n\r\n                    var positions = [];\r\n                    const positionCallback = new cesium.CallbackProperty(function (time, result) {\r\n                        if (track[0].geometry.length > positions.length) {\r\n                            var newCartographicPositions = track[0].geometry.slice(positions.length).map(function (coordinate) {\r\n                                var reprojected = coordinate;\r\n\r\n                                if (this.view3D.view2DCRS !== this.view3D.crs) {\r\n                                    reprojected = TC.Util.reproject(coordinate, this.view3D.view2DCRS, this.view3D.crs);\r\n                                }\r\n\r\n                                return cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1], coordinate[2]);\r\n                            }.bind(this));\r\n\r\n                            var updatedPositions = [];\r\n                            if (newCartographicPositions instanceof Array) {\r\n                                updatedPositions = cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(newCartographicPositions);\r\n                            } else {\r\n                                updatedPositions = [cesium.Ellipsoid.WGS84.cartographicToCartesian(newCartographicPositions)];\r\n                            }\r\n\r\n                            positions = positions.concat(updatedPositions);\r\n                            return positions;\r\n                        }\r\n\r\n                        return positions;\r\n\r\n                    }.bind(this), false);\r\n\r\n                    var entityTracking = new cesium.Entity({\r\n                        id: \"trackingEntity\",\r\n                        polyline: {\r\n                            positions: positionCallback,\r\n                            clampToGround: true,\r\n                            width: 3,\r\n                            material: new cesium.PolylineDashMaterialProperty({\r\n                                color: new cesium.CallbackProperty(function (time, result) {\r\n                                    self.viewer.scene.requestRender();\r\n                                    return cesium.Color.fromAlpha(new cesium.Color(0, 255, 209), geolocation2D.track.renderTrack.checked ? 1 : 0);\r\n                                }.bind(this), false),\r\n                                gapColor: cesium.Color.TRANSPARENT\r\n                            })\r\n                        }\r\n                    });\r\n\r\n                    self.view3D.trackingEntity = self.viewer.entities.add(entityTracking);\r\n                    self.viewer.scene.requestRender();\r\n                }\r\n            }\r\n        };\r\n        const geolocation_videoControls = function (event) {\r\n            var self = this;\r\n\r\n            var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n            switch (true) {\r\n                case geolocation2D.Const.Event.IMPORTEDTRACK.indexOf(event.type) > -1:\r\n                case event.target.className.indexOf('draw') > -1 && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK):\r\n                case !(event.target.parentElement && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK)):\r\n                case event.target.className.indexOf('stop') > -1:\r\n\r\n                    if (self.map.on3DView) {\r\n                        self.viewer.clock.shouldAnimate = false;\r\n                        self.viewer.clock.currentTime = cesium.JulianDate.fromDate(new Date());\r\n                    }\r\n\r\n                    if (self.view3D.trackDataSource) {\r\n                        if (self.view3D.trackDataSource.length > 0) {\r\n                            var entity = self.view3D.trackDataSource.get(0).entities.values[0];\r\n                            self.viewer.entities.removeById(entity.id);\r\n                        }\r\n\r\n                        self.view3D.trackDataSource.destroy();\r\n                        delete self.view3D.trackDataSource;\r\n                    }\r\n\r\n                    geolocation2D.chartProgressClear();\r\n\r\n                    if (event.custom) {\r\n                        const selectedTrack = geolocation2D.getSelectedTrack();\r\n                        if (selectedTrack) {\r\n                            selectedTrack.querySelector(geolocation2D.Const.Selector.STOP).click();\r\n                        }\r\n                    }\r\n                    break;\r\n                case event.target.className.indexOf('play') > -1:\r\n                    self.viewer.clock.shouldAnimate = false;\r\n                    break;\r\n                case event.target.className.indexOf('pause') > -1:\r\n                    self.viewer.clock.shouldAnimate = true;\r\n                    break;\r\n                case event.target.className.indexOf('back') > -1:\r\n                case event.target.className.indexOf('for') > -1:\r\n                    self.viewer.clock.multiplier = geolocation2D.simulate_speed;\r\n                    break;\r\n            }\r\n        };\r\n        /* fin geolocation */\r\n\r\n        const alterAllowedControls = function (view) {\r\n            var self = this;\r\n            const ctrlsToMngCLASS = self.ctrlsToMng.map(function (ctrl) { return ctrl.CLASS });\r\n\r\n            self.map.controls.forEach(function (mapCtrl) {\r\n                if (ctrlsToMngCLASS.indexOf(mapCtrl.CLASS) < 0) {\r\n                    switch (true) {\r\n                        case (TC.Consts.view.DEFAULT == view):\r\n                            mapCtrl.enable();\r\n                            break;\r\n                        case (TC.Consts.view.THREED == view):\r\n                            mapCtrl.disable();\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n            switch (true) {\r\n                case (TC.Consts.view.DEFAULT == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.remove(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.remove(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n                case (TC.Consts.view.THREED == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.add(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.add(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            const onLeftClickOnCanvas = (movement) => {\r\n\r\n                // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                if (self.viewer.trackedEntity) {\r\n                    return;\r\n                }\r\n\r\n                const getFeatureInfo = function () {\r\n                    var ray = self.viewer.camera.getPickRay(movement.position);\r\n                    var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                    if (position) {\r\n                        self.view3D.getInfoOnPickedPosition.call(self, position);\r\n                    }\r\n                };\r\n\r\n                var pickedFeature = self.viewer.scene.pick(movement.position);\r\n                if (pickedFeature && pickedFeature.id) {\r\n                    var id = pickedFeature.id instanceof cesium.Entity ? pickedFeature.id.name : pickedFeature.id;\r\n\r\n                    var founded = false;\r\n                    for (var layerId in self.view3D.vector2DFeatures) {\r\n                        if (self.view3D.vector2DFeatures[layerId].hasOwnProperty(id)) {\r\n                            var feature2D = self.map.workLayers.filter(function (workLayer) {\r\n                                return workLayer.id === layerId;\r\n                            })[0].features.filter(function (feature) {\r\n                                return id.indexOf(feature.id) > -1 && feature.showsPopup;\r\n                            });\r\n\r\n                            if (feature2D && feature2D.length > 0) {\r\n                                founded = true;\r\n\r\n                                if (feature2D.CLASSNAME !== \"TC.feature.Point\" && feature2D.CLASSNAME !== \"TC.feature.Marker\") {\r\n\r\n                                    var ray = self.viewer.camera.getPickRay(movement.position);\r\n                                    var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n\r\n                                    var marker = self.map.view3D.addNativeFeature.call(self.map, {\r\n                                        position: position,\r\n                                        billboard: {\r\n                                            image: TC.Util.getBackgroundUrlFromCss(self.CLASS + '-marker'),\r\n                                            eyeOffset: new cesium.Cartesian3(0, 0, -100),\r\n                                            verticalOrigin: cesium.VerticalOrigin.BOTTOM,\r\n                                            heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                                        }\r\n                                    });\r\n\r\n                                    const onDrawTable = function (e) {\r\n                                        if (e.control) {\r\n                                            const control = e.control;\r\n                                            const onTableClose = function (e) {\r\n                                                if (e.control === control) {\r\n                                                    self.map.off(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                    self.map.view3D.removeFeature.call(self, marker);\r\n                                                }\r\n                                            };\r\n                                            self.map.on(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                            self.map.off(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                        }\r\n                                    }\r\n                                    self.map.on(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                }\r\n\r\n                                self.map.trigger(TC.Consts.event.FEATURECLICK, { feature: feature2D[0] });\r\n\r\n                                break;\r\n                            }\r\n\r\n                        }\r\n                    }\r\n\r\n                    if (!founded) {\r\n                        getFeatureInfo();\r\n                    }\r\n                } else {\r\n                    getFeatureInfo();\r\n                }\r\n            };\r\n            const onMouseMoveOnCanvas = (movement) => {\r\n                // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                if (self.viewer.trackedEntity) {\r\n                    return;\r\n                }\r\n                var pickedFeature = self.viewer.scene.pick(movement.endPosition);\r\n                if (pickedFeature && pickedFeature.id) {\r\n                    self.viewer.canvas.style.cursor = 'pointer';\r\n                } else {\r\n                    self.viewer.canvas.style.cursor = 'default';\r\n                }\r\n            };\r\n\r\n            if (TC.Consts.view.THREED === view) {\r\n\r\n                if (!self.view3D.linked2DControls.featureInfo &&\r\n                    Object.keys(self.map.options.controls).indexOf(\"featureInfo\") > -1 &&\r\n                    self.allowedControls.indexOf(\"featureInfo\") > -1) {\r\n                    self.view3D.linked2DControls.featureInfo = new TwoDLinkedFeatureInfo(self);\r\n                }\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfFeatures = new cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfFeatures.setInputAction(onLeftClickOnCanvas, cesium.ScreenSpaceEventType.LEFT_CLICK);\r\n                self.eventHandlers.handlerOfFeatures.setInputAction(onMouseMoveOnCanvas, cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n\r\n            } else if (TC.Consts.view.DEFAULT === view) {\r\n                if (self.eventHandlers.handlerOfFeatures) {\r\n                    self.eventHandlers.handlerOfFeatures.destroy();\r\n                }\r\n            }\r\n\r\n            if (!self.view3D.linked2DControls.geolocation &&\r\n                Object.keys(self.map.options.controls).indexOf(\"geolocation\") > -1 &&\r\n                self.allowedControls.indexOf(\"geolocation\") > -1) {\r\n                self.view3D.linked2DControls.geolocation = self.ctrlsToMng.filter(function (ctrl) {\r\n                    return ctrl instanceof TC.control.Geolocation;\r\n                })[0];\r\n            }\r\n\r\n            if (self.view3D.linked2DControls.geolocation) {\r\n\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n\r\n                if (TC.Consts.view.THREED === view) {\r\n\r\n                    var commands = [geolocation2D.Const.Selector.STOP,\r\n                    geolocation2D.Const.Selector.PAUSE,\r\n                    geolocation2D.Const.Selector.BACKWARD,\r\n                    geolocation2D.Const.Selector.FORWARD,\r\n                    geolocation2D.Const.Selector.DRAW];\r\n                    var geolocation_videoControls_ = geolocation_videoControls.bind(self);\r\n                    self.view3D.linked2DControls.geolocation.videoControls = geolocation_videoControls_;\r\n\r\n                    var lstEventListener = function (e) {\r\n                        var classes = commands;\r\n                        if (commands.some(function (cls) {\r\n                            return e.target.classList.contains(cls.replace('.', ''))\r\n                        })) {\r\n                            geolocation_videoControls_(e);\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D.reset = function () {\r\n\r\n                        TC.wrap.control.Geolocation.prototype.setTracking = geolocation2D._setTracking;\r\n                        TC.wrap.control.Geolocation.prototype.simulateTrack = geolocation2D._wrap_simulateTrack;\r\n\r\n                        geolocation2D.simulateTrack = geolocation2D._simulateTrack;\r\n                        geolocation2D.elevationTrack = geolocation2D._elevationTrack;\r\n\r\n                        commands.forEach(function (command) {\r\n                            document.removeEventListener('click', lstEventListener);\r\n                        });\r\n\r\n                        geolocation2D.off(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    };\r\n\r\n                    document.addEventListener('click', lstEventListener);\r\n\r\n                    geolocation2D.on(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n\r\n                    var _newPosition = false;\r\n                    geolocation2D._setTracking = TC.wrap.control.Geolocation.prototype.setTracking;\r\n                    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n\r\n                        geolocation2D._setTracking.call(geolocation2D.wrap, tracking);\r\n\r\n                        if (tracking) {\r\n                            geolocation2D.on(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                        } else {\r\n                            _newPosition = false;\r\n                            geolocation2D.off(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                            if (self.view3D.trackingEntity) {\r\n                                self.viewer.entities.removeById(self.view3D.trackingEntity.id);\r\n                                delete self.view3D.trackingEntity;\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D._elevationTrack = geolocation2D.elevationTrack;\r\n                    geolocation2D.elevationTrack = function (li, resized) {\r\n\r\n                        if (resized) {\r\n                            geolocation_videoControls.call(self, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        return geolocation2D._elevationTrack.call(geolocation2D, li, resized);\r\n                    };\r\n\r\n                    // Si en el paso de 2D a 3D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = geolocation2D.getSelectedTrack();\r\n                    if (selectedTrack && geolocation2D.hasElevation) {\r\n                        geolocation2D.elevationTrack.call(self, selectedTrack, true);\r\n                    }\r\n\r\n                    var simulationOnPreUpdate; // listener de la simulación.\r\n                    geolocation2D._simulateTrack = geolocation2D.simulateTrack;\r\n                    geolocation2D.simulateTrack = function (li) {\r\n                        var self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        self.map.toast(self.getLocaleString('threed.interactionSimulation'), { type: TC.Consts.msgType.INFO });\r\n\r\n                        // tenemos una simulación activa\r\n                        if (this.viewer.clock.shouldAnimate && this.view3D.trackDataSource) {\r\n                            simulationOnPreUpdate();\r\n                            geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        self.simulate_speed = 1;\r\n                        self.drawTrack(li, false).then(function () {\r\n                            self.wrap.simulateTrack();\r\n\r\n                            if (self.layerTrack && self.layerTrack.features) {\r\n                                var track = self.layerTrack.features.filter(function (feature) {\r\n                                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                                })[0];\r\n\r\n                                if (track) {\r\n                                    toCZML.call(this, track.geometry, track.wrap.feature.getGeometry().layout, \"track\", self.markerStyle, self.lineStyle, self.walkingSpeed).then(function (result) {\r\n                                        var czml = result.czml, totalDistance = result.totalDistance, coordinates2D = result.coordinates2D;\r\n\r\n                                        this.view3D.trackDataSource = new cesium.DataSourceCollection();\r\n                                        var dataSourceDisplay = new cesium.DataSourceDisplay({\r\n                                            scene: this.viewer.scene,\r\n                                            dataSourceCollection: this.view3D.trackDataSource\r\n                                        });\r\n\r\n                                        this.viewer.scene.preRender.addEventListener(function (scene, time) {\r\n                                            dataSourceDisplay.update(time);\r\n                                        });\r\n\r\n                                        this.view3D.trackDataSource.add(cesium.CzmlDataSource.load(czml)).then(function (layout, coordinates2D, czmlDataSource) {\r\n\r\n                                            this.viewer.clock.shouldAnimate = false;\r\n\r\n                                            var start, stop;\r\n                                            start = czmlDataSource.clock.startTime;\r\n                                            stop = czmlDataSource.clock.stopTime;\r\n\r\n                                            this.viewer.clock.startTime = start.clone();\r\n                                            this.viewer.clock.stopTime = stop.clone();\r\n                                            this.viewer.clock.currentTime = start.clone();\r\n                                            this.viewer.clock.clockStep = cesium.ClockStep.TICK_DEPENDENT\r\n                                            this.viewer.clock.clockRange = cesium.ClockRange.CLAMPED;\r\n                                            this.viewer.clock.multiplier = 1;\r\n\r\n                                            var trackEntity = czmlDataSource.entities.values[0];\r\n\r\n                                            trackEntity.layout = layout;\r\n\r\n                                            trackEntity.tagLI = li; // tengo que guardar la relación con el HTML porque puede eliminar la selección del track mientras estamos creando la simulación del mismo, y no tengo forma de validarlo\r\n\r\n                                            trackEntity.availability = new cesium.TimeIntervalCollection([new cesium.TimeInterval({\r\n                                                start: start,\r\n                                                stop: stop\r\n                                            })]);\r\n\r\n                                            if (this.viewer.trackedEntity) {\r\n                                                this.viewer.entities.removeById(this.viewer.trackedEntity.id);\r\n                                                this.viewer.trackedEntity = null;\r\n                                            }\r\n\r\n                                            this.viewer.entities.add(trackEntity);\r\n\r\n                                            this.viewer.flyTo(trackEntity).then(function () {\r\n\r\n                                                this.viewer.trackedEntity = trackEntity;\r\n\r\n                                                function get2DHeightAtProgress(coordinates2D, distanceCurrent) {\r\n                                                    var coordinate;\r\n\r\n                                                    var doneDistance = 0;\r\n\r\n                                                    var reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[0], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[0];\r\n                                                    var previous = new cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                    for (var i = 1; i < coordinates2D.length; i++) {\r\n                                                        reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[i], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[i];\r\n                                                        var current = new cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                        doneDistance += new cesium.EllipsoidGeodesic(previous, current).surfaceDistance;\r\n                                                        previous = current;\r\n\r\n                                                        if (doneDistance > distanceCurrent) {\r\n                                                            coordinate = coordinates2D[i - 1];\r\n                                                            break;\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    if (coordinate) {\r\n                                                        var heightIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 2 :\r\n                                                            trackEntity.layout === ol.geom.GeometryLayout.XYZ ? 2 : -1;\r\n                                                        if (heightIndex > -1) {\r\n                                                            return coordinate[heightIndex];\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    return 0;\r\n                                                };\r\n\r\n                                                var previousPosition, distanceCurrent = 0;\r\n                                                simulationOnPreUpdate = this.viewer.scene.preUpdate.addEventListener(function (scene, currentTime) {\r\n\r\n                                                    // mientras estamos preparando la simulación ha eliminado la selección de dicho track \r\n                                                    const selectedTrack = this.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                                                    if (!selectedTrack || selectedTrack.getAttribute('data-id') !== trackEntity.tagLI.getAttribute('data-id') ||\r\n                                                        // o hemos llegado al final\r\n                                                        cesium.JulianDate.greaterThanOrEquals(currentTime, trackEntity.availability.stop)) {\r\n\r\n                                                        simulationOnPreUpdate();\r\n                                                        geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n\r\n                                                    } else if (this.viewer.clock.shouldAnimate && trackEntity.isAvailable(currentTime)) {\r\n\r\n                                                        // gestionamos las posiciones anterior y actual\r\n                                                        if (!previousPosition) {\r\n                                                            previousPosition = cesium.Cartographic.fromCartesian(cesium.Property.getValueOrUndefined(trackEntity.position, trackEntity.availability.start));\r\n                                                        }\r\n                                                        currentPosition = cesium.Cartographic.fromCartesian(cesium.Property.getValueOrUndefined(trackEntity.position, currentTime));\r\n\r\n                                                        // progreso en el perfil (si lo hay)\r\n                                                        if (this.view3D.linked2DControls.geolocation.hasElevation) {\r\n                                                            var timeIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 3 :\r\n                                                                trackEntity.layout === ol.geom.GeometryLayout.XYM ? 2 : 3;\r\n\r\n                                                            this.view3D.linked2DControls.geolocation.chartSetProgress({\r\n                                                                p: [previousPosition.longitude, previousPosition.latitude, previousPosition.height],\r\n                                                                d: distanceCurrent\r\n                                                            },\r\n                                                                [currentPosition.longitude, currentPosition.latitude, get2DHeightAtProgress.call(this, coordinates2D, distanceCurrent)],\r\n                                                                totalDistance, (trackEntity.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                                    trackEntity.layout === ol.geom.GeometryLayout.XYM ?\r\n                                                                    this.view3D.linked2DControls.geolocation._getTime(cesium.JulianDate.toDate(trackEntity.availability.start), cesium.JulianDate.toDate(currentTime)) : false));\r\n                                                        }\r\n\r\n                                                        // gestionamos las posiciones anterior y actual y la distancia\r\n                                                        distanceCurrent += new cesium.EllipsoidGeodesic(previousPosition, currentPosition).surfaceDistance;\r\n                                                        previousPosition = currentPosition;\r\n\r\n                                                        this.viewer.scene.requestRender();\r\n                                                    }\r\n                                                }.bind(this));\r\n\r\n                                                this.viewer.clock.shouldAnimate = true;\r\n\r\n                                            }.bind(this));\r\n\r\n                                            //self.view3D.customRender.restart();\r\n                                            this.viewer.scene.requestRender();\r\n\r\n                                        }.bind(this, track.wrap.feature.getGeometry().layout, coordinates2D));\r\n                                    }.bind(this));\r\n                                }\r\n                            }\r\n                        }.bind(this));\r\n\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_simulateTrack = TC.wrap.control.Geolocation.prototype.simulateTrack;\r\n                    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n                        var self = this;\r\n                    };\r\n                } else {\r\n                    // Si en el paso de 3D a 2D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = self.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                    if (selectedTrack && self.view3D.linked2DControls.geolocation.hasElevation) {\r\n\r\n                        geolocation2D._elevationTrack.call(self.view3D.linked2DControls.geolocation, selectedTrack, true);\r\n                    }\r\n                }\r\n            }\r\n\r\n        };\r\n\r\n        const draw2DDrawedFeatures = function () {\r\n            var self = this;\r\n            self.map.workLayers.filter(function (layer) {\r\n                return layer instanceof TC.layer.Vector;\r\n            }).forEach(function (vectorLayer) {\r\n                vectorLayer.features.forEach(function (feature) {\r\n                    self.view3D.addFeature.call(self.view3D, feature);\r\n                });\r\n            });\r\n        };\r\n\r\n        var initialExtent, zoomin, zoomout;\r\n        const override2DZoom = function (activate) {\r\n            var self = this;\r\n\r\n            var amount = 200.0;\r\n\r\n            var zoom = function (amount) {\r\n                var self = this;\r\n\r\n                var center = new cesium.Cartesian2(\r\n                    self.viewer.scene.canvas.clientWidth / 2,\r\n                    self.viewer.scene.canvas.clientHeight / 2);\r\n\r\n                /*\r\n                var x = center.x;\r\n                var y = center.y;\r\n                var event = new window.WheelEvent (\"wheel\", {deltaY: -100,\r\n                    deltaMode: 0,\r\n                    DOM_DELTA_PIXEL: 0,\r\n                    DOM_DELTA_LINE: 1,\r\n                    detail: 0,\r\n                    wheelDelta: 120,\r\n                    layerX: x, layerY: y,\r\n                    clientX: x, clientY: y,\r\n                    offsetX: x, offsetY: y,\r\n                    pageX: x, pageY: y,\r\n                    screenX: x, screenY: y\r\n                });\r\n                self.viewer.scene.canvas.dispatchEvent(event);*/\r\n\r\n                self.view3D.zoomToCartesian.call(self, { endPosition: center }, amount);\r\n            };\r\n\r\n            if (activate) {\r\n                initialExtent = function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var sourceCRS = self.view3D.view2DCRS;\r\n                    if (self.map.options.crs !== self.view3D.view2DCRS) {\r\n                        sourceCRS = self.map.options.crs;\r\n                    }\r\n\r\n                    var coordsXY = TC.Util.reproject(self.map.options.initialExtent.slice(0, 2), sourceCRS, self.view3D.crs);\r\n                    var coordsXY2 = TC.Util.reproject(self.map.options.initialExtent.slice(2), sourceCRS, self.view3D.crs);\r\n                    var rectangle = cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle, { duration: 0.1 });\r\n\r\n                    return false;\r\n\r\n                }.bind(self);\r\n\r\n                zoomin = function (e) {\r\n                    zoom.call(self, amount);\r\n                }.bind(self);\r\n\r\n                zoomout = function (e) {\r\n                    zoom.call(self, -amount);\r\n                }.bind(self);\r\n\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.addEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.addEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.addEventListener('click', zoomout);\r\n                });\r\n            }\r\n            else {\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.removeEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomout);\r\n                });\r\n            }\r\n        };\r\n\r\n        const fromTCtoCesiumEvent = function (eventTC) {\r\n            if (TC.Consts.event.MOUSEMOVE === eventTC) {\r\n                return TC.Util.detectMobile() ? cesium.ScreenSpaceEventType.LEFT_CLICK : cesium.ScreenSpaceEventType.MOUSE_MOVE;\r\n            } else if (TC.Consts.event.CLICK === eventTC) {\r\n                return cesium.ScreenSpaceEventType.LEFT_CLICK;\r\n            }\r\n\r\n            return eventTC;\r\n        };\r\n\r\n        return {\r\n\r\n            container: null,\r\n\r\n            crs: 'EPSG:4326',\r\n            crsPattern: /(EPSG\\:?4326)/i,\r\n\r\n            view2DCRS: null,\r\n\r\n            customRender: null,\r\n\r\n            baseLayer: null,\r\n\r\n            workLayers: [],\r\n            vector2DLayers: [],\r\n            vector2DFeatures: {},\r\n\r\n            linked2DControls: {},\r\n\r\n            isLoadingTiles: function () {\r\n                var self = this;\r\n\r\n                var surface = self.viewer.scene.globe['_surface'];\r\n                return !surface['_tileProvider'].ready ||\r\n                    surface['_tileLoadQueueHigh'].length > 0 ||\r\n                    surface['_tileLoadQueueMedium'].length > 0 ||\r\n                    surface['_tileLoadQueueLow'].length > 0 ||\r\n                    surface['_debug']['tilesWaitingForChildren'] > 0;\r\n            },\r\n\r\n            loadViewer: function () {\r\n                const self = this;\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.viewer) {\r\n                        TC.loadJSInOrder(\r\n                            !window[TC.Consts.CESIUMNS],\r\n                            [\r\n                                TC.apiLocation + TC.Consts.url.CESIUM,\r\n                                TC.apiLocation + TC.Consts.url.CESIUM_CONNECTOR\r\n                            ],\r\n                            function () {\r\n                                var resourceBoundaries = cesium.Resource.fetchJson({ url: TC.apiLocation + \"/dataSource/contornoNavarra.json\" }).then(function (bounds) {\r\n                                    if (bounds && bounds.features && bounds.features.length > 0) {\r\n                                        return bounds.features[0].geometry.coordinates[0];\r\n                                    } else {\r\n                                        return [];\r\n                                    }\r\n                                });\r\n\r\n                                cesium.when.all([cesium.ApproximateTerrainHeights.initialize(), resourceBoundaries], function () {\r\n\r\n                                    var boundaries = Array.prototype.slice.call(arguments[0])[1];\r\n\r\n                                    var terrainFallback;\r\n                                    if (self.terrainFallback) {\r\n                                        terrainFallback = {\r\n                                            url: self.terrainFallback.url.trim(),\r\n                                            layerName: self.terrainFallback.layerName,\r\n                                            format: self.terrainFallback.format,\r\n                                            noDataValue: self.terrainFallback.noDataValue\r\n                                        };\r\n                                    }\r\n\r\n                                    var terrainProvider;\r\n                                    if (terrainFallback) {\r\n                                        terrainProvider = new cesium.MergeTerrainProvider(self.terrain, self, {\r\n                                            boundaries: boundaries,\r\n                                            fallback: [terrainFallback]\r\n                                        });\r\n                                    } else {\r\n                                        terrainProvider = new cesium.CesiumTerrainProvider({\r\n                                            url: self.terrain.url.trim()\r\n                                        });\r\n\r\n                                        terrainProvider.sampleTerrainMostDetailed = function (positions) {\r\n                                            return cesium.sampleTerrainMostDetailed(terrainProvider, positions);\r\n                                        };\r\n\r\n                                        terrainProvider.attributions = {\r\n                                        };\r\n\r\n                                        if (self.terrain.attributions) {\r\n\r\n                                            terrainProvider.getAttribution = function () {\r\n                                                return terrainProvider.attributions;\r\n                                            };\r\n\r\n                                            terrainProvider.attributions = self.terrain.attributions;\r\n                                            self.map.trigger(TC.Consts.event.TERRAINPROVIDERADD, { terrainProvider: terrainProvider });\r\n                                        }\r\n                                    }\r\n\r\n                                    var globe = new cesium.Globe();\r\n                                    globe.baseColor = cesium.Color.WHITE;\r\n                                    globe.enableLighting = false;\r\n\r\n                                    /* carga más rápido pero consume RAM a cascoporro */\r\n                                    globe.tileCacheSize = 1000;\r\n\r\n                                    /* por defecto 2, a mayor número mayor rendimiento y peor calidad visual */\r\n                                    globe.maximumScreenSpaceError = 5;\r\n\r\n                                    self.viewer = self.view3D.viewer = new cesium.Viewer(self.selectors.divThreedMap, {\r\n                                        terrainProvider: terrainProvider,\r\n                                        terrainExaggeration: 1.0,\r\n\r\n                                        animation: false,\r\n                                        timeline: false,\r\n                                        fullscreenButton: false,\r\n                                        baseLayerPicker: false,\r\n                                        imageryProvider: false,\r\n                                        navigationInstructionsInitiallyVisible: false,\r\n                                        navigationHelpButton: false,\r\n                                        geocoder: false,\r\n                                        homeButton: false,\r\n                                        infoBox: false,\r\n                                        sceneModePicker: false,\r\n                                        selectionIndicator: false,\r\n                                        globe: globe,\r\n\r\n                                        //skyBox: false,\r\n                                        //skyAtmosphere: false,\r\n\r\n                                        requestRenderMode: true,\r\n                                        maximumRenderTimeChange: Infinity\r\n                                    });\r\n\r\n                                    // personalización de la escena\r\n                                    self.viewer.scene.backgroundColor = cesium.Color.WHITE;\r\n                                    self.viewer.scene.screenSpaceCameraController.enableCollisionDetection = true;\r\n                                    self.viewer.scene.screenSpaceCameraController.maximumZoomDistance = 1000000;\r\n\r\n                                    //// con false las líneas se manetienen sobre el terreno\r\n                                    //self.viewer.scene.globe.depthTestAgainstTerrain = false;\r\n\r\n                                    // borramos cualquier capa que haya\r\n                                    self.viewer.scene.imageryLayers.removeAll();\r\n\r\n                                    // registramos listeners para capturar errores del terreno y del render\r\n                                    self.viewer.terrainProvider.errorEvent.addEventListener(function (e) {\r\n                                        var self = this;\r\n                                        if (e.error) {\r\n                                            switch (e.error.statusCode) {\r\n                                                case 403:\r\n                                                case 404:\r\n                                                    console.log('es un 404 de terreno');\r\n                                                    break;\r\n                                            }\r\n                                        }\r\n                                    }, self);\r\n                                    self.viewer.scene.renderError.addEventListener(function (target, error) {\r\n                                        var self = this;\r\n\r\n                                        if (error && error.code === 18) { // GLS: 18 - SECURITY_ERR                              \r\n\r\n                                        } else {\r\n                                            self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                                            self.map.toast(self.getLocaleString(\"fi.error\"), { type: TC.Consts.msgType.ERROR });\r\n\r\n                                            self.unapply();\r\n                                        }\r\n                                    }, self);\r\n\r\n                                    self.viewer.readyPromise = new Promise(function (resolve, reject) {\r\n\r\n                                        // controlamos la carga de tiles para mostrar loading cuando pida tiles\r\n                                        self.view3D.tileLoadingHandler = new cesium.EventHelper();\r\n                                        self.view3D.tileLoadingHandler.add(self.viewer.scene.globe.tileLoadProgressEvent, function (data) {\r\n                                            if (!self.waiting)\r\n                                                self.waiting = self.map.getLoadingIndicator().addWait();\r\n\r\n                                            if ((self.viewer.scene.terrainProvider.allReady ||\r\n                                                (!self.viewer.scene.terrainProvider.allReady && self.viewer.scene.terrainProvider.ready))\r\n                                                && data === 0) {\r\n                                                self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                                                delete self.waiting;\r\n\r\n                                                resolve();\r\n\r\n                                                self.events.trigger(TC.Consts.event.TERRAINLOADED, {});\r\n                                            } else {\r\n                                                self.events.trigger(TC.Consts.event.TERRAINRECEIVING, {});\r\n                                            }\r\n                                        }.bind(self));\r\n                                    });\r\n\r\n                                    // deshabilitamos el zoom por defecto y manejamos nosotros zoom con rueda\r\n                                    //overrideDesktopZoom.call(self);\r\n                                    // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                                    override2DZoom.call(self, true);\r\n\r\n                                    // eliminamos los creditos de cesium (no encuentro la manera de que no los ponga)\r\n                                    document.querySelectorAll('.cesium-viewer-bottom').forEach(function (elm) {\r\n                                        elm.parentElement.removeChild(elm);\r\n                                    });\r\n\r\n                                    // enlazamos con los eventos del mapa 2D\r\n                                    self.view3D._event2DHandler = event2DHandler.bind(self);\r\n                                    self.map.on(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                                    // modificamos los controles disponibles\r\n                                    alterAllowedControls.call(self, TC.Consts.view.THREED);\r\n\r\n                                    self.viewer.readyPromise.then(function () {\r\n                                        // pintamos las features que están en el mapa 2D\r\n                                        draw2DDrawedFeatures.call(self);\r\n                                    });\r\n\r\n                                    resolve(self.viewer);\r\n\r\n                                });\r\n\r\n                            });\r\n\r\n                    } else {\r\n                        resolve(self.viewer);\r\n                    }\r\n                });\r\n            },\r\n\r\n            setBaseLayer: function (layer) {\r\n                var self = this;\r\n\r\n                var get3DLayer = function (layer) {\r\n                    if (!isCompatible(layer, self.view3D.crs)) {\r\n                        if (layer.getFallbackLayer() !== null && isCompatible(layer.getFallbackLayer(), self.view3D.crs)) {\r\n                            layer = layer.getFallbackLayer();\r\n                        } else {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.title }));\r\n                            layer = null;\r\n                        }\r\n                    }\r\n\r\n                    return layer;\r\n                };\r\n\r\n                if (!self.view3D.baseLayer) {\r\n\r\n                    if (layer.type === TC.Consts.layerType.WMTS || layer.type === TC.Consts.layerType.WMS) {\r\n\r\n                        if (layer.options.relatedWMTS) {\r\n                            self.map.baseLayer = layer = self.map.getLayer(layer.options.relatedWMTS);\r\n                            self.map.trigger(TC.Consts.event.BASELAYERCHANGE, { layer: self.map.baseLayer });\r\n                        } else {\r\n\r\n                            layer = get3DLayer(layer);\r\n\r\n                            if (layer) {\r\n                                if (!layer.isBase) {\r\n                                    layer.isBase = true;\r\n                                }\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n                    }\r\n                } else {\r\n\r\n                    if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                        self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                        self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                    }\r\n\r\n                    if (layer instanceof TC.layer.Vector) {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    }\r\n                    else {\r\n                        layer = get3DLayer(layer);\r\n\r\n                        if (layer) {\r\n                            layer.map = self.map;\r\n                            layer.isBase = true;\r\n\r\n                            self.view3D.addLayer.call(self, layer);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                currentMapCfg.baseMap = self.map.baseLayer;\r\n            },\r\n\r\n            addLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        self.view3D.vector2DLayers.push(layer);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        if (!layer.isBase && !layer.isCompatible(self.view3D.crs)) {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.layerNames }));\r\n                        } else {\r\n                            //var convertedLayer = rasterConverter.convert(layer, self.view3D.crs);\r\n                            rasterConverter.convert(layer, self.view3D.crs).then(function (convertedLayer) {\r\n                                if (convertedLayer) {\r\n\r\n                                    if (convertedLayer[\"enablePickFeatures\"] !== undefined) {\r\n                                        convertedLayer.enablePickFeatures = false;\r\n                                        convertedLayer[\"tcLayer\"] = layer;\r\n                                    }\r\n\r\n                                    if (layer.isBase && self.view3D.baseLayer) {\r\n                                        if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                                            self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                                            self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                                        }\r\n                                    }\r\n\r\n                                    var newImageryLayer = self.viewer.scene.imageryLayers.addImageryProvider(convertedLayer);\r\n\r\n                                    if (layer.isBase) { // si la capa es el mapa de fondo lo envío al fondo de las capas en 3D\r\n                                        self.view3D.baseLayer = newImageryLayer;\r\n                                        self.viewer.scene.imageryLayers.lowerToBottom(newImageryLayer);\r\n                                    } else {\r\n                                        newImageryLayer.show = layer.getVisibility();\r\n                                        newImageryLayer.alpha = layer.getOpacity();\r\n\r\n                                        self.view3D.workLayers.push(newImageryLayer);\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                        break;\r\n                    }\r\n                }\r\n            },\r\n            removeLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n\r\n                        if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(layer.id)) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[layer.id][featureId];\r\n\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[layer.id];\r\n                        }\r\n\r\n                        // GLS revisar, debería estar en workLayers¿? \r\n                        // self.view3D.workLayers.splice(i, 1);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n                                self.viewer.scene.imageryLayers.raiseToTop(self.view3D.workLayers[i]);\r\n                                self.viewer.scene.imageryLayers.remove(self.view3D.workLayers[i], true);\r\n\r\n                                self.view3D.workLayers.splice(i, 1);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsLayer: function (layer, options) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        if (self.view3D.vector2DFeatures[layer.id]) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var features = self.view3D.vector2DFeatures[layer.id][featureId];\r\n                                for (var i = 0; i < features.length; i++) {\r\n                                    self.view3D.setRenderOptionsFeature(features[i], { show: layer.getVisibility() });\r\n                                }\r\n                            }\r\n\r\n                            self.viewer.scene.requestRender();\r\n                        }\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            const imageryLayerNames = Array.isArray(self.view3D.workLayers[i].imageryProvider.layers) ? self.view3D.workLayers[i].imageryProvider.layers.join(',') : self.view3D.workLayers[i].imageryProvider.layers;\r\n                            if (layer.names && imageryLayerNames === layer.names.join(',') ||\r\n                                layer.title && imageryLayerNames === layer.title) {\r\n\r\n                                if (options.hasOwnProperty('visibility')) {\r\n                                    self.view3D.workLayers[i].show = options.visibility;\r\n                                }\r\n\r\n                                if (options.hasOwnProperty('opacity')) {\r\n                                    self.view3D.workLayers[i].alpha = options.opacity;\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n\r\n            flyToMapCoordinates: function (coords) {\r\n                var self = this;\r\n\r\n                var lonlat = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(coords, self.view3D.view2DCRS, self.view3D.crs) : coords;\r\n                var destination = cesium.Cartesian3.fromDegrees(lonlat[0], lonlat[1], self.viewer.camera.positionCartographic.height);\r\n\r\n                var camera = self.viewer.camera;\r\n                camera.flyTo({\r\n                    destination: destination,\r\n                    orientation: {\r\n                        heading: camera.heading,\r\n                        pitch: camera.pitch\r\n                    }\r\n                });\r\n            }.bind(viewProto),\r\n            flyToRectangle: function (rectangle, options) {\r\n                const self = this;\r\n                // lo primero de todo cancelar movimientos anteriores\r\n                self.viewer.scene.camera.cancelFlight();\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    options = options || {\r\n                    };\r\n\r\n                    var epsilon = cesium.Math.EPSILON3;\r\n                    if (rectangle.east === rectangle.west) {\r\n                        rectangle.east += epsilon;\r\n                        rectangle.west -= epsilon;\r\n                    }\r\n\r\n                    if (rectangle.north === rectangle.south) {\r\n                        rectangle.north += epsilon;\r\n                        rectangle.south -= epsilon;\r\n                    }\r\n\r\n                    var enlargeFactor = 0.2;\r\n                    var marginX = rectangle.width * enlargeFactor / 2;\r\n                    var marginY = rectangle.height * enlargeFactor / 2;\r\n                    rectangle.east -= marginX;\r\n                    rectangle.west += marginY;\r\n                    rectangle.north += marginY;\r\n                    rectangle.south -= marginY;\r\n\r\n                    var scene = self.viewer.scene;\r\n                    var camera = scene.camera;\r\n\r\n                    var destinationCartesian = camera.getRectangleCameraCoordinates(rectangle);\r\n                    var destination = cesium.Ellipsoid.WGS84.cartesianToCartographic(destinationCartesian);\r\n\r\n                    cesium.when(scene.globe.terrainProvider.sampleTerrainMostDetailed([cesium.Rectangle.center(rectangle)]), function (updatedPositions) {\r\n\r\n                        var finalDestinationCartographic = {\r\n                            longitude: destination.longitude,\r\n                            latitude: destination.latitude,\r\n                            height: destination.height + updatedPositions[0].height || 0\r\n                        };\r\n\r\n                        camera.flyTo({\r\n                            duration: options.duration || 1,\r\n                            destination: cesium.Ellipsoid.WGS84.cartographicToCartesian(finalDestinationCartographic),\r\n                            complete: function () {\r\n                                var angle = cesium.Math.toRadians(50);\r\n                                var pickBP = pickBottomPoint(this.viewer.scene);\r\n                                pickBP = cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                this.view3D.rotateAroundAxis(this.viewer.scene.camera, -angle, this.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 250,\r\n                                    callback: function () {\r\n                                        resolve();\r\n                                    }\r\n                                });\r\n                            }.bind(self)\r\n                        });\r\n                    });\r\n                });\r\n            }.bind(viewProto),\r\n\r\n            zoomToCartesian: function (position, amount) {\r\n                var self = this;\r\n                var scene = self.viewer.scene;\r\n\r\n                if (!position || !position.endPosition) {\r\n                    var canvas = scene.canvas;\r\n                    var center = new cesium.Cartesian2(\r\n                        canvas.clientWidth / 2,\r\n                        canvas.clientHeight / 2);\r\n                    position = {\r\n                        endPosition: center\r\n                    };\r\n                }\r\n\r\n                var pickRay = scene.camera.getPickRay(position.endPosition);\r\n                var intersection = scene.globe.pick(pickRay, scene);\r\n                if (intersection) {\r\n\r\n                    var distanceMeasure = cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                    if (distanceMeasure < 1) {\r\n                        return;\r\n                    }\r\n                    else {\r\n                        if (!self.view3D._zoomTo) {\r\n                            self.view3D._zoomTo = {\r\n                                amount: 0\r\n                            };\r\n                        }\r\n                        self.view3D._zoomTo.direction = amount > 0 ? 1 : 0;\r\n                        self.view3D._zoomTo.amount += (distanceMeasure * 5 / 100);\r\n                        self.view3D._zoomTo.endPosition = position.endPosition;\r\n                    }\r\n                }\r\n\r\n                var setNewPosition = function (data) {\r\n                    var self = this;\r\n                    var scene = self.viewer.scene;\r\n\r\n                    var pickRay = scene.camera.getPickRay(position.endPosition || data.endPosition);\r\n                    var intersection = scene.globe.pick(pickRay, scene);\r\n                    if (intersection) {\r\n\r\n                        var distanceMeasure = cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                        if (distanceMeasure < 1) {\r\n                            return;\r\n                        }\r\n                        else {\r\n\r\n                            var cameraPosition = scene.camera.position;\r\n                            var cameraDirection = scene.camera.direction;\r\n\r\n                            var toMove = toGo = new cesium.Cartesian3();\r\n                            cesium.Cartesian3.multiplyByScalar(pickRay.direction, data.direction == 1 ? data.amount : -data.amount, toMove);\r\n                            cesium.Cartesian3.add(cameraPosition, toMove, toGo);\r\n\r\n                            var ray = new cesium.Ray(toGo, pickRay.direction);\r\n                            var intersectionToGo = scene.globe.pick(ray, scene);\r\n                            if (intersectionToGo) {\r\n\r\n                                var reset = function () {\r\n                                    this.view3D._zoomTo = {\r\n                                        direction: 1,\r\n                                        amount: 0,\r\n                                        endPosition: {}\r\n                                    };\r\n\r\n                                    return;\r\n                                };\r\n\r\n                                if (cesium.Cartesian3.distance(toGo, intersectionToGo) < 1 ||\r\n                                    Math.abs(cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height) < scene.screenSpaceCameraController.minimumZoomDistance) {\r\n                                    reset.call(self);\r\n                                }\r\n                                else {\r\n                                    self.viewer.camera.flyTo({\r\n                                        destination: toGo,\r\n                                        orientation: {\r\n                                            heading: scene.camera.heading,\r\n                                            pitch: scene.camera.pitch,\r\n                                            roll: scene.camera.roll\r\n                                        },\r\n                                        duration: 1,\r\n                                        easingFunction: cesium.EasingFunction.LINEAR_NONE,\r\n                                        complete: function (distance) {\r\n                                            this.view3D._zoomTo = {\r\n                                                direction: 1,\r\n                                                amount: 0,\r\n                                                endPosition: {}\r\n                                            };\r\n                                        }.bind(self, cesium.Cartesian3.distance(toGo, intersectionToGo))\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                setTimeout(function () { // GLS: No hemos encontrado otra forma para acumular pasos de la rueda\r\n                    setNewPosition.call(self, self.view3D._zoomTo);\r\n                }.bind(self), 50);\r\n            },\r\n\r\n            rotateAroundAxis: function (camera, angle, axis, transform, opt_options) {\r\n                return rotateAroundAxis(camera, angle, axis, transform, opt_options);\r\n            },\r\n\r\n            addFeature: function (feature, options) {\r\n                var self = this;\r\n\r\n                var add = function () {\r\n                    // TODO: el convert debería ser uno o varios webworker, si son muchas features se colapsa.\r\n                    var csfeature = featureConverter.convert(self.viewer.scene, feature, self.view2DCRS, self.crs);\r\n                    if (csfeature) {\r\n                        if (typeof csfeature.geometry === 'function') {\r\n                            // estoy aquí // tengo que validar qué proveedor escoger, afecta, hay mucha diferencia de alturas, podría ir por capa?? búsquedas fijo por el de por defecto y track validar??\r\n                            csfeature.geometry(self.viewer.terrainProvider).then(function (newGeometry) {\r\n                                // es igual a cuando no es una función... a ver cómo lo gestiono\r\n                                if (newGeometry instanceof Array) {\r\n                                    newGeometry.forEach(function (geom) {\r\n                                        if (geom instanceof Array) {\r\n                                            geom.forEach(function (geo) {\r\n                                                geo = addFeature.call(self, geo);\r\n                                                linkFeature(self, feature.layer.id, geo, feature.id);\r\n                                            });\r\n                                        } else {\r\n                                            geom = addFeature.call(self, geom);\r\n                                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    var geom = addFeature.call(self, newGeometry);\r\n                                    linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                }\r\n                            });\r\n                        }\r\n                        else if (csfeature.geometry instanceof Array) {\r\n                            csfeature.geometry.forEach(function (geom) {\r\n                                geom = addFeature.call(self, geom);\r\n                                linkFeature(self, feature.layer.id, geom, feature.id);\r\n                            });\r\n                        }\r\n                        else {\r\n                            var geom = addFeature.call(self, csfeature.geometry);\r\n                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // GLS: para no pintar la cruz-marker del FeatureInfo\r\n                if ((self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.get2DMarker() === feature) ||\r\n                    (self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.isPending())) {\r\n                    // GLS: llega antes aquí que al callback de la instrucción que crea la feature, por eso necesito el timeout\r\n                    setTimeout(function () {\r\n                        if (self.linked2DControls.featureInfo.get2DMarker() === feature) {\r\n                            return;\r\n                        } else {\r\n                            add();\r\n                        }\r\n                    }, 5);\r\n                } else if (self.linked2DControls.geolocation && self.linked2DControls.geolocation.layerTracking === feature.layer && feature instanceof TC.feature.Polyline) {\r\n                    return;\r\n                } else {\r\n                    add();\r\n                }\r\n            },\r\n            removeFeature: function (feature) {\r\n                var self = this;\r\n                if (self.viewer) {\r\n                    if (feature) {\r\n                        switch (true) {\r\n                            case feature instanceof cesium.GroundPrimitive:\r\n                                self.viewer.scene.groundPrimitives.remove(feature);\r\n                                break;\r\n                            case feature instanceof cesium.Billboard:\r\n                                self.viewer.billboardCollection.remove(feature);\r\n                                break;\r\n                            case feature instanceof Object:\r\n                                self.viewer.entities.removeById(feature.id);\r\n                                break;\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsFeature: function (feature, options) {\r\n                if (feature) {\r\n                    feature.show = options.show;\r\n                }\r\n            },\r\n\r\n            addNativeFeature: function (cesiumFeature) {\r\n                return addFeature.call(this.view3D, cesiumFeature);\r\n            },\r\n\r\n            setCameraFromMapView: function () {\r\n                var self = this;\r\n\r\n                self.viewer.scene.globe.terrainProvider.readyPromise.then(function () {\r\n                    var center = self.mapView.getCenter();\r\n\r\n                    if (!center) {\r\n                        return;\r\n                    }\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var distance = calcDistanceForResolution.call(self, self.mapView.getResolution() || 0, cesium.Math.toRadians(latlon[0]));\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var carto = new cesium.Cartographic(cesium.Math.toRadians(latlon[0]), cesium.Math.toRadians(latlon[1]));\r\n                    if (self.viewer.scene.globe) {\r\n                        carto.height = self.viewer.scene.globe.getHeight(carto) || 0;\r\n                    }\r\n\r\n                    var setCamera = function () {\r\n                        if (self.map.on3DView) {\r\n                            var destination = cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                            var orientation = {\r\n                                pitch: cesium.Math.toRadians(-90),\r\n                                heading: -self.mapView.getRotation(),\r\n                                roll: 0.0\r\n                            };\r\n\r\n                            self.viewer.camera.setView({\r\n                                destination: destination,\r\n                                orientation: orientation\r\n                            });\r\n\r\n                            self.viewer.camera.moveBackward(distance);\r\n                        }\r\n                    };\r\n\r\n                    if (carto.height === 0) {\r\n                        TC.loadJS(!TC.tool || !TC.tool.Elevation, TC.apiLocation + 'TC/tool/Elevation', function () {\r\n                            self.view3D.elevationTool = new TC.tool.Elevation();\r\n                            self.view3D.elevationTool.getElevation({\r\n                                crs: self.view3D.crs,\r\n                                coordinates: [latlon]\r\n                            }).then(function (result) {\r\n                                if (result && result.length > 0) {\r\n                                    carto.height = result[0][2] ? result[0][2] : 0;\r\n                                    setCamera();\r\n                                }\r\n                            }).catch((e) => console.log(e));\r\n                        });\r\n                    } else {\r\n                        setCamera();\r\n                    }\r\n                });\r\n            },\r\n            setViewFromCameraView: function () {\r\n                const self = this;\r\n\r\n\r\n                var ellipsoid = cesium.Ellipsoid.WGS84;\r\n                var scene = self.viewer.scene;\r\n                var target = target_ = pickCenterPoint(scene);\r\n\r\n                if (!target_) {\r\n                    var globe = self.viewer.scene.globe;\r\n                    var carto = self.viewer.camera.positionCartographic.clone();\r\n                    var height = globe.getHeight(carto);\r\n                    carto.height = height || 0;\r\n                    target_ = cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                }\r\n\r\n\r\n                var distance = cesium.Cartesian3.distance(target_, self.viewer.camera.position);\r\n                var targetCartographic = ellipsoid.cartesianToCartographic(target_);\r\n\r\n                var centerMapCRS = self.view3D.crs !== self.view3D.view2DCRS ? TC.Util.reproject(\r\n                    [cesium.Math.toDegrees(targetCartographic.longitude), cesium.Math.toDegrees(targetCartographic.latitude)],\r\n                    self.view3D.crs, self.view3D.view2DCRS) : [cesium.Math.toDegrees(targetCartographic.longitude), cesium.Math.toDegrees(targetCartographic.latitude)];\r\n\r\n                self.mapView.setCenter(centerMapCRS);\r\n\r\n                self.mapView.setResolution(calcResolutionForDistance.call(self, distance, targetCartographic ? targetCartographic.latitude : 0));\r\n\r\n                // GLS: No tenemos la rotación del mapa activada por problemas con el iPad\r\n                //if (target) {\r\n                //    var pos = self.viewer.camera.position;\r\n\r\n                //    var targetNormal = new cesium.Cartesian3();\r\n                //    ellipsoid.geocentricSurfaceNormal(target, targetNormal);\r\n\r\n                //    var targetToCamera = new cesium.Cartesian3();\r\n                //    cesium.Cartesian3.subtract(pos, target, targetToCamera);\r\n                //    cesium.Cartesian3.normalize(targetToCamera, targetToCamera);\r\n\r\n                //    // HEADING\r\n                //    var up = self.viewer.camera.up;\r\n                //    var right = self.viewer.camera.right;\r\n                //    var normal = new cesium.Cartesian3(-target.y, target.x, 0);\r\n                //    var heading = cesium.Cartesian3.angleBetween(right, normal);\r\n                //    var cross = cesium.Cartesian3.cross(target, up, new cesium.Cartesian3());\r\n                //    var orientation = cross.z;\r\n\r\n                //    self.mapView.setRotation((orientation < 0 ? heading : -heading));\r\n                //    self.setViewFromCameraViewInProgress.resolve();\r\n                //}\r\n\r\n                return Promise.resolve();\r\n            },\r\n\r\n            lookAt: function (coords) {\r\n                const self = this;\r\n\r\n                if (self.crs !== self.view2DCRS) {\r\n                    coords = TC.Util.reproject(coords, self.view2DCRS, self.crs);\r\n                }\r\n\r\n                var camera = self.viewer.camera;\r\n                var positionCartographic = camera.positionCartographic;\r\n                var height = positionCartographic.height;\r\n                var cartographic = new cesium.Cartographic(cesium.Math.toRadians(coords[0]), cesium.Math.toRadians(coords[1]), height)\r\n\r\n                camera.flyTo({\r\n                    destination: cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height),\r\n                    duration: 1.0\r\n                });\r\n            },\r\n\r\n            getInfoOnPickedPosition: function (pickedPosition) {\r\n                var self = this;\r\n\r\n                if (!pickedPosition) {\r\n                    return;\r\n                } else {\r\n\r\n                    self.map.one(TC.Consts.event.DRAWTABLE, function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n\r\n                    self.view3D.linked2DControls.featureInfo.send.call(self, pickedPosition).then(function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n                }\r\n            },\r\n\r\n            on: function (event, callback) {\r\n                const self = this;\r\n\r\n                const movement3DtoPosition2D = function (movement) {\r\n                    if (self.viewer && self.viewer.cesiumWidget) {\r\n                        var ray = self.viewer.camera.getPickRay(movement.endPosition || movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            var positionCartographic = cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n\r\n                            var lat, lon, ele;\r\n                            lat = cesium.Math.toDegrees(positionCartographic.latitude);\r\n                            lon = cesium.Math.toDegrees(positionCartographic.longitude);\r\n                            ele = Math.round(positionCartographic.height);\r\n\r\n                            return { lon: lon, lat: lat, ele: ele };\r\n                        }\r\n                    }\r\n\r\n                    return null;\r\n                };\r\n\r\n                if (!self.eventHandlers) {\r\n                    self.eventHandlers = {};\r\n                }\r\n\r\n                self.eventHandlers.handlerOfMovementConversion = new cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                self.eventHandlers.handlerOfMovementConversion.setInputAction(function (event) {\r\n                    if (event.endPosition || event.position) {\r\n                        // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                        if (self.viewer.trackedEntity) {\r\n                            return;\r\n                        }\r\n\r\n                        callback(movement3DtoPosition2D(event));\r\n                    } else {\r\n                        callback(event);\r\n                    }\r\n\r\n                }, fromTCtoCesiumEvent(event));\r\n            },\r\n\r\n            getHeightFromMDT: function (geoCoords) {\r\n                const self = this;\r\n\r\n                var cartesian = new cesium.Cartographic(cesium.Math.toRadians(geoCoords[0]), cesium.Math.toRadians(geoCoords[1]));\r\n                return self.viewer.scene.globe.getHeight(cartesian) || 0;\r\n            },\r\n\r\n            // darle una vuelta cuando esté mejor. no se me ocurre nada mejor\r\n            addElevationMarker: function (coords, context) {\r\n                const self = this;\r\n                if (self.viewer && !self.viewer.view3DElevationMarkerPromise) {\r\n                    self.viewer.view3DElevationMarkerPromise = true;\r\n                    self.viewer.readyPromise.then(function () {\r\n                        delete self.viewer.view3DElevationMarkerPromise;\r\n                        const position = self.view2DCRS !== self.crs ? TC.Util.reproject(coords, self.view2DCRS, self.crs) : coords;\r\n                        let entity = new cesium.Entity({\r\n                            position: cesium.Cartesian3.fromDegrees(position[0], position[1]),\r\n                            name: 'elevationMarker',\r\n                            point: {\r\n                                show: true,\r\n                                color: cesium.Color.RED.withAlpha(0.5),\r\n                                pixelSize: 10,\r\n                                outlineColor: cesium.Color.WHITE,\r\n                                outlineWidth: 2,\r\n                                heightReference: cesium.HeightReference.CLAMP_TO_GROUND\r\n                            }\r\n                        });\r\n\r\n                        context.view3DElevationMarker = addFeature.call(self, entity);\r\n                    });\r\n                }\r\n            },\r\n            setElevationMarker: function (coords, context) {\r\n                const self = this;\r\n                if (self.viewer) {\r\n                    self.viewer.readyPromise.then(function () {\r\n                        if (context.view3DElevationMarker) {\r\n                            const position = self.view2DCRS !== self.crs ? TC.Util.reproject(coords, self.view2DCRS, self.crs) : coords;\r\n                            context.view3DElevationMarker.position = cesium.Cartesian3.fromDegrees(position[0], position[1], self.viewer.camera.positionCartographic.height);\r\n                            if (!context.view3DElevationMarker.show) {\r\n                                context.view3DElevationMarker.show = true;\r\n                            }\r\n                            self.viewer.scene.requestRender();\r\n                        } else {\r\n                            self.addElevationMarker(coords, context);\r\n                        }\r\n                    });\r\n                }\r\n            },\r\n            hideElevationMarker: function (context) {\r\n                const self = this;\r\n                if (self.viewer && context.view3DElevationMarker) {\r\n                    self.viewer.readyPromise.then(function () {\r\n                        self.removeFeature.call(self, context.view3DElevationMarker);\r\n                        delete context.view3DElevationMarker;\r\n                    });\r\n                }\r\n            },\r\n\r\n            destroy: function () {\r\n                var self = this;\r\n\r\n                self.map.on3DView = false;\r\n                //self.map.view3D = null;\r\n\r\n                self.view3D.vector2DLayers = [];\r\n                self.view3D.vector2DFeatures = {\r\n                };\r\n\r\n                // eliminamos el enlace con los eventos del mapa 2D\r\n                self.map.off(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                // modificamos los controles disponibles\r\n                alterAllowedControls.call(self, TC.Consts.view.DEFAULT);\r\n\r\n                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                override2DZoom.call(self, false);\r\n\r\n                //addNoCompatibleBaseLayers.call(self);\r\n\r\n                Promise.all(self.map.baseLayers.map(function (baseLayer) {\r\n                    return Promise.resolve(!isCompatible(baseLayer, self.view3D.view2DCRS));\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        var defaultBaseLayer;\r\n                        for (var i = 0; i < self.map.baseLayers.length; i++) {\r\n                            if (!defaultBaseLayer && !results[i]) {\r\n                                defaultBaseLayer = self.map.baseLayers[i];\r\n                            }\r\n                            if (self.map.baseLayers[i]) {\r\n                                self.map.baseLayers[i].mustReproject = results[i];\r\n                            }\r\n                        }\r\n                        var triggerEvent = true;\r\n                        const showReprojectDialog = function (haveToChange, baseLayer, fallbackLayer) {\r\n                            const dialogOptions = {\r\n                                layer: baseLayer\r\n                            };\r\n\r\n                            if (fallbackLayer) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n\r\n                            var control = self.map.getControlsByClass(haveToChange ? TC.control.BasemapSelector : TC.control.Coordinates);\r\n                            if (control.length > 0) {\r\n                                // gestionamos que el control de coordenadas no se renderice en el cambio de vista porque borra el modal de cambio de CRS\r\n                                if (control[0] instanceof TC.control.Coordinates) {\r\n                                    triggerEvent = false;\r\n                                }\r\n                                dialogOptions.closeCallback = function () {\r\n                                    self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                                };\r\n                                control[0].showProjectionChangeDialog(dialogOptions);\r\n                            }\r\n                        };\r\n\r\n                        var baseLayer = currentMapCfg.baseMap == self.Consts.BLANK_BASE ? currentMapCfg.baseVector : currentMapCfg.baseMap;\r\n                        if (!baseLayer.isCompatible(self.map.getCRS())) {\r\n\r\n                            if (!baseLayer.fallbackLayer) {\r\n                                showReprojectDialog(true, baseLayer);\r\n                            } else {\r\n                                baseLayer.getFallbackLayer();\r\n                                if (baseLayer.getFallbackLayer().isCompatible(self.map.getCRS())) {\r\n\r\n                                    // antes de establecer como fondo la capa de respaldo, preguntar al usuario si prefiere cambiar de CRS o si quiere seguir reproyectando al vuelo.\r\n                                    TC.confirm(self.getLocaleString('threed.changeBaselayer'),\r\n                                        function () {\r\n                                            showReprojectDialog(false, baseLayer, baseLayer.fallbackLayer);\r\n                                        }, function () {\r\n                                            self.map.setBaseLayer(baseLayer.fallbackLayer);\r\n                                        });\r\n                                } else {\r\n                                    showReprojectDialog(true, baseLayer);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            self.map.setBaseLayer(baseLayer);\r\n                        }\r\n                    }\r\n\r\n                    currentMapCfg.baseMap = '';\r\n\r\n                    self.view3D.baseLayer = null;\r\n\r\n                    self.view3D.workLayers = [];\r\n\r\n                    self.view3D.cameraControls.unbind();\r\n\r\n                    if (self.view3D.linked2DControls.featureInfo) {\r\n                        self.view3D.linked2DControls.featureInfo.reset();\r\n                    }\r\n\r\n                    if (self.view3D.linked2DControls.geolocation) {\r\n                        self.view3D.linked2DControls.geolocation.isGeo = false;\r\n                        self.view3D.linked2DControls.geolocation.reset();\r\n                    }\r\n\r\n                    self.view3D.tileLoadingHandler.removeAll();\r\n                    delete self.view3D.tileLoadingHandler;\r\n\r\n                    self.viewer.destroy();\r\n                    self.viewer = null;\r\n\r\n                    if (triggerEvent) { // si lanzamos sin más, el control de coordenadas se renderizada en el cambio de vista y borra el modal de cambio de CRS\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    })();\r\n\r\n    return {\r\n        init: viewProto.init.bind(viewProto),\r\n        apply: viewProto.apply.bind(viewProto),\r\n        unapply: viewProto.unapply.bind(viewProto),\r\n        VIEWNAME: viewProto.VIEWNAME\r\n    };\r\n});"]}