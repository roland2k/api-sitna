{"version":3,"sources":["ol/ol.js"],"names":["root","factory","define","amd","exports","module","require","ol","this","Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","x","window","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","max","id","setTimeout","clearTimeout","DRAGENTER","events","EventType","DRAGOVER","DROP","CHANGE","SINGLECLICK","MapBrowserEventType","POINTERMOVE","MOVEEND","MapEventType","POSTRENDER","POSTCOMPOSE","render","ADDFEATURE","source","VectorEventType","REMOVEFEATURE","CLEAR","hitTolerance","TileEventType","TILELOADSTART","TILELOADEND","TILELOADERROR","TC","Util","detectMouse","cssUrl","url","substr","lastIndexOf","format","KMLCustom","syncLoadJS","apiLocation","GPXCustom","View","prototype","getValueForResolutionFunction","opt_power","power","maxResolution","maxResolution_","minResolution","minResolution_","log","resolution","value","min","detectMobile","Overlay","updateRenderedPosition","pixel","mapSize","style","offset","getOffset","positioning","getPositioning","setVisible","offsetX","offsetY","OverlayPositioning","BOTTOM_RIGHT","CENTER_RIGHT","TOP_RIGHT","rendered","left_","left","right","round","devicePixelRatio","right_","BOTTOM_CENTER","CENTER_CENTER","TOP_CENTER","offsetWidth","BOTTOM_LEFT","top_","top","bottom","bottom_","CENTER_LEFT","offsetHeight","control","OverviewMap","_validateExtent_","validateExtent_","_wrap","parent","options","alwaysCentered","recenter_","_resetExtent_","resetExtent_","call","wrap","is3D","ovview","ovmap_","getView","extent","calculateExtent","feature","get3DCameraLayer","getSource","getFeatures","coordinates","getGeometry","getCoordinates","coord1","coord2","containsCoordinate","buffer","fit","GML3CRS84","GML3","srsName","inherit","GML2CRS84","GML2","gmlNamespace","gml32Namespace","GMLBase","MULTIPOINT_PARSERS_","MULTILINESTRING_PARSERS_","MULTIPOLYGON_PARSERS_","POINTMEMBER_PARSERS_","LINESTRINGMEMBER_PARSERS_","POLYGONMEMBER_PARSERS_","RING_PARSERS","GEOMETRY_FLAT_COORDINATES_PARSERS","FLAT_LINEAR_RINGS_PARSERS","GEOMETRY_PARSERS","MULTICURVE_PARSERS_","MULTISURFACE_PARSERS_","CURVEMEMBER_PARSERS_","SURFACEMEMBER_PARSERS_","SURFACE_PARSERS_","CURVE_PARSERS_","ENVELOPE_PARSERS_","PATCHES_PARSERS_","SEGMENTS_PARSERS_","readFeaturesInternal","node","objectStack","localName","features","gmlnsCollectionParser","FEATURE_COLLECTION_PARSERS","namespace","xml","makeArrayPusher","namespaceURI","pushParseAndPop","context","featureType","featureNS","prefix","defaultPrefix","childNodes","ii","child","nodeType","ft","nodeName","split","pop","indexOf","key","count","uri","candidate","push","ns","parsersNS","featureTypes","Array","isArray","p","parsers","readFeatureElement","makeReplacer","undefined","proj","proj4","register","get","metersPerUnit_","EPSG4326","METERS_PER_UNIT","oldGet","projectionLike","trim","loadProjDef","crs","sync","readGeometryElement","firstElementChild","getAttribute","Error","dataProjection","geometry","Feature","transformWithOptions","ONLY_WHITESPACE_RE","readFeatureElementInternal","asFeature","geometryName","values","n","nextElementSibling","firstChild","getAllTextContent","test","len","attributes","_content_","attName","name","setGeometryName","fid","getAttributeNS","setId","interaction","DragAndDrop","tryReadFeatures_","text","readFeatures","e","some","f","getRGBA","color","opacity","result","asArray","slice","getResolutionOptions","mapWrap","layer","view","map","prevRes","getResolution","pms","projection","getProjection","center","getCenter","enableRotation","maxExtent","layerForResolutions","type","Consts","layerType","VECTOR","getBaseLayer","maxRes","minRes","res","getResolutions","minResIx","maxResIx","resolutions","Map","setMap","self","initialExtent","proj4Obj","crsCode","projOptions","units","oProj","global","equivalentProjections","code","Projection","addEquivalentProjections","axisOrientation","interactions","defaults","constrainResolution","viewOptions","extentForResolution","rect","div","getBoundingClientRect","dx","dy","width","height","target","controls","pixelRatio","getEventPixel","event","viewportPosition","viewport_","eventPosition","changedTouches","clientX","pointerEvent","clientY","_promise","Promise","resolve","manageSize","one","MAPLOAD","updateSize","on","PRINTING","workLayers","forEach","wl","_noFeatureClicked","featuresInLayers","forEachFeatureAtPixel","showsPopup","trigger","FEATURECLICK","NOFEATURECLICK","addMoveEndListener","ZOOM","hasListener","once","BEFOREZOOM","onChangeView","un","limitZoomLevels","setView","BEFOREBASELAYERCHANGE","evt","on3DView","newLayer","oldResolutions","oldLayer","modelLayer","BASELAYERCHANGE","olMapViewport","getViewport","addEventListener","MOUSEMOVE","hit","activeControl","isExclusive","selectable","FEATUREOVER","cursor","getMetersPerUnit","extentInDegrees","getUnits","Units","DEGREES","getMetersPerDegree","getExtent","getUnitRatio","defaultCrs","Cfg","defaultProj","newProj","normalizeProjection","units_","setProjection","baseLayer","transformExtent","unitRatio","oldView","minZoom","getMinZoom","maxZoom","getMaxZoom","getMinResolution","getMaxResolution","transformFactor","Number","POSITIVE_INFINITY","transform","newView","nearest","insertLayer","olLayer","idx","layers","getLayers","alreadyExists","getLength","item","remove","insertAt","Tile","setMaxResolution","setMinResolution","loadingTileCount","beforeTileLoadHandler","state","Layer","LOADING","BEFORELAYERUPDATE","_loadingTileCount","isRaster","$events","BEFORETILELOAD","TILELOAD","IDLE","LAYERUPDATE","removeLayer","getLayerCount","getLayerGroup","indexOfFirstVector","l","Vector","getLayerIndex","elm","setLayerIndex","index","ix","getArray","setBaseLayer","reject","setLayer","curBl","Image","WMTS","layerProjectionOptions","oldCrs","getCode","getControls","ctl","ZoomSlider","initSlider_","currentResolution","newRes","sort","a","b","reduce","prev","abs","maxResolutionError","isLoaded","animate","duration","ZOOM_ANIMATION_DURATION","bind","setResolution","setExtent","applyExtent","getResolutionForExtent","constrainedResolution","EXTENT_TOLERANCE","isNaN","setCenter","_setExtentPromise","finally","_timeout","getSize","getLayer","then","apply","factor","getWidth","getHeight","setPromise","coords","opts","async","getMap","setRotation","rotation","olMap","getRotation","getCoordinateFromPixel","xy","getPixelFromCoordinate","coord","synchronous","getCanvas","from","querySelectorAll","isNative","isGeo","addPopup","popupCtl","draggable","loadJS","Draggabilly","DRAGGABILLY","popup","popupDiv","addOverlay","container","parentElement","classList","add","classes","DRAGGABLE","matches","stopPropagation","passive","drag","not","handleEvent","notSelector","isException","pointer","bcr","clientWidth","pageX","clientHeight","pageY","_pointerCancel","setDragging","_currentOffset","_previousContainerPosition","setPosition","setOffset","coordDelta","position","getPosition","containerRect","mouseMoveHandler","viewport","removeEventListener","hidePopup","currentFeature","VISIBLE","bounding","canvas","idealWidth","idealHeight","isInteger","oldSize","newSize","setSize","getFormatFromName","extractStyles","KML","mimeType","KMZ","showPointNames","GPX","GEOJSON","JSON","GeoJSON","GML32","GML","TOPOJSON","TopoJSON","WKT","exportFeatures","nativeStyle","createNativeStyle","styles","olFeatures","clone","id_","getStyle","setStyle","getNativeFeatureStyle","getText","setProperties","geom","Point","shape","getImage","RegularShape","diameter","getRadius","getStroke","document","createElement","vectorContext","toContext","getContext","size","setText","drawGeometry","newFeature","getId","getProperties","Style","image","Icon","src","toDataURL","pointsToAdd","point","LineString","getCoordinateAt","Polygon","getInteriorPoint","MultiLineString","lineStrings","getLineStrings","maxLength","line","cur","MultiPolygon","polygons","getPolygons","maxArea","polygon","getArea","crossOrigin","concat","hasZ","getGeometryStride","temp","values_","keysToChange","newKey","replace","featuresNode","writeFeaturesNode","featureProjection","removeAttribute","featureCollectionNode","createElementNS","setAttributeNS","schemaLocation","appendChild","outerHTML","setGeometry","writeFeatures","isFileDrag","dataTransfer","types","handleDragEnter","preventDefault","handleDragExit","enableDragAndDrop","ddOptions","formatConstructors","splitCollection","dropTarget","getDiv","zipFiles","ddInteraction","featurePromises","getUID","createFeature","all","li","getLoadingIndicator","removeWait","_featureImportWaitId","featuresWithGeometry","filter","FEATURESIMPORT","fileName","file","timeStamp","lastModified","failed","total","File","zipName","FEATURESIMPORTERROR","map_","addInteraction","dropArea","originalFnc","handleResult_","zipUncompressed","getFileData","arrayBuffer","fr","FileReader","onload","Uint8Array","onerror","readAsArrayBuffer","_self","manageError","err","error","msgErrorMode","CONSOLE","array","geopackage","open","myPackage","vectorLayers","getFeatureTables","numTables","finished","notLoaded","warnings","manageLoad","off","FEATURESIMPORTPARTIAL","table","reason","dropFilesCounter","contentsDao","queryForId","srs_id","obj","iterateGeoJSONFeaturesFromTable","arr","results","hasOwnProperty","jsonObj","newFile","loadFile","ex","RegExp","exec","extension","substring","isSHP","readAsText","getFileText","timer","shp","shapes","message","combine","parseShp","parseDbf","collection","stringify","toLowerCase","Object","keys","k","handleDrop","isEmpty","items","addWait","kind","isFile","webkitGetAsEntry","dropListenKeys_","listen","body","buttons","ddEnabled","loadFiles","files","getInteractions","currentTarget","undoTarget","ProcessFile","linkTo","thisView","thatView","getVisibility","getVisible","setVisibility","visible","r","METERS","metersPerDegree","createPathFromGeometry","Path2D","p0","moveTo","lineTo","closePath","getPixelRatioScalePath","path","addPath","DOMMatrix","execCanvasOperation","operationName","precomposeHandler","postcomposeHandler","precomposeHandlerName","postcomposeHandlerName","PRECOMPOSE","clip","isFunction","ctx","save","restore","stroke","strokeWidth","lineWidth","strokeColor","strokeStyle","Raster","WmsParser","WMSCapabilities","WmtsParser","WMTSCapabilities","addCommonEvents","LAYERVISIBILITY","getGetMapUrl","getServiceType","WMS","dcpType","capabilities","Capability","Request","GetMap","DCPType","HTTP","Get","OnlineResource","OperationsMetadata","GetTile","DCP","href","fragment","createDocumentFragment","textarea","innerHTML","textContent","getInfoFormats","c","GetFeatureInfo","Format","infoFormatPreference","getWMTSLayer","tileMatrixSetByCRS","Contents","TileMatrixSet","tms","CRSCodesEqual","SupportedCRS","layerNames","Identifier","j","TileMatrixSetLink","tmsCRS","matrixSetId","matrixSet","getTileMatrix","TileMatrix","getScaleDenominators","ScaleDenominator","MinScaleDenominator","MaxScaleDenominator","getName","children","getLayerNodes","childDenominators","getAttribution","ServiceProvider","ProviderName","site","ProviderSite","ServiceIdentification","Title","Service","getInfo","layerNodes","getAllLayerNodes","compareNames","title","Abstract","legend","_traverse","o","func","getLegend","MetadataURL","metadata","md","queryable","layerName","names","abstract","Metadata","jj","getServiceTitle","getRootLayerNode","ignorePrefix","Name","getIdentifier","_layerList","getNodeArray","normalizeLayerNode","normalizeCapabilities","LegendURL","isCompatible","_isCompatible","nodes","inCrs","itemCRS","CRS","SRS","crsList","isIn","getCompatibleCRS","crsLists","getNodePath","otherCrsLists","every","tileMatrixSets","tmsl","getCompatibleLayers","_recursiveFn","crsToCheck","tmsList","tmsIdentifier","layerList","tmsLinkList","kk","getCompatibleMatrixSets","tmsLink","setWMTSUrl","urls","getUrls","urlPattern","createWMSLayer","params","ImageWMS","ratio","imageRatio","imageLoadFunction","getImageLoad","layerOptions","LAYERS","method","createWmtsSource","sourceOptions","optionsFromCapabilities","requestEncoding","encoding","location","protocol","setTileLoadFunction","prevFn","matrix","getLimitedMatrixSet","matrixIndex","createWMTSLayer","getParams","setParams","updateParams","setMatrixSet","newSource","extend","newResolutions","newMaxResolution","newMinResolution","setSource","ts","setResolutions","resolutions_","tileGrid","getLayerNodeByName","BoundingBox","mapCrs","getCRS","mapCrsCode","getCRSCode","NEGATIVE_INFINITY","firstBbox","crsBbox","bbox","ext","bboxCrs","topLeft","reproject","bottomLeft","topRight","bottomRight","reloadSource","refresh","Geometry","getNearest","candidates","getClosestPoint","setScaleFunction","imageStyle","iconWidth","olFeat","setScaleForWidth","imgWidth","markerWidth","setScale","imageSize","img","naturalWidth","getSrc","getStyleValue","property","match","m","data","mergeMapAndGeneralStyles","nativeStyleOptions","isPoint","isLine","isPolygon","olGeom","getType","getData","isCluster","externalStyles","styleOptions","cluster","Stroke","lineDash","fill","Fill","fillColor","fillOpacity","circleOptions","radius","Circle","label","createNativeTextStyle","marker","anchor","anchorXUnits","anchorYUnits","styleObj","textOptions","overflow","fontSize","font","angle","PI","fontColor","labelOutlineColor","labelOutlineWidth","labelOffset","Text","toHexString","number","toString","getHexColorFromArray","colorArray","getStyleFromNative","olStyle","olGeomType","GeometryType","POINT","MULTI_POINT","setImage","getColor","getFill","getAnchor","getLineDash","createVectorSource","createStyles","WFS","listenerKey","getState","Observable","unByKey","addFeatures","import","oldFeatures","vectorOptions","usesGenericLoader","isHeatmap","heatmap","proxify","getMimeTypeFromUrl","loader","internalLoader","featureloader","xhr","getFormat","fs","newData","LAYERERROR","outputFormat","gmlFormat","sOrigin","serviceUrl","isFilterText","properties","manageResponse","response","feats","triggerLayerUpdate","onFeaturesAdd","FEATURESADD","XMLDocument","querySelector","makeAjaxCall","onlyHits","ajaxOptions","version","filterText","URL_MAX_LENGTH","WFSQueryBuilder","maxFeatures","BEFOREAPPLYQUERY","query","service","request","srsname","featurePrefix","assign","resultType","Bbox","BBOX","responseType","XML","contentType","ajax","getCapabilitiesPromise","_capabilities","numMaxFeatures","Operations","GetFeature","CountDefault","DefaultValue","firstNode","tagName","numOfFeaturesFounded","parseInt","WFSErrors","MAX_NUM_FEATURES","limit","founded","totalFeatures","catch","_requestUrl","_tcLayer","markerStyle","Cluster","distance","start","now","pCoords","cCoords","step","fromCoords","toCoords","fraction","getCurrentCoordinates","CLUSTER_ANIMATION_DURATION","clusterCache","splice","elmCoords","cElm","s","addFeatureToLayer","feat","addFn","addPoint","Polyline","addPolyline","addPolygon","addMultiPolygon","MultiPolyline","addMultiPolyline","addFeature","constructor","FEATUREREMOVE","VECTORUPDATE","FEATURESCLEAR","dynamicStyle","styleFunction","isDynamicStyle","prop","setStyles","Heatmap","newOptions","createVectorLayer","declutter","hmOptions","weight","oldWeightFn","commit","getFeatureById","removeFeature","subSource","clearFeatures","clear","setFeatureVisibility","fillOptions","strokeOptions","displayNoneStyle","_originalStyle","findFeature","getGetFeatureUrl","sendTransaction","inserts","updates","deletes","getNativeFeature","olInserts","olUpdates","olDeletes","transaction","writeTransaction","er","getElementsByTagNameNS","errorObj","texts","transactionResponse","readTransactionResponse","errObj","status","msg","setDraggable","onend","onstart","olObjects","interactionOptions","Collection","Translate","removeInteraction","detectIE","_handlerDraggablePointerMove","getFeaturesInExtent","tolerance","featuresInExtent","leftCorner","rightCorner","coordinate","Click","_trigger","featureCount","CLICK","activate","deactivate","ScaleBar","updateElement_","ScaleLine","renderedHTML_","NavBar","zCtl","Zoom","zsCtl","frameState","viewState","requestSliderSize","setTarget","addControl","button","CLASS","display","setAttribute","getLocaleString","zoomSlider","renderPromise","sliderInitialized_","setThumbPosition_","NavBarHome","z2eCtl","ZoomToExtent","tipLabel","homeBtn","setInitialExtent","Coordinates","_coordsTrigger","coordsToClick","view3D","onMouseMove","getEventCoordinate","latLon","reverse","update","Geolocation","_snapTrigger","dragging","initSnap","_postcomposeTrigger","duringTrackSnap","getTrackingLine","layerTracking","hasCoordinates","addWaypoint","waypoint","ele","time","addPosition","heading","speed","accuracy","altitudeAccuracy","altitude","last","appendCoordinate","lx","ly","storage","setSessionLocalValue","Const","LocalStorageKey","TRACKINGTEMP","formattedToStorage","Event","STATEUPDATED","moving","positionChangehandler","geoposition","setTracking","layerGPS","position_","longitude","latitude","projectedPosition","deltaMean","POSITIONCHANGE","pd","radToDeg","addCircle","accuracyCircle","geopositionTracking","firstPosition","trackCenterButton","zoomToFeatures","getTrackInfoPanel","infoPanel","isVisible","doVisible","isMinimized","maximize","controlContainer","getControlsByClass","addElement","POSITION","LEFT","htmlElement","HIDDEN","tracking","nativeTrackingFeature","sessionwaypoint","sessionTracking","parser","storageCRS","tcFeature","currentPositionWaiting","currentPositionTrk","getCurrentPositionInterval","getCurrentPositionRequest","errorTimeout","toast","enableHighAccuracy","timeout","setInterval","getCurrentPosition","errorCallback","navigator","geolocation","clearInterval","watchPosition","onGeolocateError","TIMEOUT","maximumAge","msgType","WARNING","track","activateButton","deactivateButton","watch","clearWatch","activateSnapping","deactivateSnapping","snapInfo","removeOverlay","snapInfoElement","snapLine","attachedDTD","setFillStrokeStyle","endSnap","eventPixel","layerTrack","closestFeature","getClosestFeatureToCoordinate","closestPoint","elevationChartData","secondaryElevationProfileChartData","profileChartData","eleCoordinates","pow","snappingTolerance","setCoordinates","getElementsByClassName","getKeys","locale","toLocaleString","minimumFractionDigits","getZ","getM","getLayout","GeometryLayout","XYZM","z","XYZ","XYM","mdtClosestPoint","mdtZ","mdtz","getRenderedHtml","html","drawTrackingData","layout","toShare","doZoom","formattedFromStorage","storageData","removeTrackingProperty","notReproject","unset","export","getTrackingData","geoJSON","idRequestAnimationFrame","bufferElm","segmentsUnion","mergedIndex","ls","lineString","nextLineIndex","getLastCoordinate","nls","first","getFirstCoordinate","d","processImportedFeatures","importedFileName","toAdd","toRemove","maybeRemove","segments","featureToAdd","promises","ta","indices","sameName","saveTrack","trackName","importedIndex","processAdd","IMPORTEDTRACK","wait","alert","vectorSource","simulateTrackEnd","resized","hasElevation","chartProgressClear","simulateMarker","simulateTrack","setCoords","animationFrameFraction","hasTime","toLength","utmCrs","arCoordinates","done","walkingSpeed","trackFilm","timestamp","parse","loopAtFraction","simulate_paused","getCoordinateAtM","getDoneAtM","getSelectedTrack","uiSimulate","chartSetProgress","_getTime","getCoords","to","atan2","simulate_speed","delta","d3","D3C3","headingChangehandler","infoOnMap","iomStyle","overFlowY","backgroundColor","getHeading","orientationChangehandler","beta","getBeta","gamma","getGamma","constrainCenter","pulsate","circle","pulsated","elapsed","setRadius","drawCircleGeometry","ResultsPanel","showElevationMarker","elevationMarker","stopEvent","getOpacity","getElement","getOverlayById","addElevationMarker","setElevationMarker","hideElevationMarker","coordsActivate","coordsDeactivate","Parser","read","featureOptions","MultiPoint","ovMap","collapsed","collapsible","className","getOverviewMap","pixelRatio_","boxOverlay_","box","boxSizing","_boxElm","ovmMap","positionDrag","newTransform","dragPoint","idxStart","idxEnd","dragged","cloneNode","ACTIVE","insertAdjacentElement","insertBefore","containment","removeChild","moveVector","_delta","centerPixel","newCenter","halfWidth","halfHeight","reset","load","olView","OVERVIEWBASELAYERCHANGE","originalLayer","getFallbackLayer","defaultLayer","loadProjections","orderBy","projList","fovStyle","setColor","addLayer","draw3DCamera","camLayer","fov","enable","resizeEvent","createEvent","initEvent","dispatchEvent","disable","FeatureInfo","_clickTrigger","beforeRequest","NOFEATUREINFO","getElementText","esriXmlParser","dom","DOMParser","parseFromString","documentElement","fiCollections","getElementsByTagName","fic","fInfos","lenj","fields","lenk","field","addLayerToService","getPath","getFeatureInfo","targetServices","auxInfo","requestPromises","requestDataArray","services","elem","getGetFeatureInfoUrl","targetService","mapLayers","disgregatedNames","getDisgregatedLayerNames","consoleRegister","_isGMLFilter","Filter","join","cql_filter","params_","gfiURL","QUERY_LAYERS","INFO_FORMAT","FEATURE_COUNT","pixelTolerance","expUrl","requestData","requestedFormat","expandUrl","mapLayer","toolProxification","fetch","cacheHost","getAction","cache","originalUrl","action","responses","someSuccess","featureInsertionPoints","featureInfo","responseText","iFormat","WMSGetFeatureInfo","isParentOrSame","na","nb","pa","pb","fakeLayers","found","lName","featureId","fakeLayer","compoundLayer","rawUrl","rawContent","rawFormat","responseError","ERROR","finfoPromises","defaultFeature","getMapLocale","isInside","featureInsertionPoint","responseCallback","INFO","BEFOREFEATUREINFO","GeometryFeatureInfo","hasSuitableLayers","hasLayers","_isSearching","_isDrawing","ret","beginDraw","geometryType","semaforo","drawCtrl","setActive","startDrawing_","olGeometryType","POLYLINE","LINE_STRING","POLYGON","layerStyle","Draw","olFeature","setShowsPopup","points","sketchCoords_","sketchFeature_","addToDrawing_","_drawToken","filterFeature","filterLayer","cancelDraw","source_","readFeaturesFromResponse","exception","featureToServiceDistributor","getFeaturesByGeometry","olGeometry","stride","flatCoordinates","getFlatCoordinates","bestPoint","arrRequests","extractFeatures","intersects","arrPromises","responseObj","rej","errors","errorMsg","errorType","GETCAPABILITIES","NO_FEATURES","INDETERMINATE","descripcion","errorThrown","serviceName","serviceTitle","featuresFound","Popup","PANANIMATIONSTART","PANANIMATIONEND","fitToView","popupBoundingRect","mapBoundingRect","west","north","east","popupExt","mapExt","containsExtent","overflows","newPos","newPixelPos","_oldUpdatePixelPosition","updatePixelPosition","ct","easing","percent","setDragged","_newHandleOffsetChanged","unlisten","getChangeEventType","handleOffsetChanged","containerStyle","setProperty","scale","getScale","canvas_","MULTI_POLYGON","MULTI_LINE_STRING","getLegendImageFromStyle","createFeatureBasics","setData","createPoint","hasStyleOptions","createMultiPoint","createMarker","iconUrl","getPointIconUrl","createPolyline","createPolygon","createMultiPolyline","createMultiPolygon","createCircle","_featurePromise","geomStr","olStyles","cloneFeature","getFont","getOffsetX","getOffsetY","ctor","ringsOrPolylines","isMultiPolygon","isPolygonOrMultiLineString","isLineString","XY","setCenterAndRadius","getPolygonLength","getLinearRings","ring","newRing","getLinearRing","flat","linearRingLength","getLineStringLength","readonly","extendedStyle","currentStyle","fill_","image_","stroke_","text_","newStyle","cssClass","iconOptions","getBackgroundUrlFromCss","imgAnchor","layerStroke","setWidth","strokeChanged","setLineDash","setStroke","setFill","changed","toggleSelectedStyle","condition","setSelectedStyle","removeSelectedStyle","getInnerPoint","clipped","clipBox","pol","clipPolygon","area","curArea","rings","clipPolyline","curLength","centroid","showPopup","Control","currentExtent","_innerCentroid","contentDiv","parentOptions","isEmptyObject","CLASSNAME","fStyle","getImageSize","_folders","getBounds","getTemplate","_balloon","getGeometryName","unsetData","clearData","sketch","MEASUREPARTIAL","getMeasureData","mouseOverHandler","hoverCoordinate","pushCoordinate","clickHandler","_mdPx","squaredClickTolerance_","pointerdownHandler","perimeter","formatArea","formatLength","mode","MULTIPOLYGON","MULTIPOINT","MULTIPOLYLINE","objects","_pointerdownHandler","_clickHandler","_mouseMoveHandler","_mouseOverHandler","snapInteraction","measure","drawOptions","snapTolerance","shiftKeyOnly","hole","parentStyles","RECTANGLE","maxPoints","geometryFunction","end","newCoords","DRAWSTART","overlayStyle","overlay_","MEASURE","endFn","DRAWEND","delay","dblClickInteraction","DoubleClickZoom","getActive","_projectionChangeHandler","oldProj","oldValue","sketchPoint_","sketchCoords","deflateCoordinates","getTransform","transformFn","inflateCoordinates","drawProjectionChangeHandler","snapping","snapOptions","Snap","redoStack","persistent","popCoordinate","puntos","flyingPointContained","flyingPoint","sketchLine_","undo","redo","finishDrawing","OfflineMapMaker","getRequestSchemas","schema","layerId","tileMatrixSet","olSource","getTileGrid","matrixIds","getMatrixIds","tmsLimits","llen","TileMatrixSetLimits","tileMatrixLimits","rlen","origin","getOrigin","tileSize","getTileSize","unitsPerTile","tml","mId","tSize","cl","floor","cr","rt","rb","tmsLimit","MinTileCol","MaxTileCol","MinTileRow","MaxTileRow","getGetTilePattern","WMTSEncoding","RESTFUL","encodeURIComponent","createHaloStroke1","createHaloStroke2","addHaloToStyle","mainStyle","haloPart1","unshift","haloPart2","updateSelectedStyle","style_","originalStyle","createSelectedStyle","styleFunction_","createStyleFunction","Modify","selectInteraction","select","Select","getWrapperFeature","selected","FEATURESSELECT","ctrl","deselected","FEATURESUNSELECT","modifyInteraction","modify","FEATUREMODIFY","_onMouseMove","getSelectedFeatures","setSelectedFeatures","featureOverlay_","unselectFeatures","selectedFeatures","unselectedFeatures","Edit","cancel","cancelTxt","histPoints","deleteFeatures","toGML","writeGeometryNode","poligons","XMLSerializer","serializeToString","str","pos","toGeoJSON","writeGeometry","write"],"mappings":"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","sourcesContent":["; (function (root, factory) {\r\n\r\n    if (typeof define === 'function' && define.amd) {\r\n        define(['../../lib/ol/build/ol-sitna'], factory);\r\n    } else if (typeof exports === 'object') {\r\n        module.exports = factory(require('../../lib/ol/build/ol-sitna'));\r\n    } else {\r\n        root.ol = factory(root.ol);\r\n    }\r\n\r\n})(this, function (ol) {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n\r\n    // requestAnimationFrame polyfill\r\n    var lastTime = 0;\r\n    var vendors = ['ms', 'moz', 'webkit', 'o'];\r\n    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame)\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n\r\n    if (!window.cancelAnimationFrame)\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n\r\n    // Nombres de tipos de eventos\r\n    const MOUSEMOVE = 'mousemove';\r\n    const MOUSEOVER = 'mouseover';\r\n    const DRAGENTER = ol.events.EventType.DRAGENTER;\r\n    const DRAGOVER = ol.events.EventType.DRAGOVER;\r\n    const DROP = ol.events.EventType.DROP;\r\n    const CHANGE = ol.events.EventType.CHANGE;\r\n    const SINGLECLICK = ol.MapBrowserEventType.SINGLECLICK;\r\n    const POINTERMOVE = ol.MapBrowserEventType.POINTERMOVE;\r\n    const MOVEEND = ol.MapEventType.MOVEEND;\r\n    const POSTRENDER = ol.MapEventType.POSTRENDER;\r\n    const POSTCOMPOSE = ol.render.EventType.POSTCOMPOSE;\r\n    const ADDFEATURE = ol.source.VectorEventType.ADDFEATURE;\r\n    const REMOVEFEATURE = ol.source.VectorEventType.REMOVEFEATURE;\r\n    const CLEAR = ol.source.VectorEventType.CLEAR;\r\n    const TILELOADSTART = ol.source.TileEventType.TILELOADSTART;\r\n    const TILELOADEND = ol.source.TileEventType.TILELOADEND;\r\n    const TILELOADERROR = ol.source.TileEventType.TILELOADERROR;\r\n\r\n    const hitTolerance = TC.Util.detectMouse() ? 3 : 10;\r\n\r\n    var cssUrl = TC.url.ol.substr(0, TC.url.ol.lastIndexOf('/'));\r\n    cssUrl = cssUrl.substr(0, cssUrl.lastIndexOf('/') + 1) + 'css/ol.css';\r\n    //TC.loadCSS(cssUrl);\r\n\r\n\r\n    /////////////////////////// ol patches\r\n\r\n    if (!ol.format.KMLCustom) {\r\n        TC.syncLoadJS(TC.apiLocation + 'TC/ol/format/KMLCustom');\r\n    }\r\n\r\n    if (!ol.format.GPXCustom) {\r\n        TC.syncLoadJS(TC.apiLocation + 'TC/ol/format/GPXCustom');\r\n    }\r\n\r\n    // Parche para evitar el error AssertionError: Assertion failed: calculated value (1.020636810790192) ouside allowed range (0-1)\r\n    ol.View.prototype.getValueForResolutionFunction = function (opt_power) {\r\n        const power = opt_power || 2;\r\n        const maxResolution = this.maxResolution_;\r\n        const minResolution = this.minResolution_;\r\n        const max = Math.log(maxResolution / minResolution) / Math.log(power);\r\n        return (\r\n            /**\r\n                 * @param {number} resolution Resolution.\r\n                 * @return {number} Value.\r\n             */\r\n            function (resolution) {\r\n                var value =\r\n                    (Math.log(maxResolution / resolution) / Math.log(power)) / max;\r\n                value = Math.max(Math.min(1, value), 0);\r\n                return value;\r\n            });\r\n    };\r\n\r\n    if (!TC.Util.detectMobile()) {\r\n        // Parche para situar el ancla del popup cuando tenemos zoom in/out de navegador o pantalla\r\n        ol.Overlay.prototype.updateRenderedPosition = function (pixel, mapSize) {\r\n            const style = this.element.style;\r\n            const offset = this.getOffset();\r\n\r\n            const positioning = this.getPositioning();\r\n\r\n            this.setVisible(true);\r\n\r\n            var offsetX = offset[0];\r\n            var offsetY = offset[1];\r\n            if (positioning == ol.OverlayPositioning.BOTTOM_RIGHT ||\r\n                positioning == ol.OverlayPositioning.CENTER_RIGHT ||\r\n                positioning == ol.OverlayPositioning.TOP_RIGHT) {\r\n                if (this.rendered.left_ !== '') {\r\n                    this.rendered.left_ = style.left = '';\r\n                }\r\n                const right = Math.round(mapSize[0] - pixel[0] - offsetX) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.right_ != right) {\r\n                    this.rendered.right_ = style.right = right;\r\n                }\r\n            } else {\r\n                if (this.rendered.right_ !== '') {\r\n                    this.rendered.right_ = style.right = '';\r\n                }\r\n                if (positioning == ol.OverlayPositioning.BOTTOM_CENTER ||\r\n                    positioning == ol.OverlayPositioning.CENTER_CENTER ||\r\n                    positioning == ol.OverlayPositioning.TOP_CENTER) {\r\n                    offsetX -= this.element.offsetWidth / 2;\r\n                }\r\n                const left = Math.round(pixel[0] + offsetX) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.left_ != left) {\r\n                    this.rendered.left_ = style.left = left;\r\n                }\r\n            }\r\n            if (positioning == ol.OverlayPositioning.BOTTOM_LEFT ||\r\n                positioning == ol.OverlayPositioning.BOTTOM_CENTER ||\r\n                positioning == ol.OverlayPositioning.BOTTOM_RIGHT) {\r\n                if (this.rendered.top_ !== '') {\r\n                    this.rendered.top_ = style.top = '';\r\n                }\r\n                const bottom = Math.round(mapSize[1] - pixel[1] - offsetY) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.bottom_ != bottom) {\r\n                    this.rendered.bottom_ = style.bottom = bottom;\r\n                }\r\n            } else {\r\n                if (this.rendered.bottom_ !== '') {\r\n                    this.rendered.bottom_ = style.bottom = '';\r\n                }\r\n                if (positioning == ol.OverlayPositioning.CENTER_LEFT ||\r\n                    positioning == ol.OverlayPositioning.CENTER_CENTER ||\r\n                    positioning == ol.OverlayPositioning.CENTER_RIGHT) {\r\n                    offsetY -= this.element.offsetHeight / 2;\r\n                }\r\n                const top = Math.round(pixel[1] + offsetY) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.top_ != top) {\r\n                    this.rendered.top_ = style.top = top;\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    // Modificación para cambiar el comportamiento de ol.control.OverviewMap:\r\n    // Mantener la caja del extent siempre centrada.\r\n    ol.control.OverviewMap.prototype._validateExtent_ = ol.control.OverviewMap.prototype.validateExtent_;\r\n    ol.control.OverviewMap.prototype.validateExtent_ = function () {\r\n        var self = this;\r\n        self._validateExtent_();\r\n        if (self._wrap && self._wrap.parent.options.alwaysCentered) {\r\n            self.recenter_();\r\n        }\r\n    };\r\n\r\n    // En modo 3D, cambiar la lógica de la escala para que siempre muestre área de visión.\r\n    ol.control.OverviewMap.prototype._resetExtent_ = ol.control.OverviewMap.prototype.resetExtent_;\r\n    ol.control.OverviewMap.prototype.resetExtent_ = function () {\r\n        var self = this;\r\n        self._resetExtent_.call(self);\r\n        var wrap = self._wrap;\r\n        if (wrap.is3D) {\r\n            var ovmap = self.ovmap_;\r\n            var ovview = ovmap.getView();\r\n            var extent = ovview.calculateExtent();\r\n            var feature = wrap.get3DCameraLayer().getSource().getFeatures()[0];\r\n            if (feature) {\r\n                coordinates = feature.getGeometry().getCoordinates();\r\n                var coord1 = coordinates[0][0];\r\n                var coord2 = coordinates[0][1];\r\n                if (!ol.extent.containsCoordinate(extent, coord1) || !ol.extent.containsCoordinate(extent, coord2)) {\r\n                    var buffer = Math.max(\r\n                        extent[0] - coord1[0],\r\n                        extent[1] - coord1[1],\r\n                        coord1[0] - extent[2],\r\n                        coord1[1] - extent[3],\r\n                        extent[0] - coord2[0],\r\n                        extent[1] - coord2[1],\r\n                        coord2[0] - extent[2],\r\n                        coord2[1] - extent[3]\r\n                    );\r\n                    ovview.fit(ol.extent.buffer(extent, buffer));\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ol.format.GML3CRS84 = function () {\r\n        ol.format.GML3.call(this, {\r\n            srsName: 'CRS:84'\r\n        });\r\n    };\r\n    TC.inherit(ol.format.GML3CRS84, ol.format.GML3);\r\n\r\n    ol.format.GML2CRS84 = function () {\r\n        ol.format.GML2.call(this, {\r\n            srsName: 'CRS:84'\r\n        });\r\n    };\r\n    TC.inherit(ol.format.GML2CRS84, ol.format.GML2);\r\n\r\n    // Añadido el espacio de nombres de GML 3.2 al parser\r\n    const gmlNamespace = 'http://www.opengis.net/gml';\r\n    const gml32Namespace = 'http://www.opengis.net/gml/3.2';\r\n    ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.RING_PARSERS[gml32Namespace] = ol.format.GMLBase.prototype.RING_PARSERS[gmlNamespace];\r\n    ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS[gml32Namespace] = ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS[gmlNamespace];\r\n    ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS[gml32Namespace] = ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS[gmlNamespace];\r\n    ol.format.GML3.prototype.GEOMETRY_PARSERS[gml32Namespace] = ol.format.GML3.prototype.GEOMETRY_PARSERS[gmlNamespace];\r\n    ol.format.GML3.prototype.MULTICURVE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.MULTICURVE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.MULTISURFACE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.MULTISURFACE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SURFACE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SURFACE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.CURVE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.CURVE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.ENVELOPE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.ENVELOPE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.PATCHES_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.PATCHES_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SEGMENTS_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SEGMENTS_PARSERS_[gmlNamespace];\r\n\r\n    // Bug de OpenLayers hasta 5.3.0 como mínimo:\r\n    // El parser de GML2 no lee las siguientes features del GML si tienen un featureType distinto del primero.\r\n    // Esto pasa porque genera el objeto de featureTypes con la primera y en las siguientes iteraciones si el objeto existe no se regenera.\r\n    // Entre comentarios /* */ se elimina lo que sobra.\r\n    //\r\n    // Más: se añade para FeatureCollection un parser por cada namespaceURI del nodo. \r\n    // Esto es porque QGIS genera GML cuyo nodo FeatureCollection tiene namespace = http://ogr.maptools.org/.\r\n    ol.format.GMLBase.prototype.readFeaturesInternal = function (node, objectStack) {\r\n        const localName = node.localName;\r\n        let features = null;\r\n        if (localName == 'FeatureCollection') {\r\n            // Ñapa para leer GML de https://catastro.navarra.es/ref_catastral/gml.ashx?C=217&PO=5&PA=626\r\n            // y demás GMLs obtenidos de un WFS de GeoServer.\r\n            var gmlnsCollectionParser = this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.prototype.namespace];\r\n            if (!gmlnsCollectionParser['member']) {\r\n                gmlnsCollectionParser['member'] = ol.xml.makeArrayPusher(\r\n                    ol.format.GMLBase.prototype.readFeaturesInternal);\r\n            };\r\n            //////\r\n            // Sustituimos la siguienta instrucción por la siguiente condición :\r\n            //features = pushParseAndPop([],\r\n            //    this.FEATURE_COLLECTION_PARSERS, node,\r\n            //    objectStack, this);\r\n            if (node.namespaceURI === 'http://www.opengis.net/wfs') {\r\n                features = ol.xml.pushParseAndPop([],\r\n                    this.FEATURE_COLLECTION_PARSERS, node,\r\n                    objectStack, this);\r\n            } else {\r\n                this.FEATURE_COLLECTION_PARSERS[node.namespaceURI] =\r\n                    this.FEATURE_COLLECTION_PARSERS[node.namespaceURI] || this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.prototype.namespace];\r\n                features = ol.xml.pushParseAndPop(/*null*/[], // Cambiado null por [] porque si no, no crea el array de features\r\n                    this.FEATURE_COLLECTION_PARSERS, node,\r\n                    objectStack, this);\r\n            }\r\n            //////\r\n        } else if (localName == 'featureMembers' || localName == 'featureMember' || localName == 'member') {\r\n            const context = objectStack[0];\r\n            let featureType = context['featureType'];\r\n            let featureNS = context['featureNS'];\r\n            const prefix = 'p';\r\n            const defaultPrefix = 'p0';\r\n            if (/*!featureType && */node.childNodes) {\r\n                featureType = [], featureNS = {};\r\n                for (let i = 0, ii = node.childNodes.length; i < ii; ++i) {\r\n                    const child = node.childNodes[i];\r\n                    if (child.nodeType === 1) {\r\n                        const ft = child.nodeName.split(':').pop();\r\n                        if (featureType.indexOf(ft) === -1) {\r\n                            let key = '';\r\n                            let count = 0;\r\n                            const uri = child.namespaceURI;\r\n                            for (let candidate in featureNS) {\r\n                                if (featureNS[candidate] === uri) {\r\n                                    key = candidate;\r\n                                    break;\r\n                                }\r\n                                ++count;\r\n                            }\r\n                            if (!key) {\r\n                                key = prefix + count;\r\n                                featureNS[key] = uri;\r\n                            }\r\n                            featureType.push(key + ':' + ft);\r\n                        }\r\n                    }\r\n                }\r\n                if (localName != 'featureMember') {\r\n                    // recheck featureType for each featureMember\r\n                    context['featureType'] = featureType;\r\n                    context['featureNS'] = featureNS;\r\n                }\r\n            }\r\n            if (typeof featureNS === 'string') {\r\n                const ns = featureNS;\r\n                featureNS = {};\r\n                featureNS[defaultPrefix] = ns;\r\n            }\r\n            /** @type {Object<string, Object<string, import(\"../xml.js\").Parser>>} */\r\n            const parsersNS = {};\r\n            const featureTypes = Array.isArray(featureType) ? featureType : [featureType];\r\n            for (let p in featureNS) {\r\n                /** @type {Object<string, import(\"../xml.js\").Parser>} */\r\n                const parsers = {};\r\n                for (let i = 0, ii = featureTypes.length; i < ii; ++i) {\r\n                    const featurePrefix = featureTypes[i].indexOf(':') === -1 ?\r\n                        defaultPrefix : featureTypes[i].split(':')[0];\r\n                    if (featurePrefix === p) {\r\n                        parsers[featureTypes[i].split(':').pop()] =\r\n                            (localName == 'featureMembers') ?\r\n                                ol.xml.makeArrayPusher(this.readFeatureElement, this) :\r\n                                ol.xml.makeReplacer(this.readFeatureElement, this);\r\n                    }\r\n                }\r\n                parsersNS[featureNS[p]] = parsers;\r\n            }\r\n            if (localName == 'featureMember') {\r\n                features = ol.xml.pushParseAndPop(undefined, parsersNS, node, objectStack);\r\n            } else {\r\n                features = ol.xml.pushParseAndPop([], parsersNS, node, objectStack);\r\n            }\r\n        }\r\n        if (features === null) {\r\n            features = [];\r\n        }\r\n        return features;\r\n    };\r\n\r\n    ol.proj.proj4.register(proj4);\r\n    // OpenLayers usa para las proyecciones geográficas un valor ol.proj.METERS_PER_UNIT[ol.proj.Units.DEGREES], calculado con una esfera, salvo\r\n    // EPSG:4326, en la que usa ol.proj.EPSG4326.METERS_PER_UNIT, calculado con el geoide. Esto hace que las proyecciones en EPSG:4258 salgan desplazadas,\r\n    // pese a que para todos los efectos son iguales a las EPSG:4326. Para evitar eso, introducimos en las 4258 el valor ol.proj.EPSG4326.METERS_PER_UNIT.\r\n    ol.proj.get('EPSG:4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n    ol.proj.get('urn:ogc:def:crs:EPSG::4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n    ol.proj.get('http://www.opengis.net/gml/srs/epsg.xml#4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n\r\n    // Reescribimos la obtención de proyección para que soporte códigos tipo EPSG:X, urn:ogc:def:crs:EPSG::X y http://www.opengis.net/gml/srs/epsg.xml#X\r\n    ol.proj.oldGet = ol.proj.get;\r\n    ol.proj.get = function (projectionLike) {\r\n        if (typeof projectionLike === 'string') {\r\n            projectionLike = projectionLike.trim();\r\n            TC.loadProjDef({ crs: projectionLike, sync: true });\r\n        }\r\n        return ol.proj.oldGet.call(this, projectionLike);\r\n    };\r\n\r\n    // Reescritura de código para transformar las geometrías de getFeatureInfo que están en un CRS distinto\r\n    ol.format.GMLBase.prototype.readGeometryElement = function (node, objectStack) {\r\n        var context = /** @type {Object} */ (objectStack[0]);\r\n        context['srsName'] = node.firstElementChild.getAttribute('srsName');\r\n        context['srsDimension'] = node.firstElementChild.getAttribute('srsDimension');\r\n        /** @type {ol.geom.Geometry} */\r\n\r\n        // Parche para poder leer coordenadas en EPSG:4326 con orden incorrecto (las crea QGIS, por ejemplo)\r\n        if (this instanceof ol.format.GML2CRS84 || this instanceof ol.format.GML3CRS84) {\r\n            if (context.srsName !== 'EPSG:4326' || !context.srsName) {\r\n                throw new Error(\"Conflicto de CRS\");\r\n            }\r\n        }\r\n        if (!context.srsName) {\r\n            context.srsName = this.srsName;\r\n        }\r\n        context.dataProjection = ol.proj.get(context.srsName);\r\n        const geometry = ol.xml.pushParseAndPop(null,\r\n            this.GEOMETRY_PARSERS, node, objectStack, this);\r\n        if (geometry) {\r\n            return /** @type {ol.geom.Geometry} */ (\r\n                ol.format.Feature.transformWithOptions(geometry, false, context));\r\n        } else {\r\n            return undefined;\r\n        }\r\n    };\r\n\r\n    const ONLY_WHITESPACE_RE = /^[\\s\\xa0]*$/;\r\n\r\n    // Reescritura de código para hacerlo compatible con GML generado por inspire:\r\n    // No se puede considerar geometría cualquier cosa que tenga elementos anidados.\r\n    ol.format.GMLBase.prototype.readFeatureElementInternal = function (node, objectStack, asFeature) {\r\n        let geometryName;\r\n        const values = {};\r\n        for (let n = node.firstElementChild; n; n = n.nextElementSibling) {\r\n            let value;\r\n            const localName = n.localName;\r\n            // first, check if it is simple attribute\r\n            if (n.childNodes.length === 0\r\n                || (n.childNodes.length === 1 && (n.firstChild.nodeType === 3 || n.firstChild.nodeType === 4))) {\r\n                value = ol.xml.getAllTextContent(n, false);\r\n                if (ONLY_WHITESPACE_RE.test(value)) {\r\n                    value = undefined;\r\n                }\r\n            } else {\r\n                if (asFeature) {\r\n                    //if feature, try it as a geometry\r\n                    value = this.readGeometryElement(n, objectStack);\r\n                }\r\n                if (!value) { //if not a geometry or not a feature, treat it as a complex attribute\r\n                    value = this.readFeatureElementInternal(n, objectStack, false);\r\n                } else if (localName !== 'boundedBy' && localName !== 'referencePoint') {\r\n                    // boundedBy is an extent and must not be considered as a geometry\r\n                    // flacunza: Tampoco referencePoint\r\n                    geometryName = localName;\r\n                }\r\n            }\r\n\r\n            if (values[localName]) {\r\n                if (!(values[localName] instanceof Array)) {\r\n                    values[localName] = [values[localName]];\r\n                }\r\n                values[localName].push(value);\r\n            } else {\r\n                values[localName] = value;\r\n            }\r\n\r\n            const len = n.attributes.length;\r\n            if (len > 0) {\r\n                values[localName] = { _content_: values[localName] };\r\n                for (let i = 0; i < len; i++) {\r\n                    const attName = n.attributes[i].name;\r\n                    values[localName][attName] = n.attributes[i].value;\r\n                }\r\n            }\r\n        }\r\n        if (!asFeature) {\r\n            return values;\r\n        } else {\r\n            const feature = new ol.Feature(values);\r\n            if (geometryName) {\r\n                feature.setGeometryName(geometryName);\r\n            }\r\n            const fid = node.getAttribute('fid') ||\r\n                node.getAttributeNS(this.namespace, 'id');\r\n            if (fid) {\r\n                feature.setId(fid);\r\n            }\r\n            return feature;\r\n        }\r\n    };\r\n\r\n    ol.interaction.DragAndDrop.prototype.tryReadFeatures_ = function tryReadFeatures_(format, text, options) {\r\n        let features;\r\n        try {\r\n            features = format.readFeatures(text, options);\r\n        } catch (e) {\r\n            return null;\r\n        }\r\n        if (features && features.length && features.some(f => !!f.getGeometry())) {\r\n            return features;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    //////////////////////// end ol patches\r\n\r\n    const getRGBA = function (color, opacity) {\r\n        var result;\r\n        if (color) {\r\n            result = ol.color.asArray(color);\r\n            result = result.slice();\r\n            if (opacity !== undefined) {\r\n                result[3] = opacity;\r\n            }\r\n        }\r\n        else {\r\n            result = [0, 0, 0, 1];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Obtiene el objeto de opciones de una vista que restringe los niveles de zoom activos sobre el mapa dependiendo de las opciones definidas sobre\r\n     * el mapa base activo.\r\n     */\r\n    var getResolutionOptions = function (mapWrap, layer) {\r\n        var view = mapWrap.map.getView();\r\n        var prevRes = view.getResolution();\r\n\r\n        var pms = {\r\n            projection: view.getProjection(),\r\n            center: view.getCenter(),\r\n            resolution: prevRes,\r\n            enableRotation: false\r\n        };\r\n\r\n        if (mapWrap.parent.maxExtent) {\r\n            pms.extent = mapWrap.parent.maxExtent;\r\n        }\r\n\r\n        // GLS 06/03/2019 Corregimos bug 24832, si el mapa de fondo es el mapa en blanco, asignamos las resoluciones del mapa de fondo actual\r\n        var layerForResolutions = layer;\r\n        if (layer.type === TC.Consts.layerType.VECTOR && mapWrap.parent.getBaseLayer()) {\r\n            layerForResolutions = mapWrap.parent.getBaseLayer();\r\n        }\r\n\r\n        var res = layerForResolutions.getResolutions ? layerForResolutions.getResolutions() : [];\r\n        var maxRes;\r\n        var minRes;\r\n\r\n        if (res && res.length) {\r\n            maxRes = layerForResolutions.maxResolution || res[0];\r\n            minRes = layerForResolutions.minResolution || res[res.length - 1];\r\n\r\n            var minResIx = res.indexOf(minRes);\r\n            var maxResIx = res.indexOf(maxRes);\r\n\r\n            pms.resolutions = res.slice(maxResIx, minResIx + 1);\r\n        }\r\n        else {\r\n            maxRes = layerForResolutions.maxResolution;\r\n            minRes = layerForResolutions.minResolution;\r\n        }\r\n        if (minRes) {\r\n            pms.minResolution = minRes;\r\n            if (prevRes < minRes) {\r\n                pms.resolution = minRes;\r\n            }\r\n        }\r\n        if (maxRes) {\r\n            pms.maxResolution = maxRes;\r\n            if (prevRes > maxRes) {\r\n                pms.resolution = maxRes;\r\n            }\r\n        }\r\n\r\n        return pms;\r\n    };\r\n\r\n\r\n    TC.wrap.Map.prototype.setMap = function () {\r\n        var self = this;\r\n        var center = [\r\n            (self.parent.initialExtent[0] + self.parent.initialExtent[2]) / 2,\r\n            (self.parent.initialExtent[1] + self.parent.initialExtent[3]) / 2\r\n        ];\r\n\r\n        var proj4Obj = proj4(self.parent.crs);\r\n        var addEquivalentProjections = function () {\r\n            // Añadimos proyecciones equivalentes y transformaciones necesarias.\r\n            var crsCode = self.parent.crs.substr(self.parent.crs.lastIndexOf(':') + 1);\r\n\r\n            var projOptions = {\r\n                units: proj4Obj.oProj.units,\r\n                global: true\r\n            };\r\n\r\n            var equivalentProjections = [];\r\n            if (crsCode !== '4326') { // Este código ya está metido, no lo machacamos\r\n                projOptions.code = 'EPSG:' + crsCode;\r\n                equivalentProjections.push(new ol.proj.Projection(projOptions));\r\n                projOptions.code = 'urn:ogc:def:crs:EPSG::' + crsCode;\r\n                equivalentProjections.push(new ol.proj.Projection(projOptions));\r\n\r\n                ol.proj.addEquivalentProjections(equivalentProjections);\r\n            }\r\n            //var doTransform = function (fn, input, opt_output, opt_dimension) {\r\n            //    var result = [];\r\n            //    var dimension = opt_dimension || 2;\r\n            //    for (var i = 0; i < input.length; i += dimension) {\r\n            //        var transformed = Array.prototype.slice.call(fn(input.slice(i, i + dimension)));\r\n            //        if (dimension === 3 || dimension === 4) {\r\n            //            transformed = transformed.slice(0, 2).concat(input.slice(i + 2, (i + 2) + (dimension - 2)));\r\n            //        }\r\n\r\n            //        result = result.concat(transformed);\r\n            //    }\r\n            //    if (Array.isArray(opt_output)) {\r\n            //        opt_output.length = 0;\r\n            //        for (var i = 0; i < result.length; i++) {\r\n            //            opt_output[i] = result[i];\r\n            //        }\r\n            //        result = opt_output;\r\n            //    }\r\n            //    return result;\r\n            //};\r\n            //var fromEPSG4326 = function (input, opt_output, opt_dimension) {\r\n            //    return doTransform(proj4Obj.forward, input, opt_output, opt_dimension);\r\n            //};\r\n            //var toEPSG4326 = function (input, opt_output, opt_dimension) {\r\n            //    return doTransform(proj4Obj.inverse, input, opt_output, opt_dimension);\r\n            //};\r\n\r\n            ol.proj.proj4.register(proj4);\r\n\r\n            //ol.proj.addEquivalentTransforms(\r\n            //    ol.proj.EPSG4326.PROJECTIONS,\r\n            //    equivalentProjections,\r\n            //    fromEPSG4326,\r\n            //    toEPSG4326);\r\n        };\r\n\r\n        addEquivalentProjections();\r\n\r\n        var projOptions = {\r\n            code: self.parent.crs,\r\n            units: proj4Obj.oProj.units\r\n        };\r\n        if (self.parent.crs === 'EPSG:4326') {\r\n            projOptions.axisOrientation = 'neu';\r\n        }\r\n        var projection = new ol.proj.Projection(projOptions);\r\n\r\n        var interactions = ol.interaction.defaults({ constrainResolution: true });\r\n\r\n        var viewOptions = {\r\n            projection: projection,\r\n            center: center,\r\n            enableRotation: false\r\n        };\r\n        const extentForResolution = self.parent.maxExtent || self.parent.initialExtent;\r\n        viewOptions.extent = extentForResolution;\r\n        var rect = self.parent.div.getBoundingClientRect();\r\n        var dx = extentForResolution[2] - extentForResolution[0];\r\n        var dy = extentForResolution[3] - extentForResolution[1];\r\n        if (rect.width / rect.height > dx / dy) {\r\n            viewOptions.resolution = dx / rect.width;\r\n        }\r\n        else {\r\n            viewOptions.resolution = dy / rect.height;\r\n        }\r\n\r\n        self.map = new ol.Map({\r\n            target: self.parent.div,\r\n            view: new ol.View(viewOptions),\r\n            controls: [],\r\n            interactions: interactions,\r\n            pixelRatio: 1 /* 08/02/2019 GLS: \r\n            Establecemos el pixelRatio siempre a uno, porque OL sólo atiende al valor al principio, \r\n            si después se hace zoom in/out del navegador, OL no atiende el cambio lo que provoca que el mapa se vea borroso,\r\n            click se sitúa mal, popup se sitúa entre otros efectos.\r\n            Lo gestionamos nosotros hasta que lo soporten del todo. Relacionado con las tareas/bugs:\r\n                Bug 25976:Mapa situación en blanco\r\n                Bug 25954:Canvas en blanco con zoom mayor al 100%\r\n                Bug 23855:Mapa de situación se muestra en blanco\r\n            */\r\n        });\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            // Parche para corregir https://github.com/openlayers/openlayers/issues/2904\r\n            // saben que tienen un bug cuando se trabaja sobre un mapa con zoom\r\n            self.map.getEventPixel = function (event) {\r\n                var viewportPosition = this.viewport_.getBoundingClientRect();\r\n                var eventPosition = event.changedTouches ? event.changedTouches[0] : event;\r\n                eventPosition = eventPosition.clientX ? eventPosition : (eventPosition.pointerEvent ? eventPosition.pointerEvent : eventPosition);\r\n                return [\r\n                    (eventPosition.clientX - viewportPosition.left) * window.devicePixelRatio,\r\n                    (eventPosition.clientY - viewportPosition.top) * window.devicePixelRatio\r\n                ];\r\n            };\r\n        }\r\n\r\n        self.map._wrap = self;\r\n        self._promise = Promise.resolve(self.map);\r\n\r\n        // mantenemos el ancho y alto del canvas en números enteros\r\n        self.manageSize.call(self.map);\r\n\r\n        // Para evitar estiramientos en canvas\r\n        var updateSize = function () {\r\n            self.updateSize();\r\n        };\r\n        //if (window.ResizeObserver) {\r\n        //    self.parent.loaded(function () {\r\n        //        const resizeObserver = new ResizeObserver(updateSize);\r\n        //        resizeObserver.observe(self.parent.div);\r\n        //    });\r\n        //}\r\n        //self.map.getViewport().addEventListener(RESIZE, updateSize);\r\n        self.parent.one(TC.Consts.event.MAPLOAD, updateSize);\r\n\r\n        self.map.on(SINGLECLICK, function (e) {\r\n\r\n            if (self.parent.view === TC.Consts.view.PRINTING) {\r\n                return;\r\n            }\r\n\r\n            self.parent.workLayers.forEach(function (wl) {\r\n                delete wl._noFeatureClicked;\r\n            });\r\n            var featuresInLayers = self.parent.workLayers.map(function () {\r\n                return false;\r\n            });\r\n            self.map.forEachFeatureAtPixel(e.pixel,\r\n                function (feature, layer) {\r\n                    if (feature._wrap && feature._wrap.parent.showsPopup) {\r\n                        for (var i = 0; i < self.parent.workLayers.length; i++) {\r\n                            var wl = self.parent.workLayers[i];\r\n                            if (wl.wrap.layer === layer) {\r\n                                featuresInLayers[i] = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        self.parent.trigger(TC.Consts.event.FEATURECLICK, { feature: feature._wrap.parent });\r\n                        return feature;\r\n                    }\r\n                },\r\n                {\r\n                    hitTolerance: hitTolerance\r\n                });\r\n            for (var i = 0; i < featuresInLayers.length; i++) {\r\n                if (!featuresInLayers[i]) {\r\n                    self.parent.trigger(TC.Consts.event.NOFEATURECLICK, { layer: self.parent.workLayers[i] });\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n        // GLS: 13/02/2019 cambiamos el orden de las suscripciones a eventos de cambio de resolución y moveend\r\n        // para gestionar el borrado del estado inicial. Si no lo hacemos el cambio al extent inicial se registra como evento de usuario\r\n        // porque la carga inicial del mapa con promesas nativas es más rápido que antes.\r\n        // Bug:26001 Borrar estado inicial al entrar\r\n        const addMoveEndListener = function () {\r\n            self.map.on(MOVEEND, function () {\r\n                self.parent.trigger(TC.Consts.event.ZOOM);\r\n            });\r\n        };\r\n        var olView = self.map.getView();\r\n        olView.on('change:resolution', function () {\r\n            if (!self.map.hasListener(MOVEEND)) {\r\n                self.map.once(MOVEEND, function () {\r\n                    addMoveEndListener();\r\n                });\r\n            }\r\n\r\n            self.parent.trigger(TC.Consts.event.BEFOREZOOM);\r\n        }, self.parent);\r\n\r\n        const onChangeView = function () {\r\n            if (!self.map.hasListener(MOVEEND)) {\r\n                self.map.un('change:view', onChangeView);\r\n                addMoveEndListener();\r\n            }\r\n        };\r\n        self.map.on('change:view', onChangeView);\r\n\r\n        /**\r\n         * Restringe los niveles de zoom activos sobre el mapa dependiendo de las opciones definidas sobre\r\n         * el mapa base activo.\r\n         */\r\n        var limitZoomLevels = function (layer) {\r\n            var pms = getResolutionOptions(self, layer);\r\n\r\n            var view = new ol.View(pms);\r\n            self.map.setView(view);\r\n            self.map.render();\r\n        };\r\n\r\n        self.parent.on(TC.Consts.event.BEFOREBASELAYERCHANGE, function (evt) {\r\n            // Solo se limitan las resoluciones cuando estamos en un CRS por defecto, donde no se repixelan teselas\r\n            if (self.parent.crs === self.parent.options.crs && !self.parent.on3DView && evt.newLayer.type !== TC.Consts.layerType.VECTOR) {\r\n                const oldResolutions = evt.oldLayer.getResolutions();\r\n                let modelLayer = evt.newLayer;\r\n                if (!evt.newLayer.getResolutions() && oldResolutions) {\r\n                    // Si la capa nueva no tiene resoluciones y la vieja sí, mantenemos las resoluciones anteriores.\r\n                    // Esto evita que OpenLayers se invente los niveles de zoom y las resoluciones para la capa dinámica.\r\n                    modelLayer = evt.oldLayer;\r\n                }\r\n                self.parent.one(TC.Consts.event.BASELAYERCHANGE, function (e) {\r\n                    limitZoomLevels(modelLayer);\r\n                });\r\n            }\r\n        });\r\n        self.parent.on(TC.Consts.event.MAPLOAD, function (e) {\r\n            limitZoomLevels(self.parent.getBaseLayer());\r\n        });\r\n\r\n        const olMapViewport = self.map.getViewport();\r\n\r\n        olMapViewport.addEventListener(TC.Consts.event.MOUSEMOVE, function (e) {\r\n            var hit = false;\r\n\r\n            if (!self.parent.activeControl || !self.parent.activeControl.isExclusive()) {\r\n\r\n                if (self.parent.view === TC.Consts.view.PRINTING) {\r\n                    return;\r\n                }\r\n\r\n                var pixel = self.map.getEventPixel(e);\r\n                hit = self.map.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                    var result = true;\r\n                    if (feature._wrap && !feature._wrap.parent.showsPopup && !feature._wrap.parent.options.selectable) {\r\n                        result = false;\r\n                    }\r\n\r\n                    if (result && feature._wrap) {\r\n                        self.parent.trigger(TC.Consts.event.FEATUREOVER, {\r\n                            feature: feature._wrap.parent\r\n                        });\r\n                    }\r\n\r\n                    return result;\r\n                }, { hitTolerance: hitTolerance });\r\n            }\r\n\r\n            if (hit) {\r\n                olMapViewport.style.cursor = 'pointer';\r\n            } else {\r\n                olMapViewport.style.cursor = '';\r\n                //self.parent.trigger(TC.Consts.event.FEATUREOUT);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.updateSize = function () {\r\n        this.map.updateSize();\r\n    };\r\n\r\n    var getMetersPerUnit = function (proj, extentInDegrees) {\r\n        var units = proj.getUnits();\r\n        if (!units || units === ol.proj.Units.DEGREES) {\r\n            return TC.Util.getMetersPerDegree(extentInDegrees);\r\n        }\r\n        return ol.proj.METERS_PER_UNIT[units];\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getMetersPerUnit = function () {\r\n        var self = this;\r\n        return getMetersPerUnit(ol.proj.get(self.parent.crs), self.getExtent());\r\n    };\r\n\r\n    var getUnitRatio = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var defaultCrs = self.parent.options.crs || TC.Cfg.crs;\r\n        var defaultProj = ol.proj.get(defaultCrs);\r\n        var newProj = ol.proj.get(options.crs);\r\n        return getMetersPerUnit(newProj, options.extentInDegrees) / getMetersPerUnit(defaultProj, options.extentInDegrees);\r\n    };\r\n\r\n    var normalizeProjection = function (options) {\r\n        var result;\r\n        if (options.axisOrientation) {\r\n            result = new ol.proj.Projection({\r\n                code: options.crs,\r\n                axisOrientation: options.axisOrientation\r\n            });\r\n        }\r\n        else {\r\n            result = ol.proj.get(options.crs);\r\n        }\r\n        if (!result.getUnits()) {\r\n            result.units_ = ol.proj.Units.DEGREES;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const baseLayer = options.baseLayer || self.parent.baseLayer;\r\n        var extent;\r\n        if (options.extent) {\r\n            extent = options.extent;\r\n        }\r\n        else {\r\n            extent = ol.proj.transformExtent(self.getExtent(), self.parent.crs, options.crs);\r\n        }\r\n        const extentInDegrees = ol.proj.transformExtent(extent, options.crs, 'EPSG:4326');\r\n        const unitRatio = getUnitRatio.call(self, {\r\n            crs: options.crs,\r\n            extentInDegrees: extentInDegrees\r\n        });\r\n        const projection = normalizeProjection(options);\r\n        const oldView = self.map.getView();\r\n        const viewOptions = {\r\n            projection: projection,\r\n            enableRotation: false\r\n        };\r\n        const resolutions = baseLayer.getResolutions();\r\n\r\n        if (resolutions && resolutions.length) {\r\n            viewOptions.resolutions = resolutions;\r\n        }\r\n        else {\r\n            viewOptions.minZoom = oldView.getMinZoom();\r\n            viewOptions.maxZoom = oldView.getMaxZoom();\r\n            const minResolution = baseLayer.wrap.layer.getMinResolution();\r\n            const maxResolution = baseLayer.wrap.layer.getMaxResolution();\r\n            var transformFactor = 1;\r\n            if (minResolution === 0 || maxResolution === Number.POSITIVE_INFINITY) {\r\n                const oldUnitRatio = getUnitRatio.call(self, {\r\n                    crs: self.parent.crs,\r\n                    extentInDegrees: extentInDegrees\r\n                });\r\n                transformFactor = oldUnitRatio / unitRatio;\r\n            }\r\n            if (minResolution === 0) {\r\n                viewOptions.minResolution = oldView.getMinResolution() * transformFactor;\r\n            }\r\n            else {\r\n                viewOptions.minResolution = minResolution;\r\n            }\r\n            if (maxResolution === Number.POSITIVE_INFINITY) {\r\n                viewOptions.maxResolution = oldView.getMaxResolution() * transformFactor;\r\n            }\r\n            else {\r\n                viewOptions.maxResolution = maxResolution;\r\n            }\r\n        }\r\n\r\n        // GLS: transformamos también el centro     \r\n        viewOptions.center = ol.proj.transform(self.getCenter(), self.parent.crs, options.crs);\r\n\r\n        var newView = new ol.View(viewOptions);\r\n        self.map.setView(newView);\r\n        self.parent.initialExtent = unitRatio !== 1 ? ol.proj.transformExtent(self.parent.initialExtent, self.parent.crs, options.crs) : self.parent.options.initialExtent;\r\n        if (self.parent.options.maxExtent) {\r\n            self.parent.options.maxExtent = self.parent.maxExtent = unitRatio !== 1 ? ol.proj.transformExtent(self.parent.maxExtent, self.parent.crs, options.crs) : self.parent.options.maxExtent;\r\n        }\r\n        newView.fit(extent, { nearest: true });\r\n    };\r\n\r\n    /*\r\n     *  insertLayer: inserts OpenLayers layer at index\r\n     *  Parameters: OpenLayers.Layer, number\r\n     */\r\n    TC.wrap.Map.prototype.insertLayer = function (olLayer, idx) {\r\n        var self = this;\r\n        var layers = self.map.getLayers();\r\n        var alreadyExists = false;\r\n        for (var i = 0; i < layers.getLength(); i++) {\r\n            if (layers.item(i) === olLayer) {\r\n                alreadyExists = true;\r\n                break;\r\n            }\r\n        }\r\n        if (alreadyExists) {\r\n            layers.remove(olLayer);\r\n            layers.insertAt(idx, olLayer);\r\n        }\r\n        else {\r\n            if (idx < 0) {\r\n                layers.push(olLayer);\r\n            }\r\n            else {\r\n                layers.insertAt(idx, olLayer);\r\n            }\r\n            // Solo se limitan las resoluciones cuando estamos en un CRS por defecto, donde no se repixelan teselas\r\n            var view = self.map.getView();\r\n            if (self.parent.crs === self.parent.options.crs) {\r\n                if (olLayer instanceof ol.layer.Tile) {\r\n                    var resolutions = olLayer.getSource().getResolutions();\r\n                    view.maxResolution_ = resolutions[0];\r\n                    view.minResolution_ = resolutions[resolutions.length - 1];\r\n                }\r\n            }\r\n            else {\r\n                // Cambiamos los límites de resolución de la capa a los de la vista. Esto lo hacemos porque su resolución está en otro CRS.\r\n                if (olLayer instanceof ol.layer.Tile) {\r\n                    olLayer.setMaxResolution(view.getMaxResolution());\r\n                    olLayer.setMinResolution(view.getMinResolution());\r\n                }\r\n            }\r\n\r\n            var wrap = olLayer._wrap;\r\n            var loadingTileCount = 0;\r\n\r\n            var beforeTileLoadHandler = function (e) {\r\n                wrap.parent.state = TC.Layer.state.LOADING;\r\n                if (loadingTileCount <= 0) {\r\n                    loadingTileCount = 0;\r\n                    self.parent.trigger(TC.Consts.event.BEFORELAYERUPDATE, { layer: wrap.parent });\r\n                }\r\n                olLayer._loadingTileCount = olLayer._loadingTileCount + 1;\r\n            };\r\n            if (wrap.parent.state === TC.Layer.state.LOADING && wrap.parent.isRaster()) {\r\n                beforeTileLoadHandler();\r\n            }\r\n            wrap.$events.on(TC.Consts.event.BEFORETILELOAD, beforeTileLoadHandler);\r\n\r\n            wrap.$events.on(TC.Consts.event.TILELOAD + ' ' + TC.Consts.event.TILELOADERROR, function (e) {\r\n                loadingTileCount = loadingTileCount - 1;\r\n                if (loadingTileCount <= 0) {\r\n                    loadingTileCount = 0;\r\n                    wrap.parent.state = TC.Layer.state.IDLE;\r\n                    self.parent.trigger(TC.Consts.event.LAYERUPDATE, { layer: wrap.parent });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.removeLayer = function (olLayer) {\r\n        this.map.removeLayer(olLayer);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getLayerCount = function () {\r\n        return this.map.getLayerGroup().getLayers().getLength();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.indexOfFirstVector = function () {\r\n        var result = -1;\r\n        this.map.getLayerGroup().getLayers().forEach(function (l, i) {\r\n            if (l instanceof ol.layer.Vector && result === -1) {\r\n                result = i;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getLayerIndex = function (olLayer) {\r\n        var result = -1;\r\n        this.map.getLayerGroup().getLayers().forEach(function (elm, idx) {\r\n            if (elm === olLayer) {\r\n                result = idx;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setLayerIndex = function (olLayer, index) {\r\n        var layers = this.map.getLayers();\r\n        var list = layers.getArray();\r\n        var ix = list.indexOf(olLayer);\r\n\r\n        if (ix > -1 && ix != index) {\r\n            this.map.removeLayer(olLayer);\r\n            this.insertLayer(olLayer, index);\r\n            //layers.setAt(index, olLayer);\r\n        }\r\n        else {\r\n            //no está el layer, así que no hago nada\r\n        }\r\n\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setBaseLayer = function (olLayer) {\r\n        var self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var setLayer = function (curBl) {\r\n                // GLS: si se llega después de una animación el valor de self.parent.getBaseLayer() ya es el definitivo y no el actual lo que provoca efectos indeseados. \r\n                // ir a línea 1313: paso como parámetro el baseLayer actual en el caso de animación.\r\n                var curBl = curBl || self.parent.getBaseLayer();\r\n                if (curBl) {\r\n                    self.map.removeLayer(curBl.wrap.layer);\r\n                    if (olLayer instanceof ol.layer.Image) { // Si es imagen no teselada\r\n                        olLayer._wrap.setProjection({\r\n                            crs: self.parent.crs\r\n                        });\r\n                    }\r\n\r\n                    if (olLayer._wrap.parent.type === TC.Consts.layerType.WMTS) {\r\n                        var layerProjectionOptions = { crs: self.parent.crs, oldCrs: olLayer.getSource().getProjection().getCode() };\r\n\r\n                        if (layerProjectionOptions.oldCrs !== layerProjectionOptions.crs) {\r\n                            olLayer._wrap.parent.setProjection(layerProjectionOptions);\r\n                        }\r\n                    }\r\n\r\n                    //if (olLayer instanceof ol.layer.Tile) { // Si es imagen teselada\r\n                    //    const view = self.map.getView();\r\n                    //    const resolutions = olLayer.getSource().getResolutions();\r\n                    //    if (resolutions) {\r\n                    //        view.options_.resolutions = resolutions;\r\n                    //        view.applyOptions_(view.options_);\r\n                    //    }\r\n                    //}\r\n                }\r\n                self.insertLayer(olLayer, 0);\r\n                self.map.getControls().forEach(function (ctl) {\r\n                    if (ctl instanceof ol.control.ZoomSlider) {\r\n                        ctl.initSlider_();\r\n                    }\r\n                });\r\n                resolve();\r\n            };\r\n\r\n            // Toda esta lógica antes de llamar a setLayer() es para hacer un zoom a la nueva resolución\r\n            // cuando la nueva capa no llega a la resolución actual\r\n            var viewOptions = getResolutionOptions(self, olLayer._wrap.parent);\r\n            var view = self.map.getView();\r\n            var currentResolution = view.getResolution();\r\n            if (viewOptions.resolutions) {\r\n                //buscamos la nueva resolución: o una que sea similar a la actual dentro de los márgenes admitidos, o la inmediata superior\r\n                var newRes = viewOptions.resolutions\r\n                    .sort(function (a, b) { return a - b })\r\n                    .reduce(function (prev, elm) {\r\n                        if (prev === 0 &&\r\n                            (elm > currentResolution || Math.abs(1 - (currentResolution / elm)) < self.parent.options.maxResolutionError)) {\r\n                            return elm;\r\n                        }\r\n                        return prev;\r\n                    }, 0);\r\n                if (newRes !== currentResolution) {\r\n                    if (self.parent.isLoaded) {\r\n                        view.animate({ resolution: newRes, duration: TC.Consts.ZOOM_ANIMATION_DURATION }, setLayer.bind(self, self.parent.getBaseLayer()));\r\n                    }\r\n                    else { // Primera carga, no animamos\r\n                        view.setResolution(newRes);\r\n                        setLayer();\r\n                    }\r\n                }\r\n                else {\r\n                    setLayer();\r\n                }\r\n            }\r\n            else {\r\n                setLayer();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setExtent = function (extent, options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        const applyExtent = function (view, mapSize, resolve, reject) {\r\n            var res = view.getResolutionForExtent(extent, mapSize);\r\n            // URI: Esta logica está fusilada de la función fit de un objeto view de OL3\r\n            if (view.constrainResolution) {\r\n                var constrainedResolution = view.constrainResolution(res, 0, 0);\r\n                if (constrainedResolution < res) {\r\n                    if (constrainedResolution / res < TC.Consts.EXTENT_TOLERANCE) {\r\n                        constrainedResolution = view.constrainResolution(\r\n                            constrainedResolution, -1, 0);\r\n                    }\r\n                }\r\n                res = constrainedResolution;\r\n            }\r\n\r\n            // flacunza: No animamos si la duración va a ser 0, porque a veces el zoom no se completa\r\n            // GLS: antes de resolver la promesa validamos si existe animación\r\n            // URI: si la animacion no existe ponemos duracion 0\r\n            // flacunza: en caso de que animate=undefined, se anima\r\n            const center = [((extent[0] + extent[2]) / 2), ((extent[1] + extent[3]) / 2)];\r\n            if (Number.isNaN(center[0]) || Number.isNaN(center[1])) {\r\n                reject(new Error(\"Extent not valid: \" + extent));\r\n            }\r\n            else {\r\n                if (options.animate === void (0) || options.animate) {\r\n                    view.animate({\r\n                        resolution: res,\r\n                        center: center,\r\n                        duration: TC.Consts.ZOOM_ANIMATION_DURATION\r\n                    }, resolve);\r\n                }\r\n                else {\r\n                    view.setCenter(center);\r\n                    view.setResolution(res);\r\n                    resolve();\r\n                }\r\n            }\r\n        };\r\n\r\n        const setPromise = function (extent) {\r\n            self._setExtentPromise = new Promise(function (resolve, reject) {\r\n                // Timeout porque OL3 no tiene evento featuresadded, por tanto cuando se activa map.options.zoomToMarkers\r\n                // se lanza un setExtent por marcador. El timeout evita ejecuciones a lo tonto.\r\n                clearTimeout(self._timeout);\r\n                self._timeout = setTimeout(function () {\r\n                    var mapSize = self.map.getSize();\r\n                    var view = self.map.getView();\r\n\r\n                    if (self.parent.baseLayer) {\r\n                        self.parent.baseLayer.wrap.getLayer().then(function (olLayer) {\r\n                            // Todo esto para evitar que haga más zoom que el admisible por la capa base\r\n                            const res = view.getResolutionForExtent(extent, mapSize);\r\n                            const resolutions = self.getResolutions();\r\n                            const maxZoom = view.getMaxZoom();\r\n                            if (maxZoom < resolutions.length - 1) {\r\n                                resolutions.length = Math.round(maxZoom + 1); // en 3D puede llegar un valor no entero, no sé reproducirlo\r\n                            }\r\n\r\n                            if (resolutions.length > 0) {\r\n                                var minRes = Math.min.apply(self, resolutions);\r\n                                if (minRes > res) {\r\n                                    var factor = 0.5 * (minRes / res - 1);\r\n                                    var dx = ol.extent.getWidth(extent) * factor;\r\n                                    var dy = ol.extent.getHeight(extent) * factor;\r\n                                    extent = extent.slice(0);\r\n                                    extent[0] = extent[0] - dx;\r\n                                    extent[1] = extent[1] - dy;\r\n                                    extent[2] = extent[2] + dx;\r\n                                    extent[3] = extent[3] + dy;\r\n                                }\r\n                            }\r\n\r\n                            applyExtent(view, mapSize, resolve, reject);\r\n\r\n                        });\r\n                    }\r\n                    else {\r\n                        applyExtent(view, mapSize, resolve, reject);\r\n                    }\r\n                }, 50);\r\n            });\r\n        };\r\n        Promise.resolve(self._setExtentPromise).finally(function () {\r\n            setPromise(extent);\r\n        });\r\n\r\n        return self._setExtentPromise;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getExtent = function () {\r\n        return this.map.getView().calculateExtent(this.map.getSize());\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setCenter = function (coords, options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const callback = function () {\r\n                resolve();\r\n            };\r\n\r\n            const opts = options || {};\r\n            const view = self.map.getView();\r\n\r\n            if (opts.animate) {\r\n                view.animate({\r\n                    center: coords, duration: TC.Consts.ZOOM_ANIMATION_DURATION\r\n                }, callback);\r\n            }\r\n            else {\r\n                view.setCenter(coords);\r\n                resolve();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getCenter = function () {\r\n        return this.map.getView().getCenter();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getResolution = function () {\r\n        return this.map.getView().getResolution();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setResolution = async function (resolution) {\r\n        const olMap = await this.getMap();\r\n        olMap.getView().setResolution(resolution);\r\n        return resolution;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setRotation = function (rotation) {\r\n        this.getMap().then(function (olMap) {\r\n            olMap.getView().setRotation(rotation);\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getRotation = function () {\r\n        return this.map.getView().getRotation();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getResolutions = function () {\r\n        return this.map.getView().getResolutions() || [];\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getCoordinateFromPixel = function (xy) {\r\n        return this.map.getCoordinateFromPixel(xy);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getPixelFromCoordinate = function (coord) {\r\n        return this.map.getPixelFromCoordinate(coord);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getViewport = function (options) {\r\n        const self = this;\r\n        var result;\r\n        var opts = options || {\r\n        };\r\n        if (opts.synchronous) {\r\n            result = self.map.getViewport();\r\n        }\r\n        else {\r\n            result = new Promise(function (resolve, reject) {\r\n                self.getMap().then(function (olMap) {\r\n                    resolve(olMap.getViewport());\r\n                });\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getCanvas = function () {\r\n        const self = this;\r\n        return Array.from(self.parent.div.querySelectorAll('.ol-viewport canvas:not(.tc-ctl-ovmap canvas)'));\r\n    };\r\n\r\n    TC.wrap.Map.prototype.isNative = function (map) {\r\n        return map instanceof ol.Map;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.isGeo = function () {\r\n        var units = this.map.getView().getProjection().getUnits();\r\n        return !units || units === ol.proj.Units.DEGREES;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.addPopup = function (popupCtl) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var draggable = popupCtl.options.draggable === undefined || popupCtl.options.draggable;\r\n            TC.loadJS(\r\n                draggable && !window.Draggabilly,\r\n                [TC.apiLocation + TC.Consts.url.DRAGGABILLY],\r\n                function () {\r\n                    self.getMap().then(function (olMap) {\r\n                        if (!popupCtl.wrap.popup) {\r\n                            // No popups yet\r\n                            var popup = new ol.Overlay({\r\n                                element: popupCtl.popupDiv,\r\n                                positioning: ol.OverlayPositioning.BOTTOM_LEFT\r\n                            });\r\n                            olMap.addOverlay(popup);\r\n                            popupCtl.wrap.popup = popup;\r\n\r\n                            //popupCtl._firstRender.resolve();\r\n                            //popupCtl.trigger(TC.Consts.event.CONTROLRENDER);\r\n                            const olMapViewport = olMap.getViewport();\r\n\r\n                            if (draggable) {\r\n                                const container = popupCtl.popupDiv.parentElement;\r\n                                popupCtl.popupDiv.classList.add(TC.Consts.classes.DRAGGABLE);\r\n\r\n\r\n                                container.addEventListener('touchmove', function (e) {\r\n                                    var parent = e.target;\r\n                                    do {\r\n                                        if (parent.matches('.tc-ctl-finfo-layer-content')) {\r\n                                            e.stopPropagation();\r\n                                            break;\r\n                                        }\r\n                                        parent = parent.parentElement;\r\n                                    }\r\n                                    while (parent);\r\n                                }, { passive: true });\r\n\r\n                                // Tuneamos Draggabilly para que acepte excepciones a los asideros del elemento.\r\n                                const drag = new Draggabilly(container, {\r\n                                    not: 'th,td, td *,input,select,.tc-ctl-finfo-coords'\r\n                                });\r\n                                drag.handleEvent = function (event) {\r\n                                    const notSelector = this.options.not;\r\n                                    if (notSelector) {\r\n                                        let elm = event.target;\r\n                                        let isException = false;\r\n                                        while (elm && !isException) {\r\n                                            isException = elm.matches(notSelector);\r\n                                            elm = elm.parentElement;\r\n                                        }\r\n                                        if (isException) {\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                    Draggabilly.prototype.handleEvent.call(this, event);\r\n                                };\r\n                                drag.on('pointerDown', function (e, pointer) {\r\n                                    var bcr = e.target.getBoundingClientRect();\r\n                                    // Si estamos pulsando sobre una barra de scroll abortamos drag\r\n                                    if (bcr.left + e.target.clientWidth < pointer.pageX || bcr.top + e.target.clientHeight < pointer.pageY) {\r\n                                        drag._pointerCancel(e, pointer);\r\n                                        return false;\r\n                                    }\r\n                                });\r\n                                drag.on('dragStart', function (e, pointer) {\r\n                                    popupCtl.setDragging(true);\r\n                                    popupCtl._currentOffset = popup.getOffset();\r\n                                    if (popupCtl._previousContainerPosition) {\r\n                                        var mapSize = olMap.getSize();\r\n                                        popup.setPosition(olMap.getCoordinateFromPixel([popupCtl._previousContainerPosition[0], mapSize[1] - popupCtl._previousContainerPosition[1]]));\r\n                                        popupCtl._currentOffset = [0, 0];\r\n                                        popup.setOffset(popupCtl._currentOffset);\r\n                                        delete popupCtl._previousContainerPosition;\r\n                                    }\r\n                                    else {\r\n                                        popupCtl._currentOffset = popup.getOffset();\r\n                                    }\r\n                                });\r\n                                drag.on('dragEnd', function (e) {\r\n                                    popupCtl.setDragging(false);\r\n                                    var coord1 = olMap.getCoordinateFromPixel([0, 0]);\r\n                                    var coord2 = olMap.getCoordinateFromPixel(popup.getOffset());\r\n                                    var coordDelta = [coord2[0] - coord1[0], coord2[1] - coord1[1]];\r\n                                    var position = popup.getPosition();\r\n                                    popup.setPosition([position[0] + coordDelta[0], position[1] + coordDelta[1]]);\r\n                                    popup.setOffset([0, 0]);\r\n                                    popupCtl._currentOffset = [0, 0];\r\n\r\n                                    const containerRect = container.getBoundingClientRect();\r\n                                    popupCtl._previousContainerPosition = [containerRect.left, containerRect.bottom];\r\n                                });\r\n                                //drag.on('dragMove', function (e, pointer, moveVector) {\r\n                                //popup.setOffset([popupCtl._currentOffset[0] + moveVector.x, popupCtl._currentOffset[1] + moveVector.y]);\r\n                                //});\r\n                                //.drag(function (ev, dd) {\r\n                                //    if (!ev.buttons && !Modernizr.touch) { // Evitamos que se mantenga el drag si no hay botón pulsado (p.e. en IE pulsando una scrollbar)\r\n                                //        return false;\r\n                                //    }\r\n                                //    popup.setOffset([popupCtl._currentOffset[0] + dd.deltaX, popupCtl._currentOffset[1] + dd.deltaY]);\r\n                                //}, {\r\n                                //    not: 'th,td, td *,input,select,.tc-ctl-finfo-coords'\r\n                                //    })                                \r\n                            }\r\n\r\n                            const mouseMoveHandler = function (e) {\r\n                                const viewport = olMap.getViewport();\r\n                                var hit = false;\r\n                                if (!self.parent.activeControl || !self.parent.activeControl.isExclusive()) {\r\n                                    var pixel = olMap.getEventPixel(e);\r\n                                    hit = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                                        var result = true;\r\n                                        if (feature._wrap && !feature._wrap.parent.showsPopup) {\r\n                                            result = false;\r\n                                        }\r\n                                        return result;\r\n                                    },\r\n                                        {\r\n                                            hitTolerance: hitTolerance\r\n                                        });\r\n                                }\r\n                                if (hit) {\r\n                                    viewport.style.cursor = 'pointer';\r\n                                } else {\r\n                                    viewport.style.cursor = '';\r\n                                }\r\n                            };\r\n\r\n                            // change mouse cursor when over marker\r\n                            olMapViewport.removeEventListener(MOUSEMOVE, mouseMoveHandler);\r\n                            olMapViewport.addEventListener(MOUSEMOVE, mouseMoveHandler);\r\n                        }\r\n                    });\r\n                    resolve();\r\n                }\r\n            );\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.hidePopup = function (popupCtl) {\r\n        var self = this;\r\n        self.parent.currentFeature = null;\r\n        if (popupCtl.popupDiv) {\r\n            popupCtl.popupDiv.classList.remove(TC.Consts.classes.VISIBLE);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.manageSize = function () {\r\n        const self = this;\r\n\r\n        // Para controlar que el mapa no se vea borroso porque no encajan el width y height con los width y height de CSS\r\n        const manageSize = function (event) {\r\n            var pixelRatio = window.devicePixelRatio || 1;\r\n            var canvas = event.context.canvas;\r\n            var bounding = canvas.getBoundingClientRect();\r\n\r\n            var idealWidth = pixelRatio * bounding.width;\r\n            var idealHeight = pixelRatio * bounding.height;\r\n\r\n            if (idealWidth !== bounding.width || !Number.isInteger(idealWidth)) {\r\n                idealWidth = Math.round(idealWidth);\r\n            }\r\n\r\n            if (idealHeight !== bounding.height || !Number.isInteger(idealHeight)) {\r\n                idealHeight = Math.round(idealHeight);\r\n            }\r\n\r\n            if (idealWidth !== bounding.width || idealHeight !== bounding.height) {\r\n                const oldSize = event.target.getSize();\r\n                if (oldSize[0] != idealWidth || oldSize[1] != idealHeight) {\r\n                    var newSize = [idealWidth, idealHeight];\r\n                    event.target.setSize(newSize);\r\n                }\r\n            }\r\n        };\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            self.on(POSTCOMPOSE, manageSize);\r\n        }\r\n    };\r\n\r\n    var getFormatFromName = function (name, extractStyles) {\r\n        switch (name) {\r\n            case TC.Consts.layerType.KML:\r\n            case TC.Consts.mimeType.KML:\r\n            case TC.Consts.format.KMZ:\r\n                return new ol.format.KMLCustom({\r\n                    showPointNames: false,\r\n                    extractStyles: extractStyles !== undefined ? extractStyles : true\r\n                });\r\n            case TC.Consts.layerType.GPX:\r\n            case TC.Consts.mimeType.GPX:\r\n                return new ol.format.GPXCustom();\r\n            case TC.Consts.layerType.GEOJSON:\r\n            case TC.Consts.mimeType.GEOJSON:\r\n            case TC.Consts.mimeType.JSON:\r\n            case TC.Consts.format.JSON:\r\n                return new ol.format.GeoJSON();\r\n            case TC.Consts.format.GML2:\r\n                return new ol.format.GML2();\r\n            case TC.Consts.format.GML3:\r\n                return new ol.format.GML3();\r\n            case TC.Consts.format.GML32:\r\n                return new ol.format.GML32();\r\n            case TC.Consts.mimeType.GML:\r\n            case TC.Consts.format.GML:\r\n                return new ol.format.GML();\r\n            case TC.Consts.format.TOPOJSON:\r\n                return new ol.format.TopoJSON();\r\n            case TC.Consts.format.WKT:\r\n                return new ol.format.WKT();\r\n            default:\r\n                return null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.exportFeatures = function (features, options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var nativeStyle = createNativeStyle({\r\n            styles: self.parent.options.styles\r\n        });\r\n        var olFeatures = features.map(function (elm) {\r\n            var result = elm.wrap.feature.clone();\r\n            //URI:replicamos el id a la feature OL\r\n            result.id_ = elm.id;\r\n            // Si la feature no tiene estilo propio le ponemos el definido por la API\r\n            if (!result.getStyle()) {\r\n                result.setStyle(nativeStyle);\r\n            }\r\n            // Miramos si tiene texto, en cuyo caso la features se clona para no contaminar la feature orignal \r\n            // y al clon se le añade el texto como atributo (necesario para exportar etiquetas en KML y GPX)\r\n            const text = getNativeFeatureStyle(result).getText();\r\n            if (text) {\r\n                const name = text.getText();\r\n                if (name) {\r\n                    result.setProperties({\r\n                        name: text.getText()\r\n                    });\r\n                }\r\n            }\r\n            return result;\r\n        });        \r\n        var format = getFormatFromName(options.format);\r\n\r\n        if (format instanceof ol.format.KML) {\r\n            // KML no tiene estilo para puntos aparte del de icono. Para puntos sin icono creamos uno en SVG.\r\n            olFeatures = olFeatures\r\n                .map(function (feature) {\r\n                    const geom = feature.getGeometry();\r\n                    if (geom instanceof ol.geom.Point) {\r\n                        // Si el punto no tiene icono, creamos uno nuevo con un icono generado como data URI a partir del estilo\r\n                        var style = getNativeFeatureStyle(feature);\r\n                        const shape = style.getImage();\r\n                        if (shape instanceof ol.style.RegularShape) {\r\n                            const radius = shape.getRadius();\r\n                            const stroke = shape.getStroke();\r\n                            const strokeWidth = stroke.getWidth();\r\n                            const diameter = (2 * radius) + strokeWidth + 1;\r\n                            const position = diameter / 2;\r\n                            const canvas = document.createElement('canvas');\r\n                            canvas.width = diameter;\r\n                            canvas.height = diameter;\r\n                            const vectorContext = ol.render.toContext(canvas.getContext('2d'), {\r\n                                size: [diameter, diameter]\r\n                            });\r\n                            const text = style.getText();\r\n                            style = style.clone();\r\n                            style.setText(); // Quitamos el texto para que no salga en el canvas\r\n                            vectorContext.setStyle(style);\r\n                            vectorContext.drawGeometry(new ol.geom.Point([position, position]));\r\n                            const newFeature = new ol.Feature(geom);\r\n                            newFeature.setId(feature.getId());\r\n                            newFeature.setProperties(feature.getProperties());\r\n                            newFeature.setStyle(new ol.style.Style({\r\n                                image: new ol.style.Icon({\r\n                                    src: canvas.toDataURL('image/png')\r\n                                }),\r\n                                text: text\r\n                            }));\r\n                            return newFeature;\r\n                        }\r\n                    }\r\n                    return feature;\r\n                });\r\n            // KML no pone etiquetas a líneas y polígonos. En esos casos ponemos un punto con la etiqueta.\r\n            const pointsToAdd = [];\r\n            olFeatures.forEach(function (feature) {\r\n                var style = getNativeFeatureStyle(feature);\r\n                const geometry = feature.getGeometry();\r\n                const text = style.getText();\r\n                var point;\r\n                if (text) {\r\n                    switch (true) {\r\n                        case geometry instanceof ol.geom.LineString:\r\n                            point = new ol.geom.Point(geometry.getCoordinateAt(0.5));\r\n                            break;\r\n                        case geometry instanceof ol.geom.Polygon:\r\n                            point = geometry.getInteriorPoint();\r\n                            break;\r\n                        case geometry instanceof ol.geom.MultiLineString:\r\n                            // Seleccionamos la línea más larga\r\n                            const lineStrings = geometry.getLineStrings();\r\n                            var maxLength = -1;\r\n                            point = new ol.geom.Point(lineStrings[lineStrings\r\n                                .map(function (line) {\r\n                                    return line.getLength();\r\n                                })\r\n                                .reduce(function (prev, cur, idx) {\r\n                                    if (cur > maxLength) {\r\n                                        maxLength = cur;\r\n                                        return idx;\r\n                                    }\r\n                                    return prev;\r\n                                }, -1)].getCoordinateAt(0.5));\r\n                            break;\r\n                        case geometry instanceof ol.geom.MultiPolygon:\r\n                            // Seleccionamos el polígono más grande\r\n                            const polygons = geometry.getPolygons();\r\n                            var maxArea = -1;\r\n                            point = polygons[polygons\r\n                                .map(function (polygon) {\r\n                                    return polygon.getArea();\r\n                                })\r\n                                .reduce(function (prev, cur, idx) {\r\n                                    if (cur > maxArea) {\r\n                                        maxArea = cur;\r\n                                        return idx;\r\n                                    }\r\n                                    return prev;\r\n                                }, -1)].getInteriorPoint();\r\n                            break;\r\n                        default:\r\n                            break;\r\n                    }\r\n                    if (point) {\r\n                        const newFeature = new ol.Feature(point);\r\n                        newFeature.setStyle(new ol.style.Style({\r\n                            text: text.clone(),\r\n                            image: new ol.style.Icon({\r\n                                crossOrigin: 'anonymous',\r\n                                src: TC.apiLocation + 'TC/css/img/transparent.gif'\r\n                            })\r\n                        }));\r\n                        pointsToAdd.push(newFeature);\r\n                    }\r\n                }\r\n            });\r\n            if (pointsToAdd.length) {\r\n                olFeatures = olFeatures.concat(pointsToAdd);\r\n            }\r\n        }\r\n\r\n        if (format instanceof ol.format.GMLBase) {\r\n            format.hasZ = features[0].getGeometryStride() >= 3;\r\n            format.srsName = self.parent.crs;\r\n            // Quitamos los espacios en blanco de los nombres de atributo en las features: no son válidos en GML.\r\n            olFeatures = olFeatures.map(function (f) {\r\n                var temp = f.clone();\r\n                temp.id_ = f.id_;\r\n                return temp;\r\n            });\r\n            olFeatures.forEach(function (f) {\r\n                const values = f.values_\r\n                const keysToChange = [];\r\n                for (var key in values) {\r\n                    if (key.indexOf(' ') >= 0) {\r\n                        keysToChange.push(key);\r\n                    }\r\n                }\r\n                keysToChange.forEach(function (key) {\r\n                    // Quitamos espacios en blanco y evitamos que empiece por un número\r\n                    var newKey = key.replace(/ /g, '_');\r\n                    if (/^\\d/.test(newKey)) {\r\n                        newKey = '_' + newKey;\r\n                    }\r\n                    if (key !== newKey) {\r\n                        while (values[newKey] !== undefined) {\r\n                            newKey += '_';\r\n                        }\r\n                    }\r\n                    values[newKey] = values[key];\r\n                    delete values[key];\r\n                });\r\n            });\r\n\r\n            format.featureNS = \"http://www.opengis.net/gml\";\r\n            format.featureType = \"feature\";\r\n            var featuresNode = format.writeFeaturesNode(olFeatures, {\r\n                featureProjection: self.parent.crs\r\n            });\r\n            featuresNode.querySelectorAll(\"feature geometry > * *[srsName]\").forEach((item) => { item.removeAttribute(\"srsName\") })\r\n\r\n            var featureCollectionNode = ol.xml.createElementNS('http://www.opengis.net/wfs',\r\n                'FeatureCollection');\r\n            featureCollectionNode.setAttributeNS('http://www.w3.org/2001/XMLSchema-instance',\r\n                'xsi:schemaLocation', format.schemaLocation);\r\n\r\n            featuresNode.removeAttribute('xmlns:xsi');\r\n            featuresNode.removeAttribute('xsi:schemaLocation');\r\n            featureCollectionNode.appendChild(featuresNode);\r\n            //ol.xml.setAttributeNS(node, 'http://www.w3.org/2001/XMLSchema-instance',\r\n            //    'xsi:schemaLocation', this.schemaLocation);\r\n            return featureCollectionNode.outerHTML;\r\n        }\r\n\r\n        if (format instanceof ol.format.GPX) {\r\n            // Queremos exportar tracks en vez de routes. OpenLayers exporta LineStrings como routes y MultiLineStrings como tracks.\r\n            olFeatures = olFeatures.map(function (f) {\r\n                const geom = f.getGeometry();\r\n                if (geom instanceof ol.geom.LineString) {\r\n                    f = f.clone();\r\n                    f.setGeometry(new ol.geom.MultiLineString([geom.getCoordinates()]));\r\n                }\r\n                return f;\r\n            });\r\n        }\r\n\r\n        var result = format.writeFeatures(olFeatures, {\r\n            dataProjection: 'EPSG:4326',\r\n            featureProjection: self.parent.crs\r\n        });\r\n        if (format instanceof ol.format.GPX) {\r\n            // Este formato no procesa bien las elevaciones cuando son nulas. Hemos hecho un preproceso para transformarlas en NaN y ahora hay que eliminarlas.\r\n            result = result.replace(/<ele>NaN<\\/ele>/g, '');\r\n        }\r\n        return result;\r\n    };\r\n\r\n    var isFileDrag = function (e) {\r\n        for (var i = 0, len = e.dataTransfer.types.length; i < len; i++) {\r\n            if (e.dataTransfer.types[i] === 'Files') {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    var handleDragEnter = function (e) {\r\n        var self = this;\r\n        if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n            self.getMap()._wrap.parent.div.classList.add(TC.Consts.classes.DROP);\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n        }\r\n    };\r\n\r\n    var handleDragExit = function (e) {\r\n        var self = this;\r\n        if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n            var map = self.getMap()._wrap.parent;\r\n            if (e.target === self.target) {\r\n                map.div.classList.remove(TC.Consts.classes.DROP);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.enableDragAndDrop = function (options) {\r\n        var self = this;\r\n        var opts = options || {};\r\n        var ddOptions = {\r\n            formatConstructors: [\r\n                ol.format.KMLCustom,\r\n                ol.format.GPXCustom,\r\n                ol.format.GML2,\r\n                ol.format.GML3CRS84,\r\n                ol.format.GML2CRS84,\r\n                ol.format.GML3,\r\n                //ol.format.GML32,\r\n                ol.format.GeoJSON,\r\n                function () {\r\n                    return new ol.format.WKT({\r\n                        splitCollection: true\r\n                    });\r\n                },\r\n                ol.format.TopoJSON\r\n            ]\r\n        };\r\n        if (opts.dropTarget) {\r\n            ddOptions.target = TC.Util.getDiv(opts.dropTarget);\r\n        }\r\n        else {\r\n            ddOptions.target = self.parent.div;\r\n        }\r\n        var zipFiles = null;\r\n        var ddInteraction = new ol.interaction.DragAndDrop(ddOptions);\r\n        ddInteraction.on('addfeatures', function (e) {\r\n            var featurePromises = e.features ? e.features.map(function (elm) {\r\n                if (!elm.getId()) {\r\n                    elm.setId(TC.getUID());\r\n                }\r\n                return TC.wrap.Feature.createFeature(elm);\r\n            }) : [];\r\n            Promise.all(featurePromises).then(function (features) {\r\n                var li = self.parent.getLoadingIndicator();\r\n                if (li) {\r\n                    li.removeWait(self._featureImportWaitId);\r\n                }\r\n                const featuresWithGeometry = features.filter(f => f.geometry);\r\n                if (featuresWithGeometry.length) {                    \r\n                    self.parent.trigger(TC.Consts.event.FEATURESIMPORT, {\r\n                        features: featuresWithGeometry, fileName: e.file.name, dropTarget: e.target.target, timeStamp: e.file.lastModified\r\n                    });\r\n                }\r\n                if (!features.length || features.some(f => !f.geometry)) {\r\n                    if (zipFiles)\r\n                        if (++zipFiles.failed < zipFiles.total)\r\n                            return;\r\n                        else\r\n                            e.file = new File([], zipFiles.zipName);\r\n                    self.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR, {\r\n                        file: e.file\r\n                    });\r\n                }\r\n            });\r\n        });\r\n        if (opts.once) {\r\n            ddInteraction.map_ = self.map;\r\n        }\r\n        else {\r\n            self.map.addInteraction(ddInteraction);\r\n            var dropArea = ddInteraction.target ? ddInteraction.target : self.map.getViewport();\r\n\r\n            const originalFnc = ddInteraction.handleResult_;\r\n\r\n            var zipUncompressed = {}\r\n            var getFileData = function (file) {\r\n                if (file.arrayBuffer)\r\n                    return file.arrayBuffer();\r\n                else {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var fr = new FileReader()\r\n                        fr.onload = function (e) {\r\n                            resolve(new Uint8Array(this.result));\r\n                        };\r\n                        fr.onerror = reject;\r\n                        fr.readAsArrayBuffer(file)\r\n                    })\r\n                }\r\n            }\r\n            var getFileText = function (file) {\r\n                if (file.text)\r\n                    return file.text();\r\n                else {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var fr = new FileReader()\r\n                        fr.onload = function (e) {\r\n                            resolve(new Uint8Array(this.result));\r\n                        };\r\n                        fr.onerror = reject;\r\n                        fr.readAsText(file)\r\n                    })\r\n                }\r\n            }\r\n            \r\n            ddInteraction.handleResult_ = async function (file, evt) {\r\n                var _self = this;\r\n                //URI: si el fichero es ZIP o KMZ lo proceso sino llamo a la función original con los datos originales\r\n                zipFiles = null;\r\n                const defaultEncoding = \"ISO-8859-1\";\r\n                //_self.getMap()._wrap.parent.dropFilesCounter = 0;\r\n                if (/\\.gpkg$/ig.test(file.name) || (file.type === \"application/geopackage+sqlite3\") )\r\n                    TC.loadJS(true, TC.apiLocation + 'lib/geopackage/geopackage', async function () {\r\n                        const manageError = function (err) {\r\n                            if (err)\r\n                                TC.error(err, TC.Consts.msgErrorMode.CONSOLE);\r\n\r\n                            originalFnc.apply(_self, [file, { target: { result: null } }]);\r\n                        };\r\n                        const loadFile = async function (array) {\r\n                            geopackage.open(array).then(async function (myPackage) {\r\n                                const vectorLayers = myPackage.getFeatureTables();\r\n                                const numTables = vectorLayers.length;\r\n                                var finished = 0, notLoaded = 0;\r\n                                var warnings = [];\r\n\r\n                                //me subscribo al evento\r\n                                const manageLoad = function (evt) {\r\n                                    if (++finished === numTables) {\r\n                                        self.parent.off(TC.Consts.event.FEATURESIMPORT, manageLoad);\r\n                                        for (var i = 0; i < warnings.length; i++)\r\n                                            self.parent.trigger(TC.Consts.event.FEATURESIMPORTPARTIAL, {\r\n                                                file: file,\r\n                                                table: warnings[i].table,\r\n                                                reason: warnings[i].reason\r\n                                            });\r\n                                    }\r\n                                }\r\n                                self.parent.on(TC.Consts.event.FEATURESIMPORT, manageLoad);\r\n                                if (vectorLayers.length > 1) window.dropFilesCounter = window.dropFilesCounter + vectorLayers.length - 1;\r\n                                for (var i = 0; i < vectorLayers.length; i++) {\r\n                                    //vamos a ver si construimos en JSON\r\n\r\n                                    var _currentSRSId = myPackage.contentsDao.queryForId(vectorLayers[i]).srs_id;\r\n                                    try {\r\n                                        const obj = await geopackage.iterateGeoJSONFeaturesFromTable(myPackage, vectorLayers[i]);\r\n\r\n                                        var arr = [];\r\n                                        for (const f of obj.results) {\r\n                                            if (f.hasOwnProperty(\"id\"))\r\n                                                f.id = vectorLayers[i] + \".\" + f.id;\r\n                                            if (f.geometry)\r\n                                                arr[arr.length] = f;\r\n                                        }\r\n                                        if (!arr.length) throw 'empty table';\r\n\r\n                                        var jsonObj = {\r\n                                            \"type\": \"FeatureCollection\",\r\n                                            \"features\": arr\r\n                                        }\r\n                                        var newFile = new File([], vectorLayers[i]);\r\n                                        //window.dropFilesCounter = (window.dropFilesCounter ? window.dropFilesCounter + 1 : 1);\r\n                                        originalFnc.apply(_self, [newFile, { target: { result: jsonObj } }]);\r\n\r\n                                    } catch (err) {\r\n                                        notLoaded++;\r\n                                        manageLoad({ fileName: vectorLayers[i] });\r\n                                        warnings.push({ table: vectorLayers[i], reason: err });\r\n                                        TC.error(\"Error: \" + err + \" Table: \" + vectorLayers[i], TC.Consts.msgErrorMode.CONSOLE);\r\n                                    }\r\n                                }\r\n                                if (numTables === notLoaded) {\r\n                                    manageError(\"Error: No hay capas vectoriales válidas que mostrar\");\r\n                                }\r\n                            }, manageError);\r\n                        }\r\n                        try {\r\n                            loadFile(new Uint8Array(await getFileData(file)));\r\n                        }\r\n                        catch (ex) {\r\n                            manageError(ex);\r\n                        }\r\n                    });\r\n                else if (!(/\\.(json|geojson|kml|wkt|gml|gml2|gpx)$/ig.test(file.name))) {\r\n                    if (!/\\.(shp)$/ig.test(file.name)) {\r\n                        window.dropFilesCounter--;\r\n                    }\r\n                    //const fileName = new RegExp(/(spaSITNA)*(\\w+)(\\.\\w{2,})+$/gi).exec(file.name)[2];\r\n\r\n                    const fileName = /(spaSITNA)*((\\w|\\-)+)(\\.\\w{2,})/gi.test(file.name)?new RegExp(/(spaSITNA)*((\\w|\\-)+)(\\.\\w{2,})/gi).exec(file.name)[2]:file.name;\r\n\r\n                    const extension = file.name.substring(file.name.lastIndexOf(\".\") + 1);\r\n                    if (!zipUncompressed.hasOwnProperty(fileName)) {\r\n                        zipUncompressed[fileName] = { isSHP: false };\r\n                    }\r\n                    if (/\\.(cst|cpg|prj)$/ig.test(file.name)) {\r\n                        zipUncompressed[fileName][extension] = await getFileText(file);\r\n                        zipUncompressed[fileName][\"isSHP\"] = true;\r\n                    }\r\n                    else if (/\\.(shp|dbf|str)$/ig.test(file.name)) {\r\n                        zipUncompressed[fileName][extension] = await getFileData(file);\r\n                        zipUncompressed[fileName][\"isSHP\"] = true;\r\n                    }\r\n\r\n                    clearTimeout(zipUncompressed[fileName].timer);\r\n                    zipUncompressed[fileName].timer = setTimeout(function () {\r\n                        if (!zipUncompressed[fileName].isSHP) {\r\n                            //si el fichero se llama wfsRequest.txt y no hay ningún SHP\r\n                            if (file.name.toLowerCase() !== \"wfsrequest.txt\" || (file.name.toLowerCase() === \"wfsrequest.txt\" && !Object.keys(zipUncompressed).some((k) => { return zipUncompressed[k].isSHP }))) {\r\n                                window.dropFilesCounter++;\r\n                                self.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR, {\r\n                                    file: file\r\n                                });\r\n                            }\r\n                            delete zipUncompressed[fileName];\r\n                        }\r\n                        else\r\n                            TC.loadJS(!window.shp, TC.apiLocation + 'lib/shpjs/shp', async function () {\r\n                                var shapes;\r\n                                try {\r\n                                    //window.dropFilesCounter = (window.dropFilesCounter ? window.dropFilesCounter + 1 : 1);\r\n                                    if (!zipUncompressed[fileName][\"shp\"] || !zipUncompressed[fileName][\"prj\"] || !zipUncompressed[fileName][\"dbf\"]) {\r\n                                        if (!zipUncompressed[fileName][\"shp\"]) window.dropFilesCounter++;\r\n                                        self.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR, {\r\n                                            file: file,\r\n                                            message: \"fileImport.shapeImcomplete\"\r\n                                        });\r\n                                        delete zipUncompressed[fileName];\r\n                                        return;\r\n                                    }\r\n                                    shapes = await shp.combine([\r\n                                        shp.parseShp(zipUncompressed[fileName][\"shp\"], zipUncompressed[fileName][\"prj\"], zipUncompressed[fileName][\"str\"]),\r\n                                        shp.parseDbf(zipUncompressed[fileName][\"dbf\"], zipUncompressed[fileName][\"cst\"] || zipUncompressed[fileName][\"cpg\"] || defaultEncoding)])\r\n                                    delete zipUncompressed[fileName];\r\n                                }\r\n                                catch (err) {\r\n                                    self.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR, {\r\n                                        file: file\r\n                                    });\r\n                                    return;\r\n                                }\r\n                                (shapes instanceof Array ? shapes : [shapes]).forEach(function (collection) {\r\n                                    var newFile = new File([], fileName + '.shp');\r\n                                    originalFnc.apply(_self, [newFile, { target: { result: JSON.stringify(collection) } }]);\r\n                                });\r\n                            });\r\n                    }, 1000);\r\n\r\n                }\r\n                else {\r\n                    //window.dropFilesCounter = (window.dropFilesCounter ? window.dropFilesCounter + 1 : 1);\r\n                    originalFnc.apply(_self, [file, evt]);\r\n                }\r\n            }\r\n\r\n            // Añadidos gestores de eventos para mostrar el indicador visual de drop.\r\n            var handleDrop = function (e) {\r\n                if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n                    var map = self.parent;\r\n                    if (ddInteraction.target === e.target) {\r\n                        if (!isEmpty(e.dataTransfer.items)) {\n                            var li = map.getLoadingIndicator();\n                            if (li) {\n                                self._featureImportWaitId = li.addWait();\n                            }\n                        }\r\n                        e.stopPropagation();\r\n                    }\r\n                    else {\r\n                        e.preventDefault();\r\n                    }\r\n                    map.div.classList.remove(TC.Consts.classes.DROP);\r\n                }\r\n            };\n            var isEmpty = function (items) {\n                for (var i = 0, ii = items.length; i < ii; ++i) {\n                    for (var i = 0, ii = items.length; i < ii; ++i) {\n                        if (items[i].kind === \"file\") {\n                            if (items[i].isFile) return false;\n                            else\n                                return isEmpty(items[i].webkitGetAsEntry());\n                        }\n\n\n                    }\n                }\n                return true;\n            }\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, DRAGENTER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, DRAGENTER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, DRAGOVER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, DRAGOVER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, DROP,\r\n                    handleDrop, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, DROP,\r\n                    handleDrop, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragleave',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragend',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragexit',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            document.addEventListener('mouseenter', function (e) {\r\n                if (!e.buttons) {\r\n                    self.parent.div.classList.remove(TC.Consts.classes.DROP);\r\n                }\r\n            }, false);\r\n            self.ddEnabled = true;\r\n        }\r\n        return ddInteraction;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.loadFiles = function (files, options) {\r\n        var self = this;\r\n        var ddInteraction;\r\n        if (self.ddEnabled) {\r\n            self.map.getInteractions().forEach(function (elm) {\r\n                if (elm instanceof ol.interaction.DragAndDrop) {\r\n                    ddInteraction = elm;\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            ddInteraction = self.enableDragAndDrop({\r\n                once: true\r\n            });\r\n        }\r\n\r\n        if (ddInteraction && options) {\r\n            var currentTarget = ddInteraction.target;\r\n            ddInteraction.target = options.control;\r\n            const undoTarget = function (e) {\r\n                ddInteraction.target = currentTarget;\r\n\r\n                self.parent.off(TC.Consts.event.FEATURESIMPORT, undoTarget);\r\n            };\r\n            self.parent.on(TC.Consts.event.FEATURESIMPORT, undoTarget);\r\n        }\r\n\r\n        var li = self.parent.getLoadingIndicator();\r\n        if (li) {\r\n            self._featureImportWaitId = li.addWait();\r\n        }\r\n        for (let i = 0, ii = files.length; i < ii; ++i) {\r\n            const file = files.item(i);\r\n            ddInteraction.ProcessFile(file);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.linkTo = function (map) {\r\n        const self = this;\r\n        const onChangeView = function () {\r\n            const thisView = self.map.getView();\r\n            const thatView = map.wrap.map.getView();\r\n            setTimeout(function () {\r\n                if (thisView !== thatView) {\r\n                    self.map.setView(thatView);\r\n                }\r\n            }, 100);\r\n        };\r\n        map.wrap.map.on('change:view', onChangeView);\r\n        self.map.on('change:view', onChangeView);\r\n        onChangeView();\r\n    };\r\n\r\n    /*\r\n     *  getVisibility: gets the OpenLayers layer visibility\r\n     *  Result: boolean\r\n     */\r\n    TC.wrap.Layer.prototype.getVisibility = function () {\r\n        const self = this;\r\n        var result = false;\r\n        if (self.layer) {\r\n            result = self.layer.getVisible();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    /*\r\n     *  setVisibility: Sets the OpenLayers layer visibility\r\n     *  Parameter: boolean\r\n     */\r\n    TC.wrap.Layer.prototype.setVisibility = function (visible) {\r\n        const self = this;\r\n        self.getLayer().then(function (layer) {\r\n            layer.setVisible(visible);\r\n        });\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.isNative = function (layer) {\r\n        return layer instanceof ol.layer.Layer;\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const layer = self.parent;\r\n        if (layer.map) {\r\n            const unitRatio = getUnitRatio.call(self, {\r\n                crs: options.crs,\r\n                extentInDegrees: ol.proj.transformExtent(layer.map.getExtent(), layer.map.crs, 'EPSG:4326')\r\n            });\r\n\r\n            var resolutions = layer.getResolutions();\r\n            if (resolutions && resolutions.length) {\r\n                resolutions = resolutions.map(function (r) {\r\n                    return r / unitRatio;\r\n                });\r\n                layer.wrap.layer.setMaxResolution(resolutions[0]);\r\n                layer.wrap.layer.setMinResolution(resolutions[resolutions.length - 1]);\r\n            }\r\n            else {\r\n                // de metros a grados\r\n                if (options.oldCrs && ol.proj.get(options.oldCrs).getUnits() === ol.proj.Units.METERS && (!ol.proj.get(options.crs).getUnits() || ol.proj.get(options.crs).getUnits() === ol.proj.Units.DEGREES)) {\r\n\r\n                    if (layer.minResolution) {\r\n                        layer.minResolution = layer.minResolution / unitRatio;\r\n                        self.layer.setMinResolution(layer.minResolution);\r\n                    }\r\n\r\n                    if (layer.maxResolution) {\r\n                        layer.maxResolution = layer.maxResolution / unitRatio;\r\n                        self.layer.setMaxResolution(layer.maxResolution);\r\n                    }\r\n\r\n                    // de grados a metros\r\n                } else if (options.oldCrs && ol.proj.get(options.oldCrs).getUnits() === ol.proj.Units.DEGREES && ol.proj.get(options.crs).getUnits() === ol.proj.Units.METERS) {\r\n                    var metersPerDegree = TC.Util.getMetersPerDegree(ol.proj.transformExtent(layer.map.getExtent(), layer.map.crs, 'EPSG:4326'));\r\n\r\n                    if (layer.minResolution) {\r\n                        layer.minResolution = layer.minResolution * metersPerDegree;\r\n                        self.layer.setMinResolution(layer.minResolution);\r\n                    }\r\n\r\n                    if (layer.maxResolution) {\r\n                        layer.maxResolution = layer.maxResolution * metersPerDegree;\r\n                        self.layer.setMaxResolution(layer.maxResolution);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    const createPathFromGeometry = function (geometry) {\r\n        const result = new Path2D();\r\n        const p0 = geometry[0];\r\n        result.moveTo(p0[0], p0[1]);\r\n        for (var i = 1, ii = geometry.length; i < ii; i++) {\r\n            const p = geometry[i];\r\n            result.lineTo(p[0], p[1]);\r\n        }\r\n        result.closePath();\r\n        return result;\r\n    };\r\n\r\n    const getPixelRatioScalePath = function (path) {\r\n        // flacunza:\r\n        // En desktop escalamos la geometría según devicePixelRatio porque hemos escalado el mapa previamente\r\n        // (ver TC.wrap.Map.prototype.manageSize)\r\n        if (TC.Util.detectMobile()) {\r\n            return path;\r\n        }\r\n        else {\r\n            const result = new Path2D();\r\n            result.addPath(path, new DOMMatrix('scale(' + window.devicePixelRatio + ')'));\r\n            return result;\r\n        }\r\n    };\r\n\r\n    const execCanvasOperation = function (geometry, operationName, precomposeHandler, postcomposeHandler) {\r\n        const self = this;\r\n        const precomposeHandlerName = `_${operationName}PrecomposeHandler`;\r\n        const postcomposeHandlerName = `_${operationName}PostcomposeHandler`;\r\n        if (self[precomposeHandlerName]) {\r\n            self.layer.un(ol.render.EventType.PRECOMPOSE, self[precomposeHandlerName]);\r\n            delete self[precomposeHandlerName];\r\n            self.layer.un(ol.render.EventType.POSTCOMPOSE, self[postcomposeHandlerName]);\r\n            delete self[postcomposeHandlerName];\r\n        }\r\n\r\n        if (geometry) {\r\n            self[precomposeHandlerName] = precomposeHandler;\r\n            self.layer.on(ol.render.EventType.PRECOMPOSE, self[precomposeHandlerName]);\r\n\r\n            self[postcomposeHandlerName] = postcomposeHandler;\r\n            self.layer.on(ol.render.EventType.POSTCOMPOSE, self[postcomposeHandlerName]);\r\n        }\r\n\r\n        self.parent.map.wrap.map.render();\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.clip = function (geometry) {\r\n        const self = this;\r\n        execCanvasOperation.call(self, geometry, 'clip', function (e) {\r\n            let geom = geometry;\r\n            if (TC.Util.isFunction(geometry)) {\r\n                geom = geometry.call(self._wrap);\r\n            }\r\n            if (!(geom instanceof Path2D)) {\r\n                geom = createPathFromGeometry(geom);\r\n            }\r\n            geom = getPixelRatioScalePath(geom);\r\n            const ctx = e.context;\r\n            ctx.save();\r\n            ctx.clip(geom, 'evenodd');\r\n        }, function (e) {\r\n            e.context.restore();\r\n        });\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.stroke = function (geometry, style) {\r\n        const self = this;\r\n        execCanvasOperation.call(self, geometry, 'stroke', function (e) {\r\n        }, function (e) {\r\n            let geom = geometry;\r\n            if (TC.Util.isFunction(geometry)) {\r\n                geom = geometry.call(self._wrap);\r\n            }\r\n            if (!(geom instanceof Path2D)) {\r\n                geom = createPathFromGeometry(geom);\r\n            }\r\n            geom = getPixelRatioScalePath(geom);\r\n            const ctx = e.context;\r\n            if (style.strokeWidth) {\r\n                ctx.lineWidth = style.strokeWidth;\r\n            }\r\n            if (style.strokeColor) {\r\n                ctx.strokeStyle = style.strokeColor;\r\n            }\r\n            ctx.stroke(geom);\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.WmsParser = ol.format.WMSCapabilities;\r\n\r\n    TC.wrap.layer.Raster.prototype.WmtsParser = ol.format.WMTSCapabilities;\r\n\r\n    TC.wrap.Layer.prototype.addCommonEvents = function (layer) {\r\n        var self = this;\r\n        layer.on('change:visible', function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.LAYERVISIBILITY, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        }, self.parent.map);\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getGetMapUrl = function () {\r\n        var result = null;\r\n        var self = this;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                var dcpType = self.parent.capabilities.Capability.Request.GetMap.DCPType;\r\n                for (var i = 0; i < dcpType.length; i++) {\r\n                    if (dcpType[i].HTTP && dcpType[i].HTTP.Get) {\r\n                        result = dcpType[i].HTTP.Get.OnlineResource;\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                result = self.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href;\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        const fragment = document.createDocumentFragment();\r\n        const textarea = document.createElement('textarea');\r\n        fragment.appendChild(textarea);\r\n        textarea.innerHTML = result;\r\n        result = textarea.textContent;\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getInfoFormats = function () {\r\n        var result = null;\r\n        var c = this.parent.capabilities;\r\n        if (c.Capability && c.Capability.Request.GetFeatureInfo) {\r\n            result = c.Capability.Request.GetFeatureInfo.Format;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.infoFormatPreference = [\r\n        'application/json',\r\n        'application/vnd.ogc.gml/3.1.1',\r\n        'application/vnd.ogc.gml',\r\n        'application/vnd.esri.wms_featureinfo_xml',\r\n        'text/html',\r\n        'text/plain',\r\n        'text/xml'\r\n    ];\r\n\r\n    TC.wrap.layer.Raster.prototype.getWMTSLayer = function (options) {\r\n        var result = null;\r\n        var self = this;\r\n        var capabilities = self.parent.capabilities;\r\n        options = options || {};\r\n        let tileMatrixSetByCRS;\r\n        if (options.crs) {\r\n            tileMatrixSetByCRS = capabilities.Contents.TileMatrixSet.filter(tms => TC.Util.CRSCodesEqual(options.crs, tms.SupportedCRS));\r\n        }\r\n        if (capabilities && capabilities.Contents) {\r\n            for (var i = 0; i < capabilities.Contents.Layer.length; i++) {\r\n                var layer = capabilities.Contents.Layer[i];\r\n                if (self.parent.options.layerNames === layer.Identifier) {\r\n                    for (var j = 0; j < layer.TileMatrixSetLink.length; j++) {\r\n                        if (options.crs) {\r\n                            let tms = tileMatrixSetByCRS.filter(tmsCRS => tmsCRS.Identifier === layer.TileMatrixSetLink[j].TileMatrixSet);\r\n                            if (tms.length > 0) {\r\n                                result = layer;\r\n                                break;\r\n                            }\r\n                        } else if ((options.matrixSetId || self.parent.options.matrixSet) === layer.TileMatrixSetLink[j].TileMatrixSet) {\r\n                            result = layer;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getTileMatrix = function (matrixSet) {\r\n        var result = null;\r\n        var self = this;\r\n        var capabilities = self.parent.capabilities;\r\n        if (capabilities && capabilities.Contents && capabilities.Contents.TileMatrixSet) {\r\n            for (var i = 0; i < capabilities.Contents.TileMatrixSet.length; i++) {\r\n                var tms = capabilities.Contents.TileMatrixSet[i];\r\n                if (tms.Identifier === matrixSet) {\r\n                    result = tms.TileMatrix;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getScaleDenominators = function (node) {\r\n        var result = [];\r\n        var self = this;\r\n        if (node.ScaleDenominator) {\r\n            result = [node.ScaleDenominator, node.ScaleDenominator];\r\n        }\r\n        else {\r\n            if (node.MinScaleDenominator || node.MaxScaleDenominator) {\r\n                result = [node.MaxScaleDenominator, node.MinScaleDenominator];\r\n            }\r\n        }\r\n        // Contemplamos el caso de una capa sin nombre: sus escalas válidas serán las de sus hijas.\r\n        if (!result.length && !self.getName(node)) {\r\n            var children = self.getLayerNodes(node);\r\n            var max = -Infinity, min = Infinity;\r\n            for (var i = 0, len = children.length; i < len; i++) {\r\n                var childDenominators = self.getScaleDenominators(children[i]);\r\n                if (childDenominators[0] > max) {\r\n                    max = childDenominators[0];\r\n                }\r\n                if (childDenominators[1] < min) {\r\n                    min = childDenominators[1];\r\n                }\r\n            }\r\n            if (max > -Infinity && min < Infinity) {\r\n                result = [max, min];\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getAttribution = function () {\r\n        const self = this;\r\n        const result = {};\r\n        const capabilities = TC.capabilities[self.parent.url];\r\n\r\n        if (capabilities) {\r\n            if (capabilities.ServiceProvider) {\r\n                result.name = capabilities.ServiceProvider.ProviderName.trim();\r\n                result.site = capabilities.ServiceProvider.ProviderSite;\r\n                if (result.site && result.site.href && result.site.href.trim().length > 0) {\r\n                    result.site = result.site.href;\r\n                } else {\r\n                    delete result.site;\r\n                }\r\n            }\r\n            else if (capabilities.ServiceIdentification) {\r\n                result.name = capabilities.ServiceIdentification.Title.trim();\r\n            }\r\n            else {\r\n                result.name = capabilities.Service.Title.trim();\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getInfo = function (name) {\r\n        var self = this;\r\n        var result = {};\r\n        var capabilities = self.parent.capabilities;\r\n        if (capabilities) {\r\n            if (capabilities.Capability) { // WMS\r\n                var layerNodes = self.getAllLayerNodes();\r\n                for (var i = 0; i < layerNodes.length; i++) {\r\n                    var l = layerNodes[i];\r\n                    if (self.parent.compareNames(self.getName(l), name)) {\r\n                        if (l.Title) {\r\n                            result.title = l.Title;\r\n                        }\r\n                        if (l.Abstract) {\r\n                            result['abstract'] = l.Abstract;\r\n                        }\r\n                        result.legend = [];\r\n\r\n                        var _process = function (value) {\r\n                            var legend = this.getLegend(value);\r\n\r\n                            if (legend.src)\r\n                                result.legend.push({\r\n                                    src: legend.src, title: value.Title\r\n                                });\r\n                        };\r\n\r\n                        var _traverse = function (o, func) {\r\n                            if (o.Layer && o.Layer.length > 0) {\r\n                                for (var i in o.Layer) {\r\n                                    //bajar un nivel en el árbol\r\n                                    _traverse(o.Layer[i], func);\r\n                                }\r\n                            } else {\r\n                                func.apply(self, [o]);\r\n                            }\r\n                        };\r\n\r\n                        //Obtenemos todas las leyendas de la capa o grupo de capas\r\n                        _traverse(l, _process);\r\n\r\n                        if (l.MetadataURL && l.MetadataURL.length) {\r\n                            result.metadata = [];\r\n                            for (var j = 0; j < l.MetadataURL.length; j++) {\r\n                                var md = l.MetadataURL[j];\r\n                                result.metadata.push({\r\n                                    format: md.Format, type: md.type, url: md.OnlineResource\r\n                                });\r\n                            }\r\n                        }\r\n                        result.queryable = l.queryable;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            else if (capabilities.Contents) { // WMTS\r\n                const layerName = self.parent.names[0];\r\n                for (var i = 0, ii = capabilities.Contents.Layer.length; i < ii; i++) {\r\n                    const layer = capabilities.Contents.Layer[i];\r\n                    if (layer.Identifier === layerName) {\r\n                        result.abstract = layer.Abstract;\r\n                        let metadata = layer.Metadata;\r\n                        if (metadata) {\r\n                            if (!Array.isArray(metadata)) {\r\n                                metadata = [metadata];\r\n                            }\r\n                            result.metadata = [];\r\n                            for (var j = 0, jj = metadata.length; j < jj; j++) {\r\n                                const md = metadata[j];\r\n                                result.metadata.push({\r\n                                    format: md.format,\r\n                                    url: md.href\r\n                                });\r\n                            }\r\n                        }\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getServiceType = function () {\r\n        var result = null;\r\n        var capabilities = this.parent.capabilities;\r\n        if (capabilities.Capability && capabilities.Capability.Request && capabilities.Capability.Request.GetMap) {\r\n            result = TC.Consts.layerType.WMS;\r\n        }\r\n        else if (capabilities.OperationsMetadata && capabilities.OperationsMetadata.GetTile) {\r\n            result = TC.Consts.layerType.WMTS;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getServiceTitle = function () {\r\n        var result = null;\r\n        var capabilities = this.parent.capabilities;\r\n        if (capabilities.Capability && capabilities.Service) {\r\n            result = capabilities.Service.Title;\r\n        }\r\n        else if (capabilities.ServiceIdentification) {\r\n            result = capabilities.ServiceIdentification.Title;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getRootLayerNode = function () {\r\n        var self = this;\r\n        var result;\r\n        if (self.getServiceType() === TC.Consts.layerType.WMS) {\r\n            result = self.parent.capabilities.Capability.Layer;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getName = function (node, ignorePrefix) {\r\n        var result = node.Name;\r\n        if (result && ignorePrefix) {\r\n            var idx = result.indexOf(':');\r\n            if (idx >= 0) {\r\n                result = result.substr(idx + 1);\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getIdentifier = function (node) {\r\n        return node.Identifier;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getLayerNodes = function (node) {\r\n        var result = node.Layer;\r\n        if (!Array.isArray(result)) {\r\n            if (result) {\r\n                result = [result];\r\n            }\r\n            else {\r\n                result = [];\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getAllLayerNodes = function () {\r\n        var self = this;\r\n        if (!self._layerList) {\r\n            switch (self.getServiceType()) {\r\n                case TC.Consts.layerType.WMS:\r\n                    var getNodeArray = function getNodeArray(node) {\r\n                        var r = [node];\r\n                        var children = self.getLayerNodes(node);\r\n                        for (var i = 0; i < children.length; i++) {\r\n                            r = r.concat(getNodeArray(children[i]));\r\n                        }\r\n                        return r;\r\n                    };\r\n                    var root = self.getRootLayerNode();\r\n                    self._layerList = root ? getNodeArray(root) : [];\r\n                    break;\r\n                case TC.Consts.layerType.WMTS:\r\n                    self._layerList = self.parent.capabilities.Contents.Layer.slice();\r\n                    break;\r\n                default:\r\n                    self._layerList = [];\r\n                    break;\r\n            }\r\n        }\r\n        return self._layerList;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.normalizeLayerNode = function (node) {\r\n        return node;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.normalizeCapabilities = function (capabilities) {\r\n        return capabilities;\r\n    };\r\n\r\n\r\n    TC.wrap.layer.Raster.prototype.getLegend = function (node) {\r\n        var result = {};\r\n        var styles = node.Style;\r\n        if (styles && styles.length) {\r\n            if (styles.length && styles[0].LegendURL && styles[0].LegendURL.length) {\r\n                var legend = styles[0].LegendURL[0];\r\n\r\n                const fragment = document.createDocumentFragment();\r\n                const textarea = document.createElement('textarea');\r\n                fragment.appendChild(textarea);\r\n                textarea.innerHTML = legend.OnlineResource;\r\n                result.src = textarea.textContent;\r\n                // Eliminado porque GeoServer miente con el tamaño de sus imágenes de la leyenda\r\n                //if (legend.size) {\r\n                //    result.width = legend.size[0];\r\n                //    result.height = legend.size[1];\r\n                //}\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.isCompatible = function (crs) {\r\n        var self = this;\r\n        var result = true;\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    if (layer.names.length > 0) {\r\n                        var names = layer.names.slice(0);\r\n                        var _isCompatible = function _isCompatible(nodes, name, inCrs) {\r\n                            var r = false;\r\n                            if (nodes) {\r\n                                for (var i = 0; i < nodes.length; i++) {\r\n                                    var n = nodes[i];\r\n                                    const itemCRS = n.CRS || n.SRS;\r\n                                    const crsList = Array.isArray(itemCRS) ? itemCRS : [itemCRS];\r\n                                    var isIn = inCrs || crsList.indexOf(crs) >= 0;\r\n                                    if (layer.compareNames(self.getName(n), name)) {\r\n                                        if (isIn) {\r\n                                            r = true;\r\n                                        }\r\n                                        break;\r\n                                    }\r\n                                    else if (_isCompatible(n.Layer, name, isIn)) {\r\n                                        r = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                            return r;\r\n                        };\r\n                        while (names.length > 0) {\r\n                            if (!_isCompatible([layer.capabilities.Capability.Layer], names.pop())) {\r\n                                result = false;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                result = false;\r\n                if (layer.capabilities && layer.capabilities.Contents && layer.capabilities.Contents.TileMatrixSet) {\r\n                    var tms = layer.capabilities.Contents.TileMatrixSet;\r\n                    for (var i = 0; i < tms.length; i++) {\r\n                        if (tms[i].Identifier === layer.options.matrixSet) {\r\n                            result = TC.Util.CRSCodesEqual(crs, tms[i].SupportedCRS);\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleCRS = function () {\r\n        var self = this;\r\n        var result = [];\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    if (layer.names.length > 0) {\r\n                        const crsLists = layer.names\r\n                            .map(function (name) {\r\n                                return layer\r\n                                    .getNodePath(name) // array de nodos\r\n                                    .map(function (node) {\r\n                                        const itemCRS = node.CRS || node.SRS || [];\r\n                                        const crsList = Array.isArray(itemCRS) ? itemCRS : [itemCRS];\r\n                                        return Array.isArray(crsList) ? crsList : [crsList];\r\n                                    }) // array de arrays de crs\r\n                                    .reduce(function (prev, cur) {\r\n                                        if (prev.length === 0) {\r\n                                            return cur;\r\n                                        }\r\n                                        cur.forEach(function (elm) {\r\n                                            if (prev.indexOf(elm) < 0) {\r\n                                                prev[prev.length - 1] = elm;\r\n                                            }\r\n                                        });// array con todos los crs\r\n                                        return prev;\r\n                                    }, []);\r\n                            });\r\n\r\n                        if (crsLists.length === 1) {\r\n                            result = crsLists[0];\r\n                        } else {\r\n                            const otherCrsLists = crsLists.slice(1);\r\n                            result = crsLists[0].filter(function (elm) {\r\n                                return otherCrsLists.every(function (crsList) {\r\n                                    return crsList.indexOf(elm) >= 0;\r\n                                });\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                if (layer.capabilities && layer.capabilities.Contents) {\r\n                    layer.capabilities.Contents.Layer\r\n                        .filter(function (l) {\r\n                            return l.Identifier === layer.layerNames;\r\n                        })  // La capa de interés\r\n                        .forEach(function (l) {\r\n                            const tileMatrixSets = l.TileMatrixSetLink\r\n                                .map(function (tmsl) {\r\n                                    return tmsl.TileMatrixSet;\r\n                                });\r\n                            result = layer.capabilities.Contents.TileMatrixSet\r\n                                .filter(function (tms) {\r\n                                    return tileMatrixSets.indexOf(tms.Identifier) >= 0;\r\n                                }) // TileMatrixSets asociados a la capa de interés\r\n                                .map(function (tms) {\r\n                                    return tms.SupportedCRS;\r\n                                });\r\n                        });\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleLayers = function (crs) {\r\n        var self = this;\r\n        var result = [];\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    var _recursiveFn = function (item, crs, inCrs) {\r\n                        var crsToCheck = item.CRS || item.SRS;\r\n                        var itemCRS = Array.isArray(crsToCheck) ? crsToCheck : [crsToCheck];\r\n                        var isIn = inCrs || itemCRS.indexOf(crs) >= 0;\r\n                        if (isIn && item.Name) {\r\n                            result.push(item.Name);\r\n                        }\r\n                        if (item.Layer) {\r\n                            for (var i = 0; i < item.Layer.length; i++) {\r\n                                _recursiveFn(item.Layer[i], crs, isIn);\r\n                            }\r\n                        }\r\n                    }\r\n                    _recursiveFn(layer.capabilities.Capability.Layer, crs);\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                if (layer.capabilities && layer.capabilities.Contents && layer.capabilities.Contents.TileMatrixSet) {\r\n                    var tmsList = layer.capabilities.Contents.TileMatrixSet;\r\n                    for (var i = 0, ii = tmsList.length; i < ii; i++) {\r\n                        var tms = tmsList[i];\r\n                        if (TC.Util.CRSCodesEqual(crs, tms.SupportedCRS)) {\r\n                            var tmsIdentifier = tms.Identifier;\r\n                            var layerList = layer.capabilities.Contents.Layer;\r\n                            for (var j = 0, jj = layerList.length; j < jj; j++) {\r\n                                var tmsLinkList = layerList[j].TileMatrixSetLink;\r\n                                for (var k = 0, kk = tmsLinkList.length; k < kk; k++) {\r\n                                    if (tmsLinkList[k].TileMatrixSet === tmsIdentifier) {\r\n                                        result.push(layerList[j].Identifier);\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets = function (crs) {\r\n        var self = this;\r\n        var result = [];\r\n        normalizeProjection({\r\n            crs: crs\r\n        });\r\n        var layer = self.parent;\r\n        if (self.getServiceType() === TC.Consts.layerType.WMTS) {\r\n            var layerList = layer.capabilities.Contents.Layer;\r\n            var tmsList = layer.capabilities.Contents.TileMatrixSet;\r\n            for (var i = 0, ii = layerList.length; i < ii; i++) {\r\n                if (layer.layerNames === layerList[i].Identifier) {\r\n                    var tmsLinkList = layerList[i].TileMatrixSetLink;\r\n                    for (var j = 0, jj = tmsLinkList.length; j < jj; j++) {\r\n                        var tmsLink = tmsLinkList[j];\r\n                        for (var k = 0, kk = tmsList.length; k < kk; k++) {\r\n                            var tms = tmsList[k];\r\n                            if (tms.Identifier === tmsLink.TileMatrixSet) {\r\n                                if (TC.Util.CRSCodesEqual(crs, tms.SupportedCRS)) {\r\n                                    result.push(tms.Identifier);\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.setWMTSUrl = function () {\r\n        var self = this;\r\n\r\n        self.getLayer().then(function (l) {\r\n            self.parent.options = self.parent.options || {};\r\n            var urls = l.getSource().getUrls();\r\n            self.parent.options.urlPattern = urls[urls.length - 1];\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.createWMSLayer = function (url, params, options) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var source = new ol.source.ImageWMS({\r\n            url: url,\r\n            crossOrigin: options.map ? options.map.options.crossOrigin : undefined,\r\n            params: params,\r\n            extent: TC.Cfg.initialExtent,\r\n            ratio: TC.Cfg.imageRatio,\r\n            imageLoadFunction: self.parent.getImageLoad.bind(self.parent)\r\n        });\r\n\r\n        // flacunza: Aparentemente esta gestión de eventos es redundante, porque ya se están lanzando en Raster.getImageLoad\r\n        //source.on('imageloadstart', function (e) {\r\n        //    self.trigger(TC.Consts.event.BEFORETILELOAD, {\r\n        //        tile: e.image.getImage()\r\n        //    });\r\n        //});\r\n        //source.on('imageloadend', function (e) {\r\n        //    self.trigger(TC.Consts.event.TILELOAD, {\r\n        //        tile: e.image.getImage()\r\n        //    });\r\n        //});\r\n        //source.on('imageloaderror', function (e) {\r\n        //    self.trigger(TC.Consts.event.TILELOAD, {\r\n        //        tile: e.image.getImage()\r\n        //    });\r\n        //});\r\n\r\n\r\n        var layerOptions = {\r\n            visible: !!params.LAYERS.length || (options && options.method && options.method === 'POST'), //Las capas de temáticos cargadas por POST no tienen el atributo LAYERS\r\n            source: source\r\n        };\r\n\r\n        if (options.minResolution) {\r\n            layerOptions.minResolution = options.minResolution;\r\n        }\r\n        if (options.maxResolution) {\r\n            layerOptions.maxResolution = options.maxResolution;\r\n        }\r\n        result = new ol.layer.Image(layerOptions);\r\n\r\n        result._wrap = self;\r\n\r\n        self.addCommonEvents(result);\r\n\r\n        return result;\r\n    };\r\n\r\n    var createWmtsSource = function (options) {\r\n        var self = this;\r\n        var result = null;\r\n        var sourceOptions = ol.source.WMTS.optionsFromCapabilities(self.parent.capabilities, {\r\n            layer: options.layerNames,\r\n            matrixSet: options.matrixSet,\r\n            crossOrigin: options.map ? options.map.options.crossOrigin : undefined,\r\n            requestEncoding: options.encoding,\r\n            format: options.format,\r\n        });\r\n        var https = 'https:';\r\n\r\n        if (sourceOptions) {\r\n            if (location.protocol === https) {\r\n                sourceOptions.urls = sourceOptions.urls.map(function (elm) {\r\n                    return elm.replace('http:', https);\r\n                });\r\n            }\r\n\r\n            sourceOptions.crossOrigin = options.map ? options.map.options.crossOrigin : undefined;\r\n\r\n            result = new ol.source.WMTS(sourceOptions);\r\n            result.setTileLoadFunction(self.parent.getImageLoad.bind(self.parent));\r\n\r\n            // flacunza: Aparentemente esta gestión de eventos es redundante, porque ya se están lanzando en Raster.getImageLoad\r\n            //result.on(TILELOADSTART, function (e) {\r\n            //    self.trigger(TC.Consts.event.BEFORETILELOAD, {\r\n            //        tile: e.tile.getImage()\r\n            //    });\r\n            //});\r\n            //result.on(TILELOADEND, function (e) {\r\n            //    self.trigger(TC.Consts.event.TILELOAD, {\r\n            //        tile: e.tile.getImage()\r\n            //    });\r\n            //});\r\n            //result.on(TILELOADERROR, function (e) {\r\n            //    self.trigger(TC.Consts.event.TILELOAD, {\r\n            //        tile: e.tile.getImage()\r\n            //    });\r\n            //});\r\n\r\n            var prevFn = result.getResolutions.bind(result);\r\n            result.getResolutions = function () {\r\n                var resolutions = prevFn();\r\n                var matrix = self.parent.getLimitedMatrixSet();\r\n                //esto está mal, porque matrix podría empezar más abajo (tener recortado por ambos lados)\r\n                if (matrix && matrix.length) {\r\n                    var ix = matrix[0].matrixIndex;\r\n                    resolutions = resolutions.slice(ix, matrix.length + ix);\r\n                }\r\n\r\n                return resolutions;\r\n            };\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.createWMTSLayer = function (options) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var source = createWmtsSource.call(self, options);\r\n\r\n        if (source) {\r\n            var layerOptions = {\r\n                source: source\r\n            };\r\n            if (options.minResolution) {\r\n                layerOptions.minResolution = options.minResolution;\r\n            }\r\n            if (options.maxResolution) {\r\n                layerOptions.maxResolution = options.maxResolution;\r\n            }\r\n            result = new ol.layer.Tile(layerOptions);\r\n            result._wrap = self;\r\n\r\n            self.addCommonEvents(result);\r\n\r\n            var resolutions = source.getResolutions();\r\n            //Este +1 tan chungo es porque, en el caso en que la resolución del mapa es igual a la máxima del layer, openLayers lo oculta\r\n            result.setMaxResolution(resolutions[0] + 1);\r\n            result.setMinResolution(resolutions[resolutions.length - 1]);\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n\r\n    /*\r\n     *  getParams: Gets the WMS layer getmap parameters\r\n     *  Returns: object\r\n     */\r\n    TC.wrap.layer.Raster.prototype.getParams = function () {\r\n        return this.layer.getSource().getParams();\r\n    };\r\n\r\n    /*\r\n     *  setParams: Sets the WMS layer getmap parameters\r\n     *  Parameter: object\r\n     */\r\n    TC.wrap.layer.Raster.prototype.setParams = function (params) {\r\n        this.layer.getSource().updateParams(params);\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.setMatrixSet = function (matrixSet) {\r\n        const self = this;\r\n        if (self.parent.type === TC.Consts.layerType.WMTS) {\r\n            const newSource = createWmtsSource.call(self, TC.Util.extend({}, self.parent.options, { matrixSet: matrixSet }));\r\n            const newResolutions = newSource.getResolutions();\r\n            const newMaxResolution = newResolutions[0]\r\n            const newMinResolution = newResolutions[newResolutions.length - 1];\r\n            self.layer.setMaxResolution(newMaxResolution);\r\n            self.layer.setMinResolution(newMinResolution);\r\n            if (self.parent.minResolution) {\r\n                self.parent.minResolution = newMinResolution;\r\n            }\r\n            if (self.parent.maxResolution) {\r\n                self.parent.maxResolution = newMaxResolution;\r\n            }\r\n            self.layer.setSource(newSource);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getResolutions = function () {\r\n        if (this.layer.getSource) {\r\n            var ts = this.layer.getSource();\r\n            if (ts.getResolutions) return ts.getResolutions();\r\n            else return [];\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.setResolutions = function (resolutions) {\r\n        if (this.layer.getSource) {\r\n            var ts = this.layer.getSource();\r\n            if (ts.resolutions_) {\r\n                ts.resolutions_ = resolutions;\r\n            }\r\n            else if (ts.tileGrid) {\r\n                ts.tileGrid.resolutions_ = resolutions;\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getExtent = function () {\r\n        const self = this;\r\n        const parent = self.parent;\r\n\r\n        const layerNodes = new Array(parent.names.length);\r\n        for (var i = 0, ii = layerNodes.length; i < ii; i++) {\r\n            const node = parent.getLayerNodeByName(parent.names[i]);\r\n            if (!node.BoundingBox) {\r\n                return null;\r\n            }\r\n            layerNodes[i] = node;\r\n        }\r\n\r\n        const mapCrs = parent.map && parent.map.getCRS();\r\n        const mapCrsCode = TC.Util.getCRSCode(mapCrs);\r\n        const extent = [Number.POSITIVE_INFINITY, Number.POSITIVE_INFINITY, Number.NEGATIVE_INFINITY, Number.NEGATIVE_INFINITY];\r\n        layerNodes\r\n            .map(function (node) {\r\n                const bboxes = Array.isArray(node.BoundingBox) ? node.BoundingBox : [node.BoundingBox];\r\n                let firstBbox, crsBbox;\r\n                bboxes.forEach(function (bbox, idx) {\r\n                    if (idx === 0) {\r\n                        firstBbox = bbox;\r\n                    }\r\n                    if (TC.Util.getCRSCode(bbox.crs) === mapCrsCode) {\r\n                        crsBbox = bbox;\r\n                    }\r\n                });\r\n                if (crsBbox) {\r\n                    return crsBbox.extent;\r\n                }\r\n                const ext = firstBbox.extent;\r\n                let bboxCrs = firstBbox.crs;\r\n                if (bboxCrs === 'CRS:84') {\r\n                    bboxCrs = 'EPSG:4326';\r\n                }\r\n                const topLeft = TC.Util.reproject([ext[0], ext[3]], bboxCrs, mapCrs);\r\n                const bottomLeft = TC.Util.reproject([ext[0], ext[1]], bboxCrs, mapCrs);\r\n                const topRight = TC.Util.reproject([ext[2], ext[3]], bboxCrs, mapCrs);\r\n                const bottomRight = TC.Util.reproject([ext[2], ext[1]], bboxCrs, mapCrs);\r\n                return [Math.min(topLeft[0], bottomLeft[0]), Math.min(bottomLeft[1], bottomRight[1]), Math.max(topRight[0], bottomRight[0]), Math.max(topLeft[1], topRight[1])];\r\n            })\r\n            .forEach(function (ext) {\r\n                extent[0] = Math.min(ext[0], extent[0]);\r\n                extent[1] = Math.min(ext[1], extent[1]);\r\n                extent[2] = Math.max(ext[2], extent[2]);\r\n                extent[3] = Math.max(ext[3], extent[3]);\r\n            });\r\n        return extent;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.reloadSource = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            if (self.layer.getSource) {\r\n                self.layer.getSource().refresh();\r\n                resolve();\r\n            }\r\n            else {\r\n                reject();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Geometry = {\r\n        getNearest: function (point, candidates) {\r\n            var pline = new ol.geom.LineString(candidates);\r\n            return pline.getClosestPoint(point);\r\n        }\r\n    };\r\n\r\n    // En OL3 la imagen tiene el tamaño original. Escalamos si hace falta.\r\n    var setScaleFunction = function (imageStyle, iconWidth, olFeat) {\r\n        if (imageStyle) {\r\n            var setScaleForWidth = function (imgWidth) {\r\n                var markerWidth = (olFeat && olFeat._wrap ? olFeat._wrap.parent.options.width : null) || iconWidth;\r\n                if (markerWidth < imgWidth) {\r\n                    var factor = markerWidth / imgWidth;\r\n                    imageStyle.setScale(factor);\r\n                }\r\n            };\r\n            var imageSize = imageStyle.getSize();\r\n            if (imageSize) {\r\n                setScaleForWidth(imageSize[0]);\r\n            }\r\n            else {\r\n                var img = imageStyle.getImage();\r\n                if (img.naturalWidth) {\r\n                    setScaleForWidth(img.naturalWidth);\r\n                }\r\n                else {\r\n                    const fragment = document.createDocumentFragment();\r\n                    const img = document.createElement('img');\r\n                    img.src = imageStyle.getSrc();\r\n                    img.addEventListener('load', function () {\r\n                        setScaleForWidth(this.naturalWidth);\r\n                    });\r\n                    fragment.appendChild(img);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    var getStyleValue = function (property, feature) {\r\n        var result = property;\r\n        var olFeat = feature && feature.wrap && feature.wrap.feature;\r\n        if (typeof property === 'string') {\r\n            var match = property.match(/^\\$\\{(.+)\\}$/);\r\n            if (match && olFeat) {\r\n                // Permitimos el formato ${prop.subprop.subsubprop}\r\n                var m = match[1].split('.');\r\n                var r = olFeat.getProperties();\r\n                for (var i = 0; i < m.length && r !== undefined; i++) {\r\n                    r = r[m[i]];\r\n                }\r\n                if (r === undefined) {\r\n                    r = feature.data;\r\n                    for (var i = 0; i < m.length && r !== undefined; i++) {\r\n                        r = r[m[i]];\r\n                    }\r\n                }\r\n                result = r;\r\n            }\r\n        }\r\n        else if (TC.Util.isFunction(property)) {\r\n            result = property(feature);\r\n        }\r\n        return result;\r\n    };\r\n\r\n    const mergeMapAndGeneralStyles = function (layer) {\r\n        const result = TC.Util.extend(true, {}, TC.Cfg.styles);\r\n        if (layer && layer.map) {\r\n            TC.Util.extend(true, result, layer.map.options.styles);\r\n        }\r\n        return result;\r\n    }\r\n\r\n    // Transformación de opciones de estilo en un estilo nativo OL3.\r\n    const createNativeStyle = function (options, olFeat) {\r\n        const nativeStyleOptions = {\r\n        };\r\n\r\n        var feature;\r\n        var isPoint, isLine, isPolygon;\r\n        if (olFeat) {\r\n            const olGeom = olFeat.getGeometry();\r\n            switch (olGeom && olGeom.getType()) {\r\n                case 'Point':\r\n                case 'MultiPoint':\r\n                    isPoint = true;\r\n                    break;\r\n                case 'LineString':\r\n                case 'MultiLineString':\r\n                    isLine = true;\r\n                    break;\r\n                case 'Polygon':\r\n                case 'MultiPolygon':\r\n                    isPolygon = true;\r\n                    break;\r\n            }\r\n            if (olFeat._wrap) {\r\n                feature = olFeat._wrap.parent;\r\n            }\r\n            else {\r\n                // Si la API SITNA no ha completado su feature, creamos un mock-up para que no fallen las funciones de estilo\r\n                feature = {\r\n                    id: TC.wrap.Feature.prototype.getId.call({\r\n                        feature: olFeat\r\n                    }), // GLS añado el id de la feature para poder filtrar por la capa a la cual pertenece                    \r\n                    features: olFeat.get('features'),\r\n                    getData: function () {\r\n                        return TC.wrap.Feature.prototype.getData.call({\r\n                            feature: olFeat\r\n                        });\r\n                    }\r\n                };\r\n\r\n\r\n            }\r\n        }\r\n        var isCluster = feature && Array.isArray(feature.features) && feature.features.length > 1;\r\n        var styles;\r\n        const externalStyles = mergeMapAndGeneralStyles(options.layer);\r\n        if (isCluster) {\r\n            styles = TC.Util.extend(true, {}, externalStyles.cluster, (options && options.styles && options.styles.cluster) ? options.styles.cluster : {});\r\n        }\r\n        else {\r\n            styles = TC.Util.extend(true, {}, externalStyles, options.styles);\r\n        }\r\n\r\n        var styleOptions = {};\r\n        if (styles.line && (isLine || !olFeat)) {\r\n            styleOptions = styles.line;\r\n            nativeStyleOptions.stroke = new ol.style.Stroke({\r\n                color: getStyleValue(styles.line.strokeColor, feature),\r\n                width: getStyleValue(styles.line.strokeWidth, feature),\r\n                lineDash: styles.line.lineDash\r\n            });\r\n        }\r\n\r\n        if (styles.polygon && (isPolygon || !olFeat)) {\r\n            styleOptions = styles.polygon;\r\n            nativeStyleOptions.fill = new ol.style.Fill({\r\n                color: getRGBA(getStyleValue(styles.polygon.fillColor, feature), getStyleValue(styles.polygon.fillOpacity, feature))\r\n            });\r\n            nativeStyleOptions.stroke = new ol.style.Stroke({\r\n                color: getStyleValue(styles.polygon.strokeColor, feature),\r\n                width: getStyleValue(styles.polygon.strokeWidth, feature),\r\n                lineDash: styles.polygon.lineDash\r\n            });\r\n        }\r\n\r\n        if (styles.point && (isPoint || !olFeat)) {\r\n            styleOptions = styles.point;\r\n            var circleOptions = {\r\n                radius: getStyleValue(styleOptions.radius, feature) ||\r\n                    (getStyleValue(styleOptions.height, feature) + getStyleValue(styleOptions.width, feature)) / 4\r\n            };\r\n            if (styleOptions.fillColor) {\r\n                circleOptions.fill = new ol.style.Fill({\r\n                    color: getRGBA(getStyleValue(styleOptions.fillColor, feature), getStyleValue(styleOptions.fillOpacity, feature))\r\n                });\r\n            }\r\n            if (styleOptions.strokeColor) {\r\n                circleOptions.stroke = new ol.style.Stroke({\r\n                    color: getStyleValue(styleOptions.strokeColor, feature),\r\n                    width: getStyleValue(styleOptions.strokeWidth, feature),\r\n                    lineDash: styleOptions.lineDash\r\n                });\r\n            }\r\n\r\n            if (!isNaN(circleOptions.radius))\r\n                nativeStyleOptions.image = new ol.style.Circle(circleOptions);\r\n        }\r\n\r\n        if (styleOptions.label) {\r\n            nativeStyleOptions.text = createNativeTextStyle(styleOptions, feature);\r\n        }\r\n\r\n        if (styles.marker && (isPoint || !olFeat)) {\r\n            styleOptions = styles.marker;\r\n            var ANCHOR_DEFAULT_UNITS = 'fraction';\r\n            if (styleOptions.url) {\r\n                nativeStyleOptions.image = new ol.style.Icon({\r\n                    crossOrigin: 'anonymous',\r\n                    anchor: styleOptions.anchor || styles.marker.anchor || [0.5, 1],\r\n                    anchorXUnits: styleOptions.anchorXUnits || ANCHOR_DEFAULT_UNITS,\r\n                    anchorYUnits: styleOptions.anchorYUnits || ANCHOR_DEFAULT_UNITS,\r\n                    src: styleOptions.url\r\n                });\r\n                nativeStyleOptions.text = createNativeTextStyle(styleOptions, feature);\r\n            }\r\n        }\r\n\r\n        return [new ol.style.Style(nativeStyleOptions)];\r\n    };\r\n\r\n    const createNativeTextStyle = function (styleObj, feature) {\r\n        if (!styleObj || !styleObj.label) {\r\n            return;\r\n        }\r\n\r\n        const textOptions = {\r\n            text: '' + getStyleValue(styleObj.label, feature),\r\n            overflow: true\r\n        };\r\n        //const olGeom = feature.wrap.feature.getGeometry();\r\n        //if (olGeom instanceof ol.geom.LineString || olGeom instanceof ol.geom.MultiLineString) {\r\n        //    textOptions.placement = ol.style.TextPlacement.LINE;\r\n        //}\r\n        if (styleObj.fontSize) {\r\n            textOptions.font = getStyleValue(styleObj.fontSize, feature) + 'pt sans-serif';\r\n        }\r\n        if (styleObj.angle) {\r\n            textOptions.rotation = -Math.PI * getStyleValue(styleObj.angle, feature) / 180;\r\n        }\r\n        if (styleObj.fontColor) {\r\n            textOptions.fill = new ol.style.Fill({\r\n                color: getRGBA(getStyleValue(styleObj.fontColor, feature), 1)\r\n            });\r\n        }\r\n        if (styleObj.labelOutlineColor) {\r\n            textOptions.stroke = new ol.style.Stroke({\r\n                color: getRGBA(getStyleValue(styleObj.labelOutlineColor, feature), 1),\r\n                width: getStyleValue(styleObj.labelOutlineWidth, feature)\r\n            });\r\n        }\r\n        if (styleObj.labelOffset) {\r\n            textOptions.offsetX = styleObj.labelOffset[0];\r\n            textOptions.offsetY = styleObj.labelOffset[1];\r\n        }\r\n        return new ol.style.Text(textOptions);\r\n    };\r\n\r\n    var toHexString = function (number) {\r\n        var result = number.toString(16);\r\n        if (result.length === 1) {\r\n            result = '0' + result;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    var getHexColorFromArray = function (colorArray) {\r\n        return '#' + toHexString(colorArray[0]) + toHexString(colorArray[1]) + toHexString(colorArray[2])\r\n    };\r\n\r\n    var getStyleFromNative = function (olStyle, olFeat) {\r\n        var result = {\r\n        };\r\n        if (TC.Util.isFunction(olStyle)) {\r\n            if (olFeat) {\r\n                olStyle = olStyle(olFeat);\r\n            }\r\n        }\r\n        if (Array.isArray(olStyle)) {\r\n            olStyle = olStyle[0];\r\n        }\r\n        if (!TC.Util.isFunction(olStyle)) {\r\n            var color;\r\n            var stroke;\r\n            var fill;\r\n            if (olFeat) {\r\n                const olGeom = olFeat.getGeometry();\r\n                if (olGeom) {\r\n                    const olGeomType = olGeom.getType();\r\n                    // Si la geometría no aplica, no poner ol.style.Image\r\n                    // Esto es porque el parser de KML genera estilos \"totum revolutum\" a partir de las URL de estilos (bug 27470)\r\n                    if (olGeomType !== ol.geom.GeometryType.POINT && olGeomType !== ol.geom.GeometryType.MULTI_POINT) {\r\n                        olStyle.setImage(null);\r\n                    }\r\n                }\r\n            }\r\n            var image = olStyle.getImage();\r\n            if (image) {\r\n                if (image instanceof ol.style.RegularShape) {\r\n                    stroke = image.getStroke();\r\n                    color = stroke.getColor();\r\n                    if (color) {\r\n                        color = ol.color.asArray(color);\r\n                        result.strokeColor = getHexColorFromArray(color);\r\n                    }\r\n                    result.strokeWidth = stroke.getWidth();\r\n                    fill = image.getFill();\r\n                    if (fill) {\r\n                        color = fill.getColor();\r\n                        if (color) {\r\n                            color = ol.color.asArray(color);\r\n                            result.fillColor = getHexColorFromArray(color);\r\n                        }\r\n                        result.fillOpacity = color[3];\r\n                    }\r\n                }\r\n                else {\r\n                    result.url = image.getSrc();\r\n                    var size = image.getSize();\r\n                    if (size) {\r\n                        result.width = size[0];\r\n                        result.height = size[1];\r\n                        result.anchor = image.getAnchor();\r\n                        if (result.anchor) {\r\n                            result.anchor[0] = result.anchor[0] / result.width;\r\n                            result.anchor[1] = result.anchor[1] / result.height;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                stroke = olStyle.getStroke();\r\n                if (stroke) {\r\n                    color = stroke.getColor();\r\n                    if (color) {\r\n                        color = ol.color.asArray(color);\r\n                        result.strokeColor = getHexColorFromArray(color);\r\n                    }\r\n                    result.strokeWidth = stroke.getWidth();\r\n                    result.lineDash = stroke.getLineDash();\r\n                }\r\n                fill = olStyle.getFill();\r\n                if (fill) {\r\n                    color = fill.getColor();\r\n                    if (color) {\r\n                        color = ol.color.asArray(color);\r\n                        result.fillColor = getHexColorFromArray(color);\r\n                    }\r\n                    result.fillOpacity = color[3];\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getStyle = function () {\r\n        return getStyleFromNative(this.layer.getStyle());\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.reloadSource = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const layerOptions = self.createVectorSource(self.parent, self.createStyles(self.parent));\r\n\r\n            if (self.parent.type === TC.Consts.layerType.WFS) {\r\n                var listenerKey = layerOptions.source.on('change', function (e) {\r\n                    if (layerOptions.source.getState() == 'ready') {\r\n                        ol.Observable.unByKey(listenerKey);\r\n\r\n                        resolve();\r\n                    }\r\n                });\r\n            }\r\n\r\n            var features = self.layer.getSource().getFeatures();\r\n            self.layer.setSource(layerOptions.source);\r\n\r\n            if (layerOptions.style)\r\n                self.layer.setStyle(layerOptions.style);\r\n\r\n            if (self.parent.type != TC.Consts.layerType.WFS) {\r\n                layerOptions.source.addFeatures(features);\r\n                resolve();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.import = function (options) {\r\n        var self = this;\r\n        var opts = TC.Util.extend({\r\n        }, options);\r\n        opts.type = options.format;\r\n\r\n        var oldFeatures = self.layer.getSource().getFeatures();\r\n        var layerOptions = self.createVectorSource(opts, self.createStyles(self.parent));\r\n        self.layer.setSource(layerOptions.source);\r\n        if (layerOptions.style) {\r\n            self.layer.setStyle(layerOptions.style);\r\n        }\r\n\r\n        layerOptions.source.addFeatures(oldFeatures);\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createVectorSource = function (options, nativeStyle) {\r\n        const self = this;\r\n\r\n        var createGenericLoader = function (url, format) {\r\n            var internalLoader = ol.featureloader.xhr(url, format);\r\n            return function (extent, resolution, projection) {\r\n                self.parent.state = TC.Layer.state.LOADING;\r\n                if (self.parent.map) {\r\n                    self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                        layer: self.parent\r\n                    });\r\n                }\r\n                internalLoader.call(this, extent, resolution, projection);\r\n            };\r\n        };\r\n        var usesGenericLoader = false;\r\n\r\n        var source;\r\n        var vectorOptions;\r\n\r\n        var getMimeTypeFromUrl = function (url) {\r\n            var idx = url.indexOf('?');\r\n            if (idx >= 0) {\r\n                url = url.substr(0, idx);\r\n            }\r\n            else {\r\n                idx = url.indexOf('#');\r\n                if (idx >= 0) {\r\n                    url = url.substr(0, idx);\r\n                }\r\n            }\r\n            switch (url.substr(url.lastIndexOf('.') + 1).toLowerCase()) {\r\n                case 'kml':\r\n                    return TC.Consts.mimeType.KML;\r\n                case 'json':\r\n                case 'geojson':\r\n                    return TC.Consts.mimeType.GEOJSON;\r\n                case 'gml':\r\n                    return TC.Consts.mimeType.GML;\r\n                case 'gpx':\r\n                    return TC.Consts.mimeType.GPX;\r\n                default:\r\n                    return null;\r\n            }\r\n        };\r\n\r\n        const isHeatmap = options.styles && options.styles.heatmap;\r\n        if (Array.isArray(options.url) || options.urls) {\r\n            var urls = options.urls || options.url;\r\n            urls = urls.map(function (elm, idx) {\r\n                return TC.proxify(elm);\r\n            });\r\n            vectorOptions = {\r\n                url: urls,\r\n                format: new ol.format.KMLCustom({\r\n                    showPointNames: false,\r\n                    extractStyles: !isHeatmap\r\n                }),\r\n                projection: options.crs\r\n            };\r\n        }\r\n        else if (options.url && options.type !== TC.Consts.layerType.WFS) {\r\n            vectorOptions = {\r\n                url: TC.proxify(options.url),\r\n                projection: options.crs\r\n            };\r\n            vectorOptions.format = getFormatFromName(options.format, !isHeatmap) ||\r\n                getFormatFromName(getMimeTypeFromUrl(options.url), !isHeatmap) ||\r\n                getFormatFromName(options.type, !isHeatmap);\r\n            vectorOptions.loader = createGenericLoader(vectorOptions.url, vectorOptions.format);\r\n            usesGenericLoader = true;\r\n        }\r\n        else if (options.data) {\r\n            vectorOptions = {\r\n                projection: options.crs,\r\n                loader: function (extent, resolution, projection) {\r\n                    self.parent.state = TC.Layer.state.LOADING;\r\n                    if (self.parent.map) {\r\n                        self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                            layer: self.parent\r\n                        });\r\n                    }\r\n                    var format = this.getFormat();\r\n                    try {\r\n                        var fs = format.readFeatures(options.data, {\r\n                            featureProjection: projection\r\n                        });\r\n                        this.addFeatures(fs);\r\n                        self.parent.state = TC.Layer.state.IDLE;\r\n                        if (self.parent.map) {\r\n                            self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                                layer: self.parent, newData: data\r\n                            });\r\n                        }\r\n                    }\r\n                    catch (e) {\r\n                        self.parent.state = TC.Layer.state.IDLE;\r\n                        if (self.parent.map) {\r\n                            self.parent.map.trigger(TC.Consts.event.LAYERERROR, {\r\n                                layer: self.parent, reason: e.message\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            };\r\n            vectorOptions.format = getFormatFromName(options.format) || getFormatFromName(options.type);\r\n        }\r\n        else if (options.type == TC.Consts.layerType.WFS) {\r\n            var outputFormat;\r\n            var mimeType;\r\n            switch (options.outputFormat) {\r\n                case TC.Consts.format.JSON:\r\n                    outputFormat = new ol.format.GeoJSON({\r\n                        geometryName: options.geometryName\r\n                    });\r\n                    mimeType = 'json';\r\n                    break;\r\n                case TC.Consts.format.GML3:\r\n                    outputFormat = new ol.format.WFS({ gmlFormat: new ol.format.GML3() });\r\n                    mimeType = TC.Consts.mimeType.GML;\r\n                    break;\r\n                case TC.Consts.format.GML32:\r\n                    outputFormat = new ol.format.WFS({ gmlFormat: new ol.format.GML32() });\r\n                    mimeType = TC.Consts.mimeType.GML;\r\n                    break;\r\n                default:\r\n                    outputFormat = new ol.format.WFS({ gmlFormat: new ol.format.GML2() });\r\n                    mimeType = TC.Consts.mimeType.GML;\r\n                    break;\r\n            }\r\n            vectorOptions = {\r\n                format: outputFormat,\r\n                loader: function (extent, resolution, projection) {\r\n                    var sOrigin = this;\r\n                    var serviceUrl = options.url;\r\n                    if (serviceUrl) {\r\n                        self.parent.state = TC.Layer.state.LOADING;\r\n                        self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                            layer: self.parent\r\n                        });\r\n\r\n                        const isFilterText = function () {\r\n                            return typeof options.properties === \"string\";\r\n                        };\r\n                        const manageResponse = (response) => {\r\n                            const data = response.data;\r\n                            let feats;\r\n                            try {\r\n                                feats = outputFormat.readFeatures(data);\r\n                            }\r\n                            catch (e) {\r\n                                self.parent.map.trigger(TC.Consts.event.LAYERERROR, { layer: self.parent, reason: e.message })\r\n                            }\r\n                            const triggerLayerUpdate = function () {\r\n                                self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                                    layer: self.parent, newData: data\r\n                                });\r\n                            };\r\n                            const onFeaturesAdd = function (e) {\r\n                                if (e.layer === self.parent) {\r\n                                    self.parent.map.off(TC.Consts.event.FEATURESADD, onFeaturesAdd);\r\n                                    triggerLayerUpdate();\r\n                                }\r\n                            };\r\n                            if (feats && feats.length) {\r\n                                self.parent.map.on(TC.Consts.event.FEATURESADD, onFeaturesAdd);\r\n                                sOrigin.addFeatures(feats);\r\n                            }\r\n                            else {\r\n                                triggerLayerUpdate();\r\n                            }\r\n                            self.parent.state = TC.Layer.state.IDLE;\r\n                        }\r\n                        const manageError = (error) => {\r\n                            if (error instanceof XMLDocument)\r\n                                self.parent.map.trigger(TC.Consts.event.LAYERERROR, { layer: self.parent, reason: error.querySelector(\"ExceptionText\").innerHTML });\r\n                            else\r\n                                self.parent.map.trigger(TC.Consts.event.LAYERERROR, { layer: self.parent, reason: error });\r\n                        };\r\n\r\n                        const makeAjaxCall = (onlyHits, capabilities) => {\r\n                            var ajaxOptions = {};\r\n                            var crs = projection.getCode();\r\n                            var version = options.version || capabilities.version || '1.1.0';\r\n                            capabilities.version = version;\r\n                            var url = serviceUrl;\r\n                            var featureType = Array.isArray(options.featureType) ? options.featureType : [options.featureType];\r\n                            const isSpatial = function (filter) {\r\n                                switch (true) {\r\n                                    case filter instanceof TC.filter.LogicalNary:\r\n                                        return filter.conditions.some(f => isSpatial(f));\r\n                                    case filter instanceof TC.filter.Spatial:\r\n                                        return true;\r\n                                    case typeof (filter) === \"string\":\r\n                                        return Object.keys(window[\"TC\"][\"filter\"]).filter(f => new TC.filter[f]() instanceof TC.filter.Spatial).some(f => filter.indexOf(f) > -1);\r\n                                    default:\r\n                                        return false;\r\n                                }\r\n                            }\r\n                            const filterText = isFilterText();\r\n                            // flacunza: quitamos temporalmente la condicion isSpatial para no romper WFSEdit.\r\n                            //if (options.properties && (isSpatial(options.properties) || (filterText ? options.properties.length > TC.Consts.URL_MAX_LENGTH : options.properties.getText(capabilities.version).length > TC.Consts.URL_MAX_LENGTH))) {\r\n                            if (options.properties && (filterText ? options.properties.length > TC.Consts.URL_MAX_LENGTH : options.properties.getText(capabilities.version).length > TC.Consts.URL_MAX_LENGTH)) {\r\n                                ajaxOptions.method = 'POST';\r\n                                ajaxOptions.url = url;\r\n                                ajaxOptions.data = filterText ? options.properties : TC.Util.WFSQueryBuilder(featureType, options.properties, capabilities, onlyHits ? null : options.outputFormat, onlyHits, crs, options.maxFeatures)\r\n\r\n                                if (!filterText) {\r\n                                    self.parent.map.trigger(TC.Consts.event.BEFOREAPPLYQUERY, { layer: self.parent, query: ajaxOptions.data });\r\n                                }\r\n                            }\r\n                            else {\r\n                                ajaxOptions.method = 'GET';\r\n                                ajaxOptions.url = url;\r\n                                ajaxOptions.data = {\r\n                                    service: \"WFS\",\r\n                                    request: \"GetFeature\",\r\n                                    version: version,\r\n                                    outputFormat: options.outputFormat,\r\n                                    srsname: crs\r\n                                }\r\n                                ajaxOptions.data[\"typename\" + (version === \"2.0.0\" ? \"s\" : \"\")] = (options.featurePrefix ? options.featurePrefix + \":\" : \"\") + options.featureType;\r\n                                if (onlyHits)\r\n                                    ajaxOptions.data = Object.assign(ajaxOptions.data, {\r\n                                        resultType: \"hits\"\r\n                                    });\r\n                                if (options.properties) {\r\n                                    if (options.properties instanceof TC.filter.Bbox)\r\n                                        ajaxOptions.data = Object.assign(ajaxOptions.data, {\r\n                                            BBOX: '{0},{1},{2},{3},{4}'.format(options.properties.extent.concat([crs]))\r\n                                        });\r\n                                    else\r\n                                        ajaxOptions.data = Object.assign(ajaxOptions.data, {\r\n                                            filter: filterText ? options.properties : options.properties.getText(version).replace(/(fes\\:|ogc\\:)/g, \"\")\r\n                                        });\r\n\r\n                                    if (!filterText && !onlyHits) {\r\n                                        self.parent.map.trigger(TC.Consts.event.BEFOREAPPLYQUERY, { layer: self.parent, query: options.properties.getText() });\r\n                                    }\r\n                                }\r\n                                if (options.maxFeatures)\r\n                                    ajaxOptions.data = Object.assign(ajaxOptions.data, {\r\n                                        maxFeatures: options.maxFeatures\r\n                                    });\r\n                            }\r\n                            switch (onlyHits ? \"\" : mimeType) {\r\n                                case 'json':\r\n                                    ajaxOptions.responseType = TC.Consts.mimeType.JSON;\r\n                                    break;\r\n                                default:\r\n                                    ajaxOptions.responseType = TC.Consts.mimeType.XML;\r\n                                    break;\r\n                            }\r\n                            ajaxOptions.contentType = TC.Consts.mimeType.XML;\r\n\r\n                            return TC.ajax(ajaxOptions);\r\n                        };\r\n\r\n                        self.parent.getCapabilitiesPromise().then((_capabilities) => {\r\n                            const capabilities = _capabilities;\r\n                            //obtenos del capabilities nummax de features\r\n                            let numMaxFeatures = null;\r\n                            try {\r\n                                numMaxFeatures = capabilities.Operations.GetFeature.CountDefault.DefaultValue;\r\n                            }\r\n                            catch (e) {\r\n                            }\r\n                            if (numMaxFeatures) {\r\n                                if (!options.maxFeatures) options.maxFeatures = numMaxFeatures;\r\n                                let filterText = isFilterText();\r\n                                makeAjaxCall(filterText ? false : true, capabilities).then((response) => {\r\n                                    if (filterText) {\r\n                                        manageResponse(response);\r\n                                        return;\r\n                                    }\r\n                                    var firstNode = response.data.children[0];\r\n                                    if (firstNode.tagName.toLowerCase().indexOf(\"exception\") >= 0) {\r\n                                        self.parent.map.trigger(TC.Consts.event.LAYERERROR, { layer: self.parent, reason: firstNode.querySelector(\"ExceptionText\").innerHTML })\r\n                                    }\r\n                                    else if (firstNode.tagName.toLowerCase().indexOf(\"featurecollection\") >= 0) {\r\n                                        let numOfFeaturesFounded = parseInt((firstNode.attributes[\"numberMatched\"] || firstNode.attributes[\"numberOfFeatures\"]).value, 10);\r\n                                        if (isNaN(numOfFeaturesFounded) || numOfFeaturesFounded >= parseInt(numMaxFeatures, 10)) {\r\n                                            self.parent.map.trigger(TC.Consts.event.LAYERERROR, { layer: self.parent, reason: TC.Consts.WFSErrors.MAX_NUM_FEATURES, data: { limit: parseInt(numMaxFeatures, 10), founded: numOfFeaturesFounded } });\r\n                                            return;\r\n                                        }\r\n                                        else if (!isNaN(numOfFeaturesFounded) && numOfFeaturesFounded === 0) {\r\n                                            //si no encuentra nada. LLamo a la función para \r\n                                            manageResponse({\r\n                                                data: outputFormat instanceof ol.format.GeoJSON ? { \"type\": \"FeatureCollection\", \"totalFeatures\": 0, \"features\": [], \"crs\": null } : outputFormat.writeFeatures([])\r\n                                            });\r\n                                            return;\r\n                                        }\r\n                                        makeAjaxCall(false, capabilities).then(manageResponse).catch(manageError);\r\n                                    }\r\n                                })\r\n                            }\r\n                            else {\r\n                                makeAjaxCall(false, capabilities).then(manageResponse).catch(manageError);\r\n                            }\r\n                        });\r\n                        self._requestUrl = serviceUrl;\r\n                    }\r\n                },\r\n                //strategy: ol.loadingstrategy.all(),\r\n                projection: options.crs\r\n            };\r\n        }\r\n\r\n        if (options.features) {\r\n            vectorOptions = vectorOptions || {};\r\n            vectorOptions.features = options.features.map(f => f instanceof TC.Feature ? f.wrap.feature : f);\r\n        }\r\n\r\n        source = new ol.source.Vector(vectorOptions);\r\n\r\n        if (usesGenericLoader) {\r\n            source.on(CHANGE, function (e) {\r\n                if (self.parent.map) {\r\n                    self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                        layer: self.parent\r\n                    });\r\n                }\r\n            });\r\n        }\r\n\r\n        source._tcLayer = self.parent;\r\n\r\n        var markerStyle = options.style && options.style.marker ? options.style.marker : TC.Cfg.styles.marker;\r\n        if (!options.style || !options.style.marker) {\r\n            markerStyle = TC.Util.extend({}, markerStyle, {\r\n                anchor: TC.Cfg.styles.point.anchor\r\n            });\r\n        }\r\n\r\n        // Si habilitamos el clustering la fuente es especial\r\n        if (options.cluster) {\r\n            source = new ol.source.Cluster({\r\n                projection: options.crs,\r\n                distance: options.cluster.distance,\r\n                source: source\r\n            });\r\n\r\n            // Animación\r\n            if (options.cluster.animate) {\r\n                var getCurrentCoordinates = function (fromCoords, toCoords, duration, start) {\r\n                    var fraction = Math.min((Date.now() - start) / duration, 1);\r\n                    var dx = (toCoords[0] - fromCoords[0]) * fraction;\r\n                    var dy = (toCoords[1] - fromCoords[1]) * fraction;\r\n                    return [fromCoords[0] + dx, fromCoords[1] + dy];\r\n                };\r\n                var animate = function (parent, child) {\r\n                    var start = Date.now();\r\n                    var pCoords = parent.getGeometry().getCoordinates();\r\n                    var cCoords = child.getGeometry().getCoordinates();\r\n                    child.setGeometry(new ol.geom.Point(pCoords));\r\n                    var step = function step() {\r\n                        var coords = getCurrentCoordinates(pCoords, cCoords, TC.Consts.CLUSTER_ANIMATION_DURATION, start);\r\n                        child.setGeometry(new ol.geom.Point(coords));\r\n                        if (coords[0] !== cCoords[0] && coords[1] !== cCoords[1]) {\r\n                            requestAnimationFrame(step);\r\n                        }\r\n                        else {\r\n                            clusterCache.splice(clusterCache.indexOf(parent), 1);\r\n                        }\r\n                    };\r\n                    requestAnimationFrame(step);\r\n                };\r\n                var clusterCache = [];\r\n                source.addEventListener(REMOVEFEATURE, function (e) {\r\n                    var features = e.feature.get('features');\r\n                    if (features && features.length > 1) {\r\n                        clusterCache.push(e.feature);\r\n                    }\r\n                });\r\n                source.addEventListener(ADDFEATURE, function (e) {\r\n                    var features = e.feature.get('features');\r\n                    if (features) {\r\n                        var coords = features[0].getGeometry().getCoordinates();\r\n                        if (features.length > 1) {\r\n                            var match = clusterCache.filter(function (elm) {\r\n                                var elmCoords = elm.getGeometry().getCoordinates();\r\n                                return elmCoords[0] === coords[0] && elmCoords[1] === coords[1];\r\n                            });\r\n                            if (match.length) {\r\n                                clusterCache.splice(clusterCache.indexOf(match[0]), 1);\r\n                            }\r\n                        }\r\n                        var parent = clusterCache.filter(function (elm) {\r\n                            var children = elm.get('features');\r\n                            if (children && children.length > 0) {\r\n                                var child = children.filter(function (cElm) {\r\n                                    var cCoords = cElm.getGeometry().getCoordinates();\r\n                                    return cCoords[0] === coords[0] && cCoords[1] === coords[1];\r\n                                });\r\n                                return child.length > 0;\r\n                            }\r\n                        });\r\n                        if (parent.length) {\r\n                            animate(parent[parent.length - 1], e.feature);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        var s = source;\r\n        do {\r\n            s.addEventListener(ADDFEATURE, function (e) {\r\n                var olFeat = e.feature;\r\n                // OL3 dibuja el tamaño original del icono del marcador, lo escalamos si es necesario:\r\n                var style = getNativeFeatureStyle(olFeat, true);\r\n                if (style) {\r\n                    setScaleFunction(style.getImage(), markerStyle.width, olFeat);\r\n                }\r\n            });\r\n            if (TC.Util.isFunction(s.getSource)) {\r\n                s = s.getSource();\r\n            }\r\n            else {\r\n                s = null;\r\n            }\r\n        }\r\n        while (s);\r\n\r\n        source.addEventListener(ADDFEATURE, function (e) {\r\n            const olFeat = e.feature;\r\n\r\n            const addFeatureToLayer = function (feat) {\r\n                var addFn;\r\n                switch (true) {\r\n                    case TC.feature.Point && feat instanceof TC.feature.Point:\r\n                        addFn = self.parent.addPoint;\r\n                        break;\r\n                    case TC.feature.Polyline && feat instanceof TC.feature.Polyline:\r\n                        addFn = self.parent.addPolyline;\r\n                        break;\r\n                    case TC.feature.Polygon && feat instanceof TC.feature.Polygon:\r\n                        addFn = self.parent.addPolygon;\r\n                        break;\r\n                    case TC.feature.MultiPolygon && feat instanceof TC.feature.MultiPolygon:\r\n                        addFn = self.parent.addMultiPolygon;\r\n                        break;\r\n                    case TC.feature.MultiPolyline && feat instanceof TC.feature.MultiPolyline:\r\n                        addFn = self.parent.addMultiPolyline;\r\n                        break;\r\n                    default:\r\n                        addFn = self.parent.addFeature;\r\n                        break;\r\n                }\r\n                if (addFn) {\r\n                    var _timeout;\r\n                    addFn.call(self.parent, olFeat).then(function (f) {\r\n                        var features = olFeat.get('features');\r\n                        if (Array.isArray(features)) {\r\n                            // Es una feature de fuente ol.source.Cluster\r\n                            f.features = features.map(function (elm) {\r\n                                return new feat.constructor(elm);\r\n                            });\r\n                        }\r\n\r\n                        // Timeout porque OL3 no tiene evento featuresadded. El timeout evita ejecuciones a lo tonto.\r\n                        clearTimeout(_timeout);\r\n                        _timeout = setTimeout(function () {\r\n                            self.parent.map.trigger(TC.Consts.event.FEATURESADD, {\r\n                                layer: self.parent, features: [f]\r\n                            });\r\n                        }, 50);\r\n                    });\r\n                }\r\n            };\r\n\r\n            if (!olFeat._wrap || !olFeat._wrap.parent.layer) { // Solo actuar si no es una feature añadida desde la API\r\n                TC.wrap.Feature.createFeature(olFeat).then(addFeatureToLayer);\r\n            }\r\n        });\r\n\r\n        source.addEventListener(REMOVEFEATURE, function (e) {\r\n            var olFeat = e.feature;\r\n            if (olFeat._wrap) {\r\n                var idx = self.parent.features.indexOf(olFeat._wrap.parent);\r\n                if (idx > -1) {\r\n                    self.parent.features.splice(idx, 1);\r\n                    self.parent.map.trigger(TC.Consts.event.FEATUREREMOVE, {\r\n                        layer: self.parent, feature: olFeat._wrap.parent\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        source.addEventListener(ADDFEATURE, function (e) {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        source.addEventListener(REMOVEFEATURE, function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        source.addEventListener(CLEAR, function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.FEATURESCLEAR, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        var layerOptions = {\r\n            source: source\r\n        };\r\n\r\n        if (options.minResolution) {\r\n            layerOptions.minResolution = options.minResolution;\r\n        }\r\n        if (options.maxResolution) {\r\n            layerOptions.maxResolution = options.maxResolution;\r\n        }\r\n\r\n        // En KML conservamos el estilo que viene con el archivo, así que no entramos aquí.\r\n        // A no ser que tenga clusters, porque OL no soporta por defecto la combinación de estilo KML con clusters.\r\n        if (!(vectorOptions && vectorOptions.format instanceof ol.format.KML) || options.cluster) {\r\n            layerOptions.style = nativeStyle || options.styles;\r\n        }\r\n\r\n        return layerOptions;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createStyles = function (options) {\r\n        var self = this;\r\n\r\n        var dynamicStyle = false;\r\n\r\n        if (TC.Util.isFunction(options)) {\r\n            dynamicStyle = true;\r\n            self.styleFunction = function (olFeat) {\r\n                return createNativeStyle(options(olFeat));\r\n            }\r\n        }\r\n        else {\r\n            options = TC.Util.extend({}, options);\r\n            options.crs = options.crs || TC.Cfg.crs;\r\n            const externalStyles = mergeMapAndGeneralStyles(self.parent);\r\n            options.styles = TC.Util.extend(true, externalStyles, options.styles);\r\n            var isDynamicStyle = function isDynamicStyle(obj) {\r\n                for (var key in obj) {\r\n                    var prop = obj[key];\r\n                    switch (typeof prop) {\r\n                        case 'string':\r\n                            if (/^\\$\\{(.+)\\}$/.test(prop)) {\r\n                                return true;\r\n                            }\r\n                            break;\r\n                        case 'object':\r\n                            if (isDynamicStyle(prop)) {\r\n                                return true;\r\n                            }\r\n                            break;\r\n                        case 'function':\r\n                            return true;\r\n                            break;\r\n                        default:\r\n                            break;\r\n                    }\r\n                }\r\n                return false;\r\n            };\r\n\r\n            dynamicStyle = !!(options.cluster && options.cluster.styles) || isDynamicStyle(options.styles);\r\n            const opts = {};\r\n            if (self.parent.styles) {\r\n                opts.styles = Object.assign({}, self.parent.styles);\r\n            }\r\n            if (options.cluster && options.cluster.styles) {\r\n                opts.styles = Object.assign({}, opts.styles, { cluster: options.cluster.styles });\r\n            }\r\n            self.styleFunction = function (olFeat) {\r\n                opts.layer = self.parent;\r\n                return createNativeStyle(opts, olFeat);\r\n            };\r\n        }\r\n\r\n        var nativeStyle = dynamicStyle ? self.styleFunction : self.styleFunction();\r\n\r\n        return nativeStyle;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setStyles = function (options) {\r\n        const self = this;\r\n        self.getLayer().then(function (olLayer) {\r\n            if ((options && options.heatmap) ||\r\n                olLayer instanceof ol.layer.Heatmap) {\r\n                const features = olLayer.getSource().getFeatures();\r\n                features.forEach(f => f.setStyle(null));\r\n                const newOptions = TC.Util.extend(true, { features: features }, self.parent.options);\r\n                delete newOptions.styles;\r\n                self.layer = self.createVectorLayer(TC.Util.extend(newOptions, { styles: options }));\r\n                if (self.parent.map) {\r\n                    const mapWrap = self.parent.map.wrap;\r\n                    mapWrap.insertLayer(self.layer, mapWrap.getLayerIndex(olLayer));\r\n                    mapWrap.removeLayer(olLayer);\r\n                }\r\n            }\r\n            else {\r\n                olLayer.setStyle(self.createStyles({ styles: options }));\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createVectorLayer = function (options) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        options = options || self.parent.options;\r\n\r\n        const layerOptions = self.createVectorSource(options, self.createStyles(options));\r\n\r\n        layerOptions.declutter = options.declutter || false;\r\n        if (options.styles && options.styles.heatmap) {\r\n            const hmOptions = TC.Util.extend({}, options.styles.heatmap);\r\n            if (TC.Util.isFunction(hmOptions.weight)) {\r\n                const oldWeightFn = hmOptions.weight;\r\n                hmOptions.weight = function (olFeat) {\r\n                    return oldWeightFn(olFeat._wrap.parent);\r\n                };\r\n            }\r\n            result = new ol.layer.Heatmap(TC.Util.extend({ source: layerOptions.source }, hmOptions));\r\n        }\r\n        else {\r\n            result = new ol.layer.Vector(layerOptions);\r\n        }\r\n        result._wrap = self;\r\n\r\n        self.addCommonEvents(result);\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.addFeatures = function (features) {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            if (l instanceof ol.layer.Heatmap) {\r\n                features.forEach(f => f.setStyle(null));\r\n            }\r\n            var source = l;\r\n            while (TC.Util.isFunction(source.getSource)) {\r\n                source = source.getSource();\r\n            }\r\n            source.addFeatures(features);\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeatures = function () {\r\n        var olLayer = this.getLayer();\r\n        if (olLayer instanceof ol.layer.Layer) {\r\n            return olLayer.getSource().getFeatures();\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeatureById = function (id) {\r\n        var olLayer = this.layer;\r\n        if (olLayer instanceof ol.layer.Layer) {\r\n            return olLayer.getSource().getFeatureById(id);\r\n        }\r\n        else {\r\n            return null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.removeFeature = function (feature) {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            if (feature.wrap.feature) {\r\n                let source = l.getSource();\r\n                let id = feature.wrap.feature.getId();\r\n                if (id && source.getFeatureById(id)) {\r\n                    source.removeFeature(feature.wrap.feature);\r\n                    if (source.getSource && Array.isArray(feature.features)) {\r\n                        const subSource = source.getSource();\r\n                        feature.features.slice().forEach(f => subSource.removeFeature(f.wrap.feature));\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.clearFeatures = function () {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            var source = l.getSource();\r\n            if (source.clearFeatures) {\r\n                source.clearFeatures();\r\n            }\r\n            else {\r\n                source.clear();\r\n            }\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setFeatureVisibility = function (feature, visible) {\r\n        var self = this;\r\n\r\n        var fillOptions = {\r\n            color: 'rgba(0, 0, 0, 0)'\r\n        };\r\n        var strokeOptions = {\r\n            color: 'rgba(0, 0, 0, 0)'\r\n        };\r\n        var displayNoneStyle = new ol.style.Style({\r\n            image: new ol.style.Circle({\r\n                radius: 0,\r\n                fill: new ol.style.Fill(fillOptions),\r\n                stroke: new ol.style.Stroke(strokeOptions)\r\n            }),\r\n            fill: new ol.style.Fill(fillOptions),\r\n            stroke: new ol.style.Stroke(strokeOptions)\r\n        });\r\n        var idx = self.parent.features.indexOf(feature);\r\n        if (idx >= 0) {\r\n            var olFeat = feature.wrap.feature;\r\n            self.getLayer().then(function (olLayer) {\r\n                if (visible && olFeat._originalStyle) {\r\n                    olFeat.setStyle(olFeat._originalStyle);\r\n                }\r\n                else {\r\n                    olFeat._originalStyle = olFeat.getStyle() || olLayer.getStyle();\r\n                    olFeat.setStyle(displayNoneStyle);\r\n                }\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getRGBA = function (color, opacity) {\r\n        return getRGBA(color, opacity);\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.findFeature = function (values) {\r\n        // TODO: añadir ol.animation.zoom\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getGetFeatureUrl = function () {\r\n        return this._requestUrl;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.sendTransaction = function (inserts, updates, deletes) {\r\n        const self = this;\r\n        const getNativeFeature = function (feat) {\r\n            return feat.wrap.feature;\r\n        };\r\n        return new Promise(function (resolve, reject) {\r\n            const olInserts = inserts.map(getNativeFeature);\r\n            const olUpdates = updates.map(getNativeFeature);\r\n            const olDeletes = deletes.map(getNativeFeature);\r\n            if (inserts.length || updates.length || deletes.length) {\r\n                self.getLayer().then(function (olLayer) {\r\n                    var format = new ol.format.WFS();\r\n                    var options = self.parent.options;\r\n                    var transaction = format.writeTransaction(olInserts, olUpdates, olDeletes, {\r\n                        featurePrefix: options.featurePrefix,\r\n                        featureNS: options.featureNS,\r\n                        featureType: options.featureType[0]\r\n                    });\r\n                    var ajaxOptions = {\r\n                        url: self.parent.url,\r\n                        method: 'POST',\r\n                        contentType: TC.Consts.mimeType.XML,\r\n                        responseType: TC.Consts.mimeType.XML,\r\n                        data: transaction.outerHTML\r\n                    };\r\n                    TC.ajax(ajaxOptions)\r\n                        .then(function (response) {\r\n                            const data = response.data;\r\n                            const ns = 'http://www.opengis.net/ows';\r\n                            var er = data.getElementsByTagNameNS(ns, 'ExceptionReport')[0];\r\n                            var errorObj = {\r\n                                reason: ''\r\n                            };\r\n                            if (er) {\r\n                                var e = er.getElementsByTagNameNS(ns, 'Exception')[0];\r\n                                if (e) {\r\n                                    errorObj.code = e.getAttribute('exceptionCode');\r\n                                    var texts = e.getElementsByTagNameNS(ns, 'ExceptionText');\r\n                                    for (var i = 0, len = texts.length; i < len; i++) {\r\n                                        errorObj.reason += '\\n' + texts[i].innerHTML;\r\n                                    }\r\n                                }\r\n                                reject(errorObj);\r\n                            }\r\n                            else {\r\n                                var transactionResponse = format.readTransactionResponse(data);\r\n                                resolve(transactionResponse);\r\n                            }\r\n                        })\r\n                        .catch(function (err) {\r\n                            const errObj = {\r\n                                code: err.status || '',\r\n                                reason: err.msg || 'unknown'\r\n                            };\r\n                            reject(errObj);\r\n                        });\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.parent);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setDraggable = function (draggable, onend, onstart) {\r\n        var self = this;\r\n\r\n        //tiene que estar a nivel de control para poder retirarla después\r\n        //var interaction;\r\n        Promise.all([self.parent.map.wrap.getMap(), self.getLayer()]).then(function (olObjects) {\r\n            const olMap = olObjects[0];\r\n            const olLayer = olObjects[1];\r\n            if (draggable) {\r\n                var interactionOptions = {\r\n                    layers: [olLayer],\r\n                    features: new ol.Collection(olLayer.getSource().getFeatures())\r\n                };\r\n                self.interaction = new ol.interaction.Translate(interactionOptions);\r\n                if (TC.Util.isFunction(onend)) {\r\n                    self.interaction.on('translateend', function (e) {\r\n                        if (e.features.getLength()) {\r\n                            onend(e.features.item(0)._wrap.parent);\r\n                        }\r\n                    });\r\n                }\r\n                if (TC.Util.isFunction(onstart)) {\r\n                    self.interaction.on('translatestart', function (e) {\r\n                        if (e.features.getLength()) {\r\n                            onstart(e.features.item(0)._wrap.parent);\r\n                        }\r\n                    });\r\n                }\r\n                olMap.addInteraction(self.interaction);\r\n            }\r\n            else if (self.interaction) {\r\n                olMap.removeInteraction(self.interaction);\r\n\r\n                // GLS: En IE no muestra la manita en el over sobre marcadores trasladables.\r\n                if (TC.Util.detectIE() && self._handlerDraggablePointerMove && TC.Util.isFunction(self._handlerDraggablePointerMove)) {\r\n                    olMap.un('pointermove', self._handlerDraggablePointerMove);\r\n                    delete self._handlerDraggablePointerMove;\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeaturesInExtent = function (extent, tolerance) {\r\n        var self = this;\r\n        var features = this.layer.getSource().getFeatures();\r\n        var featuresInExtent = [];\r\n\r\n        if (tolerance) {\r\n            var leftCorner = self.parent.map.getPixelFromCoordinate([extent[0], extent[1]]);\r\n            var rightCorner = self.parent.map.getPixelFromCoordinate([extent[2], extent[3]]);\r\n            leftCorner[0] -= tolerance[0] / 2;\r\n            leftCorner[1] += tolerance[1];\r\n            rightCorner[0] += tolerance[0] / 2;\r\n            extent = self.parent.map.getCoordinateFromPixel(leftCorner).concat(self.parent.map.getCoordinateFromPixel(rightCorner));\r\n        }\r\n\r\n        for (var i = 0; i < features.length; i++) {\r\n            var feat = features[i];\r\n\r\n            var geometry = feat.getGeometry();\r\n            var coordinate = geometry.getCoordinates();\r\n\r\n            if (ol.extent.containsCoordinate(extent, coordinate)) {\r\n                featuresInExtent.push(feat._wrap.parent);\r\n            }\r\n        }\r\n\r\n        return featuresInExtent;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getAttribution = function () {\r\n        return null;\r\n    };\r\n    TC.wrap.layer.Vector.prototype.getGetMapUrl = function () {\r\n        var result = null;\r\n        var self = this;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WFS:\r\n                try {\r\n                    result = self.parent.capabilities.Operations.GetFeature.DCP.HTTP.Get.href;\r\n                }\r\n                catch (ex) {\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        const fragment = document.createDocumentFragment();\r\n        const textarea = document.createElement('textarea');\r\n        fragment.appendChild(textarea);\r\n        textarea.innerHTML = result;\r\n        result = textarea.textContent;\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getServiceType = function () {\r\n        var result = null;\r\n        //URI: Si se tiene capabilities se supone que es un servicio WFS\r\n        if (this.parent.capabilities) {\r\n            result = TC.Consts.layerType.WFS;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.register = function (map) {\r\n        var self = this;\r\n\r\n        self._trigger = function (e) {\r\n            if (map.view === TC.Consts.view.PRINTING) {\r\n                return;\r\n            }\r\n            var featureCount = 0;\r\n            map.wrap.map.forEachFeatureAtPixel(e.pixel,\r\n                function (feature, layer) {\r\n                    if (feature._wrap && feature._wrap.parent.showsPopup) {\r\n                        featureCount++;\r\n                    }\r\n                },\r\n                {\r\n                    hitTolerance: hitTolerance\r\n                });\r\n            if (!featureCount) {\r\n                // GLS: lanzo el evento click, para que los controles que no pueden heredar de click y definir un callback pueda suscribirse al evento\r\n                self.parent.map.trigger(TC.Consts.event.CLICK, {\r\n                    coordinate: e.coordinate, pixel: e.pixel\r\n                });\r\n                self.parent.callback(e.coordinate, e.pixel);\r\n            }\r\n            // Seguimos adelante si no se han pinchado featuers\r\n            return featureCount === 0;\r\n        };\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.activate = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            olMap.on(SINGLECLICK, self._trigger);\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.deactivate = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            olMap.un(SINGLECLICK, self._trigger);\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ScaleBar.prototype.render = function () {\r\n        var self = this;\r\n        if (!self.ctl) {\r\n            self.ctl = new ol.control.ScaleLine({\r\n                target: self.parent.div\r\n            });\r\n        }\r\n        else {\r\n            self.ctl.updateElement_();\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.ScaleBar.prototype.getText = function () {\r\n        var self = this;\r\n        if (self.ctl) {\r\n            return self.ctl.renderedHTML_;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.NavBar.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            const div = self.parent.div;\r\n            self.zCtl = new ol.control.Zoom({\r\n                target: div\r\n            });\r\n            // Ponemos para render una función modificada, para evitar que en los pinch zoom haya errores de este tipo:\r\n            // AssertionError: Assertion failed: calculated value (1.002067782531452) ouside allowed range (0-1)\r\n\r\n            self.zsCtl = new ol.control.ZoomSlider({\r\n                render: function (e) {\r\n                    if (!e.frameState || !e.frameState.viewState || olMap.getView().getMinResolution() <= e.frameState.viewState.resolution) {\r\n                        // GLS: para evitar que el slider se configure en horizontal\r\n                        var render = function () {\r\n                            if (this.element.offsetWidth > this.element.offsetHeight) {\r\n                                if (!self.requestSliderSize) {\r\n                                    self.requestSliderSize = window.requestAnimationFrame(render.bind(this));\r\n                                }\r\n\r\n                                window.requestAnimationFrame(render.bind(this));\r\n                            } else if (this.element.offsetWidth < this.element.offsetHeight) {\r\n                                if (self.requestSliderSize) {\r\n                                    window.cancelAnimationFrame(self.requestSliderSize);\r\n                                    delete self.requestSliderSize;\r\n                                }\r\n                                ol.control.ZoomSlider.render.call(this, e);\r\n                            }\r\n                        };\r\n                        render.call(this);\r\n                    }\r\n                }\r\n            });\r\n            self.zsCtl.setTarget(div);\r\n\r\n            olMap.addControl(self.zsCtl);\r\n            olMap.addControl(self.zCtl);\r\n\r\n            div.querySelectorAll('button').forEach(function (button) {\r\n                button.classList.add('tc-ctl-btn', 'tc-float-btn', self.parent.CLASS + '-btn');                \r\n                button.style.display = 'block';\r\n                button.innerHTML = '';\r\n                if (button.matches('.ol-zoom-in')) {\r\n                    button.classList.add(self.parent.CLASS + '-btn-zoomin');\r\n                    button.setAttribute('title', self.parent.getLocaleString('zoomIn'));\r\n                }\r\n                if (button.matches('.ol-zoom-out')) {\r\n                    button.classList.add(self.parent.CLASS + '-btn-zoomout');\r\n                    button.setAttribute('title', self.parent.getLocaleString('zoomOut'));\r\n                }\r\n            });\r\n\r\n            const zoomSlider = div.querySelector('.ol-zoomslider');\r\n            zoomSlider.classList.add(self.parent.CLASS + '-bar');\r\n            zoomSlider.querySelector('.ol-zoomslider-thumb').classList.add(self.parent.CLASS + '-slider');\r\n\r\n            map.on(TC.Consts.event.BASELAYERCHANGE, self.refresh.bind(self));\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBar.prototype.refresh = function () {\r\n        /*\r\n        var map = this.parent.map;\r\n        var olMap = map.wrap.map;\r\n\r\n        olMap.removeControl(self.zsCtl);\r\n        var res = map.getResolutions();\r\n        self.zsCtl = new ol.control.ZoomSlider(\r\n            {\r\n                target: this.parent.div,\r\n                \"maxResolution\": res[0],\r\n                \"minResolution\": res[res.length - 1]\r\n            });\r\n\r\n        olMap.addControl(self.zsCtl);\r\n        $(map.div).find('.ol-zoomslider').addClass(self.parent.CLASS + '-bar').find('.ol-zoomslider-thumb').addClass(self.parent.CLASS + '-slider');\r\n        */\r\n        var self = this;\r\n        var map = self.parent.map.wrap.map;\r\n        // Puede ser que se llame a refresh antes de que esté inicializado ol.control.ZoomSlider. En ese caso llamamos a render que lo inicializa.\r\n        // Como render necesita un ol.MapEvent, esperamos al evento POSTRENDER.\r\n\r\n        self.parent.renderPromise().then(function () {\r\n            if (self.zsCtl.sliderInitialized_) {\r\n                var res = map.getView().getResolution();\r\n                self.zsCtl.setThumbPosition_(res);\r\n            }\r\n            else {\r\n                map.once(POSTRENDER, function (e) {\r\n                    self.zsCtl.render(e);\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBarHome.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            const div = self.parent.div;\r\n\r\n            self.z2eCtl = new ol.control.ZoomToExtent({\r\n                target: div, extent: map.initialExtent, tipLabel: ''\r\n            });\r\n\r\n            olMap.addControl(self.z2eCtl);\r\n\r\n            div.querySelectorAll('button').forEach(function (button) {\r\n                button.style.display = 'block';\r\n                button.innerHTML = '';\r\n            });\r\n            const homeBtn = div.querySelector('.ol-zoom-extent button');\r\n            homeBtn.classList.add('tc-ctl-btn', 'tc-float-btn', self.parent.CLASS + '-btn');\r\n            homeBtn.setAttribute('title', self.parent.getLocaleString('zoomToInitialExtent'));\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBarHome.prototype.setInitialExtent = function (extent) {\r\n        this.z2eCtl.extent = extent;\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.register = function (map) {\r\n        const self = this;\r\n        self.map = map;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            self._coordsTrigger = function (e) {\r\n                self.parent.coordsToClick(e);\r\n            };\r\n\r\n            map.wrap.getMap().then(function (olMap) {\r\n                self.olMap = olMap;\r\n\r\n                if (!self.parent.map.on3DView) {\r\n                    var projection = olMap.getView().getProjection();\r\n                    self.parent.crs = projection.getCode();\r\n                    self.parent.units = projection.getUnits();\r\n                } else {\r\n                    self.parent.crs = self.parent.map.view3D.crs;\r\n                    self.parent.units = TC.Consts.units.DEGREES;\r\n                }\r\n\r\n                self.parent.isGeo = self.parent.units === ol.proj.Units.DEGREES;\r\n\r\n                //$(olMap.getViewport()).add(self.parent.div);\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.onMouseMove = function (e) {\r\n        var self = this;\r\n        if (self.map.wrap.map) {\r\n            var coords = self.map.wrap.map.getEventCoordinate(e);\r\n            if (coords) {\r\n                if (self.parent.isGeo) {\r\n                    self.parent.latLon = coords.reverse();\r\n                } else {\r\n                    self.parent.xy = coords;\r\n                }\r\n\r\n                self.parent.update.apply(self.parent, arguments);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.register = function (map) {\r\n        var self = this;\r\n        self.map = map;\r\n\r\n        self._snapTrigger = function (e) {\r\n            if (e.dragging)\r\n                return;\r\n\r\n            self.initSnap(self.olMap.getEventCoordinate(e), e.pixel);\r\n        };\r\n\r\n        self._postcomposeTrigger = function (e) {\r\n            self.duringTrackSnap(e);\r\n        };\r\n\r\n        map.wrap.getMap().then(function (olMap) {\r\n            self.olMap = olMap;\r\n        });\r\n    };\r\n\r\n    var getTrackingLine = function () {\r\n        var self = this;\r\n\r\n        return self.parent.layerTracking.features.filter(function (f) {\r\n            return f instanceof TC.feature.Polyline;\r\n        })[0];\r\n    }\r\n\r\n    TC.wrap.control.Geolocation.prototype.hasCoordinates = function () {\r\n        var self = this;\r\n\r\n        return self.parent.layerTracking.features.length > 0 && self.parent.layerTracking.features[0].geometry.length >= 1;\r\n    };\r\n\r\n    var getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {\r\n            s: Math.floor((diff / 1000) % 60),\r\n            m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n            h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n        };\r\n\r\n        return TC.Util.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n        \r\n    TC.wrap.control.Geolocation.prototype.addWaypoint = function (position, properties) {\r\n        var self = this;\r\n\r\n        var waypoint = new ol.Feature({\r\n            geometry: new ol.geom.Point([position[0], position[1], properties.ele, properties.time], ('XYZM'))\r\n        });\r\n        waypoint.setProperties(properties);\r\n\r\n        self.parent.layerTracking.wrap.layer.getSource().addFeature(waypoint);\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.addPosition = function (position, heading, m, speed, accuracy, altitudeAccuracy, altitude) {\r\n        var self = this;\r\n\r\n        var x = Math.round(position[0]);\r\n        var y = Math.round(position[1]);\r\n\r\n        var line = getTrackingLine.call(this);\r\n        if (self.parent.layerTracking.features && line) {\r\n            var last = line.geometry.length > 0 && line.geometry[line.geometry.length - 1];\r\n            if (last && last.length == 0) {\r\n                self.parent.layerTracking.features[0].geometry.push([x, y, altitude, m]);\r\n                line.wrap.feature.getGeometry().appendCoordinate([x, y, altitude, m]);\r\n            }\r\n            else {\r\n                var lx = Math.round(last[0]);\r\n                var ly = Math.round(last[1]);\r\n\r\n                if (x != lx || y != ly) {\r\n                    self.parent.layerTracking.features[0].geometry.push([x, y, altitude, m]);\r\n                    line.wrap.feature.getGeometry().appendCoordinate([x, y, altitude, m]);\r\n                }\r\n            }\r\n\r\n            TC.Util.storage.setSessionLocalValue(self.parent.Const.LocalStorageKey.TRACKINGTEMP, self.formattedToStorage(self.parent.layerTracking).features);\r\n        }\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && speed != undefined && speed > 0 && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.positionChangehandler = function (geoposition) {\r\n        const self = this;\r\n        var accuracy, heading, speed, altitude, altitudeAccuracy;\r\n\r\n        if (!getTrackingLine.call(this)) {\r\n            self.parent.setTracking(false);\r\n        }\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (geoposition && geoposition.coords) {\r\n                self.parent.layerGPS.clearFeatures();\r\n\r\n                accuracy = (geoposition.coords.accuracy / self.parent.map.getMetersPerUnit()) || 0;\r\n                heading = geoposition.coords.heading || geoposition[2] || 0;\r\n                speed = geoposition.coords.speed ? geoposition.coords.speed * 3.6 : 0;\r\n                altitude = geoposition.coords.altitude || 0;\r\n                altitudeAccuracy = geoposition.coords.altitudeAccuracy || 0;\r\n\r\n                if (self.parent.layerTracking) {\r\n                    var position_ = [geoposition.coords && geoposition.coords.longitude || geoposition[0], geoposition.coords && geoposition.coords.latitude || geoposition[1]];\r\n                    if (!position_.every((c) => c)) { // al menos desde las herramientas de desarrollo puede llegar con lat/lon a undefined lo que provoca un error de OL: TypeError: coordinates must be finite numbers\r\n                        resolve(null);\r\n                    }\r\n                    var projectedPosition = TC.Util.reproject(position_, 'EPSG:4326', self.parent.map.crs);\r\n\r\n                    self.addPosition(projectedPosition, heading, new Date().getTime(), speed, accuracy, altitudeAccuracy, altitude);\r\n\r\n                    var coords = getTrackingLine.call(self).geometry;\r\n                    var len = coords.length;\r\n                    if (len >= 2) {\r\n                        self.parent.deltaMean = (coords[len - 1][3] - coords[0][3]) / (len - 1);\r\n                    }\r\n\r\n                    self.parent.trigger(self.parent.Const.Event.POSITIONCHANGE, {\r\n                        pd: {\r\n                            \"position\": projectedPosition,\r\n                            \"altitude\": altitude,\r\n                            \"accuracy\": accuracy,\r\n                            \"heading\": TC.Util.radToDeg(heading),\r\n                            \"speed\": speed\r\n                        }\r\n                    });\r\n\r\n                    Promise.all([self.parent.layerGPS.addPoint(projectedPosition, {\r\n                        radius: 4,\r\n                        fillColor: '#00CED1',\r\n                        fillOpacity: 1,\r\n                        strokeColor: '#ffffff',\r\n                        strokeWidth: 2,\r\n                        showsPopup: false\r\n                    }), self.parent.layerGPS.addCircle([projectedPosition, accuracy], {\r\n                        strokeColor: '#00CED1',\r\n                        strokeWidth: 0.4,\r\n                        fillColor: '#ffffff',\r\n                        fillOpacity: 0.2,\r\n                        showsPopup: false\r\n                    })]).then(function (features) {\r\n                        const marker = features[0];\r\n                        const accuracyCircle = features[1];\r\n                        self.parent.geopositionTracking = true;\r\n\r\n                        if (self.parent.firstPosition == false) {\r\n                            self.parent.firstPosition = true;\r\n\r\n                            if (!self.parent.trackCenterButton) {\r\n                                self.parent.trackCenterButton = self.parent.div.querySelector('.' + self.parent.CLASS + '-track-center');\r\n                                self.parent.trackCenterButton.querySelector('button').addEventListener('click', function () {\r\n                                    self.parent.layerGPS.map.zoomToFeatures(self.parent.layerGPS.features);\r\n\r\n                                    self.parent.getTrackInfoPanel().then(function (infoPanel) {\r\n                                        if (!infoPanel.isVisible()) {\r\n                                            infoPanel.doVisible();\r\n                                        }\r\n\r\n                                        if (infoPanel.isMinimized()) {\r\n                                            infoPanel.maximize();\r\n                                        }\r\n                                    });\r\n                                });\r\n\r\n                                var controlContainer = self.parent.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                                if (controlContainer) {\r\n                                    self.parent.trackCenterButton = controlContainer.addElement({ position: controlContainer.POSITION.LEFT, htmlElement: self.parent.trackCenterButton });\r\n                                } else {\r\n                                    self.parent.map.div.appendChild(self.parent.trackCenterButton);\r\n                                }\r\n\r\n                            }\r\n                            self.parent.trackCenterButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                            self.parent.layerGPS.map.zoomToFeatures(self.parent.layerGPS.features);\r\n                        }\r\n\r\n                        resolve({\r\n                            marker: marker, accuracy: accuracyCircle\r\n                        });\r\n                    });\r\n\r\n                } else { resolve(null); }\r\n            } else {\r\n                resolve(null);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n        var self = this;\r\n\r\n        if (tracking) {\r\n            self.parent.firstPosition = false;\r\n            var sessionwaypoint = [];\r\n\r\n            var nativeTrackingFeature;\r\n\r\n            if (self.parent.sessionTracking) {\r\n\r\n                var JSONParser = new TC.wrap.parser.JSON();\r\n                var features = JSONParser.parser.readFeatures(self.parent.sessionTracking);\r\n                if (features && self.parent.storageCRS !== self.parent.map.crs) {\r\n                    features = features.map(function (feature) {\r\n                        var clone = feature.clone();\r\n                        clone.getGeometry().transform(self.parent.storageCRS, self.parent.map.crs);\r\n                        return clone;\r\n                    });\r\n                }\r\n\r\n                var coordinates = features.filter(function (feature) {\r\n                    var type = feature.getGeometry().getType().toLowerCase();\r\n                    if (type === 'point') { sessionwaypoint.push(feature); }\r\n                    return type === 'linestring' || type === 'multilinestring';\r\n                })[0].getGeometry().getCoordinates();\r\n\r\n                nativeTrackingFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString(coordinates, ('XYZM')),\r\n                    tracking: true\r\n                });\r\n\r\n            } else {\r\n                nativeTrackingFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString([], ('XYZM')),\r\n                    tracking: true\r\n                });\r\n            }\r\n\r\n            if (nativeTrackingFeature) {\r\n\r\n                TC.wrap.Feature.createFeature(nativeTrackingFeature).then(function (tcFeature) {\r\n                    self.parent.layerTracking.addFeature(tcFeature);\r\n\r\n                    if (tcFeature.geometry.length > 1) {\r\n                        self.parent.map.zoomToFeatures(self.parent.layerTracking.features);\r\n                    }\r\n\r\n                    if (sessionwaypoint.length > 0) {\r\n                        Promise.all(sessionwaypoint.map(function (waypoint) {\r\n                            return TC.wrap.Feature.createFeature(waypoint);\r\n                        })).then(function (features) {\r\n                            if (features) {\r\n                                features.forEach(function (feature) {\r\n                                    self.parent.layerTracking.addFeature(feature);\r\n                                });\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    self.parent.currentPositionWaiting = self.parent.getLoadingIndicator().addWait();\r\n\r\n                    if (!self.currentPositionTrk) {\r\n                        self.currentPositionTrk = [];\r\n                    }\r\n\r\n                    var getCurrentPositionInterval;\r\n                    var getCurrentPositionRequest = 0;\r\n                    var errorTimeout = 0;\r\n                    var toast = false;\r\n                    var options = {\r\n                        enableHighAccuracy: true, timeout: 600000\r\n                    };\r\n\r\n                    function getCurrentPosition(errorCallback) {\r\n                        var id = getCurrentPositionRequest++;\r\n                        navigator.geolocation.getCurrentPosition(\r\n                            function (data) {\r\n                                clearInterval(getCurrentPositionInterval);\r\n                                self.parent.getLoadingIndicator().removeWait(self.parent.currentPositionWaiting);\r\n                                self.positionChangehandler(data).then(function (obj) {\r\n                                    if (self.parent.geopositionTracking == true && obj && obj.marker && obj.accuracy) {\r\n                                        self.currentPositionTrk.push(navigator.geolocation.watchPosition(self.positionChangehandler.bind(self), self.parent.onGeolocateError.bind(self.parent), options));\r\n                                    }\r\n                                });\r\n                            },\r\n                            errorCallback ? errorCallback :\r\n                                function (error) {\r\n                                    switch (error.code) {\r\n                                        case error.TIMEOUT:\r\n                                            if (errorTimeout > 10) {\r\n                                                clearInterval(getCurrentPositionInterval);\r\n                                                self.parent.onGeolocateError.call(self.parent, error);\r\n                                            } else {\r\n                                                errorTimeout++;\r\n                                                getCurrentPosition(function () {\r\n                                                    clearInterval(getCurrentPositionInterval);\r\n                                                    if (!toast) {\r\n                                                        toast = true;\r\n                                                        self.parent.onGeolocateError.call(self.parent, error);\r\n                                                    }\r\n                                                });\r\n                                            }\r\n                                            break;\r\n                                        default:\r\n                                            clearInterval(getCurrentPositionInterval);\r\n                                            self.parent.onGeolocateError.call(self.parent, error);\r\n                                    }\r\n                                }, {\r\n                                timeout: 5000 + id,\r\n                                maximumAge: 10,\r\n                                enableHighAccuracy: true\r\n                            }\r\n                        );\r\n                    }\r\n                    getCurrentPositionInterval = setInterval(getCurrentPosition, 1000);\r\n\r\n                    setTimeout(function () {\r\n                        if (self.parent.layerTracking && self.parent.layerTracking.features && self.parent.layerTracking.features.length > 0 && self.parent.layerTracking.features[0].geometry.length == 0) {\r\n                            clearInterval(getCurrentPositionInterval);\r\n\r\n                            self.parent.getLoadingIndicator().removeWait(self.parent.currentPositionWaiting);\r\n                            self.map.toast(self.parent.getLocaleString(\"geo.error.permission_denied\"), {\r\n                                type: TC.Consts.msgType.WARNING\r\n                            });\r\n                            self.parent.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n                            self.parent.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n                        }\r\n                    }, options.timeout + 1000); // Wait extra second\r\n\r\n                });\r\n            }\r\n        } else {\r\n            self.parent.firstPosition = false;\r\n\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n\r\n            if (self.parent.trackCenterButton)\r\n                self.parent.trackCenterButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.activateSnapping = function () {\r\n        var self = this;\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            self.olMap.on([POINTERMOVE, SINGLECLICK], self._snapTrigger);\r\n            self.olMap.on(POSTCOMPOSE, self._postcomposeTrigger);\r\n        }\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.deactivateSnapping = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            if (!TC.Util.detectMobile()) {\r\n                olMap.un([POINTERMOVE, SINGLECLICK], self._snapTrigger);\r\n                olMap.un(POSTCOMPOSE, self._postcomposeTrigger);\r\n            }\r\n\r\n            if (self.snapInfo) {\r\n                olMap.removeOverlay(self.snapInfo);\r\n            }\r\n\r\n            if (self.snapInfoElement) {\r\n                self.snapInfoElement.style.display = 'none';\r\n            }\r\n\r\n            if (self.snapLine) {\r\n                delete self.snapLine;\r\n                olMap.render();\r\n            }\r\n        });\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.clear = function (layer) {\r\n        var self = this;\r\n\r\n        if (layer) {\r\n            layer.clearFeatures();\r\n        }\r\n\r\n        attachedDTD = false;\r\n\r\n        self.deactivateSnapping.call(self);\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.duringTrackSnap = function (e) {\r\n        var self = this;\r\n\r\n        var vectorContext = e.vectorContext;\r\n\r\n        if (vectorContext && self.snapLine) {\r\n            if (typeof (vectorContext.setFillStrokeStyle) === 'function')\r\n                vectorContext.setFillStrokeStyle(null, new ol.style.Stroke({\r\n                    color: 'rgba(197, 39, 55, 1)',\r\n                    width: 1\r\n                }));\r\n\r\n            if (typeof (vectorContext.drawGeometry) === 'function')\r\n                vectorContext.drawGeometry(self.snapLine.wrap.feature.getGeometry());\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.endSnap = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            /* cartel */\r\n            if (self.snapInfo) {\r\n                olMap.removeOverlay(self.snapInfo);\r\n            }\r\n            if (self.snapInfoElement) {\r\n                self.snapInfoElement.style.display = 'none';\r\n            }\r\n            /* línea */\r\n            if (self.snapLine) {\r\n                delete self.snapLine;\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.initSnap = function (coordinate, eventPixel) {\r\n        var self = this;\r\n\r\n        if (self.parent.layerTrack) {\r\n            var vectorSource = self.parent.layerTrack.wrap.layer.getSource();\r\n            var closestFeature = vectorSource.getClosestFeatureToCoordinate(coordinate);\r\n\r\n            if (closestFeature !== null) {\r\n                var geometry = closestFeature.getGeometry();\r\n                var closestPoint = geometry.getClosestPoint(coordinate);\r\n\r\n                // preparamos las Z del MDT si hay datos del MDT\r\n                if (self.parent.elevationChartData &&\r\n                    Array.isArray(self.parent.elevationChartData.secondaryElevationProfileChartData) &&\r\n                    self.parent.elevationChartData.secondaryElevationProfileChartData.length > 0 && \r\n                    self.parent.elevationChartData.secondaryElevationProfileChartData[0]) {\r\n                    let profileChartData = self.parent.elevationChartData.secondaryElevationProfileChartData[0];\r\n                    if (profileChartData.hasOwnProperty(\"ele\") &&\r\n                        Array.isArray(profileChartData.ele) && !profileChartData.hasOwnProperty(\"eleCoordinates\")) {\r\n                        let coords = [...closestFeature.getGeometry().getCoordinates()];\r\n\r\n                        if (Array.isArray(coords) && Array.isArray(coords[0])) {\r\n                            coords.forEach((c, i) => {\r\n                                c.splice(2, 1, self.parent.elevationChartData.secondaryElevationProfileChartData[0].ele[i])\r\n                            });\r\n\r\n                            self.parent.elevationChartData.secondaryElevationProfileChartData[0].eleCoordinates = coords;\r\n                        }\r\n                    }\r\n                }               \r\n\r\n                const pixel = self.parent.map.getPixelFromCoordinate(closestPoint);\r\n                const distance = Math.sqrt(\r\n                    Math.pow(eventPixel[0] - pixel[0], 2) +\r\n                    Math.pow(eventPixel[1] - pixel[1], 2));\r\n\r\n                if (distance > self.parent.snappingTolerance) {\r\n                    self.endSnap();\r\n                } else {\r\n                    var coordinates = [coordinate, [closestPoint[0], closestPoint[1]]];\r\n\r\n                    if (!self.snapLine) self.snapLine = new TC.feature.Polyline(coordinates, {});\r\n                    else self.snapLine.wrap.feature.getGeometry().setCoordinates(coordinates);\r\n\r\n                    // información del punto\r\n                    if (!self.snapInfoElement)\r\n                        self.snapInfoElement = document.getElementsByClassName('tc-ctl-geolocation-track-snap-info')[0];\r\n\r\n                    self.snapInfoElement.style.display = 'block';\r\n\r\n                    if (!self.snapInfo) {\r\n                        self.snapInfo = new ol.Overlay({\r\n                            element: self.snapInfoElement,\r\n                            offset: [5, 18]\r\n                        });\r\n\r\n                        self.olMap.addOverlay(self.snapInfo);\r\n                    }\r\n\r\n                    if (self.snapInfo.getMap() == undefined)\r\n                        self.snapInfo.setMap(self.olMap);\r\n\r\n                    self.snapInfo.setPosition(coordinate);\r\n\r\n                    var data = {};\r\n                    if (closestFeature.getGeometry().getType() != \"LineString\") {\r\n                        if (closestFeature.getKeys().indexOf('name') > -1)\r\n                            data.n = closestFeature.get('name');\r\n                    }\r\n\r\n                    var locale = self.parent.map.options.locale && self.parent.map.options.locale.replace('_', '-') || undefined;\r\n                    data.x = self.map.wrap.isGeo() ? closestPoint[0].toLocaleString(locale, { minimumFractionDigits: 5 }) : Math.round(closestPoint[0]).toLocaleString(locale);\r\n                    data.y = self.map.wrap.isGeo() ? closestPoint[1].toLocaleString(locale, { minimumFractionDigits: 5 }) : Math.round(closestPoint[1]).toLocaleString(locale);\r\n\r\n                    if (self.map.wrap.isGeo()) {\r\n                        data.isGeo = true;\r\n                    }\r\n\r\n                    var getZ = function (position) {\r\n                        return closestPoint[position] ? (Math.round(closestPoint[position] * 100) / 100).toLocaleString(locale) : undefined;\r\n                    };\r\n                    var getM = function (position) {\r\n                        return closestPoint[position] > 0 ? new Date(closestPoint[position]).toLocaleString(locale) : undefined;\r\n                    };\r\n\r\n                    if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYZM) {\r\n                        data.z = getZ(2);\r\n                        data.m = getM(3);\r\n                    } else if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYZ) {\r\n                        data.z = getZ(2);\r\n                    } else if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYM) {\r\n                        data.m = getM(2);\r\n                    }\r\n\r\n                    if (data) {\r\n                        // Z del MDT si hay datos del MDT\r\n                        if (self.parent.elevationChartData && self.parent.elevationChartData.secondaryElevationProfileChartData[0] &&\r\n                            self.parent.elevationChartData.secondaryElevationProfileChartData[0].eleCoordinates) {\r\n                            let mdtClosestPoint = TC.wrap.Geometry.getNearest(coordinate, self.parent.elevationChartData.secondaryElevationProfileChartData[0].eleCoordinates);\r\n                            let mdtZ = (Math.round(mdtClosestPoint[2] * 100) / 100).toLocaleString(locale);\r\n                            data.mdtz = mdtZ;\r\n                        }\r\n\r\n                        self.parent.getRenderedHtml(self.parent.CLASS + '-track-snapping-node', data, function (html) {\r\n                            self.snapInfoElement.innerHTML = html;\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        self.olMap.render();\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.drawTrackingData = function (track) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            const featurePromises = [];\r\n\r\n            const JSONParser = new TC.wrap.parser.JSON();\r\n            const features = JSONParser.parser.readFeatures(track.data);\r\n\r\n            features.filter(function (feature) {\r\n                return feature.getGeometry().getType().toLowerCase() === 'linestring' || feature.getGeometry().getType().toLowerCase() === 'multilinestring';\r\n            }).forEach(function (feature) {\r\n                feature.getGeometry().setCoordinates(feature.getGeometry().getCoordinates(), track.layout);\r\n            });\r\n\r\n            self.activateSnapping.call(self);\r\n\r\n            for (var i = 0, len = features.length; i < len; i++) {\r\n                featurePromises.push(TC.wrap.Feature.createFeature(features[i]));\r\n            }\r\n\r\n            Promise.all(featurePromises).then(function (feats) {\r\n                feats.forEach(function (feat) {\r\n                    if (feat) {\r\n                        self.parent.layerTrack.addFeature(feat);\r\n                    }\r\n                });\r\n                if (!(self.parent.toShare) || (self.parent.toShare && self.parent.toShare.doZoom)) {\r\n                    self.parent.map.zoomToFeatures(self.parent.layerTrack.features);\r\n                }\r\n\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.formattedFromStorage = function (storageData) {\r\n        const self = this;\r\n\r\n        if (self.parent.storageCRS !== self.parent.map.crs) {\r\n            var features = new ol.format.GeoJSON().readFeatures(storageData);\r\n            if (features) {\r\n                features = features.map(function (feature) {\r\n                    var clone = feature.clone();\r\n                    clone.getGeometry().transform(self.parent.storageCRS, self.parent.map.crs);\r\n                    clone.setId(feature.getId());\r\n                    return clone;\r\n                });\r\n\r\n                return new ol.format.GeoJSON().writeFeatures(features);\r\n            }\r\n        }\r\n\r\n        return storageData;\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.formattedToStorage = function (layer, removeTrackingProperty, notReproject) {\r\n        var self = this;\r\n\r\n        var parser = new TC.wrap.parser.JSON();\r\n        parser = parser.parser;\r\n\r\n        var features = layer.wrap.layer.getSource().getFeatures();\r\n        var layout;\r\n\r\n        features = features.map(function (feature) {\r\n            if (feature.getGeometry() instanceof ol.geom.LineString) {\r\n                layout = feature.getGeometry().getLayout();\r\n            }\r\n\r\n            if (removeTrackingProperty && feature.getProperties().tracking) {\r\n                feature.unset(\"tracking\");\r\n            }\r\n\r\n            if (!notReproject && self.parent.map.crs !== self.parent.storageCRS) {\r\n                var clone = feature.clone();\r\n                clone.getGeometry().transform(self.parent.map.crs, self.parent.storageCRS);\r\n                clone.setId(feature.getId());\r\n\r\n                return clone;\r\n            }\r\n\r\n            return feature;\r\n        }).sort(function (a, b) {\r\n\r\n            if (a.getGeometry() instanceof ol.geom.Point &&\r\n                !(b.getGeometry() instanceof ol.geom.Point)) {\r\n                return -1;\r\n            }\r\n\r\n            if (b.getGeometry() instanceof ol.geom.Point &&\r\n                !(a.getGeometry() instanceof ol.geom.Point)) {\r\n                return 2;\r\n            }\r\n\r\n            if (a.getProperties().name < b.getProperties().name) { return -1; }\r\n            if (a.getProperties().name > b.getProperties().name) { return 1; }\r\n\r\n            return 0;\r\n        });\r\n\r\n        return {\r\n            features: parser.writeFeatures(features), layout: layout\r\n        };\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.export = function (li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            self.parent.getTrackingData(li).then(function (data) {\r\n                if (data) {\r\n\r\n                    var olFeatures = new ol.format.GeoJSON().readFeatures(data.data);\r\n\r\n                    if (olFeatures.length === 0) {\r\n                        var geoJSON = self.parent.getTrackingData(li);\r\n                        olFeatures = new ol.format.GeoJSON().readFeatures(geoJSON);\r\n                    }\r\n\r\n                    Promise.all(olFeatures.map(function (feature) {\r\n                        return TC.wrap.Feature.createFeature(feature);\r\n                    })).then((features) => {\r\n                        resolve(features);\r\n                    });\r\n                } else {\r\n                    reject();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    var segmentsUnion = function (lineStrings) {\r\n        var mergedIndex = [];\r\n        var coords = [];\r\n        if (lineStrings.length > 1) {\r\n\r\n            if (lineStrings[0].length == 4) {\r\n                lineStrings = lineStrings.sort(function (a, b) {\r\n                    if (a[0][3] == b[0][3])\r\n                        return 0;\r\n                    else if (a[0][3] < b[0][3])\r\n                        return -1;\r\n                    else return 1;\r\n                });\r\n            }\r\n\r\n            for (var ls = 0; ls < lineStrings.length; ls++) {\r\n                var lineString = lineStrings[ls];\r\n                var nextLineIndex = -1;\r\n                var distance = Infinity;\r\n\r\n                var last = lineString.getLastCoordinate();\r\n                for (var nls = ls + 1; nls < lineStrings.length; nls++) {\r\n                    var first = lineStrings[nls].getFirstCoordinate();\r\n                    var d = Math.hypot(last[0] - first[0], last[1] - first[1]);\r\n                    if (d < distance) {\r\n                        nextLineIndex = nls;\r\n                        distance = d;\r\n                    }\r\n                }\r\n\r\n                if (mergedIndex.length < lineStrings.length) {\r\n                    if (mergedIndex.indexOf(ls) == -1) {\r\n                        mergedIndex.push(ls);\r\n                        coords = coords.concat(lineString.getCoordinates());\r\n                    }\r\n                    if (mergedIndex.indexOf(nextLineIndex) == -1) {\r\n                        mergedIndex.push(nextLineIndex);\r\n                        coords = coords.concat(lineStrings[nextLineIndex].getCoordinates());\r\n                    }\r\n                }\r\n            }\r\n\r\n            //self.map.toast(self.parent.getLocaleString(\"geo.trk.simulateWarning\"), { type: TC.Consts.msgType.WARNING });\r\n\r\n            return coords;\r\n        }\r\n\r\n        return lineStrings[0].getCoordinates();\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.processImportedFeatures = function (options) {\r\n        var self = this;\r\n\r\n        var source = self.parent.layerTrack.wrap.layer.getSource();\r\n        var fileName = self.parent.importedFileName;\r\n        var names = [];\r\n        var toAdd = [];\r\n        var toRemove = [];\r\n        var maybeRemove = [];\r\n        var features = source.getFeatures();\r\n\r\n        var segments = [];\r\n        var coord = [];\r\n\r\n        var getName = function (feature) {\r\n            if (feature.getProperties().hasOwnProperty(\"name\")) {\r\n                if (feature.getProperties().name.trim().length > 0)\r\n                    names.push(feature.getProperties().name);\r\n                else names.push(fileName);\r\n            }\r\n            else names.push(fileName);\r\n        };\r\n\r\n        for (var f = 0; f < features.length; f++) {\r\n            var feature = features[f];\r\n\r\n            if (feature instanceof TC.Feature)\r\n                feature = features[f].wrap.feature;\r\n\r\n            if (feature.getGeometry() instanceof ol.geom.Point) {\r\n                coord.push(feature.getGeometry().getCoordinates());\r\n                maybeRemove.push(feature);\r\n            }\r\n            else if (feature.getGeometry() instanceof ol.geom.LineString) {\r\n                // GLS: 31/01/2018 Routes (<rte>) are converted into LineString geometries, and tracks (<trk>) into MultiLineString, por tanto, las líneas las cargamos como N Rutas, no las unimos como hasta ahora: // segments.push(feature.getGeometry());                \r\n                getName(feature);\r\n                const newFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString(feature.getGeometry().getCoordinates(), feature.getGeometry().getLayout())\r\n                });\r\n                newFeature.setId(feature.getId() || TC.getUID());\r\n                toAdd.push(newFeature);\r\n                toRemove.push(feature);\r\n            }\r\n            else if (feature.getGeometry() instanceof ol.geom.MultiLineString) {\r\n                var clone = feature.clone();\r\n                getName(clone);\r\n\r\n                var ls = clone.getGeometry().getLineStrings();\r\n\r\n                var coords = segmentsUnion(ls);\r\n                const newFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString(coords, feature.getGeometry().getLayout())\r\n                });\r\n                newFeature.setId(feature.getId() || TC.getUID());\r\n                toAdd.push(newFeature);\r\n                toRemove.push(feature);\r\n            }\r\n        }\r\n\r\n        if (segments.length > 0) {\r\n            var coords = segmentsUnion(segments);\r\n            toAdd.push(new ol.Feature({\r\n                geometry: new ol.geom.LineString(coords)\r\n            }));\r\n        }\r\n\r\n        if (coord.length > 0 && maybeRemove.length == features.length) {\r\n            toAdd.push(new ol.Feature({\r\n                geometry: new ol.geom.LineString(coord)\r\n            }));\r\n        }\r\n\r\n        if (toRemove.length > 0) {\r\n            for (var i = 0; i < toRemove.length; i++) {\r\n                source.removeFeature(toRemove[i]);\r\n            }\r\n        }\r\n\r\n        if (toAdd.length > 0) {\r\n            var sameName = function (array, element) {\r\n                var indices = [];\r\n                var idx = array.indexOf(element);\r\n                while (idx != -1) {\r\n                    indices.push(idx);\r\n                    idx = array.indexOf(element, idx + 1);\r\n\r\n                    if (indices.length > 1)\r\n                        return true;\r\n                }\r\n\r\n                return indices.length > 1 ? true : false;\r\n            };\r\n\r\n            var featureToAdd;\r\n            var index = 0;\r\n            var processAdd = function () {\r\n                const promises = toAdd.map(function (ta, idx) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if (featureToAdd) {\r\n                            source.removeFeature(featureToAdd);\r\n                        }\r\n\r\n                        var name;\r\n                        if (names.length > idx) {\r\n                            var name = names[idx];\r\n                            if (sameName(names, name))\r\n                                name = '[' + (idx + 1) + ']' + ' ' + name;\r\n                        }\r\n\r\n                        self.parent.importedFileName = name ? name : fileName;\r\n\r\n                        featureToAdd = toAdd[idx];\r\n                        source.addFeature(featureToAdd);\r\n\r\n                        self.parent.saveTrack({\r\n                            message: self.parent.getLocaleString('geo.trk.upload.ok', { trackName: name ? name : fileName }),\r\n                            importedFileName: name ? name : fileName,\r\n                            notReproject: options.notReproject\r\n                        }).then(function (importedIndex) {\r\n                            if (idx == 0) {\r\n                                index = importedIndex;\r\n                            }\r\n                            resolve();\r\n                        });\r\n                    });\r\n                });\r\n                return Promise.all(promises);\r\n            };\r\n            processAdd().then(function () {\r\n\r\n                self.parent.layerTrack.setVisibility(false);\r\n                // la siguiente instrucción hace que se elimine del array de ids la línea y después no funciona la descarga de la feature.\r\n                // 13/11/2020 recupero la instrucción: sin el borrado de features al compartir un track se queda la importada en 4326 y \r\n                // la nueva ya gestionada, con lo que el zoom a la feature no funciona como debe. Después de todos los cambios en la gestión de \r\n                // IDs de las features de los track no he conseguido reproducir el problema del anterior comentario.\r\n                self.parent.layerTrack.clearFeatures();\r\n\r\n                self.parent.trigger(self.parent.Const.Event.IMPORTEDTRACK, { index: index });\r\n\r\n                delete self.parent.importedFileName;\r\n                self.parent.getLoadingIndicator().removeWait(options.wait);\r\n            });\r\n        } else {\r\n\r\n            if (self.parent.layerTrack) {\r\n                self.parent.map.removeLayer(self.parent.layerTrack);\r\n                self.parent.layerTrack = undefined;\r\n            }\r\n\r\n            delete self.parent.importedFileName;\r\n            self.parent.getLoadingIndicator().removeWait(options.wait);\r\n            TC.alert(self.parent.getLocaleString(\"geo.trk.upload.error4\"));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.import = function (wait, data, type) {\r\n        var self = this;\r\n        var vectorSource;\r\n        var listenerKey;\r\n\r\n        if (data && data.text) {\r\n\r\n            var layerOptions = self.parent.layerTrack.wrap.createVectorSource({\r\n                data: data.text,\r\n                type: type\r\n            });\r\n            vectorSource = layerOptions.source;\r\n\r\n            listenerKey = vectorSource.on('change', function (e) {\r\n                if (vectorSource.getState() == 'ready') {\r\n                    ol.Observable.unByKey(listenerKey);\r\n                    self.processImportedFeatures(wait);\r\n                }\r\n            });\r\n\r\n            var olLayer = self.parent.layerTrack.wrap.layer;\r\n            olLayer.setSource(vectorSource);\r\n\r\n        } else {\r\n\r\n            if (self.parent.layerTrack) {\r\n                self.parent.map.removeLayer(self.parent.layerTrack);\r\n                self.parent.layerTrack = undefined;\r\n            }\r\n\r\n            delete self.parent.importedFileName;\r\n            self.parent.getLoadingIndicator().removeWait(wait);\r\n            TC.alert(self.parent.getLocaleString(\"geo.trk.upload.error4\"));\r\n        }\r\n    };\r\n\r\n    var idRequestAnimationFrame;\r\n    TC.wrap.control.Geolocation.prototype.simulateTrackEnd = function (resized) {\r\n        var self = this;\r\n        \r\n        if (!resized) {\r\n            // revertimos: establecemos a false para que no muestra el progreso en el perfil ya que siempre será elevación 0\r\n            self.hasElevation = true;\r\n        }\r\n\r\n        self.parent.chartProgressClear();\r\n\r\n        if (self.simulateMarker) {\r\n            window.cancelAnimationFrame(idRequestAnimationFrame);\r\n            if (self.simulateMarker.layer.wrap.layer.getSource().getFeatures().length > 0)\r\n                self.simulateMarker.layer.removeFeature(self.simulateMarker);\r\n\r\n            delete self.simulateMarker;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n        var self = this;\r\n\r\n        var coordinates;\r\n        var features = self.parent.layerTrack.wrap.layer.getSource().getFeatures();\r\n        for (var ls = 0; ls < features.length; ls++) {\r\n            if (features[ls].getGeometry() instanceof ol.geom.LineString) {\r\n                coordinates = features[ls].getGeometry().getCoordinates();\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (coordinates && coordinates.length > 0) {\r\n            var first = coordinates[0];\r\n\r\n            var setSimulateMarker = function () {\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.simulateMarker) {\r\n                        self.parent.layerTrack.addPoint(first.slice(0, 2), {\r\n                            radius: 7,\r\n                            fillColor: '#ff0000',\r\n                            fillOpacity: 0.5,\r\n                            strokeColor: '#ffffff',\r\n                            strokeWidth: 2\r\n                        }).then(function (f) {\r\n                            resolve(f);\r\n                        });\r\n                    } else {\r\n                        self.simulateMarker.setCoords(first.slice(0, 2));\r\n                        resolve(self.simulateMarker);\r\n                    }\r\n                });\r\n            };\r\n            setSimulateMarker().then(function (f) {\r\n                self.simulateMarker = f;\r\n\r\n                var animationFrameFraction = function () {\r\n                    var trackLength = coordinates.length;\r\n                    var start, finish;\r\n                    var duration;\r\n                    var fraction;\r\n                    var hasTime = false;\r\n\r\n                    const toLength = function (coords) {\r\n                        if (self.parent.map.crs !== self.parent.map.options.utmCrs) {\r\n                            return TC.Util.reproject(coords, self.parent.map.crs, self.parent.map.options.utmCrs);\r\n                        }\r\n\r\n                        return coords;\r\n                    };\r\n\r\n                    var arCoordinates = coordinates;\r\n                    if (arCoordinates[0].length == 4 && arCoordinates[0][3] > 0) {\r\n                        start = arCoordinates[0][3];\r\n                        finish = arCoordinates[arCoordinates.length - 1][3];\r\n                        hasTime = true;\r\n                    } else {\r\n                        arCoordinates[0][3] = Date.now();\r\n\r\n                        for (var i = 1; i < arCoordinates.length; i++) {\r\n                            var done;\r\n                            arCoordinates[i][3] = 0;\r\n\r\n                            if (i + 1 < arCoordinates.length) {\r\n                                done = new ol.geom.LineString(toLength(arCoordinates.slice(i - 1, i + 1))).getLength();\r\n                            } else {\r\n                                done = new ol.geom.LineString(toLength(arCoordinates.slice(i - 1))).getLength();\r\n                            }\r\n\r\n                            arCoordinates[i][3] = arCoordinates[i - 1][3] + (3600000 * done / self.parent.walkingSpeed);\r\n                        }\r\n\r\n                        start = arCoordinates[0][3];\r\n                        finish = arCoordinates[arCoordinates.length - 1][3];\r\n                    }\r\n\r\n                    var trackFilm = new ol.geom.LineString(arCoordinates);\r\n                    var timestamp = start;\r\n                    var distance = 0;\r\n\r\n                    if (self.parent.map.crs !== self.parent.map.options.utmCrs) {\r\n                        distance = new ol.geom.LineString(toLength(JSON.parse(JSON.stringify(arCoordinates)))).getLength();\r\n                    } else {\r\n                        distance = trackFilm.getLength();\r\n                    }\r\n\r\n                    var done = 0;\r\n                    var getDoneAtM = function (m) {\r\n                        for (var i = 0; i < arCoordinates.length; i++) {\r\n                            if (arCoordinates[i][3] > m)\r\n                                return {\r\n                                    d: new ol.geom.LineString(toLength(arCoordinates.slice(0, i))).getLength(),\r\n                                    p: arCoordinates[i - 1].slice(0, 2)\r\n                                };\r\n                        }\r\n                    };\r\n\r\n                    var loopAtFraction = function () {\r\n\r\n                        if (!self.parent.simulate_paused) {\r\n                            var position = trackFilm.getCoordinateAtM(timestamp);\r\n                            var d = getDoneAtM(timestamp);\r\n\r\n                            if (fraction >= 1 || !position || !d) {\r\n                                var li = self.parent.getSelectedTrack();\r\n                                if (li)\r\n                                    self.parent.uiSimulate(false, li);\r\n\r\n                                if (self.parent.hasElevation) {\r\n                                    self.parent.chartProgressClear();\r\n                                }\r\n\r\n                                self.simulateTrackEnd();\r\n\r\n                                return;\r\n                            } else {\r\n\r\n                                if (self.parent.hasElevation) {\r\n                                    self.parent.chartSetProgress(d, position, distance, (hasTime ? self.parent._getTime(arCoordinates[0][3], position[3]) : false));\r\n                                }\r\n\r\n                                if (self.simulateMarker) {\r\n                                    var from = self.simulateMarker.getCoords();\r\n                                    var to = position;\r\n                                    var rotation = Math.atan2(to[1] - from[1], to[0] - from[0]) * 180 / Math.PI;\r\n\r\n                                    self.simulateMarker.setCoords(position);\r\n                                    //self.simulateMarker.setStyle({ angle: rotation });\r\n                                }\r\n\r\n                                if (self.parent.simulate_speed !== 1)\r\n                                    timestamp = timestamp + (self.parent.delta * self.parent.simulate_speed);\r\n                                else\r\n                                    timestamp = timestamp + self.parent.delta;\r\n                            }\r\n                        }\r\n\r\n                        idRequestAnimationFrame = requestAnimationFrame(loopAtFraction);\r\n                    };\r\n                    idRequestAnimationFrame = requestAnimationFrame(loopAtFraction);\r\n\r\n                };\r\n\r\n                const hasD3 = new Promise(function (resolve, reject) {\r\n                    if (window.d3) {\r\n                        resolve();\r\n                    }\r\n                    else {\r\n                        TC.loadJS(!window.d3, [TC.Consts.url.D3C3], function () {\r\n                            resolve();\r\n                        });\r\n                    }\r\n                });\r\n                hasD3.then(function () {\r\n                    idRequestAnimationFrame = requestAnimationFrame(animationFrameFraction);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.headingChangehandler = function (evt) {\r\n        var self = this;\r\n        if (!self.parent.track.infoOnMap) {\r\n            self.parent.track.infoOnMap = document.createElement('div');\r\n            const iomStyle = self.parent.track.infoOnMap.style;\r\n            iomStyle.overFlowY = 'scroll';\r\n            iomStyle.height = '200px';\r\n            iomStyle.width = '200px';\r\n            iomStyle.top = '0';\r\n            iomStyle.left = '100px';\r\n            iomStyle.backgroundColor = 'fuchsia';\r\n            iomStyle.position = 'absolute';\r\n            self.parent.map.div.appendChild(self.parent.track.infoOnMap);\r\n        }\r\n\r\n        self.parent.track.infoOnMap.style.display = '';\r\n\r\n        self.heading = evt.target.getHeading();\r\n\r\n        self.parent.track.infoOnMap.innerHTML = self.parent.track.infoOnMap.innerHTML +\r\n            '<br> <p> salta headingChangehandler </p> <br> <p> evt.target.getHeading(): ' + self.heading + ' </p>';\r\n\r\n\r\n\r\n        self.map.wrap.getMap().then(function (map) {\r\n            map.getView().setRotation(-self.heading);\r\n        });\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.orientationChangehandler = function (event) {\r\n        var self = this;\r\n\r\n        var view = self.map.wrap.map.getView();\r\n        var center = view.getCenter();\r\n        var resolution = view.getResolution();\r\n        var beta = event.target.getBeta() || 0;\r\n        var gamma = event.target.getGamma() || 0;\r\n\r\n        center[0] -= resolution * gamma * 25;\r\n        center[1] += resolution * beta * 25;\r\n\r\n        view.setCenter(view.constrainCenter(center));\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.pulsate = function (circle) {\r\n        var self = this;\r\n\r\n        self.pulsated = true;\r\n\r\n        var radius = circle.wrap.feature.getGeometry().getRadius();\r\n        var start = new Date().getTime();\r\n\r\n        var duration = 500;\r\n        var listenerKey;\r\n\r\n        var getRadius = function (elapsed) {\r\n            switch (true) {\r\n                case elapsed <= 50:\r\n                    return radius;\r\n                case elapsed > 50 && elapsed <= 100:\r\n                    return radius * 1.02;\r\n                case elapsed > 100 && elapsed <= 150:\r\n                    return radius * 1.05;\r\n                case elapsed > 150 && elapsed <= 200:\r\n                    return radius * 1.02;\r\n                case elapsed > 200 && elapsed <= 300:\r\n                    return radius;\r\n                case elapsed > 300 && elapsed <= 350:\r\n                    return radius * 1.02;\r\n                case elapsed > 350 && elapsed <= 400:\r\n                    return radius * 1.05;\r\n                case elapsed > 400 && elapsed <= 450:\r\n                    return radius * 1.02;\r\n                case elapsed > 450 && elapsed <= 500:\r\n                    return radius * 1;\r\n                default:\r\n                    return radius;\r\n            }\r\n        };\r\n        listenerKey = self.olMap.on(POSTCOMPOSE, function (event) {\r\n            var vectorContext = event.vectorContext;\r\n            var frameState = event.frameState;\r\n\r\n            var elapsed = frameState.time - start;\r\n\r\n            var f = circle.wrap.feature.getGeometry().clone();\r\n            var r = getRadius(elapsed);\r\n            f.setRadius(r);\r\n\r\n            vectorContext.setFillStrokeStyle(\r\n                new ol.style.Fill({\r\n                    color: 'rgba(0, 0, 0, 0.1)'\r\n                }),\r\n                new ol.style.Stroke({\r\n                    color: 'rgba(255, 0, 0, .8)', width: 1\r\n                })\r\n            );\r\n            vectorContext.drawCircleGeometry(f);\r\n\r\n            if (elapsed > duration) {\r\n                ol.Observable.unByKey(listenerKey);\r\n                return;\r\n            }\r\n\r\n            frameState.animate = true;\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.register = function (map) {\r\n        const self = this;\r\n        self.map = map;\r\n\r\n        map.wrap.getMap().then(function (olMap) {\r\n            self.olMap = olMap;\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.showElevationMarker = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const data = options.data;\r\n        const layer = options.layer;\r\n        const coords = options.coords;\r\n\r\n        if (!self.elevationMarker) {\r\n            const elm = document.createElement('div');\r\n            elm.style.display = 'none';\r\n            elm.classList.add(self.parent.CLASS + '-overlay', 'elevation');\r\n            self.elevationMarker = new ol.Overlay({\r\n                id: 'ovElevationMarker',\r\n                element: elm,\r\n                offset: [0, 0],\r\n                positioning: ol.OverlayPositioning.CENTER_CENTER,\r\n                stopEvent: false\r\n            });\r\n        }\r\n\r\n        // GLS: si la capa del track está visible mostramos marcamos punto del gráfico en el mapa\r\n        if (!layer || (layer.getVisibility() && layer.getOpacity() > 0)) {\r\n            let position = coords[data[0].index];\r\n            self.elevationMarker.getElement().style.display = '';\r\n            if (!self.olMap.getOverlayById(self.elevationMarker.getId())) {\r\n                self.olMap.addOverlay(self.elevationMarker);\r\n                if (self.map.on3DView) {\r\n                    self.map.view3D.addElevationMarker(position, self.parent);\r\n                }\r\n            }\r\n            self.elevationMarker.setPosition(position);\r\n            if (self.map.on3DView) {\r\n                self.map.view3D.setElevationMarker(position, self.parent);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.hideElevationMarker = function () {\r\n        const self = this;\r\n        if (self.elevationMarker) {\r\n            self.elevationMarker.getElement().style.display = 'none';\r\n\r\n            if (self.map.on3DView) {\r\n                self.map.view3D.hideElevationMarker(self.parent);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.coordsActivate = function () {\r\n        var self = this;\r\n\r\n        self.olMap.on(SINGLECLICK, self._coordsTrigger);\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.coordsDeactivate = function () {\r\n        var self = this;\r\n\r\n        self.olMap.un(SINGLECLICK, self._coordsTrigger);\r\n    };\r\n\r\n    TC.wrap.Parser = function () {\r\n    };\r\n\r\n    TC.wrap.Parser.prototype.read = function (data) {\r\n        var result = [];\r\n        var self = this;\r\n        if (self.parser) {\r\n            if (!TC.Feature) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/Feature');\r\n            }\r\n            result = self.parser.readFeatures(data).map(function (feat) {\r\n                return new TC.Feature(null, {\r\n                    id: feat.getId(), data: feat.getProperties()\r\n                });\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Parser.prototype.readFeatures = function (data) {\r\n        var result = [];\r\n        var self = this;\r\n        if (self.parser) {\r\n            if (!TC.Feature) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/Feature');\r\n            }\r\n            result = self.parser.readFeatures(data).map(function (feat) {\r\n                let coordinates = feat.getGeometry().getCoordinates();\r\n                const featureOptions = {};\r\n                switch (feat.getGeometry().getType()) {\r\n                    case \"LineString\":\r\n                        geometry = new TC.feature.Polyline(coordinates, featureOptions);\r\n                        break;\r\n                    case \"Polygon\":\r\n                        geometry = new TC.feature.Polygon(coordinates, featureOptions);\r\n                        break;\r\n                    case \"MultiPoint\":\r\n                        geometry = new TC.feature.MultiPoint(coordinates, featureOptions);\r\n                        break;\r\n                    case \"MultiLineString\":\r\n                        geometry = new TC.feature.MultiPolyline(coordinates, featureOptions);\r\n                        break;\r\n                    case \"MultiPolygon\":\r\n                        geometry = new TC.feature.MultiPolygon(coordinates, featureOptions);\r\n                        break;\r\n                    case \"Point\":\r\n                    default:\r\n                        geometry = new TC.feature.Point(coordinates, featureOptions);\r\n                        break;\r\n                }\r\n                return geometry;\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.parser = {\r\n        WFS: function (options) {\r\n            this.parser = new ol.format.WFS(options);\r\n        },\r\n        JSON: function (options) {\r\n            this.parser = new ol.format.GeoJSON(options);\r\n        }\r\n    };\r\n    TC.inherit(TC.wrap.parser.WFS, TC.wrap.Parser);\r\n    TC.inherit(TC.wrap.parser.JSON, TC.wrap.Parser);\r\n\r\n    TC.wrap.control.OverviewMap.prototype.register = function (map) {\r\n        var self = this;\r\n\r\n        self.parent.layer.wrap.getLayer().then(function setOVMap(olLayer) {\r\n            self.ovMap = new ol.control.OverviewMap({\r\n                target: self.parent.div,\r\n                collapsed: false,\r\n                collapsible: false,\r\n                className: self.parent.CLASS + ' ol-overviewmap',\r\n                layers: [olLayer]\r\n            });\r\n            self.ovMap._wrap = self;\r\n\r\n            /* 08/02/2019 GLS: \r\n                Establecemos el pixelRatio siempre a uno (aunque el control instancie un olMap internamente no admite el paso de la opción pixelRatio,\r\n                imposible de entender, por eso lo hago directamente), porque OL sólo atiende al valor al principio,\r\n                si después se hace zoom in/out del navegador, OL no atiende el cambio lo que provoca que el mapa se vea borroso, click se sitúa mal,\r\n                popup se sitúa entre otros efectos.\r\n                Lo gestionamos nosotros hasta que lo soporten del todo. Relacionado con las tareas/bugs:\r\n                    Bug 25976:Mapa situación en blanco\r\n                    Bug 25954:Canvas en blanco con zoom mayor al 100%\r\n                    Bug 23855:Mapa de situación se muestra en blanco\r\n            */\r\n            self.ovMap.getOverviewMap().pixelRatio_ = 1;\r\n\r\n            // Quitamos el drag&drop añadido en OL 4.1.0 machacando el overlay\r\n            self.ovMap.ovmap_.removeOverlay(self.ovMap.boxOverlay_);\r\n            var box = document.createElement('DIV');\r\n            box.className = 'ol-overviewmap-box';\r\n            box.style.boxSizing = 'border-box';\r\n            self.ovMap.boxOverlay_ = new ol.Overlay({\r\n                position: [0, 0],\r\n                positioning: ol.OverlayPositioning.BOTTOM_LEFT,\r\n                element: box\r\n            });\r\n            self.ovMap.ovmap_.addOverlay(self.ovMap.boxOverlay_);\r\n\r\n            // mantenemos el ancho y alto del canvas en números enteros\r\n            self.manageSize.call(self.ovMap.ovmap_);\r\n\r\n            self._boxElm = self.ovMap.boxOverlay_.getElement();\r\n\r\n            TC.loadJS(\r\n                !window.Draggabilly,\r\n                [TC.apiLocation + TC.Consts.url.DRAGGABILLY],\r\n                function () {\r\n                    var ovmMap = self.ovMap.ovmap_;\r\n                    const drag = new Draggabilly(self._boxElm);\r\n                    // Parcheamos Draggabilly para que respete las otras transformaciones, por ejemplo rotación.\r\n                    drag.positionDrag = function () {\r\n                        const style = this.element.style;\r\n                        const newTransform = 'translate3d( ' + this.dragPoint.x +\r\n                            'px, ' + this.dragPoint.y + 'px, 0)';\r\n                        if (style.transform.length) {\r\n                            const idxStart = style.transform.indexOf('translate3d');\r\n                            if (idxStart >= 0) {\r\n                                const idxEnd = style.transform.indexOf(')', idxStart);\r\n                                style.transform = style.transform.replace(style.transform.substring(idxStart, idxEnd + 1), newTransform);\r\n                            }\r\n                            else {\r\n                                style.transform = newTransform + ' ' + style.transform;\r\n                            }\r\n                        }\r\n                        else {\r\n                            style.transform = newTransform;\r\n                        }\r\n                    };\r\n                    drag.on('pointerDown', function (e) {\r\n                        drag.dragged = self._boxElm.cloneNode();\r\n                        drag.dragged.classList.add(TC.Consts.classes.ACTIVE);\r\n                        drag.dragged.style.position = 'absolute';\r\n                        self._boxElm.insertAdjacentElement('beforebegin', drag.dragged);\r\n                        if (map.maxExtent) {\r\n                            var bottomLeft = ovmMap.getPixelFromCoordinate([map.maxExtent[0], map.maxExtent[1]]);\r\n                            var topRight = ovmMap.getPixelFromCoordinate([map.maxExtent[2], map.maxExtent[3]]);\r\n                            var mapSize = ovmMap.getSize();\r\n                            const container = document.createElement('div');\r\n                            container.style.position = 'absolute';\r\n                            container.style.bottom = Math.round(mapSize[1] - bottomLeft[1]) + 'px';\r\n                            container.style.left = Math.round(bottomLeft[0]) + 'px';\r\n                            container.style.top = Math.round(topRight[1]) + 'px';\r\n                            container.style.right = Math.round(mapSize[0] - topRight[0]) + 'px';\r\n                            const viewport = ovmMap.getViewport();\r\n                            viewport.insertBefore(container, viewport.firstElementChild);\r\n                            drag.options.containment = container;\r\n                        }\r\n                    });\r\n                    drag.on('pointerUp', function (e) {\r\n                        drag.dragged.parentElement.removeChild(drag.dragged);\r\n                        if (map.maxExtent) {\r\n                            ovmMap.getViewport().removeChild(drag.options.containment);\r\n                            drag.options.containment = null;\r\n                        }\r\n                    });\r\n                    drag.on('dragMove', function (e, pointer, moveVector) {\r\n                        drag._delta = moveVector;\r\n                    });\r\n                    drag.on('dragEnd', function (e, pointer) {\r\n                        var olMap = self.ovMap.getMap();\r\n                        var view = olMap.getView();\r\n                        var centerPixel = ovmMap.getPixelFromCoordinate(view.getCenter());\r\n                        var newCenter = ovmMap.getCoordinateFromPixel([centerPixel[0] + drag._delta.x, centerPixel[1] + drag._delta.y]);\r\n                        var extent = map.getExtent();\r\n                        var halfWidth = (extent[2] - extent[0]) / 2;\r\n                        var halfHeight = (extent[3] - extent[1]) / 2;\r\n\r\n                        if (newCenter[0] + halfWidth > map.maxExtent[2]) {\r\n                            newCenter[0] = map.maxExtent[2] - halfWidth;\r\n                        }\r\n                        else if (newCenter[0] - halfWidth < map.maxExtent[0]) {\r\n                            newCenter[0] = map.maxExtent[0] + halfWidth;\r\n                        }\r\n                        if (newCenter[1] + halfHeight > map.maxExtent[3]) {\r\n                            newCenter[1] = map.maxExtent[3] - halfHeight;\r\n                        }\r\n                        else if (newCenter[1] - halfHeight < map.maxExtent[1]) {\r\n                            newCenter[1] = map.maxExtent[1] + halfHeight;\r\n                        }\r\n\r\n                        drag.setPosition(0, 0);\r\n                        delete drag._delta;\r\n                        map.setCenter(newCenter, { animate: true });\r\n                    });\r\n                });\r\n\r\n            map.wrap.getMap().then(function (olMap) {\r\n\r\n                // Modificamos mapa para que tenga la proyección correcta\r\n                self.reset();\r\n\r\n                const load = self.parent.div.querySelector('.' + self.parent.CLASS + '-load');\r\n                olLayer._wrap.$events.on(TC.Consts.event.BEFORETILELOAD, function () {\r\n                    load.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    load.classList.add(TC.Consts.classes.VISIBLE);\r\n                });\r\n                olLayer._wrap.$events.on(TC.Consts.event.TILELOAD, function () {\r\n                    load.classList.remove(TC.Consts.classes.VISIBLE);\r\n                    load.classList.add(TC.Consts.classes.HIDDEN);\r\n                });\r\n\r\n                olMap.addControl(self.ovMap);\r\n\r\n                self.parent.isLoaded = true;\r\n                self.parent.trigger(TC.Consts.event.MAPLOAD);\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.reset = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const setLayer = function (layer, crs) {\r\n                if (layer.type === TC.Consts.layerType.WMTS) {\r\n                    var layerProjectionOptions = { crs: crs || self.parent.map.crs, oldCrs: layer.wrap.layer.getSource().getProjection().getCode() }; // , allowFallbackLayer: true\r\n\r\n                    if (layerProjectionOptions.oldCrs !== layerProjectionOptions.crs) {\r\n                        layer.setProjection(layerProjectionOptions);\r\n                    }\r\n                }\r\n\r\n                layer.wrap.getLayer().then(function (olLayer) {\r\n\r\n                    var olView = new ol.View(getResolutionOptions(self.parent.map.wrap, olLayer._wrap.parent));\r\n\r\n                    if (olView.getResolutions()) {\r\n                        olView.setResolution(olView.getResolutions().filter(function (res) {\r\n                            return res > olView.getResolutionForExtent(self.parent.map.getExtent(), olMap.getSize())\r\n                        }).reverse()[0]);\r\n\r\n                        olMap.setView(olView);\r\n                    } else if (olView.getProjection().getCode() !== olMap.getView().getProjection().getCode()) {\r\n                        olMap.setView(olView);\r\n                    }\r\n\r\n                    // para controlar el mapa en blanco en IE en la carga inicial\r\n                    olLayer._wrap.$events.one(TC.Consts.event.TILELOAD, function () {\r\n                        olMap.getLayers().getArray()[0].getSource().refresh();\r\n                    });\r\n\r\n                    if (layer !== self.parent.layer || olMap.getLayers().getArray().indexOf(layer) === -1) {\r\n\r\n                        self.parent.map.trigger(TC.Consts.event.OVERVIEWBASELAYERCHANGE, { oldLayer: layer !== self.parent.layer ? self.parent.layer : null, newLayer: layer });\r\n                        olMap.getLayers().forEach(function (l) {\r\n                            if (l instanceof ol.layer.Image || l instanceof ol.layer.Tile) {\r\n                                olMap.removeLayer(l);\r\n                            }\r\n                        });\r\n\r\n                        const load = self.parent.div.querySelector('.' + self.parent.CLASS + '-load');\r\n                        olLayer._wrap.$events.on(TC.Consts.event.BEFORETILELOAD, function () {\r\n                            load.classList.remove(TC.Consts.classes.HIDDEN);\r\n                            load.classList.add(TC.Consts.classes.VISIBLE);\r\n                        });\r\n                        olLayer._wrap.$events.on(TC.Consts.event.TILELOAD, function () {\r\n                            load.classList.remove(TC.Consts.classes.VISIBLE);\r\n                            load.classList.add(TC.Consts.classes.HIDDEN);\r\n                        });\r\n\r\n                        olMap.getLayers().insertAt(0, olLayer); // GLS: no usamos .addLayer(olLayer) para asegurar que la capa a añadir quede como fondo.\r\n                    }\r\n\r\n                    resolve(layer);\r\n                });\r\n            };\r\n\r\n            options = options || {};\r\n            var layer = options.layer || self.parent.layer;\r\n            if (self.parent.map && layer && self.ovMap) {\r\n                var olMap = self.ovMap.ovmap_;\r\n\r\n                layer.getCapabilitiesPromise().then(function () {\r\n\r\n                    var originalLayer = layer;\r\n\r\n                    if (!layer.isCompatible(self.parent.map.crs) && layer.wrap.getCompatibleMatrixSets(self.parent.map.crs).length === 0) {\r\n                        layer = layer.getFallbackLayer() || self.parent.defaultLayer;\r\n\r\n                        layer.getCapabilitiesPromise().then(function () {\r\n                            if (self.parent.map.on3DView && !layer.isCompatible(self.parent.map.crs)) {\r\n                                self.parent.map.loadProjections({\r\n                                    crsList: originalLayer.getCompatibleCRS(),\r\n                                    orderBy: 'name'\r\n                                }).then(function (projList) {\r\n                                    setLayer(originalLayer, projList[0].code);\r\n                                });\r\n                            } else if (layer.isCompatible(self.parent.map.crs)) {\r\n                                setLayer(layer);\r\n                            }\r\n                        });\r\n                    } else {\r\n                        setLayer(layer);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.get3DCameraLayer = function () {\r\n        var self = this;\r\n        var result = null;\r\n        var camLayerId = '3DCamera';\r\n        var ovMap;\r\n\r\n        if (self.ovMap) {\r\n            ovMap = self.ovMap.getOverviewMap();\r\n            ovMap.getLayers().forEach(function (elm) {\r\n                if (elm.get('id') === camLayerId) {\r\n                    result = elm;\r\n                }\r\n            });\r\n\r\n            if (!result) {\r\n                var ovMap = self.ovMap.getOverviewMap();\r\n                var fovStyle = createNativeStyle({});\r\n                // Ponemos los cuadriláteros de fov sin relleno (por legibilidad)\r\n                fovStyle[0].getFill().setColor([0, 0, 0, 0]);\r\n                result = new ol.layer.Vector({\r\n                    id: camLayerId,\r\n                    source: new ol.source.Vector(),\r\n                    style: fovStyle\r\n                });\r\n                ovMap.addLayer(result);\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.draw3DCamera = function (options) {\r\n        var self = this;\r\n\r\n        if (this.parent.map.isLoaded) {\r\n            self.is3D = !!options;\r\n            var camLayer = self.get3DCameraLayer();\r\n            if (camLayer) {\r\n                var feature;\r\n                options = options || {\r\n                };\r\n                var fov = options.fov;\r\n                var source = camLayer.getSource();\r\n                if (!fov || !fov.length) { // no vemos terreno o no estamos en vista 3D\r\n                    source.clear();\r\n                }\r\n                else {\r\n                    var features = source.getFeatures();\r\n                    if (!features.length) {\r\n                        feature = new ol.Feature();\r\n                        source.addFeature(feature);\r\n                    }\r\n                    else {\r\n                        feature = features[0];\r\n                    }\r\n                    feature.setGeometry(new ol.geom.Polygon([fov]));\r\n                }\r\n                var heading = (typeof options.heading === 'number') ? options.heading : 0;\r\n                self._boxElm.style.transform = 'rotate(' + heading + 'rad)';\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.enable = function () {\r\n        var self = this;\r\n        if (self.parent.layer && self.parent.layer.setVisibility) {\r\n            self.parent.layer.setVisibility(true);\r\n\r\n            /* GLS: bug 23855: mapa de situación se muestra en blanco\r\n                En el resize se valida el alto y el ancho y como el div padre (id = \"ovmap\") tiene display: none, \r\n                el ancho y el alto devuelven cero y por ello se muestra en blanco. \r\n                No vale con lanzar .trigger('resize') porque no utiliza los valores actuales del div, \r\n                sino los almacenados, por eso llamamos a updateSize que actualiza dichos valores.\r\n                https://tfsapp.tracasa.es:8088/tfs/web/wi.aspx?pcguid=4819cc6e-400e-4f70-ba7c-c18a830405aa&id=23855                \r\n            */\r\n            self.parent.wrap.ovMap.ovmap_.updateSize();\r\n\r\n            // Lo siguiente es para actualizar mapa de situación\r\n            const resizeEvent = document.createEvent('HTMLEvents');\r\n            resizeEvent.initEvent('resize', false, false);\r\n            self.parent.map.div.dispatchEvent(resizeEvent);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.disable = function () {\r\n        var self = this;\r\n        if (self.parent.layer && self.parent.layer.setVisibility) {\r\n            self.parent.layer.setVisibility(false);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.manageSize = function () {\r\n        const self = this;\r\n\r\n        TC.wrap.Map.prototype.manageSize.call(self);\r\n    };\r\n\r\n    TC.wrap.control.FeatureInfo.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            TC.wrap.control.Click.prototype.register.call(self, map);\r\n            var _clickTrigger = self._trigger;\r\n            self._trigger = function (e) {\r\n                var result = _clickTrigger.call(self, e);\r\n                if (result) {\r\n                    self.parent.beforeRequest({ xy: e.pixel });\r\n                }\r\n                else {\r\n                    map.trigger(TC.Consts.event.NOFEATUREINFO, { control: self.parent });\r\n                }\r\n                return result;\r\n            }\r\n        });\r\n    };\r\n\r\n    var bufferElm;\r\n    var getElementText = function (elm) {\r\n        var text = elm.innerHTML || elm.textContent;\r\n        bufferElm = bufferElm || document.createElement(\"textarea\");\r\n        bufferElm.innerHTML = text;\r\n        return bufferElm.value;\r\n    };\r\n\r\n    var esriXmlParser = {\r\n        readFeatures: function (text) {\r\n            var result = [];\r\n            var dom = (new DOMParser()).parseFromString(text, 'text/xml');\r\n            if (dom.documentElement.tagName === 'FeatureInfoResponse') {\r\n                var fiCollections = dom.documentElement.getElementsByTagName('FeatureInfoCollection');\r\n                for (var i = 0, len = fiCollections.length; i < len; i++) {\r\n                    var fic = fiCollections[i];\r\n                    var layerName = fic.getAttribute('layername');\r\n                    var fInfos = fic.getElementsByTagName('FeatureInfo');\r\n                    for (var j = 0, lenj = fInfos.length; j < lenj; j++) {\r\n                        var fields = fInfos[j].getElementsByTagName('Field');\r\n                        var attributes = {\r\n                        };\r\n                        for (var k = 0, lenk = fields.length; k < lenk; k++) {\r\n                            var field = fields[k];\r\n                            attributes[getElementText(field.getElementsByTagName('FieldName')[0])] = getElementText(field.getElementsByTagName('FieldValue')[0]);\r\n                        }\r\n                        var feature = new ol.Feature(attributes);\r\n                        feature.setId(layerName + '.' + TC.getUID());\r\n                        result.push(feature);\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        }\r\n    };\r\n\r\n    var addLayerToService = function (service, layer, name) {\r\n        var path = layer.getPath(name);\r\n        service.layers.push({\r\n            name: name,\r\n            title: path[path.length - 1],\r\n            path: path.slice(1),\r\n            features: [],\r\n            filter: layer.filter\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.FeatureInfo.prototype.getFeatureInfo = function (coords, resolution, options) {\r\n        var self = this;\r\n        var opts = options || {};\r\n        var map = self.parent.map;\r\n        return new Promise(function (resolve, reject) {\r\n            map.wrap.getMap().then(function (olMap) {\r\n                var targetServices = {};\r\n                var auxInfo = {};\r\n                const requestPromises = [];\r\n                const requestDataArray = [];\r\n                var featurePromises = [];\r\n                var services = [];\r\n\r\n                //var infoFormats = [];\r\n                var layers = olMap.getLayers().getArray();\r\n\r\n                // GLS: filtro el array de capas para quedarnos con las capas que son raster y visibles.\r\n                layers = layers.filter(function (elem) { return elem instanceof ol.layer.Image && elem.getVisible(); });\r\n\r\n                for (var j = 0; j < layers.length; j++) {\r\n                    var olLayer = layers[j];\r\n                    var layer = olLayer._wrap.parent;\r\n                    var source = olLayer.getSource();\r\n                    //console.log(\"Source: \" + layer.layerNames.join(\",\"));\r\n                    //Por qué en workLayers están el vectorial de medición, y cosas así?\r\n                    if (source.getGetFeatureInfoUrl && map.workLayers.indexOf(layer) >= 0 && layer.names.length > 0\r\n                        && (!opts.serviceUrl || opts.serviceUrl === layer.url)) { // Mirar si en las opciones pone que solo busque en un servicio\r\n\r\n                        //\r\n                        var targetService;\r\n                        if (!targetServices[layer.url]) {\r\n                            targetService = {\r\n                                url: layer.url,\r\n                                layers: [],\r\n                                mapLayers: [],\r\n                                title: layer.title,\r\n                                request: null\r\n                            };\r\n                            targetServices[layer.url] = targetService;\r\n                            auxInfo[layer.url] = {\r\n                                source: TC.Util.extend(true, {}, source),\r\n                                layers: []\r\n                            };\r\n                        }\r\n                        else {\r\n\r\n                            targetService = targetServices[layer.url];\r\n                            auxInfo[layer.url].source.updateParams(TC.Util.extend(auxInfo[layer.url].source.getParams(), source.getParams()));\r\n                        }\r\n                        targetService.mapLayers.push(layer);\r\n\r\n                        //var targetService = {\r\n                        //    layers: [], mapLayers: [layer]\r\n                        //};\r\n                        var disgregatedNames = layer.getDisgregatedLayerNames();\r\n                        if (opts.layerName) { // Mirar si en las opciones pone que solo busque en una capa\r\n                            if (disgregatedNames.indexOf(opts.layerName) >= 0 && olLayer._wrap.getInfo(opts.layerName).queryable) {\r\n                                addLayerToService(targetService, layer, opts.layerName);\r\n                                auxInfo[layer.url].layers.push(opts.layerName);\r\n                            }\r\n                        }\r\n                        else {\r\n                            for (var i = 0; i < disgregatedNames.length; i++) {\r\n                                var name = disgregatedNames[i];\r\n                                if (olLayer._wrap.getInfo(name).queryable) {\r\n                                    addLayerToService(targetService, layer, name);\r\n                                }\r\n                                else {\r\n                                    TC.Util.consoleRegister('Capa \"' + disgregatedNames[i] + '\" no queryable, la eliminamos de la petición GFI');\r\n                                    disgregatedNames.splice(i, 1);\r\n                                    i = i - 1;\r\n                                }\r\n\r\n                            }\r\n\r\n                            // GLS: validamos si nos queda alguna capa a la cual consultar\r\n                            if (disgregatedNames.length > 0) {\r\n                                auxInfo[layer.url].layers = auxInfo[layer.url].layers.concat(disgregatedNames);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                const _isGMLFilter = function (filter) {\r\n                    return filter && (/<ogc:Filter.*<\\/ogc:Filter>/.test(filter) || filter instanceof TC.filter.Filter)\r\n                }\r\n                for (var serviceUrl in targetServices) {\r\n                    services.push(targetServices[serviceUrl]);\r\n                    var targetService = targetServices[serviceUrl];\r\n                    var source = auxInfo[serviceUrl].source;\r\n                    var layers = auxInfo[serviceUrl].layers;\r\n\r\n                    // GLS: validamos si hay capas a las cuales consultar, si no hay continuamos con el siguiente servicio\r\n                    if (!layers || (layers && layers.length === 0)) {\r\n                        continue;\r\n                    }\r\n\r\n                    var params = source.getParams();\r\n                    if (params.filter) params.filter = targetService.layers.map(function (i) { return \"(\" + (!_isGMLFilter(i.filter) ? \"\" : (i.filter instanceof TC.filter.Filter ? i.filter.getText() : i.filter)) + \")\"; }).join(\"\");\n                    if (params.cql_filter) params.cql_filter = targetService.layers.map(function (i) { return !i.filter || _isGMLFilter(i.filter) ? \"INCLUDE\" : i.filter; }).join(\";\");\r\n                    source.params_.LAYERS = layers.join(',');\r\n                    var gfiURL = source.getGetFeatureInfoUrl(coords, resolution, map.crs, {\r\n                        'QUERY_LAYERS': layers.join(','),\r\n                        'INFO_FORMAT': params.INFO_FORMAT,\r\n                        'FEATURE_COUNT': 1000,\r\n                        'radius': map.options.pixelTolerance,\r\n                        'buffer': map.options.pixelTolerance\r\n                    });\r\n\r\n                    gfiURL = gfiURL.replace(/sld_body=[a-zA-Z%0-9._]*/); // Quitamos el parámetro sld_body\r\n\r\n\r\n                    var expUrl = gfiURL;\r\n                    const requestData = {\r\n                        serviceUrl: serviceUrl,\r\n                        requestedFormat: params.INFO_FORMAT,\r\n                        expandUrl: expUrl\r\n                    };\r\n                    requestDataArray.push(requestData);\r\n                    requestPromises.push(new Promise(function (resolve, reject) {\r\n                        const mapLayer = targetService.mapLayers[0];\r\n                        mapLayer.toolProxification.fetch(gfiURL)\r\n                            .then(function (data) {\r\n                                mapLayer.toolProxification.cacheHost.getAction(requestData.expandUrl).then(function (cache) {\r\n                                    requestData.originalUrl = cache.action.call(mapLayer.toolProxification, requestData.expandUrl);\r\n                                    resolve(TC.Util.extend({}, data, requestData));\r\n                                });\r\n                            })\r\n                            .catch(function (error) {\r\n                                reject(Error(error));\r\n                            });\r\n                    }));\r\n                    TC.Util.consoleRegister(\"Lanzamos GFI\");\r\n                }\r\n\r\n                if (requestPromises.length > 0) {\r\n                    Promise.all(requestPromises).then(function (responses) {\r\n                        var someSuccess = false;\r\n                        var featureCount = 0;\r\n                        var featureInsertionPoints = [];\r\n                        for (var i = 0; i < responses.length; i++) {\r\n                            var featureInfo = responses[i];\r\n                            var service = targetServices[requestDataArray[i].serviceUrl];\r\n                            someSuccess = true;\r\n                            service.text = featureInfo.responseText;\r\n                            var format;\r\n                            var iFormat = featureInfo.contentType;\r\n                            if (iFormat && iFormat.indexOf(\";\") > -1)\r\n                                iFormat = iFormat.substr(0, iFormat.indexOf(\";\")).trim();\r\n\r\n                            if (!iFormat) iFormat = featureInfo.requestedFormat;\r\n\r\n                            if (iFormat === featureInfo.requestedFormat) {\r\n                                switch (iFormat) {\r\n                                    case 'application/json':\r\n                                        format = new ol.format.GeoJSON();\r\n                                        break;\r\n                                    case 'application/vnd.ogc.gml':\r\n                                        if (featureInfo.responseText.indexOf(\"FeatureCollection\") > -1) {\r\n                                            format = new ol.format.WFS({\r\n                                                gmlFormat: new ol.format.GML2({\r\n                                                    srsName: map.crs\r\n                                                })\r\n                                            });\r\n                                        }\r\n                                        else {\r\n                                            format = new ol.format.WMSGetFeatureInfo();\r\n                                        }\r\n                                        break;\r\n                                    case 'application/vnd.ogc.gml/3.1.1':\r\n                                        format = new ol.format.GML3({\r\n                                            srsName: map.crs\r\n                                        });\r\n                                        break;\r\n                                    case 'application/vnd.esri.wms_featureinfo_xml':\r\n                                        format = esriXmlParser;\r\n                                        break;\r\n                                    default:\r\n                                        format = null;\r\n                                        break;\r\n                                }\r\n\r\n                                if (format) {\r\n                                    var features;\r\n                                    try {\r\n                                        features = format.readFeatures(featureInfo.responseText, {\r\n                                            featureProjection: ol.proj.get(map.crs)\r\n                                        });\r\n                                    }\r\n                                    catch (e) {\r\n                                        TC.error(self.parent.getLocaleString('featureInfo.error.badResponse', { url: featureInfo.serviceUrl }) + ': ' + e.message);\r\n                                        features = [];\r\n                                        continue;\r\n                                    };\r\n                                    featureCount = featureCount + features.length;\r\n                                    var isParentOrSame = function (layer, na, nb) {\r\n                                        var result = false;\r\n                                        if (na === nb) {\r\n                                            result = true;\r\n                                        }\r\n                                        else {\r\n                                            var pa = layer.getNodePath(na);\r\n                                            var pb = layer.getNodePath(nb);\r\n                                            if (pa.length > 0 && pb.length >= pa.length) {\r\n                                                result = true;\r\n                                                for (var i = 0; i < pa.length; i++) {\r\n                                                    if (layer.wrap.getName(pa[i]) !== layer.wrap.getName(pb[i])) {\r\n                                                        result = false;\r\n                                                        break;\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                        return result;\r\n                                    };\r\n\r\n                                    var fakeLayers = {\r\n                                    };\r\n\r\n                                    for (var j = 0; j < features.length; j++) {\r\n                                        var feature = features[j];\r\n                                        if (feature instanceof ol.Feature) {\r\n                                            var fid = feature.getId() || TC.getUID();\r\n                                            var found = false;\r\n                                            var layerName = fid.substr(0, fid.lastIndexOf('.'));\r\n                                            for (var k = 0; k < service.layers.length; k++) {\r\n                                                var l = service.layers[k];\r\n                                                var lName = l.name.substr(l.name.indexOf(':') + 1);\r\n                                                if (service.mapLayers.some(function (mapLayer) { return isParentOrSame(mapLayer, lName, layerName) })) {\r\n                                                    found = true;\r\n                                                    if (!opts.featureId || feature.getId() === opts.featureId) { // Mirar si en las opciones pone que solo busque una feature\r\n                                                        featurePromises.push(TC.wrap.Feature.createFeature(feature, { showsPopup: false }));\r\n                                                        featureInsertionPoints.push(l.features);\r\n                                                    }\r\n                                                    break;\r\n                                                }\r\n                                            }\r\n\r\n                                            //si llegamos aquí y no he encontrado su layer, es que no cuadraba el prefijo del fid con el id del layer\r\n                                            //esto pasa, p.ej, en cartociudad\r\n                                            if (!found) {\r\n                                                //así que creo un layer de palo para la respuesta del featInfo\r\n                                                var fakeLayer;\r\n                                                if (fakeLayers[layerName]) fakeLayer = fakeLayers[layerName];\r\n                                                else {\r\n                                                    fakeLayer = {\r\n                                                        name: layerName, title: layerName, path: [layerName], features: []\r\n                                                    };\r\n                                                    fakeLayers[layerName] = fakeLayer;\r\n                                                    service.layers.push(fakeLayer);\r\n                                                }\r\n\r\n                                                if (!opts.featureId || feature.getId() === opts.featureId) { // Mirar si en las opciones pone que solo busque una feature\r\n                                                    featurePromises.push(TC.wrap.Feature.createFeature(feature, { showsPopup: false }));\r\n                                                    featureInsertionPoints.push(fakeLayer.features);\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }//iteración sobre las features de esta respuesta\r\n\r\n\r\n                                }\r\n                                else {\r\n                                    //si no hay formato reconocido y parseable, metemos un iframe con la respuesta\r\n                                    //y prau\r\n                                    //para eso, creo una falsa entrada de tipo feature, con un campo especial rawUrl o rawContent\r\n\r\n                                    const compoundLayer = {\r\n                                        name: 'layer' + TC.getUID(), title: 'Datos en el punto', features: [{\r\n                                            rawUrl: featureInfo.originalUrl, expandUrl: featureInfo.expandUrl, rawContent: featureInfo.responseText, rawFormat: iFormat\r\n                                        }]\r\n                                    };\r\n\r\n                                    service.layers.push(compoundLayer);\r\n                                    featureCount = featureCount + 1;\r\n                                }\r\n                            }\r\n                            else { // iFormat !== featureInfo.requestedFormat\r\n\r\n                                // GLS:\r\n                                TC.Util.consoleRegister(\"Respuesta GFI: lo más probable es que el servidor esté devolviendo una excepción\");\r\n                                TC.Util.consoleRegister(\"Lanzamos los eventos que corresponde y mostramos tostada\");\r\n\r\n                                // En este caso lo más probable es que el servidor esté devolviendo una excepción\r\n                                self.parent.responseError({\r\n                                    message: featureInfo.responseText,\r\n                                    status: featureInfo.status\r\n                                });\r\n                                // GLS: misma gestión de error que en ol.js - > function (a, b, c) { // error...\r\n                                map.toast(self.parent.getLocaleString('featureInfo.error'), {\r\n                                    type: TC.Consts.msgType.ERROR\r\n                                });\r\n                            }\r\n\r\n                        }\r\n                        if (someSuccess) {\r\n                            var finfoPromises = featurePromises;\r\n                            if (featurePromises.length) {\r\n                                finfoPromises = finfoPromises.concat(new Promise(function (resolve, reject) {\r\n                                    // Si hay features cargamos el módulo de geometria para encontrar una que se interseque con el punto\r\n                                    TC.loadJS(\r\n                                        !TC.Geometry,\r\n                                        TC.apiLocation + 'TC/Geometry',\r\n                                        function () {\r\n                                            resolve();\r\n                                        }\r\n                                    );\r\n                                }));\r\n                            }\r\n                            Promise.all(finfoPromises).then(function afterFeatureInfoPromises(features) {\r\n                                var defaultFeature;\r\n                                features.forEach(function (feat, idx) {\r\n                                    if (feat) {\r\n                                        feat.attributes = [];\r\n                                        for (var key in feat.data) {\r\n                                            var value = feat.data[key];\r\n                                            if (typeof value !== 'object') {\r\n                                                feat.attributes.push({\r\n                                                    name: key,\r\n                                                    value: typeof (value) == \"number\" ? value.toLocaleString(TC.Util.getMapLocale(self.parent.map)) : value\r\n                                                });\r\n                                            }\r\n                                            else {\r\n                                                feat.attributes.push({\r\n                                                    name: key,\r\n                                                    value: value//\"objeto complejo\"\r\n                                                });\r\n                                            }\r\n                                        }\r\n                                        if (!defaultFeature && TC.Geometry.isInside(coords, feat.geometry)) {\r\n                                            defaultFeature = feat;\r\n                                        }\r\n                                        const featureInsertionPoint = featureInsertionPoints[idx];\r\n                                        // Añadimos la feature si no ha sido ya añadida (por ejemplo porque hay dos capas en el \r\n                                        // mapa que tienen features coincidentes)\r\n                                        if (!featureInsertionPoint.some(f => f.id === feat.id)) {\r\n                                            featureInsertionPoint.push(feat);\r\n                                        }\r\n                                    }\r\n                                });\r\n\r\n                                var services = [];\r\n                                for (var serviceUrl in targetServices) {\r\n                                    if (targetServices.hasOwnProperty(serviceUrl)) {\r\n                                        services.push(targetServices[serviceUrl]);\r\n                                    }\r\n                                }\r\n\r\n                                self.parent.responseCallback({\r\n                                    coords: coords,\r\n                                    resolution: resolution,\r\n                                    services: services,\r\n                                    featureCount: featureCount,\r\n                                    defaultFeature: defaultFeature\r\n                                });\r\n                                resolve();\r\n                            });\r\n                        }\r\n                        else {\r\n                            resolve();\r\n                        }\r\n                    },\r\n                        function (a, b, c) { // error\r\n                            if (services && services.length == 0) {\r\n                                for (var serviceUrl in targetServices) {\r\n                                    services.push(targetServices[serviceUrl]);\r\n                                }\r\n                            }\r\n\r\n                            self.parent.responseCallback({\r\n                                coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                            });\r\n                            map.toast(self.parent.getLocaleString('featureInfo.error'), {\r\n                                type: TC.Consts.msgType.ERROR\r\n                            });\r\n                            resolve();\r\n                        });\r\n                }\r\n                else {\r\n\r\n                    if (map.workLayers.filter(function (layer) {\r\n                        return layer instanceof TC.layer.Raster;\r\n                    }).length > 0) {\r\n                        map.toast(self.parent.getLocaleString('featureInfo.notQueryableLayers'), {\r\n                            type: TC.Consts.msgType.INFO\r\n                        });\r\n                    }\r\n\r\n                    if (services && services.length == 0) {\r\n                        for (var serviceUrl in targetServices) {\r\n                            services.push(targetServices[serviceUrl]);\r\n                        }\r\n                    }\r\n\r\n                    // GLS: nos suscribimos TC.Consts.event.BEFOREFEATUREINFO y lanzamos el mismo evento de zero resultados ya que puede darse que la resolución se lance antes del before.\r\n                    map.on(TC.Consts.event.BEFOREFEATUREINFO, function () {\r\n                        self.parent.responseCallback({\r\n                            coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                        });\r\n                    });\r\n\r\n                    self.parent.responseCallback({\r\n                        coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                    });\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            TC.wrap.control.Click.prototype.register.call(self, map);\r\n            var _clickTrigger = self._trigger;\r\n            self._trigger = function (e) {\r\n                self.hasSuitableLayers().then(function (hasLayers) {\r\n                    if (hasLayers) {\r\n                        if (!self.parent._isSearching) {\r\n                            if (e.type == SINGLECLICK && !self.parent._isDrawing && !self.parent._isSearching) {\r\n                                _clickTrigger.call(self, e);\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.hasSuitableLayers = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const map = self.parent.map;\r\n            var ret = false;\r\n            map.wrap.getMap().then(function (olMap) {\r\n                olMap.getLayers().forEach(function (olLayer) {\r\n                    var layer = olLayer._wrap.parent;\r\n                    var source = olLayer.getSource();\r\n                    //Por qué en workLayers están el vectorial de medición, y cosas así?\r\n                    if (source.getGetFeatureInfoUrl && map.workLayers.indexOf(layer) >= 0) {\r\n                        ret = true;\r\n                        return false;   //break del foreach\r\n                    }\r\n                });\r\n                resolve(ret);\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var xy = options.xy;\r\n        var layer = options.layer;\r\n        var callback = options.callback;\r\n        var geometryType = options.geometryType;\r\n        var semaforo = false;\r\n        if (!self.drawCtrl) {\r\n            layer.wrap.getLayer().then(function (olLayer) {\r\n                var olGeometryType;\r\n                switch (geometryType) {\r\n                    case TC.Consts.geom.POLYLINE:\r\n                        olGeometryType = ol.geom.GeometryType.LINE_STRING;\r\n                        break;\r\n                    default:\r\n                        olGeometryType = ol.geom.GeometryType.POLYGON;\r\n                        break;\r\n                }\r\n                const layerStyle = olLayer.getStyle();\r\n                // Si la geometría es del tipo correcto, cogemos el estilo de la capa\r\n                const styleFunction = function (olFeature) {\r\n                    if (olFeature && olFeature.getGeometry().getType() === olGeometryType) {\r\n                        if (TC.Util.isFunction(layerStyle)) {\r\n                            return layerStyle(olFeature);\r\n                        }\r\n                        return layerStyle;\r\n                    }\r\n                    return null;\r\n                };\r\n                self.drawCtrl = new ol.interaction.Draw({\r\n                    source: olLayer.getSource(),\r\n                    type: olGeometryType,\r\n                    style: styleFunction\r\n                });\r\n                var setShowsPopup = function (wrap) {\r\n                    wrap.parent.showsPopup = false;\r\n                };\r\n                olLayer.getSource().on(ADDFEATURE, function (event) {\r\n                    const olFeat = event.feature;\r\n                    if (olFeat._wrap) {\r\n                        setShowsPopup(olFeat._wrap);\r\n                    }\r\n                    else {\r\n                        TC.wrap.Feature.createFeature(olFeat).then(f => setShowsPopup(f.wrap));\r\n                    }\r\n                });\r\n                self.drawCtrl.handleEvent = function (event) {\r\n                    //esta ñapa para solucionar cuando haces un primer punto y acontinuación otro muy rápido\r\n                    if (event.type == SINGLECLICK) {\r\n                        var points = olGeometryType === ol.geom.GeometryType.POLYGON ? this.sketchCoords_[0] : this.sketchCoords_;\r\n                        if (semaforo && points.length == 2 && this.sketchFeature_ !== null) {// GLS: Añado la misma validación (this.sketchFeature_ !== null) que tiene el código de OL antes de invocar addToDrawing_ \r\n                            this.addToDrawing_(event);\r\n                        }\r\n                        else {\r\n                            semaforo = true;\r\n                        }\r\n                    }\r\n                    return ol.interaction.Draw.prototype.handleEvent.call(this, event);\r\n                }\r\n                const map = self.parent.map;\r\n                const olMap = map.wrap.map;\r\n                olMap.addInteraction(self.drawCtrl);\r\n                self.drawCtrl.on('drawstart', function (event) {\r\n                    self.parent._isDrawing = true;\r\n                    olMap.getInteractions().forEach(function (item, i) {\r\n                        if (item instanceof (ol.interaction.DoubleClickZoom))\r\n                            item.setActive(false);\r\n                    });\r\n                });\r\n                self.drawCtrl.startDrawing_({\r\n                    coordinate: xy\r\n                });\r\n                self.drawCtrl.on('drawend', function (event) {\r\n                    self.parent._isDrawing = false;\r\n                    olMap.getInteractions().forEach(function (item, i) {\r\n                        if (item instanceof (ol.interaction.DoubleClickZoom))\r\n                            item.setActive(false);\r\n                    });\r\n                    olMap.removeInteraction(self.drawCtrl);\r\n                    this.setActive(false);\r\n                    self.drawCtrl = null;\r\n                    olLayer.getSource().clear();\r\n                    self.parent._drawToken = true;\r\n                    setTimeout(function () {\r\n                        self.parent._drawToken = false;\r\n                    }, 500);\r\n                    event.feature.setId(self.parent.getUID());\r\n\r\n                    TC.wrap.Feature.createFeature(event.feature, { showsPopup: false }).then(function (feat) {\r\n                        self.parent.filterFeature = feat;\r\n                        feat.layer = self.parent.filterLayer;\r\n                        if (callback) {\r\n                            callback(feat);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n\r\n        }\r\n        else {\r\n            self.drawCtrl.setActive(true);\r\n            self.drawCtrl.startDrawing_({\r\n                coordinate: xy\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw = function (xy, layer, callback) {\r\n        var self = this;\r\n        if (self.drawCtrl && self.parent._isDrawing) {\r\n            self.parent._isDrawing = false;\r\n            self.drawCtrl.setActive(false);\r\n            self.drawCtrl.source_.clear();\r\n\r\n        }\r\n    };\r\n\r\n    var readFeaturesFromResponse = function (map, data, contentType) {\r\n        var format;\r\n        var iFormat = contentType;\r\n        if (iFormat && iFormat.indexOf(\";\") > -1)\r\n            iFormat = iFormat.substr(0, iFormat.indexOf(\";\")).trim();\r\n\r\n        if (!iFormat) iFormat = data.requestedFormat;\r\n        switch (iFormat) {\r\n            case 'application/json':\r\n                format = new ol.format.GeoJSON();\r\n                break;\r\n            case 'application/vnd.ogc.gml':\r\n                if (data.responseText.indexOf(\"FeatureCollection\") > -1)\r\n                    format = new ol.format.WFS({\r\n                        gmlFormat: new ol.format.GML2({\r\n                            srsName: map.crs\r\n                        })\r\n                    });\r\n                else\r\n                    format = new ol.format.WMSGetFeatureInfo();\r\n                break;\r\n            case 'application/vnd.ogc.gml/3.1.1':\r\n                format = new ol.format.GML3({\r\n                    srsName: map.crs\r\n                });\r\n                break;\r\n            case \"text/xml\":\r\n            case \"application/xml\":\r\n                //posible error\r\n                const exception = data.querySelector(\"ServiceException\");\r\n                if (exception)\r\n                    TC.error(exception);\r\n                format = null;\r\n                break;\r\n            default:\r\n                format = null;\r\n                break;\r\n        }\r\n        if (format) {\r\n            return format.readFeatures(data, {\r\n                featureProjection: ol.proj.get(map.crs)\r\n            });\r\n        }\r\n        else {\r\n            return null;\r\n            ////si no hay formato reconocido y parseable, metemos un iframe con la respuesta\r\n            ////y prau\r\n            ////para eso, creo una falsa entrada de tipo feature, con un campo especial rawUrl o rawContent\r\n            //var l = service.layers[0];\r\n            //l.features.push({\r\n            //    error: response.responseText\r\n            //});\r\n        }\r\n    };\r\n    var featureToServiceDistributor = function (features, service) {\r\n        var featurePromises = [];\r\n        var featureInsertionPoints = [];\r\n        var isParentOrSame = function (layer, na, nb) {\r\n            var result = false;\r\n            if (na === nb || (na.indexOf(nb) === 0)) {\r\n                result = true;\r\n            }\r\n            else {\r\n                var pa = layer.getPath(na);\r\n                var pb = layer.getPath(nb);\r\n                if (pa.length > 0 && pb.length >= pa.length) {\r\n                    result = true;\r\n                    for (var i = 0; i < pa.length; i++) {\r\n                        if (pa[i] !== pb[i]) {\r\n                            result = false;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        };\r\n\r\n        var fakeLayers = {};\r\n        for (var j = 0; j < features.length; j++) {\r\n            var feature = features[j];\r\n            if (feature instanceof ol.Feature) {\r\n                var fid = feature.getId() || TC.getUID();\r\n                var found = false;\r\n                var layerName = fid.substr(0, fid.lastIndexOf('.'));\r\n                for (var k = 0; k < service.layers.length; k++) {\r\n                    var l = service.layers[k];\r\n                    var lName = l.name.substr(l.name.indexOf(':') + 1);\r\n                    if (service.mapLayers.some(function (mapLayer) { return isParentOrSame(mapLayer, lName, layerName) })) {\r\n                        found = true;\r\n                        featurePromises.push(TC.wrap.Feature.createFeature(feature));\r\n\r\n                        featureInsertionPoints[feature.id_] = (l.features);\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                //si llegamos aqu\\u00ed y no he encontrado su layer, es que no cuadraba el prefijo del fid con el id del layer\r\n                //esto pasa, p.ej, en cartociudad\r\n                if (!found) {\r\n                    //as\\u00ed que creo un layer de palo para la respuesta del featInfo\r\n                    var fakeLayer;\r\n                    if (fakeLayers[layerName]) fakeLayer = fakeLayers[layerName];\r\n                    else {\r\n                        fakeLayer = {\r\n                            name: layerName, title: layerName, features: []\r\n                        };\r\n                        fakeLayers[layerName] = fakeLayer;\r\n                        service.layers.push(fakeLayer);\r\n                    }\r\n\r\n                    featurePromises.push(TC.wrap.Feature.createFeature(feature));\r\n                    featureInsertionPoints.push(feature.id_);\r\n                }\r\n            }\r\n        }//iteraci\\u00f3n sobre las features de esta respuesta\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            Promise.all(featurePromises).then(function (features) {\r\n                features.forEach(function (feat) {\r\n                    feat.attributes = [];\r\n                    //feat.showsPopup = false;\r\n                    for (var key in feat.data) {\r\n                        var value = feat.data[key];\r\n                        if (typeof value !== 'object') {\r\n                            feat.attributes.push({\r\n                                name: key, value: value\r\n                            });\r\n                        }\r\n                        else {\r\n                            feat.attributes.push({\r\n                                name: key,\r\n                                value: value//\"objeto complejo\"\r\n                            });\r\n                        }\r\n                    }\r\n                    featureInsertionPoints[feat.id].push(feat);\r\n                });\r\n                resolve({\r\n                    service: service\r\n                })\r\n            });\r\n        });\r\n    }\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry = function (feature, xy) {\r\n\r\n        var self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var map = self.parent.map;\r\n\r\n            map.wrap.getMap().then(function (olMap) {\r\n\r\n                var olGeometry = feature.wrap.feature.getGeometry();\r\n                var stride = olGeometry.stride;\r\n                var flatCoordinates = olGeometry.getFlatCoordinates();\r\n                //calcular el punto mas alto\r\n                if (!xy) {\r\n                    var bestPoint = null;\r\n                    for (var i = 1, len = flatCoordinates.length; i < len; i += stride) {\r\n                        if (!bestPoint || bestPoint[1] < flatCoordinates[i]) {\r\n                            bestPoint = [flatCoordinates[i - 1], flatCoordinates[i]];\r\n                        }\r\n                    }\r\n                    xy = olMap.getPixelFromCoordinate(new ol.geom.Point(bestPoint).getCoordinates());\r\n                }\r\n\r\n                self.parent.beforeRequest({ xy: xy });\r\n\r\n                var arrRequests = map.extractFeatures({ filter: new TC.filter.intersects(feature, map.crs), outputFormat: TC.Consts.format.JSON });\r\n\r\n                const arrPromises = [];\r\n                Promise.all(arrRequests).then(function (responses) {\r\n                    var targetServices = [];\r\n                    var featureCount = 0;\r\n\r\n                    for (var i = 0; i < responses.length; i++) {\r\n                        const responseObj = responses[i];\r\n                        if (!responseObj) continue;\r\n                        arrPromises.push(new Promise(function (res, rej) {\r\n                            if (responseObj.errors && responseObj.errors.length) {\r\n                                for (var j = 0; j < responseObj.errors.length; j++) {\r\n                                    var errorMsg, errorType = TC.Consts.msgType.WARNING;\r\n                                    var error = responseObj.errors[j];\r\n                                    switch (error.key) {\r\n                                        case TC.Consts.WFSErrors.MAX_NUM_FEATURES:\r\n                                            errorMsg = self.parent.getLocaleString(\"wfs.tooManyFeatures\", error.params);\r\n                                            break;\r\n                                            /*case TC.Consts.WFSErrors.NO_LAYERS:\r\n                                                errorMsg = self.parent.getLocaleString('noLayersLoaded');*/\r\n                                            break;\r\n                                        case TC.Consts.WFSErrors.GETCAPABILITIES:\r\n                                            errorMsg = self.parent.getLocaleString('wfsGFI.inValidService', error.params);\r\n                                            break;\r\n                                        case TC.Consts.WFSErrors.NO_FEATURES:\r\n                                            //si no hay features nos callamos. Quizas en un futuro se muestre una alerta\r\n                                            continue;\r\n                                            break;\r\n                                        case TC.Consts.WFSErrors.INDETERMINATE:\r\n                                            errorMsg = self.parent.getLocaleString(\"wfs.IndeterminateError\");\r\n                                            TC.error(\"Error:{error} \\r\\n Descripcion:{descripcion} \\r\\n Servicio:{serviceName}\".format({ error: error.params.err, descripcion: error.params.errorThrown, serviceName: error.params.serviceTitle }), TC.Consts.msgErrorMode.CONSOLE);\r\n                                            errorType = TC.Consts.msgType.ERROR;\r\n                                            break;\r\n                                        default:\r\n                                            errorMsg = self.parent.getLocaleString(\"wfsGFI.\" + error.key, error.params);\r\n                                            break;\r\n                                    }\r\n\r\n                                    map.toast(errorMsg, { type: errorType });\r\n                                }\r\n                                if (!responseObj.response) {\r\n                                    res();\r\n                                }\r\n                            }\r\n                        }));\r\n\r\n                        // Puede no haber response porque la URL no es correcta, metemos un condicional\r\n                        var featuresFound = responseObj.response ? readFeaturesFromResponse(map, responseObj.response.responseText, responseObj.response.contentType) : [];\r\n                        //ahora se distribuye la features por servicio y capa\r\n                        arrPromises[arrPromises.length - 1] = featureToServiceDistributor(featuresFound, responseObj.service);\r\n                        if (responseObj.service) {\r\n                            targetServices.push(responseObj.service);\r\n                        }\r\n                        featureCount = featureCount + featuresFound.length;\r\n                    }\r\n                    Promise.all(arrPromises).then(function () {\r\n                        self.parent.responseCallback({\r\n                            xy: xy || null, services: targetServices, featureCount: featureCount\r\n                        });\r\n                        resolve();\r\n                    });\r\n                }, function (e) {\r\n                    self.parent.responseCallback({});\r\n                    resolve();\r\n                })\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Popup.prototype = function () {\r\n        this.popup = null;\r\n    };\r\n\r\n    TC.Consts.event.PANANIMATIONSTART = 'pananimationstart.tc';\r\n    TC.Consts.event.PANANIMATIONEND = 'pananimationend.tc';\r\n    TC.wrap.control.Popup.prototype.fitToView = function () {\r\n        var self = this;\r\n        var map = self.parent.map;\r\n        var olMap = self.parent.map.wrap.map;\r\n\r\n        var popupBoundingRect = self.parent.popupDiv.getBoundingClientRect();\r\n        var mapBoundingRect = map.div.getBoundingClientRect();\r\n\r\n        var topLeft = olMap.getCoordinateFromPixel([popupBoundingRect.left - mapBoundingRect.left, popupBoundingRect.top - mapBoundingRect.top]);\r\n        var bottomRight = olMap.getCoordinateFromPixel([popupBoundingRect.right - mapBoundingRect.left, popupBoundingRect.bottom - mapBoundingRect.top]);\r\n        var west = topLeft[0];\r\n        var north = topLeft[1];\r\n        var east = bottomRight[0];\r\n        var south = bottomRight[1];\r\n\r\n        var popupExt = [west, south, east, north];\r\n        var mapExt = map.getExtent();\r\n\r\n        if (!ol.extent.containsExtent(mapExt, popupExt)) {\r\n            var overflows = {\r\n                left: Math.max(mapExt[0] - popupExt[0], 0),\r\n                bottom: Math.max(mapExt[1] - popupExt[1], 0),\r\n                right: Math.max(popupExt[2] - mapExt[2], 0),\r\n                top: Math.max(popupExt[3] - mapExt[3], 0)\r\n            };\r\n\r\n            if (self.parent.dragged) {\r\n                // Movemos el popup\r\n                var newPos = self.popup.getPosition();\r\n                if (overflows.right) {\r\n                    newPos[0] = newPos[0] - overflows.right;\r\n                }\r\n                else if (overflows.left) {\r\n                    newPos[0] = newPos[0] + overflows.left;\r\n                }\r\n                if (overflows.top) {\r\n                    newPos[1] = newPos[1] - overflows.top;\r\n                }\r\n                else if (overflows.bottom) {\r\n                    newPos[1] = newPos[1] + overflows.bottom;\r\n                }\r\n                var newPixelPos = olMap.getPixelFromCoordinate(newPos);\r\n                newPixelPos[1] = olMap.getSize()[1] - newPixelPos[1];\r\n                self.parent._previousContainerPosition = newPixelPos;\r\n                (self.popup._oldUpdatePixelPosition || self.popup.updatePixelPosition).call(self.popup, newPos);\r\n            }\r\n            else {\r\n                if (self.parent.isVisible()) {\r\n                    // Movemos el mapa\r\n                    var view = olMap.getView();\r\n                    var ct = view.getCenter().slice();\r\n\r\n                    if (overflows.top) ct[1] += overflows.top;\r\n                    else if (overflows.bottom) ct[1] -= overflows.bottom;\r\n                    if (overflows.right) ct[0] += overflows.right;\r\n                    else if (overflows.left) ct[0] -= overflows.left;\r\n\r\n                    view.animate({\r\n                        center: ct, easing: function (percent) {\r\n                            if (percent === 0) self.parent.map.trigger(TC.Consts.event.PANANIMATIONSTART);\r\n                            if (percent === 1) self.parent.map.trigger(TC.Consts.event.PANANIMATIONEND);\r\n                            return percent;\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Popup.prototype.setDragged = function (dragged) {\r\n        var popup = this.popup;\r\n        //var view = popup.getMap().getView();\r\n        //var onViewChange = function () {\r\n        //    console.log(this.getCenter());\r\n        //};\r\n        if (dragged) {\r\n            // Parcheamos funciones para que el popup no se mueva cuando cambiamos el extent del mapa\r\n            if (!popup._oldUpdatePixelPosition) {\r\n                popup._oldUpdatePixelPosition = popup.updatePixelPosition;\r\n                popup.updatePixelPosition = function () {\r\n                };\r\n            }\r\n            if (!popup._newHandleOffsetChanged) {\r\n                popup._newHandleOffsetChanged = function () {\r\n                    this._oldUpdatePixelPosition();\r\n                };\r\n                ol.events.unlisten(\r\n                    popup, ol.Object.getChangeEventType('offset'),\r\n                    popup.handleOffsetChanged, popup);\r\n                ol.events.listen(\r\n                    popup, ol.Object.getChangeEventType('offset'),\r\n                    popup._newHandleOffsetChanged, popup);\r\n            }\r\n            //view.on(['change:center','change:resolution'], onViewChange);\r\n        }\r\n        else {\r\n            // Redefinimos las propiedades de posicionamiento porque al arrastrarlo, las hemos modificado.\r\n            const containerStyle = popup.getElement().parentElement.style;\r\n            containerStyle.setProperty('top', popup.rendered.top_);\r\n            containerStyle.setProperty('bottom', popup.rendered.bottom_);\r\n            containerStyle.setProperty('left', popup.rendered.left_);\r\n            containerStyle.setProperty('right', popup.rendered.right_);\r\n\r\n            delete this.parent._previousContainerPosition;\r\n            // Deshacemos parcheo\r\n            if (popup._oldUpdatePixelPosition) {\r\n                popup.updatePixelPosition = popup._oldUpdatePixelPosition;\r\n                delete popup._oldUpdatePixelPosition;\r\n            }\r\n            if (popup._newHandleOffsetChanged) {\r\n                ol.events.unlisten(\r\n                    popup, ol.Object.getChangeEventType('offset'),\r\n                    popup._newHandleOffsetChanged, popup);\r\n                ol.events.listen(\r\n                    popup, ol.Object.getChangeEventType('offset'),\r\n                    popup.handleOffsetChanged, popup);\r\n                delete popup._newHandleOffsetChanged;\r\n            }\r\n            //view.un(['change:center', 'change:resolution'], onViewChange);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getLegend = function () {\r\n        var self = this;\r\n        var result = {\r\n        };\r\n        var style = getNativeFeatureStyle(self.feature, true);\r\n        if (style) {\r\n            var image = style.getImage();\r\n            if (image) {\r\n                if (image instanceof ol.style.Icon) {\r\n                    result.src = image.getSrc();\r\n                    var scale = image.getScale();\r\n                    var img = image.getImage();\r\n                    if (scale) {\r\n                        if (img.width) {\r\n                            result.width = img.width * scale;\r\n                            result.height = img.height * scale;\r\n                        }\r\n                        else {\r\n                            result.scale = scale;\r\n                        }\r\n                    }\r\n                    else {\r\n                        if (img.width) {\r\n                            result.width = img.width;\r\n                            result.height = img.height;\r\n                        }\r\n                    }\r\n                }\r\n                else if (image instanceof ol.style.Circle) {\r\n                    result.src = image.canvas_.toDataURL();\r\n                }\r\n                if (self.parent.options.radius) {\r\n                    result.height = result.width = self.parent.options.radius * 2;\r\n                }\r\n                else {\r\n                    result.width = result.width || self.parent.options.width;\r\n                    result.height = result.height || self.parent.options.height;\r\n                }\r\n            }\r\n            else {\r\n                let geometryType;\r\n                switch (self.feature.getGeometry().getType()) {\r\n                    case ol.geom.GeometryType.MULTI_POLYGON:\r\n                    case ol.geom.GeometryType.POLYGON:\r\n                        geometryType = TC.Consts.geom.POLYGON;\r\n                        break;\r\n                    case ol.geom.GeometryType.MULTI_LINE_STRING:\r\n                    case ol.geom.GeometryType.LINE_STRING:\r\n                        geometryType = TC.Consts.geom.POLYLINE;\r\n                        break;\r\n                    default:\r\n                        geometryType = TC.Consts.geom.POINT;\r\n                        break;\r\n                }\r\n\r\n                result.src = TC.Util.getLegendImageFromStyle(getStyleFromNative(style), { geometryType: geometryType });\r\n                // No image, find stroke and fill\r\n                //var stroke = style.getStroke();\r\n                //var fill = style.getFill();\r\n                //if (stroke) {\r\n                //    var strokeColor = stroke.getColor();\r\n                //    if (strokeColor) {\r\n                //        result.strokeColor = ol.color.asString(strokeColor);\r\n                //    }\r\n                //    var strokeWidth = stroke.getWidth();\r\n                //    if (strokeWidth) {\r\n                //        result.strokeWidth = strokeWidth;\r\n                //    }\r\n                //}\r\n                //if (fill) {\r\n                //    var fillColor = fill.getColor();\r\n                //    if (fillColor) {\r\n                //        result.fillColor = ol.color.asString(fillColor);\r\n                //    }\r\n                //}\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    const createFeatureBasics = function (coords, options) {\r\n        const self = this;\r\n        self.feature = new ol.Feature();\r\n        if (self.parent.id) {\r\n            self.feature.setId(self.parent.id);\r\n        }\r\n        if (options.geometryName) {\r\n            self.feature.setGeometryName(options.geometryName);\r\n        }\r\n        self.feature._wrap = self;\r\n        self.parent.setCoords(coords);\r\n        self.parent.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPoint = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { point: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createMultiPoint = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { point: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createMarker = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        var iconUrl = TC.Util.getPointIconUrl(options);\r\n        if (iconUrl) {\r\n            options.url = iconUrl;\r\n            createFeatureBasics.call(self, coords, options);\r\n            if (TC.Util.hasStyleOptions(options)) {\r\n                self.feature.setStyle(createNativeStyle({ styles: { marker: options } }, self.feature));\r\n            }\r\n        }\r\n        else {\r\n            self.createPoint(coords, options);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPolyline = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { line: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPolygon = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { polygon: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n\r\n    TC.wrap.Feature.prototype.createMultiPolyline = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { line: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createMultiPolygon = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (TC.Util.hasStyleOptions(options)) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { polygon: options } }, self.feature));\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createCircle = function (coords, options) {\r\n        const self = this;\r\n        options = options || {};\r\n        createFeatureBasics.call(self, coords, options);\r\n        if (options) {\r\n            self.feature.setStyle(\r\n                new ol.style.Style({\r\n                    stroke: new ol.style.Stroke({\r\n                        color: options.strokeColor,\r\n                        width: options.strokeWidth,\r\n                        lineDash: options.lineDash\r\n                    }),\r\n                    fill: new ol.style.Fill({\r\n                        color: getRGBA(options.fillColor, options.fillOpacity)\r\n                    })\r\n                })\r\n            );\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.createFeature = function (olFeat, options) {\r\n        if (!olFeat._featurePromise) {\r\n            olFeat._featurePromise = new Promise(function (resolve, reject) {\r\n                var olGeometry = olFeat.getGeometry();\r\n                options = options || {};\r\n                options.id = olFeat.getId();\r\n                let olStyle = olFeat.getStyle();\r\n                if (olStyle) {\r\n                    TC.Util.extend(options, getStyleFromNative(olStyle, olFeat));\r\n                }\r\n                // geometría\r\n                let geomStr;\r\n                switch (true) {\r\n                    case olGeometry instanceof ol.geom.Point:\r\n                    case olGeometry instanceof ol.geom.MultiPoint:\r\n                        if (TC.Util.isFunction(olStyle)) {\r\n                            olStyle = olStyle(olFeat);\r\n                        }\r\n                        var olStyles = olStyle ? (Array.isArray(olStyle) ? olStyle : [olStyle]) : [];\r\n                        for (var i = 0, len = olStyles.length; i < len; i++) {\r\n                            olStyle = olStyles[i];\r\n                            if (olStyle.getImage() instanceof ol.style.Icon) {\r\n                                geomStr = 'Marker';\r\n                                break;\r\n                            }\r\n                        }\r\n                        geomStr = geomStr || 'Point';\r\n                        if (olGeometry instanceof ol.geom.MultiPoint) {\r\n                            if (geomStr === 'Point') {\r\n                                geomStr = 'MultiPoint';\r\n                            }\r\n                            if (geomStr === 'Marker') {\r\n                                geomStr = 'MultiMarker';\r\n                            }\r\n                        }\r\n                        break;\r\n                    case olGeometry instanceof ol.geom.LineString:\r\n                        geomStr = 'Polyline';\r\n                        break;\r\n                    case olGeometry instanceof ol.geom.Polygon:\r\n                        geomStr = 'Polygon';\r\n                        break;\r\n                    case olGeometry instanceof ol.geom.MultiLineString:\r\n                        geomStr = 'MultiPolyline';\r\n                        break;\r\n                    case olGeometry instanceof ol.geom.MultiPolygon:\r\n                        geomStr = 'MultiPolygon';\r\n                        break;\r\n                    default:\r\n                        break;\r\n                }\r\n                if (geomStr) {\r\n                    TC.loadJS(\r\n                        !TC.feature || !TC.feature[geomStr],\r\n                        [TC.apiLocation + 'TC/feature/' + geomStr],\r\n                        function () {\r\n                            const feat = new TC.feature[geomStr](olFeat, options);\r\n                            feat.data = feat.wrap.getData();\r\n                            resolve(feat);\r\n                        }\r\n                    );\r\n                }\r\n                else {\r\n                    TC.loadJS(\r\n                        !TC.Feature,\r\n                        [TC.apiLocation + 'TC/Feature'],\r\n                        function () {\r\n                            var feat = new TC.Feature(olFeat, options);\r\n                            feat.data = feat.wrap.getData();\r\n                            resolve(feat);\r\n                        }\r\n                    );\r\n                }\r\n            });\r\n        }\r\n        return olFeat._featurePromise;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.cloneFeature = function () {\r\n        return this.feature.clone();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getStyle = function () {\r\n        var self = this;\r\n        var result = {};\r\n        var olStyle = self.feature.getStyle();\r\n        if (TC.Util.isFunction(olStyle)) {\r\n            olStyle = olStyle(self.feature);\r\n        }\r\n        var olStyles = olStyle ? (Array.isArray(olStyle) ? olStyle : [olStyle]) : [];\r\n\r\n        const getFill = function (style, obj) {\r\n            if (style) {\r\n                const fill = style.getFill();\r\n                if (fill) {\r\n                    obj.fillColor = fill.getColor();\r\n                    if (Array.isArray(obj.fillColor)) {\r\n                        obj.fillOpacity = obj.fillColor[3];\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        const getStroke = function (style, obj) {\r\n            if (style) {\r\n                const stroke = style.getStroke();\r\n                if (stroke) {\r\n                    obj.strokeColor = stroke.getColor();\r\n                    obj.strokeWidth = stroke.getWidth();\r\n                }\r\n            }\r\n        };\r\n\r\n        for (var i = 0, len = olStyles.length; i < len; i++) {\r\n            olStyle = olStyles[i];\r\n            getFill(olStyle, result);\r\n            getStroke(olStyle, result);\r\n            const image = olStyle.getImage();\r\n            if (image instanceof ol.style.Icon) {\r\n                result.url = image.getSrc();\r\n                const size = image.getSize();\r\n                const scale = image.getScale() || 1;\r\n                if (size) {\r\n                    result.width = size[0] * scale;\r\n                    result.height = size[1] * scale;\r\n                }\r\n                var anchor = image.getAnchor();\r\n                if (anchor) {\r\n                    result.anchor = [anchor[0] * scale, anchor[1] * scale];\r\n                    if (size) {\r\n                        // getAnchor devuelve los valores en pixels, hay que transformar a fracción\r\n                        result.anchor[0] = result.anchor[0] / result.width;\r\n                        result.anchor[1] = result.anchor[1] / result.height;\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                getFill(image, result);\r\n                getStroke(image, result);\r\n            }\r\n            var text = olStyle.getText();\r\n            if (text) {\r\n                result.label = text.getText();\r\n                var font = text.getFont();\r\n                if (font) {\r\n                    // A 96dpi 3pt = 4px\r\n                    result.fontSize = parseInt(font.match(/\\d+pt/)) || parseInt(font.match(/\\d+px/)) * 0.75;\r\n                }\r\n                var rotation = text.getRotation();\r\n                if (rotation) {\r\n                    result.angle = -180 * rotation / Math.PI;\r\n                }\r\n                result.labelOffset = [text.getOffsetX(), text.getOffsetY()];\r\n                fill = text.getFill();\r\n                if (fill) {\r\n                    result.fontColor = fill.getColor();\r\n                }\r\n                stroke = text.getStroke();\r\n                if (stroke) {\r\n                    result.labelOutlineColor = stroke.getColor();\r\n                    result.labelOutlineWidth = stroke.getWidth();\r\n                }\r\n            }\r\n        }\r\n        TC.Util.extend(self.parent.options, result);\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getGeometry = function () {\r\n        var result;\r\n        var self = this;\r\n        if (self.feature && self.feature.getGeometry) {\r\n            var geom = self.feature.getGeometry();\r\n            if (geom) {\r\n                if (geom.getCoordinates) {\r\n                    result = geom.getCoordinates();\r\n                }\r\n                else if (geom instanceof ol.geom.Circle) {\r\n                    result = [geom.getCenter(), geom.getRadius()];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setGeometry = function (geometry) {\r\n        const self = this;\r\n        if (self.feature && self.feature.getGeometry) {\r\n            var geom = self.feature.getGeometry();\r\n            var ctor;\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons,\r\n                isMultiPolygon,\r\n                isPolygonOrMultiLineString,\r\n                isLineString;\r\n            // punto: array de números\r\n            // línea o anillo: array de puntos\r\n            // multilínea o polígono: array de líneas o anillos\r\n            // multipolígono: array de polígonos\r\n            // Por tanto podemos recorrer los tipos en un switch sin breaks\r\n            switch (true) {\r\n                case (TC.feature.MultiPolygon && self.parent instanceof TC.feature.MultiPolygon):\r\n                    isMultiPolygon = true;\r\n                    ctor = ol.geom.MultiPolygon;\r\n                    polygons = geometry;\r\n                    if (Array.isArray(polygons)) {\r\n                        ringsOrPolylines = geometry[0];\r\n                    }\r\n                case (TC.feature.Polygon && self.parent instanceof TC.feature.Polygon || TC.feature.MultiPolyline && self.parent instanceof TC.feature.MultiPolyline):\r\n                    isPolygonOrMultiLineString = true;\r\n                    ctor = ctor || ((TC.feature.Polygon && self.parent instanceof TC.feature.Polygon) ? ol.geom.Polygon : ol.geom.MultiLineString);\r\n                    ringsOrPolylines = isMultiPolygon ? ringsOrPolylines : geometry;\r\n                    if (Array.isArray(ringsOrPolylines)) {\r\n                        points = ringsOrPolylines[0];\r\n                    }\r\n                case (TC.feature.Polyline && self.parent instanceof TC.feature.Polyline) || TC.feature.MultiPoint && self.parent instanceof TC.feature.MultiPoint:\r\n                    isLineString = true;\r\n                    ctor = ctor || ((TC.feature.Polyline && self.parent instanceof TC.feature.Polyline) ? ol.geom.LineString : ol.geom.MultiPoint);\r\n                    points = isPolygonOrMultiLineString ? points : geometry;\r\n                    if (Array.isArray(points)) {\r\n                        point = points[0];\r\n                    }\r\n                case (TC.feature.Point && self.parent instanceof TC.feature.Point):\r\n                    ctor = ctor || ol.geom.Point;\r\n                    point = isLineString ? point : geometry;\r\n                    if (Array.isArray(point) && typeof point[0] === 'number' && typeof point[1] === 'number') {\r\n                        var layout;\r\n                        switch (point.length) {\r\n                            case 3:\r\n                                layout = ol.geom.GeometryLayout.XYZ;\r\n                                break;\r\n                            case 4:\r\n                                layout = ol.geom.GeometryLayout.XYZM;\r\n                                break;\r\n                            default:\r\n                                layout = ol.geom.GeometryLayout.XY;\r\n                                break;\r\n                        }\r\n                        if (geom) {\r\n                            geom.setCoordinates(geometry, layout);\r\n                        }\r\n                        else {\r\n                            geom = new ctor(geometry, layout);\r\n                            self.feature.setGeometry(geom);\r\n                        }\r\n                    }\r\n                    break;\r\n                case (TC.feature.Circle && self.parent instanceof TC.feature.Circle):\r\n                    if (Array.isArray(geometry) &&\r\n                        Array.isArray(geometry[0])\r\n                        && typeof geometry[0][0] === 'number' && typeof geometry[0][1] === 'number'\r\n                        && typeof geometry[1] === 'number') {\r\n                        var layout;\r\n                        switch (geometry[0].length) {\r\n                            case 3:\r\n                                layout = ol.geom.GeometryLayout.XYZ;\r\n                                break;\r\n                            case 4:\r\n                                layout = ol.geom.GeometryLayout.XYZM;\r\n                                break;\r\n                            default:\r\n                                layout = ol.geom.GeometryLayout.XY;\r\n                                break;\r\n                        }\r\n                        if (geom) {\r\n                            geom.setCenterAndRadius(geometry[0], geometry[1], layout);\r\n                        }\r\n                        else {\r\n                            geom = new ol.geom.Circle(geometry[0], geometry[1], layout);\r\n                            self.feature.setGeometry(geom);\r\n                        }\r\n                    }\r\n                    break;\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getId = function () {\r\n        var result;\r\n        var self = this;\r\n        if (self.feature) {\r\n            result = self.feature.getId();\r\n        };\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setId = function (id) {\r\n        var self = this;\r\n        if (self.feature) {\r\n            self.feature.setId(id);\r\n        };\r\n    };\r\n\r\n    const getPolygonLength = function (polygon, options) {\r\n        const self = this;\r\n        var result = 0;\r\n        polygon.getLinearRings().forEach(function (ring) {\r\n            coordinates = ring.getCoordinates();\r\n            if (options.crs) {\r\n                coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n            }\r\n            const polygon = new ol.geom.Polygon([coordinates]);\r\n            const newRing = polygon.getLinearRing(0);\r\n            result = result + ol.geom.flat.linearRingLength(newRing.flatCoordinates, 0, newRing.flatCoordinates.length, newRing.stride);\r\n        });\r\n        return result;\r\n    };\r\n\r\n    const getLineStringLength = function (lineString, options) {\r\n        const self = this;\r\n        coordinates = lineString.getCoordinates();\r\n        if (options.crs) {\r\n            coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n        }\r\n        const line = new ol.geom.LineString(coordinates);\r\n        return line.getLength();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getLength = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        var result = 0;\r\n\r\n        const geom = self.feature.getGeometry();\r\n        var coordinates;\r\n        switch (true) {\r\n            case geom instanceof ol.geom.Polygon:\r\n                result = getPolygonLength.call(self, geom, options);\r\n                break;\r\n            case geom instanceof ol.geom.LineString:\r\n                result = getLineStringLength.call(self, geom, options);\r\n                break;\r\n            case geom instanceof ol.geom.MultiPolygon:\r\n                geom.getPolygons().forEach(function (polygon) {\r\n                    result = result + getPolygonLength.call(self, polygon, options);\r\n                });\r\n                break;\r\n            case geom instanceof ol.geom.MultiPolygon:\r\n                geom.getLineStrings().forEach(function (lineString) {\r\n                    result = result + getLineStringLength.call(self, lineString, options);\r\n                });\r\n                break;\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getArea = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        const geom = self.feature.getGeometry();\r\n        var coordinates;\r\n        if (geom instanceof ol.geom.Polygon) {\r\n            coordinates = geom.getLinearRing(0).getCoordinates();\r\n            if (options.crs) {\r\n                coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n            }\r\n            const polygon = new ol.geom.Polygon([coordinates]);\r\n            return polygon.getArea();\r\n        }\r\n    };\r\n\r\n    const getNativeFeatureStyle = function (feature, readonly) {\r\n        var style = feature.getStyle();\r\n        if (TC.Util.isFunction(style)) {\r\n            style = style(feature);\r\n        }\r\n        if (Array.isArray(style)) {\r\n            style = style.reduce(function (extendedStyle, currentStyle) {\r\n                extendedStyle.fill_ = currentStyle.fill_ || extendedStyle.fill_;\r\n                extendedStyle.image_ = currentStyle.image_ || extendedStyle.image_;\r\n                extendedStyle.stroke_ = currentStyle.stroke_ || extendedStyle.stroke_;\r\n                extendedStyle.text_ = currentStyle.text_ || extendedStyle.text_;\r\n                return extendedStyle;\r\n            }, new ol.style.Style());\r\n        }\r\n        if (!style && !readonly) {\r\n            style = new ol.style.Style();\r\n            feature.setStyle(style);\r\n        }\r\n        return style;\r\n    };\r\n\r\n    const getNativeLayerStyle = function (feature) {\r\n        var style = this.getStyle();\r\n        if (TC.Util.isFunction(style)) {\r\n            style = style(feature);\r\n        }\r\n        if (Array.isArray(style)) {\r\n            style = style[style.length - 1];\r\n        }\r\n        if (!style) {\r\n            style = new ol.style.Style();\r\n        }\r\n        return style;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setStyle = function (options) {\r\n        const self = this;\r\n        const olFeat = self.feature;\r\n        if (options === null) {\r\n            olFeat.setStyle(null);\r\n            return;\r\n        }\r\n        const feature = self.parent;\r\n        const geom = olFeat.getGeometry();\r\n        let newStyle = olFeat.getStyle();\r\n        let layerStyle;\r\n        if (feature.layer) {\r\n            layerStyle = getNativeLayerStyle.call(feature.layer.wrap.layer, feature.wrap.feature);\r\n        }\r\n        if (!newStyle) {\r\n            if (layerStyle) {\r\n                newStyle = layerStyle.clone();\r\n            }\r\n            else {\r\n                newStyle = new ol.style.Style();\r\n            }\r\n        }\r\n        if (TC.Util.isFunction(newStyle)) {\r\n            newStyle = newStyle(olFeat);\r\n        }\r\n        if (!Array.isArray(newStyle)) {\r\n            newStyle = [newStyle];\r\n        }\r\n        let style = newStyle[newStyle.length - 1];\r\n        if (geom instanceof ol.geom.Point || geom instanceof ol.geom.MultiPoint) {\r\n\r\n            var imageStyle;\r\n            if (options.anchor || options.url || options.cssClass) { // Marcador\r\n                imageStyle = style.getImage();\r\n                const iconOptions = {};\r\n                if (imageStyle instanceof ol.style.Icon) {\r\n                    iconOptions.src = options.url || TC.Util.getBackgroundUrlFromCss(options.cssClass) || imageStyle.getSrc();\r\n\r\n                    if (options.width && options.height) {\r\n                        iconOptions.size = [getStyleValue(options.width, feature), getStyleValue(options.height, feature)];\r\n                    }\r\n                    else {\r\n                        iconOptions.size = imageStyle.getSize();\r\n                    }\r\n                    iconOptions.anchor = getStyleValue(options.anchor, feature);\r\n                    if (!iconOptions.anchor) {\r\n                        const imgAnchor = imageStyle.getAnchor();\r\n                        if (Array.isArray(imgAnchor)) {\r\n                            iconOptions.anchor = imgAnchor.map(function (elm, idx) {\r\n                                return elm / iconOptions.size[idx];\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    iconOptions.src = TC.Util.getPointIconUrl(options);\r\n                    iconOptions.anchor = getStyleValue(options.anchor, feature);\r\n                    iconOptions.size = [getStyleValue(options.width, feature), getStyleValue(options.height, feature)];\r\n                };\r\n                if (options.angle) {\r\n                    iconOptions.angle = options.angle;\r\n                }\r\n\r\n                imageStyle = new ol.style.Icon(iconOptions);\r\n            }\r\n            else if (!(style.getImage()) && style.getText()) { // Etiqueta\r\n\r\n                if (options.label !== undefined) {\r\n                    if (options.label.length) {\r\n                        style.setText(createNativeTextStyle(options, feature));\r\n                    }\r\n                    else {\r\n                        style.setText();\r\n                    }\r\n                } else {\r\n                    style.setText();\r\n                }\r\n            }\r\n            else { // Punto sin icono\r\n                imageStyle = style.getImage();\r\n                if (!imageStyle) {\r\n                    imageStyle = new ol.style.Circle();\r\n                }\r\n                const circleOptions = {\r\n                    radius: getStyleValue(options.radius, feature) ||\r\n                    (getStyleValue(options.height, feature) + getStyleValue(options.width, feature)) / 4\r\n                };\r\n                if (isNaN(circleOptions.radius) && imageStyle.getRadius) {\r\n                    circleOptions.radius = imageStyle.getRadius();\r\n                }\r\n                if (options.fillColor) {\r\n                    circleOptions.fill = new ol.style.Fill({\r\n                        color: getRGBA(getStyleValue(options.fillColor, feature), getStyleValue(options.fillOpacity, feature))\r\n                    });\r\n                }\r\n                else if (imageStyle.getFill) {\r\n                    circleOptions.fill = imageStyle.getFill();\r\n                }\r\n                circleOptions.stroke = imageStyle.getStroke ? imageStyle.getStroke() : new ol.style.Stroke();\r\n                const layerStroke = layerStyle && layerStyle.getStroke();\r\n                if (options.strokeColor || options.strokeWidth) {\r\n                    if (!circleOptions.stroke) {\r\n                        circleOptions.stroke = new ol.style.Stroke();\r\n                    }\r\n                    if (options.strokeColor) {\r\n                        circleOptions.stroke.setColor(getStyleValue(options.strokeColor, feature));\r\n                    }\r\n                    else {\r\n                        const strokeColor = circleOptions.stroke.getColor() || (layerStroke && layerStroke.getColor() || TC.Cfg.styles.point.strokeColor);\r\n                        circleOptions.stroke.setColor(getStyleValue(strokeColor, feature));\r\n                    }\r\n                    if (options.strokeWidth) {\r\n                        circleOptions.stroke.setWidth(getStyleValue(options.strokeWidth, feature));\r\n                    }\r\n                    else {\r\n                        const strokeWidth = circleOptions.stroke.getWidth() || (layerStroke && layerStroke.getWidth() || TC.Cfg.styles.point.strokeWidth);\r\n                        circleOptions.stroke.setWidth(getStyleValue(strokeWidth, feature));\r\n                    }\r\n                }\r\n                imageStyle = new ol.style.Circle(circleOptions);\r\n            }\r\n            style.setImage(imageStyle);\r\n        }\r\n        else {\r\n            var stroke = style.getStroke();\r\n            var strokeChanged = false;\r\n            if (!stroke) {\r\n                stroke = new ol.style.Stroke();\r\n            }\r\n            if (options.strokeColor) {\r\n                stroke.setColor(getStyleValue(options.strokeColor, feature));\r\n                strokeChanged = true;\r\n            }\r\n            if (options.strokeWidth) {\r\n                stroke.setWidth(getStyleValue(options.strokeWidth, feature));\r\n                strokeChanged = true;\r\n            }\r\n            if (options.lineDash) {\r\n                stroke.setLineDash(options.lineDash)\r\n                strokeChanged = true;\r\n            }\r\n            if (strokeChanged) {\r\n                style.setStroke(stroke);\r\n            }\r\n            if (geom instanceof ol.geom.Polygon || geom instanceof ol.geom.MultiPolygon) {\r\n                if (options.fillColor || options.fillOpacity) {\r\n                    var fill = style.getFill() || new ol.style.Fill();\r\n                    fill.setColor(getRGBA(getStyleValue(options.fillColor, feature), getStyleValue(options.fillOpacity, feature)));\r\n                    style.setFill(fill);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (options.label !== undefined) {\r\n            if (options.label.length) {\r\n                style.setText(createNativeTextStyle(options, feature));\r\n            }\r\n            else {\r\n                style.setText();\r\n            }\r\n        }\r\n        olFeat.setStyle(newStyle);\r\n        olFeat.changed();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.toggleSelectedStyle = function (condition) {\r\n        const self = this;\r\n        const feature = self.feature;\r\n        const setStyle = condition === undefined ? !feature._originalStyle : condition;\r\n        if (setStyle) {\r\n            setSelectedStyle(feature);\r\n        }\r\n        else {\r\n            removeSelectedStyle(feature);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getInnerPoint = function (options) {\r\n        var result;\r\n        var opts = options || {};\r\n        // Funciones para hacer clipping con el extent actual. Así nos aseguramos de que el popup sale en un punto visible actualmente.\r\n        var feature = this.feature;\r\n        var geometry = feature.getGeometry();\r\n\r\n        if (!TC.Geometry) {\r\n            TC.syncLoadJS(TC.apiLocation + 'TC/Geometry');\r\n        }\r\n        let coords;\r\n        let clipped = false;\r\n        result = geometry.getFirstCoordinate();\r\n        switch (geometry.getType()) {\r\n            case ol.geom.GeometryType.MULTI_POLYGON:\r\n                if (opts.clipBox) {\r\n                    geometry = new ol.geom.MultiPolygon(geometry\r\n                        .getPolygons()\r\n                        .map(pol => TC.Geometry.clipPolygon(pol.getCoordinates(), opts.clipBox))\r\n                        .filter(pol => pol.length));\r\n                    clipped = true;\r\n                }\r\n                var area = 0;\r\n                geometry = geometry.getPolygons().reduce(function (prev, cur) {\r\n                    const curArea = cur.getArea();\r\n                    const result = curArea > area ? cur : prev;\r\n                    area = curArea;\r\n                    return result;\r\n                });\r\n            case ol.geom.GeometryType.POLYGON:\r\n                coords = geometry.getCoordinates();\r\n                if (opts.clipBox && !clipped) {\r\n                    coords = TC.Geometry.clipPolygon(coords, opts.clipBox);\r\n                }\r\n                geometry = new ol.geom.Polygon(coords);\r\n                result = geometry.getInteriorPoint().getCoordinates();\r\n                var rings = geometry.getLinearRings();\r\n                // Miramos si el punto está dentro de un agujero\r\n                for (var i = 1; i < rings.length; i++) {\r\n                    if (TC.Geometry.isInside(result, rings[i].getCoordinates())) {\r\n                        result = geometry.getClosestPoint(result);\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            case ol.geom.GeometryType.MULTI_LINE_STRING:\r\n                if (opts.clipBox) {\r\n                    geometry = new ol.geom.MultiLineString(geometry\r\n                        .getLineStrings()\r\n                        .map(ls => TC.Geometry.clipPolyline(ls.getCoordinates(), opts.clipBox))\r\n                        .filter(ls => ls.length));\r\n                    clipped = true;\r\n                }\r\n                var length = 0;\r\n                geometry = geometry.getLineStrings().reduce(function (prev, cur) {\r\n                    const curLength = cur.getLength();\r\n                    const result = curLength > length ? cur : prev;\r\n                    length = curLength;\r\n                    return result;\r\n                });\r\n            case ol.geom.GeometryType.LINE_STRING:\r\n                var centroid = [0, 0];\r\n                coords = geometry.getCoordinates();\r\n                if (opts.clipBox && !clipped) {\r\n                    coords = TC.Geometry.clipPolyline(coords, opts.clipBox);\r\n                }\r\n                geometry = new ol.geom.LineString(coords);\r\n                for (var i = 0; i < coords.length; i++) {\r\n                    centroid[0] += coords[i][0];\r\n                    centroid[1] += coords[i][1];\r\n                }\r\n                centroid[0] /= coords.length;\r\n                centroid[1] /= coords.length;\r\n                result = geometry.getClosestPoint(centroid);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.showPopup = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const popupCtl = options && options instanceof TC.Control ? options : options.control;\r\n        var map = popupCtl.map;\r\n        if (map) {\r\n            var feature = self.feature;\r\n            if (feature) {\r\n                map.currentFeature = self.parent;\r\n                var currentExtent = map.getExtent();\r\n\r\n                self._innerCentroid = self.getInnerPoint({ clipBox: currentExtent });\r\n\r\n                popupCtl.contentDiv.innerHTML = options.html || self.parent.getInfo({ locale: map.options.locale });\r\n               \r\n                var parentOptions = self.parent.options;\r\n                if (TC.Util.isEmptyObject(parentOptions) && self.parent.layer &&\r\n                    self.parent.layer.options && self.parent.layer.options.styles) {\r\n\r\n                    switch (self.parent.CLASSNAME) {\r\n                        case \"TC.feature.Point\":\r\n                            parentOptions = self.parent.layer.options.styles.point;\r\n\r\n                            // 11/03/2019 Al crear las features del API desde las features nativas, \r\n                            // se valida si la feature tiene icono para definir si es punto o marcador\r\n                            // el problema viene cuando la feature no tiene estilo propio sino que lo obtiene de la capa,\r\n                            // en esos casos se define como punto lo que es un marcador y cuando llegamos aquí no se accede a las\r\n                            // opciones de marcador sino de punto.\r\n                            if (!parentOptions || TC.Util.isEmptyObject(parentOptions)) {\r\n                                parentOptions = self.parent.layer.options.styles.marker;\r\n                            }\r\n                            break;\r\n                        case \"TC.feature.Marker\":\r\n                            parentOptions = self.parent.layer.options.styles.marker;\r\n                            break;\r\n                        case \"TC.feature.Circle\":\r\n                            parentOptions = self.parent.layer.options.styles.circle;\r\n                            break;\r\n                        case \"TC.feature.MultiPolygon\":\r\n                        case \"TC.feature.Polygon\":\r\n                            parentOptions = self.parent.layer.options.styles.polygon;\r\n                            break;\r\n                        case \"TC.feature.MultiPolyline\":\r\n                        case \"TC.feature.Polyline\":\r\n                            parentOptions = self.parent.layer.options.styles.line;\r\n                            break;\r\n                    }\r\n                }\r\n\r\n                // Calcular anchor\r\n                var anchor;\r\n                if (parentOptions.anchor) {\r\n                    anchor = getStyleValue(parentOptions.anchor, self.parent);\r\n                }\r\n                else {\r\n                    var style;\r\n                    var f = feature._wrap.parent;\r\n                    for (var i = 0; i < map.workLayers.length; i++) {\r\n                        var layer = map.workLayers[i];\r\n                        if (!layer.isRaster()) {\r\n                            if (layer.features.indexOf(f) >= 0) {\r\n                                style = layer.wrap.styleFunction(feature);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                    if (Array.isArray(style)) {\r\n                        const image = style[0].getImage();\r\n                        anchor = !image || image instanceof ol.style.Icon ? [0.5, 0] : [0.5, 0.5];\r\n                    }\r\n                }\r\n                const offset = [0, 0];\r\n                if (anchor) {\r\n                    if (parentOptions.height) {\r\n                        offset[1] = -(getStyleValue(parentOptions.height, self.parent) || 0) * anchor[1];\r\n                    }\r\n                    else {\r\n                        var fStyle = getNativeFeatureStyle(feature, true);\r\n                        if (fStyle) {\r\n                            const image = fStyle.getImage();\r\n                            if (image instanceof ol.style.Icon) {\r\n                                const size = image.getImageSize();\r\n                                if (size) {\r\n                                    offset[1] = size[1] * -image.getScale();\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                popupCtl.wrap.setDragged(false);\r\n                popupCtl.wrap.popup.setOffset(offset);\r\n                popupCtl.wrap.popup.setPosition(self._innerCentroid);\r\n                popupCtl.popupDiv.classList.add(TC.Consts.classes.VISIBLE);\r\n            } else {\r\n                map.wrap.hidePopup(popupCtl);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.isNative = function (feature) {\r\n        return feature instanceof ol.Feature;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getPath = function () {\r\n        var result = [];\r\n        var self = this;\r\n        if (self.feature && self.feature._folders) {\r\n            result = self.feature._folders;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getBounds = function () {\r\n        var result = null;\r\n        var self = this;\r\n        if (self.feature) {\r\n            const geometry = self.feature.getGeometry();\r\n            if (!geometry) return null;\r\n            result = geometry.getExtent();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getTemplate = function () {\r\n        var result = null;\r\n        var self = this;\r\n        var style = self.feature.getStyle();\r\n        if (TC.Util.isFunction(style)) {\r\n            style = style(self.feature);\r\n        }\r\n        if (Array.isArray(style)) {\r\n            for (var i = 0; i < style.length; i++) {\r\n                if (style[i]._balloon) {\r\n                    var s = style[i]._balloon.getText();\r\n                    if (s) {\r\n                        style = style[i]._balloon;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (style && !Array.isArray(style) && style.getText) {\r\n            result = style.getText();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getData = function () {\r\n        var self = this;\r\n        var result = self.feature.getProperties();\r\n        // En caso de clusters\r\n        if (Array.isArray(result.features)) {\r\n            if (result.features.length === 1) {\r\n                result = result.features[0].getProperties();\r\n            }\r\n            else {\r\n                result = result.features.length + ' elementos';\r\n            }\r\n        }\r\n        var geometryName = self.feature.getGeometryName();\r\n        if (result[geometryName]) {\r\n            delete result[geometryName];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setData = function (data) {\r\n        this.feature.setProperties(data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.unsetData = function (key) {\r\n        const feature = this.feature;\r\n        feature.unset(key);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.clearData = function () {\r\n        const feature = this.feature;\r\n        const geometryName = feature.getGeometryName();\r\n        feature.getKeys().forEach(function (key) {\r\n            if (key !== geometryName) {\r\n                feature.unset(key);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.mouseMoveHandler = function (evt) {\r\n        const self = this;\r\n        if (self.sketch) {\r\n            self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.mouseOverHandler = function (evt) {\r\n        const self = this;\r\n        if (self.sketch && self.hoverCoordinate) {\r\n            self.pushCoordinate(self.hoverCoordinate);\r\n            self.hoverCoordinate = null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.clickHandler = function (evt) {\r\n        const self = this;\r\n        if (self.parent.map.view === TC.Consts.view.PRINTING) {\r\n            return;\r\n        }\r\n        if (self._mdPx) { // No operamos si el clic es consecuencia es en realidad un drag\r\n            const dx = self._mdPx[0] - evt.clientX;\r\n            const dy = self._mdPx[1] - evt.clientY;\r\n            if (dx * dx + dy * dy > self.interaction.squaredClickTolerance_) {\r\n                return;\r\n            }\r\n        }\r\n        if (self.sketch) {\r\n            var coords = self.sketch.getGeometry().getCoordinates();\r\n            self.parent.trigger(TC.Consts.event.POINT, {\r\n                point: coords[coords.length - 1]\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.pointerdownHandler = function (evt) {\r\n        const self = this;\r\n        self._mdPx = [evt.clientX, evt.clientY];\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.getMeasureData = function () {\r\n        var self = this;\r\n\r\n        var formatLength = function (line, data) {\r\n            line = new ol.geom.LineString(TC.Util.reproject(line.getCoordinates(), self.parent.map.crs, self.parent.map.options.utmCrs));\r\n            data.length = line.getLength();\r\n        };\r\n\r\n        var formatArea = function (polygon, data) {\r\n            polygon = new ol.geom.Polygon([TC.Util.reproject(polygon.getLinearRing(0).getCoordinates(), self.parent.map.crs, self.parent.map.options.utmCrs)]);\r\n            data.area = polygon.getArea();\r\n            var ring = polygon.getLinearRing(0);\r\n            data.perimeter = ol.geom.flat.linearRingLength(ring.flatCoordinates, 0, ring.flatCoordinates.length, ring.stride);\r\n        };\r\n\r\n        var result = {\r\n            units: ol.proj.Units.METERS\r\n        };\r\n        if (this.sketch) {\r\n            var geom = (this.sketch.getGeometry());\r\n            if (geom instanceof ol.geom.Polygon) {\r\n                formatArea(geom, result);\r\n            }\r\n            else if (geom instanceof ol.geom.LineString) {\r\n                formatLength(geom, result);\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    // Función para reproyectar el dibujo actual\r\n    const drawProjectionChangeHandler = function (ctl, e) {\r\n        if (ctl.sketch) {\r\n            const oldProj = e.oldValue.getProjection();\r\n            const newProj = e.target.get(e.key).getProjection();\r\n            if (oldProj.getCode() !== newProj.getCode()) {\r\n                const geom = ctl.sketch.getGeometry();\r\n                geom.transform(oldProj, newProj);\r\n                ctl.interaction.sketchPoint_.getGeometry().transform(oldProj, newProj);\r\n                const flatCoordinates = [];\r\n                var sketchCoords;\r\n                if (ctl.parent.mode === TC.Consts.geom.POLYGON) {\r\n                    sketchCoords = ctl.interaction.sketchCoords_[0];\r\n                }\r\n                else {\r\n                    sketchCoords = ctl.interaction.sketchCoords_;\r\n                }\r\n                ol.geom.flat.deflateCoordinates(flatCoordinates, 0, sketchCoords, geom.stride);\r\n                const transformFn = ol.proj.getTransform(oldProj, newProj);\r\n                transformFn(flatCoordinates, flatCoordinates, geom.stride);\r\n                sketchCoords = ol.geom.flat.inflateCoordinates(flatCoordinates, 0, flatCoordinates.length, geom.stride);\r\n                if (ctl.parent.mode === TC.Consts.geom.POLYGON) {\r\n                    ctl.interaction.sketchCoords_ = [sketchCoords];\r\n                }\r\n                else {\r\n                    ctl.interaction.sketchCoords_ = sketchCoords;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.activate = function (mode) {\r\n        var self = this;\r\n\r\n        var type;\r\n        switch (mode) {\r\n            case TC.Consts.geom.POLYGON:\r\n                type = ol.geom.GeometryType.POLYGON;\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYGON:\r\n                type = ol.geom.GeometryType.MULTI_POLYGON;\r\n                break;\r\n            case TC.Consts.geom.POINT:\r\n                type = ol.geom.GeometryType.POINT;\r\n                break;\r\n            case TC.Consts.geom.MULTIPOINT:\r\n                type = ol.geom.GeometryType.MULTI_POINT;\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYLINE:\r\n                type = ol.geom.GeometryType.MULTI_LINE_STRING;\r\n                break;\r\n            default:\r\n                type = ol.geom.GeometryType.LINE_STRING;\r\n                break;\r\n        }\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.getLayer()]).then(function (objects) {\r\n                const olMap = objects[0];\r\n                const layer = objects[1];\r\n                if (layer) {\r\n                    layer.wrap.getLayer().then(function (olLayer) {\r\n\r\n                        if (!self.viewport) self.viewport = olMap.getViewport();\r\n\r\n                        if (self.interaction) {\r\n                            olMap.removeInteraction(self.interaction);\r\n                            if (self._pointerdownHandler) {\r\n                                self.viewport.removeEventListener('pointerdown', self._pointerdownHandler);\r\n                                self._pointerdownHandler = null;\r\n                            }\r\n                            if (self._clickHandler) {\r\n                                self.viewport.removeEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                                self._clickHandler = null;\r\n                            }\r\n                            if (self._mouseMoveHandler && self._mouseOverHandler) {\r\n                                self.viewport.removeEventListener(MOUSEMOVE, self._mouseMoveHandler);\r\n                                self.viewport.removeEventListener(MOUSEOVER, self._mouseOverHandler);\r\n                            }\r\n                        }\r\n\r\n                        if (self.snapInteraction) {\r\n                            olMap.removeInteraction(self.snapInteraction);\r\n                        }\r\n\r\n                        if (mode) {\r\n                            self._pointerdownHandler = self.pointerdownHandler.bind(self);\r\n                            self._clickHandler = self.clickHandler.bind(self);\r\n                            self.viewport.addEventListener('pointerdown', self._pointerdownHandler);\r\n                            self.viewport.addEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                            if (self.parent.measure) {\r\n                                self._mouseMoveHandler = self.mouseMoveHandler.bind(self);\r\n                                self._mouseOverHandler = self.mouseOverHandler.bind(self);\r\n                                self.viewport.addEventListener(MOUSEMOVE, self._mouseMoveHandler);\r\n                                self.viewport.addEventListener(MOUSEOVER, self._mouseOverHandler);\r\n                            }\r\n\r\n                            var drawOptions = {\r\n                                type: type,\r\n                                snapTolerance: 0,\r\n                                condition: function () {\r\n                                    if (ol.events.condition.shiftKeyOnly(arguments[0])) {\r\n                                        hole = olMap.forEachFeatureAtPixel(olMap.getPixelFromCoordinate(arguments[0].coordinate), function (feature) {\r\n                                            if (ol.geom.GeometryType.POLYGON == feature.getGeometry().getType() ||\r\n                                                ol.geom.GeometryType.MULTI_POLYGON == feature.getGeometry().getType()) {\r\n                                                return feature;\r\n                                            }\r\n                                            return null;\r\n                                        },\r\n                                            {\r\n                                                hitTolerance: hitTolerance\r\n                                            });\r\n                                    }\r\n\r\n                                    if (self.parent.map.view === TC.Consts.view.PRINTING) {\r\n                                        return null;\r\n                                    }\r\n\r\n                                    return true;\r\n                                }\r\n                            };\r\n                            if (olLayer) {\r\n                                drawOptions.source = olLayer.getSource();\r\n                            }\r\n                            const parentStyles = self.parent.styles || {};\r\n                            switch (mode) {\r\n                                case TC.Consts.geom.RECTANGLE:\r\n                                    if (parentStyles.line) {\r\n                                        drawOptions.style = createNativeStyle({\r\n                                            styles: {\r\n                                                line: parentStyles.line,\r\n                                                point: false,\r\n                                                polygon: false\r\n                                            }\r\n                                        });\r\n                                    }\r\n                                    drawOptions.type = ol.geom.GeometryType.LINE_STRING;\r\n                                    drawOptions.maxPoints = 2;\r\n                                    drawOptions.geometryFunction = function (coordinates, geometry) {\r\n                                        const start = coordinates[0];\r\n                                        const end = coordinates[1];\r\n                                        const newCoords = [[start, [start[0], end[1]], end, [end[0], start[1]], start]];\r\n                                        if (geometry) {\r\n                                            geometry.setCoordinates(newCoords);\r\n                                        }\r\n                                        else {\r\n                                            geometry = new ol.geom.Polygon(newCoords);\r\n                                        }\r\n                                        return geometry;\r\n                                    };\r\n                                    break;\r\n                                case TC.Consts.geom.POLYGON:\r\n                                case TC.Consts.geom.MULTIPOLYGON:\r\n                                    if (parentStyles.polygon) {\r\n                                        drawOptions.style = createNativeStyle({\r\n                                            styles: {\r\n                                                polygon: parentStyles.polygon,\r\n                                                line: false,\r\n                                                point: false\r\n                                            }\r\n                                        });\r\n                                    }\r\n                                    break;\r\n                                case TC.Consts.geom.POINT:\r\n                                case TC.Consts.geom.MULTIPOINT:\r\n                                    if (parentStyles.point) {\r\n                                        drawOptions.style = createNativeStyle({\r\n                                            styles: {\r\n                                                point: parentStyles.point,\r\n                                                line: false,\r\n                                                polygon: false\r\n                                            }\r\n                                        });\r\n                                    }\r\n                                    break;\r\n                                case TC.Consts.geom.MULTIPOLYLINE:\r\n                                default:\r\n                                    if (parentStyles.line) {\r\n                                        drawOptions.style = createNativeStyle({\r\n                                            styles: {\r\n                                                line: parentStyles.line,\r\n                                                point: false,\r\n                                                polygon: false\r\n                                            }\r\n                                        });\r\n                                    }\r\n                                    break;\r\n                            }\r\n\r\n                            self.interaction = new ol.interaction.Draw(drawOptions);\r\n\r\n                            self.interaction.on('drawstart', function (evt) {\r\n                                self.sketch = evt.feature;\r\n                                self.parent.trigger(TC.Consts.event.DRAWSTART);\r\n                            }, this);\r\n\r\n                            self.interaction.on('drawend', function (evt) {\r\n                                const overlayStyle = evt.target.overlay_.getStyle();\r\n                                evt.feature.setStyle(Array.isArray(overlayStyle) ? overlayStyle.map(function (style) {\r\n                                    return style.clone();\r\n                                }) : overlayStyle);\r\n                                if (self.parent.measure) {\r\n                                    self.parent.trigger(TC.Consts.event.MEASURE, self.getMeasureData());\r\n                                }\r\n                                TC.wrap.Feature.createFeature(self.sketch).then(function (feat) {\r\n                                    const endFn = function () {\r\n                                        self.parent.trigger(TC.Consts.event.DRAWEND, { feature: feat });\r\n                                        self.sketch = null;\r\n                                        self.interaction.setActive(true);\r\n                                    };\r\n                                    if (self.parent.mode === TC.Consts.geom.RECTANGLE) {\r\n                                        const delay = 400;\r\n                                        const dblClickInteraction = self.interaction\r\n                                            .getMap()\r\n                                            .getInteractions()\r\n                                            .getArray()\r\n                                            .filter(i => i instanceof ol.interaction.DoubleClickZoom)[0];\r\n                                        // Desactivamos temporalmente el zoom por doble clic para evitar que se lance accidentalmente\r\n                                        if (dblClickInteraction && dblClickInteraction.getActive()) {\r\n                                            dblClickInteraction.setActive(false);\r\n                                            setTimeout(function () {\r\n                                                dblClickInteraction.setActive(true);\r\n                                            }, delay);\r\n                                        }\r\n                                        self.interaction.setActive(false);\r\n                                        setTimeout(endFn, delay); // Retardo para evitar pulsaciones accidentales en dobles clics del usuario\r\n                                    }\r\n                                    else {\r\n                                        endFn();\r\n                                    }\r\n                                });\r\n                            }, this);\r\n\r\n                            self._projectionChangeHandler = function (e) {\r\n                                drawProjectionChangeHandler(self, e);\r\n                            };\r\n                            olMap.on('change:view', self._projectionChangeHandler);\r\n\r\n                            olMap.addInteraction(self.interaction);\r\n\r\n                            if (self.parent.snapping) {\r\n                                var snapOptions = {};\r\n                                if (olLayer) {\r\n                                    snapOptions.source = olLayer.getSource();\r\n                                }\r\n                                else if (self.parent.snapping instanceof TC.Layer) {\r\n                                    snapOptions.source = self.parent.snapping.wrap.layer.getSource();\r\n                                }\r\n                                self.snapInteraction = new ol.interaction.Snap(snapOptions);\r\n                                olMap.addInteraction(self.snapInteraction);\r\n                            }\r\n                        }\r\n\r\n                        self.redoStack = [];\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.deactivate = function () {\r\n        var self = this;\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.getLayer()]).then(function (objects) {\r\n                const olMap = objects[0];\r\n                const layer = objects[1];\r\n                if (self.viewport) {\r\n                    if (self._pointerdownHandler) {\r\n                        self.viewport.removeEventListener('pointerdown', self._pointerdownHandler);\r\n                        self._pointerdownHandler = null;\r\n                    }\r\n                    if (self._clickHandler) {\r\n                        self.viewport.removeEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                        self._clickHandler = null;\r\n                    }\r\n                }\r\n                if (layer && !self.parent.persistent) {\r\n                    layer.clearFeatures();\r\n                }\r\n                if (self.interaction) {\r\n                    olMap.removeInteraction(self.interaction);\r\n                    self.interaction = null;\r\n                }\r\n                olMap.un('change:view', self._projectionChangeHandler);\r\n            });\r\n        }\r\n    };\r\n\r\n    //El valor devuelto es lo que va al stack de redo\r\n    TC.wrap.control.Draw.prototype.popCoordinate = function () {\r\n        var self = this;\r\n        var result = null;\r\n        if (self.interaction) {\r\n            var feature = self.interaction.sketchFeature_;\r\n            if (feature) {\r\n                var coords;\r\n                var geom = feature.getGeometry();\r\n\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    coords = geom.getCoordinates()[0];\r\n                }\r\n                else if (geom instanceof ol.geom.LineString) {\r\n                    coords = geom.getCoordinates();\r\n                }\r\n                var fullCoords = coords;\r\n                if (coords.length > 1) {\r\n\r\n                    var puntos;\r\n                    if (geom instanceof ol.geom.Polygon)\r\n                        puntos = self.interaction.sketchCoords_[0];\r\n                    else if (geom instanceof ol.geom.LineString)\r\n                        puntos = self.interaction.sketchCoords_;\r\n\r\n                    /*\r\n                    Al menos con linestring, no necesariamente hay que quitar el último\r\n                    Porque OL mete en coordinates del sketchFeature_ tanto el último marcado como el que flota detrás del cursor\r\n                    Para comprobar que realmente es ése, podemos contrastarlo con self.interaction.sketchPoint_.getGeometry().getCoordinates()\r\n                    */\r\n                    var flyingPointContained = false;\r\n                    if (self.interaction.sketchPoint_) {\r\n                        var flyingPoint = self.interaction.sketchPoint_.getGeometry().getCoordinates();\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            if (coords[i][0] == flyingPoint[0] && coords[i][1] == flyingPoint[1]) {\r\n                                flyingPointContained = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    var index;\r\n                    if (flyingPointContained) index = puntos.length - 2;\r\n                    else index = puntos.length - 1;\r\n\r\n                    result = puntos[index];\r\n                    puntos.splice(index, 1);\r\n\r\n                    if (geom instanceof ol.geom.Polygon) {\r\n                        geom.setCoordinates([puntos]);\r\n                        self.interaction.sketchLine_.getGeometry().setCoordinates(puntos);\r\n                    }\r\n                    else {\r\n                        geom.setCoordinates(puntos);\r\n                    }\r\n\r\n\r\n                    feature.setGeometry(geom);\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.pushCoordinate = function (coord) {\r\n        var self = this;\r\n        var result = false;\r\n        if (self.interaction) {\r\n            var feature = self.interaction.sketchFeature_;\r\n            if (feature) {\r\n                var coords;\r\n                var geom = feature.getGeometry();\r\n\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    coords = geom.getCoordinates()[0];\r\n                } else if (geom instanceof ol.geom.LineString) {\r\n                    coords = geom.getCoordinates();\r\n                }\r\n                var fullCoords = coords;\r\n                //coords.push(coord);\r\n\r\n                var puntos;\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    puntos = self.interaction.sketchCoords_[0];\r\n                    //self.interaction.sketchCoords_[0].push(coord);\r\n                    //geom.setCoordinates([fullCoords], ol.geom.GeometryLayout.XY);\r\n                } else if (geom instanceof ol.geom.LineString) {\r\n\r\n                    puntos = self.interaction.sketchCoords_;\r\n                }\r\n\r\n                //Si hay punto volador, hay que meter la coordenada justo antes\r\n                var flyingPointContained = false;\r\n                if (self.interaction.sketchPoint_) {\r\n                    var flyingPoint = self.interaction.sketchPoint_.getGeometry().getCoordinates();\r\n                    for (var i = 0; i < coords.length; i++) {\r\n                        if (coords[i][0] == flyingPoint[0] && coords[i][1] == flyingPoint[1]) {\r\n                            flyingPointContained = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n\r\n\r\n                if (flyingPointContained) index = puntos.length - 1;\r\n                else index = puntos.length;\r\n                puntos.splice(index, 0, coord);\r\n\r\n                if (geom instanceof ol.geom.LineString)\r\n                    geom.setCoordinates(puntos, ol.geom.GeometryLayout.XY);\r\n                else {\r\n                    geom.setCoordinates([puntos], ol.geom.GeometryLayout.XY);\r\n                    self.interaction.sketchLine_.getGeometry().setCoordinates(puntos);\r\n                    //feature.setGeometry(geom);\r\n                }\r\n\r\n\r\n                result = true;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.undo = function () {\r\n        var self = this;\r\n        var result = false;\r\n\r\n        var coord = self.popCoordinate();\r\n        if (coord) {\r\n            self.redoStack.push(coord);\r\n            result = true;\r\n        }\r\n\r\n        self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.redo = function () {\r\n        var self = this;\r\n        var result = false;\r\n\r\n        if (self.redoStack.length > 0) {\r\n            self.pushCoordinate(self.redoStack.pop());\r\n            result = true;\r\n        }\r\n\r\n        self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.end = function () {\r\n        var self = this;\r\n        if (self.interaction && self.interaction.sketchFeature_)\r\n            self.interaction.finishDrawing();\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.setStyle = function (style) {\r\n        const self = this;\r\n        if (self.interaction) {\r\n            self.interaction.overlay_.setStyle(createNativeStyle({\r\n                styles: style\r\n            }));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OfflineMapMaker.prototype.getRequestSchemas = function (options) {\r\n        var extent = options.extent;\r\n        var layers = options.layers;\r\n        var result = new Array(layers.length);\r\n        for (var i = 0, len = result.length; i < len; i++) {\r\n            var layer = layers[i];\r\n            var schema = {\r\n                layerId: layer.id,\r\n                tileMatrixSet: layer.matrixSet\r\n            };\r\n            var olSource = layer.wrap.layer.getSource();\r\n            if (olSource.getUrls) {\r\n                schema.url = olSource.getUrls()[0];\r\n            }\r\n            if (olSource.getTileGrid) {\r\n                var tileGrid = olSource.getTileGrid();\r\n                var resolutions = tileGrid.getResolutions();\r\n                var matrixIds = tileGrid.getMatrixIds();\r\n                var node = layer.getLayerNodeByName(layer.layerNames);\r\n                var tmsLimits = null;\r\n                for (var j = 0, llen = node.TileMatrixSetLink.length; j < llen; j++) {\r\n                    var tmsl = node.TileMatrixSetLink[j];\r\n                    if (tmsl.TileMatrixSet === layer.matrixSet) {\r\n                        tmsLimits = tmsl.TileMatrixSetLimits;\r\n                        break;\r\n                    }\r\n                }\r\n                schema.tileMatrixLimits = [];\r\n                for (var j = 0, rlen = resolutions.length; j < rlen; j++) {\r\n                    var origin = tileGrid.getOrigin(j);\r\n                    var tileSize = tileGrid.getTileSize(j);\r\n                    var resolution = resolutions[j];\r\n                    var unitsPerTile = tileSize * resolution;\r\n                    var tml = {\r\n                        mId: matrixIds[j],\r\n                        res: resolution,\r\n                        origin: origin,\r\n                        tSize: tileSize,\r\n                        cl: Math.floor((extent[0] - origin[0]) / unitsPerTile),\r\n                        cr: Math.floor((extent[2] - origin[0]) / unitsPerTile),\r\n                        rt: Math.floor((origin[1] - extent[3]) / unitsPerTile),\r\n                        rb: Math.floor((origin[1] - extent[1]) / unitsPerTile)\r\n                    }\r\n                    if (tmsLimits) {\r\n                        var tmsLimit = tmsLimits[j];\r\n                        if (tmsLimit) {\r\n                            tml.cl = Math.max(tml.cl, tmsLimit.MinTileCol);\r\n                            tml.cr = Math.min(tml.cr, tmsLimit.MaxTileCol);\r\n                            tml.rt = Math.max(tml.rt, tmsLimit.MinTileRow);\r\n                            tml.rb = Math.min(tml.rb, tmsLimit.MaxTileRow);\r\n                        }\r\n                    }\r\n                    if (tml.cl <= tml.cr && tml.rt <= tml.rb) {\r\n                        schema.tileMatrixLimits.push(tml);\r\n                    }\r\n                }\r\n            }\r\n            result[i] = schema;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.OfflineMapMaker.prototype.getGetTilePattern = function (layer) {\r\n        var result = \"\";\r\n        var olSource = layer.wrap.layer.getSource();\r\n        if (olSource.getUrls) {\r\n            result = olSource.getUrls()[0];\r\n        }\r\n        if (layer.options.encoding !== TC.Consts.WMTSEncoding.RESTFUL) {\r\n            if (result.indexOf('?') < 0) {\r\n                result = result + '?';\r\n            }\r\n            if (result.indexOf('?') === result.length - 1) {\r\n                result = result + 'layer=' + layer.layerNames + '&style=default&tilematrixset=' + encodeURIComponent(layer.matrixSet) +\r\n                    '&Service=WMTS&Request=GetTile&Version=1.0.0&Format=' + encodeURIComponent(layer.format) +\r\n                    '&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}';\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    const createHaloStroke1 = function (width) {\r\n        return new ol.style.Stroke({\r\n            color: '#ffffff',\r\n            width: width + 4,\r\n        });\r\n    };\r\n\r\n    const createHaloStroke2 = function (width) {\r\n        return new ol.style.Stroke({\r\n            color: '#000000',\r\n            width: width + 6,\r\n        });\r\n    };\r\n\r\n    const addHaloToStyle = function (style) {\r\n        if (!style) {\r\n            style = [];\r\n        }\r\n        if (style instanceof ol.style.Style) {\r\n            style = [style];\r\n        }\r\n        style = style.slice();\r\n        const mainStyle = style[0];\r\n        if (mainStyle) {\r\n            const image = mainStyle.getImage();\r\n            var strokeWidth;\r\n            if (image instanceof ol.style.RegularShape) {\r\n                strokeWidth = image.getStroke().getWidth();\r\n                const radius = image.getRadius();\r\n                const haloPart1 = mainStyle.clone();\r\n                haloPart1.setImage(new ol.style.Circle({\r\n                    radius: radius,\r\n                    stroke: createHaloStroke1(strokeWidth)\r\n                }));\r\n                style.unshift(haloPart1);\r\n                const haloPart2 = mainStyle.clone();\r\n                haloPart2.setImage(new ol.style.Circle({\r\n                    radius: radius,\r\n                    stroke: createHaloStroke2(strokeWidth)\r\n                }));\r\n                style.unshift(haloPart2);\r\n            }\r\n            const stroke = mainStyle.getStroke();\r\n            if (stroke) {\r\n                strokeWidth = stroke.getWidth();\r\n                style.unshift(new ol.style.Style({\r\n                    stroke: createHaloStroke1(strokeWidth)\r\n                }));\r\n                style.unshift(new ol.style.Style({\r\n                    stroke: createHaloStroke2(strokeWidth)\r\n                }));\r\n            }\r\n            return style;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const createSelectedStyle = function (feat) {\r\n        let originalStyle = feat._originalStyle = feat._originalStyle || feat.getStyle();\r\n        if (!feat._originalStyle && feat._wrap.parent.layer) {\r\n            originalStyle = feat._wrap.parent.layer.wrap.layer.getStyle();\r\n        }\r\n        if (!originalStyle) {\r\n            originalStyle = createNativeStyle({}, feat);\r\n        }\r\n        if (TC.Util.isFunction(originalStyle)) {\r\n            return function (f, r) {\r\n                return addHaloToStyle(originalStyle(f, r));\r\n            };\r\n        }\r\n        return addHaloToStyle(originalStyle);\r\n    };\r\n\r\n    const setSelectedStyle = function (feat) {\r\n        updateSelectedStyle.call(feat);\r\n        feat.changed();\r\n        //ol.events.listen(feat, CHANGE, updateSelectedStyle, feat);\r\n    };\r\n\r\n    const removeSelectedStyle = function (feat) {\r\n        //ol.events.unlisten(feat, CHANGE, updateSelectedStyle, feat);\r\n        if (feat.hasOwnProperty('_originalStyle')) {\r\n            feat.setStyle(feat._originalStyle);\r\n        }\r\n        delete feat._originalStyle;\r\n    };\r\n\r\n    const updateSelectedStyle = function () {\r\n        this.style_ = createSelectedStyle(this);\r\n        this.styleFunction_ = !this.style_ ? undefined : ol.Feature.createStyleFunction(this.style_);\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.activate = function () {\r\n        const self = this;\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.layer.wrap.getLayer()]).then(function (olObjects) {\r\n                const olMap = olObjects[0];\r\n                const olLayer = olObjects[1];\r\n                if (self.selectInteraction) {\r\n                    olMap.removeInteraction(self.selectInteraction);\r\n                }\r\n                var select = new ol.interaction.Select({\r\n                    layers: [olLayer],\r\n                    hitTolerance: hitTolerance\r\n                });\r\n                self.selectInteraction = select;\r\n                olMap.addInteraction(select);\r\n                var getWrapperFeature = function (elm) {\r\n                    return elm._wrap.parent;\r\n                };\r\n                select.on('select', function (event) {\r\n                    if (event.selected.length > 0) {\r\n                        self.parent.trigger(TC.Consts.event.FEATURESSELECT, { ctrl: self, features: event.selected.map(getWrapperFeature) });\r\n                    }\r\n                    if (event.deselected.length > 0) {\r\n                        if (event.selected.length == 0) {\r\n                            self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { ctrl: self.parent, features: event.deselected.map(getWrapperFeature) });\r\n                        }\r\n                    }\r\n                });\r\n                if (self.modifyInteraction) {\r\n                    olMap.removeInteraction(self.modifyInteraction);\r\n                }\r\n                var modify = new ol.interaction.Modify({\r\n                    features: select.getFeatures()\r\n                });\r\n                modify.on('modifyend', function (e) {\r\n                    e.features.forEach(function (feature) {\r\n                        feature._wrap.parent.geometry = feature._wrap.getGeometry();\r\n                        self.parent.trigger(TC.Consts.event.FEATUREMODIFY, { feature: feature._wrap.parent, layer: self.parent.layer });\r\n                    });\r\n                });\r\n                self.modifyInteraction = modify;\r\n                olMap.addInteraction(modify);\r\n\r\n                if (self.snapInteraction) {\r\n                    olMap.removeInteraction(self.snapInteraction);\r\n                }\r\n                if (self.parent.snapping) {\r\n                    self.snapInteraction = new ol.interaction.Snap({\r\n                        source: olLayer.getSource()\r\n                    });\r\n                    olMap.addInteraction(self.snapInteraction);\r\n                }\r\n\r\n                if (!self._onMouseMove) {\r\n                    self._onMouseMove = function (e) {\r\n                        const viewport = olMap.getViewport();\r\n                        var hit = false;\r\n                        var feature;\r\n\r\n                        var pixel = olMap.getEventPixel(e);\r\n                        hit = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                            if (self.parent.layer && layer === self.parent.layer.wrap.layer) {\r\n                                return true;\r\n                            }\r\n                            return false;\r\n                        },\r\n                            {\r\n                                hitTolerance: hitTolerance\r\n                            });\r\n\r\n                        if (hit) {\r\n                            viewport.style.cursor = 'pointer';\r\n                        } else {\r\n                            viewport.style.cursor = '';\r\n                            //self.parent.trigger(TC.Consts.event.FEATUREOUT);\r\n                        }\r\n                    };\r\n                }\r\n\r\n                olMap.getViewport().addEventListener(MOUSEMOVE, self._onMouseMove);\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.deactivate = function () {\r\n        const self = this;\r\n        if (self.modifyInteraction) {\r\n            self.modifyInteraction.setActive(false);\r\n            self.selectInteraction.setActive(false);\r\n            self.parent.map.wrap.getMap().then(function (olMap) {\r\n                olMap.getViewport().removeEventListener(MOUSEMOVE, self._onMouseMove);\r\n                olMap.removeInteraction(self.modifyInteraction);\r\n                olMap.removeInteraction(self.selectInteraction);\r\n                self.modifyInteraction = null;\r\n                self.selectInteraction = null;\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.getSelectedFeatures = function () {\r\n        var self = this;\r\n        var result = [];\r\n        if (self.selectInteraction) {\r\n            self.selectInteraction.getFeatures().forEach(function (elm) {\r\n                result.push(elm._wrap.parent);\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.setSelectedFeatures = function (features) {\r\n        var self = this;\r\n        if (self.selectInteraction) {\r\n            var source = self.selectInteraction.featureOverlay_.getSource();\r\n            source.clear();\r\n            source.addFeatures(features.map(function (elm) {\r\n                return elm.wrap.feature;\r\n            }));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.unselectFeatures = function (features) {\r\n        features = features || [];\r\n        const self = this;\r\n        const selectedFeatures = self.selectInteraction ? self.selectInteraction.getFeatures() : null;\r\n        if (selectedFeatures) {\r\n            const unselectedFeatures = [];\r\n            selectedFeatures.getArray().slice().forEach(function (olFeature) {\r\n                if (!features.length || features.indexOf(olFeature) >= 0) {\r\n                    selectedFeatures.remove(olFeature);\r\n                    unselectedFeatures.push(olFeature._wrap.parent);\r\n                }\r\n            });\r\n            if (unselectedFeatures.length) {\r\n                self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { features: unselectedFeatures });\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.cancel = function (deactivate, cancelTxt) {\r\n        var self = this;\r\n        self.points = [];\r\n        self.histPoints = [];\r\n        var layer = (self.control && self.control.layer) || (self.modifyInteraction && self.modifyInteraction.layer);\r\n        //if (!self.session || ((self.modifyInteraction && self.modifyInteraction.modified) || (self.session.featuresAdded && self.session.featuresAdded.length)) && cancelTxt && !confirm(cancelTxt))\r\n        //    return;\r\n        if (self.selectInteraction) {\r\n            var features = self.selectInteraction.getFeatures();\r\n            self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { ctrl: self.parent, feature: features.get(0) });\r\n            features.clear();\r\n            self.selectInteraction.setActive(false);\r\n        }\r\n        //if (self.drawInteraction) {\r\n        //    self.drawInteraction.abortDrawing_();\r\n        //    if (deactivate) {\r\n        //        self.drawInteraction.setActive(false);\r\n        //    }\r\n        //}\r\n        //if(self.modifyInteraction)\r\n        //{\r\n        //    if (self.modifyInteraction.feature)\r\n        //        self.modifyInteraction.unselectFeature(self.modifyInteraction.feature);\r\n        //    if (deactivate)\r\n        //    {\r\n        //        self.modifyInteraction.deactivate();\r\n        //    }   \r\n        //}\r\n        ////if (self.session.featuresAdded && self.session.featuresAdded.length > 0) {\r\n        ////    layer.removeFeatures(self.session.featuresAdded);\r\n        ////    self.session.featuresAdded = [];\r\n        ////}\r\n        //self.parent.trigger(TC.Consts.event.EDITIONCANCEL, { ctrl: self });\r\n        ////no se por que hostias se cambia el renderIntent a las features\r\n        //layer.features.forEach(function (feat) {\r\n        //    feat.renderIntent = \"\";\r\n        //});    \r\n        //layer.removeAllFeatures();\r\n        //layer.addFeatures(self.session.features);        \r\n        //self.clearSession();\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.deleteFeatures = function (features) {\r\n        var self = this;\r\n        if (Array.isArray(features)) {\r\n            var olFeatures = features.map(function (elm) {\r\n                return elm.wrap.feature;\r\n            });\r\n            self.parent.layer.wrap.getLayer().then(function (olLayer) {\r\n                var selectedFeatures = self.selectInteraction ? self.selectInteraction.getFeatures() : null;\r\n                for (var i = 0, len = olFeatures.length; i < len; i++) {\r\n                    var olFeature = olFeatures[i];\r\n                    if (selectedFeatures) {\r\n                        selectedFeatures.remove(olFeature);\r\n                        self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { feature: olFeature._wrap.parent });\r\n                    }\r\n                    olLayer.getSource().removeFeature(olFeature);\r\n                    self.parent.trigger(TC.Consts.event.FEATUREREMOVE, { feature: olFeature._wrap.parent });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    //TC.wrap.control.Edit.prototype.clearSession = function () {\r\n    //    var self = this;\r\n    //    delete self.session;\r\n    //};\r\n\r\n    TC.wrap.Feature.prototype.toGML = function (version, srsName) {\r\n        var parser = new ol.format.GML({\r\n            srsName: srsName\r\n        });\r\n        var xml = parser.writeGeometryNode(this.feature.getGeometry());\r\n        //elimino los aributos srsName de los hijos en geometrias compuestas Polygon->LinearRing etc;\r\n        var poligons = xml.querySelector(\"MultiSurface,MultiPolygon,Polygon\")\r\n        if (poligons) poligons.querySelectorAll(\"Polygon,LinearRing\").forEach((item) => { item.removeAttribute(\"srsName\") });\r\n        //id para INSPIRE\r\n        xml.firstChild.setAttribute(\"gml:id\", xml.firstChild.tagName + \".\" + TC.getUID());\r\n        //reemplazo todos los <loquesea por <gml:loquesea y </loquesea por </gml:loquesea\r\n        return new XMLSerializer().serializeToString(xml.firstChild).replace(/\\<\\/?\\w/gm, function (str) { var pos = str.indexOf(\"/\") > 0 ? str.indexOf(\"/\") + 1 : 1; return str.substring(0, pos) + \"gml:\" + str.substring(pos) })\r\n        //return new XMLSerializer().serializeToString(xml.firstChild).replace(/\\</gm, \"<gml:\");\r\n    };\r\n\r\n\r\n    TC.wrap.Feature.prototype.toGeoJSON = function () {\r\n        var parser = new ol.format.GeoJSON();\r\n        return parser.writeGeometry(this.feature.getGeometry());\r\n    };\r\n\r\n    TC.wrap.Geometry.write = function (options) {\r\n        options = options || {};\r\n        var geometry;\r\n        switch (options.format) {\r\n            default:\r\n                options.parser = new ol.format.GeoJSON();\r\n        };\r\n        switch (options.type) {\r\n            case TC.Consts.geom.POLYLINE:\r\n                geometry = new ol.geom.LineString(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.POLYGON:\r\n                geometry = new ol.geom.Polygon(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOINT:\r\n                geometry = new ol.geom.MultiPoint(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYLINE:\r\n                geometry = new ol.geom.MultiLineString(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYGON:\r\n                geometry = new ol.geom.MultiPolygon(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOINT:\r\n                geometry = new ol.geom.MultiPoint(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.POINT:\r\n            default:\r\n                geometry = new ol.geom.Point(options.coordinates);\r\n                break;\r\n        };\r\n        return options.parser.writeGeometry(geometry);\r\n    };\r\n\r\n    TC.wrap.Geometry.toGeoJSON = function (options) {\r\n        return TC.wrap.Geometry.write(options);\r\n    };\r\n\r\n    return ol;\r\n});\r\n"]}