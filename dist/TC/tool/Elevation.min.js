TC.Consts.elevationService={GOOGLE:"elevationServiceGoogle",IDENA:"elevationServiceIDENA",IGN_ES:"elevationServiceIGNEs",IGN_FR:"elevationServiceIGNFr"};TC.tool=TC.tool||{};TC.tool.Elevation=function(e){const t=this;t.options=e||{};t._servicePromises=[];const n=t.options.services||[SITNA.Consts.elevationService.IDENA,SITNA.Consts.elevationService.IGN_FR,SITNA.Consts.elevationService.IGN_ES],o=new Promise(function(e,t){TC.loadJS(!TC.tool.ElevationService,TC.apiLocation+"TC/tool/ElevationService",function(){e()})});n.forEach(function(e,n){t._servicePromises[n]=new Promise(function(t,n){const i="string"==typeof e?e:e.name,r=i.substr(0,1).toUpperCase()+i.substr(1),l=TC.apiLocation+"TC/tool/"+r,s="string"==typeof e?{}:e;TC.loadJS(!TC.tool[r],l,function(){o.then(function(){t(new TC.tool[r](s))})})})})};!function(){const e=TC.tool.Elevation.prototype;let t=1;e.getService=function(e){return this._servicePromises[e]};e.getServices=function(){return Promise.all(this._servicePromises)};e.getElevation=function(e){const n=this;(e=e||{}).id=function(){const e=t.toString();t++;return e}();void 0===e.resolution&&(e.resolution=n.options.resolution);void 0===e.sampleNumber&&(e.sampleNumber=n.options.sampleNumber);let o,i,r=!1;TC.Util.isFunction(e.partialCallback)&&(i=e.partialCallback);return new Promise(function(t,l){TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){let s=e.coordinates;const a=1===s.length;if(!a)if(e.resolution){const t=[];s.forEach(function(n,o,i){if(o){const l=i[o-1],s=TC.Geometry.getDistance(l,n);if(s>e.resolution){let o=s%e.resolution/2,i=Math.ceil(s/e.resolution);if(0===o){i-=1;o=e.resolution}const a=n[0]-l[0],c=(n[1]-l[1])/s,u=a/s;let f=l[0]+o*u,C=l[1]+o*c,m=e.resolution*u,T=e.resolution*c;for(var r=0;r<i;r++){t.push([f,C]);f+=m;C+=T}}}t.push(n)});s=t;e.resolution=0;e.sampleNumber=0}else if(e.sampleNumber){const t=s.length;if(t>e.sampleNumber){const t=[];let n=0;s.forEach(function(e,o,i){o&&(n+=TC.Geometry.getDistance(i[o-1],e));t.push({index:o,distance:n})});const o=n/e.sampleNumber;let i=0;t.forEach(function(e,t,n){const r=e.distance-i;if(0===r)e.included=!0;else if(r>0){if(e.index){const o=n[t-1];i-o.distance<r?o.included=!0:e.included=!0}for(;e.distance>i;)i+=o}});t.filter(e=>!e.included).forEach(function(e){s[e.index]=null});s=s.filter(e=>null!==e)}else if(t<e.sampleNumber){const n=function(e,t,n){const o=e[t-1],i=e[t],r=n+1;let l=o[0],s=o[1];const a=(i[0]-l)/r,c=(i[1]-s)/r,u=new Array(n+2);u[0]=t;u[1]=0;for(var f=2,C=u.length;f<C;f++){l+=a;s+=c;u[f]=[l,s]}e.splice.apply(e,u)};let o=0;const i=s.map(function(e,t,n){let i=0;if(t){i=TC.Geometry.getDistance(n[t-1],e);o+=i}return{index:t,distance:i}});s=s.slice();const r=e.sampleNumber-t;let l=r,a=0;for(var c=0,u=i.length;l&&c<u;c++){const e=i[c];if(0!==e.distance){const t=Math.min(Math.round(r*e.distance/o),l)||1;l-=t;n(s,e.index+a,t);a+=t}}}e.resolution=0;e.sampleNumber=0}e.coordinates=s;o=s.map(e=>[e[0],e[1],null]);Object.prototype.hasOwnProperty.call(e,"includeHeights")||(e.includeHeights=a);n.getServices().then(function(s){const a=new Array(s.length);a.fill(!1);s.forEach(function(c,u){new Promise(function(t,n){navigator.onLine?c.request(e).then(function(n){t(r?null:c.parseResponse(n,e))},function(){t(null)}):t(null)}).then(function(c){if(!r){a[u]=c;if(null===c)a.every(e=>null===e)&&l("No services available");else{n._updatePartialResult(o,a)&&(r=!0);i&&i(o)}if(r){a.forEach((t,n)=>!1===t&&s[n].cancelRequest(e.id));t(o.some(e=>null!==e[2])?o:[])}}},function(e){console.error(e)})})},function(e){l(e)})})})};e.setGeometry=function(e){const t=this,n=(e=e||{}).features||[];if(n.length){const o=function(e,t,n){Promise.all(e).then(function(e){t(e)},function(e){n(e)})};return new Promise(function(i,r){if(e.maxCoordQuantity&&e.resolution){if(n.reduce(function(t,n){if(n){t+=n.getCoords({pointArray:!0}).length;switch(!0){case TC.feature.Polyline&&n instanceof TC.feature.Polyline:case TC.feature.Polygon&&n instanceof TC.feature.Polygon:case TC.feature.MultiPolyline&&n instanceof TC.feature.MultiPolyline:case TC.feature.MultiPolygon&&n instanceof TC.feature.MultiPolygon:t+=Math.floor(n.getLength()/e.resolution)}}return t},0)>e.maxCoordQuantity){r(Error(TC.tool.Elevation.errors.MAX_COORD_QUANTITY_EXCEEDED));return}}const l=e.resolution||0,s=function(t){return{crs:e.crs,coordinates:t,resolution:l,sampleNumber:0}},a=function(e){return t.getElevation(s(e))},c=n.map(function(e){return new Promise(function(n,i){switch(!0){case!e:n(null);break;case TC.feature&&TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:{const t=e.getCoords().map(function(e){return new Promise(function(t,n){o(e.map(a),t,n)})});o(t,n,i);break}case TC.feature&&TC.feature.Polygon&&e instanceof TC.feature.Polygon:case TC.feature&&TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:{const t=e.getCoords().map(a);o(t,n,i);break}case TC.feature&&TC.feature.Polyline&&e instanceof TC.feature.Polyline:t.getElevation(s(e.getCoords())).then(function(e){n(e)},function(e){i(Error(e))});break;case TC.feature&&TC.feature.Point&&e instanceof TC.feature.Point:t.getElevation(s([e.getCoords()])).then(function(e){n(e[0])},function(e){i(Error(e))});break;default:i(Error("Geometry not supported"))}})});Promise.all(c).then(function(e){const t=function(e,n){if(TC.Geometry.isPoint(e)){n[2]=e[2];e.length>3&&(n[3]=e[3])}else Array.isArray(e)&&e.forEach(function(e,o){t(e,n[o])})},o=function(e){return TC.Geometry.isPoint(e)?1:Array.isArray(e)?e.reduce((e,t)=>e+o(t),0):0};e.forEach(function(e,i){const r=n[i];if(r){console.log("Estableciendo elevaciones a geometr\xeda de tipo "+r.CLASSNAME);const n=r.getCoords();if(o(n)===o(e)){t(e,n);r.setCoords(n)}else e&&r.setCoords(e)}});i(n)},function(e){r(e)})})}return Promise.resolve([])};e._updatePartialResult=function(e,t){let n=!1,o=!1;for(var i=0,r=e.length;i<r;i++){const n=e[i];let r=null,a=null;const c=t.filter(e=>null!==e);for(var l=0,s=c.length;l<s;l++){const e=c[l];!1===e&&(o=!0);if(Array.isArray(e)){const t=e[i];if(null===r&&t){r=t[2];t.length>3&&null===a&&(a=t[3])}}if(null!==r){n[2]=r;null!==a&&(n[3]=a);break}}}return n=!o&&e.every(e=>null!==e[2])||t.every(e=>!1!==e)}}();TC.tool.Elevation.errors={MAX_COORD_QUANTITY_EXCEEDED:"max_coord_quantity_exceeded",UNDEFINED:"undefined"};TC.tool.Elevation.getElevationGain=function(e){return TC.Util.getElevationGain(e)};